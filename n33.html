<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CPC Vision</title>

  <script>
    (function () {
      const MAX_RETRIES = 3;
      const RETRY_KEY = "app_resource_retries";

      function attemptReload(reason) {
        let retries = parseInt(sessionStorage.getItem(RETRY_KEY) || "0");
        if (retries < MAX_RETRIES) {
          sessionStorage.setItem(RETRY_KEY, retries + 1);
          console.warn(
            `[Auto-Fix] ${reason}. Đang tải lại trang (Lần ${retries + 1
            }/${MAX_RETRIES})...`
          );

          document.documentElement.innerHTML = `
              <div style="display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;flex-direction:column;text-align:center;">
                <h2 style="color:#d63384">Đang khắc phục sự cố kết nối...</h2>
                <p>Hệ thống đang tự động tải lại tài nguyên (Lần ${retries + 1
            }). Vui lòng đợi giây lát.</p>
              </div>
            `;

          setTimeout(() => window.location.reload(), 1500);
        } else {
          console.error(
            "[Auto-Fix] Đã hết lượt thử lại. Vui lòng kiểm tra kết nối mạng."
          );
          sessionStorage.removeItem(RETRY_KEY);
          alert(
            "Lỗi kết nối: Không thể tải thư viện hệ thống (Dexie/Vue). Vui lòng kiểm tra đường truyền internet và nhấn F5."
          );
        }
      }

      window.addEventListener(
        "error",
        function (e) {
          if (
            e.target &&
            (e.target.tagName === "SCRIPT" || e.target.tagName === "LINK")
          ) {
            if (e.target.src && !e.target.src.startsWith("http")) return;

            attemptReload(
              `Không tải được tài nguyên: ${e.target.src || "Unknown Source"}`
            );
          }
        },
        true
      );

      window.addEventListener("load", function () {
        setTimeout(() => {
          const missingLibs = [];
          if (typeof Vue === "undefined") missingLibs.push("Vue");
          if (typeof Dexie === "undefined") missingLibs.push("Dexie");

          if (missingLibs.length > 0) {
            attemptReload(`Thiếu thư viện: ${missingLibs.join(", ")}`);
          } else {
            sessionStorage.removeItem(RETRY_KEY);
            console.log("[System] Tất cả thư viện đã tải thành công.");
          }
        }, 500);
      });
    })();
  </script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />

  <!-- Vue 3 -->
  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Lucide Icons (Fix link cũ bị lỗi) -->
  <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>

  <!-- Dexie (Fix lỗi Dexie is not defined do link unpkg cũ) -->
  <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.4/dist/dexie.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    /* ==========================================================================
         1. IMPORTS & ROOT VARIABLES
         ========================================================================== */
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");

    :root {
      --sidebar-width: 260px;
      --sidebar-collapsed-width: 90px;
      --header-height: 70px;
      --nav-width: 80px;
      --nav-width-expanded: 260px;

      --primary-color: #ff5da2;
      --primary-hover: #0d9488;
      --primary-light: #ccfbf1;
      --primary-text: #115e59;

      --headerbg-color: #edebad;
      --headerbg-light: #fcfaac;
      --headerbg-text: #827f1d;

      --gradient-start: rgba(20, 184, 166, 0.9);
      --gradient-end: rgba(6, 182, 212, 0.85);

      --sidebar-text: rgba(255, 255, 255, 0.88);
      --sidebar-text-hover: #fff;
      --sidebar-active-bg: rgba(255, 255, 255, 0.2);

      --body-bg: #f0fdfa;
      --card-bg: #ffffff;
      --table-bg: #ffffff;
      --border-color: #e5e7eb;
      --input-border-color: #d1d5db;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --danger: #ef4444;

      --bs-primary: var(--primary-color);
      --bs-primary-rgb: 20, 184, 166;
      --bs-tooltip-bg: transparent;
      --bs-tooltip-opacity: 1;

      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.07);
      --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);

      --border-radius-lg: 1.5rem;
      --border-radius-md: 0.75rem;
      --border-radius-sm: 0.5rem;

      --filter-header-bg: #fff0e5;
      --filter-header-border: #ffdab9;
      --filter-header-text: #c05621;
      --filter-selected-bg: #ff71a1;
      --filter-selected-hover: #ff5091;
    }

    /* ==========================================================================
         2. BASE & TYPOGRAPHY
         ========================================================================== */
    html,
    body {
      height: 100%;
      margin: 0;
      scroll-behavior: smooth;
      background-color: var(--body-bg);
      font-family: "Inter", "Segoe UI", sans-serif;
    }

    /* ==========================================================================
         3. LAYOUT & STRUCTURE
         ========================================================================== */
    #app {
      display: flex;
      height: 100vh;
    }

    #main-nav {
      width: var(--nav-width);
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1030;
      background: linear-gradient(180deg,
          var(--gradient-start) 0%,
          var(--gradient-end) 100%);
      box-shadow: var(--shadow-lg);
      display: flex;
      flex-direction: column;
      transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
    }

    #main-nav:hover {
      width: var(--nav-width-expanded);
    }

    #main-content-wrapper {
      flex-grow: 1;
      padding-left: var(--nav-width);
      transition: padding-left 0.3s ease;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    #main-nav:hover~#main-content-wrapper {
      padding-left: var(--nav-width-expanded);
    }

    .main-header {
      height: var(--header-height);
      padding: 0 2rem;
      display: flex;
      align-items: center;
      position: relative;
      z-index: 1020;
      flex-shrink: 0;
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 2px solid var(--border-color);
      transition: border-color 0.4s ease;
    }

    .main-header .page-title {
      color: var(--text-primary);
      font-size: 1.6rem;
      font-weight: 700;
      margin-left: 1rem;
    }

    .main-content {
      padding: 0 2rem;
      flex-grow: 1;
      overflow-y: auto;
      overflow-x: auto;
    }

    .main-content>div>div>*:first-child {
      margin-top: 2rem;
    }

    .main-content>div>div>*:last-child {
      margin-bottom: 2rem;
    }

    .action-buttons-container {
      padding: 1.5rem 0;
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }

    .table-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    /* ==========================================================================
         4. NAVIGATION (MAIN SIDEBAR)
         ========================================================================== */
    .nav-header {
      height: var(--header-height);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.8rem;
      flex-shrink: 0;
    }

    .nav-menu {
      padding: 10px;
      overflow-y: auto;
      flex-grow: 1;
    }

    .nav-menu a {
      display: flex;
      align-items: center;
      height: 50px;
      margin: 8px 0;
      padding: 0 18px;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      border-radius: var(--border-radius-md);
      position: relative;
      overflow: hidden;
      white-space: nowrap;
      transition: background-color 0.2s ease, color 0.2s ease;
    }

    #main-nav:hover .nav-menu a {
      justify-content: flex-start;
      padding: 0 20px;
    }

    .nav-menu a:hover {
      background: linear-gradient(135deg,
          rgba(255, 255, 255, 0.25),
          rgba(255, 255, 255, 0.15));
      color: #fff;
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .nav-menu a:hover .nav-icon {
      transform: scale(1.15) rotate(15deg);
      transition: transform 0.25s ease;
    }

    .nav-menu a:hover .nav-label {
      color: #fff;
    }

    .nav-menu a.active {
      background-color: white;
      color: var(--primary-hover);
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(13, 148, 136, 0.4);
    }

    .nav-menu a.sidebar-nav-focus {
      background-color: rgba(255, 255, 255, 0.3) !important;
      transform: translateX(8px) scale(1.02);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      color: #ffffff !important;
    }

    .nav-icon {
      flex-shrink: 0;
      transition: transform 0.3s ease;
    }

    .nav-label {
      margin-left: 20px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    #main-nav:hover .nav-label {
      opacity: 1;
      transition-delay: 0.1s;
    }

    /* ==========================================================================
         5. TABLES
         ========================================================================== */
    /* General Table Styles */
    .table-responsive {
      border-radius: var(--border-radius-md);
      overflow-x: visible;
    }

    .table {
      margin-bottom: 0;
      min-width: 1200px;
      border-collapse: separate;
      border-spacing: 0;
    }

    .table td,
    .table th {
      border-left: none;
      border-right: none;
    }

    .table thead th {
      background-color: var(--headerbg-light);
      color: var(--headerbg-text);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 0.8rem;
      vertical-align: middle;
      padding: 1rem 1.5rem;
      border-bottom: 2px solid var(--primary-color);
      cursor: pointer;
      white-space: nowrap;
      text-align: center;
      transition: background-color 0.2s ease;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    .table thead th:hover:not(.no-sort) {
      background-color: #99f6e4;
      color: var(--primary-hover);
    }

    .table tbody tr {
      background-color: var(--table-bg);
      transition: background-color 0.2s ease, transform 0.2s ease,
        box-shadow 0.2s ease;
    }

    .table tbody tr:hover {
      background-color: #f0fdfa;
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      position: relative;
      z-index: 1;
    }

    .table tbody td {
      vertical-align: middle;
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--border-color);
      white-space: nowrap;
      text-align: left;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .table tfoot.sticky-footer tr,
    .table tfoot tr {
      position: sticky;
      bottom: 0;
      z-index: 2;
    }

    .table tfoot td {
      font-weight: bold;
      color: var(--text-primary);
      background-color: #f9fafb;
      border-top: 2px solid var(--border-color);
    }

    /* Tùy chỉnh hàng con để không làm nhảy độ rộng cột */
    .sub-row td {
      background-color: #f8fafc !important;
      /* Màu nền nhẹ để phân biệt */

      font-size: 0.85rem !important;
      /* Chữ nhỏ hơn một chút */
      padding-top: 0.5rem !important;
      padding-bottom: 0.5rem !important;
      white-space: nowrap;
      /* Không cho xuống dòng làm tăng chiều cao */
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Đảm bảo căn lề của hàng phụ khớp hoàn toàn với hàng chính */
    .sub-row .text-end-custom {
      text-align: right !important;
      font-weight: 500;
      color: #475569;
      /* Màu chữ hơi nhạt hơn hàng chính */
    }

    .sub-row .text-center-custom {
      text-align: center !important;
    }

    .payment-sub-row td {
      background-color: #ffffff !important;
      /* Chuyển thành màu trắng */
      padding: 0.5rem 1rem;
      border-top: 1px dashed #dee2e6 !important;
      /* Đổi viền thành màu xám nhẹ */
      font-size: 0.9em;
    }

    /* Detailed Table Styles (.table-detailed) */
    .table-detailed {
      min-width: 3000px;
      border-collapse: separate;
      border-spacing: 0;
    }

    .table-detailed th,
    .table-detailed td {
      border: 1px solid rgba(255, 93, 162, 0.4);
    }

    .table-detailed th:not(:first-child),
    .table-detailed td:not(:first-child) {
      border-left: none;
    }

    .table-detailed tbody tr td,
    .table-detailed tfoot tr td {
      border-top: none;
    }

    .table-detailed thead th {
      background-color: #fff0e5;
      color: #c05621;
      font-size: 0.75rem;
      padding: 0.5rem;
      text-align: center;
      vertical-align: middle;
      position: sticky;
      z-index: 3;
    }

    .table-detailed thead tr:first-child th {
      top: 0;
    }

    .table-detailed thead tr:nth-child(2) th {
      top: 34px;
    }

    .table-detailed thead tr:nth-child(3) th {
      top: 68px;
    }

    .table-detailed tbody tr:hover {
      position: relative;
      z-index: 10;
    }

    .table-detailed tbody td {
      padding: 0.5rem;
      font-size: 0.85rem;
      vertical-align: middle;
      position: relative;
    }

    .table-detailed tfoot tr {
      position: sticky;
      z-index: 3;
      transition: background-color 0.2s ease;
    }

    .table-detailed tfoot tr:first-child {
      bottom: 46px;
    }

    .table-detailed tfoot tr:last-child {
      bottom: 0;
    }

    .table-detailed tfoot td {
      background-color: #f8f9fa;
      font-weight: bold;
      padding: 0.75rem 0.5rem;
    }

    .table-detailed tfoot tr:first-child td {
      background-color: #ebf3fa;
      border-top: 1px solid #dee2e6;
    }

    .table-detailed tfoot tr:last-child td {
      background-color: #fffbeb;
      font-weight: 700;
      color: #92400e;
    }

    .table-detailed tfoot tr:hover td {
      background-color: #e9ecef;
    }

    /* Report Dashboard Table Styles */
    .report-dashboard-table {
      width: 100%;
      font-size: 0.85rem;
      border-collapse: collapse;
      border: 1px solid #dee2e6;
    }

    .report-dashboard-table th,
    .report-dashboard-table td {
      border: 1px solid #dee2e6;
      padding: 0.4rem 0.6rem;
      vertical-align: middle;
      white-space: nowrap;
    }

    .report-dashboard-table thead th {
      font-weight: 600;
      text-align: center;
      position: sticky;
      z-index: 3;
      background-color: #e9ecef;
    }

    .report-dashboard-table thead .header-main th {
      top: 0;
      background-color: #a7d7a7;
    }

    .report-dashboard-table thead tr:nth-child(2) th {
      top: 34px;
    }

    .report-dashboard-table tbody td:first-child {
      position: sticky;
      left: 0;
      background-color: #fff;
      z-index: 1;
    }

    .report-dashboard-table tbody tr.category-main {
      background-color: #e8dfff;
      font-weight: bold;
    }

    .report-dashboard-table tbody tr.category-main td:first-child {
      background-color: #e8dfff;
    }

    .report-dashboard-table tfoot td {
      background-color: #f0f9ff;
      font-weight: 700;
      position: sticky;
      bottom: 0;
      z-index: 3;
    }

    /* Table Cell Variants & Interactive Elements */
    .table-link {
      font-weight: 600;
      color: var(--primary-hover);
      text-decoration: none;
      transition: color 0.2s ease;
    }

    .table-link:hover {
      color: var(--primary-color);
      text-decoration: underline;
    }

    .table-action-btn {
      background-color: transparent;
      border: none;
      color: var(--text-secondary);
      padding: 0.5rem;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      transition: all 0.2s ease;
    }

    .table-action-btn.text-warning {
      color: #f59e0b !important;
    }

    .table-action-btn.text-info {
      color: #3b82f6 !important;
    }

    .table-action-btn.text-danger {
      color: var(--danger) !important;
    }

    .table-action-btn:hover {
      transform: scale(1.15);
    }

    .table-action-btn.text-warning:hover {
      background-color: rgba(245, 158, 11, 0.1);
      color: #b45309 !important;
    }

    .table-action-btn.text-info:hover {
      background-color: rgba(59, 130, 246, 0.1);
      color: #1d4ed8 !important;
    }

    .table-action-btn.text-danger:hover {
      background-color: rgba(239, 68, 68, 0.1);
      color: #991b1b !important;
    }

    .table-action-btn.text-danger:hover .bi-trash {
      animation: shake 0.7s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
    }

    .table-action-btn:disabled {
      cursor: not-allowed;
      color: #ced4da !important;
      background-color: transparent !important;
      transform: none !important;
    }

    .table-action-btn:disabled:hover {
      color: #ced4da !important;
    }

    .table-form-switch {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 24px;
      padding: 0;
    }

    .table-form-switch .form-check-input {
      transform: scale(0.9);
      cursor: pointer;
    }

    .table-form-switch .form-check-input:disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }

    .interactive-cell {
      cursor: pointer;
      padding: 0.5rem !important;
      position: relative;
      border: 1px dashed transparent;
      border-radius: var(--border-radius-sm);
      transition: background-color 0.2s ease, border-color 0.2s ease;
      font-weight: 500;
    }

    .interactive-cell:hover {
      background-color: var(--primary-light);
      border-color: var(--primary-hover);
    }

    .interactive-cell-box {
      display: inline-block;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-sm);
      padding: 0.2rem 0.6rem;
    }

    .interactive-cell-box-empty {
      border-style: dashed;
    }

    .interactive-payment-date {
      cursor: pointer;
      font-weight: 600;
      color: var(--primary-hover);
      transition: color 0.2s;
    }

    .interactive-payment-date:hover {
      color: var(--primary-color);
      text-decoration: underline;
    }

    .remaining-payable-header {
      background-color: yellow !important;
      color: red !important;
      font-weight: bold;
      vertical-align: middle !important;
    }

    .row-highlight {
      animation: highlight-fade 3s ease-out;
    }

    .cell-just-edited {
      animation: highlight-success-fade 2s ease-out;
    }

    .sort-icon {
      margin-left: 5px;
      transition: transform 0.3s ease;
    }

    /* ==========================================================================
         6. FORMS & INPUTS
         ========================================================================== */
    .form-control,
    .form-select {
      border-radius: var(--border-radius-sm);
      border-color: var(--input-border-color);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(var(--bs-primary-rgb), 0.2);
    }

    .form-label {
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }

    .clear-search-btn-custom {
      position: absolute;
      right: 0;
      top: 0;
      height: 100%;
      z-index: 100;
      background: transparent !important;
      border: none;
      color: var(--text-secondary);
      padding: 0 0.75rem;
    }

    .clear-search-btn-custom:hover {
      color: #ef4444;
    }

    .input-group .btn-add-master {
      border-color: var(--input-border-color);
      background-color: #f8f9fa;
      min-width: 40px;
    }

    .input-group .btn-add-master:hover {
      background-color: #e9ecef;
      color: var(--primary-hover);
    }

    .custom-checkbox-container {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem 1.25rem;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .custom-checkbox-container:hover {
      background-color: #f8f9fa;
    }

    .custom-checkbox-icon {
      width: 20px;
      height: 20px;
      border: 2px solid var(--input-border-color);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s ease;
    }

    .custom-checkbox-icon .fa-check {
      font-size: 0.8em;
      color: white;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .custom-checkbox-icon.checked {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .custom-checkbox-icon.checked .fa-check {
      opacity: 1;
    }

    .custom-checkbox-label {
      font-weight: 500;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Custom Dropdown for Vendor Selection */
    .custom-dropdown-container {
      position: relative;
    }

    .custom-dropdown-menu {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      z-index: 1056;
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-sm);
      box-shadow: var(--shadow-lg);
      list-style: none;
      padding: 0.5rem;
      margin-top: 5px;
      max-height: 200px;
      overflow-y: auto;
    }

    .custom-dropdown-menu li {
      padding: 0.75rem 1rem;
      cursor: pointer;
      border-radius: var(--border-radius-sm);
      transition: background-color 0.15s ease;
    }

    .custom-dropdown-menu li:hover,
    .custom-dropdown-menu li.active {
      background-color: var(--primary-light);
      color: var(--primary-text);
    }

    .custom-dropdown-menu .dropdown-item-disabled {
      color: var(--text-secondary);
      font-style: italic;
      cursor: default;
    }

    .custom-dropdown-menu .vendor-item-name {
      font-weight: 500;
    }

    .custom-dropdown-menu .vendor-item-abbr {
      font-size: 0.8em;
      color: var(--text-secondary);
    }

    /* ==========================================================================
         7. BUTTONS
         ========================================================================== */
    .btn {
      border-radius: var(--border-radius-sm);
      padding: 0.6rem 1.2rem;
      font-weight: 500;
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }

    .btn-primary {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .btn-primary:hover {
      background-color: var(--primary-hover);
      border-color: var(--primary-hover);
    }

    .btn:focus,
    .btn:active,
    .btn:active:focus,
    .btn-check:focus+.btn,
    button:focus,
    button:active {
      box-shadow: none !important;
      outline: none !important;
      transform: translateY(-1px);
      /* Giữ hiệu ứng nhấn nhẹ nếu muốn */
    }

    .btn-icon {
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    .btn-icon i[data-lucide] {
      width: 24px;
      height: 24px;
    }

    .scroll-to-top-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 1050;
      width: 50px;
      height: 50px;
      box-shadow: var(--shadow-lg);
    }

    .delete-corner-btn {
      background-color: transparent !important;
      border: none !important;
      box-shadow: none !important;
      padding: 0;
      position: absolute;
      top: 0;
      right: 0;
      transform: translate(40%, -40%) scale(0.8);
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease-out;
      z-index: 10;
    }

    .interactive-cell:hover .delete-corner-btn {
      opacity: 1;
      visibility: visible;
      transform: translate(40%, -40%) scale(1);
    }

    .delete-corner-btn:hover .fa-trash-alt {
      color: #991b1b;
      background-color: #fee2e2;
      transform: scale(1.1);
    }

    .delete-corner-btn .fa-trash-alt {
      color: #ef4444;
      font-size: 0.9rem;
      padding: 8px;
      background-color: white;
      border-radius: 50%;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      transition: all 0.2s ease-in-out;
    }

    .add-below-btn {
      background-color: transparent !important;
      border: none !important;
      box-shadow: none !important;
      padding: 0;
      position: absolute;
      bottom: 0;
      left: 0;
      transform: translate(-40%, 40%) scale(0.8);
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease-out;
      z-index: 10;
    }

    .interactive-cell:hover .add-below-btn {
      opacity: 1;
      visibility: visible;
      transform: translate(-40%, 40%) scale(1);
    }

    .add-below-btn:hover .fa-plus-circle {
      color: #146c43;
      background-color: #d1fae5;
      transform: scale(1.1);
    }

    .add-below-btn .fa-plus-circle {
      color: #198754;
      font-size: 1.2rem;
      padding: 8px;
      background-color: white;
      border-radius: 50%;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      transition: all 0.2s ease-in-out;
    }

    .send-cpc-btn {
      background-color: transparent !important;
      border: none !important;
      box-shadow: none !important;
      padding: 0;
      position: absolute;
      top: 0;
      left: auto;
      right: 0;
      transform: translate(50%, -50%) scale(0.9);
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      z-index: 5;
    }

    .table-detailed tbody tr:hover .send-cpc-btn {
      opacity: 1;
      visibility: visible;
      transform: translate(50%, -50%) scale(1);
    }

    .send-cpc-btn:hover,
    .send-cpc-btn:focus {
      background-color: transparent !important;
      box-shadow: none !important;
    }

    .send-cpc-btn:hover .fa-paper-plane {
      transform: scale(1.2) rotate(15deg);
      color: var(--primary-hover);
    }

    .send-cpc-btn .fa-paper-plane {
      color: #ff5da2;
      transition: transform 0.2s ease-in-out, color 0.2s ease-in-out;
      font-size: 1.2rem;
    }

    /* ==========================================================================
         8. COMPONENTS
         ========================================================================== */
    /* Filter Panel */
    .filter-panel {
      background-color: var(--card-bg);
      padding: 1.5rem;
      border-radius: var(--border-radius-md);
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
    }

    .filter-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .filter-panel-header h5 {
      margin: 0;
      color: var(--text-primary);
    }

    .collapse-filter-btn {
      background-color: transparent;
      border: none;
      color: var(--text-secondary);
      padding: 0.5rem;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .collapse-filter-btn:hover {
      background-color: rgba(0, 0, 0, 0.05);
      color: var(--text-primary);
      transform: scale(1.1);
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .filter-group-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding: 0.5rem 1rem;
      border-radius: var(--border-radius-sm);
      background-color: var(--filter-header-bg);
      border: 1px solid var(--filter-header-border);
    }

    .filter-group-header h6 {
      margin: 0;
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--filter-header-text);
      cursor: pointer;
      width: 100%;
      user-select: none;
      transition: color 0.2s ease;
    }

    .filter-group-header h6:hover {
      color: var(--primary-hover);
    }

    .clear-filter-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 1.1em;
      transition: all 0.2s ease;
      padding: 0;
    }

    .clear-filter-btn:hover {
      color: var(--danger);
      transform: scale(1.1);
    }

    .clear-filter-btn .fa-times::before {
      content: "\f2ed";
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
    }

    .slicer-options {
      max-height: 150px;
      overflow-y: auto;
      padding-right: 5px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      transition: max-height 0.35s cubic-bezier(0.25, 0.1, 0.25, 1);
    }

    .slicer-options-expanded {
      max-height: 500px;
    }

    .slicer-btn {
      text-align: left;
    }

    .slicer-btn-selected {
      color: white;
      font-weight: 500;
      background-color: var(--filter-selected-bg);
      border-color: var(--filter-selected-bg);
    }

    .slicer-btn-selected:hover {
      color: white;
      background-color: var(--filter-selected-hover);
      border-color: var(--filter-selected-hover);
    }

    .filter-summary-panel {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #f9fafb;
      padding: 0.75rem 1.5rem;
      border-radius: var(--border-radius-md);
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
    }

    .filter-summary-text {
      color: var(--text-secondary);
      font-style: italic;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-right: 1rem;
    }

    .filter-summary-text strong {
      color: var(--text-primary);
      font-style: normal;
    }

    /* Notification Bell */
    .notification-bell-button {
      border: none;
      background-color: transparent;
      position: relative;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      z-index: 0;
    }

    .notification-bell-button:hover {
      color: var(--text-primary);
    }

    .notification-badge {
      position: absolute;
      top: 9px;
      right: 9px;
      transform: translate(50%, -50%);
      width: 20px;
      height: 20px;
      border-radius: 50%;
      padding: 0;
      background-color: var(--danger);
      color: white;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      font-size: 5px;
      font-weight: 700;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .ringing-red {
      animation: ring-animation 1.5s ease-in-out infinite;
      color: var(--danger) !important;
    }

    .notification-bell-button.ringing-red::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background-color: var(--danger);
      animation: sonar-wave 1.5s ease-out infinite;
      z-index: -1;
    }

    /* Modals */
    .modal.fade .modal-dialog {
      transform: translate(0, -25%);
      transition: transform 0.3s ease-out, opacity 0.3s ease-out;
    }

    .modal.show .modal-dialog {
      transform: translate(0, 0);
    }

    .modal-dialog {
      max-width: 1000px;
    }

    .modal-content {
      border-radius: var(--border-radius-md);
      box-shadow: var(--shadow-lg);
      border: none;
    }

    .modal-header {
      background-color: var(--card-bg);
      color: var(--text-primary);
      padding: 1.5rem;
      border-bottom: 1px solid var(--border-color);
    }

    .modal-header .modal-title {
      font-weight: 600;
    }

    .modal-body {
      padding: 2rem;
    }

    .modal-body .tab-content {
      padding-top: 1.5rem;
    }

    .modal-footer {
      padding: 1.5rem;
      background-color: #f9fafb;
      border-top: 1px solid var(--border-color);
    }

    #contractDetailsModal .custom-modal {
      max-width: 600px;
    }

    #contractDetailsModal .form-control,
    #contractDetailsModal .form-select {
      max-width: 250px;
    }

    /* Toasts / Notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }

    .toast-notification {
      min-width: 320px;
      padding: 1rem 1.25rem;
      border-radius: var(--border-radius-sm);
      color: white;
      box-shadow: var(--shadow-lg);
      opacity: 0;
      transform: translateX(110%);
      transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    }

    .toast-notification.show {
      opacity: 1;
      transform: translateX(0);
    }

    .toast-notification.success {
      background-color: #22c55e;
    }

    .toast-notification.error {
      background-color: #ef4444;
    }

    .toast-notification.warning {
      background-color: #f59e0b;
    }

    .toast-notification.info {
      background-color: #3b82f6;
    }

    /* Badges */
    .badge {
      padding: 0.5em 1em;
      border-radius: 9999px !important;
      font-weight: 500;
      font-size: 0.8rem;
    }

    .badge.bg-primary {
      color: #1e40af;
      background-color: #dbeafe !important;
      border: 1px solid #bfdbfe;
    }

    .badge.bg-success {
      color: #065f46;
      background-color: #d1fae5 !important;
      border-color: #a7f3d0;
    }

    .badge.bg-danger {
      color: #991b1b;
      background-color: #fee2e2 !important;
      border-color: #fecaca;
    }

    .badge.bg-warning {
      color: #92400e;
      background-color: #fef3c7 !important;
      border-color: #fde68a;
    }

    .badge.bg-due-today {
      color: #9a3412;
      background-color: #ffedd5 !important;
      border-color: #fed7aa;
    }

    /* Contract Header Info */
    .contract-header-info {
      background-color: #f8f9fa;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-sm);
      padding: 1rem 1.5rem;
      margin-bottom: 2rem;
      font-size: 0.95rem;
    }

    .contract-header-info .project-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 1rem;
    }

    /* Financial Edit Trigger */
    .financial-edit-trigger {
      cursor: pointer;
      display: inline-block;
      padding: 4px 8px;
      border-radius: 5px;
      transition: background-color 0.2s ease;
      white-space: nowrap;
    }

    .financial-edit-trigger:hover {
      background-color: var(--primary-light);
    }

    .financial-edit-trigger .bi-pencil-square {
      opacity: 0.6;
      transition: opacity 0.2s ease;
    }

    .financial-edit-trigger:hover .bi-pencil-square {
      opacity: 1;
      color: var(--primary-hover) !important;
    }

    /* Guide Modal Navigation */
    .guide-nav {
      border-right: 1px solid var(--border-color);
      /* Tăng độ rộng tối thiểu từ 220px lên 280px (hoặc auto) để vừa nội dung */
      min-width: 280px;
      padding-right: 1.5rem;
      position: sticky;
      top: 0;
      align-self: flex-start;
    }

    .guide-nav .nav-link {
      text-align: left;
      color: var(--text-secondary);
      border-left: 3px solid transparent;
      transition: background-color 0.2s ease, color 0.2s ease,
        transform 0.2s ease, border-left-color 0.2s ease;
      /* Thuộc tính mới: Ngăn không cho text xuống dòng */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      /* Thêm dấu ... nếu màn hình quá nhỏ */
    }

    .guide-nav .nav-link.active {
      background-color: var(--primary-color);
      color: white;
      font-weight: 600;
      border-left-color: var(--primary-hover);
    }

    .guide-nav .nav-link:not(.active):hover {
      background-color: var(--primary-light);
      color: var(--primary-hover);
      font-weight: 500;
      border-left-color: var(--primary-color);
      transform: translateX(4px);
    }

    .guide-content {
      flex-grow: 1;
      padding-left: 1.5rem;
    }

    .guide-content h4 {
      color: var(--primary-hover);
      margin-bottom: 1rem;
    }

    .guide-content .table thead th {
      position: static;
    }

    /* Command Palette */
    .command-palette-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1060;
      display: flex;
      justify-content: center;
      padding-top: 15vh;
      transition: opacity 0.2s ease;
    }

    .command-palette-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .command-palette-dialog {
      width: 100%;
      max-width: 600px;
      background-color: var(--card-bg);
      border-radius: var(--border-radius-md);
      box-shadow: var(--shadow-lg);
      display: flex;
      flex-direction: column;
      z-index: 1;
      max-height: 50vh;
    }

    .command-palette-search {
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
    }

    .command-palette-search input {
      width: 100%;
      border: none;
      outline: none;
      font-size: 1.2rem;
      background-color: transparent;
      color: var(--text-primary);
    }

    .command-results-list {
      list-style: none;
      padding: 0.5rem;
      margin: 0;
      overflow-y: auto;
    }

    .command-result-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
      border-radius: var(--border-radius-sm);
      display: flex;
      align-items: center;
      gap: 1rem;
      transition: background-color 0.15s ease;
    }

    .command-result-item:hover,
    .command-result-item.active {
      background-color: var(--body-bg);
      color: var(--primary-hover);
    }

    .command-result-item.selected {
      background-color: var(--primary-light);
      font-weight: 600;
      color: var(--primary-text);
    }

    .command-result-item.selected i.fa-check-circle {
      color: var(--primary-hover);
      margin-right: 0.75rem;
    }

    .command-result-item .result-label {
      font-weight: 500;
    }

    .command-result-item .result-sublabel {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .command-result-item .result-type {
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.2em 0.6em;
      border-radius: 5px;
      background-color: var(--primary-light);
      color: var(--primary-text);
    }

    /* --- MÀU SẮC CHO COMMAND PALETTE BADGES --- */

    /* 1. Contract: Màu Xanh Dương */
    .command-result-item .result-type.type-contract {
      background-color: #dbeafe;
      color: #1e40af;
      border: 1px solid #bfdbfe;
    }

    /* 2. CPC: Màu Xanh Lá (Teal) */
    .command-result-item .result-type.type-cpc {
      background-color: #ccfbf1;
      color: #0f766e;
      border: 1px solid #99f6e4;
    }

    /* 3. Vendor: Màu Cam */
    .command-result-item .result-type.type-vendor {
      background-color: #ffedd5;
      color: #9a3412;
      border: 1px solid #fed7aa;
    }

    /* 4. Action: Màu Xám */
    .command-result-item .result-type.type-action {
      background-color: #f3f4f6;
      color: #374151;
      border: 1px solid #e5e7eb;
    }

    /* Tooltip */
    .tooltip {
      /* Tăng khoảng cách nhỏ để không dính sát vào phần tử */
      margin: 4px 0 !important;
      /* Hiệu ứng hiện ra mượt mà */
      transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .tooltip-inner {
      /* 1. Màu nền & Chữ: Sử dụng màu tối hiện đại hoặc màu Primary của bạn */
      background-color: #1f2937 !important;
      /* Màu xám đậm (Slate 800) */
      color: #ffffff !important;

      /* 2. Typography */
      font-family: 'Inter', sans-serif;
      font-weight: 500;
      font-size: 0.85rem;
      line-height: 1.4;

      /* 3. Hình dáng & Đổ bóng */
      padding: 8px 12px !important;
      border-radius: 8px !important;
      /* Bo góc hiện đại */
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
        0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;

      /* 4. Giới hạn độ rộng */
      max-width: 250px;
    }

    /* 5. Điều chỉnh Mũi tên (Arrow) để khớp với màu nền mới */
    .bs-tooltip-top .tooltip-arrow::before {
      border-top-color: #1f2937 !important;
    }

    .bs-tooltip-bottom .tooltip-arrow::before {
      border-bottom-color: #1f2937 !important;
    }

    .bs-tooltip-start .tooltip-arrow::before {
      border-left-color: #1f2937 !important;
    }

    .bs-tooltip-end .tooltip-arrow::before {
      border-right-color: #1f2937 !important;
    }

    /* Quick Action Menu */
    .quick-action-menu-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .quick-action-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }

    .quick-action-menu {
      position: relative;
      display: flex;
      gap: 2rem;
      align-items: center;
      justify-content: center;
    }

    .quick-action-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      padding: 1rem;
      border-radius: var(--border-radius-md);
      transition: transform 0.2s ease, background-color 0.2s ease;
      border: 2px solid transparent;
    }

    .quick-action-item:hover,
    .quick-action-item.active {
      background-color: rgba(255, 255, 255, 0.15);
      transform: translateY(-10px);
    }

    .quick-action-item.active {
      border-color: var(--primary-color);
    }

    .quick-action-item.active .quick-action-icon {
      background-color: rgba(255, 93, 162, 0.3);
    }

    .quick-action-icon {
      width: 80px;
      height: 80px;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 0.75rem;
      transition: background-color 0.2s ease;
    }

    .quick-action-icon i {
      font-size: 2rem;
      color: #ffffff;
    }

    .quick-action-label {
      color: rgba(255, 255, 255, 0.9);
      font-weight: 600;
      font-size: 1rem;
    }

    /* Bond Type Icons */
    .bond-type-icon.prepayment {
      color: #0d6efd;
    }

    .bond-type-icon.performance {
      color: #198754;
    }

    .bond-type-icon.warranty {
      color: #6f42c1;
    }

    /* Modal Form Items */
    .installment-item,
    .bond-item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .installment-item .form-control,
    .bond-item .form-control,
    .bond-item .form-select {
      flex: 1;
    }

    .bond-ref-group {
      display: flex;
      align-items: center;
      gap: 5px;
      flex: 1.5;
    }

    .repayment-basis-config {
      max-height: 150px;
      overflow-y: auto;
      font-size: 0.9em;
    }

    .repayment-basis-config .form-check {
      padding-left: 2em;
    }

    .repayment-basis-config .form-check-label {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: block;
      cursor: pointer;
    }

    .repayment-config-btn {
      text-decoration: none;
      font-size: 0.8em;
      font-weight: normal;
      vertical-align: middle;
    }

    /* Nav Tabs */
    .nav-tabs .nav-link {
      font-weight: 500;
      color: var(--text-secondary);
    }

    .nav-tabs .nav-link.active {
      color: var(--primary-hover);
      border-color: var(--primary-color);
      border-bottom-color: transparent;
    }

    /* ==========================================================================
         9. UTILITY & HELPER CLASSES
         ========================================================================== */
    .text-center-custom {
      text-align: center !important;
    }

    .text-start-custom {
      text-align: left !important;
    }

    .text-end-custom {
      text-align: right !important;
    }

    .text-highlight-amount {
      color: var(--primary-color) !important;
    }

    .text-highlight-vendor {
      color: #4a55a2 !important;
    }

    .text-highlight-paid {
      color: #16a34a !important;
    }

    .usd-amount-toggle {
      cursor: pointer;
      /* Loại bỏ viền và nền khung cũ */
      border: none;
      border-radius: 0;
      padding: 0;
      background-color: transparent;

      /* Định dạng hiển thị */
      color: var(--text-primary);
      display: inline-flex;
      align-items: center;
      font-weight: 600;
      /* In đậm nhẹ để dễ nhìn */
      transition: color 0.2s ease;
    }

    /* Tạo dấu chấm màu phía trước */
    .usd-amount-toggle::before {
      content: "";
      display: inline-block;
      width: 8px;
      height: 8px;
      background-color: #0d6efd;
      /* Màu xanh dương (hoặc đổi thành var(--primary-color) nếu muốn cùng tông) */
      border-radius: 50%;
      /* Bo tròn thành hình chấm bi */
      margin-right: 6px;
      /* Khoảng cách giữa chấm và số tiền */
      flex-shrink: 0;
      box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.2);
      /* Hiệu ứng hào quang nhẹ quanh chấm */
    }

    /* Hiệu ứng khi di chuột vào (Hover) */
    .usd-amount-toggle:hover {
      background-color: transparent;
      /* Đảm bảo không hiện nền khi hover */
      color: #0d6efd;
      /* Đổi màu chữ sang xanh để báo hiệu có thể click */
     
      box-shadow: none;
      /* Loại bỏ bóng đổ cũ */
    }

    .rotate-icon {
      transition: transform 0.3s ease-in-out;
    }

    .rotate-icon.rotated {
      transform: rotate(180deg);
    }

    /* ==========================================================================
         10. TRANSITIONS & ANIMATIONS
         ========================================================================== */
    .slide-fade-enter-active,
    .slide-fade-leave-active {
      transition: all 0.1s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    .slide-fade-enter-from,
    .slide-fade-leave-to {
      opacity: 0;
      transform: translateY(15px);
    }

    .fade-scale-enter-active,
    .fade-scale-leave-active {
      transition: opacity 0.25s ease;
    }

    .fade-scale-enter-active .quick-action-menu,
    .fade-scale-leave-active .quick-action-menu {
      transition: transform 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .fade-scale-enter-from,
    .fade-scale-leave-to {
      opacity: 0;
    }

    .fade-scale-enter-from .quick-action-menu,
    .fade-scale-leave-to .quick-action-menu {
      transform: scale(0.9);
    }

    @keyframes shake {

      10%,
      90% {
        transform: translate3d(-1px, 0, 0) scale(1.15);
      }

      20%,
      80% {
        transform: translate3d(2px, 0, 0) scale(1.15);
      }

      30%,
      50%,
      70% {
        transform: translate3d(-2px, 0, 0) scale(1.15);
      }

      40%,
      60% {
        transform: translate3d(2px, 0, 0) scale(1.15);
      }
    }

    @keyframes ring-animation {

      0%,
      100% {
        transform: rotate(0);
      }

      10%,
      30%,
      50%,
      70%,
      90% {
        transform: rotate(-10deg);
      }

      20%,
      40%,
      60%,
      80% {
        transform: rotate(10deg);
      }
    }

    @keyframes sonar-wave {
      0% {
        transform: scale(0.75);
        opacity: 0.5;
      }

      100% {
        transform: scale(2.5);
        opacity: 0;
      }
    }

    @keyframes highlight-fade {
      from {
        background-color: rgba(20, 184, 166, 0.2);
      }

      to {
        background-color: transparent;
      }
    }

    @keyframes highlight-success-fade {
      from {
        background-color: #d1fae5;
      }

      to {
        background-color: var(--table-bg);
      }
    }

    /* ==========================================================================
         11. PRINT STYLES
         ========================================================================== */
    @media print {
      @page {
        size: landscape;
        margin: 0.5cm;
      }

      html,
      body {
        background-color: #fff !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        width: 100%;
        height: auto;
        font-size: 7pt;
      }

      .no-print {
        display: none !important;
      }

      #app,
      #main-content-wrapper {
        display: block !important;
        padding-left: 0 !important;
        height: auto !important;
        overflow: visible !important;
      }

      .main-content {
        padding: 0 !important;
      }

      .card {
        box-shadow: none !important;
        border: 1px solid #ccc !important;
        margin-bottom: 1rem !important;
        page-break-inside: avoid;
      }

      .table-responsive {
        overflow: visible !important;
        max-height: none !important;
        width: auto;
        transform: scale(0.7);
        transform-origin: top left;
      }

      .table,
      .table-detailed,
      .report-dashboard-table {
        width: 100% !important;
        min-width: 100% !important;
        table-layout: auto !important;
        border-collapse: collapse !important;
      }

      .table-detailed thead th,
      .table-detailed td,
      .report-dashboard-table th,
      .report-dashboard-table td {
        padding: 2px 4px !important;
        font-size: 6pt !important;
        white-space: nowrap !important;
      }

      .table-detailed thead th {
        background-color: #e9ecef !important;
      }

      .table-detailed tfoot td {
        background-color: #f8f9fa !important;
      }

      .table-detailed tbody td {
        background-color: #fff !important;
      }

      .report-dashboard-table thead th {
        background-color: #e9ecef !important;
      }

      .report-dashboard-table thead .header-main th {
        background-color: #a7d7a7 !important;
      }

      .report-dashboard-table thead .sub-header-1 th,
      .report-dashboard-table thead .sub-header-2 th {
        background-color: #ffff00 !important;
      }

      .report-dashboard-table tfoot td {
        background-color: #f8f9fa !important;
      }

      .report-dashboard-table tbody td {
        background-color: #fff !important;
      }

      .report-dashboard-table tbody .category-main,
      .report-dashboard-table tbody .category-main td {
        background-color: #e8dfff !important;
        font-weight: bold !important;
      }

      .remaining-payable-header {
        background-color: yellow !important;
        color: red !important;
      }

      .contract-header-info {
        page-break-after: avoid;
        margin-bottom: 1rem;
      }

      .contract-header-info .row {
        display: flex;
        flex-wrap: wrap;
      }

      .contract-header-info .row>.col-md-6 {
        flex: 0 0 50%;
        max-width: 50%;
        padding-right: 15px;
        padding-left: 15px;
      }

      .contract-header-info .row>.col-12 {
        flex: 0 0 100%;
        max-width: 100%;
      }

      tr {
        page-break-inside: avoid !important;
        page-break-after: auto !important;
      }

      thead {
        display: table-header-group !important;
      }

      tfoot {
        display: table-footer-group !important;
      }
    }

    /* ==========================================================================
               10.5 SIDE MODAL (FOR NOTES)
               ========================================================================== */
    #significantNotesModal {
      position: fixed;
      top: 0;
      right: 0;
      /* width is now controlled by Vue data */
      height: 100vh;
      background-color: #ffffff;
      box-shadow: -5px 0 15px rgba(0, 0, 0, 0.15);
      z-index: 1040;
      display: flex;
      flex-direction: column;
      transform: translateX(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    #significantNotesModal.is-visible {
      transform: translateX(0);
    }

    .resize-handle {
      position: absolute;
      top: 0;
      left: 0;
      width: 8px;
      /* Tăng độ rộng để dễ bắt dính hơn */
      height: 100%;
      cursor: col-resize;
      transform: translateX(-50%);
      /* Canh handle ra giữa cạnh */
      z-index: 10;
      /* Đảm bảo nó nằm trên content của modal */
    }

    .side-modal-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .side-modal-title {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
    }

    .side-modal-body {
      padding: 0 1.5rem 1.5rem;
      /* top | left & right | bottom */
      flex-grow: 1;
      overflow-y: auto;
    }

    .notes-display-area {
      white-space: pre-wrap;
      line-height: 1.6;
    }

    .notes-edit-area textarea {
      height: 100%;
      resize: none;
    }

    .side-modal-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      flex-shrink: 0;
    }

    /* Loại bỏ lớp CSS tĩnh, vì padding-right giờ được quản lý bởi Vue */
    #main-content-wrapper {
      transition: padding-right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .notes-display-area,
    .notes-edit-area [contenteditable] {
      white-space: pre-wrap;
      line-height: 1.6;
    }

    .notes-edit-area [contenteditable] {
      overflow-y: auto;
    }

    /* Styling for pasted tables */
    .notes-display-area table,
    .notes-edit-area table {
      border-collapse: collapse;
      width: 100%;
      margin: 1rem 0;
      font-size: 0.9em;
    }

    .notes-display-area th,
    .notes-display-area td,
    .notes-edit-area th,
    .notes-edit-area td {
      border: 1px solid #ccc;
      padding: 6px 10px;
      text-align: left;
    }

    .notes-display-area th,
    .notes-edit-area th {
      background-color: #f2f2f2;
      font-weight: bold;
    }

    /* --- START: Added code for sticky table header --- */
    .notes-display-area table thead tr,
    .notes-edit-area table thead tr,
    .notes-display-area table tbody tr:first-child,
    .notes-edit-area table tbody tr:first-child {
      position: -webkit-sticky;
      /* For Safari */
      position: sticky;
      top: -1px;
      /* -1px để che đường viền của dòng bên dưới khi cuộn */
      z-index: 1;
    }

    /* Đảm bảo tất cả các ô trong dòng đầu tiên có nền để che nội dung cuộn bên dưới */
    .notes-display-area table tr:first-child th,
    .notes-display-area table tr:first-child td,
    .notes-edit-area table tr:first-child th,
    .notes-edit-area table tr:first-child td {
      background-color: #f2f2f2;
      text-align: center !important;
    }

    /* --- Toolbar soạn thảo --- */
    .editor-toolbar {
      display: flex;
      gap: 0.25rem;
      padding: 0.5rem;
      background-color: #f8f9fa;
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .editor-btn {
      border: 1px solid var(--input-border-color);
      background-color: white;
      color: var(--text-primary);
      border-radius: 4px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .editor-btn:hover {
      background-color: var(--primary-light);
      color: var(--primary-hover);
      border-color: var(--primary-hover);
    }

    .editor-separator {
      width: 1px;
      background-color: var(--border-color);
      margin: 0 0.25rem;
    }

    /* --- Tinh chỉnh hiển thị danh sách trong vùng soạn thảo --- */
    .notes-display-area ul,
    .notes-edit-area ul {
      list-style-type: disc;
      padding-left: 1.5rem;
      margin-bottom: 1rem;
    }

    .notes-display-area ol,
    .notes-edit-area ol {
      list-style-type: decimal;
      padding-left: 1.5rem;
      margin-bottom: 1rem;
    }

    /* --- END: Added code for sticky table header --- */

    /* ==========================================================================
         10.6 SIDE MODAL TABS (FOR NOTES)
         ========================================================================== */
    .notes-tabs-container {
      border-bottom: 1px solid var(--border-color);
      padding: 0 1.5rem;
      flex-shrink: 0;
    }

    .notes-tabs-container .nav-tabs {
      border-bottom: none;
    }

    .notes-tabs-container .nav-link {
      padding: 0.75rem 1rem;
      border-top-left-radius: var(--border-radius-sm);
      border-top-right-radius: var(--border-radius-sm);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .notes-tabs-container .nav-link.active {
      background-color: var(--body-bg);
      border-color: var(--border-color) var(--border-color) var(--body-bg);
    }

    .notes-tabs-container .nav-link:not(.active):hover {
      background-color: #f8f9fa;
    }

    .notes-tab-add-btn {
      color: var(--primary-color);
      font-size: 1.2rem;
    }

    .notes-tab-add-btn:hover {
      color: var(--primary-hover);
    }

    .notes-tab-delete-btn {
      font-size: 0.8em;
      padding: 2px 4px;
      border-radius: 50%;
      line-height: 1;
      opacity: 0.6;
    }

    .notes-tab-delete-btn:hover {
      background-color: rgba(0, 0, 0, 0.1);
      opacity: 1;
    }

    .notes-tab-title-input {
      border: none;
      background-color: transparent;
      padding: 0;
      margin: 0;
      font: inherit;
      width: 150px;
      outline: none;
      border-bottom: 1px dashed var(--primary-color);
    }

    .side-modal-body .tab-content {
      height: 100%;
    }

    .side-modal-body .tab-pane {
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    /* --- TÙY CHỈNH MODAL HƯỚNG DẪN ĐỂ TRÁNH THANH TRƯỢT NGANG --- */

    /* 1. Mở rộng chiều rộng Modal Guide lên 90% màn hình (mặc định xl chỉ khoảng 1140px) */
    @media (min-width: 992px) {
      #guideModal .modal-dialog {
        max-width: 90vw !important;
        /* Sử dụng 90% chiều rộng viewport */
      }
    }

    /* 2. Bắt buộc nội dung trong bảng hướng dẫn phải xuống dòng */
    #guideModal .table td,
    #guideModal .table th {
      white-space: normal !important;
      /* Cho phép xuống dòng */
      word-break: break-word;
      /* Ngắt từ nếu quá dài */
      vertical-align: middle;
      /* Căn giữa theo chiều dọc cho đẹp */
    }

    /* 3. Đảm bảo container của bảng không chiếm quá không gian cho phép */
    #guideModal .table-responsive {
      overflow-x: hidden;
      /* Ẩn thanh trượt ngang nếu tính toán dư 1-2px */
    }

    /* --- ICON KHIÊN CẢNH BÁO BOND (NEW ANIMATION) --- */

    .bond-shield-icon {
      font-size: 1.2rem;
      /* Tăng kích thước một chút cho dễ nhìn */
      cursor: pointer;
      margin-left: 8px;
      transition: transform 0.2s ease-out;
      display: inline-block;
      /* Cần thiết để transform hoạt động mượt */
    }

    .bond-shield-icon:hover {
      transform: scale(1.2);
      /* Phóng to nhẹ khi hover */
    }

    /* 1. Quá hạn: Màu đỏ + Nhịp tim gấp gáp + Phát sáng */
    .shield-danger {
      color: #dc3545;
      /* Tạo viền sáng mờ xung quanh để nổi bật trên nền trắng */
      filter: drop-shadow(0 0 4px rgba(220, 53, 69, 0.6));
      animation: shield-heartbeat 1.5s ease-in-out infinite;
    }

    /* 2. Sắp hết hạn: Màu cam + Đung đưa (Swing) như chuông cảnh báo */
    .shield-warning {
      color: #f59e0b;
      animation: shield-swing 2s ease-in-out infinite;
      transform-origin: top center;
      /* Đung đưa từ đỉnh */
    }

    /* Animation Nhịp tim (Heartbeat) - Dồn dập nhưng êm */
    @keyframes shield-heartbeat {
      0% {
        transform: scale(1);
      }

      14% {
        transform: scale(1.3);
      }

      28% {
        transform: scale(1);
      }

      42% {
        transform: scale(1.3);
      }

      70% {
        transform: scale(1);
      }
    }

    /* Animation Đung đưa (Swing) */
    @keyframes shield-swing {
      0% {
        transform: rotate(0deg);
      }

      20% {
        transform: rotate(15deg);
      }

      40% {
        transform: rotate(-10deg);
      }

      60% {
        transform: rotate(5deg);
      }

      80% {
        transform: rotate(-5deg);
      }

      100% {
        transform: rotate(0deg);
      }
    }

    /* --- BOND TREE VIEW STYLES --- */
    .bond-main-row {
      background-color: #fff;
      border-left: 4px solid transparent;
      transition: all 0.2s ease;
    }

    /* Đổi màu viền trái dựa theo trạng thái để nhận diện nhanh */
    .bond-main-row.status-active {
      border-left-color: var(--primary-color);
    }

    .bond-main-row.status-warning {
      border-left-color: #f59e0b;
    }

    .bond-main-row.status-danger {
      border-left-color: #dc3545;
    }

    .bond-main-row.status-settled {
      border-left-color: #198754;
    }

    .bond-history-row {
      background-color: #f8f9fa !important;
      color: #6c757d;
      font-size: 0.9em;
    }

    .bond-history-row td {
      border-top: none !important;
      padding-top: 0.5rem;
      padding-bottom: 0.5rem;
    }

    /* Đường nối cây thư mục */
    .tree-connector {
      position: relative;
      height: 100%;
      width: 20px;
      display: inline-block;
      margin-right: 10px;
    }

    .tree-connector::before {
      content: "";
      position: absolute;
      top: -50%;
      /* Nối từ dòng trên */
      left: 10px;
      border-left: 2px solid #dee2e6;
      height: 100%;
    }

    .tree-connector::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 10px;
      border-top: 2px solid #dee2e6;
      width: 10px;
    }

    /* Làm mờ text của bond cũ */
    .text-old-bond {
      text-decoration: line-through;
      opacity: 0.7;
    }

    .badge-history {
      background-color: #e9ecef;
      color: #495057;
      border: 1px solid #ced4da;
      font-weight: normal;
    }

    /* --- HIỆU ỨNG CHEVRON XOAY --- */
    .rotate-icon {
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-block;
    }

    .rotate-icon.open {
      transform: rotate(90deg);
      /* Xoay 90 độ khi mở */
      color: var(--primary-color);
    }

    /* --- HIỆU ỨNG XUẤT HIỆN SUB-ROW --- */
    .bond-history-row {
      background-color: #f8f9fa !important;
      animation: slideDownFade 0.3s ease-out forwards;
      transform-origin: top;
    }

    @keyframes slideDownFade {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* --- CÂY THƯ MỤC (Cập nhật) --- */
    .tree-connector-container {
      height: 100%;
      display: flex;
      align-items: center;
      padding-left: 10px;
      /* Thụt đầu dòng */
    }

    .tree-connector-corner {
      width: 15px;
      height: 25px;
      /* Chiều cao nối lên dòng trên */
      border-left: 2px solid #dee2e6;
      border-bottom: 2px solid #dee2e6;
      border-bottom-left-radius: 8px;
      /* Bo góc cho mềm mại */
      margin-right: 8px;
      margin-top: -18px;
      /* Đẩy lên để nối với dòng cha */
    }

    /* --- CẬP NHẬT SIDEBAR LOGIC --- */

    /* 1. Sidebar Styles */
    #main-nav {
      width: var(--nav-width);
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1030;
      background: linear-gradient(180deg,
          var(--gradient-start) 0%,
          var(--gradient-end) 100%);
      box-shadow: var(--shadow-lg);
      display: flex;
      flex-direction: column;
      transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
    }

    /* Logic cũ: Hover thì mở rộng */
    #main-nav:not(.sidebar-fixed):hover {
      width: var(--nav-width-expanded);
    }

    /* Logic MỚI: Nếu có class .sidebar-fixed thì luôn mở rộng */
    #main-nav.sidebar-fixed {
      width: var(--nav-width-expanded);
    }

    /* 2. Main Content Wrapper Styles */
    #main-content-wrapper {
      flex-grow: 1;
      padding-left: var(--nav-width);
      /* Mặc định hẹp */
      transition: padding-left 0.3s ease;
      /* Khớp với transition của sidebar */
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* Logic cũ: Hover sidebar thì đẩy content */
    #main-nav:not(.sidebar-fixed):hover~#main-content-wrapper {
      padding-left: var(--nav-width-expanded);
    }

    /* Logic MỚI: Nếu sidebar fixed thì content luôn bị đẩy */
    #main-nav.sidebar-fixed~#main-content-wrapper {
      padding-left: var(--nav-width-expanded);
    }

    /* 3. Nút Ghim/Bỏ ghim ở đáy Sidebar */
    .nav-footer {
      margin-top: auto;
      /* Đẩy xuống đáy */
      padding: 10px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .nav-footer a {
      display: flex;
      align-items: center;
      height: 50px;
      padding: 0 18px;
      color: rgba(255, 255, 255, 0.6);
      text-decoration: none;
      border-radius: var(--border-radius-md);
      white-space: nowrap;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .nav-footer a:hover {
      background-color: rgba(255, 255, 255, 0.1);
      color: #fff;
    }

    /* Hiệu ứng xoay icon ghim */
    .pin-icon {
      transition: transform 0.3s ease, color 0.3s ease;
    }

    .sidebar-fixed .pin-icon {
      transform: rotate(45deg);
      /* Xoay nghiêng khi đã ghim */
      color: #fff;
    }

    /* Hiển thị text khi hover hoặc khi fixed */
    #main-nav:hover .nav-label,
    #main-nav.sidebar-fixed .nav-label {
      opacity: 1;
      transition-delay: 0.1s;
    }

    #main-nav:hover .nav-menu a,
    #main-nav.sidebar-fixed .nav-menu a {
      justify-content: flex-start;
      padding: 0 20px;
    }

    /* --- BOND TYPE HIGHLIGHT COLORS --- */
    /* 1. Bảo lãnh Tạm ứng: Màu Xanh Dương */
    .text-bond-prepayment {
      color: #0d6efd !important;
      font-weight: 600;
    }

    /* 2. Bảo lãnh Thực hiện HĐ: Màu Xanh Lá */
    .text-bond-performance {
      color: #198754 !important;
      font-weight: 600;
    }

    /* 3. Bảo lãnh Bảo hành: Màu Tím */
    .text-bond-warranty {
      color: #6f42c1 !important;
      font-weight: 600;
    }

    /* --- CUSTOM MODAL STYLES --- */
    /* GIAO DIỆN TAB HIỆN ĐẠI - FIX TRIỆT ĐỂ */
    ul[id="cpcModalTab"] {
      background-color: #f1f5f9 !important;
      padding: 5px !important;
      border-radius: 12px !important;
      border: none !important;
      display: flex !important;
      flex-direction: row !important;
      gap: 5px !important;
      margin-bottom: 25px !important;
      list-style: none !important;
    }

    ul[id="cpcModalTab"] .nav-item {
      flex: 1 !important;
      margin: 0 !important;
    }

    ul[id="cpcModalTab"] .nav-link {
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      width: 100% !important;
      border: none !important;
      border-radius: 9px !important;
      padding: 10px 15px !important;
      color: #64748b !important;
      /* Màu xám hiện đại */
      font-weight: 600 !important;
      font-size: 0.85rem !important;
      text-decoration: none !important;
      /* Xóa gạch chân của link */
      background: transparent !important;
      transition: all 0.2s ease !important;
    }

    /* Hiệu ứng khi Active (Đang chọn) */
    ul[id="cpcModalTab"] .nav-link.active {
      background-color: #ffffff !important;
      color: #ff5da2 !important;
      /* Màu hồng/teal chủ đạo của bạn */
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08) !important;
    }

    /* Hiệu ứng khi Hover */
    ul[id="cpcModalTab"] .nav-link:hover:not(.active) {
      background-color: rgba(255, 255, 255, 0.5) !important;
      color: #334155 !important;
    }

    /* Icon bên trong */
    ul[id="cpcModalTab"] .nav-link i {
      margin-right: 8px !important;
      font-size: 1rem !important;
    }

    .form-section-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #adb5bd;
      font-weight: 700;
      margin-bottom: 1rem;
      margin-top: 0.5rem;
      border-bottom: 1px dashed #dee2e6;
      padding-bottom: 0.5rem;
    }

    .bg-soft-primary {
      background-color: #f0f7ff;
    }

    .bg-soft-warning {
      background-color: #fff8e1;
    }

    .readonly-field {
      background-color: #f8f9fa;
      border-color: #e9ecef;
      color: #495057;
      font-family: monospace;
      /* Font đơn cách cho mã số */
    }

    /* Overview Header Styles */
    .overview-card {
      background: #fff;
      border-radius: var(--border-radius-md);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
      padding: 1.25rem 1.5rem;
      margin-bottom: 1.5rem;
    }

    .overview-header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #f1f5f9;
      padding-bottom: 1rem;
      margin-bottom: 1.5rem;
    }

    .overview-title h4 {
      color: #1e293b;
      font-weight: 700;
      margin: 0;
    }

    .overview-title span {
      color: #64748b;
      font-size: 0.85rem;
    }

    /* Stat Cards */
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1rem;
    }

    .stat-card {
      padding: 1.25rem;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      transition: transform 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-3px);
    }

    .stat-card .label {
      display: block;
      font-size: 0.75rem;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      margin-bottom: 0.5rem;
    }

    .stat-card .value {
      font-size: 1.4rem;
      font-weight: 800;
      margin: 0;
    }

    .stat-icon-bg {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    /* Themes for Cards */
    .card-vnd {
      background-color: #f0fdf4;
      border-color: #bbf7d0;
    }

    .card-vnd .value {
      color: #15803d;
    }

    .card-vnd .stat-icon-bg {
      background: #dcfce7;
      color: #22c55e;
    }

    .card-usd {
      background-color: #eff6ff;
      border-color: #bfdbfe;
    }

    .card-usd .value {
      color: #1d4ed8;
    }

    .card-usd .stat-icon-bg {
      background: #dbeafe;
      color: #3b82f6;
    }

    .card-swap {
      background-color: #f5f3ff;
      border-color: #ddd6fe;
    }

    .card-swap .value {
      color: #6d28d9;
    }

    .card-swap .stat-icon-bg {
      background: #ede9fe;
      color: #8b5cf6;
    }

    .card-trans {
      background-color: #ffffff;
      border-color: #e2e8f0;
    }

    .card-trans .value {
      color: #1e293b;
    }

    .card-trans .stat-icon-bg {
      background: #f1f5f9;
      color: #64748b;
    }

    .year-nav-group {
      background: #f1f5f9;
      padding: 4px;
      border-radius: 8px;
      display: flex;
      align-items: center;
    }

    .year-display {
      padding: 0 12px;
      font-weight: 800;
      color: #1e293b;
      min-width: 60px;
      text-align: center;
    }

    /* CPC ACTION CENTER RE-DESIGN */
    .tracking-dashboard-header {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      /* Chia đều 3 cột trên 1 hàng */
      gap: 1rem;
      margin-bottom: 1.5rem;
      width: 100%;
    }

    .action-section {
      background: #fff;
      border-radius: 16px;
      border: 1px solid #eef2f6;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .action-section-header {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid #f8fafc;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .action-section-header h6 {
      margin: 0;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.75rem;
    }

    .scroll-area {
      max-height: 280px;
      /* Khống chế chiều cao để không bị quá dài */
      overflow-y: auto;
      padding: 0.5rem;
    }

    .compact-item {
      display: flex;
      align-items: center;
      padding: 0.75rem 1rem;
      border-radius: 12px;
      margin-bottom: 0.5rem;
      transition: all 0.2s ease;
      cursor: pointer;
      border: 1px solid transparent;
    }

    .compact-item:hover {
      background-color: #f8fafc;
      border-color: #e2e8f0;
      transform: translateX(4px);
    }

    .compact-item .icon-box {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 1rem;
      flex-shrink: 0;
    }

    .item-content {
      flex-grow: 1;
      overflow: hidden;
    }

    .item-title {
      font-weight: 600;
      font-size: 0.9rem;
      color: #1e293b;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .item-sub {
      font-size: 0.75rem;
      color: #64748b;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .item-badge-group {
      text-align: right;
      min-width: 100px;
    }

    .amount-text {
      font-weight: 800;
      font-size: 0.9rem;
      margin-bottom: 2px;
    }

    /* Colors for Tracking Dashboard */
    .bg-soft-red {
      background-color: #fff1f2;
      color: #e11d48;
    }

    .bg-soft-amber {
      background-color: #fffbeb;
      color: #d97706;
    }

    .border-overdue {
      border-left: 4px solid #e11d48 !important;
    }

    .border-upcoming {
      border-left: 4px solid #f59e0b !important;
    }

    /* Scrollbar tuning */
    .scroll-area::-webkit-scrollbar {
      width: 4px;
    }

    .scroll-area::-webkit-scrollbar-thumb {
      background: #e2e8f0;
      border-radius: 10px;
    }

    .repayment-basis-container {
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      background: #fff;
      overflow: hidden;
      margin-top: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .basis-toolbar {
      background: #f8fafc;
      padding: 8px 12px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .basis-scroll-area {
      max-height: 250px;
      overflow-y: auto;
    }

    .basis-row {
      display: grid;
      grid-template-columns: 40px 60px 1fr 120px 120px;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid #f1f5f9;
      transition: background 0.2s;
      cursor: pointer;
    }

    .basis-row:hover {
      background-color: #f0f9ff;
    }

    .basis-row.selected {
      background-color: #f0f7ff;
    }

    .basis-label {
      font-size: 0.85rem;
      font-weight: 500;
      color: #334155;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .basis-value {
      font-family: "Inter", sans-serif;
      font-size: 0.8rem;
      text-align: right;
      font-weight: 600;
    }

    .text-contract {
      color: #0369a1;
    }

    .text-von {
      color: #0891b2;
    }

    .basis-header-row {
      display: grid;
      grid-template-columns: 40px 60px 1fr 120px 120px;
      background: #f1f5f9;
      padding: 6px 12px;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      color: #64748b;
    }

    /* Ẩn nút tăng giảm cho Chrome, Safari, Edge, Opera */
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* Ẩn nút tăng giảm cho Firefox */
    input[type="number"] {
      -moz-appearance: textfield;
    }

    /* --- THIẾT KẾ BỘ LỌC MỚI (INTEGRATED FILTER) --- */
    .filter-wrapper {
      background: #fff;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-md);
      margin-bottom: 1.5rem;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Header của bộ lọc luôn hiển thị */
    .filter-header-bar {
      padding: 0.75rem 1.25rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #f8fafc;
      cursor: pointer;
      user-select: none;
    }

    .filter-header-bar:hover {
      background: #f1f5f9;
    }

    /* Nội dung bộ lọc khi mở rộng */
    .filter-expand-content {
      max-height: 0;
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      visibility: hidden;
      padding: 0 1.5rem;
    }

    .filter-wrapper.is-expanded .filter-expand-content {
      max-height: 1000px;
      /* Giá trị đủ lớn để chứa nội dung */
      opacity: 1;
      visibility: visible;
      padding: 1.5rem;
      border-top: 1px solid var(--border-color);
    }

    /* Animation cho icon mũi tên */
    .filter-toggle-icon {
      transition: transform 0.4s ease;
    }

    .is-expanded .filter-toggle-icon {
      transform: rotate(180deg);
    }

    /* Chỉnh lại Filter Grid để khít hơn */
    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.25rem;
    }

    /* Tùy chỉnh Vue Transition cho mượt hơn */
    .filter-slide-enter-active,
    .filter-slide-leave-active {
      transition: all 0.4s ease-in-out;
      max-height: 500px;
    }

    .filter-slide-enter-from,
    .filter-slide-leave-to {
      max-height: 0;
      opacity: 0;
    }

    /* Tùy chỉnh riêng cho hàng con của SWAP để khớp alignment */
    .bond-history-row td {
      background-color: #fcfcfc !important;
      border-top: 1px dashed #eee !important;
      padding: 0.5rem 0.6rem !important;
      /* Phải khớp với padding row chính của Dashboard */
      font-size: 0.85rem;
    }

    .bond-history-row .tree-connector-corner {
      border-left: 2px solid #ddd;
      border-bottom: 2px solid #ddd;
      width: 12px;
      height: 15px;
      margin-left: 10px;
    }

    /* Khung chứa các badge */
    .badge-container-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
      perspective: 1000px;
      /* Tạo độ sâu cho 3D transform */
    }

    /* Cấu trúc Animation mượt mà */
    .badge-pop-enter-active {
      /* Sử dụng hiệu ứng Elastic Out: nảy nhẹ và dừng êm */
      transition:
        opacity 0.6s ease,
        transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1),
        filter 0.6s ease;
    }

    .badge-pop-leave-active {
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: absolute;
      /* Giúp các badge còn lại trượt mượt mà khi 1 cái biến mất */
    }

    .badge-pop-enter-from {
      opacity: 0;
      transform: translateY(20px) scale(0.6) rotateX(-20deg);
      filter: blur(8px);
    }

    .badge-pop-leave-to {
      opacity: 0;
      transform: translateY(-10px) scale(0.9);
      filter: blur(4px);
    }

    /* Hiệu ứng trượt (Move) - Cực kỳ quan trọng để mượt */
    .badge-pop-move {
      transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    /* Delay tuần tự (Stagger) */
    .badge-pop-enter-active:nth-child(1) {
      transition-delay: 0.05s;
    }

    .badge-pop-enter-active:nth-child(2) {
      transition-delay: 0.15s;
    }

    .badge-pop-enter-active:nth-child(3) {
      transition-delay: 0.25s;
    }

    /* Thiết kế Badge Modern (Glassmorphism) */
    .modern-stat-badge {
      height: 30px;
      padding: 0 14px !important;
      display: inline-flex !important;
      align-items: center;
      justify-content: center;
      border-radius: 50px !important;
      font-weight: 600 !important;
      font-size: 0.72rem !important;
      border: 1px solid rgba(255, 255, 255, 0.4) !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(4px);
    }

    /* Hiệu ứng Overdue (Red Pulse) */
    .badge-overdue {
      background: linear-gradient(135deg, #ff4d4d, #dc3545) !important;
      box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
    }

    /* Hiệu ứng Partial (Blue Glow) */
    .badge-partial {
      background: linear-gradient(135deg, #4facfe, #00f2fe) !important;
      color: #003366 !important;
      box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
    }

    /* Hiệu ứng Upcoming (Amber Shine) */
    .badge-upcoming {
      background: linear-gradient(135deg, #f6d365, #fda085) !important;
      color: #7d4a00 !important;
      box-shadow: 0 4px 15px rgba(246, 211, 101, 0.3);
    }

    /* Tùy chỉnh Tab Master Data phong cách hiện đại */
    .master-data-tabs-container {
      background-color: #f1f5f9;
      /* Nền xám nhạt giống modal */
      padding: 6px;
      border-radius: 14px;
      display: flex;
      gap: 6px;
      margin-bottom: 2rem;
      border: 1px solid #e2e8f0;
    }

    .master-data-tabs-container .nav-item {
      flex: 1;
      list-style: none;
    }

    .master-data-tabs-container .nav-link {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px 20px;
      border-radius: 10px;
      border: none !important;
      color: #64748b;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: transparent;
      text-decoration: none;
    }

    /* Hiệu ứng khi Active */
    .master-data-tabs-container .nav-link.active {
      background-color: #ffffff !important;
      color: var(--primary-color) !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      transform: translateY(0);
    }

    /* Hiệu ứng khi Hover */
    .master-data-tabs-container .nav-link:hover:not(.active) {
      background-color: rgba(255, 255, 255, 0.5);
      color: #334155;
    }

    .master-data-tabs-container .nav-link i {
      font-size: 1.1rem;
      transition: transform 0.3s ease;
    }

    .master-data-tabs-container .nav-link.active i {
      transform: scale(1.1);
    }

    /* Toolbar hành động cho Tab Details */
    .details-action-bar {
      background-color: #ffffff;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      box-shadow: var(--shadow-sm);
      margin-bottom: 1.5rem;
    }

    .details-action-bar .group-label {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      color: #94a3b8;
      margin-bottom: 4px;
      display: block;
      letter-spacing: 0.5px;
    }

    .btn-action-soft {
      background-color: #f8fafc;
      border: 1px solid #e2e8f0;
      color: #475569;
      font-size: 0.85rem;
      padding: 6px 12px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
    }

    .btn-action-soft:hover:not(:disabled) {
      background-color: #f1f5f9;
      border-color: #cbd5e1;
      color: var(--primary-color);
      transform: translateY(-1px);
    }

    .btn-action-soft i {
      font-size: 1rem;
    }

    /* Nút tiền tệ nổi bật khi ở chế độ USD */
    .btn-currency-active {
      background-color: #eff6ff;
      border-color: #bfdbfe;
      color: #2563eb;
      font-weight: 600;
    }

    .bg-soft-success {
      background-color: rgba(34, 197, 94, 0.05) !important;
    }

    .bg-soft-warning {
      background-color: rgba(245, 158, 11, 0.05) !important;
    }

    .hover-bg-light:hover {
      background-color: #f8fafc;
    }

    @media print {

      /* Loại bỏ giới hạn chiều rộng khi xuất PDF để thư viện tự scale */
      .table-detailed {
        min-width: auto !important;
        width: 100% !important;
        font-size: 7pt !important;
        /* Chữ nhỏ lại để vừa trang */
      }

      /* Ẩn các nút thao tác nhanh trong PDF */
      .delete-corner-btn,
      .add-below-btn,
      .send-cpc-btn,
      .no-print {
        display: none !important;
      }

      /* Đảm bảo bảng không bị cắt ngang hàng */
      tr {
        page-break-inside: avoid !important;
      }
    }

    /* CSS hỗ trợ riêng cho tiến trình render ảnh của html2pdf */
    .html2pdf__page-break {
      display: block;
      height: 0;
      page-break-before: always;
    }

    /* Vendor Partner Specific Styles */
    .vendor-sidebar {
      background: #fff;
      border-right: 1px solid #edf2f7;
      height: calc(100vh - var(--header-height));
      overflow-y: auto;
    }

    .vendor-item {
      padding: 1rem;
      border-bottom: 1px solid #f7fafc;
      cursor: pointer;
      transition: all 0.2s;
    }

    .vendor-item:hover,
    .vendor-item.active {
      background-color: #f8faff;
      border-left: 4px solid var(--primary-color);
    }

    .vendor-main-card {
      background: #fff;
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      margin-bottom: 1.5rem;
    }

    .stat-card-dark {
      background: #0f172a;
      color: #fff;
      border-radius: 16px;
      padding: 1.5rem;
      position: relative;
      overflow: hidden;
    }

    .stat-card-dark .progress {
      background: rgba(255, 255, 255, 0.1);
      height: 6px;
    }

    .vendor-avatar-box {
      width: 64px;
      height: 64px;
      background: #3b82f6;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.5rem;
    }

    .table-modern thead th {
      background: #f8fafc;
      color: #64748b;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
      border: none;
    }

    /* Thiết kế Action Bar cho Master Data */
    .master-data-toolbar {
      background: #ffffff;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-sm);
    }

    .toolbar-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toolbar-label {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      color: #94a3b8;
      margin-bottom: 4px;
      display: block;
      letter-spacing: 0.5px;
    }

    /* Nút kiểu Soft Design */
    .btn-soft-primary {
      background: #eff6ff;
      color: #2563eb;
      border: 1px solid #dbeafe;
    }

    .btn-soft-primary:hover {
      background: #2563eb;
      color: #fff;
    }

    .btn-soft-success {
      background: #f0fdf4;
      color: #16a34a;
      border: 1px solid #dcfce7;
    }

    .btn-soft-success:hover {
      background: #16a34a;
      color: #fff;
    }

    .btn-soft-warning {
      background: #fffbeb;
      color: #d97706;
      border: 1px solid #fef3c7;
    }

    .btn-soft-warning:hover {
      background: #d97706;
      color: #fff;
    }

    .btn-soft-info {
      background: #f0f9ff;
      color: #0891b2;
      border: 1px solid #e0f2fe;
    }

    .btn-soft-info:hover {
      background: #0891b2;
      color: #fff;
    }

    /* Ô tìm kiếm tập trung */
    .search-input-group {
      min-width: 300px;
    }

    .search-input-group .form-control {
      background: #f8fafc;
      border-radius: 8px !important;
    }

    /* --- MODERN PAGINATION STYLES --- */
    .pagination-wrapper {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.25rem 0;
      margin-top: 1rem;
    }

    .modern-pagination-container {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #ffffff;
      padding: 6px 12px;
      border-radius: 50px;
      border: 1px solid #e2e8f0;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }

    .btn-pagination-modern {
      height: 38px;
      padding: 0 16px;
      border-radius: 50px !important;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      color: #475569;
      background-color: #f8fafc;
      border: 1px solid #e2e8f0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .btn-pagination-modern:hover:not(:disabled) {
      background-color: var(--primary-color);
      color: #ffffff;
      border-color: var(--primary-color);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 93, 162, 0.25);
    }

    .btn-pagination-modern:disabled {
      opacity: 0.4;
      background-color: #f1f5f9;
      cursor: not-allowed;
    }

    .page-info-pill {
      padding: 6px 16px;
      background: #f1f5f9;
      border-radius: 50px;
      font-size: 0.85rem;
      font-weight: 700;
      color: #1e293b;
      min-width: 100px;
      text-align: center;
    }

    .entries-info-text {
      font-size: 0.85rem;
      color: #64748b;
      font-style: italic;
    }
  </style>

<body>
  <div id="app">
    <div id="main-nav" class="no-print" :class="{ 'sidebar-fixed': isSidebarFixed }">
      <div class="nav-header">
        <i data-lucide="eye"></i>
      </div>

      <nav class="nav-menu">
        <!-- (Các menu item cũ giữ nguyên) -->
        <a v-for="(tab, index) in sidebarTabs" :key="tab.key" href="#" :class="{ 
               active: currentTab === tab.key,
               'sidebar-nav-focus': isSidebarNavigating && sidebarNavIndex === index
           }" @click.prevent="currentTab = tab.key">
          <i :data-lucide="getIconForKey(tab.key)" class="nav-icon"></i>
          <span class="nav-label">{{ tab.label }}</span>
        </a>
      </nav>

      <div class="nav-footer">
        <a href="#" @click.prevent="toggleSidebarFixed" :title="isSidebarFixed ? t('sidebarUnpin') : t('sidebarPin')">
          <i data-lucide="pin" class="nav-icon pin-icon"></i>
          <span class="nav-label">
            {{ isSidebarFixed ? t('sidebarUnpin') : t('sidebarPin') }}
          </span>
        </a>
      </div>
    </div>

    <div id="main-content-wrapper" ref="mainContentWrapper" :class="{ 'collapsed': isSidebarCollapsed }"
      :style="{ paddingRight: isNotesModalVisible ? notesPanelWidth + 'px' : '0' }">
      <header class="main-header no-print">
        <h2 class="m-0 ms-4 page-title">
          {{ t(currentTab.replace(/-/g, '')) }}
        </h2>
        <div class="ms-auto d-flex align-items-center gap-3">
          <button class="btn btn-outline-primary d-flex align-items-center" @click="openProjectBackupModal"
            :aria-label="t('btnBackupProject')">
            <i data-lucide="archive" class="me-2" style="width: 20px; height: 20px"></i>
            <span>{{ t('btnBackupProject') }}</span>
          </button>
          <button class="btn btn-outline-primary d-flex align-items-center" @click="triggerProjectImport"
            :aria-label="t('btnImportProject')">
            <i data-lucide="archive-restore" class="me-2" style="width: 20px; height: 20px"></i>
            <span>{{ t('btnImportProject') }}</span>
          </button>
          <button class="btn btn-outline-secondary d-flex align-items-center" @click="backupDataToFile"
            :aria-label="t('btnSaveToFile')">
            <i data-lucide="save" class="me-2" style="width: 20px; height: 20px"></i>
            <span>{{ t('btnBackup') }}</span>
          </button>
          <button class="btn btn-outline-secondary d-flex align-items-center" @click="triggerFileOpen"
            :aria-label="t('btnOpenFile')">
            <i data-lucide="folder-open" class="me-2" style="width: 20px; height: 20px"></i>
            <span>{{ t('btnRestore') }}</span>
          </button>

          <button class="btn btn-info btn-icon rounded-circle" @click="openGuideModal" data-bs-toggle="tooltip">
            <i data-lucide="help-circle"></i>
          </button>
          <button class="btn btn-outline-secondary d-flex align-items-center" @click="toggleLanguage"
            :aria-label="t('toggleLanguage')">
            <i data-lucide="languages" class="me-2" style="width: 20px; height: 20px"></i>
            <span class="fw-bold">{{ language.toUpperCase() }}</span>
          </button>
          <div class="notification-bell-container dropdown">
            <button ref="notificationBellButton" class="notification-bell-button"
              :class="{ 'ringing-red': hasOverdueBonds }" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i data-lucide="bell"></i>
              <span class="notification-badge badge rounded-pill" v-if="expiringBonds.length > 0">{{
                expiringBonds.length }}</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end notification-dropdown-menu p-2"
              aria-labelledby="notificationDropdown" data-bs-auto-close="outside">
              <li class="dropdown-header px-2">
                {{ t('notificationHeader') }}
              </li>
              <li>
                <hr class="dropdown-divider" />
              </li>
              <div class="notification-item-container">
                <template v-if="expiringBonds.length > 0">
                  <li>
                    <hr class="dropdown-divider my-2" />
                  </li>
                  <li class="text-center px-3 py-1">
                    <a href="#" @click.prevent="goToFilteredBondDashboard" class="btn btn-sm btn-outline-primary w-100">
                      <i class="fas fa-tasks me-2"></i>
                      {{ t('duebond') }}
                    </a>
                  </li>
                  <li v-for="(bond, index) in expiringBonds" :key="index" class="notification-item m-1">
                    <div class="p-2 rounded" :class="bond.status === 'Overdue' ? 'bg-danger-light' : 'bg-warning-light'"
                      style="border-left: 5px solid"
                      :style="{ borderColor: bond.status === 'Overdue' ? '#dc3545' : '#ffc107' }">
                      <div @click.stop="toggleNotificationExpansion(bond.id)" style="cursor: pointer"
                        class="d-flex justify-content-between align-items-center">
                        <div>
                          <div>
                            <strong>{{ t('contract') }}:</strong>
                            <a href="#" @click.prevent.stop="goToBondDashboard(bond)" class="table-link">
                              {{ bond.contractNo }}
                            </a>
                          </div>
                          <div class="fw-bold" :class="bond.status === 'Overdue' ? 'text-danger' : 'text-warning-dark'">
                            <i class="fas fa-exclamation-circle me-1"></i>
                            {{ bond.message }}
                          </div>
                        </div>
                        <i class="fas fa-chevron-down rotate-icon p-2"
                          :class="{'rotated': isNotificationExpanded(bond.id)}"></i>
                      </div>

                      <div v-if="isNotificationExpanded(bond.id)" class="mt-2 pt-2 border-top small">
                        <div>
                          <strong>{{ t('bond') }}:</strong> {{
                          bond.bondNumber }} ({{ bond.bondType }})
                        </div>
                        <div>
                          <strong>{{ t('amount') }}:</strong> {{
                          formatCurrency(bond.amount) }}
                        </div>
                        <div>
                          <strong>{{ t('expiryDate') }}:</strong> {{
                          bond.expiryDate }}
                        </div>
                        <div>
                          <strong>{{ t('issuingBank') }}:</strong> {{
                          bond.issuingBankName }}
                        </div>
                      </div>
                    </div>
                  </li>
                </template>
                <template v-else>
                  <li class="notification-item text-center text-muted p-3">
                    {{ t('noNotifications') }}
                  </li>
                </template>
              </div>
            </ul>
          </div>
        </div>
      </header>

      <main class="main-content">
        <div class="toast-container no-print">
          <div v-for="toast in toasts" :key="toast.id" :data-toast-id="toast.id"
            :class="['toast-notification', toast.type]">
            <i class="toast-icon" :class="{
                            'fas fa-info-circle': toast.type === 'info',
                            'fas fa-check-circle': toast.type === 'success',
                            'fas fa-exclamation-triangle': toast.type === 'warning',
                            'fas fa-times-circle': toast.type === 'error'
                        }"></i>
            <span>{{ toast.message }}</span>
          </div>
        </div>

        <transition name="slide-fade" mode="out-in">
          <div :key="currentTab">
            <div v-if="currentTab === 'cpc-tracking'">
              <div class="action-buttons-container no-print d-flex align-items-center mb-4">
                <button class="btn btn-primary shadow-sm px-4" @click="addNewCpcItem">
                  <i class="fas fa-plus me-2"></i> {{ t('btnAddCpc') }}
                </button>
                <button class="btn btn-outline-danger ms-auto" @click="clearAllData">
                  <i class="fas fa-trash-alt me-2"></i> {{ t('btnClearAll')
                  }}
                </button>
              </div>

              <!-- START: TOGGLEABLE CPC ACTION CENTER -->
              <div class="filter-wrapper no-print mb-4"
                :class="{ 'is-expanded': !viewStates.cpcTracking.isActionCenterCollapsed }">
                <div class="filter-header-bar"
                  @click="viewStates.cpcTracking.isActionCenterCollapsed = !viewStates.cpcTracking.isActionCenterCollapsed">
                  <div class="d-flex align-items-center flex-grow-1">
                    <div class="stat-icon-bg bg-primary text-white me-3"
                      :style="{ transform: viewStates.cpcTracking.isActionCenterCollapsed ? 'rotate(0deg)' : 'rotate(15deg) scale(1.1)' }">
                      <i class="fas fa-bolt"></i>
                    </div>
                    <span class="fw-bold me-4" style="font-size: 1.1rem;">{{ t('actionCenterTitle') }}</span>

                    <div class="badge-container-wrapper">
                      <transition-group name="badge-pop">
                        <template v-if="viewStates.cpcTracking.isActionCenterCollapsed">
                          <div v-if="overdueCpcs.length > 0" key="overdue"
                            class="badge modern-stat-badge badge-overdue text-white">
                            <i class="fas fa-clock me-1"></i> {{ overdueCpcs.length }} {{ t('overdueRecently') }}
                          </div>
                          <div v-if="partialCpcs.length > 0" key="partial"
                            class="badge modern-stat-badge badge-partial">
                            <i class="fas fa-adjust me-1"></i> {{ partialCpcs.length }} {{ t('partialpayment') }}
                          </div>
                          <div v-if="upcomingCpcs.length > 0" key="upcoming"
                            class="badge modern-stat-badge badge-upcoming">
                            <i class="fas fa-calendar-check me-1"></i> {{ upcomingCpcs.length }} {{ t('pending') }}
                          </div>
                          <div v-if="overdueCpcs.length === 0 && partialCpcs.length === 0 && upcomingCpcs.length === 0"
                            key="empty" class="text-success small fw-bold">
                            <i class="fas fa-check-circle me-1"></i> {{ t('allStable') }}
                          </div>
                        </template>
                      </transition-group>
                    </div>
                  </div>

                  <div class="d-flex align-items-center gap-3">
                    <div class="text-muted small fw-bold opacity-75">
                      {{ viewStates.cpcTracking.isActionCenterCollapsed ? t('showDetails') : t('collapse') }}
                    </div>
                    <i class="fas fa-chevron-down filter-toggle-icon text-secondary"></i>
                  </div>
                </div>

                <div class="filter-expand-content">
                  <div class="tracking-dashboard-header pt-3">
                    <!-- 1. Cột Overdue -->
                    <div class="action-section">
                      <div class="action-section-header">
                        <h6 class="text-danger"><i class="fas fa-clock me-2"></i>{{ t('overdueRecently') }}</h6>
                        <span class="badge bg-danger rounded-pill">{{ overdueCpcs.length }}</span>
                      </div>
                      <div class="scroll-area">
                        <div v-if="overdueCpcs.length > 0">
                          <div v-for="item in overdueCpcs.slice(0, 10)" :key="item.id"
                            class="compact-item border-overdue" @click="highlightAndScrollToItem(item.id)">
                            <div class="icon-box bg-soft-red"><i class="fas fa-exclamation-circle"></i></div>
                            <div class="item-content">
                              <div class="item-title">{{ item.vendorNameAbbr }} - {{ item.cpcIdentifier }}</div>
                              <div class="item-sub text-truncate">{{ item.contents }}</div>
                            </div>
                            <div class="item-badge-group">
                              <div class="amount-text text-danger">{{ formatCurrency(item.amount - item.totalAmountPaid)
                                }}</div>
                              <span class="text-muted" style="font-size: 0.65rem">
                                {{ t('daysLate', { days: Math.abs(calculateDiffDays(item.paymentDueDate)) }) }}
                              </span>
                            </div>
                          </div>
                        </div>
                        <div v-else class="text-center py-5 text-muted small">{{ t('noOverdueRecords') }}</div>
                      </div>
                    </div>

                    <!-- 2. Cột Partial -->
                    <div class="action-section">
                      <div class="action-section-header">
                        <h6 class="text-primary"><i class="fas fa-adjust me-2"></i>{{ t('partialpayment') }}</h6>
                        <span class="badge bg-primary rounded-pill">{{ partialCpcs.length }}</span>
                      </div>
                      <div class="scroll-area">
                        <div v-if="partialCpcs.length > 0">
                          <div v-for="item in partialCpcs.slice(0, 10)" :key="item.id"
                            class="compact-item border-primary" @click="highlightAndScrollToItem(item.id)">
                            <div class="icon-box bg-soft-primary"><i class="fas fa-pie-chart"></i></div>
                            <div class="item-content">
                              <div class="item-title">{{ item.vendorNameAbbr }} - {{ item.cpcIdentifier }}</div>
                              <div class="item-sub text-truncate">{{ t('paidStatus') }}: {{
                                formatCurrency(item.totalAmountPaid) }}</div>
                            </div>
                            <div class="item-badge-group">
                              <div class="amount-text text-primary">{{ formatCurrency(item.amount -
                                item.totalAmountPaid) }}</div>
                              <span class="text-muted" style="font-size: 0.65rem">{{ t('remainingLabel') }}</span>
                            </div>
                          </div>
                        </div>
                        <div v-else class="text-center py-5 text-muted small">{{ t('noPartialRecords') }}</div>
                      </div>
                    </div>

                    <!-- 3. Cột Upcoming -->
                    <div class="action-section">
                      <div class="action-section-header">
                        <h6 class="text-warning"><i class="fas fa-calendar-check me-2"></i>{{ t('pending') }} (10D)</h6>
                        <span class="badge bg-warning text-dark rounded-pill">{{ upcomingCpcs.length }}</span>
                      </div>
                      <div class="scroll-area">
                        <div v-if="upcomingCpcs.length > 0">
                          <div v-for="item in upcomingCpcs.slice(0, 10)" :key="item.id"
                            class="compact-item border-upcoming" @click="highlightAndScrollToItem(item.id)">
                            <div class="icon-box bg-soft-amber"><i class="fas fa-hourglass-half"></i></div>
                            <div class="item-content">
                              <div class="item-title">{{ item.vendorNameAbbr }} - {{ item.cpcIdentifier }}</div>
                              <div class="item-sub text-truncate">{{ item.contents }}</div>
                            </div>
                            <div class="item-badge-group">
                              <div class="amount-text text-warning">{{ formatCurrency(item.amount -
                                item.totalAmountPaid) }}</div>
                              <div class="fw-bold text-dark" style="font-size: 0.7rem">{{ item.paymentDueDate }}</div>
                            </div>
                          </div>
                        </div>
                        <div v-else class="text-center py-5 text-muted small">{{ t('noUpcomingRecords') }}</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- END: TOGGLEABLE CPC ACTION CENTER -->

              <div class="filter-wrapper no-print"
                :class="{ 'is-expanded': !viewStates.cpcTracking.isFilterCollapsed }">
                <!-- Thanh Header luôn hiển thị -->
                <div class="filter-header-bar" @click="toggleFilterPanel(viewStates.cpcTracking)">
                  <div class="d-flex align-items-center flex-grow-1">
                    <i class="fas fa-filter text-primary me-2"></i>
                    <span class="fw-bold me-3">{{ t('filterPanelTitle') }}</span>

                    <!-- Hiển thị tóm tắt bộ lọc ngay trên thanh header khi đóng -->
                    <span v-if="viewStates.cpcTracking.isFilterCollapsed" class="text-muted small text-truncate"
                      style="max-width: 600px;">
                      <i class="fas fa-info-circle me-1"></i>
                      {{ activeFiltersSummary(viewStates.cpcTracking) }}
                    </span>
                  </div>

                  <div class="d-flex align-items-center gap-2">
                    <button v-if="activeFiltersSummary(viewStates.cpcTracking) !== t('noActiveFilters')"
                      class="btn btn-sm btn-link text-danger p-0 me-2 text-decoration-none"
                      @click.stop="clearAllFilters">
                      <i class="fas fa-sync-alt me-1"></i> {{ t('btnClearAllFilters') }}
                    </button>
                    <i class="fas fa-chevron-down filter-toggle-icon text-secondary"></i>
                  </div>
                </div>

                <!-- Nội dung mở rộng -->
                <div class="filter-expand-content">
                  <div class="filter-grid">
                    <!-- Project Filter -->
                    <div class="filter-group">
                      <div class="filter-group-header">
                        <h6
                          @click="viewStates.cpcTracking.filter.expansion.project = !viewStates.cpcTracking.filter.expansion.project">
                          <i class="fas fa-folder me-2"></i><span>{{ t('project') }}</span>
                        </h6>
                        <button class="clear-filter-btn" @click="viewStates.cpcTracking.filter.projectId = []"><i
                            class="fas fa-times"></i></button>
                      </div>
                      <input type="text" class="form-control filter-search mb-2"
                        v-model="viewStates.cpcTracking.filter.projectSearch" :placeholder="t('searchProjects')">
                      <div class="slicer-options"
                        :class="{ 'slicer-options-expanded': viewStates.cpcTracking.filter.expansion.project }">
                        <button v-for="project in availableCpcProjects" :key="project.id" class="btn slicer-btn"
                          :class="{ 'slicer-btn-selected': viewStates.cpcTracking.filter.projectId.includes(project.id) }"
                          @click="toggleFilter(viewStates.cpcTracking.filter.projectId, project.id)">
                          {{ project.name }}
                        </button>
                      </div>
                    </div>

                    <!-- Vendor Filter -->
                    <div class="filter-group">
                      <div class="filter-group-header">
                        <h6
                          @click="viewStates.cpcTracking.filter.expansion.vendor = !viewStates.cpcTracking.filter.expansion.vendor">
                          <i class="fas fa-truck me-2"></i><span>{{ t('vendor') }}</span>
                        </h6>
                        <button class="clear-filter-btn" @click="viewStates.cpcTracking.filter.vendorId = []"><i
                            class="fas fa-times"></i></button>
                      </div>
                      <input type="text" class="form-control filter-search mb-2"
                        v-model="viewStates.cpcTracking.filter.vendorSearch" :placeholder="t('searchVendors')">
                      <div class="slicer-options"
                        :class="{ 'slicer-options-expanded': viewStates.cpcTracking.filter.expansion.vendor }">
                        <button v-for="vendor in availableCpcVendors" :key="vendor.id" class="btn slicer-btn"
                          :class="{ 'slicer-btn-selected': viewStates.cpcTracking.filter.vendorId.includes(vendor.id) }"
                          @click="toggleFilter(viewStates.cpcTracking.filter.vendorId, vendor.id)">
                          {{ vendor.name }}
                        </button>
                      </div>
                    </div>

                    <!-- Contract Filter -->
                    <div class="filter-group">
                      <div class="filter-group-header">
                        <h6
                          @click="viewStates.cpcTracking.filter.expansion.contract = !viewStates.cpcTracking.filter.expansion.contract">
                          <i class="fas fa-file-signature me-2"></i><span>{{ t('contract') }}</span>
                        </h6>
                        <button class="clear-filter-btn" @click="viewStates.cpcTracking.filter.contractId = []"><i
                            class="fas fa-times"></i></button>
                      </div>
                      <input type="text" class="form-control filter-search mb-2"
                        v-model="viewStates.cpcTracking.filter.contractNoSearch" :placeholder="t('searchContracts')">
                      <div class="slicer-options"
                        :class="{ 'slicer-options-expanded': viewStates.cpcTracking.filter.expansion.contract }">
                        <button v-for="contract in availableCpcContracts" :key="contract.id" class="btn slicer-btn"
                          :class="{ 'slicer-btn-selected': viewStates.cpcTracking.filter.contractId.includes(contract.id) }"
                          @click="toggleFilter(viewStates.cpcTracking.filter.contractId, contract.id)">
                          {{ contract.contractNo }}
                        </button>
                      </div>
                    </div>

                    <!-- Status Filter -->
                    <div class="filter-group">
                      <div class="filter-group-header">
                        <h6
                          @click="viewStates.cpcTracking.filter.expansion.status = !viewStates.cpcTracking.filter.expansion.status">
                          <i class="fas fa-tasks me-2"></i><span>{{ t('status') }}</span>
                        </h6>
                        <button class="clear-filter-btn" @click="viewStates.cpcTracking.filter.status = []"><i
                            class="fas fa-times"></i></button>
                      </div>
                      <div class="slicer-options"
                        :class="{ 'slicer-options-expanded': viewStates.cpcTracking.filter.expansion.status }">
                        <!-- Danh sách Status đầy đủ bao gồm cả SWAP -->
                        <button v-for="status in [
                    'Complete', 
                    'Partial Payment', 
                    'Pending', 
                     
                    'Complete SWAP', 
                    'Partial SWAP', 
                    'Complete SWAP Payment', 
                    'Partial SWAP Payment'
                ]" :key="status" class="btn slicer-btn"
                          :class="{ 'slicer-btn-selected': viewStates.cpcTracking.filter.status.includes(status) }"
                          @click="toggleFilter(viewStates.cpcTracking.filter.status, status)">
                          {{ t(status.toLowerCase().replace(/ /g, '')) }}
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
        </transition>

        <div class="table-controls no-print">
          <div class="d-flex align-items-center gap-2">
            <label class="form-label mb-0 text-secondary small">{{ t('showEntriesLabel') }}</label>
            <div class="year-nav-group">
              <button class="btn btn-sm btn-light border-0" @click="changePerPage(viewStates.cpcTracking, -1)"
                :disabled="viewStates.cpcTracking.perPage <= 5">
                <i class="fas fa-chevron-left fa-xs"></i>
              </button>
              <div class="year-display" style="min-width: 40px">
                {{ viewStates.cpcTracking.perPage }}
              </div>
              <button class="btn btn-sm btn-light border-0" @click="changePerPage(viewStates.cpcTracking, 1)"
                :disabled="viewStates.cpcTracking.perPage >= 100">
                <i class="fas fa-chevron-right fa-xs"></i>
              </button>
            </div>
          </div>

          <div class="d-flex align-items-center gap-2">
            <div class="dropdown">
              <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="fas fa-columns me-2"></i> {{ t('btnColumns')
                }}
              </button>
              <ul class="dropdown-menu dropdown-menu-end" data-bs-auto-close="outside">
                <li v-for="col in availableColumns" :key="col.key">
                  <div class="custom-checkbox-container"
                    @click="columnVisibility[col.key] = !columnVisibility[col.key]">
                    <div class="custom-checkbox-icon" :class="{ 'checked': columnVisibility[col.key] }">
                      <i class="fas fa-check"></i>
                    </div>
                    <span class="custom-checkbox-label">{{ col.label }}</span>
                  </div>
                </li>
              </ul>
            </div>

            <div class="input-group" style="width: 250px">
              <span class="input-group-text bg-light border-end-0"><i class="fas fa-search"></i></span>
              <input ref="cpcSearchInput" type="text" class="form-control border-start-0"
                :placeholder="t('searchPlaceholder')" v-model="viewStates.cpcTracking.searchTerm" />
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead>
                  <tr>
                    <th class="text-center-custom no-sort">
                      {{ t('tableHeaderNo') }}
                    </th>
                    <template v-for="col in visibleColumns" :key="col.key">
                      <th v-if="!col.noSort" class="text-center-custom"
                        @click="handleSort(viewStates.cpcTracking, col.key)">
                        {{ col.label }}
                        <i v-if="viewStates.cpcTracking.sortBy === col.key"
                          :class="viewStates.cpcTracking.sortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'"
                          class="sort-icon"></i>
                      </th>
                      <th v-else class="text-center-custom no-sort">
                        {{ col.label }}
                      </th>
                    </template>
                    <th class="text-center-custom no-sort">
                      {{ t('tableHeaderAction') }}
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <template v-if="formattedPaginatedCpcData.length > 0">
                    <template v-for="(item, index) in formattedPaginatedCpcData" :key="item.id">
                      <tr :id="'cpc-row-' + item.id" :class="{ 'row-highlight': item.id === highlightedRowId }"
                        @click.alt.prevent="copyItem(item)" @click.ctrl.prevent="editItem(item)">
                        <td class="text-center-custom fw-bold">
                          {{ (viewStates.cpcTracking.currentPage - 1)
                          * viewStates.cpcTracking.perPage + index + 1
                          }}
                        </td>
                        <template v-for="col in availableColumns" :key="col.key">
                          <td v-if="columnVisibility[col.key]" :class="[
						{
						'text-center-custom': ['cpcIdentifier', 'code', 'receivedDate', 'paymentDueDate', 'latestPaymentDate'].includes(col.key),
						'text-end-custom': ['amount', 'totalAmountPaid'].includes(col.key),
						'cell-just-edited': justEditedCell.itemId === item.id && justEditedCell.field === col.key
						},
						{'fw-bold text-highlight-vendor': col.key === 'vendorName'},
						{'fw-bold text-highlight-amount': col.key === 'amount'},
						{'fw-bold text-highlight-paid': col.key === 'totalAmountPaid' && item.totalAmountPaid > 0}
					]">
                            <template v-if="col.key === 'contractNo'">
                              <div class="d-flex align-items-center justify-content-between">
                                <a href="#" @click.prevent="goToContractDetails(item)" class="table-link text-nowrap">
                                  {{ item.contractNo }}
                                </a>

                                <i v-if="item.bondAlert" class="fas fa-shield-alt bond-shield-icon"
                                  :class="item.bondAlert.class === 'bond-alert-danger' ? 'shield-danger' : 'shield-warning'"
                                  @click.stop.prevent="goToBondDashboardFromTracking(item)" data-bs-html="true"
                                  :title="item.bondAlert.message"></i>
                              </div>
                            </template>
                            <template v-else-if="col.key === 'amount'">
                              <span v-if="!item.isUsd">{{ item.amountFormatted }}</span>
                              <span v-else class="usd-amount-toggle" @click="toggleCurrencyDisplay(item)">
                                {{ item.displayAmountInUsd ?
                                item.amountUsdFormatted :
                                item.amountFormatted }}
                              </span>
                            </template>
                            <template v-else-if="col.key === 'totalAmountPaid'">
                              <span class="financial-edit-trigger" @click="openFinancialsModal(item)">
                                {{ item.totalAmountPaidFormatted }}
                                <i class="bi bi-pencil-square ms-1"></i>
                              </span>
                            </template>
                            <template v-else-if="col.key === 'latestPaymentDate' && item.latestPaymentDate !== 'N/A'">{{
                              item.latestPaymentDate }}</template>
                            <template v-else-if="col.key === 'moreInfo'">
                              <div class="d-flex flex-column align-items-center justify-content-center gap-1">
                                <button class="btn btn-sm btn-outline-secondary" @click="toggleExpand(item)"
                                  v-if="(item.installments && item.installments.length > 1)">
                                  <i class="fas fa-chevron-down rotate-icon me-1"
                                    :class="{'rotated': item.isExpanded}"></i>
                                  {{ t('installment') }}
                                </button>
                                <button class="btn btn-sm btn-outline-primary" @click="viewBondDetails(item)"
                                  v-if="item.bonds && item.bonds.length > 0">
                                  <i class="fas fa-shield-alt me-1"></i>
                                  {{ t('bond') }}
                                </button>
                              </div>
                            </template>
                            <template v-else-if="col.key === 'status'">
                              <span :class="item.statusInfo.badgeClass">
                                <i :class="item.statusInfo.iconClass"></i>
                                {{ item.statusInfo.statusText }}
                              </span>
                            </template>
                            <template v-else-if="col.key === 'lineTracking' || col.key === 'notes'">
                              <div v-if="editingCell.itemId === item.id && editingCell.field === col.key"
                                style="min-width: 200px">
                                <input type="text" class="form-control form-control-sm border-primary"
                                  v-model="inlineEditValue" @blur="saveInlineEdit" @keyup.enter="saveInlineEdit"
                                  @keyup.esc="cancelInlineEdit" ref="inlineInput" />
                              </div>
                              <span v-else @dblclick="startEditing(item, col.key)" style="
                                            cursor: pointer;
                                            display: block;
                                            min-height: 1.5rem;
                                            width: 100%;
                                          ">
                                {{ item[col.key] || '...' }}
                              </span>
                            </template>
                            <template v-else>{{ col.key === 'vendorName' ?
                              item.vendorNameAbbr : item[col.key]
                              }}</template>
                          </td>
                        </template>
                        <td class="text-center-custom">
                          <div class="d-flex justify-content-center gap-1">
                            <button class="btn table-action-btn text-warning" @click="editItem(item)"
                              data-bs-toggle="tooltip" :title="t('tooltipEdit')">
                              <i class="bi bi-pencil-square"></i>
                            </button>
                            <button class="btn table-action-btn text-info" @click="copyItem(item)"
                              data-bs-toggle="tooltip" :title="t('tooltipCopy')">
                              <i class="bi bi-files"></i>
                            </button>
                            <button class="btn table-action-btn text-danger" @click="deleteItem(item)"
                              data-bs-toggle="tooltip" :title="t('tooltipDelete')">
                              <i class="bi bi-trash"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <template
                        v-if="item.isExpanded && item.installmentsFormatted && item.installmentsFormatted.length > 0">
                        <tr v-for="(installment, instIdx) in item.installmentsFormatted"
                          :key="'inst-' + item.id + '-' + instIdx" class="sub-row">

                          <!-- Cột STT (Để trống hoặc ghi chỉ số đợt) -->
                          <td class="text-center-custom"></td>

                          <template v-for="col in availableColumns" :key="'sub-col-' + col.key">
                            <td v-if="columnVisibility[col.key]" :class="[
            {
              'text-center-custom': ['cpcIdentifier', 'code', 'receivedDate', 'paymentDueDate', 'latestPaymentDate'].includes(col.key),
              'text-end-custom': ['amount', 'totalAmountPaid'].includes(col.key)
            }
          ]">

                              <!-- Chỉ hiển thị dữ liệu thanh toán ở cột 'Số tiền đã trả' (totalAmountPaid) -->
                              <template v-if="col.key === 'totalAmountPaid'">
                                {{ installment.amountFormatted }}
                              </template>

                              <!-- Hiển thị ngày thanh toán của đợt đó ở cột 'Ngày thanh toán' (latestPaymentDate) -->
                              <template v-else-if="col.key === 'latestPaymentDate'">
                                {{ installment.date }}
                              </template>

                              <!-- Hiển thị thông tin bổ sung (SWAP, STT đợt) ở cột 'More Info' -->
                              <template v-else-if="col.key === 'moreInfo'">
                                <div class="d-flex justify-content-center align-items-center gap-1">
                                  <span class="badge bg-light text-dark border" style="font-size: 0.7rem;">
                                    {{ t('installment_ordinal', { num: instIdx + 1, ordinal: getOrdinal(instIdx + 1) })
                                    }}
                                  </span>
                                  <span v-if="installment.isSwap" class="badge bg-info text-dark"
                                    style="font-size: 0.7rem;">
                                    SWAP
                                  </span>
                                </div>
                              </template>

                              <!-- Các cột còn lại để trống để giữ đúng vị trí cột -->
                              <template v-else></template>
                            </td>
                          </template>

                          <!-- Cột Action (Để trống để thẳng hàng) -->
                          <td class="text-center-custom"></td>
                        </tr>
                      </template>
                      <tr v-else-if="item.isExpanded && (!item.installments || item.installments.length === 0)">
                        <td :colspan="visibleColumns.length + 2" class="sub-row text-muted text-center">
                          {{ t('noPaymentsAvailable') }}
                        </td>
                      </tr>
                    </template>
                  </template>
                  <template v-else>
                    <tr>
                      <td :colspan="availableColumns.length + 2" class="text-center text-muted py-5">
                        {{ t('noMatchingData') }}
                      </td>
                    </tr>
                  </template>
                </tbody>
                <tfoot class="sticky-footer" v-if="filteredCpcData.length > 0">
                  <tr>
                    <td></td>
                    <template v-for="col in visibleColumns" :key="col.key + '-footer'">
                      <td :class="{'text-end-custom': ['amount', 'totalAmountPaid'].includes(col.key)}">
                        <strong v-if="col.key === 'vendorName'">{{ t('total') }}:</strong>
                        <strong v-if="col.key === 'amount'">{{ totalAmountCpcTracking }}</strong>
                        <strong v-if="col.key === 'totalAmountPaid'">{{ totalAmountPaidCpcTracking }}</strong>
                      </td>
                    </template>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
        <div class="pagination-wrapper no-print">
          <!-- Thông tin số lượng dòng (Bên trái) -->
          <div class="entries-info-text">
            <i class="fas fa-list-ol me-1"></i>
            {{ t('paginationInfo', {
            start: (viewStates.cpcTracking.currentPage - 1) * viewStates.cpcTracking.perPage + 1,
            end: Math.min(viewStates.cpcTracking.currentPage * viewStates.cpcTracking.perPage, filteredCpcData.length),
            total: filteredCpcData.length
            }) }}
          </div>

          <!-- Cụm điều khiển trang (Bên phải) -->
          <div class="modern-pagination-container">
            <!-- Nút Previous -->
            <button class="btn btn-pagination-modern" @click="viewStates.cpcTracking.currentPage--"
              :disabled="viewStates.cpcTracking.currentPage === 1">
              <i class="fas fa-arrow-left"></i>
              <span>{{ t('btnPrevious') }}</span>
            </button>

            <!-- Hiển thị Trang X / Y -->
            <div class="page-info-pill">
              {{ viewStates.cpcTracking.currentPage }} / {{ totalPages }}
            </div>

            <!-- Nút Next -->
            <button class="btn btn-pagination-modern" @click="viewStates.cpcTracking.currentPage++"
              :disabled="viewStates.cpcTracking.currentPage >= totalPages">
              <span>{{ t('btnNext') }}</span>
              <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>
    </div>

    <div v-if="currentTab === 'cpc-details'">
      <div class="filter-wrapper no-print" :class="{ 'is-expanded': !viewStates.cpcDetails.isFilterCollapsed }">
        <!-- Header Bar: Luôn hiển thị, chứa tóm tắt khi đóng -->
        <div class="filter-header-bar" @click="toggleFilterPanel(viewStates.cpcDetails)">
          <div class="d-flex align-items-center flex-grow-1">
            <i class="fas fa-filter text-primary me-2"></i>
            <span class="fw-bold me-3">{{ t('filterPanelTitle') }}</span>

            <!-- Hiển thị tóm tắt bộ lọc ngay trên thanh header khi đóng -->
            <span v-if="viewStates.cpcDetails.isFilterCollapsed" class="text-muted small text-truncate"
              style="max-width: 600px;">
              <i class="fas fa-info-circle me-1"></i>
              {{ activeFiltersSummary(viewStates.cpcDetails) }}
            </span>
          </div>

          <div class="d-flex align-items-center gap-2">
            <!-- Nút xóa nhanh bộ lọc -->
            <button v-if="activeFiltersSummary(viewStates.cpcDetails) !== t('noActiveFilters')"
              class="btn btn-sm btn-link text-danger p-0 me-2 text-decoration-none" @click.stop="clearAllFilters">
              <i class="fas fa-sync-alt me-1"></i> {{ t('btnClearAllFilters') }}
            </button>
            <i class="fas fa-chevron-down filter-toggle-icon text-secondary"></i>
          </div>
        </div>

        <!-- Nội dung bộ lọc khi mở rộng -->
        <div class="filter-expand-content">
          <div class="filter-grid">
            <!-- Project Filter -->
            <div class="filter-group">
              <div class="filter-group-header">
                <h6
                  @click="viewStates.cpcDetails.filter.expansion.project = !viewStates.cpcDetails.filter.expansion.project">
                  <i class="fas fa-folder me-2"></i><span>{{ t('project') }}</span>
                </h6>
                <button class="clear-filter-btn"
                  @click="viewStates.cpcDetails.filter.projectId = []; viewStates.cpcDetails.filter.projectSearch = ''">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <input type="text" class="form-control filter-search mb-2"
                v-model="viewStates.cpcDetails.filter.projectSearch" :placeholder="t('searchProjects')">
              <div class="slicer-options"
                :class="{ 'slicer-options-expanded': viewStates.cpcDetails.filter.expansion.project }">
                <button v-for="project in availableDetailProjects" :key="project.id" class="btn slicer-btn"
                  :class="{ 'slicer-btn-selected': viewStates.cpcDetails.filter.projectId.includes(project.id) }"
                  @click="toggleFilter(viewStates.cpcDetails.filter.projectId, project.id)">
                  {{ project.name }}
                </button>
              </div>
            </div>

            <!-- Vendor Filter -->
            <div class="filter-group">
              <div class="filter-group-header">
                <h6
                  @click="viewStates.cpcDetails.filter.expansion.vendor = !viewStates.cpcDetails.filter.expansion.vendor">
                  <i class="fas fa-truck-fast me-2"></i><span>{{ t('vendor') }}</span>
                </h6>
                <button class="clear-filter-btn"
                  @click="viewStates.cpcDetails.filter.vendorId = []; viewStates.cpcDetails.filter.vendorSearch = ''">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <input type="text" class="form-control filter-search mb-2"
                v-model="viewStates.cpcDetails.filter.vendorSearch" :placeholder="t('searchVendors')">
              <div class="slicer-options"
                :class="{ 'slicer-options-expanded': viewStates.cpcDetails.filter.expansion.vendor }">
                <button v-for="vendor in availableDetailVendors" :key="vendor.id" class="btn slicer-btn"
                  :class="{ 'slicer-btn-selected': viewStates.cpcDetails.filter.vendorId.includes(vendor.id) }"
                  @click="toggleFilter(viewStates.cpcDetails.filter.vendorId, vendor.id)">
                  {{ vendor.name }}
                </button>
              </div>
            </div>

            <!-- Contract Filter -->
            <div class="filter-group">
              <div class="filter-group-header">
                <h6
                  @click="viewStates.cpcDetails.filter.expansion.contract = !viewStates.cpcDetails.filter.expansion.contract">
                  <i class="fas fa-file-signature me-2"></i><span>{{ t('selectContract') }}</span>
                </h6>
                <button class="clear-filter-btn" @click="viewStates.cpcDetails.filter.selectedContractId = null">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="slicer-options"
                v-if="viewStates.cpcDetails.filter.projectId.length === 1 && viewStates.cpcDetails.filter.vendorId.length === 1"
                :class="{ 'slicer-options-expanded': viewStates.cpcDetails.filter.expansion.contract }">
                <button v-for="contract in availableDetailContracts" :key="contract.id" class="btn slicer-btn"
                  :class="{ 'slicer-btn-selected': viewStates.cpcDetails.filter.selectedContractId === contract.id }"
                  @click="viewStates.cpcDetails.filter.selectedContractId = contract.id">
                  {{ contract.contractNo }}
                </button>
              </div>
              <div v-else class="text-muted p-2 small">
                <i class="fas fa-info-circle me-1"></i> {{ t('promptSelectContract') }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- START: MODERN ACTION BAR FOR CPC DETAILS -->
      <div v-if="viewStates.cpcDetails.filter.selectedContractId" class="details-action-bar no-print">

        <!-- NHÓM 1: CONTEXT & CURRENCY (Bên trái) -->
        <div class="d-flex align-items-center gap-2">
          <div class="d-flex flex-column">
            <span class="group-label">Điều hướng</span>
            <button class="btn btn-action-soft rounded-pill shadow-sm bg-primary text-white"
              @click="currentTab = 'contract-overview'">
              <i class="fas fa-chart-pie me-2"></i> Dashboard Overview
            </button>
          </div>

          <div class="vr mx-2"></div>

          <div class="d-flex flex-column">
            <span class="group-label">{{ t('currency') }}</span>
            <button class="btn btn-action-soft rounded-pill shadow-sm"
              :class="{ 'btn-currency-active': viewStates.cpcDetails.currencyView === 'USD' }"
              @click="toggleDetailsCurrencyView" :disabled="!isCurrentContractUSD">
              <i class="fas fa-sync-alt"></i>
              <span>{{ t('viewAs') }} {{ viewStates.cpcDetails.currencyView === 'USD' ? 'VND' : 'USD' }}</span>
            </button>
          </div>
        </div>

        <!-- NHÓM 2: DATA OPERATIONS (Giữa) -->
        <div class="d-flex align-items-center gap-3 ms-auto">
          <div class="d-flex flex-column">
            <span class="group-label text-center">{{ t('btnData') }}</span>
            <div class="btn-group shadow-sm">
              <button class="btn btn-action-soft" @click="downloadDetailsTemplate"
                :title="t('btnDownloadDetailsTemplate')">
                <i class="fas fa-file-download text-primary"></i> {{ t('btnTemplate') }}
              </button>
              <button class="btn btn-action-soft" @click="checkPhaseAndTriggerUpload" :title="t('btnUploadDetails')">
                <i class="fas fa-file-upload text-success"></i> {{ t('btnUpload') }}
              </button>
              <button class="btn btn-action-soft" @click="exportDetailsToExcel" :title="t('btnExportDetails')">
                <i class="fas fa-file-export text-warning"></i> {{ t('btnExport') }}
              </button>
            </div>
          </div>

          <!-- NHÓM 3: VIEW CONFIGURATION (Bên phải) -->
          <div class="d-flex flex-column">
            <span class="group-label text-center">{{ t('filterPanelTitle') }}</span>
            <div class="d-flex gap-2">
              <!-- Dropdown Columns -->
              <div class="dropdown">
                <button class="btn btn-action-soft dropdown-toggle shadow-sm" type="button" data-bs-toggle="dropdown">
                  <i class="fas fa-columns"></i> {{ t('btnColumns') }}
                </button>
                <ul class="dropdown-menu dropdown-menu-end p-2" style="min-width: 200px;">
                  <li v-for="col in detailsAvailableColumnGroups" :key="col.key" class="mb-1">
                    <div class="custom-checkbox-container py-1 px-2 rounded hover-bg-light"
                      @click="toggleDetailColumnVisibility('column', col.key)">
                      <div class="custom-checkbox-icon"
                        :class="{ 'checked': viewStates.cpcDetails.columnVisibility[col.key] }">
                        <i class="fas fa-check"></i>
                      </div>
                      <span class="small fw-medium">{{ col.label }}</span>
                    </div>
                  </li>
                </ul>
              </div>

              <!-- Dropdown Sub-Columns -->
              <div class="dropdown">
                <button class="btn btn-action-soft dropdown-toggle shadow-sm" type="button" data-bs-toggle="dropdown">
                  <i class="fas fa-list-ul"></i> {{ t('btnSubColumns') }}
                </button>
                <ul class="dropdown-menu dropdown-menu-end p-2"
                  style="max-height: 400px; overflow-y: auto; min-width: 250px;">
                  <li v-for="col in detailsAllSubColumns" :key="col.key" class="mb-1">
                    <div class="custom-checkbox-container py-1 px-2 rounded hover-bg-light"
                      @click="toggleDetailColumnVisibility('subColumn', col.key)">
                      <div class="custom-checkbox-icon"
                        :class="{ 'checked': viewStates.cpcDetails.subColumnVisibility[col.key] }">
                        <i class="fas fa-check"></i>
                      </div>
                      <span class="small fw-medium">{{ col.label }}</span>
                    </div>
                  </li>
                </ul>
              </div>

              <!-- Nút Print -->
              <div class="btn-group shadow-sm">
                <button class="btn btn-action-soft" @click="exportCpcDetailsToPdf" :title="t('btnExportPdf')">
                  <i class="fas fa-file-pdf text-danger"></i> Xuất PDF (A3)
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Input file ẩn -->
        <input type="file" ref="uploadDetailsExcelInput" @change="handleDetailsFileUpload" accept=".xlsx, .xls"
          style="display: none">
      </div>
      <!-- END: MODERN ACTION BAR FOR CPC DETAILS -->

      <div v-if="selectedContractDetails" class="contract-header-info">
        <h3 class="project-title">
          {{ selectedContractDetails.projectName }}
        </h3>
        <div class="row">
          <div class="col-md-6">
            <p>
              <strong>1. {{ t('vendor') }}:</strong> {{
              selectedContractDetails.vendorNameAbbr }}
            </p>
            <p>
              <strong>2. {{ t('contract') }}:</strong>
              <button type="button" class="btn btn-sm btn-outline-primary rounded-pill ms-1"
                @click="editContractItem(selectedContractDetails)">
                {{ selectedContractDetails.contractNo }}
                <i class="fas fa-edit fa-fw ms-1"></i>
              </button>
            </p>
            <p>
              <strong>3. {{ t('date') }}:</strong> {{
              selectedContractDetails.date }}
            </p>
            <p>
              <strong>4. {{ t('details') }}:</strong> {{
              selectedContractDetails.description }}
            </p>
            <p>
              <strong>5. {{ t('significantNotes') }}:</strong>
              <button type="button" class="btn btn-sm btn-outline-info rounded-pill ms-1" @click="toggleNotesModal">
                <i class="fas fa-sticky-note fa-fw me-1"></i> {{
                t('viewEditNotes') }}
              </button>
            </p>
          </div>
          <div class="col-md-6">
            <p>
              <strong>{{ t('vendorNo') }}:</strong> {{
              selectedContractDetails.vendorNo }}
            </p>
            <p>
              <strong>{{ t('contractSystemNo') }}:</strong> {{
              selectedContractDetails.contractSystemNo }}
            </p>
            <p>
              <strong>{{ t('currency') }}:</strong>
              <span class="badge" :class="selectedContractDetails.currency === 'USD' ? 'bg-primary' : 'bg-success'">{{
                selectedContractDetails.currency || 'VND'
                }}</span>
            </p>
            <p class="d-flex align-items-center">
              <strong class="me-2">{{ t('status') }}:</strong>
              <button type="button" :class="getStatusBadgeClass(selectedContractDetails.status)"
                class="status-badge-clickable ms-2" @click="openStatusUpdateModal(selectedContractDetails)">
                {{ t((selectedContractDetails.status ||
                '').toLowerCase()) }}
              </button>
              <small v-if="selectedContractDetails.statusNote" class="ms-2 text-muted fst-italic">
                - {{ selectedContractDetails.statusNote }}
              </small>
            </p>
          </div>
        </div>
      </div>

      <div v-if="viewStates.cpcDetails.filter.selectedContractId" class="d-flex align-items-center mb-2 flex-wrap"
        style="position: relative; z-index: 10">
        <ul class="nav nav-pills">
          <li class="nav-item">
            <a class="nav-link" :class="{ 'active': viewStates.cpcDetails.activePhaseId === 'summary' }" href="#"
              @click.prevent="viewStates.cpcDetails.activePhaseId = 'summary'">
              <i class="fas fa-layer-group me-1"></i> {{
              t('grandTotal') }}
            </a>
          </li>

          <li class="nav-item d-flex align-items-center ms-1"
            v-for="(phase, index) in (selectedContractDetails?.phases || [])" :key="phase.id">
            <div class="btn-group">
              <a class="nav-link border"
                :class="{ 'active': viewStates.cpcDetails.activePhaseId === phase.id, 'bg-white': viewStates.cpcDetails.activePhaseId !== phase.id }"
                href="#" @click.prevent="viewStates.cpcDetails.activePhaseId = phase.id">
                {{ phase.name }}
              </a>
              <button type="button" class="btn btn-sm btn-light border dropdown-toggle dropdown-toggle-split"
                data-bs-toggle="dropdown" aria-expanded="false" data-bs-boundary="viewport">
                <span class="visually-hidden">Toggle Dropdown</span>
              </button>
              <ul class="dropdown-menu">
                <li>
                  <a class="dropdown-item" href="#" @click.prevent="renamePhase(phase)"><i class="fas fa-edit me-2"></i>
                    Đổi tên</a>
                </li>
                <li>
                  <hr class="dropdown-divider" />
                </li>
                <li>
                  <a class="dropdown-item text-danger" href="#" @click.prevent="deletePhase(phase)"><i
                      class="fas fa-trash me-2"></i> Xóa GĐ</a>
                </li>
              </ul>
            </div>
          </li>

          <li class="nav-item ms-2">
            <button class="btn btn-outline-primary btn-sm" @click="addNewPhase" title="Thêm giai đoạn mới">
              <i class="fas fa-plus"></i>
            </button>
          </li>
        </ul>

        <div class="ms-auto text-muted small fst-italic" v-if="viewStates.cpcDetails.activePhaseId === 'summary'">
          <i class="fas fa-info-circle"></i> Chế độ xem tổng hợp
          (Chỉ đọc khi có Phase)
        </div>
      </div>
      <div v-if="viewStates.cpcDetails.filter.selectedContractId" class="card">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-bordered table-detailed align-middle">
              <thead>
                <tr>
                  <th v-if="viewStates.cpcDetails.columnVisibility.contract" :colspan="getGroupColspan('contract')">
                    {{ t('columnGroupContract') }}
                  </th>
                  <th v-if="viewStates.cpcDetails.columnVisibility.cpc" :colspan="getGroupColspan('cpc')">
                    {{ t('columnGroupCpc') }}
                  </th>
                  <th v-if="viewStates.cpcDetails.columnVisibility.payment" :colspan="getGroupColspan('payment')">
                    {{ t('columnGroupPayment') }}
                  </th>
                  <th v-if="viewStates.cpcDetails.columnVisibility.invoice" :colspan="getGroupColspan('invoice')">
                    {{ t('columnGroupInvoice') }}
                  </th>
                  <th v-if="viewStates.cpcDetails.columnVisibility.remainingPayable"
                    :rowspan="getGroupColspan('remainingPayable') > 0 ? 3 : 1" class="remaining-payable-header">
                    {{ t('columnGroupRemainingPayable') }}
                  </th>
                  <th v-if="viewStates.cpcDetails.columnVisibility.contractRemaining"
                    :colspan="getGroupColspan('contractRemaining')">
                    {{ t('columnGroupContractRemaining') }}
                  </th>
                </tr>
                <tr>
                  <template v-if="viewStates.cpcDetails.columnVisibility.contract">
                    <th rowspan="2" v-if="viewStates.cpcDetails.subColumnVisibility.contractInfo">
                      {{ t('contractinfo') }}
                    </th>
                    <th rowspan="2" v-if="viewStates.cpcDetails.subColumnVisibility.description">
                      {{ t('details') }}
                    </th>
                    <th rowspan="2" v-if="viewStates.cpcDetails.subColumnVisibility.contractAmount">
                      {{ t('amount') }}
                    </th>
                    <th rowspan="2" v-if="viewStates.cpcDetails.subColumnVisibility.contractVon">
                      Von
                    </th>
                    <th rowspan="2" v-if="viewStates.cpcDetails.subColumnVisibility.contractVat">
                      Vat
                    </th>
                    <th rowspan="2" v-if="viewStates.cpcDetails.subColumnVisibility.contractTotal">
                      {{ t('total') }}
                    </th>
                  </template>
                  <template v-if="viewStates.cpcDetails.columnVisibility.cpc">
                    <th rowspan="2" v-if="viewStates.cpcDetails.subColumnVisibility.cpcNo">
                      CPC No
                    </th>
                    <th rowspan="2" v-if="viewStates.cpcDetails.subColumnVisibility.cpcDueDate">
                      Due Date
                    </th>
                    <th rowspan="2" v-if="viewStates.cpcDetails.subColumnVisibility.cpcWorkDone">
                      Work-done
                    </th>
                    <th rowspan="2" v-if="viewStates.cpcDetails.subColumnVisibility.cpcPaymentOfWorkdone">
                      Payment of workdone
                    </th>
                    <th rowspan="2" v-if="viewStates.cpcDetails.subColumnVisibility.cpcAdvance">
                      Advance
                    </th>
                    <th rowspan="2" v-if="viewStates.cpcDetails.subColumnVisibility.cpcRepayment">
                      Repayment
                    </th>
                    <th rowspan="2" v-if="viewStates.cpcDetails.subColumnVisibility.cpcRetention">
                      Retention
                    </th>
                    <th rowspan="2" v-if="viewStates.cpcDetails.subColumnVisibility.cpcOtherDeduction">
                      Other deduction
                    </th>
                    <th colspan="2"
                      v-if="viewStates.cpcDetails.subColumnVisibility.cpcAmountDue || viewStates.cpcDetails.subColumnVisibility.cpcVatAmountDue">
                      Amount Due
                    </th>
                  </template>
                  <template v-if="viewStates.cpcDetails.columnVisibility.payment">
                    <th rowspan="2" v-if="viewStates.cpcDetails.subColumnVisibility.paymentDate">
                      {{ t('date') }}
                    </th>
                    <th rowspan="2" v-if="viewStates.cpcDetails.subColumnVisibility.paymentAmount">
                      {{ t('net') }}
                    </th>
                    <th rowspan="2" v-if="viewStates.cpcDetails.subColumnVisibility.paymentVat">
                      {{ t('vat') }}
                    </th>
                    <th rowspan="2" v-if="viewStates.cpcDetails.subColumnVisibility.paymentTotal">
                      {{ t('total') }}
                    </th>
                  </template>
                  <template v-if="viewStates.cpcDetails.columnVisibility.invoice">
                    <th rowspan="2" v-if="viewStates.cpcDetails.subColumnVisibility.invoiceNo">
                      No.
                    </th>
                    <th rowspan="2" v-if="viewStates.cpcDetails.subColumnVisibility.invoiceDate">
                      {{ t('date') }}
                    </th>
                    <th rowspan="2" v-if="viewStates.cpcDetails.subColumnVisibility.invoiceAmount">
                      {{ t('net') }}
                    </th>
                    <th rowspan="2" v-if="viewStates.cpcDetails.subColumnVisibility.invoiceVat">
                      {{ t('vat') }}
                    </th>
                    <th rowspan="2" v-if="viewStates.cpcDetails.subColumnVisibility.invoiceTotal">
                      {{ t('total') }}
                    </th>
                  </template>
                  <template v-if="viewStates.cpcDetails.columnVisibility.contractRemaining">
                    <th rowspan="2" v-if="viewStates.cpcDetails.subColumnVisibility.contractRemainingInclVat">
                      Amount (Included Vat)
                    </th>
                    <th rowspan="2" v-if="viewStates.cpcDetails.subColumnVisibility.contractRemainingExclVat">
                      Amount (Excluded Vat)
                    </th>
                    <th rowspan="2" v-if="viewStates.cpcDetails.subColumnVisibility.contractRemainingVat">
                      Vat
                    </th>
                  </template>
                </tr>
                <tr>
                  <template
                    v-if="viewStates.cpcDetails.columnVisibility.cpc && (viewStates.cpcDetails.subColumnVisibility.cpcAmountDue || viewStates.cpcDetails.subColumnVisibility.cpcVatAmountDue)">
                    <th v-if="viewStates.cpcDetails.subColumnVisibility.cpcAmountDue">
                      {{ t('net') }}
                    </th>
                    <th v-if="viewStates.cpcDetails.subColumnVisibility.cpcVatAmountDue">
                      {{ t('vat') }}
                    </th>
                  </template>
                </tr>
              </thead>
              <tbody>
                <template v-for="(item, index) in displayedContractDetailTable" :key="item.id">
                  <tr>
                    <template v-if="viewStates.cpcDetails.columnVisibility.contract">
                      <td v-if="viewStates.cpcDetails.subColumnVisibility.contractInfo"
                        :class="['text-start-custom', { 'interactive-cell': !isVndViewForUsdContract && (viewStates.cpcDetails.activePhaseId !== 'summary' || (selectedContractDetails?.phases?.length || 0) === 0) }]"
                        @click.prevent="(!isVndViewForUsdContract && (viewStates.cpcDetails.activePhaseId !== 'summary' || (selectedContractDetails?.phases?.length || 0) === 0)) && openContractDetailsModal(item, index)">
                        <div class="interactive-cell-box"
                          :class="{'interactive-cell-box-empty': !item.contractInfo && !item.description}"
                          style="white-space: pre-wrap">
                          {{ item.contractInfo }}
                        </div>

                        <template
                          v-if="viewStates.cpcDetails.activePhaseId !== 'summary' || (selectedContractDetails?.phases?.length || 0) === 0">
                          <button v-if="displayedContractDetailTable.length > 1"
                            class="btn btn-sm delete-corner-btn no-print" @click.stop="deleteDetailRow(item.id)"
                            data-bs-toggle="tooltip" :title="t('deleteRow')">
                            <i class="fas fa-trash-alt"></i>
                          </button>
                          <button class="btn btn-sm add-below-btn no-print" @click.stop="addNewDetailRowAtIndex(index)"
                            data-bs-toggle="tooltip" :title="t('addNewRow')">
                            <i class="fas fa-plus-circle"></i>
                          </button>
                        </template>
                      </td>

                      <td class="text-start-custom" v-if="viewStates.cpcDetails.subColumnVisibility.description">
                        {{ item.description }}
                      </td>
                      <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.contractAmount">
                        {{
                        formatDetailsCurrency(item.contractAmount)
                        }}
                      </td>
                      <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.contractVon">
                        {{ formatDetailsCurrency(item.contractVon)
                        }}
                      </td>
                      <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.contractVat">
                        {{ formatDetailsCurrency(item.contractVat)
                        }}
                      </td>
                      <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.contractTotal">
                        {{ formatDetailsCurrency(item.contractTotal)
                        }}
                      </td>
                    </template>

                    <template v-if="viewStates.cpcDetails.columnVisibility.cpc">
                      <td v-if="viewStates.cpcDetails.subColumnVisibility.cpcNo"
                        :class="{ 'interactive-cell': !isVndViewForUsdContract && (viewStates.cpcDetails.activePhaseId !== 'summary' || (selectedContractDetails?.phases?.length || 0) === 0) }"
                        @click.prevent="(!isVndViewForUsdContract && (viewStates.cpcDetails.activePhaseId !== 'summary' || (selectedContractDetails?.phases?.length || 0) === 0)) && openCpcDetailsModal(item, index)">
                        <div class="interactive-cell-box d-flex align-items-center gap-1"
                          :class="{'interactive-cell-box-empty': !item.cpcNo}">
                          <span>{{ item.cpcNo }}</span>
                          <!-- Hiển thị Badge SWAP nếu có ít nhất 1 đợt thanh toán là SWAP -->
                          <span v-if="item.paymentInstallments?.some(p => p.isSwap)" class="badge bg-info text-dark"
                            style="font-size: 0.6rem; padding: 2px 4px;" title="Hồ sơ có cấn trừ SWAP">
                            SWAP
                          </span>
                        </div>

                        <button
                          v-if="item.cpcNo && (viewStates.cpcDetails.activePhaseId !== 'summary' || (selectedContractDetails?.phases?.length || 0) === 0)"
                          class="btn btn-sm btn-light send-cpc-btn no-print"
                          @click.stop.prevent="handleCpcSendClick($event, item)" data-bs-toggle="tooltip"
                          data-bs-placement="top" :title="t('tooltipSendCpc')">
                          <i class="fas fa-paper-plane" :style="{ color: item.linkedCpcId ? '#28a745' : '' }"></i>
                        </button>
                      </td>
                      <td v-if="viewStates.cpcDetails.subColumnVisibility.cpcDueDate">
                        {{ item.cpcDueDate }}
                      </td>
                      <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.cpcWorkDone">
                        {{ formatDetailsCurrency(item.cpcWorkDone)
                        }}
                      </td>
                      <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.cpcPaymentOfWorkdone">
                        {{
                        formatDetailsCurrency(item.cpcPaymentOfWorkdone)
                        }}
                      </td>
                      <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.cpcAdvance">
                        {{ formatDetailsCurrency(item.cpcAdvance) }}
                      </td>
                      <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.cpcRepayment">
                        {{ formatDetailsCurrency(item.cpcRepayment)
                        }}
                      </td>
                      <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.cpcRetention">
                        {{ formatDetailsCurrency(item.cpcRetention)
                        }}
                      </td>
                      <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.cpcOtherDeduction">
                        {{
                        formatDetailsCurrency(item.cpcOtherDeduction)
                        }}
                      </td>
                      <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.cpcAmountDue">
                        {{ formatDetailsCurrency(item.cpcAmountDue)
                        }}
                      </td>
                      <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.cpcVatAmountDue">
                        {{ formatDetailsCurrency(item.cpcVat) }}
                      </td>
                    </template>

                    <template v-if="viewStates.cpcDetails.columnVisibility.payment">
                      <td v-if="viewStates.cpcDetails.subColumnVisibility.paymentDate">
                        <span v-if="item.paymentInstallments && item.paymentInstallments.length > 1"
                          class="interactive-payment-date" @click="toggleDetailRowExpand(item)">
                          {{ item.latestPaymentDate }}
                          <i class="fas fa-chevron-down rotate-icon ms-2" :class="{'rotated': item.isExpanded}"></i>
                        </span>
                        <span v-else>{{ item.latestPaymentDate }}</span>
                      </td>
                      <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.paymentAmount">
                        {{
                        formatDetailsCurrency(item.paymentTotalAmount)
                        }}
                      </td>
                      <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.paymentVat">
                        {{
                        formatDetailsCurrency(item.paymentTotalVat)
                        }}
                      </td>
                      <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.paymentTotal">
                        {{
                        formatDetailsCurrency(item.paymentGrandTotal)
                        }}
                      </td>
                    </template>

                    <template v-if="viewStates.cpcDetails.columnVisibility.invoice">
                      <td v-if="viewStates.cpcDetails.subColumnVisibility.invoiceNo"
                        :class="{ 'interactive-cell': !isVndViewForUsdContract && (viewStates.cpcDetails.activePhaseId !== 'summary' || (selectedContractDetails?.phases?.length || 0) === 0) }"
                        @click.prevent="(!isVndViewForUsdContract && (viewStates.cpcDetails.activePhaseId !== 'summary' || (selectedContractDetails?.phases?.length || 0) === 0)) && openInvoiceDetailsModal(item, index)">
                        <div class="interactive-cell-box" :class="{'interactive-cell-box-empty': !item.invoiceNo}">
                          {{ item.invoiceNo }}
                        </div>
                      </td>
                      <td v-if="viewStates.cpcDetails.subColumnVisibility.invoiceDate">
                        {{ item.invoiceDate }}
                      </td>
                      <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.invoiceAmount">
                        {{ formatDetailsCurrency(item.invoiceAmount)
                        }}
                      </td>
                      <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.invoiceVat">
                        {{ formatDetailsCurrency(item.invoiceVat) }}
                      </td>
                      <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.invoiceTotal">
                        {{ formatDetailsCurrency(item.invoiceTotal)
                        }}
                      </td>
                    </template>

                    <td v-if="viewStates.cpcDetails.columnVisibility.remainingPayable" class="text-end-custom">
                      {{
                      formatDetailsCurrency(item.remainingPayable)
                      }}
                    </td>
                    <template v-if="viewStates.cpcDetails.columnVisibility.contractRemaining">
                      <td class="text-end-custom"
                        v-if="viewStates.cpcDetails.subColumnVisibility.contractRemainingInclVat">
                        {{
                        formatDetailsCurrency(item.contractRemainingInclVat)
                        }}
                      </td>
                      <td class="text-end-custom"
                        v-if="viewStates.cpcDetails.subColumnVisibility.contractRemainingExclVat">
                        {{
                        formatDetailsCurrency(item.contractRemainingExclVat)
                        }}
                      </td>
                      <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.contractRemainingVat">
                        {{
                        formatDetailsCurrency(item.contractRemainingVat)
                        }}
                      </td>
                    </template>
                  </tr>
                  <template v-if="item.isExpanded && item.paymentInstallments && item.paymentInstallments.length > 0">
                    <tr v-for="(payment, pIdx) in item.paymentInstallments" :key="item.id + '-payment-' + pIdx"
                      class="payment-sub-row">
                      <td :colspan="paymentSubRowColspan" class="text-end-custom pe-3">
                        <strong>{{ t('installment_ordinal', { num: pIdx + 1, ordinal: getOrdinal(pIdx + 1) }) }}:
                          <small v-if="payment.isSwap" class="text-info">(SWAP)</small>
                        </strong>
                      </td>
                      <template v-if="viewStates.cpcDetails.columnVisibility.payment">
                        <td class="text-center-custom" v-if="viewStates.cpcDetails.subColumnVisibility.paymentDate">
                          {{ payment.date }}
                        </td>
                        <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.paymentAmount">
                          {{ formatDetailsCurrency(payment.amount)
                          }}
                        </td>
                        <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.paymentVat">
                          {{ formatDetailsCurrency(payment.vat) }}
                        </td>
                        <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.paymentTotal">
                          {{ formatDetailsCurrency(
                          (isCurrentContractUSD &&
                          viewStates.cpcDetails.currencyView ===
                          'USD') ? payment.amount : payment.totalVND
                          ) }}
                        </td>
                      </template>
                      <td :colspan="paymentSubRowColspanAfter"></td>
                    </tr>
                  </template>
                </template>
              </tbody>
              <tfoot>
                <tr>
                  <template v-if="viewStates.cpcDetails.columnVisibility.contract">
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.contractInfo">
                      <strong>{{ t('total') }}</strong>
                    </td>
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.description"></td>
                    <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.contractAmount">
                      {{
                      formatDetailsCurrency(totalDetails.contractAmount)
                      }}
                    </td>
                    <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.contractVon">
                      {{
                      formatDetailsCurrency(totalDetails.contractVon)
                      }}
                    </td>
                    <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.contractVat">
                      {{
                      formatDetailsCurrency(totalDetails.contractVat)
                      }}
                    </td>
                    <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.contractTotal">
                      {{
                      formatDetailsCurrency(totalDetails.contractTotal)
                      }}
                    </td>
                  </template>
                  <template v-if="viewStates.cpcDetails.columnVisibility.cpc">
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.cpcNo"></td>
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.cpcDueDate"></td>
                    <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.cpcWorkDone">
                      {{
                      formatDetailsCurrency(totalDetails.cpcWorkDone)
                      }}
                    </td>
                    <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.cpcPaymentOfWorkdone">
                      {{
                      formatDetailsCurrency(totalDetails.cpcPaymentOfWorkdone)
                      }}
                    </td>
                    <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.cpcAdvance">
                      {{
                      formatDetailsCurrency(totalDetails.cpcAdvance)
                      }}
                    </td>
                    <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.cpcRepayment">
                      {{
                      formatDetailsCurrency(totalDetails.cpcRepayment)
                      }}
                    </td>
                    <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.cpcRetention">
                      {{
                      formatDetailsCurrency(totalDetails.cpcRetention)
                      }}
                    </td>
                    <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.cpcOtherDeduction">
                      {{
                      formatDetailsCurrency(totalDetails.cpcOtherDeduction)
                      }}
                    </td>
                    <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.cpcAmountDue">
                      {{
                      formatDetailsCurrency(totalDetails.cpcAmountDue)
                      }}
                    </td>
                    <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.cpcVatAmountDue">
                      {{ formatDetailsCurrency(totalDetails.cpcVat)
                      }}
                    </td>
                  </template>
                  <template v-if="viewStates.cpcDetails.columnVisibility.payment">
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.paymentDate"></td>
                    <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.paymentAmount">
                      {{
                      formatDetailsCurrency(totalDetails.paymentAmount)
                      }}
                    </td>
                    <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.paymentVat">
                      {{
                      formatDetailsCurrency(totalDetails.paymentVat)
                      }}
                    </td>
                    <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.paymentTotal">
                      {{
                      formatDetailsCurrency(totalDetails.paymentTotal)
                      }}
                    </td>
                  </template>
                  <template v-if="viewStates.cpcDetails.columnVisibility.invoice">
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.invoiceNo"></td>
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.invoiceDate"></td>
                    <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.invoiceAmount">
                      {{
                      formatDetailsCurrency(totalDetails.invoiceAmount)
                      }}
                    </td>
                    <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.invoiceVat">
                      {{
                      formatDetailsCurrency(totalDetails.invoiceVat)
                      }}
                    </td>
                    <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.invoiceTotal">
                      {{
                      formatDetailsCurrency(totalDetails.invoiceTotal)
                      }}
                    </td>
                  </template>
                  <td v-if="viewStates.cpcDetails.columnVisibility.remainingPayable" class="text-end-custom">
                    {{
                    formatDetailsCurrency(totalDetails.remainingPayable)
                    }}
                  </td>
                  <template v-if="viewStates.cpcDetails.columnVisibility.contractRemaining">
                    <td class="text-end-custom"
                      v-if="viewStates.cpcDetails.subColumnVisibility.contractRemainingInclVat">
                      {{
                      formatDetailsCurrency(totalDetails.contractRemainingInclVat)
                      }}
                    </td>
                    <td class="text-end-custom"
                      v-if="viewStates.cpcDetails.subColumnVisibility.contractRemainingExclVat">
                      {{
                      formatDetailsCurrency(totalDetails.contractRemainingExclVat)
                      }}
                    </td>
                    <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.contractRemainingVat">
                      {{
                      formatDetailsCurrency(totalDetails.contractRemainingVat)
                      }}
                    </td>
                  </template>
                </tr>
                <tr>
                  <template v-if="viewStates.cpcDetails.columnVisibility.contract">
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.contractInfo">
                      <strong>{{ t('footerRemaining') }}</strong>
                    </td>
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.description"></td>
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.contractAmount"></td>
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.contractVon"></td>
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.contractVat"></td>
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.contractTotal"></td>
                  </template>
                  <template v-if="viewStates.cpcDetails.columnVisibility.cpc">
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.cpcNo"></td>
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.cpcDueDate"></td>
                    <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.cpcWorkDone">
                      {{
                      detailsCalculatedFooter.workDoneBalanceFormatted
                      }}
                    </td>
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.cpcPaymentOfWorkdone"></td>
                    <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.cpcAdvance">
                      {{
                      detailsCalculatedFooter.advanceBalanceFormatted
                      }}
                    </td>
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.cpcRepayment"></td>
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.cpcRetention"></td>
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.cpcOtherDeduction"></td>
                    <td class="text-end-custom" v-if="viewStates.cpcDetails.subColumnVisibility.cpcAmountDue">
                      {{ detailsCalculatedFooter.amountDueFormatted
                      }}
                    </td>
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.cpcVatAmountDue"></td>
                  </template>
                  <template v-if="viewStates.cpcDetails.columnVisibility.payment">
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.paymentDate"></td>
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.paymentAmount"></td>
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.paymentVat"></td>
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.paymentTotal"></td>
                  </template>
                  <template v-if="viewStates.cpcDetails.columnVisibility.invoice">
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.invoiceNo"></td>
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.invoiceDate"></td>
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.invoiceAmount"></td>
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.invoiceVat"></td>
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.invoiceTotal"></td>
                  </template>
                  <td v-if="viewStates.cpcDetails.columnVisibility.remainingPayable" class="text-end-custom">
                    {{
                    detailsCalculatedFooter.finalRemainingPayableFormatted
                    }}
                  </td>
                  <template v-if="viewStates.cpcDetails.columnVisibility.contractRemaining">
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.contractRemainingInclVat"></td>
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.contractRemainingExclVat"></td>
                    <td v-if="viewStates.cpcDetails.subColumnVisibility.contractRemainingVat"></td>
                  </template>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
      <div v-else class="text-center text-muted p-5 no-print">
        <h5>{{ t('pleaseSelectContractToView') }}</h5>
      </div>
    </div>

    <!-- Tab: Contract Overview -->
    <div v-if="currentTab === 'contract-overview'">
      <div v-if="selectedContractDetails && contractOverviewData">
        <div class="mb-3 no-print">
          <button class="btn btn-action-soft rounded-pill" @click="currentTab = 'cpc-details'">
            <i class="fas fa-arrow-left me-2"></i> {{ t('backToDetails') }}
          </button>
        </div>

        <!-- HEADER THÔNG TIN CHUNG -->
        <div class="overview-card mb-4">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <span class="badge bg-primary mb-2">{{ t('mainContract') }}</span>
              <span class="text-muted ms-2">#{{ selectedContractDetails.contractNo }}</span>
              <h2 class="fw-bold">{{ selectedContractDetails.description }}</h2>
              <div class="text-muted small">
                <i class="fas fa-project-diagram me-1"></i> {{ t('project') }}: {{ selectedContractDetails.projectName
                }}
              </div>
            </div>
            <div class="text-end">
              <div class="text-muted small text-uppercase fw-bold">{{ t('totalValue') }}</div>
              <h2 class="text-primary fw-bold">{{ formatCurrency(contractOverviewData.totalContractValue) }}</h2>
            </div>
          </div>
          <hr>
          <div class="row g-3">
            <div class="col-md-3 border-end">
              <div class="small text-muted"><i class="fas fa-hard-hat me-1"></i> {{ t('vendor') }}</div>
              <!-- Tên nhà thầu có thể click được -->
              <div class="fw-bold text-primary" style="cursor: pointer; text-decoration: none;"
                @mouseover="$event.target.style.textDecoration='underline'"
                @mouseleave="$event.target.style.textDecoration='none'"
                @click="goToVendorPartnerFromOverview(selectedContractDetails.vendorId, selectedContractDetails.vendorName)">
                <i class="fas fa-user-tie me-1 small opacity-50"></i>
                {{ selectedContractDetails.vendorName }}
              </div>
            </div>
            <div class="col-md-3 border-end">
              <div class="small text-muted"><i class="fas fa-calendar-alt me-1"></i> {{ t('duration') }}</div>
              <div class="fw-bold">{{ selectedContractDetails.date }} - {{ t('na') }}</div>
            </div>
            <!-- Cột Bảo lãnh (Thay thế Tạm ứng ban đầu theo yêu cầu trước) -->
            <div class="col-md-6 ps-4">
              <div class="small text-muted mb-1"><i class="fas fa-shield-alt me-1"></i> {{ t('bondEffective') }}</div>
              <div class="d-flex flex-wrap gap-3" v-if="overviewBonds.length > 0">
                <div v-for="bond in overviewBonds" :key="bond.id" class="d-flex flex-column border-start ps-2 border-2"
                  :class="getBondTypeColorClass(bond.bondType).replace('text-', 'border-')">
                  <span class="small fw-bold" :class="getBondTypeColorClass(bond.bondType)" style="font-size: 0.75rem;">
                    {{ bond.bondType }}
                  </span>
                  <span class="fw-bold"
                    :class="getBondStatusClassForDashboard(bond).badgeClass.includes('bg-danger') ? 'text-danger' : 'text-dark'">
                    <i class="far fa-calendar-alt me-1"></i>{{ bond.expiryDate }}
                  </span>
                </div>
              </div>
              <div v-else class="fw-bold text-muted italic small mt-1">
                <i class="fas fa-info-circle me-1"></i> {{ t('noBonds') }}
              </div>
            </div>
          </div>
        </div>

        <!-- ROW 4 CARDS TỔNG QUAN -->
        <div class="row g-3 mb-4">
          <div class="col-md-3">
            <div class="card h-100 border-0 shadow-sm p-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="small fw-bold text-muted">{{ t('acceptanceProgress') }}</span>
                <span class="badge bg-soft-primary text-primary">{{ contractOverviewData.progressPercent }}%</span>
              </div>
              <h4 class="fw-bold mb-3">{{ formatCurrency(contractOverviewData.totalWorkdone) }}</h4>
              <div class="progress mb-2" style="height: 8px;">
                <div class="progress-bar" :style="{width: contractOverviewData.progressPercent + '%'}"></div>
              </div>
              <div class="d-flex justify-content-between small text-muted">
                <span>{{ t('budget') }}: {{ formatNumber(contractOverviewData.budgetAmount) }}</span>
                <span>{{ t('footerRemaining') }}: {{ formatNumber(contractOverviewData.remainingValue) }}</span>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card h-100 border-0 shadow-sm p-3 border-start border-4 border-success">
              <span class="small fw-bold text-muted text-uppercase mb-2">{{ t('totalPaidHeader') }}</span>
              <h4 class="fw-bold text-success">{{ formatCurrency(contractOverviewData.totalPaid) }}</h4>
              <span class="text-muted small fst-italic">{{ t('totalPaidNote') }}</span>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card h-100 border-0 shadow-sm p-3 border-start border-4 border-warning">
              <span class="small fw-bold text-muted mb-2">{{ t('advanceBalanceHeader') }}</span>
              <h4 class="fw-bold text-warning">{{ formatCurrency(contractOverviewData.currentAdvanceBalance) }}</h4>
              <span class="text-muted small">{{ t('total') }}: {{ formatNumber(contractOverviewData.initialAdvance +
                contractOverviewData.additionalAdvance) }}</span>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card h-100 border-0 shadow-sm p-3 border-start border-4 border-primary">
              <span class="small fw-bold text-muted mb-2">{{ t('retentionValueHeader') }}</span>
              <h4 class="fw-bold text-primary">{{ formatCurrency(contractOverviewData.retentionValue) }}</h4>
              <span class="text-muted small">Workdone - PoW</span>
            </div>
          </div>
        </div>

        <!-- DÒNG TIỀN TẠM ỨNG -->
        <div class="alert alert-light border shadow-sm p-4 mb-4 bg-white">
          <h6 class="fw-bold mb-3"><i class="fas fa-info-circle text-warning me-2"></i> {{ t('advanceFlow') }}</h6>
          <div class="row g-4 text-center text-md-start">
            <div class="col-md-3">
              <div class="small text-muted">{{ t('initialAdvance') }}</div>
              <h5 class="fw-bold text-success">{{ formatCurrency(contractOverviewData.initialAdvance) }}</h5>
              <div class="small text-muted fst-italic" style="font-size: 0.7rem;">(First disbursement)</div>
            </div>
            <div class="col-md-3">
              <div class="small text-muted">{{ t('additionalAdvance') }}</div>
              <h5 class="fw-bold text-dark">{{ formatCurrency(contractOverviewData.additionalAdvance) }}</h5>
              <div class="small text-muted fst-italic" style="font-size: 0.7rem;">(Subsequent advances)</div>
            </div>
            <div class="col-md-3">
              <div class="small text-muted">{{ t('totalRecovered') }}</div>
              <h5 class="fw-bold text-danger">{{ formatCurrency(contractOverviewData.totalRecovered) }}</h5>
              <div class="small text-muted fst-italic" style="font-size: 0.7rem;">(Cumulative repayment)</div>
            </div>
            <div class="col-md-3 border-start ps-4">
              <div class="small text-muted">{{ t('currentAdvanceBalance') }}</div>
              <h5 class="fw-bold text-primary">{{ formatCurrency(contractOverviewData.currentAdvanceBalance) }}</h5>
              <div class="small text-muted fw-bold" style="font-size: 0.7rem; color: #64748b;">
                <i class="fas fa-arrow-right me-1"></i>{{ t('toRecover') }}
              </div>
            </div>
          </div>
        </div>
        <!-- BẢNG LỊCH SỬ HỒ SƠ -->
        <div class="card border-0 shadow-sm mb-5">
          <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
            <h5 class="m-0 fw-bold"><i class="fas fa-list-ol me-2 text-primary"></i> {{ t('paymentHistory') }}</h5>
            <button class="btn btn-sm btn-outline-primary rounded-pill px-3 no-print"
              @click="isHistoryExpanded = !isHistoryExpanded">
              <i class="fas" :class="isHistoryExpanded ? 'fa-compress-alt' : 'fa-expand-alt'"></i>
              {{ isHistoryExpanded ? t('viewOverviewMode') : t('viewDetailedMode') }}
            </button>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table mb-0 align-middle table-hover" style="min-width: 1400px;">
                <thead class="bg-light small text-muted text-uppercase">
                  <tr>
                    <th class="ps-4 text-start" style="width: 250px;">{{ t('cpcStatusGroup') }}</th>
                    <th class="text-end">Workdone</th>
                    <th class="text-end">PoW</th>
                    <th class="text-end">Advance</th>
                    <th class="text-end">Repayment</th>
                    <th class="text-end">Retention</th>
                    <th class="text-end">Other Ded.</th>
                    <th class="text-end text-primary">Amount Due</th>
                    <th class="text-end text-success">Amount Paid</th>
                    <th class="text-center" style="width: 130px;">{{ t('status') }}</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- CHẾ ĐỘ 1: COLLAPSE -->
                  <template v-if="!isHistoryExpanded">
                    <tr class="bg-soft-success">
                      <td class="ps-4 text-start py-3">
                        <div class="fw-bold text-success">{{ t('summaryPaid') }}</div>
                        <div class="small text-muted">{{ historySummaryRows.paid.count }} {{ t('cpc') }}</div>
                      </td>
                      <td class="text-end fw-bold">{{ formatNumber(historySummaryRows.paid.workDone) }}</td>
                      <td class="text-end">{{ formatNumber(historySummaryRows.paid.paymentOfWorkdone) }}</td>
                      <td class="text-end text-success">{{ formatNumber(historySummaryRows.paid.advance) }}</td>
                      <td class="text-end text-danger">{{ formatNumber(historySummaryRows.paid.repayment) }}</td>
                      <td class="text-end text-danger">{{ formatNumber(historySummaryRows.paid.retention) }}</td>
                      <td class="text-end text-danger">{{ formatNumber(historySummaryRows.paid.otherDeduction) }}</td>
                      <td class="text-end fw-bold text-primary">{{ formatNumber(historySummaryRows.paid.amountDue) }}
                      </td>
                      <td class="text-end fw-bold text-success">{{ formatNumber(historySummaryRows.paid.amountPaid) }}
                      </td>
                      <td class="text-center"><span class="badge bg-success text-uppercase">{{ t('complete') }}</span>
                      </td>
                    </tr>
                    <tr class="bg-soft-warning">
                      <td class="ps-4 text-start py-3">
                        <div class="fw-bold text-warning">{{ t('summaryProcessing') }}</div>
                        <div class="small text-muted">{{ historySummaryRows.processing.count }} {{ t('cpc') }}</div>
                      </td>
                      <td class="text-end fw-bold">{{ formatNumber(historySummaryRows.processing.workDone) }}</td>
                      <td class="text-end">{{ formatNumber(historySummaryRows.processing.paymentOfWorkdone) }}</td>
                      <td class="text-end text-success">{{ formatNumber(historySummaryRows.processing.advance) }}</td>
                      <td class="text-end text-danger">{{ formatNumber(historySummaryRows.processing.repayment) }}</td>
                      <td class="text-end text-danger">{{ formatNumber(historySummaryRows.processing.retention) }}</td>
                      <td class="text-end text-danger">{{ formatNumber(historySummaryRows.processing.otherDeduction) }}
                      </td>
                      <td class="text-end fw-bold text-primary">{{ formatNumber(historySummaryRows.processing.amountDue)
                        }}</td>
                      <td class="text-end fw-bold text-warning">{{
                        formatNumber(historySummaryRows.processing.amountPaid) }}</td>
                      <td class="text-center"><span class="badge bg-warning text-dark text-uppercase">{{ t('processing')
                          }}</span></td>
                    </tr>
                  </template>

                  <!-- CHẾ ĐỘ 2: EXPAND -->
                  <template v-else>
                    <tr v-for="item in groupedContractHistoryTable" :key="item.id">
                      <td class="ps-4 text-start">
                        <div class="fw-bold text-primary">{{ item.cpcNo }}</div>
                        <div class="small text-muted text-truncate" style="max-width: 200px;">{{ item.description }}
                        </div>
                      </td>
                      <td class="text-end fw-bold">{{ formatNumber(item.workDone) }}</td>
                      <td class="text-end">{{ formatNumber(item.paymentOfWorkdone) }}</td>
                      <td class="text-end text-success">{{ item.advance > 0 ? formatNumber(item.advance) : '-' }}</td>
                      <td class="text-end text-danger">{{ item.repayment < 0 ? formatNumber(item.repayment) : '-'
                          }}</td>
                      <td class="text-end text-danger">{{ item.retention < 0 ? formatNumber(item.retention) : '-'
                          }}</td>
                      <td class="text-end text-danger">{{ item.otherDeduction < 0 ? formatNumber(item.otherDeduction)
                          : '-' }}</td>
                      <td class="text-end fw-bold text-primary">{{ formatNumber(item.amountDue) }}</td>
                      <td class="text-end fw-bold text-dark">{{ formatNumber(item.amountPaid) }}</td>
                      <td class="text-center">
                        <div v-if="item.amountPaid > 0 && item.amountPaid < item.amountDue" class="px-2">
                          <div class="d-flex justify-content-between mb-1" style="font-size: 0.65rem;">
                            <span class="text-warning fw-bold">PARTIAL</span>
                            <span class="text-muted">{{ Math.round((item.amountPaid / item.amountDue) * 100) }}%</span>
                          </div>
                          <div class="progress" style="height: 3px;">
                            <div class="progress-bar bg-warning" role="progressbar"
                              :style="{ width: (item.amountPaid / item.amountDue * 100) + '%' }"></div>
                          </div>
                        </div>
                        <span v-else
                          :class="item.amountPaid >= item.amountDue ? 'badge bg-success' : 'badge bg-light text-muted border'"
                          style="font-size: 0.7rem;">
                          {{ item.amountPaid >= item.amountDue ? t('complete').toUpperCase() :
                          t('unpaidStatus').toUpperCase() }}
                        </span>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div v-if="currentTab === 'vendor-balance'">
      <!-- 1. TOOLBAR HÀNH ĐỘNG (ACTION BAR) -->
      <div class="master-data-toolbar no-print">
        <!-- Nhóm Công cụ Tính toán -->
        <div class="toolbar-group">
          <div>
            <span class="toolbar-label">Công cụ hệ thống</span>
            <div class="d-flex gap-2">
              <button class="btn btn-primary shadow-sm px-3" @click="manualRecalculateVendorBalance"
                title="Tính toán lại toàn bộ số liệu công nợ">
                <i class="fas fa-sync-alt me-2"></i>Làm mới số liệu
              </button>
              <button class="btn btn-soft-warning px-3 shadow-sm" @click="promptAndDebugVendor()"
                title="Truy vết chi tiết cách tính công nợ">
                <i class="fas fa-bug me-2"></i>{{ t('btnDebugVendor') }}
              </button>
            </div>
          </div>
        </div>

        <!-- Nhóm Đối chiếu Kế toán (SAP) -->
        <div class="toolbar-group ms-auto">
          <div>
            <span class="toolbar-label text-center">Đối chiếu SAP/Kế toán</span>
            <div class="d-flex gap-2">
              <button class="btn btn-soft-success px-3 shadow-sm" @click="triggerAccountingFileUpload">
                <i class="fas fa-file-invoice-dollar me-2"></i>{{ t('btnUploadReconcile') }}
              </button>
              <button class="btn btn-soft-secondary px-3 shadow-sm" v-if="accountingComparisonData"
                @click="clearAccountingComparison">
                <i class="fas fa-times me-2"></i>{{ t('btnClear') }}
              </button>
            </div>
            <input type="file" ref="accountingUploadInput" @change="handleAccountingFileUpload" accept=".xlsx, .xls"
              style="display: none" />
          </div>
        </div>

        <!-- Nhóm Tìm kiếm & Hiển thị -->
        <div class="search-input-group ms-3">
          <span class="toolbar-label">{{ t('search') }}</span>
          <div class="input-group shadow-sm border rounded-3 overflow-hidden">
            <span class="input-group-text border-0 bg-white"><i class="fas fa-search text-muted"></i></span>
            <input type="text" class="form-control border-0" :placeholder="t('searchVendorPlaceholder')"
              v-model="viewStates.vendorBalance.searchTerm" ref="vendorBalanceSearchInput">
            <button v-if="viewStates.vendorBalance.searchTerm" @click="viewStates.vendorBalance.searchTerm = ''"
              class="btn border-0 bg-white text-danger" type="button">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- 2. BỘ LỌC TÍCH HỢP (FILTER WRAPPER) -->
      <div class="filter-wrapper no-print mb-4" :class="{ 'is-expanded': !viewStates.vendorBalance.isFilterCollapsed }">
        <div class="filter-header-bar" @click="toggleFilterPanel(viewStates.vendorBalance)">
          <div class="d-flex align-items-center flex-grow-1">
            <i class="fas fa-filter text-primary me-2"></i>
            <span class="fw-bold me-3">{{ t('filterPanelTitle') }}</span>
            <span v-if="viewStates.vendorBalance.isFilterCollapsed" class="text-muted small text-truncate"
              style="max-width: 600px;">
              <i class="fas fa-info-circle me-1"></i>
              {{ activeFiltersSummary(viewStates.vendorBalance) }}
              <span v-if="viewStates.vendorBalance.filter.asOfDate" class="ms-2">| {{ t('reportAsOf') }}: {{
                viewStates.vendorBalance.filter.asOfDate }}</span>
            </span>
          </div>
          <div class="d-flex align-items-center gap-2">
            <button
              v-if="activeFiltersSummary(viewStates.vendorBalance) !== t('noActiveFilters') || viewStates.vendorBalance.filter.asOfDate"
              class="btn btn-sm btn-link text-danger p-0 me-2 text-decoration-none" @click.stop="clearAllFilters">
              <i class="fas fa-sync-alt me-1"></i> {{ t('btnClearAllFilters') }}
            </button>
            <i class="fas fa-chevron-down filter-toggle-icon text-secondary"></i>
          </div>
        </div>

        <div class="filter-expand-content">
          <div class="filter-grid" style="grid-template-columns: repeat(4, 1fr);">
            <!-- Dự án -->
            <div class="filter-group">
              <div class="filter-group-header">
                <h6
                  @click="viewStates.vendorBalance.filter.expansion.project = !viewStates.vendorBalance.filter.expansion.project">
                  <i class="fas fa-folder me-2"></i><span>{{ t('project') }}</span>
                </h6>
                <button class="clear-filter-btn" @click="viewStates.vendorBalance.filter.projectId = []"><i
                    class="fas fa-times"></i></button>
              </div>
              <input type="text" class="form-control filter-search mb-2"
                v-model="viewStates.vendorBalance.filter.projectSearch" :placeholder="t('searchProjects')">
              <div class="slicer-options"
                :class="{ 'slicer-options-expanded': viewStates.vendorBalance.filter.expansion.project }">
                <button v-for="project in availableProjectsForVendorBalance" :key="project.id" class="btn slicer-btn"
                  :class="{ 'slicer-btn-selected': viewStates.vendorBalance.filter.projectId.includes(project.id) }"
                  @click="toggleFilter(viewStates.vendorBalance.filter.projectId, project.id)">
                  {{ project.name }}
                </button>
              </div>
            </div>

            <!-- Trạng thái Số dư -->
            <div class="filter-group">
              <div class="filter-group-header">
                <h6><i class="fas fa-balance-scale me-2"></i>{{ t('outstandingBalanceStatus') }}</h6>
              </div>
              <div class="slicer-options slicer-options-expanded">
                <button class="btn slicer-btn mb-1"
                  :class="{ 'slicer-btn-selected': viewStates.vendorBalance.filter.balanceStatus === 'hasBalance' }"
                  @click="toggleZeroFilter(viewStates.vendorBalance.filter, 'balanceStatus', 'hasBalance')">
                  {{ t('balanceStatusHasBalance') }}
                </button>
                <button class="btn slicer-btn mb-1"
                  :class="{ 'slicer-btn-selected': viewStates.vendorBalance.filter.balanceStatus === 'fullySettled' }"
                  @click="toggleZeroFilter(viewStates.vendorBalance.filter, 'balanceStatus', 'fullySettled')">
                  {{ t('fullySettled') }}
                </button>
              </div>
            </div>

            <!-- Trạng thái Đối chiếu -->
            <div class="filter-group">
              <div class="filter-group-header">
                <h6><i class="fas fa-tasks me-2"></i><span>{{ t('status') }} Đối chiếu</span></h6>
              </div>
              <div class="slicer-options slicer-options-expanded">
                <button v-for="status in ['Match', 'Mismatch', 'Only in App', 'Only in Accounting']" :key="status"
                  class="btn slicer-btn mb-1"
                  :class="{ 'slicer-btn-selected': viewStates.vendorBalance.filter.status.includes(status) }"
                  @click="toggleFilter(viewStates.vendorBalance.filter.status, status)">
                  {{ t(`status${status.replace(/ /g, '')}`) }}
                </button>
              </div>
            </div>

            <!-- Ngày báo cáo -->
            <div class="filter-group">
              <div class="filter-group-header">
                <h6><i class="fas fa-calendar-alt me-2"></i>{{ t('reportAsOf') }}</h6>
              </div>
              <div class="p-2 bg-light rounded-3 border">
                <input type="date" class="form-control form-control-sm"
                  v-model="viewStates.vendorBalance.filter.asOfDate">
                <small class="text-muted mt-2 d-block italic" style="font-size: 0.7rem;">Hệ thống tính toán số dư lũy kế
                  đến hết ngày này.</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 3. ĐIỀU KHIỂN HIỂN THỊ (VIEW CONTROLS) -->
      <div class="table-controls mb-3">
        <div class="d-flex align-items-center gap-2">
          <label class="form-label mb-0 text-secondary small">{{ t('showEntriesLabel') }}</label>
          <div class="year-nav-group">
            <button class="btn btn-sm btn-light border-0" @click="changePerPage(viewStates.vendorBalance, -1)"
              :disabled="viewStates.vendorBalance.perPage <= 5">
              <i class="fas fa-chevron-left fa-xs"></i>
            </button>
            <div class="year-display" style="min-width: 40px">{{ viewStates.vendorBalance.perPage }}</div>
            <button class="btn btn-sm btn-light border-0" @click="changePerPage(viewStates.vendorBalance, 1)"
              :disabled="viewStates.vendorBalance.perPage >= 100">
              <i class="fas fa-chevron-right fa-xs"></i>
            </button>
          </div>
        </div>
        <div class="ms-auto text-muted small fst-italic">
          <i class="fas fa-info-circle me-1"></i> Nhấp vào tên Nhà cung cấp để xem danh sách hợp đồng chi tiết.
        </div>
      </div>

      <!-- 4. BẢNG DỮ LIỆU CÔNG NỢ -->
      <div class="card border-0 shadow-sm overflow-hidden">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="bg-light">
                <tr>
                  <th class="text-center-custom no-sort" style="width: 50px">#</th>
                  <th @click="handleSort(viewStates.vendorBalance, 'vendorNo')" style="cursor:pointer">{{ t('vendorNo')
                    }} <i class="fas fa-sort ms-1 opacity-25"></i></th>
                  <th @click="handleSort(viewStates.vendorBalance, 'vendorName')" style="cursor:pointer">{{ t('vendor')
                    }} <i class="fas fa-sort ms-1 opacity-25"></i></th>
                  <th class="text-end-custom" @click="handleSort(viewStates.vendorBalance, 'gl3311_app')">{{ t('gl3311')
                    }} (App)</th>
                  <th class="text-end-custom bg-soft-success" v-if="accountingComparisonData"
                    @click="handleSort(viewStates.vendorBalance, 'gl3311_excel')">{{ t('payableSap') }}</th>
                  <th class="text-end-custom" v-if="accountingComparisonData"
                    @click="handleSort(viewStates.vendorBalance, 'gl3311_diff')">{{ t('difference') }}</th>
                  <th class="text-end-custom" @click="handleSort(viewStates.vendorBalance, 'gl3312_app')">{{ t('gl3312')
                    }} (App)</th>
                  <th class="text-end-custom bg-soft-success" v-if="accountingComparisonData"
                    @click="handleSort(viewStates.vendorBalance, 'gl3312_excel')">{{ t('advanceSap') }}</th>
                  <th class="text-end-custom" v-if="accountingComparisonData"
                    @click="handleSort(viewStates.vendorBalance, 'gl3312_diff')">{{ t('difference') }}</th>
                  <th class="text-center-custom no-sort" v-if="accountingComparisonData" style="width: 120px">{{
                    t('status') }}</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(item, index) in paginatedVendorBalanceComparison" :key="item.vendorId"
                  :class="{'table-warning': item.status === 'Mismatch', 'table-info': item.status === 'Only in App', 'table-light': item.status === 'Only in Accounting'}">
                  <td class="text-center-custom fw-bold text-muted">{{ (viewStates.vendorBalance.currentPage - 1) *
                    viewStates.vendorBalance.perPage + index + 1 }}</td>
                  <td class="font-monospace small">{{ item.vendorNo }}</td>
                  <td>
                    <a href="#" @click.stop.prevent="goToContractDashboardFromVendor(item)"
                      class="fw-bold text-primary text-decoration-none">
                      {{ item.vendorName }}
                    </a>
                  </td>
                  <td class="text-end-custom fw-bold">{{ formatCurrency(item.gl3311_app) }}</td>
                  <td class="text-end-custom text-success fw-medium" v-if="accountingComparisonData">{{
                    formatCurrency(item.gl3311_excel) }}</td>
                  <td class="text-end-custom" v-if="accountingComparisonData"
                    :class="{'fw-bold text-danger': Math.abs(item.gl3311_diff) > 1}">{{ formatCurrency(item.gl3311_diff)
                    }}</td>
                  <td class="text-end-custom fw-bold text-secondary">{{ formatCurrency(item.gl3312_app) }}</td>
                  <td class="text-end-custom text-success fw-medium" v-if="accountingComparisonData">{{
                    formatCurrency(item.gl3312_excel) }}</td>
                  <td class="text-end-custom" v-if="accountingComparisonData"
                    :class="{'fw-bold text-danger': Math.abs(item.gl3312_diff) > 1}">{{ formatCurrency(item.gl3312_diff)
                    }}</td>
                  <td class="text-center-custom" v-if="accountingComparisonData">
                    <span class="badge" :class="getComparisonStatusBadge(item.status)">{{
                      t(`status${item.status.replace(/ /g, '')}`) }}</span>
                  </td>
                </tr>
                <tr v-if="vendorBalanceComparison.length === 0">
                  <td :colspan="accountingComparisonData ? 10 : 5" class="text-center text-muted py-5">{{
                    t('noMatchingData') }}</td>
                </tr>
              </tbody>
              <tfoot class="sticky-footer bg-light" v-if="vendorBalanceComparison.length > 0">
                <tr class="fw-bold">
                  <td colspan="3" class="text-end-custom text-muted small uppercase pe-3">{{ t('total') }}:</td>
                  <td class="text-end-custom text-primary">{{ formatCurrency(totalVendorBalanceComparison.gl3311_app) }}
                  </td>
                  <td class="text-end-custom text-success" v-if="accountingComparisonData">{{
                    formatCurrency(totalVendorBalanceComparison.gl3311_excel) }}</td>
                  <td class="text-end-custom" v-if="accountingComparisonData">{{
                    formatCurrency(totalVendorBalanceComparison.gl3311_diff) }}</td>
                  <td class="text-end-custom text-secondary">{{ formatCurrency(totalVendorBalanceComparison.gl3312_app)
                    }}</td>
                  <td class="text-end-custom text-success" v-if="accountingComparisonData">{{
                    formatCurrency(totalVendorBalanceComparison.gl3312_excel) }}</td>
                  <td class="text-end-custom" v-if="accountingComparisonData">{{
                    formatCurrency(totalVendorBalanceComparison.gl3312_diff) }}</td>
                  <td v-if="accountingComparisonData"></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>

      <!-- 5. PHÂN TRANG -->
      <!-- PHẦN PHÂN TRANG HIỆN ĐẠI CHO TAB VENDOR BALANCE -->
      <div class="pagination-wrapper no-print">
        <!-- Thông tin số lượng dòng (Bên trái) -->
        <div class="entries-info-text">
          <i class="fas fa-list-ol me-1"></i>
          {{ t('paginationInfo', {
          start: (viewStates.vendorBalance.currentPage - 1) * viewStates.vendorBalance.perPage + 1,
          end: Math.min(viewStates.vendorBalance.currentPage * viewStates.vendorBalance.perPage,
          vendorBalanceComparison.length),
          total: vendorBalanceComparison.length
          }) }}
        </div>

        <!-- Cụm điều khiển trang hình viên thuốc (Bên phải) -->
        <div class="modern-pagination-container">
          <!-- Nút Previous -->
          <button class="btn btn-pagination-modern" @click="viewStates.vendorBalance.currentPage--"
            :disabled="viewStates.vendorBalance.currentPage === 1">
            <i class="fas fa-arrow-left"></i>
            <span>{{ t('btnPrevious') }}</span>
          </button>

          <!-- Hiển thị Số trang Hiện tại / Tổng số trang -->
          <div class="page-info-pill">
            {{ viewStates.vendorBalance.currentPage }} / {{ vendorBalanceTotalPages }}
          </div>

          <!-- Nút Next -->
          <button class="btn btn-pagination-modern" @click="viewStates.vendorBalance.currentPage++"
            :disabled="viewStates.vendorBalance.currentPage >= vendorBalanceTotalPages">
            <span>{{ t('btnNext') }}</span>
            <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>
    </div>
    <div v-if="currentTab === 'vendor-partner'" class="row g-0 h-100" style="margin: -2rem">
      <!-- Sidebar Nhà thầu -->
      <div class="col-md-3 vendor-sidebar no-print">
        <div class="p-3">
          <h5 class="fw-bold mb-3">{{ t('vendorPartner') }}</h5>
          <div class="input-group mb-3">
            <span class="input-group-text bg-light border-end-0"><i class="fas fa-search"></i></span>
            <input type="text" class="form-control border-start-0 bg-light" :placeholder="t('vendorSearchHint')"
              v-model="viewStates.vendorPartner.searchTerm" ref="vendorPartnerSearchInput">
          </div>

          <div class="vendor-list">
            <!-- Trạng thái chờ tìm kiếm -->
            <div v-if="viewStates.vendorPartner.searchTerm.trim().length < 2" class="text-center py-5 text-muted small">
              <i class="fas fa-search mb-2 d-block fa-2x opacity-25"></i>
              {{ t('startSearchPrompt') }}
            </div>

            <!-- Trạng thái không tìm thấy -->
            <div v-else-if="vendorPartnerList.length === 0" class="text-center py-5 text-muted small">
              {{ t('noResultsFound') }}
            </div>

            <!-- Danh sách kết quả -->
            <div v-else v-for="v in vendorPartnerList" :key="v.id" class="vendor-item rounded-3 mb-2"
              :class="{ active: viewStates.vendorPartner.selectedId === v.id }"
              @click="viewStates.vendorPartner.selectedId = v.id">
              <div class="fw-bold text-dark text-truncate">{{ v.name }}</div>
              <div class="small text-muted">{{ v.contractCount }} {{ t('contract').toLowerCase() }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Nội dung chi tiết -->
      <div class="col-md-9 p-4" style="background: #f8fafc; overflow-y: auto;">
        <div v-if="selectedVendorData">
          <!-- Vendor Header Card -->
          <div class="vendor-main-card d-flex align-items-center mb-4">
            <div class="vendor-avatar-box me-4 shadow-sm">
              <i class="fas fa-building"></i>
            </div>
            <div class="flex-grow-1">
              <h3 class="fw-bold mb-1">{{ selectedVendorData.vendor.name }}</h3>
              <div class="d-flex gap-4 text-muted small">
                <span><strong># MST:</strong> {{ selectedVendorData.vendor.vendorNo }}</span>
                <!-- Hiển thị Người liên hệ -->
                <span><i class="fas fa-user-tie me-1"></i> {{ selectedVendorData.vendor.contactPerson || t('na')
                  }}</span>
                <!-- Hiển thị Số điện thoại -->
                <span><i class="fas fa-phone-alt me-1"></i> {{ selectedVendorData.vendor.phoneNumber || t('na')
                  }}</span>
              </div>
              <div class="mt-3">
                <span class="badge bg-light text-dark border me-2"><i class="fas fa-file-contract me-1"></i> {{
                  selectedVendorData.contracts.length }} {{ t('activeContracts') }}</span>
                <span class="badge bg-light text-dark border"><i class="fas fa-project-diagram me-1"></i> {{
                  selectedVendorData.projectCount }} {{ t('joinedProjects') }}</span>
              </div>
            </div>
          </div>

          <!-- Top Stat Cards -->
          <div class="row g-4 mb-4">
            <!-- Card 1: Công nợ CPC -->
            <div class="col-md-6">
              <div class="stat-card-dark h-100 shadow-lg"
                style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);">
                <div class="small opacity-75 mb-1">{{ t('cpcOutstanding') }}</div>
                <h2 class="fw-bold mb-4" style="color: #38bdf8;">{{
                  formatCurrency(selectedVendorData.totalCpcOutstanding) }}</h2>
                <div class="d-flex justify-content-between small mb-2">
                  <span>{{ t('workProgress') }}</span>
                  <span>{{ selectedVendorData.overallProgress }}%</span>
                </div>
                <div class="progress rounded-pill" style="height: 6px; background: rgba(255,255,255,0.1);">
                  <div class="progress-bar bg-info" :style="{ width: selectedVendorData.overallProgress + '%' }"></div>
                </div>
              </div>
            </div>
            <!-- Card 2: Dư nợ Tạm ứng -->
            <div class="col-md-3">
              <div class="card h-100 border-0 shadow-sm p-4 rounded-4 border-start border-4 border-warning">
                <div class="small text-muted mb-1">{{ t('advBalance') }}</div>
                <h3 class="fw-bold text-warning mb-3">{{ formatCurrency(selectedVendorData.totalAdvBalance) }}</h3>
                <span class="badge bg-soft-warning text-dark rounded-pill px-3" style="font-size: 0.65rem;">
                  <i class="fas fa-hand-holding-usd me-1"></i> {{ t('unrecovered') }}
                </span>
              </div>
            </div>
            <!-- Card 3: Bảo hành -->
            <div class="col-md-3">
              <div class="card h-100 border-0 shadow-sm p-4 rounded-4 border-start border-4 border-primary">
                <div class="small text-muted mb-1">{{ t('retentionHeld') }}</div>
                <h3 class="fw-bold text-primary mb-3">{{ formatCurrency(selectedVendorData.totalRetention) }}</h3>
                <div class="text-muted small" style="font-size: 0.7rem;"><i class="fas fa-shield-alt me-1"></i> {{
                  t('retentionPool') }}</div>
              </div>
            </div>
          </div>

          <!-- Detailed Table -->
          <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
            <div class="card-header bg-white p-4 border-0">
              <h5 class="fw-bold mb-0 text-primary"><i class="fas fa-list-ul me-2"></i> {{ t('contractList') }}</h5>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-modern align-middle mb-0">
                  <thead>
                    <tr>
                      <th class="ps-4">{{ t('contractProjectHeader') }}</th>
                      <th class="text-end">{{ t('contractValueHeader') }}</th>
                      <th class="text-center" style="width: 150px;">{{ t('status') }} / {{ t('acceptanceShort') }}</th>
                      <th class="text-end pe-4">{{ t('confirmedCpc') }}</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="c in selectedVendorData.contracts" :key="c.id" class="hover-bg-light">
                      <td class="ps-4">
                        <div class="text-primary small fw-bold mb-1">{{ c.projectName.toUpperCase() }}</div>
                        <!-- Link điều hướng sang Contract Overview -->
                        <div class="fw-bold text-dark" style="cursor: pointer; text-decoration: none;"
                          @click="goToContractOverviewFromVendor(c)" title="View detailed overview">
                          <i class="fas fa-external-link-alt me-1 small opacity-50"></i>
                          {{ c.contractNo }}
                        </div>
                        <div class="small text-muted text-truncate" style="max-width: 300px;">{{ c.description }}</div>
                      </td>
                      <td class="text-end">
                        <div class="fw-bold">{{ formatCurrency(c.budget) }}</div>
                        <div class="small text-muted" style="font-size: 0.7rem;">{{ t('acceptanceShort') }}: {{
                          formatCurrency(c.workdone) }}</div>
                      </td>
                      <td>
                        <div class="text-center mb-1">
                          <span :class="getStatusBadgeClass(c.status)" style="font-size: 0.65rem; padding: 2px 8px;">
                            {{ t((c.status || 'active').toLowerCase()) }}
                          </span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                          <div class="progress flex-grow-1" style="height: 4px; background: #eee;">
                            <div class="progress-bar bg-primary" :style="{ width: c.progress + '%' }"></div>
                          </div>
                          <span class="small fw-bold">{{ c.progress }}%</span>
                        </div>
                      </td>
                      <td class="text-end pe-4">
                        <div class="fw-bold text-danger">{{ formatCurrency(c.outstanding) }}</div>
                        <div class="small text-muted italic" style="font-size: 0.7rem;">{{ t('advBalShort') }}: {{
                          formatCurrency(c.advBalance) }}</div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <!-- Màn hình trống -->
        <div v-else class="h-100 d-flex flex-column align-items-center justify-content-center text-muted">
          <i class="fas fa-handshake fa-4x mb-3 opacity-25"></i>
          <h5>{{ t('selectVendorPrompt') }}</h5>
        </div>
      </div>
    </div>

    <div v-if="currentTab === 'cpc-dashboard'">
      <div class="overview-card no-print">
        <div class="overview-header-top">
          <div class="d-flex align-items-center">
            <div class="stat-icon-bg me-3" style="background: #fff1f2; color: #e11d48">
              <i class="fas fa-chart-line"></i>
            </div>
            <div class="overview-title">
              <h4>Financial Overview</h4>
              <span>Aggregated payment and swap statistics</span>
            </div>
          </div>

          <div class="d-flex align-items-center gap-2">

            <div class="year-nav-group ms-2">
              <button class="btn btn-sm btn-light border-0" @click="changeDashboardYear(-1)">
                <i class="fas fa-chevron-left fa-xs"></i>
              </button>
              <div class="year-display">
                {{ paymentDashboardYear }}
              </div>
              <button class="btn btn-sm btn-light border-0" @click="changeDashboardYear(1)">
                <i class="fas fa-chevron-right fa-xs"></i>
              </button>
            </div>
          </div>
        </div>

        <div class="stat-grid">
          <div class="stat-card card-vnd">
            <div>
              <span class="label">Total Paid (VND)</span>
              <h3 class="value">
                {{ formatCurrency(dashboardStats.totalVnd) }}
              </h3>
            </div>
            <div class="stat-icon-bg">
              <i class="fas fa-wallet"></i>
            </div>
          </div>

          <div class="stat-card card-usd">
            <div>
              <span class="label">Total Paid (USD)</span>
              <h3 class="value">
                {{ formatCurrencyUSD(dashboardStats.totalUsd) }}
              </h3>
            </div>
            <div class="stat-icon-bg">
              <i class="fas fa-dollar-sign"></i>
            </div>
          </div>

          <div class="stat-card card-swap">
            <div>
              <span class="label">Total SWAP Value</span>
              <h3 class="value">
                {{ formatCurrency(dashboardStats.totalSwap) }}
              </h3>
            </div>
            <div class="stat-icon-bg">
              <i class="fas fa-sync"></i>
            </div>
          </div>

          <div class="stat-card card-trans">
            <div>
              <span class="label">Transactions</span>
              <h3 class="value">{{ dashboardStats.count }}</h3>
            </div>
            <div class="stat-icon-bg">
              <i class="fas fa-layer-group"></i>
            </div>
          </div>
        </div>
      </div>

      <div class="filter-wrapper no-print mb-4"
        :class="{ 'is-expanded': !viewStates.paymentDashboard.isFilterCollapsed }">
        <!-- Thanh Header: Luôn hiển thị, chứa tóm tắt khi đóng -->
        <div class="filter-header-bar" @click="toggleFilterPanel(viewStates.paymentDashboard)">
          <div class="d-flex align-items-center flex-grow-1">
            <i class="fas fa-filter text-primary me-2"></i>
            <span class="fw-bold me-3">{{ t('filterPanelTitle') }}</span>

            <!-- Hiển thị tóm tắt bộ lọc khi đóng -->
            <span v-if="viewStates.paymentDashboard.isFilterCollapsed" class="text-muted small text-truncate"
              style="max-width: 600px;">
              <i class="fas fa-info-circle me-1"></i>
              {{ activeFiltersSummary(viewStates.paymentDashboard) }}

            </span>
          </div>

          <div class="d-flex align-items-center gap-2">
            <!-- Nút xóa nhanh tất cả bộ lọc -->
            <button v-if="activeFiltersSummary(viewStates.paymentDashboard) !== t('noActiveFilters')"
              class="btn btn-sm btn-link text-danger p-0 me-2 text-decoration-none" @click.stop="clearAllFilters">
              <i class="fas fa-sync-alt me-1"></i> {{ t('btnClearAllFilters') }}
            </button>
            <i class="fas fa-chevron-down filter-toggle-icon text-secondary"></i>
          </div>
        </div>

        <!-- Nội dung bộ lọc khi mở rộng -->
        <div class="filter-expand-content">
          <div class="filter-grid">

            <!-- 1. Bộ lọc Dự án -->
            <div class="filter-group">
              <div class="filter-group-header">
                <h6
                  @click="viewStates.paymentDashboard.filter.expansion.project = !viewStates.paymentDashboard.filter.expansion.project">
                  <i class="fas fa-folder me-2"></i><span>{{ t('project') }}</span>
                </h6>
                <button class="clear-filter-btn"
                  @click="viewStates.paymentDashboard.filter.projectId = []; viewStates.paymentDashboard.filter.projectSearch = ''">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <input type="text" class="form-control filter-search mb-2"
                v-model="viewStates.paymentDashboard.filter.projectSearch" :placeholder="t('searchProjects')">
              <div class="slicer-options"
                :class="{ 'slicer-options-expanded': viewStates.paymentDashboard.filter.expansion.project }">
                <button v-for="project in availableProjects" :key="project.id" class="btn slicer-btn"
                  :class="{ 'slicer-btn-selected': viewStates.paymentDashboard.filter.projectId.includes(project.id) }"
                  @click="toggleFilter(viewStates.paymentDashboard.filter.projectId, project.id)">
                  {{ project.name }}
                </button>
              </div>
            </div>

            <!-- 2. Bộ lọc Nhà cung cấp -->
            <div class="filter-group">
              <div class="filter-group-header">
                <h6
                  @click="viewStates.paymentDashboard.filter.expansion.vendor = !viewStates.paymentDashboard.filter.expansion.vendor">
                  <i class="fas fa-truck-fast me-2"></i><span>{{ t('vendor') }}</span>
                </h6>
                <button class="clear-filter-btn"
                  @click="viewStates.paymentDashboard.filter.vendorId = []; viewStates.paymentDashboard.filter.vendorSearch = ''">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <input type="text" class="form-control filter-search mb-2"
                v-model="viewStates.paymentDashboard.filter.vendorSearch" :placeholder="t('searchVendors')">
              <div class="slicer-options"
                :class="{ 'slicer-options-expanded': viewStates.paymentDashboard.filter.expansion.vendor }">
                <button v-for="vendor in availableVendors" :key="vendor.id" class="btn slicer-btn"
                  :class="{ 'slicer-btn-selected': viewStates.paymentDashboard.filter.vendorId.includes(vendor.id) }"
                  @click="toggleFilter(viewStates.paymentDashboard.filter.vendorId, vendor.id)">
                  {{ vendor.name }}
                </button>
              </div>
            </div>

            <!-- 3. Nguồn thanh toán -->
            <div class="filter-group">
              <div class="filter-group-header">
                <h6
                  @click="viewStates.paymentDashboard.filter.expansion.paymentSource = !viewStates.paymentDashboard.filter.expansion.paymentSource">
                  <i class="fas fa-university me-2"></i><span>{{ t('paymentSource') }}</span>
                </h6>
                <button class="clear-filter-btn" @click="viewStates.paymentDashboard.filter.paymentSource = []">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <input type="text" class="form-control filter-search mb-2"
                v-model="viewStates.paymentDashboard.filter.paymentSourceSearch"
                :placeholder="t('searchPaymentSources')">
              <div class="slicer-options"
                :class="{ 'slicer-options-expanded': viewStates.paymentDashboard.filter.expansion.paymentSource }">
                <button v-for="source in availablePaymentSources" :key="source" class="btn slicer-btn"
                  :class="{ 'slicer-btn-selected': viewStates.paymentDashboard.filter.paymentSource.includes(source) }"
                  @click="toggleFilter(viewStates.paymentDashboard.filter.paymentSource, source)">
                  {{ source }}
                </button>
              </div>
            </div>

            <!-- 4. Khoảng thời gian -->
            <div class="filter-group">
              <div class="filter-group-header">
                <h6><i class="fas fa-calendar-alt me-2"></i>{{ t('dateRange') }}</h6>
                <button class="clear-filter-btn" @click="setDefaultDashboardDates">
                  <i class="fas fa-sync-alt"></i>
                </button>
              </div>
              <div class="p-2 bg-light rounded shadow-sm border">
                <div class="mb-2">
                  <label class="form-label small fw-bold text-secondary mb-1">{{ t('startDate') }}</label>
                  <input type="date" class="form-control form-control-sm"
                    v-model="viewStates.paymentDashboard.filter.startDate">
                </div>
                <div>
                  <label class="form-label small fw-bold text-secondary mb-1">{{ t('endDate') }}</label>
                  <input type="date" class="form-control form-control-sm"
                    v-model="viewStates.paymentDashboard.filter.endDate">
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <div class="table-controls">
        <div class="d-flex align-items-center gap-2">
          <label for="dashboardPerPageSelect" class="form-label mb-0 text-secondary">{{ t('showEntriesLabel') }}</label>
          <div class="year-nav-group">
            <button class="btn btn-sm btn-light border-0" @click="changePerPage(viewStates.paymentDashboard, -1)"
              :disabled="viewStates.paymentDashboard.perPage === 5">
              <i class="fas fa-chevron-left fa-xs"></i>
            </button>
            <div class="year-display" style="min-width: 40px">
              {{ viewStates.paymentDashboard.perPage }}
            </div>
            <button class="btn btn-sm btn-light border-0" @click="changePerPage(viewStates.paymentDashboard, 1)"
              :disabled="viewStates.paymentDashboard.perPage === 100">
              <i class="fas fa-chevron-right fa-xs"></i>
            </button>
          </div>
        </div>
        <div class="dropdown">
          <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fas fa-columns me-2"></i> {{ t('btnColumns')
            }}
          </button>
          <ul class="dropdown-menu dropdown-menu-end" data-bs-auto-close="outside">
            <li v-for="col in dashboardPaymentAvailableColumns" :key="col.key">
              <div class="custom-checkbox-container"
                @click="dashboardPaymentColumnVisibility[col.key] = !dashboardPaymentColumnVisibility[col.key]">
                <div class="custom-checkbox-icon" :class="{ 'checked': dashboardPaymentColumnVisibility[col.key] }">
                  <i class="fas fa-check"></i>
                </div>
                <span class="custom-checkbox-label">{{ col.label }}</span>
              </div>
            </li>
          </ul>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead>
                <tr>
                  <th class="text-center-custom no-sort" style="width: 50px">
                    #
                  </th>
                  <template v-for="col in dashboardPaymentAvailableColumns" :key="col.key">
                    <th v-if="dashboardPaymentColumnVisibility[col.key]"
                      :class="{'text-center-custom': ['cpcIdentifier', 'code', 'date', 'paymentDueDate'].includes(col.key), 'text-end-custom': ['originalAmount', 'amount'].includes(col.key)}"
                      @click="handleSort(viewStates.paymentDashboard, col.key)">
                      {{ col.label }}
                      <i v-if="viewStates.paymentDashboard.sortBy === col.key"
                        :class="viewStates.paymentDashboard.sortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'"
                        class="sort-icon"></i>
                    </th>
                  </template>
                  <th class="text-center-custom no-sort">
                    {{ t('tableHeaderAction') }}
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(payment, index) in formattedPaginatedPaymentsDashboard" :key="payment.id">
                  <td class="text-center-custom fw-bold">
                    {{ (viewStates.paymentDashboard.currentPage - 1)
                    * viewStates.paymentDashboard.perPage + index +
                    1 }}
                  </td>
                  <template v-for="col in dashboardPaymentAvailableColumns" :key="col.key">
                    <td v-if="dashboardPaymentColumnVisibility[col.key]" :class="[
                      {'text-center-custom': ['cpcIdentifier', 'code', 'date', 'paymentDueDate'].includes(col.key)},
                      {'text-end-custom': ['originalAmount', 'amount'].includes(col.key)},
                      {'fw-bold text-highlight-vendor': col.key === 'vendorName'},
                      {'fw-bold text-highlight-amount': col.key === 'originalAmount'},
                      {'fw-bold text-highlight-paid': col.key === 'amount' && payment.amount > 0}
                    ]">
                      <template v-if="col.key === 'originalAmount'">
                        {{ payment.originalAmountFormatted }}
                      </template>

                      <template v-else-if="col.key === 'amount'">
                        {{ payment.amountFormatted }}
                        <small v-if="payment.isSwapRow" class="d-block text-muted" style="
                                        font-size: 0.7rem;
                                        font-weight: normal;
                                      ">(SWAP Payment)</small>
                      </template>

                      <template v-else-if="col.key === 'contractNo'">
                        <a href="#" @click.prevent="goToContractDetailsFromDashboard(payment)" class="table-link">{{
                          payment.contractNo }}</a>
                      </template>

                      <template v-else-if="col.key === 'vendorName'">
                        {{ payment.vendorNameAbbr }}
                      </template>

                      <template v-else>{{ payment[col.key] }}</template>
                    </td>
                  </template>
                  <td class="text-center-custom">
                    <button class="btn table-action-btn text-warning" @click="editInstallment(payment)">
                      <i class="bi bi-pencil-square"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="pagination-wrapper no-print">
        <!-- Thông tin số lượng dòng (Bên trái) -->
        <div class="entries-info-text">
          <i class="fas fa-list-ol me-1"></i>
          {{ t('paginationInfo', {
          start: (viewStates.paymentDashboard.currentPage - 1) * viewStates.paymentDashboard.perPage + 1,
          end: Math.min(viewStates.paymentDashboard.currentPage * viewStates.paymentDashboard.perPage,
          filteredPaymentsDashboard.length),
          total: filteredPaymentsDashboard.length
          }) }}
        </div>

        <!-- Cụm điều khiển trang hình viên thuốc (Bên phải) -->
        <div class="modern-pagination-container">
          <!-- Nút Previous -->
          <button class="btn btn-pagination-modern" @click="viewStates.paymentDashboard.currentPage--"
            :disabled="viewStates.paymentDashboard.currentPage === 1">
            <i class="fas fa-arrow-left"></i>
            <span>{{ t('btnPrevious') }}</span>
          </button>

          <!-- Hiển thị Số trang Hiện tại / Tổng số trang -->
          <div class="page-info-pill">
            {{ viewStates.paymentDashboard.currentPage }} / {{ dashboardTotalPages }}
          </div>

          <!-- Nút Next -->
          <button class="btn btn-pagination-modern" @click="viewStates.paymentDashboard.currentPage++"
            :disabled="viewStates.paymentDashboard.currentPage >= dashboardTotalPages">
            <span>{{ t('btnNext') }}</span>
            <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>
    </div>
    <div v-if="currentTab === 'cpc-swap-dashboard'">
      <div class="overview-card no-print">
        <div class="overview-header-top">
          <div class="d-flex align-items-center">
            <div class="stat-icon-bg me-3" style="background: #f5f3ff; color: #7c3aed">
              <i class="fas fa-exchange-alt"></i>
            </div>
            <div class="overview-title">
              <h4>SWAP Financial Overview</h4>
              <span>Aggregated statistics for 3-way debt
                settlements</span>
            </div>
          </div>

          <div class="d-flex align-items-center gap-2">


            <div class="year-nav-group ms-2">
              <button class="btn btn-sm btn-light border-0" @click="changeSwapDashboardYear(-1)">
                <i class="fas fa-chevron-left fa-xs"></i>
              </button>
              <div class="year-display">
                {{ swapDashboardYear }}
              </div>
              <button class="btn btn-sm btn-light border-0" @click="changeSwapDashboardYear(1)">
                <i class="fas fa-chevron-right fa-xs"></i>
              </button>
            </div>
          </div>
        </div>

        <div class="stat-grid">
          <div class="stat-card card-usd">
            <div>
              <span class="label">Receivable SWAP</span>
              <h3 class="value">
                {{
                formatCurrency(swapDashboardStats.totalReceivable)
                }}
              </h3>
            </div>
            <div class="stat-icon-bg">
              <i class="fas fa-file-download"></i>
            </div>
          </div>

          <div class="stat-card card-swap">
            <div>
              <span class="label">Payable SWAP</span>
              <h3 class="value">
                {{ formatCurrency(swapDashboardStats.totalPayable)
                }}
              </h3>
            </div>
            <div class="stat-icon-bg">
              <i class="fas fa-file-upload"></i>
            </div>
          </div>

          <div class="stat-card card-vnd">
            <div>
              <span class="label">Total Settled</span>
              <h3 class="value">
                {{ formatCurrency(swapDashboardStats.totalSettled)
                }}
              </h3>
            </div>
            <div class="stat-icon-bg">
              <i class="fas fa-check-double"></i>
            </div>
          </div>

          <div class="stat-card card-trans">
            <div>
              <span class="label">Transactions</span>
              <h3 class="value">{{ swapDashboardStats.count }}</h3>
            </div>
            <div class="stat-icon-bg">
              <i class="fas fa-list-ul"></i>
            </div>
          </div>
        </div>
      </div>

      <div class="filter-wrapper no-print mb-4" :class="{ 'is-expanded': !viewStates.swapDashboard.isFilterCollapsed }">
        <!-- Thanh Header: Luôn hiển thị, chứa tóm tắt khi đóng -->
        <div class="filter-header-bar" @click="toggleFilterPanel(viewStates.swapDashboard)">
          <div class="d-flex align-items-center flex-grow-1">
            <i class="fas fa-filter text-primary me-2"></i>
            <span class="fw-bold me-3">{{ t('filterPanelTitle') }}</span>

            <!-- Hiển thị tóm tắt bộ lọc khi đóng (Đã fix lỗi double date) -->
            <span v-if="viewStates.swapDashboard.isFilterCollapsed" class="text-muted small text-truncate"
              style="max-width: 600px;">
              <i class="fas fa-info-circle me-1"></i>
              {{ activeFiltersSummary(viewStates.swapDashboard) }}
            </span>
          </div>

          <div class="d-flex align-items-center gap-2">
            <!-- Nút xóa nhanh tất cả bộ lọc -->
            <button v-if="activeFiltersSummary(viewStates.swapDashboard) !== t('noActiveFilters')"
              class="btn btn-sm btn-link text-danger p-0 me-2 text-decoration-none" @click.stop="clearAllFilters">
              <i class="fas fa-sync-alt me-1"></i> {{ t('btnClearAllFilters') }}
            </button>
            <i class="fas fa-chevron-down filter-toggle-icon text-secondary"></i>
          </div>
        </div>

        <!-- Nội dung bộ lọc khi mở rộng -->
        <div class="filter-expand-content">
          <div class="filter-grid">

            <!-- 1. Bộ lọc Dự án -->
            <div class="filter-group">
              <div class="filter-group-header">
                <h6
                  @click="viewStates.swapDashboard.filter.expansion.project = !viewStates.swapDashboard.filter.expansion.project">
                  <i class="fas fa-folder me-2"></i><span>{{ t('project') }}</span>
                </h6>
                <button class="clear-filter-btn"
                  @click="viewStates.swapDashboard.filter.projectId = []; viewStates.swapDashboard.filter.projectSearch = ''">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <input type="text" class="form-control filter-search mb-2"
                v-model="viewStates.swapDashboard.filter.projectSearch" :placeholder="t('searchProjects')">
              <div class="slicer-options"
                :class="{ 'slicer-options-expanded': viewStates.swapDashboard.filter.expansion.project }">
                <button v-for="p in availableSwapProjects" :key="p.id" class="btn slicer-btn"
                  :class="{ 'slicer-btn-selected': viewStates.swapDashboard.filter.projectId.includes(p.id) }"
                  @click="toggleFilter(viewStates.swapDashboard.filter.projectId, p.id)">
                  {{ p.name }}
                </button>
              </div>
            </div>

            <!-- 2. Bộ lọc Đối tác SWAP -->
            <div class="filter-group">
              <div class="filter-group-header">
                <h6
                  @click="viewStates.swapDashboard.filter.expansion.vendorSWAP = !viewStates.swapDashboard.filter.expansion.vendorSWAP">
                  <i class="fas fa-handshake me-2"></i><span>{{ t('vendorSWAP') }}</span>
                </h6>
                <button class="clear-filter-btn"
                  @click="viewStates.swapDashboard.filter.vendorSWAP = []; viewStates.swapDashboard.filter.vendorSWAPSearch = ''">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <input type="text" class="form-control filter-search mb-2"
                v-model="viewStates.swapDashboard.filter.vendorSWAPSearch" :placeholder="t('searchVendors')">
              <div class="slicer-options"
                :class="{ 'slicer-options-expanded': viewStates.swapDashboard.filter.expansion.vendorSWAP }">
                <button v-for="v in availableSwapVendorSWAPs" :key="v" class="btn slicer-btn"
                  :class="{ 'slicer-btn-selected': viewStates.swapDashboard.filter.vendorSWAP.includes(v) }"
                  @click="toggleFilter(viewStates.swapDashboard.filter.vendorSWAP, v)">
                  {{ v }}
                </button>
              </div>
            </div>

            <!-- 3. Khoảng thời gian (Thỏa thuận) -->
            <div class="filter-group">
              <div class="filter-group-header">
                <h6><i class="fas fa-calendar-alt me-2"></i>{{ t('dateRange') }}</h6>
                <button class="clear-filter-btn"
                  @click="viewStates.swapDashboard.filter.startDate = ''; viewStates.swapDashboard.filter.endDate = ''">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="p-2 bg-light rounded shadow-sm border">
                <div class="mb-2">
                  <label class="form-label small fw-bold text-secondary mb-1">Từ ngày</label>
                  <input type="date" class="form-control form-control-sm"
                    v-model="viewStates.swapDashboard.filter.startDate">
                </div>
                <div>
                  <label class="form-label small fw-bold text-secondary mb-1">Đến ngày</label>
                  <input type="date" class="form-control form-control-sm"
                    v-model="viewStates.swapDashboard.filter.endDate">
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <div class="table-controls">
        <div class="d-flex align-items-center gap-2">
          <label class="form-label mb-0 text-secondary small">{{ t('showEntriesLabel') }}</label>

          <div class="year-nav-group">
            <button class="btn btn-sm btn-light border-0" @click="changePerPage(viewStates.swapDashboard, -1)"
              :disabled="viewStates.swapDashboard.perPage <= 5">
              <i class="fas fa-chevron-left fa-xs"></i>
            </button>

            <div class="year-display" style="min-width: 45px">
              {{ viewStates.swapDashboard.perPage }}
            </div>

            <button class="btn btn-sm btn-light border-0" @click="changePerPage(viewStates.swapDashboard, 1)"
              :disabled="viewStates.swapDashboard.perPage >= 100">
              <i class="fas fa-chevron-right fa-xs"></i>
            </button>
          </div>
        </div>

        <div class="d-flex align-items-center gap-2">
          <button class="btn btn-outline-success d-flex align-items-center" @click="exportSwapDashboardToExcel">
            <i class="fas fa-file-export me-2"></i> {{
            t('btnExport') }}
          </button>

          <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle d-flex align-items-center" type="button"
              data-bs-toggle="dropdown" aria-expanded="false">
              <i class="fas fa-columns me-2"></i> {{ t('btnColumns')
              }}
            </button>
            <ul class="dropdown-menu dropdown-menu-end" data-bs-auto-close="outside">
              <li v-for="col in swapDashboardAvailableColumns" :key="col.key">
                <div class="custom-checkbox-container"
                  @click="swapDashboardColumnVisibility[col.key] = !swapDashboardColumnVisibility[col.key]">
                  <div class="custom-checkbox-icon" :class="{ 'checked': swapDashboardColumnVisibility[col.key] }">
                    <i class="fas fa-check"></i>
                  </div>
                  <span class="custom-checkbox-label">{{ col.label }}</span>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead>
                <tr>
                  <th style="width: 40px"></th>
                  <th style="width: 50px">#</th>
                  <template v-for="col in swapDashboardAvailableColumns" :key="col.key">
                    <th v-if="swapDashboardColumnVisibility[col.key]"
                      :class="{'text-center-custom': ['cpcIdentifier', 'date', 'swapDueDatePayment', 'latestSwapPaymentDate'].includes(col.key), 'text-end-custom': ['amount', 'totalSwapPaidAmount'].includes(col.key)}"
                      @click="handleSort(viewStates.swapDashboard, col.key)">
                      {{ col.label }}
                      <i v-if="viewStates.swapDashboard.sortBy === col.key"
                        :class="viewStates.swapDashboard.sortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'"
                        class="sort-icon"></i>
                    </th>
                  </template>
                  <th class="text-center-custom no-sort">
                    {{ t('tableHeaderAction') }}
                  </th>
                </tr>
              </thead>
              <tbody>
                <template v-for="(swap, index) in formattedPaginatedSwapsDashboard" :key="swap.id">
                  <tr>
                    <td>
                      <button class="btn btn-sm btn-outline-secondary border-0" @click="toggleSwapExpand(swap)"
                        v-if="swap.swapPayments && swap.swapPayments.length > 0">
                        <i class="fas fa-chevron-right rotate-icon" :class="{'open': swap.isExpanded}"></i>
                      </button>
                    </td>
                    <td class="text-center-custom fw-bold">
                      {{ (viewStates.swapDashboard.currentPage - 1)
                      * viewStates.swapDashboard.perPage + index + 1
                      }}
                    </td>

                    <template v-for="col in swapDashboardAvailableColumns" :key="col.key">
                      <td v-if="swapDashboardColumnVisibility[col.key]" :class="[
                        {'text-center-custom': ['cpcIdentifier', 'date', 'swapDueDatePayment', 'latestSwapPaymentDate'].includes(col.key)}, 
                        {'text-end-custom': ['amount', 'totalSwapPaidAmount'].includes(col.key)},
                        {'fw-bold text-highlight-vendor': col.key === 'vendorName'},
                        {'fw-bold text-highlight-amount': col.key === 'amount'},
                        {'fw-bold text-highlight-paid': col.key === 'totalSwapPaidAmount' && swap.totalSwapPaidAmount > 0}
                      ]">
                        <template v-if="col.key === 'amount'">{{ swap.amountFormatted }}</template>
                        <template v-else-if="col.key === 'totalSwapPaidAmount'">{{ swap.totalSwapPaidAmountFormatted
                          }}</template>
                        <template v-else-if="col.key === 'vendorName'">{{ swap.vendorNameAbbr }}</template>
                        <template v-else-if="col.key === 'status'">
                          <span :class="getSwapStatusInfo(swap).badgeClass">{{ getSwapStatusInfo(swap).statusText
                            }}</span>
                        </template>
                        <template v-else-if="col.key === 'contractNo'">
                          <a href="#" @click.prevent="goToContractDetailsFromDashboard(swap)" class="table-link">{{
                            swap.contractNo }}</a>
                        </template>
                        <template v-else>{{ swap[col.key] }}</template>
                      </td>
                    </template>

                    <td class="text-center-custom">
                      <button class="btn table-action-btn text-warning" @click="editSwap(swap)">
                        <i class="bi bi-pencil-square"></i>
                      </button>
                    </td>
                  </tr>

                  <template v-if="swap.isExpanded">
                    <tr v-for="(p, pIdx) in swap.swapPayments" :key="pIdx" class="sub-row bond-history-row">
                      <!-- Cột Chevron & STT: Để trống -->
                      <td></td>
                      <td class="text-center-custom"></td>

                      <template v-for="col in swapDashboardAvailableColumns" :key="col.key">
                        <td v-if="swapDashboardColumnVisibility[col.key]" :class="[
            {
              'text-center-custom': ['cpcIdentifier', 'date', 'swapDueDatePayment', 'latestSwapPaymentDate'].includes(col.key),
              'text-end-custom': ['amount', 'totalSwapPaidAmount'].includes(col.key)
            }
          ]">

                          <!-- Cột hiển thị Connector (Dấu nối cây) ở cột đầu tiên hiển thị -->
                          <template v-if="col.key === 'projectName'">
                            <div class="tree-connector-container" style="height: 20px;">
                              <div class="tree-connector-corner" style="margin-top: -10px; height: 20px;"></div>
                              <span class="text-muted" style="font-size: 0.7rem;">{{ t('installment_swap', { num: pIdx +
                                1, ordinal: getOrdinal(pIdx + 1) }) }}</span>

                            </div>
                          </template>

                          <!-- Căn lề số tiền thanh toán đợt SWAP vào cột 'totalSwapPaidAmount' (Số tiền đã trả SWAP) -->
                          <template v-else-if="col.key === 'totalSwapPaidAmount'">
                            <span class="fw-bold text-success">{{ formatCurrency(p.amount) }}</span>
                          </template>

                          <!-- Căn lề ngày thanh toán đợt SWAP vào cột 'latestSwapPaymentDate' (Ngày thanh toán SWAP) -->
                          <template v-else-if="col.key === 'latestSwapPaymentDate'">
                            <div class="d-flex align-items-center justify-content-center gap-1">

                              <span>{{ p.date }}</span>
                            </div>
                          </template>

                          <!-- Căn lề nguồn tiền (Source) vào cột 'swapProduct' hoặc 'swapInformation' nếu muốn -->
                          <template v-else-if="col.key === 'swapInformation'">
                            <span class="text-muted small"><i class="fas fa-university me-1"></i> {{ p.source }}</span>
                          </template>

                          <!-- Các cột còn lại để trống để giữ alignment -->
                          <template v-else></template>
                        </td>
                      </template>

                      <!-- Cột Action: Để trống -->
                      <td></td>
                    </tr>
                  </template>

                </template>
                <tr v-if="filteredSwapsDashboard.length === 0">
                  <td :colspan="20" class="text-center text-muted py-5">
                    {{ t('noMatchingData') }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="pagination-wrapper no-print">
        <!-- Thông tin số lượng dòng (Bên trái) -->
        <div class="entries-info-text">
          <i class="fas fa-list-ol me-1"></i>
          {{ t('paginationInfo', {
          start: (viewStates.swapDashboard.currentPage - 1) * viewStates.swapDashboard.perPage + 1,
          end: Math.min(viewStates.swapDashboard.currentPage * viewStates.swapDashboard.perPage,
          filteredSwapsDashboard.length),
          total: filteredSwapsDashboard.length
          }) }}
        </div>

        <!-- Cụm điều khiển trang hình viên thuốc (Bên phải) -->
        <div class="modern-pagination-container">
          <!-- Nút Previous -->
          <button class="btn btn-pagination-modern" @click="viewStates.swapDashboard.currentPage--"
            :disabled="viewStates.swapDashboard.currentPage === 1">
            <i class="fas fa-arrow-left"></i>
            <span>{{ t('btnPrevious') }}</span>
          </button>

          <!-- Hiển thị Số trang Hiện tại / Tổng số trang -->
          <div class="page-info-pill">
            {{ viewStates.swapDashboard.currentPage }} / {{ swapDashboardTotalPages }}
          </div>

          <!-- Nút Next -->
          <button class="btn btn-pagination-modern" @click="viewStates.swapDashboard.currentPage++"
            :disabled="viewStates.swapDashboard.currentPage >= swapDashboardTotalPages">
            <span>{{ t('btnNext') }}</span>
            <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>
    </div>

    <div v-if="currentTab === 'cpc-bond-dashboard'">
      <!-- 1. TOOLBAR HÀNH ĐỘNG (ACTION BAR) -->
      <div class="master-data-toolbar no-print">
        <!-- Nhóm Khởi tạo -->
        <div class="toolbar-group">
          <div>
            <span class="toolbar-label">{{ t('btnAdd') }}</span>
            <button class="btn btn-primary px-3 shadow-sm" @click="openBondModal('add')">
              <i class="fas fa-shield-alt me-2"></i>{{ t('btnAddBond') }}
            </button>
          </div>
        </div>

        <!-- Nhóm Thao tác Dữ liệu Excel -->
        <div class="toolbar-group ms-auto">
          <div>
            <span class="toolbar-label text-center">{{ t('btnData') }}</span>
            <div class="btn-group shadow-sm">
              <button class="btn btn-soft-primary" @click="downloadBondTemplate" :title="t('btnTemplate')">
                <i class="fas fa-file-download text-primary me-2"></i>{{ t('btnTemplate') }}
              </button>
              <button class="btn btn-soft-success" @click="triggerBondFileUpload" :title="t('btnUploadBonds')">
                <i class="fas fa-file-upload text-success me-2"></i>{{ t('btnUpload') }}
              </button>
              <button class="btn btn-soft-info" @click="exportBondsToExcel" :title="t('btnExportBonds')">
                <i class="fas fa-file-export text-info me-2"></i>{{ t('btnExport') }}
              </button>
            </div>
          </div>
        </div>

        <!-- Nhóm Bảo trì Hệ thống -->
        <div class="toolbar-group ms-3">
          <div>
            <span class="toolbar-label text-center">Bảo trì</span>
            <button class="btn btn-soft-warning px-3 shadow-sm" @click="clearFilteredBonds"
              :title="t('btnClearVisibleBonds')">
              <i class="fas fa-eraser me-2"></i>{{ t('btnClearVisibleBonds') }}
            </button>
          </div>
        </div>

        <!-- Spacer -->
        <div class="search-input-group ms-3 opacity-0 pe-none" style="min-width: 50px;"></div>
      </div>

      <!-- 2. BỘ LỌC TÍCH HỢP (FILTER WRAPPER) -->
      <div class="filter-wrapper no-print mb-4" :class="{ 'is-expanded': !viewStates.bondDashboard.isFilterCollapsed }">
        <div class="filter-header-bar" @click="toggleFilterPanel(viewStates.bondDashboard)">
          <div class="d-flex align-items-center flex-grow-1">
            <i class="fas fa-filter text-primary me-2"></i>
            <span class="fw-bold me-3">{{ t('filterPanelTitle') }}</span>
            <span v-if="viewStates.bondDashboard.isFilterCollapsed" class="text-muted small text-truncate"
              style="max-width: 600px;">
              <i class="fas fa-info-circle me-1"></i>
              {{ activeFiltersSummary(viewStates.bondDashboard) }}
            </span>
          </div>
          <div class="d-flex align-items-center gap-2">
            <button v-if="activeFiltersSummary(viewStates.bondDashboard) !== t('noActiveFilters')"
              class="btn btn-sm btn-link text-danger p-0 me-2 text-decoration-none" @click.stop="clearAllFilters">
              <i class="fas fa-sync-alt me-1"></i> {{ t('btnClearAllFilters') }}
            </button>
            <i class="fas fa-chevron-down filter-toggle-icon text-secondary"></i>
          </div>
        </div>

        <div class="filter-expand-content">
          <div class="filter-grid" style="grid-template-columns: repeat(5, 1fr);">
            <!-- Cột 1: Project Filter -->
            <div class="filter-group">
              <div class="filter-group-header">
                <h6
                  @click="viewStates.bondDashboard.filter.expansion.project = !viewStates.bondDashboard.filter.expansion.project">
                  <i class="fas fa-folder me-2"></i><span>{{ t('project') }}</span>
                </h6>
                <button class="clear-filter-btn" @click="viewStates.bondDashboard.filter.projectId = []"><i
                    class="fas fa-times"></i></button>
              </div>
              <input type="text" class="form-control filter-search mb-2"
                v-model="viewStates.bondDashboard.filter.projectSearch" :placeholder="t('searchProjects')">
              <div class="slicer-options"
                :class="{ 'slicer-options-expanded': viewStates.bondDashboard.filter.expansion.project }">
                <button v-for="project in filteredAvailableBondProjects" :key="project.id" class="btn slicer-btn"
                  :class="{ 'slicer-btn-selected': viewStates.bondDashboard.filter.projectId.includes(project.id) }"
                  @click="toggleFilter(viewStates.bondDashboard.filter.projectId, project.id)">
                  {{ project.name }}
                </button>
              </div>
            </div>

            <!-- Cột 2: Vendor Filter -->
            <div class="filter-group">
              <div class="filter-group-header">
                <h6
                  @click="viewStates.bondDashboard.filter.expansion.vendor = !viewStates.bondDashboard.filter.expansion.vendor">
                  <i class="fas fa-truck-fast me-2"></i><span>{{ t('vendor') }}</span>
                </h6>
                <button class="clear-filter-btn" @click="viewStates.bondDashboard.filter.vendorId = []"><i
                    class="fas fa-times"></i></button>
              </div>
              <input type="text" class="form-control filter-search mb-2"
                v-model="viewStates.bondDashboard.filter.vendorSearch" :placeholder="t('searchVendors')">
              <div class="slicer-options"
                :class="{ 'slicer-options-expanded': viewStates.bondDashboard.filter.expansion.vendor }">
                <button v-for="vendor in filteredAvailableBondVendors" :key="vendor.id" class="btn slicer-btn"
                  :class="{ 'slicer-btn-selected': viewStates.bondDashboard.filter.vendorId.includes(vendor.id) }"
                  @click="toggleFilter(viewStates.bondDashboard.filter.vendorId, vendor.id)">
                  {{ vendor.name }}
                </button>
              </div>
            </div>

            <!-- Cột 3: Contract Filter -->
            <div class="filter-group">
              <div class="filter-group-header">
                <h6
                  @click="viewStates.bondDashboard.filter.expansion.contract = !viewStates.bondDashboard.filter.expansion.contract">
                  <i class="fas fa-file-signature me-2"></i><span>{{ t('contract') }}</span>
                </h6>
                <button class="clear-filter-btn" @click="viewStates.bondDashboard.filter.contractId = []"><i
                    class="fas fa-times"></i></button>
              </div>
              <input type="text" class="form-control filter-search mb-2"
                v-model="viewStates.bondDashboard.filter.contractNoSearch" :placeholder="t('searchContracts')">
              <div class="slicer-options"
                :class="{ 'slicer-options-expanded': viewStates.bondDashboard.filter.expansion.contract }">
                <button v-for="contract in filteredAvailableBondContracts" :key="contract.id" class="btn slicer-btn"
                  :class="{ 'slicer-btn-selected': viewStates.bondDashboard.filter.contractId.includes(contract.id) }"
                  @click="toggleFilter(viewStates.bondDashboard.filter.contractId, contract.id)">
                  {{ contract.contractNo }}
                </button>
              </div>
            </div>

            <!-- Cột 4: Trạng thái (ĐÃ TÁCH) -->
            <div class="filter-group">
              <div class="filter-group-header">
                <h6><i class="fas fa-tasks me-2"></i><span>Trạng thái</span></h6>
                <button class="clear-filter-btn" @click="viewStates.bondDashboard.filter.status = []"><i
                    class="fas fa-times"></i></button>
              </div>
              <div class="slicer-options slicer-options-expanded">
                <button v-for="status in ['Active', 'Expiring Soon', 'Overdue', 'Settled']" :key="status"
                  class="btn slicer-btn mb-1"
                  :class="{ 'slicer-btn-selected': viewStates.bondDashboard.filter.status.includes(status) }"
                  @click="toggleFilter(viewStates.bondDashboard.filter.status, status)">
                  {{ status === 'Settled' ? t('bondSettled') : status }}
                </button>
              </div>
            </div>

            <!-- Cột 5: Loại bảo lãnh (ĐÃ TÁCH) -->
            <div class="filter-group">
              <div class="filter-group-header">
                <h6
                  @click="viewStates.bondDashboard.filter.expansion.bondType = !viewStates.bondDashboard.filter.expansion.bondType">
                  <i class="fas fa-shield-alt me-2"></i><span>Loại bảo lãnh</span>
                </h6>
                <button class="clear-filter-btn" @click="viewStates.bondDashboard.filter.bondType = []"><i
                    class="fas fa-times"></i></button>
              </div>
              <div class="slicer-options slicer-options-expanded">
                <button v-for="type in filteredAvailableBondTypes" :key="type" class="btn slicer-btn mb-1"
                  :class="{ 'slicer-btn-selected': viewStates.bondDashboard.filter.bondType.includes(type) }"
                  @click="toggleFilter(viewStates.bondDashboard.filter.bondType, type)">
                  {{ type }}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 3. ĐIỀU KHIỂN BẢNG (TABLE CONTROLS) -->
      <div class="table-controls mb-3">
        <div class="d-flex align-items-center gap-2">
          <label class="form-label mb-0 text-secondary small">{{ t('showEntriesLabel') }}</label>
          <div class="year-nav-group">
            <button class="btn btn-sm btn-light border-0" @click="changePerPage(viewStates.bondDashboard, -1)"
              :disabled="viewStates.bondDashboard.perPage <= 5">
              <i class="fas fa-chevron-left fa-xs"></i>
            </button>
            <div class="year-display" style="min-width: 40px">{{ viewStates.bondDashboard.perPage }}</div>
            <button class="btn btn-sm btn-light border-0" @click="changePerPage(viewStates.bondDashboard, 1)"
              :disabled="viewStates.bondDashboard.perPage >= 100">
              <i class="fas fa-chevron-right fa-xs"></i>
            </button>
          </div>
        </div>

        <div class="dropdown ms-auto">
          <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fas fa-columns me-2"></i> {{ t('btnColumns') }}
          </button>
          <ul class="dropdown-menu dropdown-menu-end p-2" style="max-height: 400px; overflow-y: auto; min-width: 250px;"
            data-bs-auto-close="outside">
            <li v-for="col in dashboardBondAvailableColumns" :key="col.key" class="mb-1">
              <div class="custom-checkbox-container py-1 px-2 rounded hover-bg-light"
                @click="dashboardBondColumnVisibility[col.key] = !dashboardBondColumnVisibility[col.key]">
                <div class="custom-checkbox-icon" :class="{ 'checked': dashboardBondColumnVisibility[col.key] }">
                  <i class="fas fa-check"></i>
                </div>
                <span class="small fw-medium">{{ col.label }}</span>
              </div>
            </li>
          </ul>
        </div>
      </div>

      <!-- 4. BẢNG DỮ LIỆU BẢO LÃNH -->
      <div class="card">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="bg-light">
                <tr>
                  <th style="width: 40px"></th>
                  <th class="text-center-custom" style="width: 50px">#</th>
                  <template v-for="col in dashboardBondAvailableColumns" :key="col.key">
                    <th v-if="dashboardBondColumnVisibility[col.key]" class="text-center-custom"
                      @click="handleSort(viewStates.bondDashboard, col.key)">
                      {{ col.label }}
                      <i v-if="viewStates.bondDashboard.sortBy === col.key"
                        :class="viewStates.bondDashboard.sortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'"
                        class="sort-icon"></i>
                    </th>
                  </template>
                  <th class="text-center-custom no-sort" style="width: 120px">{{ t('tableHeaderAction') }}</th>
                </tr>
              </thead>

              <tbody>
                <template v-if="paginatedGroupedBonds.length > 0">
                  <template v-for="(group, index) in paginatedGroupedBonds" :key="group.latestBond.id">
                    <!-- DÒNG CHÍNH: Không chứa đường nối -->
                    <tr class="bond-main-row" :class="getBondRowClass(group.latestBond)">
                      <td class="text-center">
                        <button v-if="group.history.length > 0"
                          class="btn btn-sm btn-link p-0 text-decoration-none border-0"
                          @click="toggleBondGroupExpand(group)">
                          <i class="fas fa-chevron-right rotate-icon" :class="{ 'open': group.isExpanded }"></i>
                        </button>
                      </td>
                      <td class="text-center-custom fw-bold text-muted">
                        {{ (viewStates.bondDashboard.currentPage - 1) * viewStates.bondDashboard.perPage + index + 1 }}
                      </td>

                      <template v-for="col in dashboardBondAvailableColumns" :key="col.key">
                        <td v-if="dashboardBondColumnVisibility[col.key]"
                          :class="{'text-center-custom': ['issueDate', 'expiryDate', 'issuingBankName', 'status', 'isSettled'].includes(col.key), 'text-end-custom': ['amount'].includes(col.key)}">

                          <!-- Cột Hợp đồng (Dòng chính) -->
                          <template v-if="col.key === 'contractNo'">
                            <a href="#" @click.prevent="goToContractDetailsFromDashboard(group.latestBond)"
                              class="table-link fw-bold">
                              {{ group.latestBond.contractNo }}
                            </a>
                          </template>

                          <!-- Các cột khác giữ nguyên logic cũ -->
                          <template v-else-if="col.key === 'bondType'">
                            <span :class="getBondTypeColorClass(group.latestBond.bondType)">{{ group.latestBond.bondType
                              }}</span>
                            <span v-if="group.history.length > 0"
                              class="badge bg-light text-secondary border ms-2 rounded-pill"
                              style="font-size: 0.7em">+{{ group.history.length }}</span>
                          </template>
                          <template v-else-if="col.key === 'quickSettle'">
                            <div class="form-check form-switch table-form-switch">
                              <input class="form-check-input" type="checkbox" role="switch"
                                :checked="group.latestBond.isSettled" :disabled="group.latestBond.isRenewed"
                                @change="promptQuickSettle(group.latestBond, $event)" />
                            </div>
                          </template>
                          <template v-else-if="col.key === 'amount'"><span class="fw-bold text-dark">{{
                              group.latestBond.amountFormatted }}</span></template>
                          <template v-else-if="col.key === 'status'"><span
                              :class="getBondStatusClassForDashboard(group.latestBond).badgeClass">{{
                              getBondStatusClassForDashboard(group.latestBond).message }}</span></template>
                          <template v-else-if="col.key === 'vendorName'"><span
                              class="text-highlight-vendor fw-medium">{{ group.latestBond.vendorNameAbbr
                              }}</span></template>
                          <template v-else>{{ group.latestBond[col.key] }}</template>
                        </td>
                      </template>
                      <td class="text-center-custom">
                        <div class="d-flex justify-content-center gap-1">
                          <!-- Nút Sửa -->
                          <button class="btn table-action-btn text-warning" @click="editBond(group.latestBond)"
                            :title="t('btnEdit')">
                            <i class="fas fa-edit"></i>
                          </button>

                          <!-- Nút Gia hạn (Đã fix để đồng bộ với Edit/Delete) -->
                          <button class="btn table-action-btn text-primary"
                            @click="openRenewBondModal(group.latestBond)" :title="t('btnRenew')">
                            <i class="fas fa-redo"></i>
                          </button>

                          <!-- Nút Xóa -->
                          <button class="btn table-action-btn text-danger" @click="deleteBond(group.latestBond)"
                            :title="t('btnDelete')">
                            <i class="fas fa-trash"></i>
                          </button>
                        </div>
                      </td>
                    </tr>

                    <!-- DÒNG PHỤ (LỊCH SỬ): Chứa đường nối cây -->
                    <template v-if="group.isExpanded && group.history.length > 0">
                      <tr v-for="(oldBond, hIdx) in group.history" :key="oldBond.id" class="bond-history-row">
                        <td></td> <!-- Cột Chevron trống -->
                        <td></td> <!-- Cột STT trống -->

                        <template v-for="(col, colIdx) in dashboardBondAvailableColumns" :key="'hist-' + col.key">
                          <td v-if="dashboardBondColumnVisibility[col.key]"
                            :class="{'text-center-custom': ['issueDate', 'expiryDate', 'issuingBankName', 'status'].includes(col.key), 'text-end-custom': ['amount'].includes(col.key)}">

                            <!-- 1. HIỂN THỊ ĐƯỜNG NỐI VÀ BADGE LỊCH SỬ TẠI CỘT HỢP ĐỒNG -->
                            <template v-if="col.key === 'contractNo'">
                              <div class="tree-connector-container">
                                <div class="tree-connector-corner"></div>
                                <span class="badge badge-history">
                                  <i class="fas fa-history me-1"></i>
                                  {{ t('historyRecord') }} {{ group.history.length - hIdx }}
                                </span>
                              </div>
                            </template>

                            <!-- 2. HIỂN THỊ DỮ LIỆU CỦA BẢN GỐC (Bản cũ) -->
                            <template v-else-if="col.key === 'bondNumber'">
                              <span class="text-old-bond text-muted">{{ oldBond.bondNumber }}</span>
                            </template>

                            <template v-else-if="col.key === 'status'">
                              <span class="badge badge-history">
                                {{ oldBond.isRenewed ? t('renewedStatus') : t('settledStatus') }}
                              </span>
                            </template>

                            <template v-else-if="col.key === 'bondType'">
                              <span :class="getBondTypeColorClass(oldBond.bondType)" style="opacity: 0.6">
                                {{ oldBond.bondType }}
                              </span>
                            </template>

                            <template v-else-if="col.key === 'amount'">
                              <span class="text-muted small">{{ oldBond.amountFormatted }}</span>
                            </template>

                            <!-- Ẩn các cột không cần thiết ở dòng lịch sử để tránh rối (Dự án, Nhà thầu, Quick Settle) -->
                            <template v-else-if="!['projectName', 'vendorName', 'quickSettle'].includes(col.key)">
                              <span class="text-muted small">{{ oldBond[col.key] }}</span>
                            </template>
                          </td>
                        </template>

                        <td class="text-center-custom">
                          <!-- Nút xem lại bản ghi cũ (chế độ chỉ đọc) -->
                          <button class="btn btn-sm btn-link text-muted p-0" @click="editBond(oldBond)">
                            <i class="fas fa-eye"></i>
                          </button>
                        </td>
                      </tr>
                    </template>
                  </template>
                </template>
                <template v-else>
                  <tr>
                    <td :colspan="20" class="text-center text-muted py-5">{{ t('noBondData') }}</td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- 5. PHÂN TRANG -->
      <div class="pagination-wrapper no-print">
        <!-- Thông tin số lượng dòng (Bên trái) -->
        <div class="entries-info-text">
          <i class="fas fa-list-ol me-1"></i>
          {{ t('paginationInfo', {
          start: (viewStates.bondDashboard.currentPage - 1) * viewStates.bondDashboard.perPage + 1,
          end: Math.min(viewStates.bondDashboard.currentPage * viewStates.bondDashboard.perPage,
          groupedBondsDashboard.length),
          total: groupedBondsDashboard.length
          }) }}
        </div>

        <!-- Cụm điều khiển trang hình viên thuốc (Bên phải) -->
        <div class="modern-pagination-container">
          <!-- Nút Previous -->
          <button class="btn btn-pagination-modern" @click="viewStates.bondDashboard.currentPage--"
            :disabled="viewStates.bondDashboard.currentPage === 1">
            <i class="fas fa-arrow-left"></i>
            <span>{{ t('btnPrevious') }}</span>
          </button>

          <!-- Hiển thị Số trang Hiện tại / Tổng số trang -->
          <div class="page-info-pill">
            {{ viewStates.bondDashboard.currentPage }} / {{ groupedBondDashboardTotalPages }}
          </div>

          <!-- Nút Next -->
          <button class="btn btn-pagination-modern" @click="viewStates.bondDashboard.currentPage++"
            :disabled="viewStates.bondDashboard.currentPage >= groupedBondDashboardTotalPages">
            <span>{{ t('btnNext') }}</span>
            <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>

      <input type="file" ref="uploadBondExcelInput" @change="handleBondFileUpload" accept=".xlsx, .xls"
        style="display: none" />
    </div>

    <div v-if="currentTab === 'cpc-contract-dashboard'">
      <!-- 1. TOOLBAR HÀNH ĐỘNG (ACTION BAR) -->
      <div class="master-data-toolbar no-print">
        <!-- Nhóm Khởi tạo -->
        <div class="toolbar-group">
          <div>
            <span class="toolbar-label">{{ t('btnAdd') }}</span>
            <button class="btn btn-primary px-3 shadow-sm" @click="addNewContractItem">
              <i class="fas fa-file-signature me-2"></i>{{ t('btnAddContract') }}
            </button>
          </div>
        </div>

        <!-- Nhóm Dữ liệu Excel -->
        <div class="toolbar-group ms-auto">
          <div>
            <span class="toolbar-label text-center">{{ t('btnData') }}</span>
            <div class="btn-group shadow-sm">
              <button class="btn btn-soft-primary" @click="downloadContractTemplate" :title="t('btnTemplate')">
                <i class="fas fa-file-download text-primary me-2"></i>{{ t('btnTemplate') }}
              </button>
              <button class="btn btn-soft-success" @click="triggerContractFileUpload" :title="t('btnUploadContracts')">
                <i class="fas fa-file-upload text-success me-2"></i>{{ t('btnUpload') }}
              </button>
              <button class="btn btn-soft-info" @click="exportContractDashboardToExcel" :title="t('btnExport')">
                <i class="fas fa-file-export text-info me-2"></i>{{ t('btnExport') }}
              </button>
            </div>
          </div>
        </div>

        <!-- Nhóm Bảo trì -->
        <div class="toolbar-group ms-3">
          <div>
            <span class="toolbar-label text-center">Bảo trì</span>
            <button class="btn btn-soft-warning px-3 shadow-sm" @click="clearFilteredContracts"
              :title="t('btnClearVisibleContracts')">
              <i class="fas fa-eraser me-2"></i>{{ t('btnClearVisibleContracts') }}
            </button>
          </div>
        </div>

        <!-- Spacer cho cân đối layout -->
        <div class="search-input-group ms-3 opacity-0 pe-none" style="min-width: 50px;"></div>
      </div>

      <!-- 2. BỘ LỌC TÍCH HỢP (FILTER WRAPPER) -->
      <div class="filter-wrapper no-print mb-4"
        :class="{ 'is-expanded': !viewStates.contractDashboard.isFilterCollapsed }">
        <div class="filter-header-bar" @click="toggleFilterPanel(viewStates.contractDashboard)">
          <div class="d-flex align-items-center flex-grow-1">
            <i class="fas fa-filter text-primary me-2"></i>
            <span class="fw-bold me-3">{{ t('filterPanelTitle') }}</span>
            <span v-if="viewStates.contractDashboard.isFilterCollapsed" class="text-muted small text-truncate"
              style="max-width: 600px;">
              <i class="fas fa-info-circle me-1"></i>
              {{ activeFiltersSummary(viewStates.contractDashboard) }}
            </span>
          </div>
          <div class="d-flex align-items-center gap-2">
            <button v-if="activeFiltersSummary(viewStates.contractDashboard) !== t('noActiveFilters')"
              class="btn btn-sm btn-link text-danger p-0 me-2 text-decoration-none" @click.stop="clearAllFilters">
              <i class="fas fa-sync-alt me-1"></i> {{ t('btnClearAllFilters') }}
            </button>
            <i class="fas fa-chevron-down filter-toggle-icon text-secondary"></i>
          </div>
        </div>

        <div class="filter-expand-content">
          <div class="filter-grid">
            <!-- Project Filter -->
            <div class="filter-group">
              <div class="filter-group-header">
                <h6
                  @click="viewStates.contractDashboard.filter.expansion.project = !viewStates.contractDashboard.filter.expansion.project">
                  <i class="fas fa-folder me-2"></i><span>{{ t('project') }}</span>
                </h6>
                <button class="clear-filter-btn" @click="viewStates.contractDashboard.filter.projectId = []"><i
                    class="fas fa-times"></i></button>
              </div>
              <input type="text" class="form-control filter-search mb-2"
                v-model="viewStates.contractDashboard.filter.projectSearch" :placeholder="t('searchProjects')">
              <div class="slicer-options"
                :class="{ 'slicer-options-expanded': viewStates.contractDashboard.filter.expansion.project }">
                <button v-for="project in filteredAvailableContractProjects" :key="project.id" class="btn slicer-btn"
                  :class="{ 'slicer-btn-selected': viewStates.contractDashboard.filter.projectId.includes(project.id) }"
                  @click="toggleFilter(viewStates.contractDashboard.filter.projectId, project.id)">
                  {{ project.name }}
                </button>
              </div>
            </div>

            <!-- Vendor Filter -->
            <div class="filter-group">
              <div class="filter-group-header">
                <h6
                  @click="viewStates.contractDashboard.filter.expansion.vendor = !viewStates.contractDashboard.filter.expansion.vendor">
                  <i class="fas fa-truck-fast me-2"></i><span>{{ t('vendor') }}</span>
                </h6>
                <button class="clear-filter-btn" @click="viewStates.contractDashboard.filter.vendorId = []"><i
                    class="fas fa-times"></i></button>
              </div>
              <input type="text" class="form-control filter-search mb-2"
                v-model="viewStates.contractDashboard.filter.vendorSearch" :placeholder="t('searchVendors')">
              <div class="slicer-options"
                :class="{ 'slicer-options-expanded': viewStates.contractDashboard.filter.expansion.vendor }">
                <button v-for="vendor in filteredAvailableContractVendors" :key="vendor.id" class="btn slicer-btn"
                  :class="{ 'slicer-btn-selected': viewStates.contractDashboard.filter.vendorId.includes(vendor.id) }"
                  @click="toggleFilter(viewStates.contractDashboard.filter.vendorId, vendor.id)">
                  {{ vendor.name }}
                </button>
              </div>
            </div>

            <!-- Contract Filter -->
            <div class="filter-group">
              <div class="filter-group-header">
                <h6
                  @click="viewStates.contractDashboard.filter.expansion.contract = !viewStates.contractDashboard.filter.expansion.contract">
                  <i class="fas fa-file-signature me-2"></i><span>{{ t('contract') }}</span>
                </h6>
                <button class="clear-filter-btn" @click="viewStates.contractDashboard.filter.contractId = []"><i
                    class="fas fa-times"></i></button>
              </div>
              <input type="text" class="form-control filter-search mb-2"
                v-model="viewStates.contractDashboard.filter.contractNoSearch" :placeholder="t('searchContracts')">
              <div class="slicer-options"
                :class="{ 'slicer-options-expanded': viewStates.contractDashboard.filter.expansion.contract }">
                <button v-for="contract in filteredAvailableContractContracts" :key="contract.id" class="btn slicer-btn"
                  :class="{ 'slicer-btn-selected': viewStates.contractDashboard.filter.contractId.includes(contract.id) }"
                  @click="toggleFilter(viewStates.contractDashboard.filter.contractId, contract.id)">
                  {{ contract.contractNo }}
                </button>
              </div>
            </div>

            <!-- Code Filter -->
            <div class="filter-group">
              <div class="filter-group-header">
                <h6
                  @click="viewStates.contractDashboard.filter.expansion.code = !viewStates.contractDashboard.filter.expansion.code">
                  <i class="fas fa-hashtag me-2"></i><span>{{ t('code') }}</span>
                </h6>
                <button class="clear-filter-btn" @click="viewStates.contractDashboard.filter.code = []"><i
                    class="fas fa-times"></i></button>
              </div>
              <input type="text" class="form-control filter-search mb-2"
                v-model="viewStates.contractDashboard.filter.codeSearch" :placeholder="t('searchCodes')">
              <div class="slicer-options"
                :class="{ 'slicer-options-expanded': viewStates.contractDashboard.filter.expansion.code }">
                <button v-for="code in filteredAvailableContractCodes" :key="code" class="btn slicer-btn"
                  :class="{ 'slicer-btn-selected': viewStates.contractDashboard.filter.code.includes(code) }"
                  @click="toggleFilter(viewStates.contractDashboard.filter.code, code)">
                  {{ code }}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 3. ĐIỀU KHIỂN BẢNG (TABLE CONTROLS) -->
      <div class="table-controls mb-3">
        <div class="d-flex align-items-center gap-2">
          <label class="form-label mb-0 text-secondary small">{{ t('showEntriesLabel') }}</label>
          <div class="year-nav-group">
            <button class="btn btn-sm btn-light border-0" @click="changePerPage(viewStates.contractDashboard, -1)"
              :disabled="viewStates.contractDashboard.perPage <= 5">
              <i class="fas fa-chevron-left fa-xs"></i>
            </button>
            <div class="year-display" style="min-width: 45px">{{ viewStates.contractDashboard.perPage }}</div>
            <button class="btn btn-sm btn-light border-0" @click="changePerPage(viewStates.contractDashboard, 1)"
              :disabled="viewStates.contractDashboard.perPage >= 100">
              <i class="fas fa-chevron-right fa-xs"></i>
            </button>
          </div>
        </div>

        <div class="dropdown ms-auto">
          <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fas fa-columns me-2"></i> {{ t('btnColumns') }}
          </button>
          <ul class="dropdown-menu dropdown-menu-end p-2" style="max-height: 400px; overflow-y: auto; min-width: 250px;"
            data-bs-auto-close="outside">
            <li v-for="col in contractDashboardAvailableColumns" :key="col.key" class="mb-1">
              <div class="custom-checkbox-container py-1 px-2 rounded hover-bg-light"
                @click="contractDashboardColumnVisibility[col.key] = !contractDashboardColumnVisibility[col.key]">
                <div class="custom-checkbox-icon" :class="{ 'checked': contractDashboardColumnVisibility[col.key] }">
                  <i class="fas fa-check"></i>
                </div>
                <span class="small fw-medium">{{ col.label }}</span>
              </div>
            </li>
          </ul>
        </div>
      </div>

      <!-- 4. BẢNG DỮ LIỆU CHÍNH -->
      <div class="card">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="bg-light">
                <tr>
                  <th class="text-center-custom no-sort" style="width: 50px">#</th>
                  <template v-for="col in contractDashboardAvailableColumns" :key="col.key">
                    <th v-if="contractDashboardColumnVisibility[col.key]" class="text-center-custom"
                      @click="handleSort(viewStates.contractDashboard, col.key)">
                      {{ col.label }}
                      <i v-if="viewStates.contractDashboard.sortBy === col.key"
                        :class="viewStates.contractDashboard.sortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'"
                        class="sort-icon"></i>
                    </th>
                  </template>
                  <th class="text-center-custom no-sort" style="width: 100px">{{ t('tableHeaderAction') }}</th>
                </tr>
              </thead>
              <tbody>
                <template v-if="formattedPaginatedContractDashboardData.length > 0">
                  <tr v-for="(item, index) in formattedPaginatedContractDashboardData" :key="item.id">
                    <td class="text-center-custom fw-bold text-muted">{{ (viewStates.contractDashboard.currentPage - 1)
                      * viewStates.contractDashboard.perPage + index + 1 }}</td>
                    <template v-for="col in contractDashboardAvailableColumns" :key="col.key">
                      <td v-if="contractDashboardColumnVisibility[col.key]"
                        :class="{'text-end-custom': ['paidAmountExclVAT', 'paidVatAmount', 'paidAmountInclVAT', 'invoiceAmountTotal', 'invoiceVatTotal', 'invoiceGrandTotal', 'contractAmountTotal', 'vonTotal', 'contractVatTotal', 'contractGrandTotal'].includes(col.key), 'text-center-custom': ['code', 'department', 'contractSystemNo', 'vendorNo', 'date', 'glAccount', 'currency'].includes(col.key)}">
                        <template
                          v-if="['paidAmountExclVAT', 'paidVatAmount', 'paidAmountInclVAT', 'invoiceAmountTotal', 'invoiceVatTotal', 'invoiceGrandTotal', 'contractAmountTotal', 'vonTotal', 'contractVatTotal', 'contractGrandTotal'].includes(col.key)">
                          {{ item[col.key + 'Formatted'] }}
                        </template>
                        <template v-else-if="col.key === 'currency'">
                          <span class="badge"
                            :class="item.currency === 'USD' ? 'bg-soft-primary text-primary border-primary' : 'bg-soft-success text-success border-success'">{{
                            item.currency }}</span>
                        </template>
                        <template v-else-if="col.key === 'contractNo'">
                          <a href="#" @click.prevent="goToContractDetailsFromDashboard(item)"
                            class="table-link fw-bold">{{ item.contractNo }}</a>
                        </template>
                        <template v-else>{{ item[col.key] }}</template>
                      </td>
                    </template>
                    <td class="text-center-custom">
                      <div class="d-flex justify-content-center gap-1">
                        <button class="btn table-action-btn text-warning" @click="editContractItem(item)"
                          :title="t('tooltipEdit')">
                          <i class="bi bi-pencil-square"></i>
                        </button>
                        <button class="btn table-action-btn text-danger" @click="deleteContractItem(item)"
                          :title="t('tooltipDelete')">
                          <i class="bi bi-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                </template>
                <template v-else>
                  <tr>
                    <td :colspan="visibleContractDashboardColumns.length + 2" class="text-center text-muted py-5">{{
                      t('noMatchingData') }}</td>
                  </tr>
                </template>
              </tbody>
              <tfoot class="sticky-footer"
                v-if="filteredContractDashboardData.length > 0 && totalContractDashboardMetrics">
                <tr class="table-light fw-bold">
                  <td class="text-center-custom">Σ</td> <!-- Ký hiệu tổng -->
                  <template v-for="col in contractDashboardAvailableColumns" :key="col.key + '-footer'">
                    <td v-if="contractDashboardColumnVisibility[col.key]" :class="['text-end-custom']">
                      <!-- Hiển thị chữ 'Tổng' ở cột ngày hoặc tên hợp đồng cho dễ nhìn -->
                      <span v-if="col.key === 'contractNo'" class="text-muted small text-uppercase pe-2">
                        {{ t('total') }}:
                      </span>

                      <!-- Hiển thị giá trị tổng cho các cột tài chính -->
                      <span v-if="[
                    'contractAmountTotal', 'vonTotal', 'contractVatTotal', 'contractGrandTotal', 
                    'paidAmountExclVAT', 'paidVatAmount', 'paidAmountInclVAT', 
                    'invoiceAmountTotal', 'invoiceVatTotal', 'invoiceGrandTotal'
                ].includes(col.key)">
                        {{ formatNumber(totalContractDashboardMetrics[col.key]) }}
                      </span>
                    </td>
                  </template>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>

      <!-- 5. PHÂN TRANG (PAGINATION) -->
      <div class="pagination-wrapper no-print">
        <!-- Thông tin số lượng dòng (Bên trái) -->
        <div class="entries-info-text">
          <i class="fas fa-list-ol me-1"></i>
          {{ t('paginationInfo', {
          start: (viewStates.contractDashboard.currentPage - 1) * viewStates.contractDashboard.perPage + 1,
          end: Math.min(viewStates.contractDashboard.currentPage * viewStates.contractDashboard.perPage,
          filteredContractDashboardData.length),
          total: filteredContractDashboardData.length
          }) }}
        </div>

        <!-- Cụm điều khiển trang hình viên thuốc (Bên phải) -->
        <div class="modern-pagination-container">
          <!-- Nút Previous -->
          <button class="btn btn-pagination-modern" @click="viewStates.contractDashboard.currentPage--"
            :disabled="viewStates.contractDashboard.currentPage === 1">
            <i class="fas fa-arrow-left"></i>
            <span>{{ t('btnPrevious') }}</span>
          </button>

          <!-- Hiển thị Số trang Hiện tại / Tổng số trang -->
          <div class="page-info-pill">
            {{ viewStates.contractDashboard.currentPage }} / {{ contractDashboardTotalPages }}
          </div>

          <!-- Nút Next -->
          <button class="btn btn-pagination-modern" @click="viewStates.contractDashboard.currentPage++"
            :disabled="viewStates.contractDashboard.currentPage >= contractDashboardTotalPages">
            <span>{{ t('btnNext') }}</span>
            <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>

      <!-- INPUT FILE ẨN -->
      <input type="file" id="uploadContractExcelInput" ref="uploadContractExcelInput" @change="handleContractFileUpload"
        accept=".xlsx, .xls" style="display: none" />
    </div>

    <div v-if="currentTab === 'cpc-report-dashboard'">
      <div class="filter-panel no-print">
        <div class="row align-items-end">
          <div class="col-md-3">
            <div class="filter-group">
              <div class="filter-group-header">
                <h6
                  @click="viewStates.reportDashboard.filter.expansion.project = !viewStates.reportDashboard.filter.expansion.project">
                  <i class="fas fa-folder me-2"></i>
                  <span>{{ t('project') }}</span>
                </h6>
                <button class="clear-filter-btn" @click="viewStates.reportDashboard.filter.projectId = []"
                  data-bs-toggle="tooltip" :title="t('tooltipClearFilter')">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <input type="text" class="form-control filter-search"
                v-model="viewStates.reportDashboard.filter.projectSearch" :placeholder="t('searchProjects')" />
              <div class="slicer-options"
                :class="{ 'slicer-options-expanded': viewStates.reportDashboard.filter.expansion.project }">
                <button v-for="project in availableReportProjects" :key="project.id" class="btn slicer-btn"
                  :class="{ 'slicer-btn-selected': viewStates.reportDashboard.filter.projectId.includes(project.id) }"
                  @click="toggleFilter(viewStates.reportDashboard.filter.projectId, project.id)">
                  {{ project.name }}
                </button>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <label for="reportAsOfDate" class="form-label">{{ t('reportAsOfDate') }}</label><input type="date"
              class="form-control" id="reportAsOfDate" v-model="viewStates.reportDashboard.asOfDate" />
          </div>
          <div class="col-md-3">
            <label for="reportMonth" class="form-label">{{ t('reportMonth') }}</label><input type="month"
              class="form-control" id="reportMonth" v-model="viewStates.reportDashboard.reportMonth" />
          </div>
          <div class="col-md-3 text-end">
            <div class="btn-group">
              <button class="btn btn-primary" @click="printReport">
                <i class="fas fa-print me-2"></i> {{ t('print') }}</button><button class="btn btn-success"
                @click="exportReportToExcel">
                <i class="fas fa-file-excel me-2"></i> {{
                t('btnExport') }}
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="report-dashboard-table">
              <thead>
                <tr class="header-main">
                  <th rowspan="2" style="min-width: 350px">
                    {{ t('category') }}
                  </th>
                  <th colspan="3">
                    {{ t('reportPaidToDateHeader', { date:
                    formattedAsOfDate }) }}
                  </th>
                  <th colspan="3">
                    {{ t('reportRemainingFromDateHeader', { date:
                    formattedAsOfDate }) }}
                  </th>
                  <th colspan="3">
                    {{ t('reportPaidInMonthHeader', { month:
                    formattedReportMonth }) }}
                  </th>
                </tr>
                <tr>
                  <th>{{ t('net') }}</th>
                  <th>{{ t('vat') }}</th>
                  <th>{{ t('total') }}</th>
                  <th>{{ t('net') }}</th>
                  <th>{{ t('vat') }}</th>
                  <th>{{ t('total') }}</th>
                  <th>{{ t('net') }}</th>
                  <th>{{ t('vat') }}</th>
                  <th>{{ t('total') }}</th>
                </tr>
              </thead>
              <tbody>
                <template v-for="item in reportData" :key="item.code">
                  <tr :class="{ 'category-main': item.level === 1 }">
                    <td class="text-start" :class="'category-level-' + item.level">
                      {{ item.code }} {{ item.name }}
                    </td>
                    <td class="text-end">
                      {{
                      formatReportNumber(item.metrics.paidToDate.net)
                      }}
                    </td>
                    <td class="text-end">
                      {{
                      formatReportNumber(item.metrics.paidToDate.vat)
                      }}
                    </td>
                    <td class="text-end">
                      {{
                      formatReportNumber(item.metrics.paidToDate.total)
                      }}
                    </td>
                    <td class="text-end">
                      {{
                      formatReportNumber(item.metrics.remaining.net)
                      }}
                    </td>
                    <td class="text-end">
                      {{
                      formatReportNumber(item.metrics.remaining.vat)
                      }}
                    </td>
                    <td class="text-end">
                      {{
                      formatReportNumber(item.metrics.remaining.total)
                      }}
                    </td>
                    <td class="text-end">
                      {{
                      formatReportNumber(item.metrics.paidInMonth.net)
                      }}
                    </td>
                    <td class="text-end">
                      {{
                      formatReportNumber(item.metrics.paidInMonth.vat)
                      }}
                    </td>
                    <td class="text-end">
                      {{
                      formatReportNumber(item.metrics.paidInMonth.total)
                      }}
                    </td>
                  </tr>
                </template>
              </tbody>
              <tfoot>
                <tr>
                  <td class="text-start">
                    <strong>{{ t('grandTotal') }}</strong>
                  </td>
                  <td class="text-end">
                    {{
                    formatReportNumber(reportGrandTotal.paidToDate.net)
                    }}
                  </td>
                  <td class="text-end">
                    {{
                    formatReportNumber(reportGrandTotal.paidToDate.vat)
                    }}
                  </td>
                  <td class="text-end">
                    {{
                    formatReportNumber(reportGrandTotal.paidToDate.total)
                    }}
                  </td>
                  <td class="text-end">
                    {{
                    formatReportNumber(reportGrandTotal.remaining.net)
                    }}
                  </td>
                  <td class="text-end">
                    {{
                    formatReportNumber(reportGrandTotal.remaining.vat)
                    }}
                  </td>
                  <td class="text-end">
                    {{
                    formatReportNumber(reportGrandTotal.remaining.total)
                    }}
                  </td>
                  <td class="text-end">
                    {{
                    formatReportNumber(reportGrandTotal.paidInMonth.net)
                    }}
                  </td>
                  <td class="text-end">
                    {{
                    formatReportNumber(reportGrandTotal.paidInMonth.vat)
                    }}
                  </td>
                  <td class="text-end">
                    {{
                    formatReportNumber(reportGrandTotal.paidInMonth.total)
                    }}
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div v-if="currentTab === 'cogs-dashboard' && viewStates.cogsDashboard">
      <div class="filter-wrapper no-print mb-4" :class="{ 'is-expanded': !viewStates.cogsDashboard.isFilterCollapsed }">
        <!-- Thanh Header: Luôn hiển thị, chứa tóm tắt khi đóng -->
        <div class="filter-header-bar" @click="toggleFilterPanel(viewStates.cogsDashboard)">
          <div class="d-flex align-items-center flex-grow-1">
            <i class="fas fa-filter text-primary me-2"></i>
            <span class="fw-bold me-3">{{ t('filterPanelTitle') }}</span>

            <!-- Hiển thị tóm tắt bộ lọc khi đóng -->
            <span v-if="viewStates.cogsDashboard.isFilterCollapsed" class="text-muted small text-truncate"
              style="max-width: 600px;">
              <i class="fas fa-info-circle me-1"></i>
              {{ activeFiltersSummary(viewStates.cogsDashboard) }}
              <span v-if="viewStates.cogsDashboard.filter.asOfDate" class="ms-2">
                | {{ t('reportAsOf') }}: {{ viewStates.cogsDashboard.filter.asOfDate }}
              </span>
            </span>
          </div>

          <div class="d-flex align-items-center gap-2">
            <!-- Nút xóa nhanh tất cả bộ lọc -->
            <button
              v-if="activeFiltersSummary(viewStates.cogsDashboard) !== t('noActiveFilters') || viewStates.cogsDashboard.filter.asOfDate"
              class="btn btn-sm btn-link text-danger p-0 me-2 text-decoration-none" @click.stop="clearAllFilters">
              <i class="fas fa-sync-alt me-1"></i> {{ t('btnClearAllFilters') }}
            </button>
            <i class="fas fa-chevron-down filter-toggle-icon text-secondary"></i>
          </div>
        </div>

        <!-- Nội dung bộ lọc khi mở rộng -->
        <div class="filter-expand-content">
          <div class="filter-grid">

            <!-- 1. Bộ lọc Dự án -->
            <div class="filter-group">
              <div class="filter-group-header">
                <h6
                  @click="viewStates.cogsDashboard.filter.expansion.project = !viewStates.cogsDashboard.filter.expansion.project">
                  <i class="fas fa-folder me-2"></i><span>{{ t('project') }}</span>
                </h6>
                <button class="clear-filter-btn"
                  @click="viewStates.cogsDashboard.filter.projectId = []; viewStates.cogsDashboard.filter.projectSearch = ''">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <input type="text" class="form-control filter-search mb-2"
                v-model="viewStates.cogsDashboard.filter.projectSearch" :placeholder="t('searchProjects')">
              <div class="slicer-options"
                :class="{ 'slicer-options-expanded': viewStates.cogsDashboard.filter.expansion.project }">
                <button v-for="project in availableCogsProjects" :key="project.id" class="btn slicer-btn"
                  :class="{ 'slicer-btn-selected': viewStates.cogsDashboard.filter.projectId.includes(project.id) }"
                  @click="toggleFilter(viewStates.cogsDashboard.filter.projectId, project.id)">
                  {{ project.name }}
                </button>
              </div>
            </div>

            <!-- 2. Ngày báo cáo -->
            <div class="filter-group">
              <div class="filter-group-header">
                <h6><i class="fas fa-calendar-alt me-2"></i>{{ t('reportAsOf') }}</h6>
                <button class="clear-filter-btn" @click="viewStates.cogsDashboard.filter.asOfDate = null">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="p-2 bg-light rounded shadow-sm border">
                <label class="form-label small fw-bold text-secondary mb-1">Chọn ngày chốt:</label>
                <input type="date" class="form-control" v-model="viewStates.cogsDashboard.filter.asOfDate">
                <small class="form-text text-muted d-block mt-2">{{ t('reportAsOfNote') }}</small>
              </div>
            </div>

            <!-- 3. Trạng thái Đối chiếu (Chỉ hiện khi đã upload file SAP) -->
            <div class="filter-group" v-if="cogsComparisonData">
              <div class="filter-group-header">
                <h6
                  @click="viewStates.cogsDashboard.filter.expansion.status = !viewStates.cogsDashboard.filter.expansion.status">
                  <i class="fas fa-tasks me-2"></i><span>{{ t('reconciliationStatus') }}</span>
                </h6>
                <button class="clear-filter-btn" @click="viewStates.cogsDashboard.filter.status = []">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="slicer-options"
                :class="{ 'slicer-options-expanded': viewStates.cogsDashboard.filter.expansion.status }">
                <button v-for="status in availableCogsStatuses" :key="status" class="btn slicer-btn"
                  :class="{ 'slicer-btn-selected': viewStates.cogsDashboard.filter.status.includes(status) }"
                  @click="toggleFilter(viewStates.cogsDashboard.filter.status, status)">
                  {{ t(`status${status.replace(/ /g, '')}`) }}
                </button>
              </div>
            </div>

          </div>
        </div>
      </div>

      <div class="action-buttons-container">
        <div class="d-flex align-items-center gap-2">
          <button class="btn btn-outline-info" @click="triggerCogsFileUpload">
            <i class="fas fa-file-invoice-dollar me-2"></i> {{
            t('btnUploadCogs') }}
          </button>
          <button class="btn btn-outline-secondary" v-if="cogsComparisonData" @click="clearCogsComparison">
            <i class="fas fa-times me-2"></i> {{ t('btnClearCogs')
            }}
          </button>
        </div>
      </div>
      <input type="file" ref="cogsUploadInput" @change="handleCogsFileUpload" accept=".xlsx, .xls"
        style="display: none" />
      <h4 class="mt-4">{{ t('cogsSummaryTitle') }}</h4>
      <div class="card mb-5">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead>
                <tr>
                  <th class="text-center-custom" style="width: 5%">
                    {{ t('tableHeaderNo') }}
                  </th>
                  <th>{{ t('glaccount') }}</th>
                  <th class="text-end-custom">
                    {{ t('invAmountApp') }}
                  </th>
                  <th v-if="cogsSummaryFromSap" class="text-end-custom">
                    {{ t('invAmountSap') }}
                  </th>
                  <th v-if="cogsSummaryFromSap" class="text-end-custom">
                    {{ t('difference') }}
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(item, index) in cogsSummaryData" :key="item.glAccount">
                  <td class="text-center-custom">
                    {{ index + 1 }}
                  </td>
                  <td>{{ item.glAccount }}</td>
                  <td class="text-end-custom">
                    {{ formatCurrency(item.totalInvoiceAmount) }}
                  </td>
                  <td v-if="cogsSummaryFromSap" class="text-end-custom">
                    {{ formatCurrency(item.totalSap) }}
                  </td>
                  <td v-if="cogsSummaryFromSap" class="text-end-custom"
                    :class="{'fw-bold text-danger': Math.round(item.difference) !== 0}">
                    {{ formatCurrency(item.difference) }}
                  </td>
                </tr>
                <tr v-if="cogsSummaryData.length === 0">
                  <td :colspan="cogsSummaryFromSap ? 5 : 3" class="text-center text-muted py-4">
                    {{ t('noMatchingData') }}
                  </td>
                </tr>
              </tbody>
              <tfoot class="sticky-footer" v-if="cogsSummaryData.length > 0">
                <tr>
                  <td colspan="2" class="text-end-custom fw-bold">
                    {{ t('total') }}:
                  </td>
                  <td class="text-end-custom fw-bold">
                    {{
                    formatCurrency(totalCogsSummary.totalInvoiceAmount)
                    }}
                  </td>
                  <td v-if="cogsSummaryFromSap" class="text-end-custom fw-bold">
                    {{ formatCurrency(totalCogsSummary.totalSap) }}
                  </td>
                  <td v-if="cogsSummaryFromSap" class="text-end-custom fw-bold">
                    {{ formatCurrency(totalCogsSummary.difference)
                    }}
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
      <h4 class="mt-5 mb-3">{{ t('cogsDetailTitle') }}</h4>
      <div class="card">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead>
                <tr>
                  <th class="text-center-custom" style="width: 5%">
                    {{ t('tableHeaderNo') }}
                  </th>
                  <th>{{ t('glaccount') }}</th>
                  <th>{{ t('vendor') }}</th>
                  <th>{{ t('contract') }}</th>
                  <th>{{ t('contractSystemNo') }}</th>
                  <th class="text-end-custom">
                    {{ t('invAmountApp') }}
                  </th>
                  <th v-if="cogsComparisonData" class="text-end-custom">
                    {{ t('invAmountSap') }}
                  </th>
                  <th v-if="cogsComparisonData" class="text-end-custom">
                    {{ t('difference') }}
                  </th>
                  <th v-if="cogsComparisonData" class="text-center-custom">
                    {{ t('reconciliationStatus') }}
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(item, index) in paginatedCogsDetailsData" :key="item.id" :class="{
                                    'table-warning': cogsComparisonData && item.status === 'Mismatch',
                                    'table-info': cogsComparisonData && item.status === 'Only in App',
                                    'table-light': cogsComparisonData && item.status === 'Only in Accounting'
                                }">
                  <td class="text-center-custom">
                    {{ (viewStates.cogsDashboard.currentPage - 1) *
                    viewStates.cogsDashboard.perPage + index + 1 }}
                  </td>
                  <td>{{ item.glAccount }}</td>
                  <td>{{ item.vendorName }}</td>
                  <td>
                    <a href="#" @click.prevent="goToContractDetailsFromDashboard(item)" class="table-link">
                      {{ item.contractNo }}
                    </a>
                  </td>
                  <td>{{ item.contractSystemNo }}</td>
                  <td class="text-end-custom">
                    {{ formatCurrency(item.invoiceAmountTotal) }}
                  </td>

                  <td v-if="cogsComparisonData" class="text-end-custom">
                    {{ formatCurrency(item.invAmountSap) }}
                  </td>
                  <td v-if="cogsComparisonData" class="text-end-custom"
                    :class="{'fw-bold text-danger': Math.round(item.difference) !== 0}">
                    {{ formatCurrency(item.difference) }}
                  </td>
                  <td v-if="cogsComparisonData" class="text-center-custom">
                    <span class="badge" :class="getComparisonStatusBadge(item.status)">
                      {{ t(`status${item.status.replace(/ /g, '')}`)
                      }}
                    </span>
                  </td>
                </tr>
                <tr v-if="cogsDashboardData.length === 0">
                  <td :colspan="cogsComparisonData ? 9 : 6" class="text-center text-muted py-4">
                    {{ t('noMatchingData') }}
                  </td>
                </tr>
              </tbody>
              <tfoot class="sticky-footer" v-if="cogsDashboardData.length > 0">
                <tr>
                  <td :colspan="5" class="text-end-custom fw-bold">
                    {{ t('total') }}:
                  </td>
                  <td class="text-end-custom fw-bold">
                    {{
                    formatCurrency(totalCogsDetails.totalInvoiceAmount)
                    }}
                  </td>
                  <td v-if="cogsComparisonData" class="text-end-custom fw-bold">
                    {{
                    formatCurrency(totalCogsDetails.totalInvAmountSap)
                    }}
                  </td>
                  <td v-if="cogsComparisonData" class="text-end-custom fw-bold">
                    {{
                    formatCurrency(totalCogsDetails.totalDifference)
                    }}
                  </td>
                  <td v-if="cogsComparisonData"></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
      <div class="pagination-wrapper no-print">
        <!-- Thông tin số lượng dòng (Bên trái) -->
        <div class="entries-info-text">
          <i class="fas fa-list-ol me-1"></i>
          {{ t('paginationInfo', {
          start: (viewStates.cogsDashboard.currentPage - 1) * viewStates.cogsDashboard.perPage + 1,
          end: Math.min(viewStates.cogsDashboard.currentPage * viewStates.cogsDashboard.perPage,
          cogsDashboardData.length),
          total: cogsDashboardData.length
          }) }}
        </div>

        <!-- Cụm điều khiển trang hình viên thuốc (Bên phải) -->
        <div class="modern-pagination-container">
          <!-- Nút Previous -->
          <button class="btn btn-pagination-modern" @click="viewStates.cogsDashboard.currentPage--"
            :disabled="viewStates.cogsDashboard.currentPage === 1">
            <i class="fas fa-arrow-left"></i>
            <span>{{ t('btnPrevious') }}</span>
          </button>

          <!-- Hiển thị Số trang Hiện tại / Tổng số trang -->
          <div class="page-info-pill">
            {{ viewStates.cogsDashboard.currentPage }} / {{ cogsDashboardTotalPages }}
          </div>

          <!-- Nút Next -->
          <button class="btn btn-pagination-modern" @click="viewStates.cogsDashboard.currentPage++"
            :disabled="viewStates.cogsDashboard.currentPage >= cogsDashboardTotalPages">
            <span>{{ t('btnNext') }}</span>
            <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>
    </div>

    <div v-if="currentTab === 'invoice-aging'">
      <div class="filter-wrapper no-print mb-3" :class="{ 'is-expanded': !viewStates.invoiceAging.isFilterCollapsed }">
        <!-- Thanh Header: Luôn hiển thị, chứa tóm tắt khi đóng -->
        <div class="filter-header-bar" @click="toggleFilterPanel(viewStates.invoiceAging)">
          <div class="d-flex align-items-center flex-grow-1">
            <i class="fas fa-filter text-primary me-2"></i>
            <span class="fw-bold me-3">{{ t('filterPanelTitle') }}</span>

            <!-- Hiển thị tóm tắt bộ lọc khi đóng -->
            <span v-if="viewStates.invoiceAging.isFilterCollapsed" class="text-muted small text-truncate"
              style="max-width: 600px;">
              <i class="fas fa-info-circle me-1"></i>
              {{ activeFiltersSummary(viewStates.invoiceAging) }}
              <span v-if="viewStates.invoiceAging.filter.reportDate" class="ms-2">
                | {{ t('agingReportDate') }}: {{ viewStates.invoiceAging.filter.reportDate }}
              </span>
            </span>
          </div>

          <div class="d-flex align-items-center gap-2">
            <!-- Nút xóa nhanh tất cả bộ lọc -->
            <button v-if="activeFiltersSummary(viewStates.invoiceAging) !== t('noActiveFilters')"
              class="btn btn-sm btn-link text-danger p-0 me-2 text-decoration-none" @click.stop="clearAllFilters">
              <i class="fas fa-sync-alt me-1"></i> {{ t('btnClearAllFilters') }}
            </button>
            <i class="fas fa-chevron-down filter-toggle-icon text-secondary"></i>
          </div>
        </div>

        <!-- Nội dung bộ lọc khi mở rộng -->
        <div class="filter-expand-content">
          <div class="filter-grid">

            <!-- 1. Ngày tính tuổi nợ -->
            <div class="filter-group">
              <div class="filter-group-header">
                <h6><i class="fas fa-calendar-check me-2"></i>{{ t('agingReportDate') }}</h6>
              </div>
              <div class="p-2 bg-light rounded shadow-sm border">
                <label class="form-label small fw-bold text-secondary mb-1">Tính toán đến ngày:</label>
                <input type="date" class="form-control" v-model="viewStates.invoiceAging.filter.reportDate">
                <small class="form-text text-muted d-block mt-2">Dùng để xác định số ngày quá hạn của hóa đơn.</small>
              </div>
            </div>

            <!-- 2. Bộ lọc Dự án -->
            <div class="filter-group">
              <div class="filter-group-header">
                <h6
                  @click="viewStates.invoiceAging.filter.expansion.project = !viewStates.invoiceAging.filter.expansion.project">
                  <i class="fas fa-folder me-2"></i><span>{{ t('project') }}</span>
                </h6>
                <button class="clear-filter-btn"
                  @click="viewStates.invoiceAging.filter.projectId = []; viewStates.invoiceAging.filter.projectSearch = ''">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <input type="text" class="form-control filter-search mb-2"
                v-model="viewStates.invoiceAging.filter.projectSearch" :placeholder="t('searchProjects')">
              <div class="slicer-options"
                :class="{ 'slicer-options-expanded': viewStates.invoiceAging.filter.expansion.project }">
                <button v-for="p in availableInvoiceAgingProjects" :key="p.id" class="btn slicer-btn"
                  :class="{ 'slicer-btn-selected': viewStates.invoiceAging.filter.projectId.includes(p.id) }"
                  @click="toggleFilter(viewStates.invoiceAging.filter.projectId, p.id)">
                  {{ p.name }}
                </button>
              </div>
            </div>

            <!-- 3. Bộ lọc Nhà cung cấp -->
            <div class="filter-group">
              <div class="filter-group-header">
                <h6
                  @click="viewStates.invoiceAging.filter.expansion.vendor = !viewStates.invoiceAging.filter.expansion.vendor">
                  <i class="fas fa-truck me-2"></i><span>{{ t('vendor') }}</span>
                </h6>
                <button class="clear-filter-btn"
                  @click="viewStates.invoiceAging.filter.vendorId = []; viewStates.invoiceAging.filter.vendorSearch = ''">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <input type="text" class="form-control filter-search mb-2"
                v-model="viewStates.invoiceAging.filter.vendorSearch" :placeholder="t('searchVendors')">
              <div class="slicer-options"
                :class="{ 'slicer-options-expanded': viewStates.invoiceAging.filter.expansion.vendor }">
                <button v-for="v in availableInvoiceAgingVendors" :key="v.id" class="btn slicer-btn"
                  :class="{ 'slicer-btn-selected': viewStates.invoiceAging.filter.vendorId.includes(v.id) }"
                  @click="toggleFilter(viewStates.invoiceAging.filter.vendorId, v.id)">
                  {{ v.name }}
                </button>
              </div>
            </div>

          </div>
        </div>
      </div>

      <div class="table-controls no-print">
        <div class="d-flex align-items-center gap-3">
          <div class="btn-group btn-group-sm">
            <input type="radio" class="btn-check" id="ageInv" value="invoice"
              v-model="viewStates.invoiceAging.viewMode" />
            <label class="btn btn-outline-primary" for="ageInv">{{ t('viewByInvoice') }}</label>
            <input type="radio" class="btn-check" id="ageCon" value="contract"
              v-model="viewStates.invoiceAging.viewMode" />
            <label class="btn btn-outline-primary" for="ageCon">{{ t('viewByContract') }}</label>
          </div>

          <button class="btn btn-sm btn-success" @click="exportInvoiceAgingToExcel">
            <i class="fas fa-file-export me-1"></i> {{
            t('btnExportExcel') }}
          </button>

          <div class="vr"></div>
          <label class="mb-0 text-secondary small">{{ t('showEntriesLabel') }}</label>
          <select class="form-select form-select-sm w-auto" v-model.number="viewStates.invoiceAging.perPage">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
          </select>
        </div>
      </div>

      <div class="card">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table v-if="viewStates.invoiceAging.viewMode === 'invoice'"
              class="table table-hover align-middle table-bordered">
              <thead class="table-light">
                <tr>
                  <th class="text-center-custom">#</th>
                  <th v-for="col in invoiceAgingColumns" :key="col.key"
                    @click="handleSort(viewStates.invoiceAging, col.key)" style="cursor: pointer">
                    {{ col.label }}
                    <i v-if="viewStates.invoiceAging.sortBy === col.key"
                      :class="viewStates.invoiceAging.sortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'"></i>
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr v-if="viewStates.invoiceAging.filter.projectId.length === 0">
                  <td colspan="15" class="text-center py-5 text-muted">
                    {{ t('promptSelectProjectAging') }}
                  </td>
                </tr>
                <template v-else-if="paginatedInvoiceAgingData.length > 0">
                  <tr v-for="(item, index) in paginatedInvoiceAgingData" :key="item.id">
                    <td class="text-center-custom small">
                      {{ (viewStates.invoiceAging.currentPage - 1) *
                      viewStates.invoiceAging.perPage + index + 1 }}
                    </td>
                    <td>{{ item.projectName }}</td>
                    <td class="fw-bold">
                      <a href="#" @click.prevent="goToContractDetails(item)" class="table-link">{{ item.contractNo
                        }}</a>
                    </td>
                    <td class="text-center-custom">
                      {{ item.contractDate }}
                    </td>
                    <td class="small">
                      {{ item.contractDescription }}
                    </td>
                    <td class="text-center-custom">
                      {{ item.vendorNo }}
                    </td>
                    <td class="fw-bold text-primary">
                      {{ item.vendorName }}
                    </td>
                    <td>{{ item.invoiceNo }}</td>
                    <td>{{ item.invoiceDate }}</td>
                    <td>{{ item.invoicePostingDate }}</td>
                    <td class="text-center-custom">
                      <span class="badge bg-danger">{{ item.age }} {{ t('daysUnit') }}</span>
                    </td>
                    <td class="text-end-custom">
                      {{ formatCurrency(item.remainingNet) }}
                    </td>
                    <td class="text-end-custom">
                      {{ formatCurrency(item.remainingVat) }}
                    </td>
                    <td class="text-end-custom fw-bold text-danger">
                      {{ formatCurrency(item.remainingTotal) }}
                    </td>
                  </tr>
                </template>
                <tr v-else>
                  <td colspan="15" class="text-center py-5 text-muted">
                    {{ t('noAgingData', { date:
                    viewStates.invoiceAging.filter.reportDate }) }}
                  </td>
                </tr>
              </tbody>
            </table>

            <table v-else class="table table-hover align-middle table-bordered">
              <thead class="table-light text-center">
                <tr>
                  <th rowspan="2" style="width: 40px">#</th>
                  <th rowspan="2" @click="handleSort(viewStates.invoiceAging, 'projectName')" style="cursor: pointer">
                    {{ t('project') }}
                  </th>
                  <th rowspan="2" @click="handleSort(viewStates.invoiceAging, 'contractDate')" style="cursor: pointer">
                    {{ t('contractDateLabel') }}
                  </th>
                  <th rowspan="2" @click="handleSort(viewStates.invoiceAging, 'contractNo')" style="cursor: pointer">
                    {{ t('contract') }}
                  </th>
                  <th rowspan="2" @click="handleSort(viewStates.invoiceAging, 'vendorNo')" style="cursor: pointer">
                    {{ t('vendorNo') }}
                  </th>
                  <th rowspan="2" @click="handleSort(viewStates.invoiceAging, 'vendorName')" style="cursor: pointer">
                    {{ t('vendor') }}
                  </th>
                  <th rowspan="2">{{ t('descriptionLabel') }}</th>
                  <th colspan="4" class="bg-soft-warning">
                    {{ t('ageDays') }} ({{
                    viewStates.invoiceAging.filter.reportDate }})
                  </th>
                  <th rowspan="2" @click="handleSort(viewStates.invoiceAging, 'remainingTotal')"
                    style="cursor: pointer">
                    {{ t('totalOverdue') }}
                  </th>
                </tr>
                <tr class="bg-light">
                  <th style="width: 110px">{{ t('age1_30') }}</th>
                  <th style="width: 110px">{{ t('age31_60') }}</th>
                  <th style="width: 110px">{{ t('age61_90') }}</th>
                  <th style="width: 110px">{{ t('ageOver90') }}</th>
                </tr>
              </thead>
              <tbody>
                <tr v-if="viewStates.invoiceAging.filter.projectId.length === 0">
                  <td colspan="12" class="text-center py-5 text-muted">
                    {{ t('promptSelectProjectAging') }}
                  </td>
                </tr>
                <template v-else-if="paginatedContractAgingData.length > 0">
                  <tr v-for="(item, index) in paginatedContractAgingData" :key="item.id">
                    <td class="text-center-custom fw-bold small">
                      {{ (viewStates.invoiceAging.currentPage - 1) *
                      viewStates.invoiceAging.perPage + index + 1 }}
                    </td>
                    <td>{{ item.projectName }}</td>
                    <td class="text-center-custom">
                      {{ item.contractDate }}
                    </td>
                    <td class="fw-bold">
                      <a href="#" @click.prevent="goToContractDetails(item)" class="table-link">{{ item.contractNo
                        }}</a>
                    </td>
                    <td class="text-center-custom">
                      {{ item.vendorNo }}
                    </td>
                    <td class="text-primary fw-bold">
                      {{ item.vendorName }}
                    </td>
                    <td class="small">{{ item.description }}</td>
                    <td class="text-end-custom">
                      {{ item.age1_30 ? formatCurrency(item.age1_30)
                      : '-' }}
                    </td>
                    <td class="text-end-custom text-warning fw-bold">
                      {{ item.age31_60 ?
                      formatCurrency(item.age31_60) : '-' }}
                    </td>
                    <td class="text-end-custom text-orange fw-bold">
                      {{ item.age61_90 ?
                      formatCurrency(item.age61_90) : '-' }}
                    </td>
                    <td class="text-end-custom text-danger fw-bold">
                      {{ item.ageOver90 ?
                      formatCurrency(item.ageOver90) : '-' }}
                    </td>
                    <td class="text-end-custom fw-bold bg-light text-danger">
                      {{ formatCurrency(item.remainingTotal) }}
                    </td>
                  </tr>
                </template>
                <tr v-else>
                  <td colspan="12" class="text-center py-5 text-muted">
                    {{ t('noAgingData', { date:
                    viewStates.invoiceAging.filter.reportDate }) }}
                  </td>
                </tr>
              </tbody>
              <tfoot class="sticky-footer bg-light fw-bold text-end">
                <tr>
                  <td colspan="7">{{ t('total') }}:</td>
                  <td>
                    {{
                    formatCurrency(totalContractAgingBuckets.age1_30)
                    }}
                  </td>
                  <td>
                    {{
                    formatCurrency(totalContractAgingBuckets.age31_60)
                    }}
                  </td>
                  <td>
                    {{
                    formatCurrency(totalContractAgingBuckets.age61_90)
                    }}
                  </td>
                  <td>
                    {{
                    formatCurrency(totalContractAgingBuckets.ageOver90)
                    }}
                  </td>
                  <td class="text-danger">
                    {{
                    formatCurrency(totalContractAgingBuckets.total)
                    }}
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>

      <div class="pagination-wrapper no-print">
        <!-- Thông tin số lượng dòng (Bên trái) - Tự động tính theo View Mode -->
        <div class="entries-info-text">
          <i class="fas fa-list-ol me-1"></i>
          {{ t('paginationInfo', {
          start: (viewStates.invoiceAging.currentPage - 1) * viewStates.invoiceAging.perPage + 1,
          end: Math.min(
          viewStates.invoiceAging.currentPage * viewStates.invoiceAging.perPage,
          (viewStates.invoiceAging.viewMode === 'invoice' ? filteredInvoiceAgingData.length :
          filteredContractAgingData.length)
          ),
          total: (viewStates.invoiceAging.viewMode === 'invoice' ? filteredInvoiceAgingData.length :
          filteredContractAgingData.length)
          }) }}
        </div>

        <!-- Cụm điều khiển trang hình viên thuốc (Bên phải) -->
        <div class="modern-pagination-container">
          <!-- Nút Previous -->
          <button class="btn btn-pagination-modern" @click="viewStates.invoiceAging.currentPage--"
            :disabled="viewStates.invoiceAging.currentPage === 1">
            <i class="fas fa-arrow-left"></i>
            <span>{{ t('btnPrevious') }}</span>
          </button>

          <!-- Hiển thị Số trang Hiện tại / Tổng số trang (Tính toán động) -->
          <div class="page-info-pill">
            {{ viewStates.invoiceAging.currentPage }} / {{ Math.ceil((viewStates.invoiceAging.viewMode === 'invoice' ?
            filteredInvoiceAgingData.length : filteredContractAgingData.length) / viewStates.invoiceAging.perPage) || 1
            }}
          </div>

          <!-- Nút Next -->
          <button class="btn btn-pagination-modern" @click="viewStates.invoiceAging.currentPage++"
            :disabled="viewStates.invoiceAging.currentPage * viewStates.invoiceAging.perPage >= (viewStates.invoiceAging.viewMode === 'invoice' ? filteredInvoiceAgingData.length : filteredContractAgingData.length)">
            <span>{{ t('btnNext') }}</span>
            <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>
    </div>


    <div v-if="currentTab === 'master-data'">
      <!-- 1. NAVIGATION TABS (CHỌN NHÓM DỮ LIỆU) -->
      <ul class="master-data-tabs-container no-print mb-4">
        <li class="nav-item">
          <a class="nav-link" :class="{ active: masterData.activeSubTab === 'vendors' }" href="#"
            @click.prevent="masterData.activeSubTab = 'vendors'">
            <i class="fas fa-truck-fast me-2"></i>
            <span>{{ t('vendor_tab') }}</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" :class="{ active: masterData.activeSubTab === 'projects' }" href="#"
            @click.prevent="masterData.activeSubTab = 'projects'">
            <i class="fas fa-folder-open me-2"></i>
            <span>{{ t('project_tab') }}</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" :class="{ active: masterData.activeSubTab === 'categories' }" href="#"
            @click.prevent="masterData.activeSubTab = 'categories'">
            <i class="fas fa-sitemap me-2"></i>
            <span>{{ t('categoryTab') }}</span>
          </a>
        </li>
      </ul>

      <div class="tab-content">
        <!-- ========================================== -->
        <!-- 2. TAB NHÀ CUNG CẤP (VENDORS)               -->
        <!-- ========================================== -->
        <div v-if="masterData.activeSubTab === 'vendors'">
          <!-- Toolbar Nhóm Hành động -->
          <div class="master-data-toolbar no-print">
            <div class="toolbar-group">
              <div>
                <span class="toolbar-label">{{ t('btnAdd') }}</span>
                <button class="btn btn-primary px-3 shadow-sm" @click="openVendorModal('add')">
                  <i class="fas fa-plus-circle me-2"></i>{{ t('btnAddVendor') }}
                </button>
              </div>
            </div>

            <div class="toolbar-group ms-auto">
              <div>
                <span class="toolbar-label text-center">{{ t('btnData') }}</span>
                <div class="btn-group shadow-sm">
                  <button class="btn btn-soft-primary" @click="downloadMasterDataTemplate"
                    :title="t('btnDownloadTemplate')">
                    <i class="fas fa-file-download text-primary me-2"></i>{{ t('btnTemplate') }}
                  </button>
                  <button class="btn btn-soft-success" @click="triggerMasterDataUpload" :title="t('btnUploadMerge')">
                    <i class="fas fa-file-import text-success me-2"></i>{{ t('btnUpload') }}
                  </button>
                  <button class="btn btn-soft-info" @click="exportMasterVendors" :title="t('btnExportVendors')">
                    <i class="fas fa-file-export text-info me-2"></i>{{ t('btnExport') }}
                  </button>
                </div>
              </div>
            </div>

            <div class="search-input-group ms-3">
              <span class="toolbar-label">{{ t('search') }}</span>
              <div class="input-group shadow-sm border rounded-3 overflow-hidden">
                <span class="input-group-text border-0 bg-white"><i class="fas fa-search text-muted"></i></span>
                <input type="text" class="form-control border-0" :placeholder="t('searchVendorPlaceholder')"
                  v-model="masterData.vendors.searchTerm" ref="vendorSearchInput">
              </div>
            </div>
          </div>

          <!-- Bảng dữ liệu Vendors -->
          <div class="card border-0 shadow-sm overflow-hidden">
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                  <thead>
                    <tr>
                      <th class="text-center-custom" style="width: 5%">{{ t('tableHeaderNo') }}</th>
                      <th>{{ t('vendor') }}</th>
                      <th>{{ t('abbreviation') }}</th>
                      <th>{{ t('vendorNo') }}</th>
                      <th class="text-center-custom">{{ t('contractCount') }}</th>
                      <th class="text-center-custom" style="width: 15%">{{ t('action') }}</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="(vendor, index) in paginatedVendors" :key="vendor.id">
                      <td class="text-center-custom fw-bold text-muted">{{ (masterData.vendors.currentPage - 1) *
                        masterData.vendors.perPage + index + 1 }}</td>
                      <td class="fw-bold text-dark">{{ vendor.name }}</td>
                      <td><span class="badge bg-light text-dark border">{{ vendor.abbrName }}</span></td>
                      <td class="font-monospace">{{ vendor.vendorNo }}</td>
                      <td class="text-center-custom">
                        <span class="badge"
                          :class="vendorUsageCount[vendor.id] > 0 ? 'bg-soft-primary text-primary' : 'bg-light text-muted'">
                          {{ vendorUsageCount[vendor.id] || 0 }}
                        </span>
                      </td>
                      <td class="text-center-custom">
                        <div class="d-flex justify-content-center gap-1">
                          <button class="btn table-action-btn text-warning" @click="openVendorModal('edit', vendor)"
                            :title="t('btnEdit')">
                            <i class="bi bi-pencil-square"></i>
                          </button>
                          <button class="btn table-action-btn text-danger" @click="deleteVendor(vendor)"
                            :disabled="vendorUsageCount[vendor.id] > 0"
                            :title="vendorUsageCount[vendor.id] > 0 ? t('errorVendorInUse') : t('btnDelete')">
                            <i class="bi bi-trash"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                    <tr v-if="filteredVendorsForAdmin.length === 0">
                      <td colspan="6" class="text-center text-muted py-5">{{ t('noVendorsFound') }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Phân trang Vendors -->
          <div class="pagination-wrapper no-print" v-if="vendorTotalPages > 1">
            <div class="entries-info-text">
              <i class="fas fa-list-ol me-1"></i>
              {{ t('paginationInfo', {
              start: (masterData.vendors.currentPage - 1) * masterData.vendors.perPage + 1,
              end: Math.min(masterData.vendors.currentPage * masterData.vendors.perPage,
              filteredVendorsForAdmin.length),
              total: filteredVendorsForAdmin.length
              }) }}
            </div>

            <div class="modern-pagination-container">
              <button class="btn btn-pagination-modern" @click="masterData.vendors.currentPage--"
                :disabled="masterData.vendors.currentPage === 1">
                <i class="fas fa-arrow-left"></i>
                <span>{{ t('btnPrevious') }}</span>
              </button>

              <div class="page-info-pill">
                {{ masterData.vendors.currentPage }} / {{ vendorTotalPages }}
              </div>

              <button class="btn btn-pagination-modern" @click="masterData.vendors.currentPage++"
                :disabled="masterData.vendors.currentPage >= vendorTotalPages">
                <span>{{ t('btnNext') }}</span>
                <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- ========================================== -->
        <!-- 3. TAB DỰ ÁN (PROJECTS)                    -->
        <!-- ========================================== -->
        <div v-if="masterData.activeSubTab === 'projects'">
          <!-- Toolbar Nhóm Hành động -->
          <div class="master-data-toolbar no-print">
            <div class="toolbar-group">
              <div>
                <span class="toolbar-label">{{ t('btnAdd') }}</span>
                <button class="btn btn-primary px-3 shadow-sm" @click="openProjectModal('add')">
                  <i class="fas fa-folder-plus me-2"></i>{{ t('btnAddProject') }}
                </button>
              </div>
            </div>

            <div class="toolbar-group ms-auto">
              <div>
                <span class="toolbar-label text-center">Bảo trì hệ thống</span>
                <div class="d-flex gap-2">
                  <button class="btn btn-soft-warning px-3 shadow-sm" @click="cleanupOrphanData">
                    <i class="fas fa-broom me-2"></i>{{ t('btnCleanupData') }}
                  </button>
                  <button class="btn btn-soft-info px-3 shadow-sm" @click="runFullResync">
                    <i class="fas fa-sync-alt me-2"></i>{{ t('btnResyncData') }}
                  </button>
                </div>
              </div>
            </div>

            <div class="search-input-group ms-3">
              <span class="toolbar-label">{{ t('search') }}</span>
              <div class="input-group shadow-sm border rounded-3 overflow-hidden">
                <span class="input-group-text border-0 bg-white"><i class="fas fa-search text-muted"></i></span>
                <input type="text" class="form-control border-0" :placeholder="t('searchProjectPlaceholder')"
                  v-model="masterData.projects.searchTerm" ref="projectSearchInput">
              </div>
            </div>
          </div>

          <!-- Bảng dữ liệu Projects -->
          <div class="card border-0 shadow-sm overflow-hidden">
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                  <thead>
                    <tr>
                      <th class="text-center-custom" style="width: 5%">{{ t('tableHeaderNo') }}</th>
                      <th>{{ t('project') }}</th>
                      <th class="text-center-custom">{{ t('projectContractCount') }}</th>
                      <th class="text-center-custom" style="width: 15%">{{ t('action') }}</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="(project, index) in paginatedProjects" :key="project.id">
                      <td class="text-center-custom fw-bold text-muted">{{ (masterData.projects.currentPage - 1) *
                        masterData.projects.perPage + index + 1 }}</td>
                      <td class="fw-bold text-dark">{{ project.name }}</td>
                      <td class="text-center-custom">
                        <span class="badge"
                          :class="projectUsageCount[project.id] > 0 ? 'bg-soft-primary text-primary' : 'bg-light text-muted'">
                          {{ projectUsageCount[project.id] || 0 }}
                        </span>
                      </td>
                      <td class="text-center-custom">
                        <div class="d-flex justify-content-center gap-1">
                          <button class="btn table-action-btn text-warning" @click="openProjectModal('edit', project)"
                            :title="t('btnEdit')">
                            <i class="bi bi-pencil-square"></i>
                          </button>
                          <button class="btn table-action-btn text-danger" @click="deleteProject(project)"
                            :disabled="projectUsageCount[project.id] > 0"
                            :title="projectUsageCount[project.id] > 0 ? t('errorProjectInUse') : t('btnDelete')">
                            <i class="bi bi-trash"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                    <tr v-if="filteredProjectsForAdmin.length === 0">
                      <td colspan="4" class="text-center text-muted py-5">{{ t('noProjectsFound') }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Phân trang Projects -->
          <div class="pagination-wrapper no-print" v-if="projectTotalPages > 1">
            <div class="entries-info-text">
              <i class="fas fa-list-ol me-1"></i>
              {{ t('paginationInfo', {
              start: (masterData.projects.currentPage - 1) * masterData.projects.perPage + 1,
              end: Math.min(masterData.projects.currentPage * masterData.projects.perPage,
              filteredProjectsForAdmin.length),
              total: filteredProjectsForAdmin.length
              }) }}
            </div>

            <div class="modern-pagination-container">
              <button class="btn btn-pagination-modern" @click="masterData.projects.currentPage--"
                :disabled="masterData.projects.currentPage === 1">
                <i class="fas fa-arrow-left"></i>
                <span>{{ t('btnPrevious') }}</span>
              </button>

              <div class="page-info-pill">
                {{ masterData.projects.currentPage }} / {{ projectTotalPages }}
              </div>

              <button class="btn btn-pagination-modern" @click="masterData.projects.currentPage++"
                :disabled="masterData.projects.currentPage >= projectTotalPages">
                <span>{{ t('btnNext') }}</span>
                <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- ========================================== -->
        <!-- 4. TAB HẠNG MỤC (CATEGORIES)               -->
        <!-- ========================================== -->
        <div v-if="masterData.activeSubTab === 'categories'">
          <!-- Toolbar Nhóm Hành động -->
          <div class="master-data-toolbar no-print">
            <div class="toolbar-group">
              <div>
                <span class="toolbar-label">{{ t('btnAdd') }}</span>
                <button class="btn btn-primary px-3 shadow-sm" @click="openCategoryModal('add')">
                  <i class="fas fa-plus-square me-2"></i>{{ t('addCategory') }}
                </button>
              </div>
            </div>

            <div class="toolbar-group ms-auto">
              <div>
                <span class="toolbar-label text-center">{{ t('btnData') }}</span>
                <div class="btn-group shadow-sm">
                  <button class="btn btn-soft-primary" @click="downloadCategoryTemplate"
                    :title="t('btnDownloadTemplate')">
                    <i class="fas fa-file-download text-primary me-2"></i>{{ t('btnTemplate') }}
                  </button>
                  <button class="btn btn-soft-success" @click="triggerCategoryUpload" :title="t('btnUploadCategories')">
                    <i class="fas fa-file-import text-success me-2"></i>{{ t('btnUpload') }}
                  </button>
                  <button class="btn btn-soft-info" @click="exportCategories" :title="t('btnExport')">
                    <i class="fas fa-file-export text-info me-2"></i>{{ t('btnExport') }}
                  </button>
                </div>
              </div>
            </div>
            <!-- Giữ cột trống để layout đồng nhất với các tab trên -->
            <div class="search-input-group opacity-0 pe-none"></div>
          </div>

          <!-- Bảng dữ liệu Categories -->
          <div class="card border-0 shadow-sm overflow-hidden">
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                  <thead>
                    <tr>
                      <th class="text-center-custom" style="width: 5%">{{ t('categoryTableHeaderNo') }}</th>
                      <th>{{ t('categoryTableHeaderCode') }}</th>
                      <th>{{ t('categoryTableHeaderNameVi') }}</th>
                      <th>{{ t('categoryTableHeaderNameEn') }}</th>
                      <th class="text-center-custom">{{ t('categoryTableHeaderUsage') }}</th>
                      <th class="text-center-custom" style="width: 15%">{{ t('action') }}</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="(category, index) in displayCategories" :key="category.id"
                      :class="{'bg-light fw-bold': category.level === 1}">
                      <td class="text-center-custom text-muted small">{{ index + 1 }}</td>
                      <td :style="{ 'padding-left': (category.level - 1) * 1.5 + 'rem' }">
                        <span v-if="category.level > 1" class="text-muted me-2">↳</span>
                        <span class="font-monospace">{{ category.code }}</span>
                      </td>
                      <td>{{ category.name_vi }}</td>
                      <td class="text-muted small italic">{{ category.name_en }}</td>
                      <td class="text-center-custom">
                        <span class="badge"
                          :class="categoryUsageCount[category.code] > 0 ? 'bg-soft-primary text-primary' : 'bg-light text-muted'">
                          {{ categoryUsageCount[category.code] || 0 }}
                        </span>
                      </td>
                      <td class="text-center-custom">
                        <div class="d-flex justify-content-center gap-1">
                          <button class="btn table-action-btn text-warning" @click="openCategoryModal('edit', category)"
                            :title="t('btnEdit')">
                            <i class="bi bi-pencil-square"></i>
                          </button>
                          <button class="btn table-action-btn text-danger" @click="deleteCategory(category)"
                            :disabled="categoryUsageCount[category.code] > 0"
                            :title="categoryUsageCount[category.code] > 0 ? t('errorCategoryInUse') : t('btnDelete')">
                            <i class="bi bi-trash"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                    <tr v-if="displayCategories.length === 0">
                      <td colspan="6" class="text-center text-muted py-5">{{ t('categoryTableNoData') }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </transition>
  <input type="file" id="restoreJsonInput" ref="restoreJsonInput" @change="handleFileLoad" accept=".json"
    style="display: none" />
  <input type="file" ref="importProjectInput" @change="handleProjectFileUpload" accept=".json" style="display: none" />
  </main>
  </div>

  <transition name="fade">
    <button v-if="showScrollToTopButton" @click="scrollToTop"
      class="btn btn-primary btn-icon scroll-to-top-btn no-print">
      <i class="fas fa-arrow-up"></i>
    </button>
  </transition>

  <div v-if="isCommandPaletteVisible" class="command-palette-container" @keydown.esc="toggleCommandPalette(false)">
    <div class="command-palette-backdrop" @click="toggleCommandPalette(false)"></div>
    <div class="command-palette-dialog">
      <div class="command-palette-search">
        <input type="search" ref="commandInput" v-model="commandSearchTerm"
          :placeholder="t('commandPalettePlaceholder')" @keydown.down.prevent="navigateCommands('down')"
          @keydown.up.prevent="navigateCommands('up')" @keydown.enter.prevent="executeActiveCommand" />
      </div>
      <ul class="command-results-list">
        <li v-for="(result, index) in commandResults" :key="result.id" class="command-result-item"
          :class="{ 'active': index === activeCommandIndex }" @click="executeCommand(result)">
          <span class="result-type" :class="'type-' + result.type.toLowerCase()">{{ result.type }}</span>
          <div class="flex-grow-1">
            <div class="result-label">{{ result.label }}</div>
            <div class="result-sublabel">{{ result.sublabel }}</div>
          </div>
        </li>
        <li v-if="commandSearchTerm && commandResults.length === 0" class="command-result-item">
          {{ t('commandPaletteNoResults') }}
        </li>
      </ul>
    </div>
  </div>
  <transition name="fade-scale">
    <div v-if="isProjectQuickFilterVisible" class="command-palette-container"
      @keydown.esc.stop="toggleProjectQuickFilter(false)">
      <div class="command-palette-backdrop" @click="toggleProjectQuickFilter(false)"></div>
      <div class="command-palette-dialog">
        <div class="command-palette-search">
          <input type="search" ref="projectQuickFilterInput" v-model="projectQuickFilterSearch"
            :placeholder="t('searchProjects')" @keydown.down.prevent="navigateProjectQuickFilter('down')"
            @keydown.up.prevent="navigateProjectQuickFilter('up')"
            @keydown.space.prevent="toggleProjectSelection(filteredProjectsForQuickFilter[activeProjectQuickFilterIndex])"
            @keydown.enter.prevent="toggleProjectQuickFilter(false)" />
        </div>
        <ul class="command-results-list">
          <li v-for="(project, index) in filteredProjectsForQuickFilter" :key="project.id" class="command-result-item"
            :class="{ 
                    'active': index === activeProjectQuickFilterIndex, 
                    'selected': (project.id === 'all' && viewStates.cpcTracking.filter.projectId.length === 0) || viewStates.cpcTracking.filter.projectId.includes(project.id)
                  }" @click="toggleProjectSelection(project)">
            <i class="fas fa-check-circle"
              v-if="(project.id === 'all' && viewStates.cpcTracking.filter.projectId.length === 0) || viewStates.cpcTracking.filter.projectId.includes(project.id)"></i>
            <div class="flex-grow-1">
              <div class="result-label">{{ project.name }}</div>
            </div>
          </li>
          <li v-if="projectQuickFilterSearch && filteredProjectsForQuickFilter.length === 0"
            class="command-result-item">
            {{ t('commandPaletteNoResults') }}
          </li>
        </ul>
      </div>
    </div>
  </transition>
  <div class="modal fade" id="cpcDetailModal" tabindex="-1" aria-labelledby="cpcDetailModalLabel" aria-hidden="true"
    data-focus-ref="projectInput">
    <div class="modal-dialog modal-lg">
      <div class="modal-content" v-if="currentEditItem">
        <div class="modal-header">
          <h5 class="modal-title" id="cpcDetailModalLabel">
            {{ modalMode === 'financials' ? t('modalTitleEditFinancials')
            + ' - ' + currentEditItem.cpcIdentifier : (modalMode ===
            'edit' ? t('modalTitleEdit') : (modalMode === 'copy' ?
            t('modalTitleCopy') : t('modalTitleAdd'))) }}
          </h5>
          <button type="button" class="btn-close" @click="closeModal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form @submit.prevent="saveModal" @keydown.ctrl.enter.prevent="saveModal"
            @keydown.meta.enter.prevent="saveModal">
            <template v-if="modalMode !== 'financials'">
              <ul class="nav" id="cpcModalTab" role="tablist">
                <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="general-tab" data-bs-toggle="tab"
                    data-bs-target="#general-tab-pane" type="button" role="tab">
                    <i class="fas fa-file-invoice me-2"></i>{{
                    t('modalSectionMain') }}
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="payments-tab" data-bs-toggle="tab" data-bs-target="#payments-tab-pane"
                    type="button" role="tab">
                    <i class="fas fa-coins me-2"></i>{{
                    t('paymentInstallments') }}
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="additional-tab" data-bs-toggle="tab"
                    data-bs-target="#additional-tab-pane" type="button" role="tab">
                    <i class="fas fa-server me-2"></i>{{
                    t('modalSectionSystem') }}
                  </button>
                </li>
              </ul>

              <div class="tab-content" id="cpcModalTabContent">
                <div class="tab-pane fade show active" id="general-tab-pane" role="tabpanel">
                  <div class="form-section-title">
                    <i class="fas fa-info-circle me-1"></i> Thông tin
                    chung
                  </div>
                  <div class="row g-3 mb-4">
                    <div class="col-md-6">
                      <label class="form-label small fw-bold text-secondary">{{ t('project') }}
                        <span class="text-danger">*</span></label>
                      <div class="custom-dropdown-container">
                        <input type="text" class="form-control fw-bold" v-model="currentEditItem.projectName"
                          @focus="isProjectDropdownVisible = true" @blur="handleProjectInputBlur"
                          @keydown="navigateProjects" placeholder="Chọn dự án..." ref="projectInput" />
                        <ul v-if="isProjectDropdownVisible && filteredProjectsForModal.length > 0"
                          class="custom-dropdown-menu">
                          <li v-for="(project, index) in filteredProjectsForModal" :key="project.id"
                            :class="{ 'active': index === activeProjectIndex }"
                            @mousedown.prevent="selectProject(project)">
                            <div class="vendor-item-name">
                              {{ project.name }}
                            </div>
                          </li>
                        </ul>
                      </div>
                    </div>

                    <div class="col-md-6">
                      <label class="form-label small fw-bold text-secondary">{{ t('cpc') }} No.
                        <span class="text-danger">*</span></label>
                      <div class="input-group">
                        <span class="input-group-text bg-light"><i class="fas fa-hashtag text-muted"></i></span>
                        <input type="text" class="form-control fw-bold" v-model="currentEditItem.cpcIdentifier"
                          placeholder="VD: CPC-01" />
                      </div>
                    </div>

                    <div class="col-md-6">
                      <label class="form-label small fw-bold text-secondary">{{ t('contract') }}</label>
                      <div class="custom-dropdown-container">
                        <div class="input-group">
                          <input type="text" class="form-control" :value="currentEditItem.contractNo"
                            @input="contractSearchTerm = $event.target.value; currentEditItem.contractNo = $event.target.value"
                            @focus="isContractDropdownVisible = true; contractSearchTerm = currentEditItem.contractNo || ''"
                            @blur="handleContractInputBlur" @keydown="navigateContracts"
                            @change="autoFillFromMasterContract" placeholder="Tìm hợp đồng..." />

                          <button class="btn btn-light border" type="button" @click="addNewContractItem"
                            :title="t('btnAddContract')">
                            <i class="fas fa-plus text-success"></i>
                          </button>
                        </div>

                        <ul v-if="isContractDropdownVisible && filteredContractsForModal.length > 0"
                          class="custom-dropdown-menu">
                          <li v-for="(contract, index) in filteredContractsForModal" :key="contract.id"
                            :class="{ 'active': index === activeContractIndex }"
                            @mousedown.prevent="selectContract(contract)">
                            <div class="vendor-item-name">
                              {{ contract.contractNo }}
                            </div>
                            <div class="vendor-item-abbr">
                              {{ vendors.find(v => v.id ===
                              contract.vendorId)?.name || 'N/A' }}
                            </div>
                          </li>
                        </ul>
                      </div>
                    </div>

                    <div class="col-md-6">
                      <label class="form-label small fw-bold text-secondary">{{ t('vendor') }}</label>
                      <div class="custom-dropdown-container">
                        <div class="input-group">
                          <input type="text" class="form-control" :value="currentEditItem.vendorName"
                            @input="vendorSearchTerm = $event.target.value; currentEditItem.vendorName = $event.target.value"
                            @focus="isVendorDropdownVisible = true; syncVendorSearch(currentEditItem.vendorName)"
                            @blur="handleVendorInputBlur" @keydown="navigateVendors" placeholder="Nhà cung cấp..." />
                          <button class="btn btn-light border" type="button" @click="openVendorModal('add')"
                            title="Thêm NCC mới">
                            <i class="fas fa-plus text-success"></i>
                          </button>
                        </div>
                        <ul v-if="isVendorDropdownVisible" class="custom-dropdown-menu">
                          <li v-if="filteredVendors.length === 0" class="dropdown-item-disabled">
                            {{ t('noMatchingData') }}
                          </li>
                          <li v-for="(vendor, index) in filteredVendors" :key="vendor.id"
                            :class="{ 'active': index === activeVendorIndex }"
                            @mousedown.prevent="selectVendor(vendor)">
                            <div class="vendor-item-name">
                              {{ vendor.name }}
                            </div>
                            <div class="vendor-item-abbr">
                              {{ vendor.abbrName }}
                            </div>
                          </li>
                        </ul>
                      </div>
                    </div>

                    <div class="col-12">
                      <label class="form-label small fw-bold text-secondary">{{ t('contents') }}</label>
                      <input type="text" class="form-control" v-model="currentEditItem.contents"
                        placeholder="Nội dung thanh toán..." />
                    </div>
                  </div>

                  <div class="p-3 bg-soft-primary rounded border border-primary-subtle mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      <div class="form-section-title m-0 border-0 p-0 text-primary">
                        <i class="fas fa-wallet me-1"></i> {{
                        t('modalSectionFinancial') }}
                      </div>

                      <div class="form-check form-switch m-0">
                        <input class="form-check-input" type="checkbox" role="switch" id="isUsdSwitch"
                          v-model="currentEditItem.isUsd" @change="handleCpcUsdToggle" />
                        <label class="form-check-label fw-bold text-primary" for="isUsdSwitch">{{ t('paymentInUSD')
                          }}</label>
                      </div>
                    </div>

                    <div class="row g-3">
                      <div class="col-md-4">
                        <label class="form-label small text-muted">{{ currentEditItem.isUsd ? t('amountUSD') :
                          t('amountExclVAT') }}</label>
                        <div class="input-group" v-if="currentEditItem.isUsd">
                          <span class="input-group-text text-success border-success bg-white fw-bold">$</span>
                          <input type="text" class="form-control text-end text-success fw-bold border-success"
                            v-model="currentEditItem.displayAmountUsd" @input="formatCpcAmountUsd" placeholder="0.00" />
                        </div>
                        <input v-else type="text" class="form-control text-end"
                          v-model="currentEditItem.displayAmountExclVAT" @input="formatCpcAmountExclVAT"
                          placeholder="0" />
                      </div>

                      <div class="col-md-4">
                        <label class="form-label small text-muted">{{ currentEditItem.isUsd ? t('exchangeRate') :
                          t('vatAmount') }}</label>
                        <input v-if="currentEditItem.isUsd" type="text" class="form-control text-end"
                          v-model="currentEditItem.displayExchangeRate" @input="formatExchangeRate"
                          placeholder="23.500" />
                        <input v-else type="text" class="form-control text-end"
                          v-model="currentEditItem.displayVatAmount" @input="formatCpcVatAmount" placeholder="0" />
                      </div>

                      <div class="col-md-4">
                        <label class="form-label small text-muted">{{ t('amountInclVAT') }}
                          <small v-if="currentEditItem.isUsd">(VND Equiv.)</small></label>
                        <div class="input-group">
                          <input type="text" class="form-control bg-white text-end fw-bold text-dark"
                            v-model="currentEditItem.displayAmount" readonly />
                          <span class="input-group-text bg-white">₫</span>
                        </div>
                      </div>

                      <div class="col-md-6">
                        <label class="form-label small text-muted">{{ t('receivedDate') }}</label>
                        <input type="date" class="form-control" v-model="currentEditItem.receivedDate" />
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small text-muted">{{ t('paymentDueDate') }}</label>
                        <input type="date" class="form-control" v-model="currentEditItem.paymentDueDate" />
                      </div>
                    </div>
                  </div>
                </div>

                <div class="tab-pane fade" id="payments-tab-pane" role="tabpanel">
                  <div class="card mb-4 bg-light border-0 shadow-sm">
                    <div class="card-body py-3">
                      <div class="row text-center align-items-center">
                        <div class="col-4 border-end">
                          <small class="text-secondary text-uppercase fw-bold" style="font-size: 0.7rem">
                            {{ t('amount') }} (CPC)
                          </small>
                          <div class="h5 mb-0 text-primary fw-bold">
                            {{ currentEditItem.isUsd ?
                            formatCurrencyUSD(currentEditItem.amountUsd) :
                            currentEditItem.displayAmount }}
                          </div>
                        </div>

                        <div class="col-4 border-end">
                          <small class="text-secondary text-uppercase fw-bold" style="font-size: 0.7rem">
                            {{ t('total') }} {{ t('paidStatus') }}
                          </small>
                          <div class="h5 mb-0 text-success fw-bold">
                            {{ getModalTotalPaidFormatted() }}
                          </div>
                        </div>

                        <div class="col-4">
                          <small class="text-secondary text-uppercase fw-bold" style="font-size: 0.7rem">
                            {{ t('footerRemaining') }}
                          </small>
                          <div class="h5 mb-0 fw-bold"
                            :class="getModalRemainingAmount() < 0 ? 'text-danger' : 'text-muted'">
                            {{ getModalRemainingFormatted() }}
                          </div>
                        </div>
                      </div>

                      <div class="progress mt-3" style="
                                height: 22px;
                                border-radius: 12px;
                                background-color: #e9ecef;
                                box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
                              ">
                        <div
                          class="progress-bar progress-bar-striped progress-bar-animated d-flex align-items-center justify-content-center"
                          :class="getModalRemainingAmount() < 0 ? 'bg-danger' : 'bg-success'" role="progressbar" :style="{ 
            width: Math.min(100, Math.max(0, getModalPaymentPercentage())) + '%',
            transition: 'width 0.6s cubic-bezier(0.4, 0, 0.2, 1)'
        }">
                          <span class="text-white fw-bold" style="
                                    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
                                    font-size: 0.85rem;
                                  ">
                            {{ Math.round(getModalPaymentPercentage()) }}%
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="installments-container" style="
                            max-height: 400px;
                            overflow-y: auto;
                            padding-right: 5px;
                          ">
                    <div v-for="(installment, idx) in currentEditItem.installments" :key="idx"
                      class="card mb-3 border-0 shadow-sm bg-light">
                      <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
                          <div class="fw-bold text-primary">
                            #{{ idx + 1 }} {{ t('installment') }}
                          </div>
                          <div class="d-flex gap-3 align-items-center">
                            <div class="form-check form-switch m-0">
                              <input class="form-check-input" type="checkbox" role="switch" :id="'usd-check-'+idx"
                                v-model="installment.isUsd" @change="handleUsdToggle(installment)" />
                              <label class="form-check-label small" :for="'usd-check-'+idx">USD</label>
                            </div>
                            <div class="form-check form-switch m-0">
                              <input class="form-check-input" type="checkbox" role="switch" :id="'swap-check-'+idx"
                                v-model="installment.isSwap" />
                              <label class="form-check-label small" :for="'swap-check-'+idx">SWAP</label>
                            </div>
                            <button class="btn btn-sm btn-outline-danger border-0 py-0 px-2"
                              @click="removeInstallment(idx)">
                              <i class="fas fa-times"></i>
                            </button>
                          </div>
                        </div>
                        <div class="row g-2 align-items-end">
                          <div class="col-md-3">
                            <label class="form-label small text-muted mb-0">{{ t('paymentDate') }}</label>
                            <input type="date" class="form-control form-control-sm" v-model="installment.date" />
                          </div>
                          <div class="col-md-3">
                            <label class="form-label small text-muted mb-0">{{ t('paymentSource') }}</label>
                            <input type="text" class="form-control form-control-sm"
                              v-model="installment.paymentSource" />
                          </div>
                          <template v-if="!installment.isUsd">
                            <div class="col-md-6">
                              <label class="form-label small text-muted mb-0">VND Amount</label>
                              <input type="text" class="form-control form-control-sm text-end fw-bold"
                                v-model="installment.displayAmount" @input="formatInstallmentAmount(installment)" />
                            </div>
                          </template>
                          <template v-else>
                            <div class="col-md-2">
                              <label class="form-label small text-muted mb-0">USD</label>
                              <input type="text" class="form-control form-control-sm text-end text-success fw-bold"
                                v-model="installment.displayAmountUsd"
                                @input="formatInstallmentAmountUsd(installment)" />
                            </div>
                            <div class="col-md-2">
                              <label class="form-label small text-muted mb-0">Rate</label>
                              <input type="text" class="form-control form-control-sm text-end"
                                v-model="installment.displayExchangeRate"
                                @input="formatInstallmentExchangeRate(installment)" />
                            </div>
                            <div class="col-md-2">
                              <label class="form-label small text-muted mb-0">VND</label>
                              <input type="text" class="form-control form-control-sm text-end bg-white"
                                :value="installment.displayAmount" readonly />
                            </div>
                          </template>
                        </div>

                        <div v-if="installment.isSwap" class="mt-2 pt-2 border-top">
                          <small class="text-info fst-italic">Nhập chi tiết cấn trừ SWAP...</small>
                        </div>
                      </div>
                    </div>
                  </div>

                  <button type="button" class="btn btn-outline-primary border-dashed w-100 py-2 mt-2"
                    @click="addInstallment" style="border-style: dashed; border-width: 2px">
                    <i class="fas fa-plus-circle me-1"></i> {{
                    currentEditItem && currentEditItem.amount < 0 ? t('completeWithOffset') : t('addInstallment') }}
                      </button>
                </div>

                <div class="tab-pane fade" id="additional-tab-pane" role="tabpanel">
                  <div class="form-section-title">
                    <i class="fas fa-database me-1"></i> Metadata &
                    Tracking
                  </div>

                  <div class="row g-3 mb-4">
                    <div class="col-md-3">
                      <label class="form-label small fw-bold text-secondary">{{ t('code') }}</label>
                      <input type="text" class="form-control readonly-field" v-model="currentEditItem.code" readonly
                        tabindex="-1" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label small fw-bold text-secondary">{{ t('department') }}</label>
                      <input type="text" class="form-control readonly-field" v-model="currentEditItem.department"
                        readonly tabindex="-1" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label small fw-bold text-secondary">{{ t('contractSystemNo') }}</label>
                      <input type="text" class="form-control readonly-field" v-model="currentEditItem.contractSystemNo"
                        readonly tabindex="-1" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label small fw-bold text-secondary">{{ t('vendorNo') }}</label>
                      <input type="text" class="form-control readonly-field" v-model="currentEditItem.vendorNo" readonly
                        tabindex="-1" />
                    </div>
                  </div>

                  <div class="form-section-title">
                    <i class="fas fa-pen-nib me-1"></i> Ghi chú & Theo dõi
                  </div>
                  <div class="mb-3">
                    <label class="form-label small fw-bold text-secondary">{{ t('lineTracking') }}</label>
                    <input type="text" class="form-control" v-model="currentEditItem.lineTracking"
                      placeholder="Trạng thái hồ sơ..." />
                  </div>
                  <div class="mb-3">
                    <label class="form-label small fw-bold text-secondary">{{ t('notes') }}</label>
                    <textarea class="form-control" rows="4" v-model="currentEditItem.notes"
                      placeholder="Ghi chú nội bộ..."></textarea>
                  </div>
                </div>
              </div>
            </template>
            <template v-else>
              <div class="card mb-3 bg-light border-0 shadow-sm">
                <div class="card-body py-2">
                  <div class="row text-center align-items-center">
                    <div class="col-4 border-end">
                      <small class="text-secondary text-uppercase fw-bold" style="font-size: 0.75rem">
                        {{ t('amount') }} (CPC)
                      </small>
                      <div class="h5 mb-0 text-primary fw-bold">
                        {{ currentEditItem.isUsd ?
                        formatCurrencyUSD(currentEditItem.amountUsd) :
                        currentEditItem.displayAmount }}
                      </div>
                    </div>

                    <div class="col-4 border-end">
                      <small class="text-secondary text-uppercase fw-bold" style="font-size: 0.75rem">
                        {{ t('total') }} {{ t('paidStatus') }}
                      </small>
                      <div class="h5 mb-0 text-success fw-bold">
                        {{ getModalTotalPaidFormatted() }}
                      </div>
                    </div>

                    <div class="col-4">
                      <small class="text-secondary text-uppercase fw-bold" style="font-size: 0.75rem">
                        {{ t('footerRemaining') }}
                      </small>
                      <div class="h5 mb-0 fw-bold"
                        :class="getModalRemainingAmount() < 0 ? 'text-danger' : 'text-muted'">
                        {{ getModalRemainingFormatted() }}
                      </div>
                    </div>
                  </div>

                  <div class="progress mt-3" style="
                            height: 22px;
                            border-radius: 12px;
                            background-color: #e9ecef;
                            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
                          ">
                    <div
                      class="progress-bar progress-bar-striped progress-bar-animated d-flex align-items-center justify-content-center"
                      :class="getModalRemainingAmount() < 0 ? 'bg-danger' : 'bg-success'" role="progressbar" :style="{ 
            width: Math.min(100, Math.max(0, getModalPaymentPercentage())) + '%',
            transition: 'width 0.6s cubic-bezier(0.4, 0, 0.2, 1)'
        }">
                      <span class="text-white fw-bold" style="
                                text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
                                font-size: 0.85rem;
                              ">
                        {{ Math.round(getModalPaymentPercentage()) }}%
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              <div v-for="(installment, idx) in currentEditItem.installments" :key="idx"
                class="mb-3 p-3 border rounded bg-white shadow-sm">
                <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
                  <div class="d-flex align-items-center">
                    <span class="badge bg-primary me-2">{{ idx + 1 }}</span>
                    <h6 class="mb-0 text-primary fw-bold">
                      {{ t('installment') }}
                    </h6>
                  </div>

                  <div class="d-flex align-items-center gap-3">
                    <div class="form-check form-switch m-0">
                      <input class="form-check-input" type="checkbox" role="switch" :id="'usd-check-fin-' + idx"
                        v-model="installment.isUsd" @change="handleUsdToggle(installment)" />
                      <label class="form-check-label small fw-semibold text-secondary" :for="'usd-check-fin-' + idx">
                        {{ t('paymentInUSD') }}
                      </label>
                    </div>

                    <div class="form-check form-switch m-0">
                      <input class="form-check-input" type="checkbox" role="switch" :id="'swap-check-fin-' + idx"
                        v-model="installment.isSwap" />
                      <label class="form-check-label small fw-semibold text-secondary" :for="'swap-check-fin-' + idx">
                        {{ t('swap') }}
                      </label>
                    </div>

                    <button class="btn btn-sm btn-outline-danger border-0 py-0 px-2" @click="removeInstallment(idx)">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>

                <div class="row g-2 align-items-end">
                  <div class="col-md-3">
                    <label class="form-label small text-muted mb-1 fw-bold">{{ t('paymentDate') }}</label>
                    <input type="date" class="form-control" v-model="installment.date"
                      :class="{ 'is-invalid': installment.isDateInvalid }" min="2010-01-01" max="2040-12-31" />
                  </div>

                  <div class="col-md-3">
                    <label class="form-label small text-muted mb-1 fw-bold">{{ t('paymentSource') }}</label>
                    <input type="text" class="form-control" v-model="installment.paymentSource"
                      :placeholder="t('paymentSource')" />
                  </div>

                  <template v-if="!installment.isUsd">
                    <div class="col-md-6">
                      <label class="form-label small text-muted mb-1 fw-bold">{{ t('amountPaid') }} (VND)</label>
                      <div class="input-group">
                        <input type="text" class="form-control text-end fw-bold" v-model="installment.displayAmount"
                          @input="formatInstallmentAmount(installment)" placeholder="0" />
                        <span class="input-group-text text-muted">₫</span>
                      </div>
                    </div>
                  </template>

                  <template v-else>
                    <div class="col-md-2">
                      <label class="form-label small text-muted mb-1 fw-bold">{{ t('amountUSD') }}</label>
                      <div class="input-group">
                        <span class="input-group-text text-success py-0 px-2">$</span>
                        <input type="text" class="form-control text-end fw-bold text-success px-1"
                          v-model="installment.displayAmountUsd" @input="formatInstallmentAmountUsd(installment)"
                          placeholder="0.00" />
                      </div>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label small text-muted mb-1 fw-bold">{{ t('exchangeRate') }}</label>
                      <input type="text" class="form-control text-end" v-model="installment.displayExchangeRate"
                        @input="formatInstallmentExchangeRate(installment)" placeholder="23.500" />
                    </div>
                    <div class="col-md-2">
                      <label class="form-label small text-muted mb-1 fw-bold">VND Equiv.</label>
                      <div class="input-group">
                        <input type="text" class="form-control text-end bg-light text-secondary px-1"
                          :value="installment.displayAmount" readonly />
                        <span class="input-group-text bg-light text-secondary py-0 px-1"
                          style="font-size: 0.75rem">₫</span>
                      </div>
                    </div>
                  </template>
                </div>

                <div v-if="installment.isSwap" class="mt-3 pt-3 border-top bg-light rounded p-2">
                  <div class="row g-2 mb-2">
                    <div class="col-md-4">
                      <label class="form-label small">{{ t('vendorSWAP') }}</label>
                      <input type="text" class="form-control form-control-sm" v-model="installment.vendorSWAP" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label small">{{ t('swapAgreement') }}</label>
                      <input type="text" class="form-control form-control-sm" v-model="installment.swapAgreement" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label small">{{ t('swapProduct') }}</label>
                      <input type="text" class="form-control form-control-sm" v-model="installment.swapProduct" />
                    </div>
                  </div>
                  <div class="mb-2">
                    <label class="form-label small">{{ t('swapInformation') }}</label>
                    <textarea class="form-control form-control-sm" rows="2"
                      v-model="installment.swapInformation"></textarea>
                  </div>
                  <div class="mb-2">
                    <label class="form-label small">{{ t('swapDueDatePayment') }}</label>
                    <input type="date" class="form-control form-control-sm" v-model="installment.swapDueDatePayment"
                      min="2010-01-01" max="2040-12-31" />
                  </div>
                  <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" :checked="isSwapFullyPaid(installment)" disabled />
                    <label class="form-check-label small">{{ t('swapPaidLabel') }}</label>
                  </div>
                  <div v-if="installment.isSwap">
                    <h6 class="small fw-bold text-muted">
                      {{ t('swapPayments') }}
                    </h6>
                    <div v-for="(payment, pIdx) in installment.swapPayments" :key="pIdx" class="installment-item mb-1">
                      <input type="text" class="form-control form-control-sm text-end" v-model="payment.displayAmount"
                        @input="formatSwapPaymentAmount(payment)" :placeholder="t('amountPaid')" />
                      <input type="date" class="form-control form-control-sm" v-model="payment.date" />
                      <input type="text" class="form-control form-control-sm" v-model="payment.source"
                        :placeholder="t('paymentSource')" />
                      <button type="button" class="btn btn-outline-danger btn-sm"
                        @click="removeSwapPayment(installment, pIdx)">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-info mt-1" @click="addSwapPayment(installment)">
                      <i class="fas fa-plus me-1"></i> {{
                      t('addSwapPayment') }}
                    </button>
                  </div>
                </div>
              </div>
              <div class="mt-3">
                <button type="button" class="btn btn-success" @click="addInstallment">
                  <i class="fas fa-plus me-1"></i> {{ currentEditItem &&
                  currentEditItem.amount < 0 ? t('completeWithOffset') : t('addInstallment') }} </button>
              </div>
            </template>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" @click="closeModal">
            {{ t('btnClose') }}</button><button type="button" class="btn btn-primary" @click="saveModal">
            <i class="fas fa-save me-2"></i>{{ t('btnSaveChanges') }}
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="swapEditModal" tabindex="-1" aria-labelledby="swapEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content" v-if="currentEditSwap">
        <div class="modal-header">
          <h5 class="modal-title" id="swapEditModalLabel">
            {{ t('editSwapTitle') }}
          </h5>
          <button type="button" class="btn-close" @click="closeSwapModal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>
            <strong>{{ t('contract') }}:</strong> {{
            currentEditSwap.contractNo }} |
            <strong>{{ t('amount') }}:</strong> {{
            formatCurrency(currentEditSwap.amount) }}
          </p>
          <hr />
          <form @submit.prevent="saveSwapModal" @keydown.ctrl.enter.prevent="saveSwapModal"
            @keydown.meta.enter.prevent="saveSwapModal">
            <div class="p-2 bg-light border rounded">
              <div class="row g-2 mb-2">
                <div class="col-md-3">
                  <label class="form-label small">{{ t('vendorSWAP') }}</label><input type="text"
                    class="form-control form-control-sm" v-model="currentEditSwap.vendorSWAP" />
                </div>
                <div class="col-md-3">
                  <label class="form-label small">{{ t('swapAgreement') }}</label><input type="text"
                    class="form-control form-control-sm" v-model="currentEditSwap.swapAgreement" />
                </div>
                <div class="col-md-3">
                  <label class="form-label small">{{ t('swapProduct') }}</label><input type="text"
                    class="form-control form-control-sm" v-model="currentEditSwap.swapProduct" />
                </div>
                <div class="col-md-3">
                  <label class="form-label small">{{ t('agreementDate') }}</label><input type="date"
                    class="form-control form-control-sm" v-model="currentEditSwap.date" />
                </div>
              </div>
              <div class="mb-2">
                <label class="form-label small">{{ t('swapInformation') }}</label><textarea
                  class="form-control form-control-sm" rows="2" v-model="currentEditSwap.swapInformation"></textarea>
              </div>
              <div class="mb-2">
                <label class="form-label small">{{ t('swapDueDatePayment') }}</label><input type="date"
                  class="form-control form-control-sm" v-model="currentEditSwap.swapDueDatePayment" />
              </div>
              <hr class="my-2" />
              <h6>
                {{ t('swapPayments') }}
                <span class="badge bg-secondary ms-2">{{ totalSwapPayments(currentEditSwap) }}/{{
                  formatCurrency(currentEditSwap.amount) }}</span>
              </h6>
              <div v-for="(payment, pIdx) in currentEditSwap.swapPayments" :key="pIdx" class="installment-item">
                <input type="text" class="form-control form-control-sm text-end" v-model="payment.displayAmount"
                  @input="formatSwapPaymentAmount(payment)" :placeholder="t('amountPaid')" /><input type="date"
                  class="form-control form-control-sm" v-model="payment.date" /><input type="text"
                  class="form-control form-control-sm" v-model="payment.source"
                  :placeholder="t('paymentSource')" /><button type="button" class="btn btn-outline-danger btn-sm"
                  @click="removeSwapPayment(currentEditSwap, pIdx)">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
              <button type="button" class="btn btn-info btn-sm mt-2" @click="addSwapPayment(currentEditSwap)">
                <i class="fas fa-plus me-1"></i> {{ t('addSwapPayment') }}
              </button>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" @click="closeSwapModal">
            {{ t('btnClose') }}</button><button type="button" class="btn btn-primary" @click="saveSwapModal">
            {{ t('btnSaveChanges') }}
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="contractDetailModal" tabindex="-1" aria-labelledby="contractDetailModalLabel"
    aria-hidden="true" data-focus-ref="contractProjectInput">
    <div class="modal-dialog modal-lg">
      <div class="modal-content" v-if="currentEditContract">
        <div class="modal-header">
          <h5 class="modal-title" id="contractDetailModalLabel">
            {{ contractModalMode === 'edit' ? t('modalTitleEditContract')
            : t('modalTitleAddContract') }}
          </h5>
          <button type="button" class="btn-close" @click="closeContractModal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form @submit.prevent="saveContractModal" @keydown.ctrl.enter.prevent="saveContractModal"
            @keydown.meta.enter.prevent="saveContractModal">
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="contractProject" class="form-label">{{ t('project') }}</label>
                <div class="custom-dropdown-container">
                  <input type="text" class="form-control" id="contractProject" autocomplete="off"
                    v-model="currentEditContract.projectName" @focus="isContractProjectDropdownVisible = true"
                    @input="isContractProjectDropdownVisible = true" @blur="handleContractProjectInputBlur"
                    @keydown="navigateProjectsForContract" placeholder="Nhập tên dự án..." ref="contractProjectInput" />
                  <ul v-if="isContractProjectDropdownVisible && filteredProjectsForContractModal.length > 0"
                    class="custom-dropdown-menu">
                    <li v-for="(project, index) in filteredProjectsForContractModal" :key="project.id"
                      :class="{ 'active': index === activeContractProjectIndex }"
                      @mousedown.prevent="selectProjectForContract(project)">
                      <div class="vendor-item-name">
                        {{ project.name }}
                      </div>
                    </li>
                  </ul>
                </div>
              </div>
              <div class="col-md-6">
                <label for="contractGlAccount" class="form-label">{{ t('glaccount') }}</label><input type="text"
                  class="form-control" id="contractGlAccount" v-model="currentEditContract.glAccount" />
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="contractNo" class="form-label">{{ t('contract') }}</label><input type="text"
                  class="form-control" id="contractNo" v-model="currentEditContract.contractNo" />
              </div>
              <div class="col-md-6">
                <label for="contractDate" class="form-label">{{ t('date') }}</label><input type="date"
                  class="form-control" id="contractDate" v-model="currentEditContract.date" />
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-12">
                <label for="contractDescription" class="form-label">{{ t('details') }}</label><input type="text"
                  class="form-control" id="contractDescription" v-model="currentEditContract.description" />
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="contractVendor" class="form-label">{{ t('vendor') }}</label>
                <div class="custom-dropdown-container">
                  <div class="input-group">
                    <input type="text" class="form-control" id="contractVendor" autocomplete="off"
                      :value="currentEditContract.vendorName"
                      @input="vendorSearchTerm = $event.target.value; currentEditContract.vendorName = $event.target.value"
                      @focus="isVendorDropdownVisible = true; syncVendorSearch(currentEditContract.vendorName)"
                      @blur="handleVendorInputBlur" @keydown="navigateVendors" />
                    <button class="btn btn-outline-secondary btn-add-master" type="button"
                      @click="openVendorModal('add')" data-bs-toggle="tooltip" :title="t('modalTitleAddVendor')">
                      <i class="fas fa-plus"></i>
                    </button>
                  </div>
                  <ul v-if="isVendorDropdownVisible" class="custom-dropdown-menu">
                    <li v-if="filteredVendors.length === 0" class="dropdown-item-disabled">
                      {{ t('noMatchingData') }}
                    </li>
                    <li v-for="(vendor, index) in filteredVendors" :key="vendor.id"
                      :class="{ 'active': index === activeVendorIndex }" @mousedown.prevent="selectVendor(vendor)">
                      <div class="vendor-item-name">
                        {{ vendor.name }}
                      </div>
                      <div class="vendor-item-abbr">
                        {{ vendor.abbrName }}
                      </div>
                    </li>
                  </ul>
                </div>
              </div>
              <div class="col-md-6">
                <label for="contractVendorAbbr" class="form-label">{{ t('abbreviation') }}</label>
                <input type="text" class="form-control" id="contractVendorAbbr"
                  v-model="currentEditContract.vendorAbbrName" />
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="contractCurrency" class="form-label">{{ t('currency') }}</label>
                <select class="form-select" id="contractCurrency" v-model="currentEditContract.currency">
                  <option value="VND">VND</option>
                  <option value="USD">USD</option>
                </select>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-3">
                <label for="contractVendorNo" class="form-label">{{ t('vendorNo') }}</label><input type="text"
                  class="form-control bg-light" id="contractVendorNo" v-model="currentEditContract.vendorNo" readonly />
              </div>
              <div class="col-md-3">
                <label for="contractCode" class="form-label">{{ t('code') }}</label><input type="text"
                  class="form-control" id="contractCode" v-model="currentEditContract.code" />
              </div>
              <div class="col-md-3">
                <label for="contractDepartment" class="form-label">{{ t('department') }}</label><input type="text"
                  class="form-control" id="contractDepartment" v-model="currentEditContract.department" />
              </div>
              <div class="col-md-3">
                <label for="contractSystemNo" class="form-label">{{ t('contractSystemNo') }}</label><input type="text"
                  class="form-control" id="contractSystemNo" v-model="currentEditContract.contractSystemNo" />
              </div>
            </div>

            <hr class="my-4" />
            <h6 class="mb-3 text-secondary fw-normal">
              {{ t('calculationRules') }}
            </h6>
            <div class="row mb-3" v-if="currentEditContract.settings">
              <div class="col-md-4">
                <label for="repaymentThreshold" class="form-label">{{ t('repaymentThresholdLabel') }}</label>
                <input type="number" step="1" min="0" max="100" class="form-control" id="repaymentThreshold"
                  v-model.number="currentEditContract.settings.repaymentThreshold" />
                <small class="form-text text-muted">{{ t('repaymentThresholdNote') }}</small>
              </div>
              <div class="col-md-4">
                <label for="retentionRate" class="form-label">{{ t('retentionRateLabel') }}</label>
                <input type="number" step="1" min="0" max="20" class="form-control" id="retentionRate"
                  v-model.number="currentEditContract.settings.retentionRate" />
                <small class="form-text text-muted">{{ t('retentionRateNote') }}</small>
              </div>
              <div class="col-md-4">
                <label for="defaultVatRate" class="form-label">{{ t('defaultVatRateLabel') }}</label>
                <input type="number" step="1" min="0" max="10" class="form-control" id="defaultVatRate"
                  v-model.number="currentEditContract.settings.defaultVatRate"
                  :class="{'bg-warning-subtle': currentEditContract.currency === 'USD'}" />
                <small class="form-text text-muted">{{ t('defaultVatRateNote') }}</small>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" @click="closeContractModal">
            {{ t('btnClose') }}</button><button type="button" class="btn btn-primary" @click="saveContractModal">
            {{ t('btnSaveChanges') }}
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="bondDetailViewModal" tabindex="-1" aria-labelledby="bondDetailViewModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content" v-if="currentViewBondItem">
        <div class="modal-header">
          <h5 class="modal-title" id="bondDetailViewModalLabel">
            {{ t('bondDetailsFor') }} {{ currentViewBondItem.projectName
            }}
          </h5>
          <button type="button" class="btn-close" @click="closeBondViewModal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div v-if="currentViewBondItem.bonds && currentViewBondItem.bonds.length > 0">
            <table class="bond-view-table">
              <thead>
                <tr>
                  <th class="text-center-custom">
                    {{ t('tableHeaderNo') }}
                  </th>
                  <th class="text-center-custom">
                    {{ t('bondNumber') }}
                  </th>
                  <th class="text-center-custom">{{ t('bondType') }}</th>
                  <th class="text-center-custom">{{ t('amount') }}</th>
                  <th class="text-center-custom">{{ t('issueDate') }}</th>
                  <th class="text-center-custom">
                    {{ t('expiryDate') }}
                  </th>
                  <th class="text-center-custom">
                    {{ t('issuingBank') }}
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(bond, idx) in currentViewBondItem.bonds" :key="'view-bond-row-' + idx">
                  <td class="text-center-custom">{{ idx + 1 }}</td>
                  <td class="text-start-custom">{{ bond.bondNumber }}</td>
                  <td class="text-start-custom">{{ bond.bondType }}</td>
                  <td class="text-end-custom">
                    {{ formatCurrency(bond.amount) }}
                  </td>
                  <td class="text-center-custom">{{ bond.issueDate }}</td>
                  <td class="text-center-custom">
                    {{ bond.expiryDate }}
                  </td>
                  <td class="text-start-custom">
                    {{ bond.issuingBank }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div v-else class="text-muted text-center">
            {{ t('noBondInfo') }}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" @click="closeBondViewModal">
            {{ t('btnClose') }}
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="installmentEditModal" tabindex="-1" aria-labelledby="installmentEditModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" v-if="currentEditInstallment">
        <div class="modal-header">
          <h5 class="modal-title" id="installmentEditModalLabel">
            {{ t('modalTitleEditInstallment') }}
          </h5>
          <button type="button" class="btn-close" @click="closeInstallmentModal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>
            <strong>{{ t('contract') }}:</strong> {{
            currentEditInstallment.contractNo }}
          </p>
          <hr />
          <form @submit.prevent="saveInstallmentModal" @keydown.ctrl.enter.prevent="saveInstallmentModal"
            @keydown.meta.enter.prevent="saveInstallmentModal">
            <div class="mb-3">
              <label for="editInstallmentDate" class="form-label">{{ t('paymentDate') }}</label><input type="date"
                class="form-control" id="editInstallmentDate" v-model="currentEditInstallment.date" />
            </div>
            <div class="mb-3">
              <label for="installmentAmount" class="form-label">{{ t('amountPaid') }}</label><input type="text"
                class="form-control text-end" id="installmentAmount" v-model="currentEditInstallment.displayAmount"
                @input="formatInstallmentEditAmount" />
            </div>
            <div class="mb-3">
              <label for="paymentSource" class="form-label">{{ t('paymentSource') }}</label><input type="text"
                class="form-control" id="paymentSource" v-model="currentEditInstallment.paymentSource" />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" @click="closeInstallmentModal">
            {{ t('btnClose') }}</button><button type="button" class="btn btn-primary" @click="saveInstallmentModal">
            {{ t('btnSaveChanges') }}
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="bondEditModal" tabindex="-1" aria-labelledby="bondEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" v-if="currentEditBond">
        <div class="modal-header">
          <h5 class="modal-title" id="bondEditModalLabel">
            {{ t('updateBondStatus') }}
          </h5>
          <button type="button" class="btn-close" @click="closeBondEditModal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>
            <strong>{{ t('contract') }}:</strong> {{
            currentEditBond.contractNo }}
          </p>
          <p>
            <strong>{{ t('bond') }}:</strong> {{
            currentEditBond.bondNumber }} ({{ currentEditBond.bondType }})
          </p>
          <hr />
          <form @submit.prevent="saveBondModal" @keydown.ctrl.enter.prevent="saveBondModal"
            @keydown.meta.enter.prevent="saveBondModal">
            <div class="mb-3">
              <label class="form-label">{{ t('statusUpdate') }}:</label>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="editBondIsAdvanceSettled"
                  v-model="currentEditBond.isAdvanceSettled" /><label class="form-check-label"
                  for="editBondIsAdvanceSettled">{{ t('advancePaymentsCleared') }}</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="editBondIsContractSettled"
                  v-model="currentEditBond.isContractSettled" /><label class="form-check-label"
                  for="editBondIsContractSettled">{{ t('contractSettled') }}</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="editBondIsOtherReasonSettled"
                  v-model="currentEditBond.isOtherReasonSettled" /><label class="form-check-label"
                  for="editBondIsOtherReasonSettled">{{ t('otherReason') }}:</label><input type="text"
                  class="form-control mt-2" v-model="currentEditBond.otherReasonText"
                  v-if="currentEditBond.isOtherReasonSettled" :placeholder="t('inputCustomReason')" />
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" @click="closeBondEditModal">
            {{ t('btnClose') }}</button><button type="button" class="btn btn-primary" @click="saveBondModal">
            {{ t('btnSaveChanges') }}
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="renewBondModal" tabindex="-1" aria-labelledby="renewBondModalLabel" aria-hidden="true"
    data-focus-ref="newBondNumberInput">
    <div class="modal-dialog modal-lg">
      <div class="modal-content" v-if="currentRenewBond">
        <div class="modal-header">
          <h5 class="modal-title" id="renewBondModalLabel">
            {{ t('renewBond') }}
          </h5>
          <button type="button" class="btn-close" @click="closeRenewBondModal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form @submit.prevent="saveRenewedBond" @keydown.ctrl.enter.prevent="saveRenewedBond"
            @keydown.meta.enter.prevent="saveRenewedBond">
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="renewProject" class="form-label">{{ t('project') }}</label><input type="text"
                  class="form-control" id="renewProject" v-model="currentRenewBond.projectName" readonly />
              </div>
              <div class="col-md-6">
                <label for="renewContractNo" class="form-label">{{ t('contract') }}</label><input type="text"
                  class="form-control" id="renewContractNo" v-model="currentRenewBond.contractNo" readonly />
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="renewBondNumber" class="form-label">{{ t('originalBondNumber') }}</label><input type="text"
                  class="form-control" id="renewBondNumber" v-model="currentRenewBond.bondNumber" readonly />
              </div>
              <div class="col-md-6">
                <label for="renewBondType" class="form-label">{{ t('originalBondType') }}</label><input type="text"
                  class="form-control" id="renewBondType" v-model="currentRenewBond.bondType" readonly />
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="renewOldExpiryDate" class="form-label">{{ t('originalExpiryDate') }}</label><input
                  type="date" class="form-control" id="renewOldExpiryDate" v-model="currentRenewBond.expiryDate"
                  readonly />
              </div>
              <div class="col-md-6">
                <label for="renewOldAmount" class="form-label">{{ t('originalAmount') }}</label><input type="text"
                  class="form-control text-end" id="renewOldAmount" :value="formatCurrency(currentRenewBond.amount)"
                  readonly />
              </div>
            </div>
            <hr />
            <h6>{{ t('newRenewalDetails') }}</h6>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="newBondNumber" class="form-label">{{ t('newBondNumber') }}</label><input type="text"
                  class="form-control" id="newBondNumber" v-model="newBondDetails.bondNumber"
                  ref="newBondNumberInput" />
              </div>
              <div class="col-md-6">
                <label for="newBondRef" class="form-label">{{ t('ref') }}</label><input type="text" class="form-control"
                  id="newBondRef" v-model="newBondDetails.ref" />
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="newBondType" class="form-label">{{ t('newBondType') }}</label><select class="form-select"
                  id="newBondType" v-model="newBondDetails.bondType">
                  <option value="">{{ t('selectBondType') }}</option>
                  <option :value="t('prepaymentBond')">
                    {{ t('prepaymentBond') }}
                  </option>
                  <option :value="t('performanceBond')">
                    {{ t('performanceBond') }}
                  </option>
                  <option :value="t('warrantyBond')">
                    {{ t('warrantyBond') }}
                  </option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="newBondAmount" class="form-label">{{ t('newAmount') }}</label><input type="text"
                  class="form-control text-end" id="newBondAmount" v-model="newBondDetails.displayAmount"
                  @input="formatNewBondAmount" />
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="newIssueDate" class="form-label">{{ t('newIssueDate') }}</label><input type="date"
                  class="form-control" id="newIssueDate" v-model="newBondDetails.issueDate" />
              </div>
              <div class="col-md-6">
                <label for="newExpiryDate" class="form-label">{{ t('newExpiryDate') }}</label><input type="date"
                  class="form-control" id="newExpiryDate" v-model="newBondDetails.expiryDate" />
              </div>
            </div>
            <div class="mb-3">
              <label for="newIssuingBank" class="form-label">{{ t('newIssuingBank') }}</label><input type="text"
                class="form-control" id="newIssuingBank" v-model="newBondDetails.issuingBank" />
            </div>
            <div class="mb-3">
              <label for="renewalNotes" class="form-label">{{ t('renewalNotes') }}</label><textarea class="form-control"
                id="renewalNotes" rows="3" v-model="newBondDetails.renewalNotes"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" @click="closeRenewBondModal">
            {{ t('btnCancel') }}</button><button type="button" class="btn btn-primary" @click="saveRenewedBond">
            {{ t('btnSaveRenewal') }}
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade confirmation-modal" id="confirmationModal" tabindex="-1"
    aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" tabindex="-1" @keydown.ctrl.enter.prevent="confirmAction"
        @keydown.meta.enter.prevent="confirmAction">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmationModalLabel">
            {{ confirmation.title }}
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p v-html="confirmation.message"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" @click="cancelAction">
            {{ t('btnCancel') }}
          </button>
          <button v-if="confirmation.onNeutral" type="button" class="btn btn-outline-secondary" @click="neutralAction"
            data-bs-dismiss="modal">
            {{ confirmation.neutralButtonText }}
          </button>
          <button type="button" :class="['btn', confirmation.confirmButtonClass]" @click="confirmAction">
            {{ confirmation.confirmButtonText }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="orphanDataModal" tabindex="-1" aria-labelledby="orphanDataModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="orphanDataModalLabel">
            <i class="fas fa-broom me-2 text-warning"></i> {{
            t('modalTitleOrphanData') }}
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" :aria-label="t('btnClose')"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted">{{ t('orphanDataDescription') }}</p>

          <div v-if="orphanData.projectsWithNoContracts.length > 0" class="mb-4">
            <h6>
              <i class="fas fa-folder text-danger me-2"></i> {{
              t('orphanUnusedProjects') }} ({{
              orphanData.projectsWithNoContracts.length }})
            </h6>
            <p class="small text-muted">
              {{ t('orphanUnusedProjectsDesc') }}
            </p>
            <ul class="list-group">
              <li v-for="item in orphanData.projectsWithNoContracts" :key="item.id"
                class="list-group-item d-flex justify-content-between align-items-center">
                <span v-html="t('orphanProjectLabel', { name: item.name, id: item.id })"></span>
                <button class="btn btn-sm btn-outline-danger" @click="deleteOrphanItem('projects', item.id)">
                  <i class="fas fa-trash me-1"></i> {{
                  t('btnDeleteOrphan') }}
                </button>
              </li>
            </ul>
          </div>

          <div v-if="orphanData.contractsWithOrphanProject.length > 0" class="mb-4">
            <h6>
              <i class="fas fa-file-signature text-danger me-2"></i> {{
              t('orphanContractsWithOrphanProject') }} ({{
              orphanData.contractsWithOrphanProject.length }})
            </h6>
            <ul class="list-group">
              <li v-for="item in orphanData.contractsWithOrphanProject" :key="item.id"
                class="list-group-item d-flex justify-content-between align-items-center">
                <span
                  v-html="t('orphanContractLabel', { contractNo: item.contractNo, id: item.id, projectId: item.projectId })"></span>
                <button class="btn btn-sm btn-outline-danger" @click="deleteOrphanItem('contracts', item.id)">
                  <i class="fas fa-trash me-1"></i> {{
                  t('btnDeleteOrphan') }}
                </button>
              </li>
            </ul>
          </div>

          <div v-if="orphanData.contractsWithOrphanVendor.length > 0" class="mb-4">
            <h6>
              <i class="fas fa-file-signature text-danger me-2"></i> {{
              t('orphanContractsWithOrphanVendor') }} ({{
              orphanData.contractsWithOrphanVendor.length }})
            </h6>
            <ul class="list-group">
              <li v-for="item in orphanData.contractsWithOrphanVendor" :key="item.id"
                class="list-group-item d-flex justify-content-between align-items-center">
                <span
                  v-html="t('orphanContractVendorLabel', { contractNo: item.contractNo, id: item.id, vendorId: item.vendorId })"></span>
                <button class="btn btn-sm btn-outline-danger" @click="deleteOrphanItem('contracts', item.id)">
                  <i class="fas fa-trash me-1"></i> {{
                  t('btnDeleteOrphan') }}
                </button>
              </li>
            </ul>
          </div>

          <div v-if="orphanData.cpcWithOrphanContract.length > 0" class="mb-4">
            <h6>
              <i class="fas fa-clipboard-list text-danger me-2"></i> {{
              t('orphanCpcWithOrphanContract') }} ({{
              orphanData.cpcWithOrphanContract.length }})
            </h6>
            <ul class="list-group">
              <li v-for="item in orphanData.cpcWithOrphanContract" :key="item.id"
                class="list-group-item d-flex justify-content-between align-items-center">
                <span
                  v-html="t('orphanCpcLabel', { cpcIdentifier: item.cpcIdentifier, id: item.id, contractId: item.contractId })"></span>
                <button class="btn btn-sm btn-outline-danger" @click="deleteOrphanItem('cpcItems', item.id)">
                  <i class="fas fa-trash me-1"></i> {{
                  t('btnDeleteOrphan') }}
                </button>
              </li>
            </ul>
          </div>

          <div v-if="orphanData.installmentsWithOrphanCpc.length > 0" class="mb-4">
            <h6>
              <i class="fas fa-cash-register text-danger me-2"></i> {{
              t('orphanInstallmentsWithOrphanCpc') }} ({{
              orphanData.installmentsWithOrphanCpc.length }})
            </h6>
            <ul class="list-group">
              <li v-for="item in orphanData.installmentsWithOrphanCpc" :key="item.id"
                class="list-group-item d-flex justify-content-between align-items-center">
                <span
                  v-html="t('orphanInstallmentLabel', { amount: formatCurrency(item.amount), date: item.date, id: item.id, cpcId: item.cpcId })"></span>
                <button class="btn btn-sm btn-outline-danger" @click="deleteOrphanItem('installments', item.id)">
                  <i class="fas fa-trash me-1"></i> {{
                  t('btnDeleteOrphan') }}
                </button>
              </li>
            </ul>
          </div>

          <div v-if="orphanData.bondsWithOrphanCpc.length > 0" class="mb-4">
            <h6>
              <i class="fas fa-shield-alt text-danger me-2"></i> {{
              t('orphanBondsWithOrphanCpc') }} ({{
              orphanData.bondsWithOrphanCpc.length }})
            </h6>
            <ul class="list-group">
              <li v-for="item in orphanData.bondsWithOrphanCpc" :key="item.id"
                class="list-group-item d-flex justify-content-between align-items-center">
                <span
                  v-html="t('orphanBondLabel', { bondNumber: item.bondNumber, id: item.id, cpcId: item.cpcId })"></span>
                <button class="btn btn-sm btn-outline-danger" @click="deleteOrphanItem('bonds', item.id)">
                  <i class="fas fa-trash me-1"></i> {{
                  t('btnDeleteOrphan') }}
                </button>
              </li>
            </ul>
          </div>

          <div v-if="!hasOrphanData" class="alert alert-success text-center">
            <i class="fas fa-check-circle me-2"></i>
            {{ t('orphanDataSuccess') }}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            {{ t('btnClose') }}
          </button>
          <button type="button" class="btn btn-danger" @click="deleteAllOrphans" v-if="hasOrphanData">
            <i class="fas fa-exclamation-triangle me-2"></i> {{
            t('btnDeleteAllOrphans') }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="guideModal" tabindex="-1" aria-labelledby="guideModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="guideModalLabel">
            <i class="fas fa-book-open me-2"></i> {{ t('guideTitle') }}
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="d-flex align-items-start">
            <div class="nav flex-column nav-pills me-4 guide-nav" id="v-pills-tab" role="tablist"
              aria-orientation="vertical">
              <button :class="{ active: activeHelpTopic === 'getting-started' }" class="nav-link"
                @click="activeHelpTopic = 'getting-started'" type="button">
                <i class="fas fa-rocket fa-fw me-2"></i> Bắt đầu nhanh
              </button>
              <button :class="{ active: activeHelpTopic === 'shortcuts' }" class="nav-link"
                @click="activeHelpTopic = 'shortcuts'" type="button">
                <i class="fas fa-keyboard fa-fw me-2"></i> Phím tắt & Thủ
                thuật
              </button>
              <button :class="{ active: activeHelpTopic === 'cpc-tracking' }" class="nav-link"
                @click="activeHelpTopic = 'cpc-tracking'" type="button">
                <i class="fas fa-clipboard-list fa-fw me-2"></i> Theo dõi
                CPC
              </button>
              <button :class="{ active: activeHelpTopic === 'cpc-details' }" class="nav-link"
                @click="activeHelpTopic = 'cpc-details'" type="button">
                <i class="fas fa-file-alt fa-fw me-2"></i> Chi tiết CPC
              </button>
              <button :class="{ active: activeHelpTopic === 'data-management' }" class="nav-link"
                @click="activeHelpTopic = 'data-management'" type="button">
                <i class="fas fa-database fa-fw me-2"></i> Quản lý Dữ liệu
              </button>
              <button :class="{ active: activeHelpTopic === 'excel-templates' }" class="nav-link"
                @click="activeHelpTopic = 'excel-templates'" type="button">
                <i class="fas fa-file-excel fa-fw me-2"></i> Hướng dẫn
                Template
              </button>
              <button :class="{ active: activeHelpTopic === 'other-dashboards' }" class="nav-link"
                @click="activeHelpTopic = 'other-dashboards'" type="button">
                <i class="fas fa-chart-pie fa-fw me-2"></i> Các Dashboard
                khác
              </button>
              <button :class="{ active: activeHelpTopic === 'faq' }" class="nav-link" @click="activeHelpTopic = 'faq'"
                type="button">
                <i class="fas fa-question-circle fa-fw me-2"></i> Câu hỏi
                thường gặp
              </button>
            </div>

            <div class="tab-content guide-content" id="v-pills-tabContent">
              <div v-if="activeHelpTopic === 'getting-started'">
                <div class="d-flex justify-content-between align-items-center border-bottom pb-3 mb-4">
                  <h4 class="m-0 text-primary">
                    <i class="fas fa-rocket fa-fw me-2"></i>Hướng dẫn Bắt
                    đầu Nhanh
                  </h4>
                  <span class="badge bg-info text-dark">Quy trình 6 Bước</span>
                </div>

                <div class="alert alert-warning d-flex align-items-center" role="alert">
                  <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                  <div>
                    <strong>Lưu ý quan trọng về Dữ liệu:</strong> Ứng dụng
                    này chạy trên trình duyệt (Offline-first). Trước khi
                    bắt đầu, hãy nhớ rằng nếu bạn xóa lịch sử duyệt web,
                    dữ liệu sẽ mất. Hãy xem <strong>Bước 6</strong> để
                    biết cách bảo vệ dữ liệu.
                  </div>
                </div>

                <p class="lead fs-6">
                  Chào mừng bạn đến với CPC Vision. Để quản lý hồ sơ thanh
                  toán hiệu quả, hãy tuân thủ luồng dữ liệu chuẩn sau đây:
                </p>

                <div class="list-group list-group-flush border rounded">
                  <div class="list-group-item p-4">
                    <div class="d-flex w-100 justify-content-between">
                      <h5 class="mb-1 text-success">
                        <span class="badge bg-success rounded-pill me-2">1</span>
                        Khởi tạo Dữ liệu Nguồn (Master Data)
                      </h5>
                    </div>
                    <p class="mb-2 text-muted">
                      Đây là móng nhà. Bạn cần có Dự án và Nhà cung cấp
                      trước khi làm hợp đồng.
                    </p>
                    <ul class="mb-0 small">
                      <li>
                        Vào tab
                        <strong class="text-dark"><i class="fas fa-database"></i> Master
                          Data</strong>.
                      </li>
                      <li>
                        Chọn thẻ <strong>Dự án</strong> &rarr; Nhấn nút
                        "Thêm Dự án".
                      </li>
                      <li>
                        Chọn thẻ <strong>Nhà cung cấp</strong> &rarr; Nhấn
                        nút "Thêm NCC" (Nhập đầy đủ Tên, Tên viết tắt và
                        Mã NCC - Mã này dùng để đối chiếu kế toán).
                      </li>
                    </ul>
                  </div>

                  <div class="list-group-item p-4 bg-light">
                    <h5 class="mb-1 text-primary">
                      <span class="badge bg-primary rounded-pill me-2">2</span>
                      Tạo Hợp đồng (Contract)
                    </h5>
                    <p class="mb-2 text-muted">
                      Hợp đồng là trung tâm kết nối Dự án và NCC.
                    </p>
                    <ul class="mb-0 small">
                      <li>
                        Cách nhanh nhất: Nhấn phím tắt
                        <code>Alt + A</code> &rarr; Chọn
                        <strong>Thêm Hợp đồng</strong>.
                      </li>
                      <li>
                        Điền số Hợp đồng, chọn Dự án và NCC đã tạo ở Bước
                        1.
                      </li>
                      <li>
                        <strong>Quan trọng:</strong> Tại phần "Quy tắc
                        tính toán", hãy thiết lập các tỷ lệ (Giữ lại 5%,
                        VAT 8%...) để hệ thống tự động tính toán ở các
                        bước sau.
                      </li>
                    </ul>
                  </div>

                  <div class="list-group-item p-4">
                    <h5 class="mb-1 text-info text-dark">
                      <span class="badge bg-info text-dark rounded-pill me-2">3</span>
                      Tính toán Chi tiết CPC (Tab Chi tiết)
                    </h5>
                    <p class="mb-2 text-muted">
                      Thay vì nhập tay số tổng, hãy để hệ thống tính toán
                      lũy kế cho bạn.
                    </p>
                    <ul class="mb-0 small">
                      <li>
                        Chuyển sang tab
                        <strong class="text-dark"><i class="fas fa-table"></i> Chi tiết
                          CPC</strong>.
                      </li>
                      <li>
                        Sử dụng bộ lọc để chọn đúng Hợp đồng vừa tạo.
                      </li>
                      <li>
                        Nhập số liệu vào các ô nét đứt (Work-done kỳ này,
                        Tạm ứng...). Hệ thống sẽ tự động tính: <br /><code>Đề nghị TT = Workdone + Tạm ứng + Hoàn ứng +
                                Giữ lại</code>
                      </li>
                      <li>
                        Sau khi số liệu đúng, nhấn vào biểu tượng máy bay
                        <i class="fas fa-paper-plane text-danger"></i> ở
                        cột <strong>CPC No</strong> để "bắn" dữ liệu sang
                        bảng theo dõi.
                      </li>
                    </ul>
                  </div>

                  <div class="list-group-item p-4 bg-light">
                    <h5 class="mb-1 text-warning text-dark">
                      <span class="badge bg-warning text-dark rounded-pill me-2">4</span>
                      Theo dõi & Thanh toán (Tab Tracking)
                    </h5>
                    <p class="mb-2 text-muted">
                      Nơi quản lý dòng tiền thực tế.
                    </p>
                    <ul class="mb-0 small">
                      <li>
                        Chuyển sang tab
                        <strong class="text-dark"><i class="fas fa-clipboard-list"></i> Theo dõi
                          CPC</strong>. Bạn sẽ thấy CPC vừa "bắn" sang từ Bước 3.
                      </li>
                      <li>
                        Nhấn vào cột
                        <strong>Số tiền đã trả (Amount Paid)</strong> để
                        nhập các lần chuyển tiền thực tế (Installments).
                      </li>
                      <li>
                        Nhập <strong>Ngày thanh toán</strong> và
                        <strong>Nguồn tiền</strong>. Trạng thái sẽ tự đổi
                        màu (Xanh/Đỏ/Vàng) dựa trên hạn thanh toán.
                      </li>
                    </ul>
                  </div>

                  <div class="list-group-item p-4">
                    <h5 class="mb-1 text-secondary">
                      <span class="badge bg-secondary rounded-pill me-2">5</span>
                      Quản lý Bảo lãnh (Optional)
                    </h5>
                    <p class="mb-2 text-muted">
                      Kiểm soát rủi ro pháp lý.
                    </p>
                    <ul class="mb-0 small">
                      <li>
                        Tại dòng CPC ở tab Theo dõi, nhấn nút
                        <strong><i class="fas fa-shield-alt"></i> Bond</strong>.
                      </li>
                      <li>
                        Khai báo các bảo lãnh liên quan (Tạm ứng, Thực
                        hiện HĐ, Bảo hành) và ngày hết hạn.
                      </li>
                      <li>
                        Hệ thống sẽ hiện chấm đỏ trên quả chuông
                        <i class="fas fa-bell"></i> nếu có bảo lãnh sắp
                        hết hạn.
                      </li>
                    </ul>
                  </div>

                  <div class="list-group-item p-4 border-start border-5 border-danger">
                    <h5 class="mb-1 text-danger">
                      <span class="badge bg-danger rounded-pill me-2">6</span>
                      Sao lưu Dữ liệu (Bắt buộc)
                    </h5>
                    <p class="mb-2">
                      Đây là thao tác quan trọng nhất để không bị mất
                      việc.
                    </p>
                    <div class="d-flex gap-2">
                      <button class="btn btn-outline-secondary btn-sm pe-none">
                        <i class="fas fa-save"></i> Sao lưu
                      </button>
                      <div class="small align-self-center">
                        &larr; Nhấn nút này ở góc trên bên phải màn hình
                        vào <strong>cuối mỗi ngày làm việc</strong>. File
                        <code>.json</code> tải về chính là "bảo hiểm" cho
                        dữ liệu của bạn.
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div v-if="activeHelpTopic === 'shortcuts'">
                <h4>
                  <i class="fas fa-keyboard fa-fw me-2 text-primary"></i>
                  Phím tắt & Thao tác Nâng cao
                </h4>
                <p>
                  Sử dụng phím tắt giúp bạn thao tác nhanh hơn gấp nhiều
                  lần so với dùng chuột.
                </p>

                <h6 class="mt-4 text-success">
                  <i class="fas fa-keyboard me-2"></i>Phím tắt Hệ thống
                </h6>
                <div class="table-responsive">
                  <table class="table table-bordered table-hover table-sm mb-0"
                    style="table-layout: fixed; width: 100%">
                    <thead class="table-light">
                      <tr>
                        <th style="width: 18%">Phím tắt</th>
                        <th style="width: 57%">Chức năng</th>
                        <th style="width: 25%">Phạm vi</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td><code>Ctrl + I</code></td>
                        <td>
                          Mở <strong>Command Palette</strong> (Tìm kiếm
                          toàn cục: CPC, Hợp đồng, NCC...)
                        </td>
                        <td>Toàn bộ hệ thống</td>
                      </tr>
                      <tr>
                        <td><code>Alt + A</code></td>
                        <td>
                          Mở <strong>Menu Hành động Nhanh</strong> (Thêm
                          mới CPC, Hợp đồng, Bond...)
                        </td>
                        <td>Toàn bộ hệ thống</td>
                      </tr>
                      <tr>
                        <td><code>Alt + S</code></td>
                        <td>
                          Bật chế độ
                          <strong>Điều hướng Sidebar</strong> (Dùng mũi
                          tên Lên/Xuống để chuyển Tab và Enter để chọn)
                        </td>
                        <td>Toàn bộ hệ thống</td>
                      </tr>
                      <tr>
                        <td><code>Alt + F</code></td>
                        <td>
                          Ẩn / Hiện bảng <strong>Bộ lọc</strong> (Filter
                          Panel)
                        </td>
                        <td>Các màn hình chính</td>
                      </tr>
                      <tr>
                        <td><code>Alt + N</code></td>
                        <td>
                          Mở danh sách <strong>Thông báo</strong> Bảo lãnh
                          quá hạn (Dùng Tab để điều hướng và Enter để
                          chọn)
                        </td>
                        <td>Toàn bộ hệ thống</td>
                      </tr>
                      <tr>
                        <td><code>Alt + C</code></td>
                        <td>
                          <strong>Xóa tất cả bộ lọc</strong> đang áp dụng
                        </td>
                        <td>Các màn hình chính</td>
                      </tr>
                      <tr>
                        <td>
                          <code>Alt + &larr;</code> / <code>&rarr;</code>
                        </td>
                        <td>
                          Chuyển trang (<strong>Pagination</strong>) Trước
                          / Sau
                        </td>
                        <td>Các bảng dữ liệu</td>
                      </tr>
                      <tr>
                        <td><code>/</code> (Phím Gạch chéo)</td>
                        <td>
                          Nhảy nhanh vào ô <strong>Tìm kiếm</strong> (Tìm
                          kiếm toàn cục)
                        </td>
                        <td>Tab Theo dõi CPC, Dữ liệu nguồn</td>
                      </tr>
                      <tr>
                        <td><code>Alt + P</code></td>
                        <td>
                          Mở bộ lọc nhanh <strong>Dự án</strong> (Điều
                          hướng bằng mũi tên Lên/Xuống, chọn bằng nút
                          Space, thoát bằng Enter/Esc)
                        </td>
                        <td>Tab Theo dõi CPC</td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <h6 class="mt-4 text-info">
                  <i class="fas fa-mouse me-2"></i>Thao tác Chuột Đặc biệt
                </h6>
                <div class="table-responsive">
                  <table class="table table-bordered table-hover table-sm" style="table-layout: fixed; width: 100%">
                    <thead class="table-light">
                      <tr>
                        <th style="width: 18%">Thao tác</th>
                        <th style="width: 57%">Chức năng</th>
                        <th style="width: 25%">Vị trí áp dụng</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>
                          <strong>Ctrl + Click</strong>
                          <div class="small text-muted">(vào dòng)</div>
                        </td>
                        <td>
                          Mở cửa sổ <strong>Chỉnh sửa</strong> (Edit) item
                          đó
                        </td>
                        <td>Tab Theo dõi CPC</td>
                      </tr>
                      <tr>
                        <td>
                          <strong>Alt + Click</strong>
                          <div class="small text-muted">(vào dòng)</div>
                        </td>
                        <td>
                          <strong>Sao chép</strong> (Copy) item đó thành
                          dòng mới
                        </td>
                        <td>Tab Theo dõi CPC</td>
                      </tr>
                      <tr>
                        <td>
                          <strong>Double Click</strong>
                        </td>
                        <td>
                          Sửa nhanh trực tiếp (Inline Edit) nội dung ô
                        </td>
                        <td>Cột "Theo dõi..." & "Ghi chú"</td>
                      </tr>
                      <tr>
                        <td>
                          <strong>Ctrl + Click</strong>
                          <div class="small text-muted">
                            (vào icon <i class="fas fa-paper-plane"></i>)
                          </div>
                        </td>
                        <td>
                          Gửi <strong>TẤT CẢ</strong> các CPC của hợp đồng
                          đó sang tab Theo dõi (Bulk Send)
                        </td>
                        <td>Tab Chi tiết CPC</td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <div class="alert alert-light border mt-3 p-2">
                  <strong><i class="fas fa-lightbulb text-warning me-1"></i>
                    Mẹo trong Ghi chú (Significant Payment Notes):</strong>
                  Dùng <kbd>Ctrl</kbd>+<kbd>B</kbd> để
                  <strong>in đậm</strong> và <kbd>Ctrl</kbd>+<kbd>S</kbd>
                  để <strong>Lưu</strong> ngay lập tức khi đang soạn thảo.
                </div>
              </div>

              <div v-if="activeHelpTopic === 'cpc-tracking'">
                <h4>
                  <i class="fas fa-clipboard-list fa-fw me-2 text-primary"></i>
                  Tab: Theo dõi CPC - Hướng dẫn Chuyên sâu
                </h4>
                <p>
                  Đây là màn hình trung tâm của ứng dụng, nơi bạn quản lý
                  danh sách tất cả các hồ sơ thanh toán (CPC) từ lúc tiếp
                  nhận đến khi hoàn tất chi trả.
                </p>

                <div class="alert alert-info">
                  <h5><i class="fas fa-bolt me-2"></i> Thao tác Nhanh</h5>
                  <ul class="mb-0">
                    <li>
                      <strong>Thêm mới:</strong> Nhấn nút
                      <strong>"Thêm CPC"</strong> hoặc dùng phím tắt
                      <code>Alt + A</code> &rarr; <code>Enter</code>.
                    </li>
                    <li>
                      <strong>Tìm kiếm:</strong> Nhấn phím
                      <code>/</code> (Gạch chéo) để nhảy ngay vào ô tìm
                      kiếm.
                    </li>
                    <li>
                      <strong>Sửa chi tiết:</strong> Giữ
                      <code>Ctrl</code> + Click vào dòng bất kỳ để mở cửa
                      sổ chỉnh sửa.
                    </li>
                  </ul>
                </div>

                <h5 class="mt-4 text-success">
                  <i class="fas fa-list-ul me-2"></i> Các Tính năng Chính
                </h5>

                <div class="accordion" id="cpcTrackingAccordion">
                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button class="accordion-button" type="button" data-bs-toggle="collapse"
                        data-bs-target="#track-inline">
                        <strong>1. Sửa nhanh trực tiếp (Inline Edit)</strong>
                      </button>
                    </h2>
                    <div id="track-inline" class="accordion-collapse collapse show"
                      data-bs-parent="#cpcTrackingAccordion">
                      <div class="accordion-body">
                        <p>
                          Bạn không cần mở cửa sổ chi tiết để cập nhật
                          tiến độ hồ sơ. Tại danh sách, hãy
                          <strong>Nhấp đúp chuột (Double-click)</strong>
                          vào:
                        </p>
                        <ul>
                          <li>
                            Cột
                            <strong>Theo dõi trình ký (Line Tracking)</strong>: Để cập nhật hồ sơ đang ở đâu (VD: "18/11
                            PRC trình GMD/freecash", "Done/Chưa cấp
                            room"...).
                          </li>
                          <li>
                            Cột <strong>Ghi chú (Notes)</strong>: Để thêm
                            các ghi chú nhanh.
                          </li>
                        </ul>
                        <p>
                          <em>Sau khi sửa xong, nhấn <code>Enter</code> để
                            lưu hoặc <code>Esc</code> để hủy.</em>
                        </p>
                      </div>
                    </div>
                  </div>

                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#track-status">
                        <strong>2. Logic Trạng thái & Màu sắc (Cột
                          Status)</strong>
                      </button>
                    </h2>
                    <div id="track-status" class="accordion-collapse collapse" data-bs-parent="#cpcTrackingAccordion">
                      <div class="accordion-body">
                        <p>
                          Hệ thống tự động tính toán trạng thái dựa trên
                          <strong>Hạn thanh toán (Due Date)</strong>,
                          <strong>Số tiền đã trả</strong> và
                          <strong>Hình thức thanh toán (Tiền mặt/SWAP)</strong>:
                        </p>
                        <div class="table-responsive">
                          <table class="table table-sm table-bordered text-center align-middle">
                            <thead class="table-light">
                              <tr>
                                <th style="width: 30%">Trạng thái</th>
                                <th style="width: 20%">Màu sắc</th>
                                <th>Ý nghĩa</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr>
                                <td><strong>Complete</strong></td>
                                <td>
                                  <span class="badge bg-success">Xanh lá</span>
                                </td>
                                <td>
                                  Đã thanh toán đủ 100% giá trị CPC.
                                </td>
                              </tr>
                              <tr>
                                <td><strong>Partial Payment</strong></td>
                                <td>
                                  <span class="badge bg-warning text-dark">Vàng</span>
                                </td>
                                <td>Đã thanh toán một phần, chưa hết.</td>
                              </tr>

                              <tr>
                                <td><strong>Partial SWAP</strong></td>
                                <td>
                                  <span class="badge bg-info text-dark">Xanh dương nhạt</span>
                                </td>
                                <td>
                                  CPC có phát sinh giao dịch cấn trừ
                                  (SWAP) nhưng chưa thanh toán hết tổng
                                  giá trị.
                                </td>
                              </tr>
                              <tr>
                                <td>
                                  <strong>Partial SWAP Payment</strong>
                                </td>
                                <td>
                                  <span class="badge bg-info text-dark">Xanh dương nhạt</span>
                                  <i class="fas fa-exchange-alt ms-1"></i>
                                </td>
                                <td>Thanh toán một phần khoản SWAP.</td>
                              </tr>
                              <tr>
                                <td>
                                  <strong>Complete SWAP Payment</strong>
                                </td>
                                <td>
                                  <span class="badge bg-success">Xanh lá</span>
                                  <i class="fas fa-check-double ms-1"></i>
                                </td>
                                <td>
                                  Đã thanh toán đủ 100% giá trị CPC, trong
                                  đó có bao gồm thanh toán 100% khoản
                                  SWAP.
                                </td>
                              </tr>

                              <tr>
                                <td><strong>Overdue</strong></td>
                                <td>
                                  <span class="badge bg-danger">Đỏ</span>
                                </td>
                                <td>
                                  Chưa thanh toán xong và đã quá hạn (Ngày
                                  hiện tại > Due Date).
                                </td>
                              </tr>
                              <tr>
                                <td><strong>Due Today</strong></td>
                                <td>
                                  <span class="badge bg-due-today">Cam đậm</span>
                                </td>
                                <td>Hạn thanh toán là hôm nay.</td>
                              </tr>
                              <tr>
                                <td><strong>Pending</strong></td>
                                <td>
                                  <span class="badge bg-primary">Xanh dương</span>
                                </td>
                                <td>
                                  Chưa đến hạn thanh toán (Còn X ngày).
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                        <div class="alert alert-light border mt-2 small">
                          <i class="fas fa-info-circle text-info me-1"></i>
                          <strong>Lưu ý về SWAP:</strong> Để đạt trạng
                          thái <em>Complete SWAP Payment</em>, bạn cần
                          tích chọn vào ô "Đã thanh toán SWAP" (SWAP Paid)
                          trong cửa sổ chi tiết thanh toán.
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#track-payment">
                        <strong>3. Nhập Thanh toán & Tài chính</strong>
                      </button>
                    </h2>
                    <div id="track-payment" class="accordion-collapse collapse" data-bs-parent="#cpcTrackingAccordion">
                      <div class="accordion-body">
                        <p>
                          Nhấn vào nút
                          <strong>Sửa (Hình bút chì
                            <i class="bi bi-pencil-square"></i>)</strong>
                          hoặc số tiền tại cột
                          <strong>Amount Paid</strong> để mở cửa sổ tài
                          chính:
                        </p>
                        <ul>
                          <li>
                            <strong>Nhiều đợt thanh toán:</strong> Một CPC
                            có thể được trả làm nhiều lần. Nhấn "Thêm đợt"
                            để ghi nhận từng lần chuyển tiền.
                          </li>
                          <li>
                            <strong>Cấn trừ (SWAP):</strong> Nếu thanh
                            toán bằng cách cấn trừ công nợ, hãy tích vào ô
                            <strong>SWAP</strong>. Hệ thống sẽ yêu cầu
                            nhập thêm thông tin đối tác 3 bên.
                          </li>
                          <li>
                            <strong>USD:</strong> Nếu thanh toán bằng
                            ngoại tệ, tích chọn
                            <strong>Pay in USD</strong> và nhập tỷ giá. Hệ
                            thống sẽ tự quy đổi ra VND để báo cáo.
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>

                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#track-expand">
                        <strong>4. Sao chép & Xem Lịch sử</strong>
                      </button>
                    </h2>
                    <div id="track-expand" class="accordion-collapse collapse" data-bs-parent="#cpcTrackingAccordion">
                      <div class="accordion-body">
                        <ul>
                          <li>
                            <strong>Sao chép (Copy):</strong> Dùng khi
                            muốn copy 1 CPC có thông tin tương tự. Nhấn
                            nút <i class="bi bi-files text-info"></i> để
                            tạo bản sao với đầy đủ thông tin Hợp đồng, Dự
                            án, chỉ cần sửa lại số tiền và nội dung.
                          </li>
                          <li>
                            <strong>Xem lịch sử (Expand):</strong> Nếu CPC
                            có nhiều đợt thanh toán, nút
                            <i class="fas fa-chevron-down"></i> sẽ xuất
                            hiện ở cột "More Info". Nhấn vào để xem chi
                            tiết lịch sử trả tiền ngay trên lưới mà không
                            cần mở cửa sổ.
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="alert alert-light border mt-3">
                  <strong><i class="fas fa-lightbulb text-warning"></i> Mẹo tìm
                    kiếm nâng cao:</strong>
                  Bạn có thể kết hợp bộ lọc (Filter Panel) và ô tìm kiếm.
                  Ví dụ: Lọc Project "Dự án A" trước, sau đó gõ tên nhà
                  cung cấp vào ô tìm kiếm để tìm nhanh hơn.
                </div>
              </div>

              <div v-if="activeHelpTopic === 'cpc-details'">
                <h4>
                  <i class="fas fa-file-alt fa-fw me-2 text-primary"></i>
                  Tab: Chi tiết CPC - Hướng dẫn Chuyên sâu
                </h4>
                <p>
                  Đây là trái tim của việc quản lý giá trị thanh toán. Nó
                  hoạt động như một bảng tính Excel thông minh, tự động
                  tính toán các logic phức tạp (Khấu trừ tạm ứng, Giữ lại,
                  VAT...) cho từng dòng công việc.
                </p>

                <div class="alert alert-info">
                  <h5>
                    <i class="fas fa-stream me-2"></i> Quy trình làm việc
                    chuẩn
                  </h5>
                  <ol class="mb-0">
                    <li>
                      <strong>Lọc Hợp đồng:</strong> Chọn lần lượt
                      <code>Dự án</code> &rarr;
                      <code>Nhà cung cấp</code> &rarr; Chọn
                      <code>Hợp đồng</code> cụ thể.
                    </li>
                    <li>
                      <strong>Nhập liệu:</strong> Điền số liệu vào các ô
                      có viền nét đứt (Work-done, Advance, Retention...).
                    </li>
                    <li>
                      <strong>Gửi dữ liệu:</strong> Nhấn icon
                      <i class="fas fa-paper-plane text-primary"></i> để
                      đẩy số liệu tổng hợp sang tab
                      <strong>Theo dõi CPC</strong>.
                    </li>
                    <li>
                      <strong>Đối chiếu:</strong> Sau khi nhập thanh toán
                      ở tab Theo dõi, quay lại đây để xem dòng tiền được
                      phân bổ tự động vào cột Payment.
                    </li>
                  </ol>
                </div>

                <h5 class="mt-4 text-success">
                  <i class="fas fa-star me-2"></i> Các Tính năng & Logic
                  Tính toán
                </h5>

                <div class="accordion" id="cpcDetailsAccordion">
                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button class="accordion-button" type="button" data-bs-toggle="collapse"
                        data-bs-target="#detail-calcs">
                        <strong>1. Cơ chế Tự động Tính toán</strong>
                      </button>
                    </h2>
                    <div id="detail-calcs" class="accordion-collapse collapse show"
                      data-bs-parent="#cpcDetailsAccordion">
                      <div class="accordion-body">
                        <ul>
                          <li>
                            <strong>Amount Due (Số tiền đề nghị):</strong>
                            Tự động =
                            <em>Work-done + Advance + Repayment + Retention
                              + Other Deduction</em>.
                          </li>
                          <li>
                            <strong>VAT:</strong> Tự động tính theo % (Mặc
                            định 8% hoặc 10%). Có thể sửa tay số tiền hoặc
                            thay đổi % VAT bằng nút
                            <strong>(Change %)</strong> trên tiêu đề.
                          </li>
                          <li>
                            <strong>Repayment (Thu hồi tạm ứng):</strong>
                            Tự động tính dựa trên % Work-done lũy kế và
                            ngưỡng thu hồi cấu hình trong Hợp đồng.
                          </li>
                          <li>
                            <strong class="text-primary">Footer Remaining (Dòng Tổng còn lại dưới
                              cùng):</strong>
                            <br /><em>Lưu ý quan trọng: Các số liệu này phản ánh
                              công nợ thực tế đến thời điểm hiện tại.</em>
                            <ul>
                              <li>
                                <strong>Cột Advance (Dư Tạm ứng):</strong>
                                <br /><code>= Tổng Tạm ứng thực chi - Tổng Khấu trừ
                                        (Repayment)</code>
                                <br /><span class="text-danger small"><i class="fas fa-exclamation-circle"></i>
                                  Chỉ lấy Repayment trên các dòng đã nhập
                                  <strong>Ngày hạch toán (Posting Date)</strong>
                                  của Hóa đơn. Dùng để áp dụng cho các
                                  trường hợp đã nhận CPC và đã nhập dữ
                                  liệu Repayment trên CPC nhưng NCC chưa
                                  xuất hóa đơn.</span>
                              </li>
                              <li>
                                <strong>Cột Remaining Payable (Phải
                                  trả):</strong>
                                <br /><code>= (Tổng Hóa đơn - Tổng Đã thanh toán) +
                                        Dư Tạm ứng</code>
                                <br /><span class="text-danger small"><i class="fas fa-exclamation-circle"></i>
                                  Tương tự, chỉ tính trên các dòng đã có
                                  <strong>Ngày hạch toán</strong> (Hóa đơn
                                  đã về).</span>
                              </li>
                            </ul>
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>

                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#detail-sync">
                        <strong>2. Liên kết Dữ liệu & Logic Thanh toán</strong>
                      </button>
                    </h2>
                    <div id="detail-sync" class="accordion-collapse collapse" data-bs-parent="#cpcDetailsAccordion">
                      <div class="accordion-body">
                        <p>
                          Tab này và tab "Theo dõi CPC" liên kết chặt chẽ
                          với nhau:
                        </p>
                        <table class="table table-sm table-bordered">
                          <thead class="table-light">
                            <tr>
                              <th style="width: 30%">Trường hợp</th>
                              <th>Hành động & Kết quả</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr>
                              <td><strong>Gửi dữ liệu</strong></td>
                              <td>
                                Nhấn
                                <i class="fas fa-paper-plane text-primary"></i>
                                tại cột <strong>CPC No</strong> để tạo/cập
                                nhật dòng CPC tương ứng bên tab
                                <strong>Theo dõi CPC</strong>.
                              </td>
                            </tr>
                            <tr>
                              <td><strong>CPC Âm (Cấn trừ)</strong></td>
                              <td>
                                Khi CPC có giá trị Âm (do Repayment >
                                Work-done):
                                <br />Bên tab Theo dõi, hãy nhập số tiền
                                thanh toán là số
                                <strong>DƯƠNG (+)</strong>. Hệ thống hiểu
                                đây là số tiền đã được
                                <strong>Cấn trừ (Offset)</strong> thành
                                công.
                              </td>
                            </tr>
                            <tr>
                              <td>
                                <strong>CPC 0 Đồng (Hoàn tất)</strong>
                              </td>
                              <td>
                                Nếu CPC có giá trị bằng 0 (ví dụ: hồ sơ
                                quyết toán không phát sinh thanh toán):
                                <br />Bên tab Theo dõi, hãy nhập
                                <strong>Số tiền = 0</strong> và điền đầy
                                đủ <strong>Ngày thanh toán</strong>.
                                <br />&rarr; Hệ thống sẽ ghi nhận CPC này
                                là
                                <span class="badge bg-success">Complete (Offset)</span>
                                và đã hoàn thành nghĩa vụ.
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>

                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#detail-actions">
                        <strong>3. Thao tác Dòng & Cột nâng cao</strong>
                      </button>
                    </h2>
                    <div id="detail-actions" class="accordion-collapse collapse" data-bs-parent="#cpcDetailsAccordion">
                      <div class="accordion-body">
                        <ul>
                          <li>
                            <strong>Thêm/Xóa dòng:</strong> Rê chuột vào
                            cột đầu tiên (Contract Info), bạn sẽ thấy nút
                            <i class="fas fa-plus-circle text-success"></i>
                            (Thêm dòng dưới) và
                            <i class="fas fa-trash-alt text-danger"></i>
                            (Xóa dòng).
                          </li>
                          <li>
                            <strong>Ẩn/Hiện cột:</strong> Sử dụng nút
                            <strong>"Các cột"</strong> và
                            <strong>"Các cột con"</strong> ở góc trên bên
                            phải để tùy biến giao diện.
                          </li>
                          <li>
                            <strong>Gửi hàng loạt (Bulk Send):</strong>
                            Giữ phím <code>Ctrl</code> và nhấn vào biểu
                            tượng máy bay
                            <i class="fas fa-paper-plane"></i> để cập nhật
                            <strong>TẤT CẢ</strong> các CPC của hợp đồng
                            này sang tab Theo dõi cùng lúc.
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>

                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#detail-notes">
                        <strong>4. Ghi chú & Điều khoản (Significant
                          Notes)</strong>
                      </button>
                    </h2>
                    <div id="detail-notes" class="accordion-collapse collapse" data-bs-parent="#cpcDetailsAccordion">
                      <div class="accordion-body">
                        <p>
                          Bên cạnh tên hợp đồng ở phần header, có nút
                          <strong class="text-info"><i class="fas fa-sticky-note"></i>
                            Xem/Sửa</strong>. Tính năng này dùng để:
                        </p>
                        <ul>
                          <li>
                            Lưu các điều khoản thanh toán quan trọng của
                            hợp đồng (tiến độ, phạt, bảo hành...).
                          </li>
                          <li>
                            <strong>Hỗ trợ nhiều Tab:</strong> Bạn có thể
                            tạo nhiều tab ghi chú (ví dụ: "HĐ Chính", "PL
                            01"...) để quản lý thông tin rõ ràng hơn.
                          </li>
                          <li>
                            Nội dung ghi chú hỗ trợ định dạng cơ bản (In
                            đậm, xuống dòng) và tự động lưu.
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>

                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#detail-invoice">
                        <strong>5. Nhập Hóa đơn từ XML</strong>
                      </button>
                    </h2>
                    <div id="detail-invoice" class="accordion-collapse collapse" data-bs-parent="#cpcDetailsAccordion">
                      <div class="accordion-body">
                        <p>Bạn không cần nhập tay từng hóa đơn:</p>
                        <ol>
                          <li>
                            Nhấn vào ô tại cột
                            <strong>Invoice No</strong>.
                          </li>
                          <li>
                            Trong cửa sổ hiện ra, nhấn nút
                            <strong>"Tải từ XML"</strong>.
                          </li>
                          <li>
                            Chọn file hóa đơn điện tử (.xml). Hệ thống sẽ
                            tự động điền Số hóa đơn, Ngày, Giá trị trước
                            thuế và VAT.
                          </li>
                          <li>
                            Nếu hóa đơn áp dụng cho nhiều dòng CPC, bạn có
                            thể tích chọn các dòng muốn phân bổ.
                          </li>
                        </ol>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="alert alert-warning mt-3 border-warning">
                  <strong><i class="fas fa-exclamation-triangle"></i> Lưu ý
                    quan trọng về Hợp đồng USD:</strong>
                  <ul class="mb-0 mt-1">
                    <li>
                      Nếu hợp đồng là <strong>USD</strong>, bạn có thể
                      nhấn nút
                      <strong>"Xem theo VND" (View as VND)</strong> để quy
                      đổi hiển thị.
                    </li>
                    <li>
                      <strong>Chế độ Chỉ Đọc:</strong> Khi đang ở chế độ
                      "Xem theo VND", bảng tính sẽ bị
                      <strong>VÔ HIỆU HÓA (Disabled)</strong>. Bạn không
                      thể chỉnh sửa, thêm dòng hay xóa dòng. Điều này nhằm
                      đảm bảo tính toàn vẹn của dữ liệu gốc USD.
                    </li>
                    <li>
                      Để chỉnh sửa, vui lòng nhấn nút chuyển lại về chế độ
                      <strong>View as USD</strong>.
                    </li>
                  </ul>
                </div>
              </div>

              <div v-if="activeHelpTopic === 'data-management'">
                <h4>
                  <i class="fas fa-database fa-fw me-2 text-primary"></i>
                  Quản lý Dữ liệu & Bảo trì Hệ thống
                </h4>

                <div class="alert alert-danger border-danger">
                  <h5>
                    <i class="fas fa-radiation-alt me-2"></i> CẢNH BÁO
                    QUAN TRỌNG: CƠ CHẾ LƯU TRỮ
                  </h5>
                  <p class="mb-0">
                    Ứng dụng này hoạt động theo cơ chế
                    <strong>Offline-First</strong> (Lưu trực tiếp vào
                    trình duyệt web của bạn). <br /><strong>DỮ LIỆU SẼ BỊ MẤT VĨNH VIỄN NẾU:</strong>
                  </p>
                  <ul class="mb-0 mt-2">
                    <li>
                      Bạn xóa Lịch sử duyệt web / Bộ nhớ đệm (Cache) của
                      trình duyệt.
                    </li>
                    <li>Bạn cài lại Windows hoặc trình duyệt web.</li>
                    <li>
                      Bạn sử dụng Chế độ Ẩn danh (Incognito/Private) và
                      tắt trình duyệt.
                    </li>
                  </ul>
                </div>

                <div class="alert alert-success">
                  <strong><i class="fas fa-shield-alt me-2"></i> Giải pháp an
                    toàn:</strong>
                  Hãy tạo thói quen nhấn nút
                  <strong>"Sao lưu ra File"</strong> (.json) vào cuối mỗi
                  ngày làm việc hoặc sau mỗi lần nhập liệu lớn. File JSON
                  này là "bảo hiểm" duy nhất cho dữ liệu của bạn.
                </div>

                <div class="accordion" id="dataMgmtAccordion">
                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button class="accordion-button" type="button" data-bs-toggle="collapse"
                        data-bs-target="#data-backup">
                        <strong>1. Sao lưu & Phục hồi (Backup &
                          Restore)</strong>
                      </button>
                    </h2>
                    <div id="data-backup" class="accordion-collapse collapse show" data-bs-parent="#dataMgmtAccordion">
                      <div class="accordion-body">
                        <ul>
                          <li>
                            <strong>Sao lưu ra File (.json):</strong>
                            Nút này xuất toàn bộ cơ sở dữ liệu (Dự án, Hợp
                            đồng, CPC, Bảo lãnh...) ra một file văn bản.
                            <br /><em>Khác với "Xuất Excel":</em> Excel
                            chỉ dùng để báo cáo, còn file JSON dùng để
                            khôi phục lại hệ thống nguyên vẹn.
                          </li>
                          <li>
                            <strong>Phục hồi từ File:</strong>
                            Dùng để nạp lại dữ liệu từ file .json đã sao
                            lưu.
                            <br /><strong class="text-danger">Lưu ý:</strong>
                            Hành động này sẽ <strong>GHI ĐÈ</strong> toàn
                            bộ dữ liệu hiện có trên trình duyệt bằng dữ
                            liệu trong file.
                          </li>
                          <li>
                            <strong>Sao lưu/Nhập riêng Dự án:</strong>
                            Nút "Backup Project" và "Import Project" cho
                            phép bạn chia sẻ dữ liệu của
                            <strong>một dự án cụ thể</strong> cho đồng
                            nghiệp mà không ảnh hưởng đến các dự án khác.
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>

                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#data-repair">
                        <strong>2. Kiểm tra & Sửa chữa Dữ liệu (Check &
                          Repair)</strong>
                      </button>
                    </h2>
                    <div id="data-repair" class="accordion-collapse collapse" data-bs-parent="#dataMgmtAccordion">
                      <div class="accordion-body">
                        <p>
                          Nút
                          <strong><i class="fas fa-sync-alt text-info"></i>
                            Kiểm tra & Sửa chữa Dữ liệu</strong>
                          nằm ở tab <em>Master Data &rarr; Dự án</em>.
                        </p>
                        <p><strong>Khi nào cần dùng?</strong></p>
                        <ul>
                          <li>
                            Sau khi bạn nhập dữ liệu lớn từ Excel
                            (Import).
                          </li>
                          <li>
                            Sau khi bạn sửa tên Dự án hoặc đổi Nhà cung
                            cấp của một Hợp đồng cũ.
                          </li>
                          <li>
                            Khi thấy báo cáo hiển thị không đúng (Ví dụ:
                            Lọc theo Dự án A nhưng không thấy CPC của nó).
                          </li>
                        </ul>
                        <p>
                          <strong>Nó làm gì?</strong> Nó quét toàn bộ hệ
                          thống để đảm bảo các mục con (CPC, Thanh toán,
                          Bảo lãnh) luôn có thông tin
                          <code>Project</code> và <code>Vendor</code> khớp
                          chính xác với Hợp đồng cha của chúng.
                        </p>
                      </div>
                    </div>
                  </div>

                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#data-cleanup">
                        <strong>3. Dọn dẹp Dữ liệu Mồ côi (Cleanup Orphan
                          Data)</strong>
                      </button>
                    </h2>
                    <div id="data-cleanup" class="accordion-collapse collapse" data-bs-parent="#dataMgmtAccordion">
                      <div class="accordion-body">
                        <p>
                          Nút
                          <strong><i class="fas fa-broom text-warning"></i> Dọn
                            dẹp Dữ liệu</strong>
                          giúp tối ưu hóa hệ thống.
                        </p>
                        <p>
                          <strong>Dữ liệu mồ côi là gì?</strong> Là những
                          dữ liệu rác còn sót lại khi xóa không triệt để.
                          Ví dụ: Một đợt thanh toán còn tồn tại nhưng CPC
                          cha của nó đã bị xóa.
                        </p>
                        <p>
                          Chức năng này sẽ liệt kê tất cả các trường hợp
                          rác và cho phép bạn xóa chúng đi để làm nhẹ dữ
                          liệu và tránh lỗi tính toán.
                        </p>
                      </div>
                    </div>
                  </div>

                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#data-import">
                        <strong>4. Chiến lược Nhập liệu từ Excel</strong>
                      </button>
                    </h2>
                    <div id="data-import" class="accordion-collapse collapse" data-bs-parent="#dataMgmtAccordion">
                      <div class="accordion-body">
                        <p>
                          Hệ thống hỗ trợ nhiều cổng nhập liệu Excel khác
                          nhau. Hãy dùng đúng cổng:
                        </p>
                        <table class="table table-sm table-bordered">
                          <thead class="table-light">
                            <tr>
                              <th>Vị trí nút Import</th>
                              <th>Mục đích sử dụng</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr>
                              <td>Tab <strong>Theo dõi CPC</strong></td>
                              <td>
                                Nhập dữ liệu hàng loạt: Tạo mới CPC, Hợp
                                đồng và các đợt thanh toán cùng lúc. (Dùng
                                template <code>cpc_upload...</code>)
                              </td>
                            </tr>
                            <tr>
                              <td>Tab <strong>Master Data</strong></td>
                              <td>
                                Khởi tạo danh sách Nhà cung cấp, Dự án
                                hoặc Hạng mục báo cáo ban đầu.
                              </td>
                            </tr>
                            <tr>
                              <td>Tab <strong>Chi tiết CPC</strong></td>
                              <td>
                                Cập nhật chi tiết lũy kế (Work-done,
                                Advance...) cho
                                <strong>một hợp đồng cụ thể</strong>.
                              </td>
                            </tr>
                            <tr>
                              <td>Tab <strong>Bảo lãnh</strong></td>
                              <td>
                                Nhập danh sách các bảo lãnh ngân hàng cần
                                theo dõi.
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div v-if="activeHelpTopic === 'excel-templates'">
                <h4>
                  <i class="fas fa-file-excel fa-fw me-2 text-primary"></i>
                  Hướng dẫn Import Excel
                </h4>
                <p>
                  Luôn tải file mẫu (Template) mới nhất từ ứng dụng trước
                  khi nhập liệu.
                </p>

                <div class="accordion" id="excelAccordion">
                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button class="accordion-button" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseOne">
                        1. Template Tổng hợp (Nhập CPC & Hợp đồng)
                      </button>
                    </h2>
                    <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#excelAccordion">
                      <div class="accordion-body">
                        <ul>
                          <li>
                            <strong>Sheet CPC_Main:</strong> Chứa thông
                            tin chính. Cột <code>contractNo</code> và
                            <code>cpc</code> là bắt buộc để liên kết.
                          </li>
                          <li>
                            <strong>Sheet Installments:</strong> Chứa các
                            đợt thanh toán. Phải khớp mã hợp đồng và số
                            CPC với sheet chính.
                          </li>
                          <li>
                            <strong>Sheet Bonds:</strong> Nhập bảo lãnh.
                            Cột <code>bondNumber</code> là duy nhất.
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>
                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseTwo">
                        2. Template Chi tiết (Nhập Work-done/Advance)
                      </button>
                    </h2>
                    <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#excelAccordion">
                      <div class="accordion-body">
                        <p>
                          Dùng cho tab <strong>Chi tiết CPC</strong>. Tải
                          template này <em>sau khi</em> đã chọn một hợp
                          đồng cụ thể. Nó giúp bạn nhập nhanh các số liệu
                          lũy kế, % thanh toán, v.v.
                        </p>
                      </div>
                    </div>
                  </div>
                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseThree">
                        3. Template Master Data (NCC, Dự án)
                      </button>
                    </h2>
                    <div id="collapseThree" class="accordion-collapse collapse" data-bs-parent="#excelAccordion">
                      <div class="accordion-body">
                        <p>
                          Dùng để khởi tạo nhanh danh sách Nhà cung cấp
                          hoặc Dự án ban đầu.
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div v-if="activeHelpTopic === 'other-dashboards'">
                <h4>
                  <i class="fas fa-chart-pie fa-fw me-2 text-primary"></i>
                  Hệ thống Báo cáo & Phân tích (Dashboards)
                </h4>
                <p>
                  Ngoài việc theo dõi từng CPC, hệ thống cung cấp các góc
                  nhìn tổng hợp (Helicopter view) giúp bạn kiểm soát dòng
                  tiền, công nợ và rủi ro pháp lý.
                </p>

                <div class="accordion" id="dashboardsAccordion">
                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button class="accordion-button" type="button" data-bs-toggle="collapse"
                        data-bs-target="#dash-vendor">
                        <strong>1. Cân đối Công nợ NCC (Vendor Balance)</strong>
                      </button>
                    </h2>
                    <div id="dash-vendor" class="accordion-collapse collapse show"
                      data-bs-parent="#dashboardsAccordion">
                      <div class="accordion-body">
                        <p>
                          Đây là báo cáo quan trọng nhất để đối chiếu với
                          bộ phận Kế toán. Nó tổng hợp số liệu từ tất cả
                          hợp đồng của từng Nhà cung cấp.
                        </p>
                        <ul>
                          <li>
                            <strong>GL 3311 (Phải trả):</strong> Số tiền
                            bạn còn nợ NCC (Dựa trên Hóa đơn đã nhận - Số
                            tiền đã trả).
                          </li>
                          <li>
                            <strong>GL 3312 (Tạm ứng):</strong> Số tiền
                            bạn đã ứng trước nhưng chưa thu hồi (Dựa trên
                            Tiền đã trả - Khấu trừ hoàn ứng).
                          </li>
                          <li>
                            <strong>Tính năng "Debug":</strong> Nếu thấy
                            số liệu nghi ngờ, hãy nhấn nút
                            <span class="badge bg-warning text-dark"><i class="fas fa-bug"></i> Debug</span>
                            và nhập mã NCC, tiếp tục nhấn F12 để hiển thị
                            thông tin truy vết. Hệ thống sẽ "truy vết" và
                            in ra Console chi tiết từng phép cộng trừ để
                            bạn kiểm tra.
                          </li>
                          <li>
                            <strong>Đối chiếu Excel:</strong> Nhấn nút
                            <strong>"Tải lên & Đối chiếu"</strong> để
                            upload file xuất từ SAP/Phần mềm kế toán. Hệ
                            thống sẽ tự động so sánh và tô màu đỏ các dòng
                            bị lệch.
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>

                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#dash-payment">
                        <strong>2. Bảng điều khiển Thanh toán
                          (Cashflow)</strong>
                      </button>
                    </h2>
                    <div id="dash-payment" class="accordion-collapse collapse" data-bs-parent="#dashboardsAccordion">
                      <div class="accordion-body">
                        <p>Nơi xem lịch sử dòng tiền ra chi tiết nhất.</p>
                        <ul>
                          <li>
                            <strong>Khác biệt với CPC Tracking:</strong>
                            Tab CPC Tracking nhóm tiền theo Hồ sơ. Tab này
                            "rã" hồ sơ ra thành từng lần chuyển tiền riêng
                            lẻ.
                          </li>
                          <li>
                            <strong>Bộ lọc ngày:</strong> Mặc định lọc từ
                            đầu đến cuối tháng hiện tại. Rất hữu ích để
                            trả lời câu hỏi:
                            <em>"Trong tháng 10 chúng ta đã chi bao nhiêu
                              tiền cho Dự án A?"</em>.
                          </li>
                          <li>
                            <strong>Nguồn thanh toán:</strong> Theo dõi
                            dòng tiền đi từ nguồn nào.
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>

                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#dash-bond">
                        <strong>3. Quản lý Bảo lãnh (Bond Dashboard)</strong>
                      </button>
                    </h2>
                    <div id="dash-bond" class="accordion-collapse collapse" data-bs-parent="#dashboardsAccordion">
                      <div class="accordion-body">
                        <p>
                          Giúp kiểm soát rủi ro pháp lý về các chứng thư
                          bảo lãnh.
                        </p>
                        <ul>
                          <li>
                            <strong>Cảnh báo màu sắc:</strong> <br /><span class="badge bg-danger">Đỏ</span>
                            Quá hạn. <br /><span class="badge bg-warning text-dark">Vàng</span>
                            Sắp hết hạn (trong 30 ngày). <br /><span class="badge bg-primary">Xanh</span>
                            Còn hiệu lực.
                          </li>
                          <li>
                            <strong>Gia hạn (Renew):</strong> Nhấn nút
                            <i class="fas fa-redo text-primary"></i> để
                            ghi nhận việc gia hạn. Hệ thống sẽ lưu lại
                            lịch sử các lần gia hạn của bảo lãnh đó.
                          </li>
                          <li>
                            <strong>Quyết toán nhanh (Quick Settle):</strong>
                            Khi hợp đồng kết thúc hoặc đã hoàn ứng xong,
                            gạt nút <strong>Quick Settle</strong> để tắt
                            cảnh báo cho bảo lãnh đó.
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>

                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#dash-report">
                        <strong>4. Báo cáo Phân tích (Report Dashboard)</strong>
                      </button>
                    </h2>
                    <div id="dash-report" class="accordion-collapse collapse" data-bs-parent="#dashboardsAccordion">
                      <div class="accordion-body">
                        <p>
                          Báo cáo quản trị cấp cao, gom nhóm chi phí theo
                          Cấu trúc Hạng mục (Cost Categories).
                        </p>
                        <ul>
                          <li>
                            <strong>Cấu trúc cây:</strong> Dữ liệu được
                            tổng hợp từ Hợp đồng &rarr; Hạng mục con
                            (Level 2) &rarr; Hạng mục cha (Level 1).
                          </li>
                          <li>
                            <strong>Tính đến ngày (As of Date):</strong>
                            Tính năng mạnh mẽ cho phép bạn "quay ngược
                            thời gian" để xem số liệu lũy kế tại một thời
                            điểm trong quá khứ.
                          </li>
                          <li>
                            <strong>Paid in Month:</strong> Cột này hiển
                            thị dòng tiền thực chi trong tháng được chọn,
                            giúp báo cáo tình hình thực hiện kế hoạch
                            tháng.
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>

                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#dash-others">
                        <strong>5. Các Dashboard khác (Hợp đồng, SWAP,
                          COGS)</strong>
                      </button>
                    </h2>
                    <div id="dash-others" class="accordion-collapse collapse" data-bs-parent="#dashboardsAccordion">
                      <div class="accordion-body">
                        <ul>
                          <li>
                            <strong>Hợp đồng (Contract):</strong> Danh
                            sách tổng thể tất cả hợp đồng, tổng giá trị,
                            tổng đã thanh toán và trạng thái (Đóng/Mở).
                          </li>
                          <li>
                            <strong>SWAP:</strong> Chuyên theo dõi các
                            giao dịch cấn trừ công nợ 3 bên. Phân loại rõ
                            đâu là khoản Phải thu (Receivable) và Phải trả
                            (Payable).
                          </li>
                          <li>
                            <strong>COGS (Giá vốn):</strong> Dành cho mục
                            đích kiểm toán. Đối chiếu doanh thu/chi phí
                            ghi nhận trên App với số liệu Giá vốn (Cost of
                            Goods Sold) trên hệ thống tài chính theo từng
                            tài khoản GL.
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="alert alert-light border mt-3">
                  <strong><i class="fas fa-lightbulb text-warning me-1"></i>
                    Mẹo:</strong>
                  Tất cả các Dashboard đều hỗ trợ xuất ra Excel (<i class="fas fa-file-export"></i>) để bạn có thể làm
                  báo cáo tùy chỉnh thêm nếu cần.
                </div>
              </div>

              <div v-if="activeHelpTopic === 'faq'">
                <h4>
                  <i class="fas fa-question-circle fa-fw me-2 text-primary"></i>
                  Câu hỏi Thường gặp
                </h4>
                <div class="accordion">
                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#faq-1">
                        <strong>H:</strong> Làm sao để chuyển dữ liệu sang
                        máy khác?
                      </button>
                    </h2>
                    <div id="faq-1" class="accordion-collapse collapse">
                      <div class="accordion-body">
                        <strong>Đ:</strong> Dùng nút "Sao lưu ra File"
                        (.json) trên máy cũ, gửi file đó sang máy mới và
                        dùng nút "Phục hồi từ File".
                      </div>
                    </div>
                  </div>
                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#faq-2">
                        <strong>H:</strong> Tại sao tôi không xóa được Dự
                        án/NCC?
                      </button>
                    </h2>
                    <div id="faq-2" class="accordion-collapse collapse">
                      <div class="accordion-body">
                        <strong>Đ:</strong> Hệ thống chặn xóa nếu Dự
                        án/NCC đó đang được sử dụng trong một Hợp đồng nào
                        đó. Hãy xóa Hợp đồng liên quan trước hoặc dùng
                        chức năng
                        <strong>Dọn dẹp Dữ liệu</strong> (Cleanup Data)
                        trong Master Data.
                      </div>
                    </div>
                  </div>
                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#faq-3">
                        <strong>H:</strong> Tôi nhập file Excel nhưng báo
                        lỗi "Orphaned"?
                      </button>
                    </h2>
                    <div id="faq-3" class="accordion-collapse collapse">
                      <div class="accordion-body">
                        <strong>Đ:</strong> Lỗi này nghĩa là bạn đang nhập
                        một đợt thanh toán (Installment) nhưng không tìm
                        thấy CPC cha tương ứng trong file hoặc trong hệ
                        thống. Hãy kiểm tra kỹ cột
                        <code>contractNo</code> và <code>cpc</code> cho
                        khớp nhau.
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            {{ t('btnClose') }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="contractDetailsModal" data-focus-ref="gridContractInfoInput" tabindex="-1">
    <div class="modal-dialog modal-sm custom-modal">
      <div class="modal-content" v-if="currentDetailItem" @keydown.ctrl.enter.prevent="saveContractDetails"
        @keydown.meta.enter.prevent="saveContractDetails"
        @keydown.ctrl.arrow-right.prevent="navigateDetailModal('next')"
        @keydown.meta.arrow-right.prevent="navigateDetailModal('next')"
        @keydown.ctrl.arrow-left.prevent="navigateDetailModal('prev')"
        @keydown.meta.arrow-left.prevent="navigateDetailModal('prev')">
        <div class="modal-header">
          <h5 class="modal-title">
            {{ t('modalTitleEditContractDetail') }}
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="d-flex flex-column gap-2 align-items-end">
            <div class="d-flex align-items-center flex-nowrap mb-2">
              <label class="me-2 text-end flex-shrink-0 fw-semibold text-muted" style="width: 120px">{{
                t('contractinfo') }}</label>
              <input type="text" class="form-control flex-grow-1" v-model="currentDetailItem.contractInfo"
                ref="gridContractInfoInput" />
            </div>

            <div class="d-flex align-items-center flex-nowrap mb-2">
              <label class="me-2 text-end flex-shrink-0 fw-semibold text-muted" style="width: 120px">{{ t('details')
                }}</label>
              <input type="text" class="form-control flex-grow-1" v-model="currentDetailItem.description" />
            </div>

            <div class="d-flex align-items-center flex-nowrap mb-2">
              <label class="me-2 text-end flex-shrink-0 fw-semibold text-muted" style="width: 120px">{{ t('amount')
                }}</label>
              <input type="text" class="form-control flex-grow-1 text-end"
                :value="formatNumber(currentDetailItem.contractAmount)"
                @input="formatNumericInput($event, 'contractAmount')" />
            </div>

            <div class="d-flex align-items-center flex-nowrap mb-2">
              <label class="me-2 text-end flex-shrink-0 fw-semibold text-muted" style="width: 120px">Von</label>
              <input type="text" class="form-control flex-grow-1 text-end"
                :value="formatNumber(currentDetailItem.contractVon)"
                @input="formatNumericInput($event, 'contractVon')" />
            </div>

            <div class="d-flex align-items-center flex-nowrap mb-2">
              <label class="me-2 text-end flex-shrink-0 fw-semibold text-muted" style="width: 120px">Vat</label>

              <button type="button" class="btn btn-link p-0 me-2 repayment-config-btn flex-shrink-0"
                @click="isContractVatOverrideVisible = !isContractVatOverrideVisible">
                <i class="fas" :class="isContractVatOverrideVisible ? 'fa-eye-slash' : 'fa-eye'"></i>
                ({{ isContractVatOverrideVisible ? t('hide') : t('change')
                }} %)
              </button>

              <input type="text" class="form-control flex-grow-1 text-end"
                :value="formatNumber(currentDetailItem.contractVat)"
                @input="formatManualCpcDetailInput($event, 'contractVat', 'isContractVatManual')"
                :disabled="isCurrentContractUSD" />
            </div>

            <div class="d-flex align-items-center flex-nowrap mb-2" v-if="isContractVatOverrideVisible">
              <label class="me-2 text-end flex-shrink-0 fw-semibold text-muted" style="width: 120px">% Vat</label>
              <input type="number" step="0.1" max="100" class="form-control flex-grow-1 text-end"
                v-model.number="currentDetailItem.contractPercentVat" :disabled="isCurrentContractUSD" />
            </div>

            <div class="d-flex align-items-center flex-nowrap mb-2">
              <label class="me-2 text-end flex-shrink-0 fw-semibold text-muted" style="width: 120px">{{ t('total')
                }}</label>
              <input type="text" class="form-control flex-grow-1 text-end bg-light"
                :value="formatNumber(currentDetailItem.contractTotal)" readonly />
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-danger me-auto" @click="clearContractDetails">
            {{ t('deleteContents') }}
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            {{ t('btnClose') }}
          </button>
          <button type="button" class="btn btn-primary" @click="saveContractDetails">
            {{ t('btnSaveChanges') }}
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="cpcDetailsModal" data-focus-ref="gridCpcNoInput" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content" v-if="currentDetailItem" @keydown.ctrl.enter.prevent="saveCpcDetails"
        @keydown.meta.enter.prevent="saveCpcDetails">
        <div class="modal-header">
          <h5 class="modal-title">{{ t('modalTitleEditCpcDetail') }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body" v-if="currentDetailItem">
          <div class="row g-3 mb-3">
            <div class="col-md-3">
              <label class="form-label small fw-bold">CPC No</label>
              <input type="text" class="form-control" v-model="currentDetailItem.cpcNo" ref="gridCpcNoInput" />
            </div>
            <div class="col-md-3">
              <label class="form-label small fw-bold">Due Date</label>
              <input type="date" class="form-control" v-model="currentDetailItem.cpcDueDate" />
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <div class="form-check form-switch mb-2">
                <input class="form-check-input" type="checkbox" role="switch" id="isFinalSettlementCheck"
                  v-model="currentDetailItem.isFinalSettlement" />
                <label class="form-check-label small fw-bold text-primary" for="isFinalSettlementCheck">Quyết toán
                  (Final)</label>
              </div>
            </div>
            <div class="col-md-3">
              <label class="form-label small fw-bold text-secondary">Work-done gốc (Giá trị HT)</label>
              <div class="input-group">
                <input type="text" class="form-control text-end bg-light fw-bold"
                  :value="formatNumber(currentDetailItem.cpcWorkDone)"
                  @input="formatNumericInput($event, 'cpcWorkDone')" />
                <span class="input-group-text small bg-light">{{ isCurrentContractUSD ? '$' : '₫' }}</span>
              </div>
            </div>
          </div>

          <div class="row g-0 mb-3 rounded-3 overflow-hidden border shadow-sm">
            <div class="col-md-6 p-3 bg-primary-subtle border-end border-primary-subtle">
              <div class="d-flex align-items-center mb-2">
                <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-2"
                  style="width: 24px; height: 24px">
                  <i class="fas fa-file-invoice-dollar style font-size: 12px;"></i>
                </div>
                <h6 class="mb-0 fw-bold text-primary">
                  Payment of Work-done
                </h6>
              </div>
              <div class="row g-2">
                <div class="col-4">
                  <label class="small text-muted mb-1">% PoW</label>
                  <input type="number" step="0.1" class="form-control form-control-sm text-center border-primary-subtle"
                    v-model.number="currentDetailItem.cpcPercentPoW" />
                </div>
                <div class="col-8">
                  <label class="small text-muted mb-1">Giá trị thanh toán khối lượng</label>
                  <div class="input-group input-group-sm">
                    <input type="text" class="form-control text-end fw-bold border-primary-subtle"
                      :value="formatNumber(currentDetailItem.cpcPaymentOfWorkdone)"
                      @input="formatManualCpcDetailInput($event, 'cpcPaymentOfWorkdone', 'isPoWManual')" />
                    <span class="input-group-text border-primary-subtle bg-white">{{ isCurrentContractUSD ? '$' : '₫'
                      }}</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-md-6 p-3" style="background-color: #eef2ff">
              <div class="d-flex align-items-center mb-2">
                <div class="rounded-circle bg-indigo text-white d-flex align-items-center justify-content-center me-2"
                  style="
                          width: 24px;
                          height: 24px;
                          background-color: #6366f1;
                        ">
                  <i class="fas fa-hand-holding-heart style font-size: 12px;"></i>
                </div>
                <h6 class="mb-0 fw-bold" style="color: #4338ca">
                  Advance (Tạm ứng)
                </h6>
              </div>
              <div class="row g-2">
                <div class="col-4">
                  <label class="small text-muted mb-1">% Adv</label>
                  <input type="number" step="0.1" max="100" class="form-control form-control-sm text-center"
                    style="border-color: #c7d2fe" v-model.number="currentDetailItem.cpcPercentAdv" />
                </div>
                <div class="col-8">
                  <label class="small text-muted mb-1">Giá trị tạm ứng đợt này</label>
                  <div class="input-group input-group-sm">
                    <input type="text" class="form-control text-end fw-bold" style="border-color: #c7d2fe"
                      :value="formatNumber(currentDetailItem.cpcAdvance)"
                      @input="formatManualCpcDetailInput($event, 'cpcAdvance', 'isAdvanceManual')" />
                    <span class="input-group-text bg-white" style="border-color: #c7d2fe">{{ isCurrentContractUSD ? '$'
                      : '₫' }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <label class="form-label small fw-bold mb-0">Repayment (Hoàn ứng)</label>
                <div class="d-flex gap-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" v-model="currentDetailItem.useWorkdoneForRepayment"
                      id="useWorkdoneForRepaymentCheck" />
                    <label class="form-check-label small" for="useWorkdoneForRepaymentCheck">Tính trên Work-done</label>
                  </div>
                  <button type="button" class="btn btn-link p-0 small text-decoration-none"
                    @click="showRepaymentBasisConfig = !showRepaymentBasisConfig">
                    <i class="fas fa-cog me-1"></i> Cấu hình cơ sở
                  </button>
                </div>
              </div>
              <div class="input-group">
                <input type="text" class="form-control text-end text-danger fw-bold"
                  :value="formatNumber(currentDetailItem.cpcRepayment)"
                  @input="formatManualCpcDetailInput($event, 'cpcRepayment', 'isRepaymentManual')" />
                <span class="input-group-text">{{ isCurrentContractUSD ? '$' : '₫' }}</span>
              </div>

              <div v-if="showRepaymentBasisConfig" class="repayment-basis-container">
                <div class="basis-toolbar">
                  <span class="small fw-bold text-secondary">
                    <i class="fas fa-list-check me-1"></i> Cơ sở tính khấu
                    trừ
                  </span>
                  <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-primary py-0" @click="toggleAllRepaymentBasis(true)">
                      <i class="fas fa-check-double me-1"></i> Chọn hết
                    </button>
                    <button type="button" class="btn btn-outline-secondary py-0"
                      @click="toggleAllRepaymentBasis(false)">
                      <i class="fas fa-times me-1"></i> Bỏ chọn
                    </button>
                  </div>
                </div>

                <div class="basis-header-row">
                  <span></span>
                  <span>Dòng</span>
                  <span>Nội dung</span>
                  <span class="text-end">Contract</span>
                  <span class="text-end">VON</span>
                </div>

                <div class="basis-scroll-area">
                  <div v-for="basis in availableRepaymentBasis" :key="basis.id" class="basis-row"
                    :class="{ 'selected': basis.isChecked }" @click="toggleRepaymentBasis(basis.id)">
                    <div class="text-center">
                      <input class="form-check-input m-0" type="checkbox" :checked="basis.isChecked" />
                    </div>
                    <div class="text-center">
                      <span class="badge bg-light text-dark border">#{{ basis.index }}</span>
                    </div>
                    <div class="basis-label" :title="basis.info">
                      {{ basis.info }}
                    </div>
                    <div class="basis-value text-contract">
                      {{ formatNumber(basis.contractAmount) }}
                    </div>
                    <div class="basis-value text-von">
                      {{ formatNumber(basis.contractVon) }}
                    </div>
                  </div>

                  <div v-if="availableRepaymentBasis.length === 0" class="p-4 text-center text-muted small italic">
                    <i class="fas fa-folder-open d-block mb-2 fa-2x opacity-20"></i>
                    Chưa có dòng nào có giá trị Contract/VON để tính toán.
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <label class="form-label small fw-bold">Retention (Giữ lại bảo hành)</label>
              <div class="input-group">
                <input type="text" class="form-control text-end text-danger"
                  :value="formatNumber(currentDetailItem.cpcRetention)"
                  @input="formatNumericInput($event, 'cpcRetention')" />
                <span class="input-group-text bg-light">{{ isCurrentContractUSD ? '$' : '₫' }}</span>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label small fw-bold">Other deduction (Giảm trừ khác)</label>
              <div class="input-group">
                <input type="text" class="form-control text-end text-danger"
                  :value="formatNumber(currentDetailItem.cpcOtherDeduction)"
                  @input="formatNumericInput($event, 'cpcOtherDeduction')" />
                <span class="input-group-text bg-light">{{ isCurrentContractUSD ? '$' : '₫' }}</span>
              </div>
            </div>
          </div>

          <div class="row g-3 p-3 rounded-3 bg-dark text-white shadow-lg mx-0">
            <div class="col-md-6">
              <label class="form-label small fw-bold text-info">Amount Due (Số tiền đề nghị)</label>
              <div class="input-group">
                <input type="text"
                  class="form-control form-control-lg text-end bg-transparent text-white border-info fw-bolder"
                  :value="formatNumber(currentDetailItem.cpcAmountDue)" readonly />
                <span class="input-group-text bg-info border-info text-white fw-bold">{{ isCurrentContractUSD ? '$' :
                  '₫' }}</span>
              </div>
            </div>
            <div class="col-md-6">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <label class="form-label small fw-bold text-info">VAT</label>
                <button v-if="!isCurrentContractUSD" type="button"
                  class="btn btn-link btn-sm p-0 text-info text-decoration-none"
                  @click="isVatOverrideVisible = !isVatOverrideVisible">
                  <i class="fas fa-edit me-1"></i> % VAT
                </button>
                <span v-else class="badge bg-secondary opacity-50">N/A (USD)</span>
              </div>
              <div class="d-flex gap-2">
                <input v-if="isVatOverrideVisible && !isCurrentContractUSD" v-focus type="number" step="0.1"
                  class="form-control border-info bg-transparent text-white text-center" style="width: 80px"
                  v-model.number="currentDetailItem.cpcPercentVat" />
                <div class="input-group">
                  <input type="text" class="form-control form-control-lg text-end bg-transparent fw-bolder"
                    :class="isCurrentContractUSD ? 'text-secondary border-secondary' : 'text-white border-info'"
                    :value="formatNumber(currentDetailItem.cpcVat)" @input="formatNumericInput($event, 'cpcVat', true)"
                    :disabled="isCurrentContractUSD" />
                  <span class="input-group-text border-info text-white fw-bold"
                    :class="isCurrentContractUSD ? 'bg-secondary border-secondary' : 'bg-info border-info'">{{
                    isCurrentContractUSD ? '$' : '₫' }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-danger me-auto" @click="clearCpcDetails">
            {{ t('deleteContents') }}
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            {{ t('btnClose') }}
          </button>
          <button type="button" class="btn btn-primary" @click="saveCpcDetails">
            {{ t('btnSaveChanges') }}
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="paymentDetailsModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content" v-if="currentDetailItem" @keydown.ctrl.enter.prevent="saveInvoiceDetails"
        @keydown.meta.enter.prevent="saveInvoiceDetails">
        <div class="modal-header">
          <h5 class="modal-title">
            {{ t('modalTitleEditPaymentDetail') }}
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">...</div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="invoiceDetailsModal" data-focus-ref="gridInvoiceNoInput" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content" v-if="currentDetailItem" @keydown.ctrl.enter.prevent="saveInvoiceDetails"
        @keydown.meta.enter.prevent="saveInvoiceDetails">
        <div class="modal-header">
          <h5 class="modal-title">
            {{ t('modalTitleEditInvoiceDetail') }}
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div v-if="invoiceCpcRows.length > 1" class="mb-3 p-3 border rounded bg-light">
            <h6 class="mb-2">{{ t('distributeToCpcRows') }}</h6>
            <div class="repayment-basis-config">
              <div v-for="row in invoiceCpcRows" :key="row.id" class="form-check small">
                <input class="form-check-input" type="checkbox" :value="row.id" :id="'inv-row-' + row.id"
                  v-model="invoiceSelectedRowIds" :disabled="row.id === currentDetailItem.id" />
                <label class="form-check-label" :for="'inv-row-' + row.id">
                  {{ t('row') }} #{{ getRowIndex(row.id) + 1 }}: {{
                  row.contractInfo }} (Work-done: {{
                  formatNumber(row.cpcWorkDone) }})
                </label>
              </div>
            </div>
          </div>
          <div class="row g-3">
            <div class="col-md-12">
              <label class="form-label">No.</label><input type="text" class="form-control"
                v-model="currentDetailItem.invoiceNo" ref="gridInvoiceNoInput" />
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ t('date') }}</label><input type="date" class="form-control"
                v-model="currentDetailItem.invoiceDate" />
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ t('postingDate') }}</label><input type="date" class="form-control"
                v-model="currentDetailItem.invoicePostingDate" ref="invoicePostingDateInput" />
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ t('net') }}</label><input type="text" class="form-control text-end"
                :value="formatNumber(currentDetailItem.invoiceAmount)"
                @input="formatNumericInput($event, 'invoiceAmount')" />
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ t('vat') }}</label><input type="text" class="form-control text-end"
                :value="formatNumber(currentDetailItem.invoiceVat)" @input="formatNumericInput($event, 'invoiceVat')"
                :disabled="isCurrentContractUSD" />
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ t('total') }}</label><input type="text"
                class="form-control text-end bg-light" :value="formatNumber(currentDetailItem.invoiceTotal)" readonly />
            </div>
            <div class="col-md-6" v-if="isCurrentContractUSD">
              <label class="form-label">{{ t('invoiceExchangeRate') }}</label><input type="text"
                class="form-control text-end" :value="formatNumber(currentDetailItem.invoiceExchangeRate)"
                @input="formatNumericInput($event, 'invoiceExchangeRate')" />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-danger me-auto" @click="clearInvoiceDetails">
            {{ t('deleteContents') }}
          </button>
          <input type="file" ref="invoiceXmlInput" @change="handleInvoiceXmlUpload" accept=".xml"
            style="display: none" />
          <button type="button" class="btn btn-outline-primary" @click="triggerInvoiceXmlUpload">
            <i class="fas fa-upload me-2"></i> {{ t('loadFromXml') }}
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            {{ t('btnClose') }}
          </button>
          <button type="button" class="btn btn-primary" @click="saveInvoiceDetails">
            {{ t('btnSaveChanges') }}
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="statusUpdateModal" tabindex="-1" aria-labelledby="statusUpdateModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" v-if="currentStatusUpdate">
        <div class="modal-header">
          <h5 class="modal-title" id="statusUpdateModalLabel">
            {{ t('updateContractStatus') }}
          </h5>
          <button type="button" class="btn-close" @click="closeStatusUpdateModal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form @submit.prevent="saveStatusUpdate" @keydown.ctrl.enter.prevent="saveStatusUpdate"
            @keydown.meta.enter.prevent="saveStatusUpdate">
            <div class="mb-3">
              <label for="contractStatusSelect" class="form-label">{{ t('status') }}</label><select class="form-select"
                id="contractStatusSelect" v-model="currentStatusUpdate.status">
                <option value="Active">{{ t('active') }}</option>
                <option value="Closed">{{ t('closed') }}</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="statusNote" class="form-label">{{ t('statusNote') }}</label><textarea class="form-control"
                id="statusNote" rows="3" v-model="currentStatusUpdate.statusNote"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" @click="closeStatusUpdateModal">
            {{ t('btnClose') }}</button><button type="button" class="btn btn-primary" @click="saveStatusUpdate">
            {{ t('btnSaveChanges') }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="vendorManagementModal" tabindex="-1" aria-labelledby="vendorModalLabel" aria-hidden="true"
    data-focus-ref="vendorNameInput">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" v-if="currentEditVendor">
        <div class="modal-header">
          <h5 class="modal-title" id="vendorModalLabel">
            {{ vendorModalMode === 'add' ? t('modalTitleAddVendor') :
            t('editVendor') }}
          </h5>
          <button type="button" class="btn-close" @click="closeVendorModal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form @submit.prevent="saveVendor" @keydown.ctrl.enter.prevent="saveVendor"
            @keydown.meta.enter.prevent="saveVendor">
            <div class="mb-3">
              <label for="vendorName" class="form-label">{{ t('vendor') }}</label>
              <input type="text" class="form-control" id="vendorName" v-model="currentEditVendor.name" required
                ref="vendorNameInput" />
            </div>
            <div class="mb-3">
              <label for="vendorAbbrName" class="form-label">{{ t('abbreviation') }}</label>
              <input type="text" class="form-control" id="vendorAbbrName" v-model="currentEditVendor.abbrName" />
            </div>
            <div class="mb-3">
              <label for="vendorNo" class="form-label">{{ t('vendorNo') }}</label>
              <input type="text" class="form-control" id="vendorNo" v-model="currentEditVendor.vendorNo" required />
            </div>
            <div class="col-md-6 mb-3">
              <label for="vendorContact" class="form-label">{{ t('contactPerson') }}</label>
              <input type="text" class="form-control" id="vendorContact" v-model="currentEditVendor.contactPerson">
            </div>
            <div class="col-md-6 mb-3">
              <label for="vendorPhone" class="form-label">{{ t('phoneNumber') }}</label>
              <input type="text" class="form-control" id="vendorPhone" v-model="currentEditVendor.phoneNumber">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" @click="closeVendorModal">
            {{ t('btnClose') }}
          </button>
          <button type="button" class="btn btn-primary" @click="saveVendor">
            {{ t('btnSaveChanges') }}
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="projectManagementModal" tabindex="-1" aria-labelledby="projectModalLabel"
    aria-hidden="true" data-focus-ref="projectNameInput">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" v-if="currentEditProject">
        <div class="modal-header">
          <h5 class="modal-title" id="projectModalLabel">
            {{ projectModalMode === 'add' ? t('btnAddProject') :
            t('editProject') }}
          </h5>
          <button type="button" class="btn-close" @click="closeProjectModal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form @submit.prevent="saveProject" @keydown.ctrl.enter.prevent="saveProject"
            @keydown.meta.enter.prevent="saveProject">
            <div class="mb-3">
              <label for="projectName" class="form-label">{{ t('project') }}</label>
              <input type="text" class="form-control" id="projectName" v-model="currentEditProject.name" required
                ref="projectNameInput" />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" @click="closeProjectModal">
            {{ t('btnClose') }}
          </button>
          <button type="button" class="btn btn-primary" @click="saveProject">
            {{ t('btnSaveChanges') }}
          </button>
        </div>
      </div>
    </div>
  </div>
  <transition name="fade-scale">
    <div v-if="isQuickMenuOpen" class="quick-action-menu-container no-print" @click.self="toggleQuickMenu(false)">
      <div class="quick-action-backdrop"></div>
      <div class="quick-action-menu">
        <div v-for="(item, index) in quickMenuItems" :key="item.action" class="quick-action-item"
          :class="{ 'active': activeQuickMenuIndex === index }" @click="executeQuickMenuAction(item.action)"
          @mouseover="activeQuickMenuIndex = index">
          <div class="quick-action-icon">
            <i :class="item.icon"></i>
          </div>
          <div class="quick-action-label">{{ item.label }}</div>
        </div>
      </div>
    </div>
  </transition>
  <div class="modal fade" id="bondManagementModal" tabindex="-1" aria-labelledby="bondManagementModalLabel"
    aria-hidden="true" data-focus-ref="bondContractSearchInput">
    <div class="modal-dialog modal-lg">
      <div class="modal-content" v-if="currentEditBond">
        <div class="modal-header">
          <h5 class="modal-title" id="bondManagementModalLabel">
            {{ bondModalMode === 'add' ? t('btnAddBond') : t('btnEdit') +
            ' ' + t('bond') }}
          </h5>
          <button type="button" class="btn-close" @click="closeBondModal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form @submit.prevent="saveBond" @keydown.ctrl.enter.prevent="saveBond"
            @keydown.meta.enter.prevent="saveBond">
            <div class="row mb-3">
              <div class="col-md-12">
                <label for="bondContractSearch" class="form-label">{{ t('contract') }}</label>
                <div class="custom-dropdown-container">
                  <input type="text" class="form-control" id="bondContractSearch" ref="bondContractSearchInput"
                    autocomplete="off" v-model="bondContractSearchTerm" @focus="isBondContractDropdownVisible = true"
                    @blur="handleBondContractInputBlur" @keydown="navigateBondContracts"
                    :placeholder="bondModalMode === 'edit' ? '' : t('searchContracts')"
                    :disabled="bondModalMode === 'edit'" />
                  <ul v-if="isBondContractDropdownVisible && bondModalMode === 'add'" class="custom-dropdown-menu">
                    <li v-if="filteredBondContractsForModal.length === 0" class="dropdown-item-disabled">
                      {{ t('noMatchingData') }}
                    </li>
                    <li v-for="(contract, index) in filteredBondContractsForModal" :key="contract.id"
                      :class="{ 'active': index === activeBondContractIndex }"
                      @mousedown.prevent="selectBondContract(contract)">
                      <div class="vendor-item-name">
                        {{ contract.contractNo }}
                      </div>
                      <div class="vendor-item-abbr">
                        {{ vendors.find(v => v.id ===
                        contract.vendorId)?.name }}
                      </div>
                    </li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label for="bondNumber" class="form-label">{{ t('bondNumber') }}</label>
                <input type="text" class="form-control" id="bondNumber" v-model="currentEditBond.bondNumber" required />
              </div>
              <div class="col-md-6">
                <label for="bondType" class="form-label">{{ t('bondType') }}</label>
                <select class="form-select" id="bondType" v-model="currentEditBond.bondType">
                  <option value="">{{ t('selectBondType') }}</option>
                  <option :value="t('prepaymentBond')">
                    {{ t('prepaymentBond') }}
                  </option>
                  <option :value="t('performanceBond')">
                    {{ t('performanceBond') }}
                  </option>
                  <option :value="t('warrantyBond')">
                    {{ t('warrantyBond') }}
                  </option>
                </select>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-4">
                <label for="bondAmount" class="form-label">{{ t('amount') }}</label>
                <input type="text" class="form-control text-end" id="bondAmount" v-model="currentEditBond.displayAmount"
                  @input="formatCurrentBondAmount" />
              </div>
              <div class="col-md-4">
                <label for="bondIssueDate" class="form-label">{{ t('issueDate') }}</label>
                <input type="date" class="form-control" id="bondIssueDate" v-model="currentEditBond.issueDate" />
              </div>
              <div class="col-md-4">
                <label for="bondExpiryDate" class="form-label">{{ t('expiryDate') }}</label>
                <input type="date" class="form-control" id="bondExpiryDate" v-model="currentEditBond.expiryDate" />
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="issuingBank" class="form-label">{{ t('issuingBank') }}</label>
                <input type="text" class="form-control" id="issuingBank" v-model="currentEditBond.issuingBank" />
              </div>
              <div class="col-md-6">
                <label for="bondRef" class="form-label">{{ t('ref') }}</label>
                <input type="text" class="form-control" id="bondRef" v-model="currentEditBond.ref" />
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" @click="closeBondModal">
            {{ t('btnClose') }}
          </button>
          <button type="button" class="btn btn-primary" @click="saveBond">
            {{ t('btnSaveChanges') }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="projectBackupModal" tabindex="-1" aria-labelledby="projectBackupModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="projectBackupModalLabel">
            {{ t('modalTitleBackupProject') }}
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" :aria-label="t('btnClose')"></button>
        </div>
        <div class="modal-body">
          <p>{{ t('promptSelectProject') }}</p>
          <div class="mb-3">
            <label for="projectSelectBackup" class="form-label">{{ t('project') }}</label>
            <select class="form-select" id="projectSelectBackup" v-model="selectedProjectIdForBackup">
              <option :value="null" disabled>
                {{ t('promptSelectProject') }}
              </option>
              <option v-for="project in availableProjectsForBackup" :key="project.id" :value="project.id">
                {{ project.name }}
              </option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            {{ t('btnClose') }}
          </button>
          <button type="button" class="btn btn-primary" @click="exportSelectedProject"
            :disabled="!selectedProjectIdForBackup">
            <i data-lucide="download" class="me-2" style="width: 16px"></i>
            {{ t('btnExportJson') }}
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="validationErrorModal" tabindex="-1" aria-labelledby="validationErrorModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="validationErrorModalLabel">
            <i class="fas fa-exclamation-triangle me-2"></i> {{
            t('validationErrorTitle') }}
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
            :aria-label="t('btnClose')"></button>
        </div>
        <div class="modal-body">
          <p>{{ t('validationErrorIntro') }}</p>
          <table class="table table-sm table-bordered">
            <thead class="table-light">
              <tr>
                <th style="width: 15%">{{ t('validationSheet') }}</th>
                <th style="width: 10%">{{ t('validationRow') }}</th>
                <th>{{ t('validationMessage') }}</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="(error, index) in validationErrors" :key="index">
                <td><strong>{{ error.sheet }}</strong></td>
                <td>{{ error.row }}</td>
                <td v-html="error.message"></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            {{ t('btnClose') }}
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="categoryManagementModal" tabindex="-1" aria-labelledby="categoryModalLabel"
    aria-hidden="true" data-focus-ref="categoryCodeInput">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" v-if="currentEditCategory">
        <div class="modal-header">
          <h5 class="modal-title" id="categoryModalLabel">
            {{ categoryModalMode === 'add' ? t('categoryModalAddTitle') :
            t('categoryModalEditTitle') }}
          </h5>
          <button type="button" class="btn-close" @click="closeCategoryModal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form @submit.prevent="saveCategory" @keydown.ctrl.enter.prevent="saveCategory">
            <div class="mb-3">
              <label for="categoryParent" class="form-label">{{ t('categoryParentLabel') }}</label>
              <select class="form-select" id="categoryParent" v-model="currentEditCategory.parentCode">
                <option :value="null">
                  {{ t('categoryParentOption') }}
                </option>
                <option v-for="parent in levelOneCategories" :key="parent.id" :value="parent.code">
                  {{ parent.code }} - {{ parent.name_vi }}
                </option>
              </select>
            </div>
            <div class="mb-3">
              <label for="categoryCode" class="form-label">{{ t('categoryCodeLabel') }}</label>
              <input type="text" class="form-control" id="categoryCode" v-model="currentEditCategory.code" required
                ref="categoryCodeInput" :disabled="categoryModalMode === 'edit'" />
              <small class="form-text text-muted" v-if="categoryModalMode === 'edit'">{{ t('categoryCodeReadonly')
                }}</small>
            </div>
            <div class="mb-3">
              <label for="categoryNameVi" class="form-label">{{ t('categoryNameViLabel') }}</label>
              <input type="text" class="form-control" id="categoryNameVi" v-model="currentEditCategory.name_vi"
                required />
            </div>
            <div class="mb-3">
              <label for="categoryNameEn" class="form-label">{{ t('categoryNameEnLabel') }}</label>
              <input type="text" class="form-control" id="categoryNameEn" v-model="currentEditCategory.name_en" />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" @click="closeCategoryModal">
            {{ t('btnClose') }}
          </button>
          <button type="button" class="btn btn-primary" @click="saveCategory">
            {{ t('btnSaveChanges') }}
          </button>
        </div>
      </div>
    </div>
  </div>
  <div id="significantNotesModal" :class="{ 'is-visible': isNotesModalVisible }"
    :style="{ width: notesPanelWidth + 'px' }">
    <div class="resize-handle" @mousedown.prevent="startResize"></div>
    <div class="side-modal-header">
      <h5 class="side-modal-title">
        <i class="fas fa-sticky-note me-2"></i> {{
        t('significantNotesTitle') }}
      </h5>
      <button type="button" class="btn-close" @click="closeNotesModal"></button>
    </div>

    <div class="notes-tabs-container">
      <ul class="nav nav-tabs">
        <li class="nav-item" v-for="noteTab in currentContractNotes" :key="noteTab.id">
          <a class="nav-link" :class="{ active: activeNoteTabId === noteTab.id }" href="#"
            @click.prevent="activeNoteTabId = noteTab.id">
            <span v-if="editingTabId !== noteTab.id" @dblclick="startEditingTabTitle(noteTab)">{{ noteTab.title
              }}</span>
            <input v-else type="text" v-model="editingTabTitle" @blur="saveTabTitle"
              @keydown.enter.prevent="saveTabTitle" @keydown.esc.prevent="cancelEditingTabTitle"
              class="notes-tab-title-input" ref="tabTitleInput" />
            <button class="btn-close notes-tab-delete-btn" @click.stop.prevent="deleteNoteTab(noteTab)"></button>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" @click.prevent="addNewNoteTab" data-bs-toggle="tooltip" :title="t('addNoteTab')">
            <i class="fas fa-plus notes-tab-add-btn"></i>
          </a>
        </li>
      </ul>
    </div>

    <div class="side-modal-body p-0 d-flex flex-column">
      <div class="tab-content flex-grow-1" v-if="activeNote">
        <div class="tab-pane fade show active h-100 d-flex flex-column">
          <div v-if="!isNotesEditing" class="notes-display-area p-3 flex-grow-1"
            v-html="activeNote.content || `<i>${t('noNotesAvailable')}</i>`"></div>

          <div v-else class="d-flex flex-column h-100">
            <div class="editor-toolbar">
              <button class="editor-btn" @click.prevent="formatDoc('bold')" title="In đậm (Ctrl+B)">
                <i class="fas fa-bold"></i>
              </button>
              <button class="editor-btn" @click.prevent="formatDoc('italic')" title="In nghiêng">
                <i class="fas fa-italic"></i>
              </button>
              <button class="editor-btn" @click.prevent="formatDoc('underline')" title="Gạch chân">
                <i class="fas fa-underline"></i>
              </button>

              <div class="editor-separator"></div>

              <button class="editor-btn" @click.prevent="formatDoc('insertUnorderedList')" title="Danh sách chấm tròn">
                <i class="fas fa-list-ul"></i>
              </button>
              <button class="editor-btn" @click.prevent="formatDoc('insertOrderedList')" title="Danh sách số">
                <i class="fas fa-list-ol"></i>
              </button>

              <div class="editor-separator"></div>

              <button class="editor-btn" @click.prevent="formatTableAlign('left')" title="Căn trái (Table Cell)">
                <i class="fas fa-align-left"></i>
              </button>
              <button class="editor-btn" @click.prevent="formatTableAlign('center')" title="Căn giữa (Table Cell)">
                <i class="fas fa-align-center"></i>
              </button>
              <button class="editor-btn" @click.prevent="formatTableAlign('right')" title="Căn phải (Table Cell)">
                <i class="fas fa-align-right"></i>
              </button>
            </div>

            <div class="notes-edit-area flex-grow-1 p-3 bg-white">
              <div ref="notesEditor" contenteditable="true" class="h-100 outline-none" style="outline: none"
                @keydown="handleNotesKeystroke" @input="updateNotesContent" @blur="updateNotesContent"></div>
            </div>
          </div>
        </div>
      </div>
      <div v-else class="text-center text-muted p-5">
        {{ t('promptAddNoteTab') }}
      </div>
    </div>

    <div class="side-modal-footer">
      <button v-if="!isNotesEditing && activeNote" type="button" class="btn btn-primary" @click="toggleNotesEdit(true)">
        <i class="fas fa-edit me-2"></i> {{ t('btnEdit') }}
      </button>
      <button v-if="isNotesEditing" type="button" class="btn btn-secondary" @click="toggleNotesEdit(false)">
        {{ t('btnCancel') }}
      </button>
      <button v-if="isNotesEditing" type="button" class="btn btn-success" @click="saveNotes">
        <i class="fas fa-save me-2"></i> {{ t('btnSaveChanges') }}
      </button>
    </div>
  </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
</body>

<script>
  const databaseService = {
    db: null,

    initialize() {
      this.db = new Dexie("CPCVisionDB");

      this.db.version(1).stores({
        projects: "++id, &name",
        vendors: "++id, &vendorNo, name",
        contracts:
          "++id, &contractNo, projectId, vendorId, code, [projectId+vendorId]",
        cpcItems:
          "++id, cpcIdentifier, contractId, projectId, vendorId, code, receivedDate, paymentDueDate, [projectId+vendorId], [projectId+receivedDate]",
        installments:
          "++id, cpcId, contractId, projectId, vendorId, date, [projectId+date], [vendorId+date]",
        bonds:
          "++id, contractId, *cpcId, projectId, vendorId, expiryDate, bondNumber, isSettled, [isSettled+expiryDate], [projectId+expiryDate], [vendorId+expiryDate]",
        appState: "key",
        cpcDetailRows:
          "++id, id, contractId, cpcNo, invoicePostingDate, [contractId+invoicePostingDate]",
        banks: "++id, &name",
      });

      this.db
        .version(2)
        .stores({
          projects: "++id, &name",
          vendors: "++id, &vendorNo, name",
          contracts:
            "++id, &contractNo, projectId, vendorId, code, [projectId+vendorId]",
          cpcItems:
            "++id, cpcIdentifier, contractId, projectId, vendorId, code, receivedDate, paymentDueDate, projectName, vendorName, contractNo, [projectId+vendorId], [projectId+receivedDate], [vendorId+receivedDate]",
          installments:
            "++id, cpcId, contractId, projectId, vendorId, date, isSwap, [projectId+date], [vendorId+date], [contractId+date]",
          bonds:
            "++id, contractId, projectId, vendorId, expiryDate, bondNumber, isSettled, [isSettled+expiryDate], [projectId+expiryDate], [vendorId+expiryDate]",
          appState: "key",
          cpcDetailRows:
            "++id, id, contractId, cpcNo, invoicePostingDate, [contractId+invoicePostingDate]",
          banks: "++id, &name",
        })
        .upgrade(async (tx) => {
          console.log(
            "Upgrading database to version 2: Denormalizing data and preparing bonds table..."
          );

          await tx
            .table("bonds")
            .toCollection()
            .modify((bond) => {
              if (Array.isArray(bond.cpcId) && bond.cpcId.length > 0) {
                bond.cpcId = bond.cpcId[0];
              } else if (Array.isArray(bond.cpcId)) {
                delete bond.cpcId;
              }
            });

          const projects = await tx.table("projects").toArray();
          const vendors = await tx.table("vendors").toArray();
          const contracts = await tx.table("contracts").toArray();
          const projectMap = new Map(projects.map((p) => [p.id, p]));
          const vendorMap = new Map(vendors.map((v) => [v.id, v]));
          const contractMap = new Map(contracts.map((c) => [c.id, c]));
          await tx
            .table("cpcItems")
            .toCollection()
            .modify((cpc) => {
              const contract = contractMap.get(cpc.contractId);
              if (contract) {
                const project = projectMap.get(contract.projectId);
                const vendor = vendorMap.get(contract.vendorId);
                cpc.contractNo = contract.contractNo;
                if (project) cpc.projectName = project.name;
                if (vendor) cpc.vendorName = vendor.name;
              }
            });
          await tx
            .table("installments")
            .toCollection()
            .modify((inst) => {
              const contract = contractMap.get(inst.contractId);
              if (contract) {
                inst.projectId = contract.projectId;
                inst.vendorId = contract.vendorId;
              }
            });
          await tx
            .table("bonds")
            .toCollection()
            .modify((bond) => {
              const contract = contractMap.get(bond.contractId);
              if (contract) {
                bond.projectId = contract.projectId;
                bond.vendorId = contract.vendorId;
              }
            });
        });

      this.db.version(3).stores({
        projects: "++id, &name",
        vendors: "++id, &vendorNo, name",
        contracts:
          "++id, &contractNo, projectId, vendorId, code, [projectId+vendorId]",
        cpcItems:
          "++id, cpcIdentifier, contractId, projectId, vendorId, code, receivedDate, paymentDueDate, projectName, vendorName, contractNo, [projectId+vendorId], [projectId+receivedDate], [vendorId+receivedDate]",
        installments:
          "++id, cpcId, contractId, projectId, vendorId, date, isSwap, [projectId+date], [vendorId+date], [contractId+date]",
        bonds:
          "++id, contractId, cpcId, projectId, vendorId, expiryDate, bondNumber, isSettled, [isSettled+expiryDate], [projectId+expiryDate], [vendorId+expiryDate]",
        appState: "key",
        cpcDetailRows:
          "++id, id, contractId, cpcNo, invoicePostingDate, [contractId+invoicePostingDate]",
        banks: "++id, &name",
      });

      this.db
        .version(4)
        .stores({
          projects: "++id, &name",
          vendors: "++id, &vendorNo, name",
          contracts:
            "++id, &contractNo, projectId, vendorId, code, [projectId+vendorId]",
          cpcItems:
            "++id, cpcIdentifier, contractId, projectId, vendorId, code, receivedDate, paymentDueDate, [projectId+vendorId], [projectId+receivedDate], [vendorId+receivedDate]",
          installments:
            "++id, cpcId, contractId, projectId, vendorId, date, isSwap, [projectId+date], [vendorId+date], [contractId+date]",
          bonds:
            "++id, contractId, cpcId, projectId, vendorId, expiryDate, bondNumber, isSettled, [isSettled+expiryDate], [projectId+expiryDate], [vendorId+expiryDate]",
          appState: "key",
          cpcDetailRows:
            "++id, id, contractId, cpcNo, invoicePostingDate, [contractId+invoicePostingDate]",
          banks: "++id, &name",
        })
        .upgrade(async (tx) => {
          console.log(
            "Upgrading database to version 4: Normalizing schema by removing denormalized fields."
          );

          await tx
            .table("cpcItems")
            .toCollection()
            .modify((cpc) => {
              delete cpc.projectName;
              delete cpc.vendorName;
              delete cpc.vendorNameAbbr;
              delete cpc.vendorNo;
              delete cpc.contractNo;
            });

          console.log("Schema for 'cpcItems' has been normalized.");
        });

      this.db.version(5).stores({
        projects: "++id, &name",
        vendors: "++id, &vendorNo, name",
        contracts:
          "++id, &contractNo, projectId, vendorId, code, [projectId+vendorId]",
        cpcItems:
          "++id, cpcIdentifier, contractId, projectId, vendorId, code, receivedDate, paymentDueDate, [projectId+vendorId], [projectId+receivedDate], [vendorId+receivedDate]",
        installments:
          "++id, cpcId, contractId, projectId, vendorId, date, isSwap, [projectId+date], [vendorId+date], [contractId+date]",
        bonds:
          "++id, contractId, cpcId, projectId, vendorId, expiryDate, bondNumber, isSettled, [isSettled+expiryDate], [projectId+expiryDate], [vendorId+expiryDate]",
        appState: "key",
        cpcDetailRows:
          "++id, id, contractId, cpcNo, invoicePostingDate, [contractId+invoicePostingDate]",
        banks: "++id, &name",

        categories: "++id, &code, parentCode",
      });

      this.db.version(6).stores({
        projects: "++id, &name",
        vendors: "++id, &vendorNo, name",
        contracts: "++id, &contractNo, projectId, vendorId, code, [projectId+vendorId]",
        cpcItems: "++id, cpcIdentifier, contractId, projectId, vendorId, code, receivedDate, paymentDueDate, [projectId+vendorId], [projectId+receivedDate], [vendorId+receivedDate]",
        installments: "++id, cpcId, contractId, projectId, vendorId, date, isSwap, [projectId+date], [vendorId+date], [contractId+date]",
        bonds: "++id, contractId, cpcId, projectId, vendorId, expiryDate, bondNumber, isSettled, [isSettled+expiryDate], [projectId+expiryDate], [vendorId+expiryDate]",
        appState: "key",
        cpcDetailRows: "++id, id, contractId, cpcNo, invoicePostingDate, [contractId+invoicePostingDate]",
        banks: "++id, &name",
        categories: "++id, &code, parentCode",
      });
    },

    async getAllData() {
      if (!this.db) this.initialize();
      const data = {};
      await this.db.transaction("r", this.db.tables, async () => {
        for (const table of this.db.tables) {
          const tableName = table.name;
          if (!tableName.startsWith("_")) {
            data[tableName] = await table.toArray();
          }
        }
      });
      return data;
    },

    async saveAllData(appData) {
      if (!this.db) this.initialize();

      const sanitizedData = JSON.parse(JSON.stringify(appData));

      const tables = [
        "projects",
        "vendors",
        "banks",
        "contracts",
        "cpcItems",
        "installments",
        "bonds",
        "cpcDetailRows",
        "categories",
      ];

      return this.db.transaction("rw", this.db.tables, async () => {
        for (const tableName of tables) {
          if (this.db[tableName]) {
            await this.db[tableName].clear();

            const rows = sanitizedData[tableName];
            if (rows && Array.isArray(rows) && rows.length > 0) {
              await this.db[tableName].bulkAdd(rows);
            }
          }
        }
      });
    },

    async updateVendor(vendorData) {
      return this.db.vendors.put(vendorData);
    },

    async updateProject(projectData) {
      return this.db.projects.put(projectData);
    },

    async updateContract(contractData) {
      return this.db.transaction(
        "rw",
        this.db.contracts,
        this.db.cpcItems,
        this.db.installments,
        this.db.bonds,
        async () => {
          await this.db.contracts.put(contractData);

          const childModifications = {
            projectId: contractData.projectId,
            vendorId: contractData.vendorId,
          };

          await this.db.cpcItems
            .where("contractId")
            .equals(contractData.id)
            .modify(childModifications);

          await this.db.installments
            .where("contractId")
            .equals(contractData.id)
            .modify(childModifications);

          await this.db.bonds
            .where("contractId")
            .equals(contractData.id)
            .modify(childModifications);
        }
      );
    },

    async findOrCreateEntity(tableName, propertyName, value) {
      const trimmedValue = value.trim();
      if (!trimmedValue) {
        throw new Error(`Giá trị cho ${propertyName} không được để trống.`);
      }
      let entity = await this.db[tableName]
        .where(propertyName)
        .equalsIgnoreCase(trimmedValue)
        .first();
      if (!entity) {
        const newEntity = { [propertyName]: trimmedValue };
        if (tableName === "vendors" && propertyName === "vendorNo") {
          newEntity.name = "Chưa có tên";
        }
        const newId = await this.db[tableName].add(newEntity);
        entity = { id: newId, ...newEntity };
      }
      return entity;
    },

    async resyncAllDenormalizedData() {
      console.group("=== BẮT ĐẦU KIỂM TRA & SỬA CHỮA DỮ LIỆU ===");
      return this.db.transaction("rw", this.db.tables, async () => {
        const allContracts = await this.db.contracts.toArray();
        const contractMap = new Map(allContracts.map((c) => [c.id, c]));

        let updatedCount = 0;

        await this.db
          .table("cpcItems")
          .toCollection()
          .modify((cpc) => {
            const contract = contractMap.get(cpc.contractId);
            let changed = false;
            if (contract) {
              if (cpc.projectId !== contract.projectId) {
                console.log(
                  `%c[Sửa CPC] ID: ${cpc.id} (CPC: ${cpc.cpcIdentifier}) - Sửa ProjectID từ ${cpc.projectId} -> ${contract.projectId}`,
                  "color: orange"
                );
                cpc.projectId = contract.projectId;
                changed = true;
              }
              if (cpc.vendorId !== contract.vendorId) {
                console.log(
                  `%c[Sửa CPC] ID: ${cpc.id} (CPC: ${cpc.cpcIdentifier}) - Sửa VendorID từ ${cpc.vendorId} -> ${contract.vendorId}`,
                  "color: orange"
                );
                cpc.vendorId = contract.vendorId;
                changed = true;
              }
            }
            if (changed) updatedCount++;
          });

        const updateChildren = async (tableName) => {
          await this.db
            .table(tableName)
            .toCollection()
            .modify((child) => {
              const contract = contractMap.get(child.contractId);
              if (contract) {
                let childChanged = false;

                if (child.projectId !== contract.projectId) {
                  console.log(
                    `%c[Sửa ${tableName}] ID: ${child.id} - Sửa ProjectID từ ${child.projectId} -> ${contract.projectId}`,
                    "color: #bada55"
                  );
                  child.projectId = contract.projectId;
                  childChanged = true;
                }

                if (child.vendorId !== contract.vendorId) {
                  console.log(
                    `%c[Sửa ${tableName}] ID: ${child.id} - Sửa VendorID từ ${child.vendorId} -> ${contract.vendorId}`,
                    "color: #bada55"
                  );
                  child.vendorId = contract.vendorId;
                  childChanged = true;
                }

                if (childChanged) updatedCount++;
              }
            });
        };

        await updateChildren("installments");
        await updateChildren("bonds");

        console.log(
          `%c=== HOÀN TẤT === Tổng số bản ghi đã sửa: ${updatedCount}`,
          "font-weight: bold; font-size: 14px; color: green"
        );
        console.groupEnd();
        return updatedCount;
      });
    },
  };

  databaseService.initialize();
  const appUtils = {
    format: {
      currency(value, currency = "VND", lang = "vi-VN") {
        if (value === null || value === undefined) return "";
        const options = {
          style: "currency",
          currency: currency,
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        };
        if (currency === "USD") {
          options.minimumFractionDigits = 2;
          options.maximumFractionDigits = 2;
          lang = "en-US";
        }
        return new Intl.NumberFormat(lang, options).format(value || 0);
      },

      usdInput(value) {
        if (value === null || value === undefined) return "0.00";
        return new Intl.NumberFormat("en-US", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
          useGrouping: true,
        }).format(value || 0);
      },

      number(value, lang = "vi-VN") {
        if (value === 0) return "0";
        if (!value) return "";
        return new Intl.NumberFormat(lang).format(value);
      },

      reportNumber(value, lang = "vi-VN") {
        if (value === 0) return "-";
        if (!value) return "";
        return new Intl.NumberFormat(lang).format(value);
      },

      date(dateInput) {
        if (!dateInput) return "";
        const d = new Date(dateInput);

        if (isNaN(d.getTime())) {
          console.warn(
            "Robustness check: Invalid date input provided to format.date:",
            dateInput
          );
          return "";
        }
        const year = d.getFullYear();
        const month = (d.getMonth() + 1).toString().padStart(2, "0");
        const day = d.getDate().toString().padStart(2, "0");

        return `${year}-${month}-${day}`;
      },
    },

    ui: {
      toggleModal(modalId, action = "show") {
        const modalEl = document.getElementById(modalId);
        if (modalEl) {
          const modalInstance =
            bootstrap.Modal.getInstance(modalEl) ||
            new bootstrap.Modal(modalEl);

          if (action === "show") {
            modalInstance.show();
          } else if (action === "hide") {
            if (
              document.activeElement &&
              modalEl.contains(document.activeElement)
            ) {
              document.activeElement.blur();
            }
            modalInstance.hide();
          }
        }
      },

      showConfirmation(vueInstance, config) {
        vueInstance.confirmation = {
          title: vueInstance.t("confirm"),
          message: vueInstance.t("areYouSure"),
          onConfirm: null,
          onCancel: null,
          confirmButtonText: vueInstance.t("confirm"),
          confirmButtonClass: "btn-danger",
          ...config,
        };
        this.toggleModal("confirmationModal", "show");
      },
    },

    text: {
      normalizeVietnamese(str) {
        if (!str) return "";
        return str
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/đ/g, "d")
          .replace(/Đ/g, "D")
          .toLowerCase();
      },

      parseVndAmount(str) {
        if (typeof str !== "string" && typeof str !== "number") return 0;
        const cleanStr = String(str).replace(/\./g, "").replace(/,/g, "");
        return parseInt(cleanStr, 10) || 0;
      },

      parseUsdAmount(str) {
        if (typeof str !== "string" && typeof str !== "number") return 0;
        let sanitized = String(str).replace(/[^0-9.]/g, "");
        const parts = sanitized.split(".");
        if (parts.length > 2) {
          sanitized = parts[0] + "." + parts.slice(1).join("");
        }
        return parseFloat(sanitized) || 0;
      },
    },

    filter: {
      getAvailableItems({
        sourceData,
        linkingData,
        linkKey,
        idKey = "id",
        nameKey = "name",
        searchTerm = "",
        vueInstance,
      }) {
        if (!Array.isArray(sourceData) || !Array.isArray(linkingData)) {
          console.warn(
            "Robustness check: sourceData or linkingData is not an array in getAvailableItems."
          );
          return [];
        }

        const idsInUse = new Set(
          linkingData
            .filter(
              (item) =>
                item &&
                item[linkKey] !== undefined &&
                item[linkKey] !== null
            )
            .map((item) => item[linkKey])
        );

        const activeItems = sourceData.filter(
          (item) => item && idsInUse.has(item[idKey])
        );

        if (!searchTerm) {
          return activeItems.sort((a, b) =>
            (a[nameKey] || "").localeCompare(b[nameKey] || "")
          );
        }

        const normalizedSearch =
          appUtils.text.normalizeVietnamese(searchTerm);
        return activeItems
          .filter(
            (item) =>
              item &&
              item[nameKey] &&
              appUtils.text
                .normalizeVietnamese(item[nameKey])
                .includes(normalizedSearch)
          )
          .sort((a, b) =>
            (a[nameKey] || "").localeCompare(b[nameKey] || "")
          );
      },

      filterBySelectedIds(data, selectedIds, key) {
        if (!selectedIds || selectedIds.length === 0) return data;
        return data.filter((item) => selectedIds.includes(item[key]));
      },
    },
    validation: {
      isValidDateString(dateString) {
        if (!dateString || typeof dateString !== "string") return false;
        const d = new Date(dateString);
        if (isNaN(d.getTime())) {
          return false;
        }
        const year = d.getFullYear();
        return year >= 2010 && year <= 2040;
      },
    },
  };
  const app = Vue.createApp({
    data() {
      return {

        isHistoryExpanded: false,
        isContractProjectDropdownVisible: false,
        activeContractProjectIndex: -1,
        isProjectDropdownVisible: false,
        activeProjectIndex: -1,
        contractSearchTerm: "",
        isContractDropdownVisible: false,
        activeContractIndex: -1,
        isResizingNotes: false,
        notesPanelWidth: 450,
        isNotesModalVisible: false,
        isNotesEditing: false,
        currentContractNotes: [],
        activeNoteTabId: null,
        editingTabId: null,
        editingTabTitle: "",
        currentEditProject: null,
        projectModalMode: "add",
        currentEditCategory: null,
        categoryModalMode: "add",
        dataVersion: 1,
        isProjectQuickFilterVisible: false,
        projectQuickFilterSearch: "",
        activeProjectQuickFilterIndex: 0,
        invoiceSelectedRowIds: [],
        isValidationModalVisible: false,
        validationErrors: [],
        commandActions: [],
        reportCategoriesFromDB: [],
        bondModalMode: "add",
        bondContractSearchTerm: "",
        isBondContractDropdownVisible: false,
        activeBondContractIndex: -1,
        shouldFocusFirstInstallment: false,
        isSidebarFixed: localStorage.getItem("isSidebarFixed") === "true",
        timeOfDayClass: "day",
        shouldFocusPaymentDate: false,
        isQuickMenuOpen: false,
        activeQuickMenuIndex: -1,
        accountingComparisonData: null,
        cogsComparisonData: null,
        cogsSummaryFromSap: null,
        isDataLoading: true,
        isLoadingError: false,
        migrationStatus: "pending",
        lastSaveTimestamp: null,
        vendorSearchTerm: "",
        filteredVendors: [],
        isVendorDropdownVisible: false,
        activeVendorIndex: -1,
        isSidebarNavigating: false,
        sidebarNavIndex: -1,
        selectedProjectIdForBackup: null,
        projects: [],
        vendors: [],
        banks: [],
        contracts: [],
        cpcItems: [],
        installments: [],
        bonds: [],
        cpcDetailRows: [],
        currentEditVendor: null,
        vendorModalMode: "add",
        orphanData: {
          contractsWithOrphanProject: [],
          contractsWithOrphanVendor: [],
          projectsWithNoContracts: [],
          installmentsWithOrphanCpc: [],
          bondsWithOrphanCpc: [],
          cpcWithOrphanContract: [],
        },

        activeHelpTopic: "getting-started",
        isCommandPaletteVisible: false,
        isSearching: false,
        commandSearchTerm: "",
        commandSearchResults: [],
        activeCommandIndex: 0,
        fuseInstance: null,
        fuseIndex: null,
        debouncedSearch: null,

        viewStates: {
          vendorPartner: {
            searchTerm: "",
            selectedId: null
          },
          viewMode: "contract",
          invoiceAging: {
            viewMode: "contract",
            sortBy: "contractNo",
            sortDirection: "asc",
            currentPage: 1,
            perPage: 10,
            isFilterCollapsed: true,
            filter: {
              projectId: [],
              vendorId: [],
              minAge: 0,
              projectSearch: "",
              vendorSearch: "",
              reportDate: new Date().toISOString().slice(0, 10),
              expansion: {
                project: false,
                vendor: false,
              },
            },
          },
          cpcTracking: {
            sortBy: "receivedDate",
            sortDirection: "desc",
            currentPage: 1,
            perPage: 7,
            searchTerm: "",
            isActionCenterCollapsed: true,
            filter: {
              projectId: [],
              vendorId: [],
              contractId: [],
              status: [],
              projectSearch: "",
              vendorSearch: "",
              contractNoSearch: "",

              expansion: {
                project: false,
                vendor: false,
                contract: false,
                status: false,
              },
            },
            isFilterCollapsed: true,
          },
          cpcDetails: {
            activePhaseId: "summary",
            filter: {
              projectId: [],
              vendorId: [],
              selectedContractId: null,
              projectSearch: "",
              vendorSearch: "",

              expansion: {
                project: false,
                vendor: false,
                contract: false,
              },
            },
            currencyView: "VND",
            columnVisibility: {},
            subColumnVisibility: {},
            isFilterCollapsed: true,
          },
          vendorBalance: {
            sortBy: "vendorName",
            sortDirection: "asc",
            currentPage: 1,
            perPage: 7,
            searchTerm: "",
            filter: {
              projectId: [],
              projectSearch: "",
              status: [],
              balanceStatus: null,
              asOfDate: null,

              expansion: {
                project: false,
                balanceStatus: false,
                status: false,
              },
            },
            isFilterCollapsed: false,
          },
          paymentDashboard: {
            sortBy: "date",
            sortDirection: "desc",
            currentPage: 1,
            perPage: 7,
            filter: {
              startDate: "",
              endDate: "",
              projectId: [],
              vendorId: [],
              code: [],
              paymentSource: [],
              projectSearch: "",
              vendorSearch: "",
              codeSearch: "",
              paymentSourceSearch: "",

              expansion: {
                project: false,
                vendor: false,
                code: false,
                paymentSource: false,
              },
            },
            isFilterCollapsed: true,
          },
          swapDashboard: {
            sortBy: "swapDueDatePayment",
            sortDirection: "asc",
            currentPage: 1,
            perPage: 7,
            filter: {
              projectId: [],
              vendorId: [],
              vendorSWAP: [],
              projectSearch: "",
              vendorSearch: "",
              vendorSWAPSearch: "",

              expansion: {
                project: false,
                vendor: false,
                vendorSWAP: false,
              },
            },
            isFilterCollapsed: true,
          },
          bondDashboard: {
            sortBy: "expiryDate",
            sortDirection: "asc",
            currentPage: 1,
            perPage: 7,
            expandedGroupKeys: [],
            filter: {
              projectId: [],
              vendorId: [],
              contractId: [],
              bondType: [],
              status: [],
              projectSearch: "",
              vendorSearch: "",
              contractNoSearch: "",
              typeSearch: "",

              expansion: {
                project: false,
                vendor: false,
                contract: false,
                bondType: false,
              },
            },
            isFilterCollapsed: true,
          },
          contractDashboard: {
            sortBy: "date",
            sortDirection: "desc",
            currentPage: 1,
            perPage: 7,
            filter: {
              projectId: [],
              vendorId: [],
              contractId: [],
              code: [],
              projectSearch: "",
              vendorSearch: "",
              contractNoSearch: "",
              codeSearch: "",

              expansion: {
                project: false,
                vendor: false,
                contract: false,
                code: false,
              },
            },
            isFilterCollapsed: true,
          },
          reportDashboard: {
            asOfDate: new Date().toISOString().slice(0, 10),
            reportMonth: new Date().toISOString().slice(0, 7),
            filter: {
              projectId: [],
              projectSearch: "",

              expansion: {
                project: false,
              },
            },
          },
          cogsDashboard: {
            sortBy: "glAccount",
            sortDirection: "asc",
            currentPage: 1,
            perPage: 10,
            filter: {
              projectId: [],
              status: [],
              projectSearch: "",

              expansion: {
                project: false,
                status: false,
              },
            },
            isFilterCollapsed: false,
          },
        },
        currentEditItem: null,
        modalMode: "edit",
        currentEditContract: null,
        contractModalMode: "add",
        currentViewBondItem: null,
        currentEditInstallment: null,
        currentEditSwap: null,
        currentEditBond: null,
        currentStatusUpdate: null,
        isSidebarCollapsed: false,
        currentTab: "cpc-tracking",
        masterData: {
          activeSubTab: "vendors",

          vendors: {
            searchTerm: "",
            currentPage: 1,
            perPage: 10,
          },
          projects: {
            searchTerm: "",
            currentPage: 1,
            perPage: 10,
          },
        },
        highlightedRowId: null,
        toasts: [],
        confirmation: {
          title: "",
          message: "",
          onConfirm: null,
          confirmButtonText: "Confirm",
          confirmButtonClass: "btn-danger",
          onNeutral: null,
          neutralButtonText: "Continue",
        },
        language: "vi",
        transitionName: "slide-fade",
        expandedNotificationIds: [],
        editingCell: { itemId: null, field: null },
        inlineEditValue: "",
        justEditedCell: { itemId: null, field: null },
        showScrollToTopButton: false,
        translations: {
          en: {
            actionCenterTitle: "CPC Action Center",
            overdueRecently: "Overdue Recently",
            allStable: "All systems stable",
            showDetails: "SHOW DETAILS",
            collapse: "COLLAPSE",
            noOverdueRecords: "No overdue records found.",
            noPartialRecords: "No partial payment records found.",
            noUpcomingRecords: "No upcoming records within 10 days.",
            daysLate: "{days} days late",
            daysRemaining: "{days} days remaining",
            remainingLabel: "Remaining",
            swapLabel: "SWAP",
            offsetLabel: "Offset",
            vendorpartner: "Vendor Partners",
            contractoverview: "Contract Overview",
            contactPerson: "Contact Person",
            phoneNumber: "Phone Number",
            vendorPartner: "Vendor Partners",
            vendorSearchHint: "Name, Tax ID...",
            startSearchPrompt: "Enter vendor name or ID to start...",
            noResultsFound: "No matching results found.",
            selectVendorPrompt: "Please select a vendor to view data",
            activeContracts: "Active Contracts",
            joinedProjects: "Participating Projects",
            cpcOutstanding: "CPC OUTSTANDING",
            advBalance: "ADVANCE BALANCE",
            retentionHeld: "RETENTION HELD",
            workProgress: "WORK PROGRESS",
            retentionPool: "Retention Pool",
            unrecovered: "Unrecovered",
            contractProjectHeader: "CONTRACT & PROJECT",
            contractValueHeader: "CONTRACT VALUE",
            confirmedCpc: "CONFIRMED CPC",
            acceptanceShort: "Acc.", // Viết tắt cho Acceptance (Nghiệm thu)
            advBalShort: "Adv. Bal", // Viết tắt cho Advance Balance
            cpcOutstanding: "CPC OUTSTANDING",
            advBalance: "ADVANCE BALANCE",
            retentionHeld: "RETENTION HELD",
            performance: "WORK PROGRESS",
            vendorPartner: "Vendor Partners",
            vendorSearchHint: "Name, Tax ID...",
            totalCommitted: "TOTAL COMMITTED LIMIT",
            performance: "PERFORMANCE",
            disbursedNet: "DISBURSED (NET)",
            retentionHeld: "RETENTION HELD",
            contractList: "Detailed Contract List",
            confirmedAmount: "Confirmed / Paid",
            activeVendor: "Active Vendor",
            retentionPool: "Retention Pool",
            initialAdvance: "Initial Advance",
            additionalAdvance: "Additional Advance",
            currentAdvanceBalance: "Current Advance Balance",
            processing: "Processing",
            contractOverview: "Contract Overview",
            vendorPartner: "Vendor Partner",
            mainContract: "MAIN CONTRACT",
            totalValue: "Total Value",
            duration: "Duration",
            acceptanceProgress: "ACCEPTANCE PROGRESS",
            totalPaidHeader: "TOTAL PAID",
            totalPaidNote: "Total disbursed amount (Incl. VAT)",
            advanceBalanceHeader: "ADVANCE BALANCE",
            retentionValueHeader: "RETENTION VALUE",
            budget: "Budget",
            advanceFlow: "Advance Flow",
            totalRecovered: "Total Recovered/Repayment",
            toRecover: "To be recovered",
            paymentHistory: "Payment History",
            cpcStatusGroup: "CPC / Status Group",
            summaryPaid: "TOTAL COMPLETED PAYMENTS",
            summaryProcessing: "TOTAL PENDING/PARTIAL PAYMENTS",
            backToDetails: "Back to CPC Details",
            viewOverviewMode: "View Overview (2 rows)",
            viewDetailedMode: "View Detailed (Each CPC)",
            bondEffective: "Bond Information (Active)",
            noBonds: "No active bonds for this contract.",
            agingReportDate: "Calculate aging to",
            viewByInvoice: "By Invoice",
            viewByContract: "By Contract (CPC)",
            age1_30: "1-30 Days",
            age31_60: "31-60 Days",
            age61_90: "61-90 Days",
            ageOver90: "> 90 Days",
            totalOverdue: "Total Overdue",
            invoiceNet: "Net Amount",
            invoiceVat: "VAT",
            invoiceTotal: "Total Amount",
            contractDateLabel: "Contract Date",
            descriptionLabel: "Description",
            btnExportExcel: "Export Excel",
            promptSelectProjectAging:
              "Please select a Project to view aging data",
            noAgingData: "No overdue data found up to {date}",
            calculatingData: "Recalculating all data...",
            refreshSuccess: "Data refreshed successfully!",
            phaseRowsInitialized:
              "Empty rows initialized for the new phase.",
            errorUploadInSummaryMode:
              "You are in Summary view. Please select a specific Phase tab to upload data.",
            phaseAddedSuccess: "New phase added successfully.",
            phaseRenamedSuccess: "Phase renamed successfully.",
            phaseDeletedSuccess: "Phase and related data deleted.",
            phaseDeleteError: "System error while deleting data.",
            filteringBondForContract:
              "Filtering expiring/overdue bonds for contract: {contractNo}",
            vendorNoContractWarning:
              "This vendor has no contracts in the system (Accounting only).",
            filteringContractForVendor:
              "Filtering contracts for: {vendorName}",
            errorDateInvalidField:
              "Invalid date '{dateStr}' for field '{field}'. Please use date between 2010-2040.",
            errorDateInvalidInstallment:
              "Dates in payment installments are invalid (must be 2010-2040).",
            errorPaymentExceedsDetailsNegative:
              "Offset value ({totalPaid}) is invalid for receivable amount ({cpcAmount}). Please enter a positive value not exceeding {absAmount}.",
            errorContractNotFound: "Error: Original contract not found.",
            rowAddedSuccess: "New row added.",
            rowAddError: "Could not add new row.",
            errorNoRowsToUpdateInvoice: "No rows found to update invoice.",
            dataAppendedSuccess: "Data appended to {phaseName}.",
            dataAppendError: "Error appending data.",
            dataOverwrittenSuccess: "Data overwritten for {phaseName}.",
            noValidDataFound: "No valid data found in the file.",
            resyncStarted: "Starting data check and synchronization...",
            resyncComplete:
              "Complete! Checked and updated {count} records.",
            resyncError: "An error occurred during synchronization.",
            errorSelectContractToExport:
              "Please select a contract to export.",
            errorNoDetailDataToExport: "No detail data to export.",
            exportDetailsSuccess: "Details exported successfully.",
            errorProjectNameRequired: "Please enter Project Name.",
            errorProjectNameExists: "Project name '{name}' already exists.",
            projectAddSuccess: "New project added successfully!",
            projectUpdateSuccess: "Project updated successfully!",
            projectSaveError: "Failed to save project.",
            warningMismatchVatPayment:
              "VAT Payment ({paid}) >= Invoice VAT ({invoice}). Row skipped.",
            historyRecord: "History Rec",
            settledStatus: "Settled",
            viewDetails: "View Details",
            renewalHistoryTooltip: "Renewal History",
            quickSettleTooltip: "Toggle Quick Settle status",
            bondSettled: "Settled",
            tabInvoiceAging: "Invoice Aging",
            invoiceFilterTitle: "Invoice Filters",
            ageDays: "Age (Days)",
            filterOverdueDays: "Filter overdue days >",
            daysUnit: "days",
            remainingNet: "Remaining Net",
            remainingVat: "Remaining VAT",
            remainingTotal: "Remaining Total",
            promptSelectProjectForAging:
              "Please select a Project to view invoice aging",
            promptSelectProjectForAgingDesc:
              "Select 'Show Filters' -> 'Project' to start.",
            noInvoiceAgingData: "No matching invoice aging data found.",
            invoiceNoLabel: "Invoice No.",
            sidebarPin: "Pin Sidebar",
            sidebarUnpin: "Auto Collapse",
            swapProduct: "SWAP Product",
            generalNotes: "General Notes",
            addNoteTab: "Add a new note tab",
            promptNewTabTitle: "Please enter a title for the new tab:",
            promptAddNoteTab: "Add a new tab to start writing notes.",
            confirmDeleteTabTitle: "Delete Tab",
            confirmDeleteTabMessage:
              "Are you sure you want to delete the tab {title}? All content in this tab will be lost.",

            significantNotes: "Significant Notes",
            viewEditNotes: "View/Edit",
            significantNotesTitle: "Significant Payment Notes",
            notesPlaceholder: "Enter contract payment conditions here...",
            noNotesAvailable: "No notes available.",
            btnExportVendors: "Export Vendors",
            btnUploadCategories: "Upload Categories",
            categoryUploadSuccess:
              "Successfully processed {added} new and {updated} updated categories.",
            categoryUploadSkipped:
              "Skipped {skipped} rows due to missing data or errors.",
            errorNoCategoryDataToExport: "No category data to export.",
            categoryExportSuccess: "Categories exported successfully!",
            categoryTab: "Report Categories",
            addCategory: "Add Category",
            categoryTableHeaderNo: "No.",
            categoryTableHeaderCode: "Code",
            categoryTableHeaderNameVi: "Vietnamese Name",
            categoryTableHeaderNameEn: "English Name",
            categoryTableHeaderUsage: "Contracts Using",
            categoryTableNoData: "No categories found.",
            categoryModalAddTitle: "Add New Category",
            categoryModalEditTitle: "Edit Category",
            categoryParentLabel:
              "Parent Category (Leave empty for Level 1)",
            categoryParentOption: "-- Is a parent category (Level 1) --",
            categoryCodeLabel: "Category Code",
            categoryCodeReadonly: "Code cannot be changed after creation.",
            categoryNameViLabel: "Vietnamese Name",
            categoryNameEnLabel: "English Name",
            errorCategoryRequired: "Code and Vietnamese Name are required.",
            errorCategoryCodeExists:
              "Category code '{code}' already exists.",
            categoryAddSuccess: "New category added successfully!",
            categoryUpdateSuccess: "Category updated successfully!",
            categorySaveFailed: "Failed to save category.",
            errorCategoryInUse:
              "Cannot delete a category that is in use by one or more contracts.",
            confirmDeleteCategory:
              "Are you sure you want to delete the category <strong>{code} - {name}</strong>?",
            warningDeleteParentCategory:
              "<strong>WARNING:</strong> This is a parent category. All <strong>{count}</strong> child categories will also be deleted.",
            errorDeleteParentInUse:
              "Cannot delete parent category because one of its child categories is in use.",
            categoryDeleteSuccess: "Category deleted successfully.",
            categoryDeleteFailed: "Failed to delete category.",
            confirmSendCpcTitle: "Confirm CPC Send",
            confirmUpdateCpcMessage:
              "CPC <strong>{cpcNo}</strong> already exists. Do you want to update its value to <strong>{amount}</strong> based on the sum of the detail rows?",
            btnUpdate: "Update",
            confirmSendCpcMessage:
              "Are you sure you want to send CPC <strong>{cpcNo}</strong> with a total value of <strong>{amount}</strong>?",
            btnSend: "Send",
            editProject: "Edit Project",
            validationErrorTitle: "Excel File Validation Errors",
            validationErrorIntro:
              "The file could not be imported because the following errors were found. Please correct them in your Excel file and try again:",
            validationSheet: "Sheet",
            validationRow: "Row",
            validationMessage: "Error Message",
            validationErrorRequired:
              "Required field '<strong>{field}</strong>' is empty.",
            validationErrorNoContract:
              "Contract '<strong>{contractNo}</strong>' does not exist in the system's Master Data.",
            validationErrorDuplicate:
              "A CPC with this number for this contract already exists (either in the database or duplicated in the file).",
            validationErrorOrphaned:
              "This installment is orphaned: its parent CPC was not found or was invalid in the 'CPC_Main' sheet.",
            cpcUploadSuccess:
              "Successfully added {cpcCount} CPCs and {instCount} installments.",
            uploadSkipped: "Skipped {count} rows due to errors.",
            uploadSkippedReasonMissingData:
              "Missing required 'contractNo' or 'cpc'.",
            uploadSkippedReasonNoContract:
              "Contract '{contractNo}' not found in Master Data.",
            uploadSkippedReasonDuplicate:
              "CPC for this contract already exists (in DB or file).",
            uploadSkippedReasonOrphaned:
              "Orphaned installment: its parent CPC was not found or was invalid in the file.",
            confirmSettleTitle: "Confirm Settlement",
            confirmCancelSettleTitle: "Confirm Cancel Settlement",
            confirmSettleMessage:
              "Are you sure you want to settle bond <strong>{bondNumber}</strong>?",
            confirmCancelSettleMessage:
              "Are you sure you want to cancel the settlement status for bond <strong>{bondNumber}</strong>?",
            btnConfirmSettle: "Settle",
            btnConfirmCancelSettle: "Cancel Settlement",
            bondSettledSuccess: "Bond '{bondNumber}' has been settled.",
            bondUnsettledSuccess:
              "Settlement for bond '{bondNumber}' has been canceled.",
            errorFindBondToUpdate:
              "Error: Could not find the bond to update.",
            errorUpdateBondStatus: "Could not update bond status.",
            tooltipBondRenewed: "Renewed, cannot be changed.",
            tooltipBondCancelSettle: "Click to cancel settlement.",
            tooltipBondQuickSettle: "Click to quick settle.",
            btnUploadBonds: "Upload Bonds",
            btnExportBonds: "Export Bonds",
            errorNoBondDataToExport: "No bond data to export.",
            bondExportSuccess: "Bond data exported successfully!",
            bondUploadSuccess: "Successfully added {count} new bonds.",
            bondUploadNone: "No new bonds were added.",
            bondUploadSkipped: " Skipped {count} rows due to errors.",
            bondUploadReasonMissingData: "Missing Contract No. or Bond No.",
            bondUploadReasonExists: "Bond Number already exists.",
            bondUploadReasonNoContract:
              "Contract '{contractNo}' not found.",
            bondUploadSkippedConsole: "Skipped bonds:",
            excelHeaderContract: "Contract",
            excelHeaderBondNumber: "Bond Number",
            excelHeaderReference: "Reference",
            excelHeaderBondType: "Bond Type",
            excelHeaderAmount: "Amount",
            excelHeaderIssueDate: "Issue Date",
            excelHeaderExpiryDate: "Expiry Date",
            excelHeaderBank: "Bank",
            excelHeaderStatus: "Status",
            appTitle: "CPC Vision",
            toggleLanguage: "Toggle Language",
            btnClose: "Close",
            btnSaveChanges: "Save Changes",
            btnCancel: "Cancel",
            confirm: "Confirm",
            warning: "Warning",
            areYouSure: "Are you sure?",
            actionCannotBeUndone: "This action cannot be undone.",
            allFiltersCleared: "All filters have been cleared.",
            activeFilters: "Active Filters",
            editFilters: "Edit Filters",
            noActiveFilters: "No active filters.",
            filterPanelTitle: "Filter Controls",
            search: "Search",
            columns: "Columns",
            subColumns: "Sub-columns",
            total: "Total",
            grandTotal: "GRAND TOTAL",
            footerRemaining: "Remaining",
            status: "Status",
            action: "Action",
            saveChanges: "Save Changes",
            saved: "Saved",
            unsaved: "Unsaved",
            unsavedChangesTooltip:
              "You have unsaved changes. Click the button to save.",
            savedStatusTooltip: "All changes are saved to your browser.",
            guideTitle: "Application User Guide",
            print: "Print",
            viewAs: "View as",
            configure: "Configure",
            banks: "Banks",
            ok: "OK",
            na: "N/A",
            calculationRules: "Calculation Rules",
            repaymentThresholdLabel: "Repayment Threshold (%)",
            repaymentThresholdNote: "Default: 80%.",
            retentionRateLabel: "Retention Rate (%)",
            retentionRateNote: "Default: 5%.",
            defaultVatRateLabel: "Default VAT Rate (%)",
            defaultVatRateNote: "Default: 8%.",
            hide: "Hide",
            change: "Change",
            tabCpcTracking: "CPC Tracking",
            cpctracking: "CPC Tracking",
            tabCpcDetails: "CPC Details",
            cpcdetails: "CPC Details",
            tabVendorBalance: "Vendor Balance",
            vendorbalance: "Vendor Balance",
            tabPaymentDashboard: "Payment",
            cpcdashboard: "Payment Dashboard",
            tabSwapDashboard: "SWAP",
            cpcswapdashboard: "SWAP Dashboard",
            tabBondDashboard: "Bond",
            cpcbonddashboard: "Bond Dashboard",
            tabContractDashboard: "Contract",
            cpccontractdashboard: "Contract Dashboard",
            tabReportDashboard: "Report",
            cpcreportdashboard: "Report Dashboard",
            tabCogsDashboard: "COGS",
            cogsdashboard: "COGS Dashboard",
            masterdata: "Master Data",
            btnAddCpc: "Add CPC",
            btnAddContract: "Add Contract",
            btnAddBond: "Add Bond",
            btnUploadContracts: "Upload Contracts",
            btnData: "Data",
            btnTemplate: "Template",
            btnUpload: "Upload from Excel",
            btnUploadMerge: "Upload & Merge",
            btnExport: "Export to Excel",
            btnExportJson: "Export to JSON",
            btnSaveToFile: "Backup to File",
            btnOpenFile: "Restore from File",
            btnClearAll: "Clear All",
            btnClearAllFilters: "Clear All Filters",
            btnEdit: "Edit",
            btnAdd: "Add",
            btnRenew: "Renew",
            btnDelete: "Delete",
            btnPrevious: "Previous",
            btnNext: "Next",
            btnDownloadDetailsTemplate: "Details Template",
            btnUploadDetails: "Upload Details",
            btnExportDetails: "Export Details",
            btnBackupProject: "Backup Project",
            btnImportProject: "Import Project",
            btnBackup: "Backup",
            btnRestore: "Restore",
            btnUploadReconcile: "Upload & Reconcile Accounts",
            btnClear: "Clear",
            btnDebugVendor: "Debug Vendor by No.",
            btnUploadCogs: "Upload & Reconcile COGS",
            btnClearCogs: "Clear Reconciliation",
            btnAddVendor: "Add Vendor",
            btnDownloadTemplate: "Download Template",
            btnCleanupData: "Cleanup Data",
            btnAddProject: "Add Project",
            btnAddBank: "Add Bank",
            btnClearVisibleContracts: "Delete Visible Contracts",
            btnClearVisibleBonds: "Delete Visible Bonds",
            showEntriesLabel: "Show:",
            entriesUnit: "entries",
            searchPlaceholder: "Search...",
            clearSearchTooltip: "Clear search",
            tableHeaderNo: "No.",
            tableHeaderAction: "Action",
            noMatchingData: "No data matches the current filters.",
            paginationInfo: "Showing {start} to {end} of {total} entries",
            paginationPageInfo: "Page {currentPage} / {totalPages}",
            project: "Project",
            vendor: "Vendor",
            code: "Code",
            glaccount: "G/L Account",
            contract: "Contract",
            date: "Date",
            postingDate: "Posting Date",
            currency: "Currency",
            bondType: "Bond Type",
            dateRange: "Date Range",
            startDate: "Start Date",
            endDate: "End Date",
            searchProjects: "Search projects...",
            searchVendors: "Search vendors...",
            searchCodes: "Search codes...",
            searchContracts: "Search contracts...",
            searchTypes: "Search types...",
            searchPaymentSources: "Search payment sources...",
            tooltipClearFilter: "Clear filter",
            tooltipResetDate: "Reset date range",
            cpc: "CPC",
            contents: "Contents",
            department: "Department",
            contractSystemNo: "Contract System No.",
            vendorNo: "Vendor No.",
            amountInclVAT: "Amount (Incl. VAT)",
            receivedDate: "Received Date",
            paymentDueDate: "Payment Due Date",
            amountPaid: "Amount Paid",
            paymentDate: "Payment Date",
            lineTracking: "Line tracking",
            notes: "Notes",
            installment: "Installment",
            bond: "Bond",
            moreInfo: "More Info",
            installment_ordinal: "Inst. {num}{ordinal}",
            installment_swap: "Inst. {num}{ordinal}",
            noPaymentsAvailable: "No payments are available.",
            tooltipEdit: "Edit",
            tooltipCopy: "Copy",
            tooltipDelete: "Delete",
            complete: "Complete",
            partialpayment: "Partial Payment",
            pending: "Pending",
            completeswap: "Complete SWAP",
            partialswap: "Partial SWAP",
            completeswappayment: "Complete SWAP Payment",
            partialswappayment: "Partial SWAP Payment",
            status_overdue_days: "{days} days overdue",
            status_due_today: "Due Today",
            status_days_left: "{days} days left",
            completeWithOffset: "Complete (Offset)",
            swap: "SWAP",
            swapPayments: "SWAP Payments",
            addSwapPayment: "Add SWAP Payment",
            swapPaidLabel: "SWAP Paid",
            vendorSWAP: "SWAP Vendor",
            swapAgreement: "SWAP Agreement",
            agreementDate: "Agreement Date",
            swapInformation: "SWAP Information",
            swapDueDatePayment: "SWAP Due Date Payment",
            swapAmountPaid: "SWAP Amount Paid",
            paidStatus: "Paid",
            unpaidStatus: "Unpaid",
            collected: "Collected",
            partiallyCollected: "Partially Collected",
            uncollected: "Uncollected",
            swapPaymentDate: "Swap Payment Date",
            duebond: "Due Bonds",
            bondNumber: "Bond Number",
            ref: "Ref.",
            issueDate: "Issue Date",
            expiryDate: "Expiry Date",
            issuingBank: "Issuing Bank",
            quickSettle: "Quick Settle",
            bond_status_overdue: "Overdue by {days} days",
            bond_status_expiring: "Expiring in {days} days",
            bond_status_active: "Active",
            renewedStatus: "Renewed",
            noExpenseData: "No expense data matches the current filters.",
            noBondData: "No bond data matches the current filters.",
            noSwapData: "No SWAP data matches the current filters.",
            gl3311: "Payable to Supplier",
            gl3312: "Advance to Supplier",
            outstandingBalanceStatus: "Outstanding Balance Status",
            balanceStatusHasBalance: "Payable/Advance ≠ 0",
            fullySettled: "Payable & Advance = 0",
            reportAsOf: "Report as of",
            reportAsOfNote: "Leave blank to view the current balance.",
            payableSap: "Payable (SAP)",
            advanceSap: "Advance (SAP)",
            difference: "Difference",
            statusMatch: "Match",
            statusMismatch: "Mismatch",
            statusOnlyinApp: "Only in App",
            statusOnlyinAccounting: "Only in Accounting",
            cogsSummaryTitle: "Summary by G/L Account",
            cogsDetailTitle: "Contract Details for Reconciliation",
            invAmountApp: "Inv. Amount (App)",
            invAmountSap: "Inv. Amount (SAP)",
            reconciliationStatus: "Status",
            transactionType: "Transaction Type",
            transactionTypeReceivable: "Debt Collection",
            transactionTypePayable: "Payable Payment",
            modalTitleEdit: "Edit CPC Item",
            modalTitleCopy: "Copy CPC Item",
            modalTitleAdd: "Add New CPC Item",
            modalTitleEditFinancials: "Edit Financials & Payments",
            modalTitleAddContract: "Add New Contract",
            modalTitleEditContract: "Edit Contract",
            modalTitleAddVendor: "Add New Vendor",
            editVendor: "Edit Vendor",
            modalTitleEditInstallment: "Edit Payment",
            modalTitleEditContractDetail: "Edit Contract Details",
            modalTitleEditCpcDetail: "Edit CPC Details",
            modalTitleEditPaymentDetail: "Edit Payment Details",
            modalTitleEditInvoiceDetail: "Edit Invoice Details",
            editSwapTitle: "Edit SWAP Details",
            modalSectionMain: "Main Information",
            modalSectionFinancial: "Financials & Dates",
            modalSectionSystem: "System Information",
            amountExclVAT: "Amount (Excl. VAT)",
            vatAmount: "VAT",
            amountUSD: "Amount USD",
            exchangeRate: "Exchange Rate",
            invoiceExchangeRate: "Invoice Exchange Rate",
            paymentInUSD: "Pay in USD",
            paymentInstallments: "Payment Installments",
            paymentSource: "Payment Source",
            addInstallment: "Add Installment",
            bondInformation: "Bond Information",
            selectBondType: "Select Bond Type",
            prepaymentBond: "Prepayment Bond",
            performanceBond: "Performance Bond",
            warrantyBond: "Warranty Bond",
            addBond: "Add Bond",
            bondDetailsFor: "Bond Details for",
            noBondInfo: "No bond information is available for this item.",
            updateBondStatus: "Update Bond Status",
            statusUpdate: "Status Update",
            advancePaymentsCleared: "Advance payments fully cleared",
            contractSettled: "The contract has been settled",
            otherReason: "Other reason",
            inputCustomReason: "Input custom reason",
            renewBond: "Renew Bond",
            originalBondNumber: "Original Bond Number",
            originalBondType: "Original Bond Type",
            originalExpiryDate: "Original Expiry Date",
            originalAmount: "Original Amount",
            newRenewalDetails: "New Renewal Details",
            newBondNumber: "New Bond Number",
            newBondType: "New Bond Type",
            newAmount: "New Amount",
            newIssueDate: "New Issue Date",
            newExpiryDate: "New Expiry Date",
            newIssuingBank: "New Issuing Bank",
            renewalNotes: "Renewal Notes",
            btnSaveRenewal: "Save Renewal",
            updateContractStatus: "Update Contract Status",
            active: "Active",
            closed: "Closed",
            statusNote: "Status Note",
            selectContract: "Select Contract",
            promptSelectContract:
              "Please select one project and one vendor",
            pleaseSelectContractToView:
              "Please select a contract to view or enter data.",
            loadFromXml: "Load from XML",
            addNewRow: "Add New Row",
            deleteRow: "Delete Row",
            deleteContents: "Clear Contents",
            contractinfo: "Contract Info",
            details: "Description",
            amount: "Amount",
            net: "Net",
            vat: "VAT",
            repaymentBasisTitle:
              "Select Contract/VON values for repayment calculation",
            noBasisAvailable:
              "No Contract/VON values found in previous or current rows.",
            calcRepayOnWorkdone: "Repayment on Work-done",
            finalSettlement: "Final Settlement",
            distributeToCpcRows: "Distribute to CPC rows:",
            columnGroupContract: "Contract",
            columnGroupCpc: "CPC",
            columnGroupPayment: "Payment",
            columnGroupInvoice: "Invoice",
            columnGroupRemainingPayable: "Remaining Payable",
            columnGroupContractRemaining: "Contract Remaining",
            reportAsOfDate: "As of Date",
            reportMonth: "Report Month",
            category: "Category",
            reportPaidToDateHeader: "Paid up to {date}",
            reportRemainingFromDateHeader: "Remaining from {date}",
            reportPaidInMonthHeader: "Paid in {month}",
            vendor_tab: "Vendor",
            project_tab: "Project",
            banks_tab: "Banks",
            abbreviation: "Abbreviation",
            contractCount: "No. Contract",
            searchVendorPlaceholder: "Search Vendor...",
            noVendorsFound: "No vendors found.",
            searchProjectPlaceholder: "Search Project...",
            projectContractCount: "No. Contracts related to Project",
            noProjectsFound: "No projects found.",
            searchBankPlaceholder: "Search Bank...",
            bankContractCount: "No. Bonds Issued",
            noBanksFound: "No banks found.",
            commandPalettePlaceholder: "Search Contract, CPC, Vendor...",
            commandPaletteNoResults: "No results found.",
            cpc_search: "CPC",
            contract_search: "CONTRACT",
            notificationHeader: "Bond Notifications",
            noNotifications: "No bonds are expiring soon or overdue.",
            changesSavedSuccess: "Changes saved successfully.",
            errorPaymentDate:
              "Payment date is required for installments with an amount greater than zero.",
            errorPostingDateRequired:
              "Posting Date is required to save the invoice.",
            errorPaymentExceedsDetails:
              "Total payment ({totalPaid}) exceeds the CPC amount ({cpcAmount}) by {overExcessAmount}.",
            contractCreatedAutomatically:
              "A new contract has been automatically created in the master list.",
            confirmDeletion: "Confirm Deletion",
            confirmDeleteCpcItem:
              "Are you sure you want to delete CPC item <strong>{cpc}</strong>? This action cannot be undone.",
            confirmDeleteRow:
              "Are you sure you want to delete this entire row?",
            itemDeleted: "Item deleted successfully.",
            rowDeleted: "Row deleted successfully.",
            confirmClearAllData:
              "This will permanently delete all CPC and Contract data. Are you sure you want to proceed?",
            yesClearAll: "Yes, Clear All",
            allDataCleared: "All application data has been cleared.",
            fileSaveSuccess: "Data file saved successfully.",
            confirmDataLoad: "Confirm Data Load",
            confirmOverwriteData:
              "This will overwrite all current unsaved data with the content from the file. Are you sure?",
            loadSuccess: "Data has been loaded successfully.",
            invalidJsonFormat: "Invalid JSON file format.",
            errorParsingJson: "Error parsing the JSON file.",
            errorInvalidExcelFile:
              "Invalid file type. Please upload an .xlsx or .xls file.",
            itemsUploaded: "{count} items were successfully uploaded.",
            noValidItems:
              "No new valid items were found in the file to upload.",
            errorProcessingExcel:
              "An error occurred while processing the Excel file.",
            errorContractNumberRequired:
              "Contract Number is a required field.",
            errorContractExists:
              "A contract with this number already exists in the master list.",
            contractSavedSuccess: "Contract saved successfully.",
            confirmDeleteContract:
              "Are you sure you want to delete contract <strong>{contractNo}</strong>? This action cannot be undone.",
            contractDeletedSuccess:
              "Contract has been deleted successfully.",
            errorUpdatingPayment:
              "Error: Could not find the original payment to update.",
            confirmDeleteBond:
              "Are you sure you want to delete bond <strong>{bondNumber}</strong>?",
            bondDeletedSuccess: "The bond has been deleted successfully.",
            errorFindBondToDelete:
              "Error: Could not find the specific bond to delete.",
            errorFindOriginalCpcItem:
              "Error: Could not find the original CPC item for this operation.",
            errorNewBondDates:
              "The new issue date and expiry date are required for bond renewal.",
            bondRenewedSuccess:
              "The bond has been successfully renewed and a new bond entry has been added.",
            bondInfoSaved: "Bond information has been saved.",
            cpcSentToTracking: "CPC has been sent to the Tracking tab.",
            cpcUpdatedInTracking:
              "CPC has been updated in the Tracking tab.",
            cpcPaymentUpdatedInDetails:
              "Payment information has been updated in the CPC Details tab.",
            errorNoDataToSend: "No CPC data available on this row to send.",
            paymentManagedInTracking:
              "Payment details are managed in the CPC Tracking tab.",
            detailsDataUploaded:
              "Details data for contract {contractNo} has been successfully updated.",
            confirmOverwriteDetails:
              "This will replace all existing details for contract <strong>{contractNo}</strong> with data from the file. Are you sure?",
            contractStatusUpdated: "Contract status updated successfully.",
            btnClearVisibleBonds: "Delete Visible Bonds",
            btnClearVisibleContracts: "Delete Visible Contracts",
            confirmClearVisibleBonds:
              "Are you sure you want to delete the <strong>{count}</strong> currently visible bonds? This action cannot be undone.",
            confirmClearVisibleContracts:
              "Are you sure you want to delete the <strong>{count}</strong> currently visible contracts? This action cannot be undone.",
            visibleBondsCleared: "{count} bonds have been deleted.",
            visibleContractsCleared: "{count} contracts have been deleted.",
            cogsReconciliationCleared:
              "COGS reconciliation data has been cleared.",
            cogsUploadSuccess:
              "Upload successful! Processed {count} data rows.",
            accountingReconciliationCleared:
              "Reconciliation data has been deleted.",
            accountingUploadSuccess:
              "Upload successful! Processed {count} vendor codes from the file.",
            projectDeletedSuccess: "Project deleted successfully.",
            projectDeleteFailed: "Failed to delete project.",
            vendorDeletedSuccess: "Vendor deleted successfully.",
            vendorDeleteFailed: "Failed to delete vendor.",
            errorProjectVendorRequired:
              "Please enter complete Project and Vendor information.",
            errorSavingCpc: "Failed to save CPC data.",
            vendorSavedSuccess: "Vendor information saved successfully!",
            vendorSaveFailed: "Failed to save vendor.",
            errorVendorNameRequired: "Please enter a Vendor name.",
            errorVendorNoRequired: "Please enter a Vendor No.",
            errorVendorNameExists: "Vendor '{vendorName}' already exists.",
            errorVendorNoExists: "Vendor No. '{vendorNo}' already exists.",
            errorLoadingFromDb:
              "Unable to load data from browser database.",
            errorSavingChanges: "Failed to save changes.",
            errorSheetNotFound:
              "Sheet '{sheetName}' not found in the Excel file.",
            errorNoValidDataInExcel:
              "No valid data found in the Excel file.",
            errorVendorInUse:
              "Cannot delete a vendor that is currently in use in contracts.",
            errorProjectInUse:
              "Cannot delete a project that is currently in use in contracts.",
            confirmDeleteVendorMessage:
              "Are you sure you want to delete the Vendor '<strong>{vendorName}</strong>'? This action cannot be undone.",
            confirmDeleteProjectMessage:
              "Are you sure you want to delete the Project '<strong>{projectName}</strong>'?",
            alertAddProjectNotImplemented:
              "The 'Add Project' feature is under development.",
            alertEditProjectNotImplemented:
              "The 'Edit Project' feature is under development.",
            modalTitleBackupProject: "Backup Project Data",
            promptSelectProject: "-- Select a project --",
            errorSelectProject: "Please select a project.",
            projectExportSuccess:
              "Successfully exported data for project '{projectName}'.",
            errorProjectNotFound: "Project not found.",
            confirmOverwriteProjectTitle: "Project Exists",
            confirmOverwriteProjectMessage:
              "Project '<strong>{projectName}</strong>' already exists. Do you want to <strong>delete all old data</strong> for this project and replace it with data from the file?",
            btnOverwrite: "Overwrite",
            confirmImportNewProjectTitle: "Confirm New Project Import",
            confirmImportNewProjectMessage:
              "Are you sure you want to add the project '<strong>{projectName}</strong>' and all related data to the application?",
            btnImport: "Import",
            errorInvalidProjectBackupFile:
              "Invalid file or not a project backup file.",
            errorImportingProject:
              "An error occurred while processing the file.",
            projectImportSuccess:
              "Project data has been imported successfully!",
            projectImportFailed:
              "The import process failed. Please check the console.",
            modalTitleOrphanData: "Orphan Data Management",
            orphanDataDescription:
              "Below is a list of records that reference non-existent items (e.g., contracts belonging to a deleted project). You can review and delete individual items or clear all to clean up the system.",
            orphanUnusedProjects: "Unused Projects",
            orphanUnusedProjectsDesc:
              "These are projects with no contracts assigned to them. You can delete them if they are no longer needed.",
            orphanContractsWithOrphanProject:
              "Contracts with Non-Existent Project",
            orphanContractsWithOrphanVendor:
              "Contracts with Non-Existent Vendor",
            orphanCpcWithOrphanContract: "CPCs with Non-Existent Contract",
            orphanInstallmentsWithOrphanCpc:
              "Payments with Non-Existent CPC",
            orphanBondsWithOrphanCpc: "Bonds with Non-Existent CPC",
            orphanProjectLabel:
              "Project: <strong>{name}</strong> (ID: {id})",
            orphanContractLabel:
              "Contract: <strong>{contractNo}</strong> (ID: {id}) - Refers to Project ID: <code>{projectId}</code>",
            orphanContractVendorLabel:
              "Contract: <strong>{contractNo}</strong> (ID: {id}) - Refers to Vendor ID: <code>{vendorId}</code>",
            orphanCpcLabel:
              "CPC: <strong>{cpcIdentifier}</strong> (ID: {id}) - Refers to Contract ID: <code>{contractId}</code>",
            orphanInstallmentLabel:
              "Payment: <strong>{amount}</strong> on <strong>{date}</strong> (ID: {id}) - Refers to CPC ID: <code>{cpcId}</code>",
            orphanBondLabel:
              "Bond: <strong>{bondNumber}</strong> (ID: {id}) - Refers to CPC ID: <code>{cpcId}</code>",
            btnDeleteOrphan: "Delete",
            orphanDataSuccess:
              "Scan complete! No orphan data found in the system.",
            btnDeleteAllOrphans: "Delete All Orphan Data",
            confirmDeleteOrphanTitle: "Confirm Deletion",
            confirmDeleteOrphanMessage:
              "Are you sure you want to permanently delete this item (ID: {itemId})?",
            orphanItemDeleted: "Item (ID: {itemId}) deleted successfully.",
            orphanDeleteFailed:
              "Deletion failed. Please check the console.",
            confirmDeleteAllOrphansTitle: "Confirm Delete All",
            confirmDeleteAllOrphansMessage:
              "This action will permanently delete **ALL** listed items. Are you sure you want to continue?",
            btnYesDeleteAll: "Yes, Delete All",
            allOrphansDeleted:
              "All orphan data has been successfully cleaned up.",
            deleteAllOrphansFailed:
              "Bulk deletion failed. Please check the console.",
            btnColumns: "Columns",
            btnSubColumns: "Sub-Columns",
            row: "Row",
            xmlLoadSuccess: "Invoice data loaded from XML successfully.",
            xmlLoadError: "Error parsing XML file.",
            paymentUpdatedSuccess: "Payment updated successfully.",
            contractDataAutoFilled:
              "Contract data has been auto-filled from the master list.",
            errorNoVendorDataToExport: "No vendor data to export.",
            vendorExportSuccess: "Vendors exported successfully.",
            allProjects: "All Projects",
            contractAmountTotal: "Contract Amount",
            vonTotal: "VON",
            contractVatTotal: "Contract VAT",
            contractGrandTotal: "Total Contract",
            paidAmountExclVAT: "Paid (Excl. VAT)",
            paidVatAmount: "Paid (VAT)",
            paidAmountInclVAT: "Paid (Incl. VAT)",
            invoiceAmountTotal: "Invoice Amount",
            invoiceVatTotal: "Invoice VAT",
            invoiceGrandTotal: "Total Invoice",
            tooltipSendCpc:
              "Click to send/update this CPC. Ctrl+Click to send/update ALL CPCs for this contract.",
            btnResyncData: "Check & Repair Data",
            confirmResyncTitle: "Confirm Data Check & Repair",
            confirmResyncMessage:
              "This action will scan the entire database to find and fix inconsistent information (e.g., incorrect project or vendor names in child items).<br><br>This process is safe and recommended after importing data from a file or if you suspect errors. Do you want to continue?",
            btnStart: "Start",
            confirmBulkSendTitle: "Confirm Bulk Send",
            confirmBulkSendMessage:
              "Are you sure you want to send/update all <strong>{count}</strong> CPC items for contract <strong>{contractNo}</strong>?",
            btnConfirmSendAll: "Yes, Send All",
            errorSelectContractAction:
              "Please select a contract to perform this action.",
            infoNoCpcToSend: "There are no CPCs to send for this contract.",
            successBulkCpcSent:
              "Successfully sent/updated {count} CPC items.",
            errorBulkCpcFailed: "Bulk CPC send failed.",
            promptDebugVendor: "Please enter the Vendor No. to debug:",
            confirmMergeVendorTitle: "Duplicate Vendor No. Detected",
            confirmMergeVendorMessage:
              'Vendor No. <strong>{vendorNo}</strong> already exists for vendor "<strong>{destName}</strong>".<br><br>Do you want to merge the vendor you are editing ("<strong>{sourceName}</strong>") into the existing one? <br><br><strong class="text-danger">Note:</strong> All contracts from "{sourceName}" will be reassigned to "{destName}", and "{sourceName}" will be deleted. This action cannot be undone.',
            btnConfirmMerge: "Yes, Merge",
            errorInvalidMergeIds:
              "Error: Invalid vendor IDs for merge operation.",
            errorMergeVendorNotFound:
              "Error: Could not find vendors in the system.",
            successVendorMerged:
              'Successfully merged vendor "{sourceName}" into "{destName}"!',
            errorVendorMergeFailed:
              "An error occurred during the merge. Data has been rolled back.",
            warningEnterCpcForInvoice:
              "Enter CPC number in the current row before uploading invoice.",
            errorSelectRowForInvoice:
              "Please select at least one row to distribute the invoice.",
            errorVendorConstraint:
              "Error: Vendor Name or No. already exists in the database.",
            errorContractNoExists:
              "Error: Contract number '{contractNo}' already exists.",
          },
          vi: {
            actionCenterTitle: "Trung tâm Xử lý CPC",
            overdueRecently: "Hồ sơ Quá hạn",
            allStable: "Tất cả ổn định",
            showDetails: "XEM CHI TIẾT",
            collapse: "THU GỌN",
            noOverdueRecords: "Không có hồ sơ quá hạn.",
            noPartialRecords: "Không có hồ sơ trả một phần.",
            noUpcomingRecords: "Chưa có hồ sơ sắp đến hạn.",
            daysLate: "trễ {days} ngày",
            daysRemaining: "còn {days} ngày",
            remainingLabel: "Còn lại",
            swapLabel: "Cấn trừ",
            offsetLabel: "Bù trừ",
            vendorpartner: "Đối tác Nhà thầu",
            contractoverview: "Tổng quan Hợp đồng",
            contactPerson: "Người liên hệ",
            phoneNumber: "Số điện thoại",
            vendorPartner: "Đối tác Nhà thầu",
            vendorSearchHint: "Tìm tên, mã số thuế...",
            startSearchPrompt: "Nhập tên hoặc mã NCC để bắt đầu...",
            noResultsFound: "Không tìm thấy kết quả nào khớp.",
            selectVendorPrompt: "Vui lòng chọn một nhà thầu để xem dữ liệu",
            activeContracts: "Hợp đồng hiện hữu",
            joinedProjects: "Dự án tham gia",
            cpcOutstanding: "CÔNG NỢ CPC CHƯA TRẢ",
            advBalance: "DƯ NỢ TẠM ỨNG",
            retentionHeld: "BẢO HÀNH ĐANG GIỮ",
            workProgress: "TIẾN ĐỘ THỰC HIỆN",
            retentionPool: "Quỹ bảo hành",
            unrecovered: "Chưa thu hồi",
            contractProjectHeader: "HỢP ĐỒNG & DỰ ÁN",
            contractValueHeader: "GIÁ TRỊ HĐ",
            confirmedCpc: "CPC ĐÃ XÁC NHẬN",
            acceptanceShort: "NT", // Viết tắt cho Nghiệm thu
            advBalShort: "Dư tạm ứng",
            cpcOutstanding: "CÔNG NỢ CPC CHƯA TRẢ",
            advBalance: "DƯ NỢ TẠM ỨNG",
            retentionHeld: "BẢO HÀNH ĐANG GIỮ",
            performance: "TIẾN ĐỘ THỰC HIỆN",
            vendorPartner: "Đối tác Nhà thầu",
            vendorSearchHint: "Tìm tên, mã số thuế...",
            totalCommitted: "TỔNG HẠN MỨC CAM KẾT",
            performance: "HIỆU SUẤT THỰC HIỆN",
            disbursedNet: "ĐÃ GIẢI NGÂN (NET)",
            retentionHeld: "BẢO HÀNH ĐANG GIỮ",
            contractList: "Danh sách Hợp đồng chi tiết",
            confirmedAmount: "Đã xác nhận / Thực chi",
            activeVendor: "Nhà thầu đang hoạt động",
            retentionPool: "Quỹ bảo hành",
            initialAdvance: "Tạm ứng ban đầu",
            additionalAdvance: "Tạm ứng bổ sung",
            currentAdvanceBalance: "Dư nợ tạm ứng hiện tại",
            processing: "Đang xử lý",
            contractOverview: "Tổng quan Hợp đồng",
            vendorPartner: "Đối tác Nhà thầu",
            mainContract: "HỢP ĐỒNG CHÍNH",
            totalValue: "Tổng giá trị",
            duration: "Thời hạn",
            acceptanceProgress: "TIẾN ĐỘ NGHIỆM THU",
            totalPaidHeader: "ĐÃ THANH TOÁN",
            totalPaidNote: "Tổng tiền đã giải ngân (Gồm VAT)",
            advanceBalanceHeader: "DƯ NỢ TẠM ỨNG",
            retentionValueHeader: "GIÁ TRỊ GIỮ LẠI",
            budget: "Dự toán",
            advanceFlow: "Dòng tiền Tạm ứng",
            totalRecovered: "Đã thu hồi/khấu trừ",
            toRecover: "Cần thu hồi tiếp",
            paymentHistory: "Lịch sử hồ sơ thanh toán",
            cpcStatusGroup: "Hồ sơ / Trạng thái nhóm",
            summaryPaid: "TỔNG CÁC ĐỢT ĐÃ THANH TOÁN XONG",
            summaryProcessing: "TỔNG CÁC ĐỢT ĐANG XỬ LÝ / DỞ DANG",
            backToDetails: "Quay lại Chi tiết CPC",
            viewOverviewMode: "Xem tổng quát (2 dòng)",
            viewDetailedMode: "Xem chi tiết từng đợt",
            bondEffective: "Thông tin Bảo lãnh (Còn hiệu lực)",
            noBonds: "Hợp đồng này hiện không có bảo lãnh nào.",
            agingReportDate: "Tính tuổi nợ đến ngày",
            viewByInvoice: "Theo Hóa đơn",
            viewByContract: "Theo Hợp đồng (CPC)",
            age1_30: "1-30 ngày",
            age31_60: "31-60 ngày",
            age61_90: "61-90 ngày",
            ageOver90: "> 90 ngày",
            totalOverdue: "Tổng nợ quá hạn",
            invoiceNet: "Nợ gốc",
            invoiceVat: "Thuế VAT",
            invoiceTotal: "Tổng cộng",
            contractDateLabel: "Ngày HĐ",
            descriptionLabel: "Mô tả",
            btnExportExcel: "Xuất Excel",
            promptSelectProjectAging:
              "Vui lòng chọn Dự án để xem dữ liệu tuổi nợ",
            noAgingData: "Không có dữ liệu quá hạn tính đến {date}",
            calculatingData: "Đang tính toán lại toàn bộ dữ liệu...",
            refreshSuccess: "Đã làm mới số liệu thành công!",
            phaseRowsInitialized:
              "Đã khởi tạo các dòng trống cho giai đoạn mới.",
            errorUploadInSummaryMode:
              "Bạn đang ở chế độ xem Tổng hợp. Vui lòng chọn Tab Giai đoạn cụ thể để tải lên dữ liệu.",
            phaseAddedSuccess: "Đã thêm giai đoạn mới thành công.",
            phaseRenamedSuccess: "Đổi tên thành công.",
            phaseDeletedSuccess: "Đã xóa giai đoạn và dữ liệu liên quan.",
            phaseDeleteError: "Lỗi hệ thống khi xóa dữ liệu.",
            filteringBondForContract:
              "Đang lọc các bảo lãnh sắp/đã hết hạn của HĐ: {contractNo}",
            vendorNoContractWarning:
              "Nhà cung cấp này chưa có hợp đồng nào trong hệ thống (Chỉ có trong Kế toán).",
            filteringContractForVendor:
              "Đang lọc hợp đồng của: {vendorName}",
            errorDateInvalidField:
              "Ngày '{dateStr}' cho trường '{field}' không hợp lệ. Vui lòng chọn ngày trong khoảng 2010-2040.",
            errorDateInvalidInstallment:
              "Ngày trong các đợt thanh toán không hợp lệ (phải từ 2010-2040).",
            errorPaymentExceedsDetailsNegative:
              "Giá trị cấn trừ ({totalPaid}) không hợp lệ cho khoản phải thu ({cpcAmount}). Vui lòng nhập giá trị dương và không lớn hơn {absAmount}.",
            errorContractNotFound: "Lỗi: Không tìm thấy hợp đồng gốc.",
            rowAddedSuccess: "Đã thêm dòng mới.",
            rowAddError: "Không thể thêm dòng mới.",
            errorNoRowsToUpdateInvoice:
              "Không tìm thấy dòng nào để cập nhật hóa đơn.",
            dataAppendedSuccess: "Đã nối tiếp dữ liệu vào {phaseName}.",
            dataAppendError: "Lỗi khi thêm nối tiếp dữ liệu.",
            dataOverwrittenSuccess: "Đã thay thế dữ liệu cho {phaseName}.",
            noValidDataFound: "Không tìm thấy dữ liệu hợp lệ trong file.",
            resyncStarted: "Bắt đầu quá trình kiểm tra và đồng bộ hóa...",
            resyncComplete:
              "Hoàn tất! Đã kiểm tra và cập nhật {count} bản ghi.",
            resyncError: "Quá trình đồng bộ hóa đã xảy ra lỗi.",
            errorSelectContractToExport:
              "Vui lòng chọn một hợp đồng để xuất.",
            errorNoDetailDataToExport: "Không có dữ liệu chi tiết để xuất.",
            exportDetailsSuccess: "Xuất chi tiết thành công.",
            errorProjectNameRequired: "Vui lòng nhập tên Dự án.",
            errorProjectNameExists: "Tên dự án '{name}' đã tồn tại.",
            projectAddSuccess: "Thêm dự án mới thành công!",
            projectUpdateSuccess: "Cập nhật dự án thành công!",
            projectSaveError: "Lưu dự án thất bại.",
            warningMismatchVatPayment:
              "VAT Đã trả ({paid}) >= VAT Hóa đơn ({invoice}). Dòng bị bỏ qua.",
            historyRecord: "Lịch sử GH",
            settledStatus: "Đã tất toán",
            viewDetails: "Xem chi tiết",
            renewalHistoryTooltip: "Lịch sử gia hạn",
            quickSettleTooltip: "Bật/Tắt trạng thái Quyết toán nhanh",
            bondSettled: "Đã tất toán",
            tabInvoiceAging: "Công nợ Hóa đơn",
            invoiceFilterTitle: "Bộ lọc Hóa đơn",
            ageDays: "Tuổi nợ (Ngày)",
            filterOverdueDays: "Lọc quá hạn trên:",
            daysUnit: "ngày",
            remainingNet: "Còn lại (Net)",
            remainingVat: "Còn lại (VAT)",
            remainingTotal: "Tổng còn lại",
            promptSelectProjectForAging:
              "Vui lòng chọn Dự án để xem công nợ hóa đơn",
            promptSelectProjectForAgingDesc:
              "Chọn 'Hiện bộ lọc' -> 'Dự án' để bắt đầu.",
            noInvoiceAgingData:
              "Không tìm thấy hóa đơn công nợ nào thỏa mãn điều kiện.",
            invoiceNoLabel: "Số Hóa đơn",
            sidebarPin: "Ghim Menu",
            sidebarUnpin: "Tự động thu gọn",
            swapProduct: "Sản phẩm SWAP",
            generalNotes: "Ghi chú chung",
            addNoteTab: "Thêm tab ghi chú mới",
            promptNewTabTitle: "Vui lòng nhập tiêu đề cho tab mới:",
            promptAddNoteTab: "Thêm một tab mới để bắt đầu ghi chú.",
            confirmDeleteTabTitle: "Xóa Tab",
            confirmDeleteTabMessage:
              "Bạn có chắc chắn muốn xóa tab {title} không? Toàn bộ nội dung trong tab này sẽ bị mất.",
            significantNotes: "Điều khoản quan trọng",
            viewEditNotes: "Xem/Sửa",
            significantNotesTitle: "Ghi chú Điều khoản Thanh toán",
            notesPlaceholder:
              "Nhập các điều kiện thanh toán quan trọng của hợp đồng tại đây...",
            noNotesAvailable: "Chưa có ghi chú nào.",
            btnExportVendors: "Xuất NCC",
            btnUploadCategories: "Tải lên Hạng mục",
            categoryUploadSuccess:
              "Đã xử lý thành công {added} hạng mục mới và {updated} hạng mục cập nhật.",
            categoryUploadSkipped:
              "Đã bỏ qua {skipped} dòng do thiếu dữ liệu hoặc có lỗi.",
            errorNoCategoryDataToExport:
              "Không có dữ liệu hạng mục để xuất.",
            categoryExportSuccess: "Xuất danh sách hạng mục thành công!",
            categoryTab: "Hạng mục Báo cáo",
            addCategory: "Thêm Hạng mục",
            categoryTableHeaderNo: "STT",
            categoryTableHeaderCode: "Mã",
            categoryTableHeaderNameVi: "Tên Tiếng Việt",
            categoryTableHeaderNameEn: "Tên Tiếng Anh",
            categoryTableHeaderUsage: "Số HĐ sử dụng",
            categoryTableNoData: "Chưa có hạng mục nào.",
            categoryModalAddTitle: "Thêm Hạng mục Mới",
            categoryModalEditTitle: "Chỉnh sửa Hạng mục",
            categoryParentLabel: "Hạng mục cha (Để trống nếu là cấp 1)",
            categoryParentOption: "-- Là hạng mục cha (Cấp 1) --",
            categoryCodeLabel: "Mã Hạng mục",
            categoryCodeReadonly: "Không thể thay đổi mã sau khi đã tạo.",
            categoryNameViLabel: "Tên Tiếng Việt",
            categoryNameEnLabel: "Tên Tiếng Anh",
            errorCategoryRequired: "Mã và Tên Tiếng Việt là bắt buộc.",
            errorCategoryCodeExists: "Mã hạng mục '{code}' đã tồn tại.",
            categoryAddSuccess: "Thêm hạng mục mới thành công!",
            categoryUpdateSuccess: "Cập nhật hạng mục thành công!",
            categorySaveFailed: "Lưu hạng mục thất bại.",
            errorCategoryInUse:
              "Không thể xóa hạng mục đang được sử dụng bởi một hoặc nhiều hợp đồng.",
            confirmDeleteCategory:
              "Bạn có chắc chắn muốn xóa hạng mục <strong>{code} - {name}</strong> không?",
            warningDeleteParentCategory:
              "<strong class='text-danger'>CẢNH BÁO:</strong> Đây là hạng mục cha. Toàn bộ <strong>{count}</strong> hạng mục con cũng sẽ bị xóa.",
            errorDeleteParentInUse:
              "Không thể xóa hạng mục cha vì một trong các hạng mục con đang được sử dụng.",
            categoryDeleteSuccess: "Đã xóa hạng mục thành công.",
            categoryDeleteFailed: "Xóa hạng mục thất bại.",
            confirmSendCpcTitle: "Xác nhận gửi CPC",
            confirmUpdateCpcMessage:
              "CPC <strong>{cpcNo}</strong> đã tồn tại. Bạn có muốn cập nhật giá trị thành <strong>{amount}</strong> dựa trên tổng các dòng chi tiết không?",
            btnUpdate: "Cập nhật",
            confirmSendCpcMessage:
              "Bạn có chắc chắn muốn gửi CPC <strong>{cpcNo}</strong> với tổng giá trị là <strong>{amount}</strong> không?",
            btnSend: "Gửi",
            editProject: "Sửa Dự án",
            validationErrorTitle: "Lỗi Xác thực Dữ liệu File Excel",
            validationErrorIntro:
              "Không thể nhập file vì đã phát hiện các lỗi sau. Vui lòng sửa chúng trong file Excel của bạn và thử lại:",
            validationSheet: "Sheet",
            validationRow: "Dòng",
            validationMessage: "Nội dung lỗi",
            validationErrorRequired:
              "Trường bắt buộc '<strong>{field}</strong>' bị bỏ trống.",
            validationErrorNoContract:
              "Hợp đồng '<strong>{contractNo}</strong>' không tồn tại trong Dữ liệu Nguồn của hệ thống.",
            validationErrorDuplicate:
              "CPC với số này cho hợp đồng này đã tồn tại (trong CSDL hoặc bị trùng lặp trong file).",
            validationErrorOrphaned:
              "Thanh toán mồ côi: không tìm thấy CPC cha tương ứng hoặc CPC cha không hợp lệ trong sheet 'CPC_Main'.",
            cpcUploadSuccess:
              "Đã thêm thành công {cpcCount} CPC và {instCount} đợt thanh toán.",
            uploadSkipped: "Đã bỏ qua {count} dòng do lỗi.",
            uploadSkippedReasonMissingData:
              "Thiếu thông tin bắt buộc 'contractNo' hoặc 'cpc'.",
            uploadSkippedReasonNoContract:
              "Hợp đồng '{contractNo}' không được tìm thấy trong Dữ liệu Nguồn.",
            uploadSkippedReasonDuplicate:
              "CPC cho hợp đồng này đã tồn tại (trong CSDL hoặc trong file).",
            uploadSkippedReasonOrphaned:
              "Thanh toán mồ côi: không tìm thấy CPC cha hợp lệ trong file.",
            confirmSettleTitle: "Xác nhận Quyết toán",
            confirmCancelSettleTitle: "Xác nhận Hủy Quyết toán",
            confirmSettleMessage:
              "Bạn có chắc chắn muốn quyết toán bảo lãnh <strong>{bondNumber}</strong> không?",
            confirmCancelSettleMessage:
              "Bạn có chắc chắn muốn hủy trạng thái quyết toán của bảo lãnh <strong>{bondNumber}</strong> không?",
            btnConfirmSettle: "Đồng ý Quyết toán",
            btnConfirmCancelSettle: "Đồng ý Hủy",
            bondSettledSuccess:
              "Bảo lãnh '{bondNumber}' đã được quyết toán.",
            bondUnsettledSuccess:
              "Đã hủy quyết toán cho bảo lãnh '{bondNumber}'.",
            errorFindBondToUpdate:
              "Lỗi: Không tìm thấy bảo lãnh để cập nhật.",
            errorUpdateBondStatus:
              "Không thể cập nhật trạng thái bảo lãnh.",
            tooltipBondRenewed: "Đã gia hạn, không thể thay đổi.",
            tooltipBondCancelSettle: "Nhấn để hủy quyết toán.",
            tooltipBondQuickSettle: "Nhấn để quyết toán nhanh.",
            btnUploadBonds: "Tải lên Bảo lãnh",
            btnExportBonds: "Xuất Bảo lãnh",
            errorNoBondDataToExport: "Không có dữ liệu bảo lãnh để xuất.",
            bondExportSuccess: "Xuất dữ liệu bảo lãnh thành công!",
            bondUploadSuccess: "Đã thêm thành công {count} bảo lãnh mới.",
            bondUploadNone: "Không có bảo lãnh nào mới được thêm.",
            bondUploadSkipped: " Đã bỏ qua {count} dòng do lỗi.",
            bondUploadReasonMissingData:
              "Thiếu số Hợp đồng hoặc số Bảo lãnh.",
            bondUploadReasonExists: "Số Bảo lãnh đã tồn tại.",
            bondUploadReasonNoContract:
              "Không tìm thấy Hợp đồng '{contractNo}'.",
            bondUploadSkippedConsole: "Các bảo lãnh bị bỏ qua:",
            excelHeaderContract: "Hợp đồng",
            excelHeaderBondNumber: "Số Bảo lãnh",
            excelHeaderReference: "Tham chiếu",
            excelHeaderBondType: "Loại Bảo lãnh",
            excelHeaderAmount: "Số tiền",
            excelHeaderIssueDate: "Ngày phát hành",
            excelHeaderExpiryDate: "Ngày hết hạn",
            excelHeaderBank: "Ngân hàng",
            excelHeaderStatus: "Trạng thái",
            appTitle: "CPC Vision",
            toggleLanguage: "Đổi ngôn ngữ",
            btnClose: "Đóng",
            btnSaveChanges: "Lưu thay đổi",
            btnCancel: "Hủy",
            confirm: "Xác nhận",
            warning: "Cảnh báo",
            areYouSure: "Bạn có chắc chắn không?",
            actionCannotBeUndone: "Hành động này không thể được hoàn tác.",
            allFiltersCleared: "Tất cả bộ lọc đã được xóa.",
            activeFilters: "Bộ lọc đang áp dụng",
            editFilters: "Sửa Bộ lọc",
            noActiveFilters: "Không có bộ lọc nào được áp dụng.",
            filterPanelTitle: "Bảng điều khiển Bộ lọc",
            search: "Tìm kiếm",
            columns: "Các cột",
            subColumns: "Các cột con",
            total: "Tổng cộng",
            grandTotal: "TỔNG CỘNG",
            footerRemaining: "Số dư còn lại",
            status: "Trạng thái",
            action: "Hành động",
            saveChanges: "Lưu thay đổi",
            saved: "Đã lưu",
            unsaved: "Chưa lưu",
            unsavedChangesTooltip:
              "Bạn có các thay đổi chưa được lưu. Nhấn nút để lưu lại.",
            savedStatusTooltip:
              "Mọi thay đổi đã được lưu vào trình duyệt của bạn.",
            guideTitle: "Hướng dẫn sử dụng",
            print: "In",
            viewAs: "Xem theo",
            configure: "Cấu hình",
            banks: "Ngân hàng",
            ok: "OK",
            na: "Không có",
            calculationRules: "Quy tắc Tính toán",
            repaymentThresholdLabel: "Tỷ lệ tính Khấu trừ Tạm ứng (%)",
            repaymentThresholdNote: "Mặc định: 80%.",
            retentionRateLabel: "Tỷ lệ Giữ lại (%)",
            retentionRateNote: "Mặc định: 5%.",
            defaultVatRateLabel: "Tỷ lệ VAT Mặc định (%)",
            defaultVatRateNote: "Mặc định: 8%.",
            hide: "Ẩn",
            change: "Sửa",
            tabCpcTracking: "Theo dõi CPC",
            cpctracking: "Theo dõi CPC",
            tabCpcDetails: "Chi tiết CPC",
            cpcdetails: "Chi tiết CPC",
            tabVendorBalance: "Cân đối Công nợ",
            vendorbalance: "Cân đối Công nợ NCC",
            tabPaymentDashboard: "Thanh toán",
            cpcdashboard: "Bảng điều khiển Thanh toán",
            tabSwapDashboard: "SWAP",
            cpcswapdashboard: "Bảng điều khiển SWAP",
            tabBondDashboard: "Bảo lãnh",
            cpcbonddashboard: "Bảng điều khiển Bảo lãnh",
            tabContractDashboard: "Hợp đồng",
            cpccontractdashboard: "Bảng điều khiển Hợp đồng",
            tabReportDashboard: "Báo cáo",
            cpcreportdashboard: "Báo cáo Dashboard",
            tabCogsDashboard: "COGS",
            cogsdashboard: "Bảng điều khiển COGS",
            masterdata: "Dữ liệu Nguồn",
            btnAddCpc: "Thêm CPC",
            btnAddContract: "Thêm Hợp đồng",
            btnAddBond: "Thêm Bảo lãnh",
            btnUploadContracts: "Tải lên Hợp đồng",
            btnData: "Dữ liệu",
            btnTemplate: "Tệp Mẫu",
            btnUpload: "Nhập từ Excel",
            btnUploadMerge: "Tải lên & Trộn",
            btnExport: "Xuất ra Excel",
            btnExportJson: "Xuất ra JSON",
            btnSaveToFile: "Sao lưu ra File",
            btnOpenFile: "Phục hồi từ File",
            btnClearAll: "Xóa Tất cả",
            btnClearAllFilters: "Xóa Tất cả Bộ lọc",
            btnEdit: "Sửa",
            btnAdd: "Thêm",
            btnRenew: "Gia hạn",
            btnDelete: "Xoá",
            btnPrevious: "Trang trước",
            btnNext: "Trang sau",
            btnDownloadDetailsTemplate: "Mẫu Chi tiết",
            btnUploadDetails: "Tải lên Chi tiết",
            btnExportDetails: "Xuất Chi tiết",
            btnBackupProject: "Sao lưu Dự án",
            btnImportProject: "Nhập Dự án",
            btnBackup: "Sao lưu",
            btnRestore: "Phục hồi",
            btnUploadReconcile: "Tải lên & Đối chiếu",
            btnClear: "Xóa",
            btnDebugVendor: "Debug NCC theo Mã",
            btnUploadCogs: "Tải lên & Đối chiếu COGS",
            btnClearCogs: "Xóa Đối chiếu",
            btnAddVendor: "Thêm NCC",
            btnDownloadTemplate: "Tải Template",
            btnCleanupData: "Dọn dẹp Dữ liệu",
            btnAddProject: "Thêm Dự án",
            btnAddBank: "Thêm Ngân hàng",
            btnClearVisibleContracts: "Xóa Hợp đồng Hiển thị",
            btnClearVisibleBonds: "Xóa các Bảo lãnh đang hiển thị",
            showEntriesLabel: "Hiển thị:",
            entriesUnit: "mục",
            searchPlaceholder: "Tìm kiếm...",
            clearSearchTooltip: "Xóa tìm kiếm",
            tableHeaderNo: "STT",
            tableHeaderAction: "Hành động",
            noMatchingData:
              "Không có dữ liệu nào khớp với bộ lọc hiện tại.",
            paginationInfo:
              "Hiển thị từ {start} đến {end} trong tổng số {total} mục",
            paginationPageInfo: "Trang {currentPage} / {totalPages}",
            project: "Dự án",
            vendor: "Nhà cung cấp",
            code: "Mã",
            glaccount: "Tài khoản G/L",
            contract: "Hợp đồng",
            date: "Ngày",
            postingDate: "Ngày hạch toán",
            currency: "Loại tiền tệ",
            bondType: "Loại bảo lãnh",
            dateRange: "Khoảng thời gian",
            startDate: "Ngày bắt đầu",
            endDate: "Ngày kết thúc",
            searchProjects: "Tìm dự án...",
            searchVendors: "Tìm nhà cung cấp...",
            searchCodes: "Tìm mã...",
            searchContracts: "Tìm hợp đồng...",
            searchTypes: "Tìm loại...",
            searchPaymentSources: "Tìm nguồn thanh toán...",
            tooltipClearFilter: "Xóa bộ lọc",
            tooltipResetDate: "Đặt lại khoảng ngày",
            cpc: "CPC",
            contents: "Nội dung",
            department: "Bộ phận",
            contractSystemNo: "Số HĐ trên hệ thống",
            vendorNo: "Mã nhà cung cấp",
            amountInclVAT: "Số tiền (gồm VAT)",
            receivedDate: "Ngày nhận",
            paymentDueDate: "Hạn thanh toán",
            amountPaid: "Số tiền đã trả",
            paymentDate: "Ngày thanh toán",
            lineTracking: "Theo dõi trình ký",
            notes: "Ghi chú",
            installment: "Đợt thanh toán",
            bond: "Bảo lãnh",
            moreInfo: "Thêm",
            installment_ordinal: "Đợt {num}{ordinal}",
            installment_swap: "Đợt {num}{ordinal}",
            noPaymentsAvailable: "Không có dữ liệu thanh toán.",
            tooltipEdit: "Sửa",
            tooltipCopy: "Sao chép",
            tooltipDelete: "Xóa",
            complete: "Hoàn thành",
            partialpayment: "TT một phần",
            pending: "Chờ xử lý",
            completeswap: "Hoàn thành SWAP",
            partialswap: "SWAP một phần",
            completeswappayment: "Hoàn thành TT SWAP",
            partialswappayment: "TT SWAP một phần",
            status_overdue_days: "Quá hạn {days} ngày",
            status_due_today: "Đến hạn hôm nay",
            status_days_left: "Còn {days} ngày",
            completeWithOffset: "Hoàn thành (Cấn trừ)",
            swap: "SWAP",
            swapPayments: "Các đợt thanh toán SWAP",
            addSwapPayment: "Thêm đợt thanh toán SWAP",
            swapPaidLabel: "Đã thanh toán SWAP",
            vendorSWAP: "Nhà cung cấp SWAP",
            swapAgreement: "Thỏa thuận SWAP",
            agreementDate: "Ngày Thỏa thuận",
            swapInformation: "Thông tin SWAP",
            swapDueDatePayment: "Hạn thanh toán SWAP",
            swapAmountPaid: "Đã trả SWAP",
            paidStatus: "Đã trả",
            unpaidStatus: "Chưa trả",
            collected: "Đã thu hồi",
            partiallyCollected: "Thu hồi một phần",
            uncollected: "Chưa thu hồi",
            swapPaymentDate: "Ngày thanh toán SWAP",
            duebond: "Bảo lãnh đến hạn/hết hạn",
            bondNumber: "Số bảo lãnh",
            ref: "Tham chiếu",
            issueDate: "Ngày phát hành",
            expiryDate: "Ngày hết hạn",
            issuingBank: "Ngân hàng phát hành",
            quickSettle: "Quyết toán nhanh",
            bond_status_overdue: "Quá hạn {days} ngày",
            bond_status_expiring: "Hết hạn trong {days} ngày",
            bond_status_active: "Hiệu lực",
            renewedStatus: "Đã gia hạn",
            noExpenseData: "Không có dữ liệu chi phí nào khớp với bộ lọc.",
            noBondData: "Không có dữ liệu bảo lãnh nào khớp với bộ lọc.",
            noSwapData: "Không có dữ liệu SWAP nào khớp với bộ lọc.",
            gl3311: "Phải trả NCC",
            gl3312: "Tạm ứng NCC",
            outstandingBalanceStatus: "Trạng thái Công nợ",
            balanceStatusHasBalance: "Phải trả/Tạm ứng ≠ 0",
            fullySettled: "Phải trả & Tạm ứng = 0",
            reportAsOf: "Báo cáo tính đến",
            reportAsOfNote: "Để trống để xem số dư hiện tại.",
            payableSap: "Phải trả (SAP)",
            advanceSap: "Tạm ứng (SAP)",
            difference: "Chênh lệch",
            statusMatch: "Khớp",
            statusMismatch: "Lệch",
            statusOnlyinApp: "Chỉ có trên App",
            statusOnlyinAccounting: "Chỉ có trên SAP",
            cogsSummaryTitle: "Tổng hợp theo Tài khoản Kế toán",
            cogsDetailTitle: "Chi tiết Hợp đồng để Đối chiếu",
            invAmountApp: "Giá trị HĐ (App)",
            invAmountSap: "Giá trị HĐ (SAP)",
            reconciliationStatus: "Trạng thái",
            transactionType: "Loại Giao dịch",
            transactionTypeReceivable: "Thu hồi Công nợ",
            transactionTypePayable: "Thanh toán Phải trả",
            modalTitleEdit: "Sửa Mục CPC",
            modalTitleCopy: "Sao chép Mục CPC",
            modalTitleAdd: "Thêm Mục CPC Mới",
            modalTitleEditFinancials: "Sửa Tài chính & Thanh toán",
            modalTitleAddContract: "Thêm Hợp đồng Mới",
            modalTitleEditContract: "Sửa Hợp đồng",
            modalTitleAddVendor: "Thêm NCC Mới",
            editVendor: "Sửa NCC",
            modalTitleEditInstallment: "Sửa Thanh toán",
            modalTitleEditContractDetail: "Sửa Chi tiết Hợp đồng",
            modalTitleEditCpcDetail: "Sửa Chi tiết CPC",
            modalTitleEditPaymentDetail: "Sửa Chi tiết Thanh toán",
            modalTitleEditInvoiceDetail: "Sửa Chi tiết Hóa đơn",
            editSwapTitle: "Chỉnh sửa Chi tiết SWAP",
            modalSectionMain: "Thông tin chính",
            modalSectionFinancial: "Tài chính & Ngày tháng",
            modalSectionSystem: "Thông tin hệ thống",
            amountExclVAT: "Số tiền (chưa VAT)",
            vatAmount: "VAT",
            amountUSD: "Số tiền USD",
            exchangeRate: "Tỷ giá",
            invoiceExchangeRate: "Tỷ giá Hóa đơn",
            paymentInUSD: "Thanh toán bằng USD",
            paymentInstallments: "Các đợt thanh toán",
            paymentSource: "Nguồn thanh toán",
            addInstallment: "Thêm đợt",
            bondInformation: "Thông tin bảo lãnh",
            selectBondType: "Chọn loại bảo lãnh",
            prepaymentBond: "Bảo lãnh tạm ứng",
            performanceBond: "Bảo lãnh thực hiện HĐ",
            warrantyBond: "Bảo lãnh bảo hành",
            addBond: "Thêm bảo lãnh",
            bondDetailsFor: "Chi tiết bảo lãnh cho",
            noBondInfo: "Không có thông tin bảo lãnh cho mục này.",
            updateBondStatus: "Cập nhật trạng thái bảo lãnh",
            statusUpdate: "Cập nhật trạng thái",
            advancePaymentsCleared: "Khoản tạm ứng đã được khấu trừ hết",
            contractSettled: "Hợp đồng đã được quyết toán",
            otherReason: "Lý do khác",
            inputCustomReason: "Nhập lý do tùy chỉnh",
            renewBond: "Gia hạn bảo lãnh",
            originalBondNumber: "Số bảo lãnh gốc",
            originalBondType: "Loại bảo lãnh gốc",
            originalExpiryDate: "Ngày hết hạn gốc",
            originalAmount: "Số tiền gốc",
            newRenewalDetails: "Chi tiết gia hạn mới",
            newBondNumber: "Số bảo lãnh mới",
            newBondType: "Loại bảo lãnh mới",
            newAmount: "Số tiền mới",
            newIssueDate: "Ngày phát hành mới",
            newExpiryDate: "Ngày hết hạn mới",
            newIssuingBank: "Ngân hàng phát hành mới",
            renewalNotes: "Ghi chú gia hạn",
            btnSaveRenewal: "Lưu Gia hạn",
            updateContractStatus: "Cập nhật Trạng thái Hợp đồng",
            active: "Hoạt động",
            closed: "Đã đóng",
            statusNote: "Ghi chú Trạng thái",
            selectContract: "Chọn Hợp đồng",
            promptSelectContract:
              "Vui lòng chọn một dự án và một nhà cung cấp",
            pleaseSelectContractToView:
              "Vui lòng chọn một hợp đồng để xem hoặc nhập dữ liệu.",
            loadFromXml: "Tải từ XML",
            addNewRow: "Thêm Dòng mới",
            deleteRow: "Xóa Dòng",
            deleteContents: "Xóa Nội dung",
            contractinfo: "Thông tin HĐ",
            details: "Mô tả",
            amount: "Số tiền",
            net: "Net",
            vat: "VAT",
            repaymentBasisTitle:
              "Chọn các giá trị Hợp đồng/VON để tính toán khấu trừ",
            noBasisAvailable:
              "Không có giá trị Hợp đồng/VON nào ở các dòng trước hoặc dòng hiện tại.",
            calcRepayOnWorkdone: "Tính Repayment trên Work-done",
            finalSettlement: "Quyết toán",
            distributeToCpcRows: "Phân bổ cho các dòng CPC:",
            columnGroupContract: "Hợp đồng",
            columnGroupCpc: "CPC",
            columnGroupPayment: "Thanh toán",
            columnGroupInvoice: "Hóa đơn",
            columnGroupRemainingPayable: "Còn lại phải trả",
            columnGroupContractRemaining: "HĐ còn lại",
            reportAsOfDate: "Tính đến ngày",
            reportMonth: "Báo cáo cho tháng",
            category: "HẠNG MỤC",
            reportPaidToDateHeader: "Số đã thanh toán đến ngày {date}",
            reportRemainingFromDateHeader:
              "Số còn phải thanh toán kể từ ngày {date}",
            reportPaidInMonthHeader: "Số thanh toán trong tháng {month}",
            vendor_tab: "Nhà cung cấp",
            project_tab: "Dự án",
            banks_tab: "Ngân hàng",
            abbreviation: "Tên viết tắt",
            contractCount: "Số Hợp đồng",
            searchVendorPlaceholder: "Tìm Nhà cung cấp...",
            noVendorsFound: "Không tìm thấy nhà cung cấp nào.",
            searchProjectPlaceholder: "Tìm Dự án...",
            projectContractCount: "Số HĐ liên quan",
            noProjectsFound: "Không tìm thấy dự án nào.",
            searchBankPlaceholder: "Tìm Ngân hàng...",
            bankContractCount: "Số BL đã phát hành",
            noBanksFound: "Không tìm thấy ngân hàng nào.",
            commandPalettePlaceholder: "Tìm Hợp đồng, CPC, Nhà cung cấp...",
            commandPaletteNoResults: "Không tìm thấy kết quả.",
            cpc_search: "CPC",
            contract_search: "HỢP ĐỒNG",
            notificationHeader: "Thông báo Bảo lãnh",
            noNotifications:
              "Không có bảo lãnh nào sắp hết hạn hoặc đã quá hạn.",
            changesSavedSuccess: "Đã lưu các thay đổi thành công.",
            errorPaymentDate:
              "Ngày thanh toán là bắt buộc đối với các đợt có số tiền lớn hơn không.",
            errorPostingDateRequired:
              "Ngày hạch toán là bắt buộc để lưu hóa đơn.",
            errorPaymentExceedsDetails:
              "Tổng số tiền thanh toán ({totalPaid}) vượt quá số tiền CPC ({cpcAmount}) là {overExcessAmount}.",
            contractCreatedAutomatically:
              "Một hợp đồng mới đã được tự động tạo trong danh sách chính.",
            confirmDeletion: "Xác nhận Xóa",
            confirmDeleteCpcItem:
              "Bạn có chắc chắn muốn xóa mục CPC <strong>{cpc}</strong> không? Hành động này không thể hoàn tác.",
            confirmDeleteRow:
              "Bạn có chắc chắn muốn xóa toàn bộ dòng này không?",
            itemDeleted: "Đã xóa mục thành công.",
            rowDeleted: "Đã xóa dòng thành công.",
            confirmClearAllData:
              "Điều này sẽ xóa vĩnh viễn tất cả dữ liệu CPC và Hợp đồng. Bạn có chắc chắn muốn tiếp tục không?",
            yesClearAll: "Vâng, Xóa Tất cả",
            allDataCleared: "Tất cả dữ liệu của ứng dụng đã được xóa.",
            fileSaveSuccess: "Đã lưu tệp dữ liệu thành công.",
            confirmDataLoad: "Xác nhận Tải Dữ liệu",
            confirmOverwriteData:
              "Điều này sẽ ghi đè tất cả dữ liệu chưa được lưu hiện tại bằng nội dung từ tệp. Bạn có chắc không?",
            loadSuccess: "Dữ liệu đã được tải thành công.",
            invalidJsonFormat: "Định dạng tệp JSON không hợp lệ.",
            errorParsingJson: "Lỗi khi xử lý tệp JSON.",
            errorInvalidExcelFile:
              "Loại tệp không hợp lệ. Vui lòng tải lên tệp .xlsx hoặc .xls.",
            itemsUploaded: "Đã tải lên thành công {count} mục.",
            noValidItems:
              "Không tìm thấy mục hợp lệ mới nào trong tệp để tải lên.",
            errorProcessingExcel: "Đã xảy ra lỗi khi xử lý tệp Excel.",
            errorContractNumberRequired:
              "Số hợp đồng là một trường bắt buộc.",
            errorContractExists:
              "Một hợp đồng với số này đã tồn tại trong danh sách chính.",
            contractSavedSuccess: "Đã lưu hợp đồng thành công.",
            confirmDeleteContract:
              "Bạn có chắc chắn muốn xóa hợp đồng <strong>{contractNo}</strong> khỏi danh sách chính không? Hành động này không thể hoàn tác.",
            contractDeletedSuccess: "Hợp đồng đã được xóa thành công.",
            errorUpdatingPayment:
              "Lỗi: Không thể tìm thấy thanh toán gốc để cập nhật.",
            confirmDeleteBond:
              "Bạn có chắc chắn muốn xóa bảo lãnh <strong>{bondNumber}</strong> không?",
            bondDeletedSuccess: "Bảo lãnh đã được xóa thành công.",
            errorFindBondToDelete:
              "Lỗi: Không thể tìm thấy bảo lãnh cụ thể để xóa.",
            errorFindOriginalCpcItem:
              "Lỗi: Không thể tìm thấy mục CPC gốc cho hoạt động này.",
            errorNewBondDates:
              "Ngày phát hành mới và ngày hết hạn mới là bắt buộc để gia hạn bảo lãnh.",
            bondRenewedSuccess:
              "Bảo lãnh đã được gia hạn thành công và một mục bảo lãnh mới đã được thêm vào.",
            bondInfoSaved: "Thông tin bảo lãnh đã được lưu.",
            cpcSentToTracking: "CPC đã được gửi sang tab Theo dõi.",
            cpcUpdatedInTracking: "CPC đã được cập nhật ở tab Theo dõi.",
            cpcPaymentUpdatedInDetails:
              "Thông tin thanh toán đã được cập nhật vào tab Chi tiết CPC.",
            errorNoDataToSend:
              "Không có dữ liệu CPC trên dòng này để gửi đi.",
            paymentManagedInTracking:
              "Chi tiết thanh toán được quản lý ở tab Theo dõi CPC.",
            detailsDataUploaded:
              "Dữ liệu chi tiết cho hợp đồng {contractNo} đã được cập nhật thành công.",
            confirmOverwriteDetails:
              "Thao tác này sẽ thay thế tất cả chi tiết hiện có của hợp đồng <strong>{contractNo}</strong> bằng dữ liệu từ tệp. Bạn có chắc không?",
            contractStatusUpdated:
              "Cập nhật trạng thái hợp đồng thành công.",
            confirmClearVisibleBonds:
              "Bạn có chắc chắn muốn xóa <strong>{count}</strong> bảo lãnh đang hiển thị không? Hành động này không thể hoàn tác.",
            confirmClearVisibleContracts:
              "Bạn có chắc chắn muốn xóa <strong>{count}</strong> hợp đồng đang hiển thị không? Hành động này không thể hoàn tác.",
            visibleBondsCleared: "{count} bảo lãnh đã được xóa.",
            visibleContractsCleared: "{count} hợp đồng đã được xóa.",
            cogsReconciliationCleared:
              "Dữ liệu đối chiếu COGS đã được xóa.",
            cogsUploadSuccess:
              "Tải lên thành công! Đã xử lý {count} dòng dữ liệu.",
            accountingReconciliationCleared:
              "Dữ liệu đối chiếu đã được xóa.",
            accountingUploadSuccess:
              "Tải lên thành công! Đã xử lý {count} mã Nhà cung cấp từ file.",
            projectDeletedSuccess: "Dự án đã được xóa thành công.",
            projectDeleteFailed: "Xóa dự án thất bại.",
            vendorDeletedSuccess: "Nhà cung cấp đã được xóa thành công.",
            vendorDeleteFailed: "Xóa nhà cung cấp thất bại.",
            errorProjectVendorRequired:
              "Vui lòng nhập đầy đủ thông tin Dự án và Nhà cung cấp.",
            errorSavingCpc: "Lưu dữ liệu CPC thất bại.",
            vendorSavedSuccess:
              "Thông tin nhà cung cấp đã được lưu thành công!",
            vendorSaveFailed: "Lưu thông tin nhà cung cấp thất bại.",
            errorVendorNameRequired: "Vui lòng nhập tên Nhà cung cấp.",
            errorVendorNoRequired: "Vui lòng nhập Mã Nhà cung cấp.",
            errorVendorNameExists:
              "Nhà cung cấp '{vendorName}' đã tồn tại.",
            errorVendorNoExists: "Mã nhà cung cấp '{vendorNo}' đã tồn tại.",
            errorLoadingFromDb:
              "Không thể tải dữ liệu từ cơ sở dữ liệu của trình duyệt.",
            errorSavingChanges: "Lưu thay đổi thất bại.",
            errorSheetNotFound:
              "Không tìm thấy sheet '{sheetName}' trong file Excel.",
            errorNoValidDataInExcel:
              "Không tìm thấy dữ liệu hợp lệ trong file Excel.",
            errorVendorInUse:
              "Không thể xóa nhà cung cấp đang được sử dụng trong hợp đồng.",
            errorProjectInUse:
              "Không thể xóa dự án đang được sử dụng trong hợp đồng.",
            confirmDeleteVendorMessage:
              "Bạn có chắc chắn muốn xóa Nhà cung cấp '<strong>{vendorName}</strong>' không? Hành động này không thể hoàn tác.",
            confirmDeleteProjectMessage:
              "Bạn có chắc chắn muốn xóa Dự án '<strong>{projectName}</strong>' không?",
            alertAddProjectNotImplemented:
              "Chức năng 'Thêm Dự án' sẽ được phát triển.",
            alertEditProjectNotImplemented:
              "Chức năng 'Sửa Dự án' sẽ được phát triển.",
            modalTitleBackupProject: "Sao lưu Dữ liệu Dự án",
            promptSelectProject: "-- Chọn một dự án --",
            errorSelectProject: "Vui lòng chọn một dự án.",
            projectExportSuccess:
              "Đã xuất dữ liệu cho dự án '{projectName}' thành công.",
            errorProjectNotFound: "Không tìm thấy dự án.",
            confirmOverwriteProjectTitle: "Dự án đã Tồn tại",
            confirmOverwriteProjectMessage:
              "Dự án '<strong>{projectName}</strong>' đã có trong dữ liệu hiện tại. Bạn có muốn <strong>xóa toàn bộ dữ liệu cũ</strong> của dự án này và thay thế bằng dữ liệu từ file không?",
            btnOverwrite: "Ghi đè",
            confirmImportNewProjectTitle: "Xác nhận Nhập Dự án Mới",
            confirmImportNewProjectMessage:
              "Bạn có chắc chắn muốn thêm dự án '<strong>{projectName}</strong>' và tất cả dữ liệu liên quan vào ứng dụng không?",
            btnImport: "Nhập",
            errorInvalidProjectBackupFile:
              "File không hợp lệ hoặc không phải là file backup dự án.",
            errorImportingProject: "Có lỗi xảy ra khi xử lý file.",
            projectImportSuccess: "Dữ liệu dự án đã được nhập thành công!",
            projectImportFailed:
              "Quá trình nhập thất bại. Vui lòng kiểm tra console.",
            modalTitleOrphanData: "Quản lý Dữ liệu Mồ côi",
            orphanDataDescription:
              "Dưới đây là danh sách các bản ghi tham chiếu đến các mục không còn tồn tại (ví dụ: hợp đồng thuộc về một dự án đã bị xóa). Bạn có thể xem lại và xóa từng mục hoặc xóa tất cả để dọn dẹp hệ thống.",
            orphanUnusedProjects: "Dự án không được sử dụng",
            orphanUnusedProjectsDesc:
              "Đây là các dự án không có hợp đồng nào được gán vào. Bạn có thể xóa chúng nếu không còn cần thiết.",
            orphanContractsWithOrphanProject:
              "Hợp đồng có Dự án không tồn tại",
            orphanContractsWithOrphanVendor:
              "Hợp đồng có Nhà cung cấp không tồn tại",
            orphanCpcWithOrphanContract: "CPC có Hợp đồng không tồn tại",
            orphanInstallmentsWithOrphanCpc:
              "Thanh toán có CPC không tồn tại",
            orphanBondsWithOrphanCpc: "Bảo lãnh có CPC không tồn tại",
            orphanProjectLabel: "Dự án: <strong>{name}</strong> (ID: {id})",
            orphanContractLabel:
              "HĐ: <strong>{contractNo}</strong> (ID: {id}) - Tham chiếu đến Project ID: <code>{projectId}</code>",
            orphanContractVendorLabel:
              "HĐ: <strong>{contractNo}</strong> (ID: {id}) - Tham chiếu đến Vendor ID: <code>{vendorId}</code>",
            orphanCpcLabel:
              "CPC: <strong>{cpcIdentifier}</strong> (ID: {id}) - Tham chiếu đến Contract ID: <code>{contractId}</code>",
            orphanInstallmentLabel:
              "Thanh toán: <strong>{amount}</strong> ngày <strong>{date}</strong> (ID: {id}) - Tham chiếu đến CPC ID: <code>{cpcId}</code>",
            orphanBondLabel:
              "Bảo lãnh: <strong>{bondNumber}</strong> (ID: {id}) - Tham chiếu đến CPC ID: <code>{cpcId}</code>",
            btnDeleteOrphan: "Xóa",
            orphanDataSuccess:
              "Kiểm tra hoàn tất! Không tìm thấy dữ liệu mồ côi nào trong hệ thống.",
            btnDeleteAllOrphans: "Xóa tất cả Dữ liệu Mồ côi",
            confirmDeleteOrphanTitle: "Xác nhận Xóa",
            confirmDeleteOrphanMessage:
              "Bạn có chắc chắn muốn xóa vĩnh viễn mục này (ID: {itemId}) không?",
            orphanItemDeleted: "Đã xóa mục (ID: {itemId}) thành công.",
            orphanDeleteFailed: "Xóa thất bại. Vui lòng kiểm tra console.",
            confirmDeleteAllOrphansTitle: "Xác nhận Xóa Tất cả",
            confirmDeleteAllOrphansMessage:
              "Hành động này sẽ xóa vĩnh viễn **TẤT CẢ** các mục được liệt kê. Bạn có chắc chắn muốn tiếp tục không?",
            btnYesDeleteAll: "Vâng, Xóa Tất cả",
            allOrphansDeleted:
              "Đã dọn dẹp tất cả dữ liệu mồ côi thành công.",
            deleteAllOrphansFailed:
              "Xóa hàng loạt thất bại. Vui lòng kiểm tra console.",
            btnColumns: "Các cột",
            btnSubColumns: "Các cột con",
            row: "Dòng",
            xmlLoadSuccess:
              "Đã tải dữ liệu hóa đơn từ file XML thành công.",
            xmlLoadError: "Lỗi xử lý file XML.",
            paymentUpdatedSuccess: "Cập nhật thanh toán thành công.",
            contractDataAutoFilled:
              "Dữ liệu hợp đồng đã được tự động điền từ danh sách chính.",
            errorNoVendorDataToExport:
              "Không có dữ liệu nhà cung cấp để xuất.",
            vendorExportSuccess: "Xuất danh sách nhà cung cấp thành công.",
            allProjects: "Tất cả Dự án",
            contractAmountTotal: "Tổng GT Hợp đồng",
            vonTotal: "Tổng GT Von",
            contractVatTotal: "Tổng VAT Hợp đồng",
            contractGrandTotal: "Tổng GT sau VAT",
            paidAmountExclVAT: "Đã trả (chưa VAT)",
            paidVatAmount: "Đã trả (VAT)",
            paidAmountInclVAT: "Đã trả (gồm VAT)",
            invoiceAmountTotal: "Tổng GT Hóa đơn",
            invoiceVatTotal: "Tổng VAT Hóa đơn",
            invoiceGrandTotal: "Tổng GT Hóa đơn (sau VAT)",
            tooltipSendCpc:
              "Click để gửi/cập nhật CPC này. Ctrl+Click để gửi/cập nhật TẤT CẢ CPC cho hợp đồng này.",
            btnResyncData: "Kiểm tra & Sửa chữa Dữ liệu",
            confirmResyncTitle: "Xác nhận Kiểm tra & Sửa chữa Dữ liệu",
            confirmResyncMessage:
              "Hành động này sẽ quét toàn bộ cơ sở dữ liệu để tìm và sửa các thông tin không nhất quán (ví dụ: tên dự án, nhà cung cấp bị sai lệch trong các mục con).<br><br>Quá trình này an toàn và được khuyến khích thực hiện sau khi nhập dữ liệu từ file hoặc khi bạn nghi ngờ có lỗi. Bạn có muốn tiếp tục?",
            btnStart: "Bắt đầu",
            confirmBulkSendTitle: "Xác nhận gửi hàng loạt",
            confirmBulkSendMessage:
              "Bạn có chắc chắn muốn gửi/cập nhật tất cả <strong>{count}</strong> mục CPC cho hợp đồng <strong>{contractNo}</strong> không?",
            btnConfirmSendAll: "Đồng ý Gửi tất cả",
            errorSelectContractAction:
              "Vui lòng chọn một hợp đồng để thực hiện.",
            infoNoCpcToSend: "Không có CPC nào để gửi cho hợp đồng này.",
            successBulkCpcSent:
              "Đã gửi/cập nhật thành công {count} mục CPC.",
            errorBulkCpcFailed: "Gửi hàng loạt CPC thất bại.",
            promptDebugVendor:
              "Vui lòng nhập Mã Nhà cung cấp (Vendor No.) cần debug:",
            confirmMergeVendorTitle: "Phát hiện Trùng Mã Nhà Cung Cấp",
            confirmMergeVendorMessage:
              'Mã nhà cung cấp <strong>{vendorNo}</strong> đã tồn tại cho NCC "<strong>{destName}</strong>".<br><br>Bạn có muốn hợp nhất NCC bạn đang sửa ("<strong>{sourceName}</strong>") vào NCC đã có không? <br><br><strong class="text-danger">Lưu ý:</strong> Toàn bộ hợp đồng của NCC "{sourceName}" sẽ được chuyển sang cho "{destName}" và NCC "{sourceName}" sẽ bị xóa. Hành động này không thể hoàn tác.',
            btnConfirmMerge: "Đồng ý Hợp nhất",
            errorInvalidMergeIds:
              "Lỗi: ID nhà cung cấp không hợp lệ để hợp nhất.",
            errorMergeVendorNotFound:
              "Lỗi: Không tìm thấy nhà cung cấp trong hệ thống.",
            successVendorMerged:
              'Đã hợp nhất thành công NCC "{sourceName}" vào "{destName}"!',
            errorVendorMergeFailed:
              "Đã xảy ra lỗi trong quá trình hợp nhất. Dữ liệu đã được hoàn tác.",
            warningEnterCpcForInvoice:
              "Vui lòng nhập số CPC vào dòng hiện tại trước khi tải lên hóa đơn.",
            errorSelectRowForInvoice:
              "Vui lòng chọn ít nhất một dòng để phân bổ hóa đơn.",
            errorVendorConstraint:
              "Lỗi: Tên hoặc Mã NCC đã tồn tại trong cơ sở dữ liệu.",
            errorContractNoExists:
              "Lỗi: Số hợp đồng '{contractNo}' đã tồn tại.",
          },
        },
        columnVisibility: {},
        dashboardPaymentColumnVisibility: {},
        swapDashboardColumnVisibility: {},
        dashboardBondColumnVisibility: {},
        contractDashboardColumnVisibility: {},
        currentRenewBond: null,
        newBondDetails: {
          bondNumber: "",
          ref: "",
          bondType: "",
          amount: 0,
          displayAmount: "",
          issueDate: "",
          expiryDate: "",
          issuingBank: "",
          isSettled: false,
          settlementReasonDisplay: "",
          renewedFromBondId: null,
          renewalNotes: "",
          renewalDate: "",
        },
        showRepaymentBasisConfig: false,
        currentDetailItem: null,
        currentDetailIndex: -1,
        isModalInitializing: false,
        calculationEngine: null,
        isVatOverrideVisible: false,
        isContractVatOverrideVisible: false,
        invoiceSelectedRowIds: [],
      };
    },

    async created() {
      // 1. Khởi tạo danh sách hành động cho Command Palette (Ctrl + I)
      this.commandActions = [
        {
          id: "action_add_cpc",
          type: "ACTION",
          searchLabel: this.t("btnAddCpc"),
          searchSublabel: "Tạo một CPC mới trong bảng theo dõi",
          action: () => this.addNewCpcItem(),
        },
        {
          id: "action_add_contract",
          type: "ACTION",
          searchLabel: this.t("btnAddContract"),
          searchSublabel: "Tạo một Hợp đồng mới trong Master Data",
          action: () => this.addNewContractItem(),
        },
        {
          id: "action_add_vendor",
          type: "ACTION",
          searchLabel: this.t("btnAddVendor"),
          searchSublabel: "Tạo một Nhà cung cấp mới trong Master Data",
          action: () => this.openVendorModal("add"),
        },
        {
          id: "action_add_bond",
          type: "ACTION",
          searchLabel: this.t("btnAddBond"),
          searchSublabel: "Thêm mới một Bảo lãnh cho hợp đồng",
          action: () => this.openBondModal("add"),
        },
        {
          id: "action_backup",
          type: "ACTION",
          searchLabel: this.t("btnBackup"),
          searchSublabel: "Sao lưu toàn bộ dữ liệu ra file JSON",
          action: () => this.backupDataToFile(),
        },
      ];

      // 2. Thiết lập mặc định cho ngày chốt số liệu Vendor Balance (Cuối tháng hiện tại)
      const today = new Date();
      this.viewStates.vendorBalance.filter.asOfDate = appUtils.format.date(
        new Date(today.getFullYear(), today.getMonth() + 1, 0)
      );

      // 3. Khởi tạo Engine tính toán và Tìm kiếm
      this.initializeCalculationEngine();
      this.debouncedSearch = this.debounce(this.performSearch, 200);

      try {
        // 4. Kiểm tra và thực hiện nâng cấp cấu trúc Database (nếu có)
        const didMigrate = await this.runDataMigrationToNumericIDs();
        if (didMigrate) {
          console.log("Dữ liệu đã được chuyển đổi. Đang tải lại ứng dụng...");
          alert("Cơ sở dữ liệu đã được cập nhật phiên bản mới. Trang sẽ tự động tải lại.");
          window.location.reload();
          return;
        }

        // 5. Khởi tạo dữ liệu Hạng mục báo cáo (Categories)
        await this.seedInitialCategories();
        this.reportCategoriesFromDB = await databaseService.db.categories.toArray();

        // 6. Nạp dữ liệu thô từ IndexedDB (Dự án, NCC, CPC, HĐ...)
        const didLoadFromDB = await this.loadDataFromIndexedDB();

        // 7. Nạp thời gian lưu trữ cuối cùng
        const timestampRecord = await databaseService.db.appState.get("lastSaveTimestamp");
        if (timestampRecord) {
          this.lastSaveTimestamp = timestampRecord.value;
        }

        // --- BƯỚC QUAN TRỌNG: GIẢI PHÓNG UI ---
        // Cho phép hiển thị bảng CPC Tracking ngay lập tức với dữ liệu thô đã nạp
        this.isDataLoading = false;
        console.log("[System] Giao diện đã được mở khóa. Đang render bảng Tracking...");

        // 8. Khởi tạo Search Engine (Fuse.js)
        this.initializeFuse();

        // 9. CHẠY TÍNH TOÁN NẶNG NGẦM (BACKGROUND)
        // Việc tính toán lại toàn bộ tab Details sẽ diễn ra sau 300ms 
        // để nhường chỗ cho trình duyệt vẽ xong bảng Tracking
        if (didLoadFromDB) {
          setTimeout(() => {
            console.log("[System] Đang chạy tính toán lũy kế Details ngầm...");
            this._recalculateAllDetailRowsAfterLoad();
          }, 300);
        }

      } catch (error) {
        console.error("Lỗi nghiêm trọng trong quá trình khởi tạo:", error);
        this.isLoadingError = true;
        this.isDataLoading = false;
      }
    },

    mounted() {
      sessionStorage.removeItem("app_resource_retries");

      const savedWidth = localStorage.getItem("notesPanelWidth");
      if (savedWidth) {
        this.notesPanelWidth = parseInt(savedWidth, 10);
      }
      this.$nextTick(() => {
        const modals = document.querySelectorAll(".modal");
        modals.forEach((modalEl) => {
          modalEl.addEventListener("shown.bs.modal", () => {
            const focusRefName = modalEl.dataset.focusRef;

            if (
              modalEl.id === "cpcDetailModal" &&
              this.modalMode !== "add"
            ) {
              return;
            }

            if (focusRefName && this.$refs[focusRefName]) {
              const targetEl = Array.isArray(this.$refs[focusRefName])
                ? this.$refs[focusRefName][0]
                : this.$refs[focusRefName];

              if (targetEl && typeof targetEl.focus === "function") {
                targetEl.focus();
                if (typeof targetEl.select === "function") {
                  targetEl.select();
                }
              }
            }
          });
        });
      });
      this.loadLanguage();
      this.setDefaultDashboardDates();
      this.initializeColumnVisibility();
      this.$refs.mainContentWrapper?.addEventListener(
        "scroll",
        this.handleScroll
      );

      window.addEventListener("keydown", this.handleGlobalKeyDown);
      window.addEventListener("keydown", this.handleQuickMenuShortcut);
      window.addEventListener("keydown", this.handleSidebarShortcut);
      window.addEventListener("keydown", this.handleFilterToggleShortcut);

      const confirmationModalEl =
        document.getElementById("confirmationModal");
      if (confirmationModalEl) {
        confirmationModalEl.addEventListener("shown.bs.modal", () => {
          const contentEl =
            confirmationModalEl.querySelector(".modal-content");
          if (contentEl) {
            contentEl.focus();
          }
        });
      }
      const modalIds = [
        "cpcDetailModal",
        "swapEditModal",
        "contractDetailModal",
        "bondDetailViewModal",
        "bondEditModal",
        "installmentEditModal",
        "renewBondModal",
        "confirmationModal",
        "guideModal",
        "contractDetailsModal",
        "cpcDetailsModal",
        "paymentDetailsModal",
        "invoiceDetailsModal",
        "statusUpdateModal",
      ];
      modalIds.forEach((id) => {
        const modalEl = document.getElementById(id);
        if (modalEl) {
          modalEl.addEventListener("hidden.bs.modal", () =>
            this.clearModalData(id)
          );
        }
      });

      const cpcDetailModalEl = document.getElementById("cpcDetailModal");
      if (cpcDetailModalEl) {
        cpcDetailModalEl.addEventListener("shown.bs.modal", () => {
          if (this.modalMode === 'financials' && this.shouldFocusPaymentDate) {
            this.$nextTick(() => {
              const firstDateInput = cpcDetailModalEl.querySelector('input[type="date"]');
              if (firstDateInput) {
                firstDateInput.focus();
              }
              this.shouldFocusPaymentDate = false; // Reset cờ
            });
            return;
          }

          if (this.modalMode === 'add') {
            const projectInput = this.$refs.projectInput;
            if (projectInput) projectInput.focus();
          }
        });
      }

      this.tooltipInstance = new bootstrap.Tooltip(document.body, {
        selector: "[data-bs-toggle='tooltip']",
      });

      this.$nextTick(() => {
        lucide.createIcons();
      });
    },
    beforeUnmount() {
      window.removeEventListener("mousemove", this.doResize);
      window.removeEventListener("mouseup", this.stopResize);

      this.$refs.mainContentWrapper?.removeEventListener(
        "scroll",
        this.handleScroll
      );
      window.removeEventListener("keydown", this.handleGlobalKeyDown);
      window.removeEventListener("keydown", this.handleQuickMenuShortcut);
      window.removeEventListener("keydown", this.handleSidebarShortcut);
      window.removeEventListener(
        "keydown",
        this.handleFilterToggleShortcut
      );
    },
    watch: {
      'currentEditContract.currency': function (newVal) {
        // Nếu chuyển sang USD và đang có đối tượng contract trong modal
        if (newVal === 'USD' && this.currentEditContract) {
          if (!this.currentEditContract.settings) {
            this.currentEditContract.settings = {
              repaymentThreshold: 80,
              retentionRate: 5,
              defaultVatRate: 0
            };
          } else {
            // Tự động gán VAT mặc định bằng 0 khi là USD
            this.currentEditContract.settings.defaultVatRate = 0;
          }
        } else if (newVal === 'VND' && this.currentEditContract?.settings?.defaultVatRate === 0) {
          // Tùy chọn: Nếu chuyển ngược lại VND và đang là 0, có thể gợi ý về 8 hoặc 10
          this.currentEditContract.settings.defaultVatRate = 8;
        }
      },
      "viewStates.invoiceAging.filter.projectId": {
        handler(newIds) {
          if (newIds && newIds.length > 0) {
            console.log(
              "Đang đồng bộ dữ liệu thanh toán cho Dự án được chọn..."
            );

            const contractsToSync = this.contracts.filter((c) =>
              newIds.includes(c.projectId)
            );

            contractsToSync.forEach((c) => {
              this.syncPaymentsToDetails(c.id);
            });
          }
        },
        deep: true,
      },
      "viewStates.cpcDetails.activePhaseId": {
        async handler(newPhaseId) {
          if (!newPhaseId || newPhaseId === "summary") return;

          const contractId =
            this.viewStates.cpcDetails.filter.selectedContractId;
          if (!contractId) return;

          const hasRows = this.cpcDetailRows.some(
            (r) => r.contractId === contractId && r.phaseId === newPhaseId
          );

          if (!hasRows) {
            console.log(
              `Phase ${newPhaseId} chưa có dữ liệu. Đang khởi tạo dòng trống...`
            );

            const newRows = [];
            for (let i = 0; i < 5; i++) {
              newRows.push(this.createEmptyDetailRow(contractId, i));
            }

            try {
              const newIds = await databaseService.db.cpcDetailRows.bulkAdd(
                JSON.parse(JSON.stringify(newRows)),
                { allKeys: true }
              );

              newRows.forEach((row, index) => (row.id = newIds[index]));
              this.cpcDetailRows.push(...newRows);

              this.showToast(
                "Đã khởi tạo các dòng trống cho giai đoạn mới.",
                "success"
              );
            } catch (error) {
              console.error("Lỗi khi khởi tạo dòng cho Phase:", error);
            }
          }
        },
      },
      currentTab(newTab, oldTab) {
        this.$nextTick(() => {
          lucide.createIcons();

          if (
            newTab === "cpc-details" &&
            this.viewStates.cpcDetails.filter.selectedContractId
          ) {
            this.syncPaymentsToDetails(
              this.viewStates.cpcDetails.filter.selectedContractId
            );
          }

          if (
            newTab === "invoice-aging" &&
            this.viewStates.invoiceAging.filter.projectId.length === 0
          ) {
            this.viewStates.invoiceAging.isFilterCollapsed = false;
            this.viewStates.invoiceAging.filter.expansion.project = false;
          }

          if (
            newTab === "invoice-aging" &&
            this.viewStates.invoiceAging.filter.projectId.length > 0
          ) {
            const selectedProjectIds =
              this.viewStates.invoiceAging.filter.projectId;
            const contractsToSync = this.contracts.filter((c) =>
              selectedProjectIds.includes(c.projectId)
            );
            contractsToSync.forEach((c) => {
              this.syncPaymentsToDetails(c.id);
            });
          }
        });
      },

      selectedContractDetails(newContractDetails, oldContractDetails) {
        if (
          this.isNotesModalVisible &&
          newContractDetails?.id !== oldContractDetails?.id
        ) {
          this.initializeNotesForContract(newContractDetails);
        }
      },

      projectQuickFilterSearch(newValue, oldValue) {
        if (newValue !== oldValue) {
          this.activeProjectQuickFilterIndex = 0;
        }
      },
      language() {
        this.initializeFuse();
        this.$nextTick(() => {
          this.tooltipInstance?.dispose();
          this.tooltipInstance = new bootstrap.Tooltip(document.body, {
            selector: "[data-bs-toggle='tooltip']",
          });
          lucide.createIcons();
        });
      },
      vendorSearchTerm(newValue) {
        if (this.isVendorDropdownVisible) {
          if (newValue) {
            const normalizedSearch =
              appUtils.text.normalizeVietnamese(newValue);
            this.filteredVendors = this.vendors
              .filter(
                (vendor) =>
                  appUtils.text
                    .normalizeVietnamese(vendor.name)
                    .includes(normalizedSearch) ||
                  (vendor.abbrName &&
                    appUtils.text
                      .normalizeVietnamese(vendor.abbrName)
                      .includes(normalizedSearch)) ||
                  (vendor.vendorNo && vendor.vendorNo.includes(newValue))
              )
              .slice(0, 10);
          } else {
            this.filteredVendors = this.vendors.slice(0, 10);
          }
        }
        this.activeVendorIndex = -1;
      },
      "viewStates.vendorBalance.searchTerm"() {
        this.viewStates.vendorBalance.currentPage = 1;
      },
      "viewStates.cpcDetails.filter.projectId": {
        deep: true,
        handler() {
          this.viewStates.cpcDetails.filter.selectedContractId = null;
        },
      },
      "viewStates.cpcDetails.filter.vendorId": {
        deep: true,
        handler() {
          this.viewStates.cpcDetails.filter.selectedContractId = null;
        },
      },
      "viewStates.cpcDetails.filter.selectedContractId": {
        async handler(newContractId, oldContractId) {
          this.viewStates.cpcDetails.activePhaseId = "summary";
          if (newContractId && newContractId !== oldContractId) {
            if (this.isDataLoading) {
              return;
            }

            const existingRowCount = this.cpcDetailRows.filter(
              (r) => r.contractId === newContractId
            ).length;

            if (existingRowCount === 0) {
              console.log(
                `Không tìm thấy dòng chi tiết nào cho HĐ ${newContractId}. Khởi tạo 5 dòng trống ban đầu.`
              );
              const newTable = Array.from({ length: 5 }, (_, i) =>
                this.createEmptyDetailRow(newContractId, i)
              );

              try {
                const newIds =
                  await databaseService.db.cpcDetailRows.bulkAdd(newTable, {
                    allKeys: true,
                  });
                newTable.forEach((row, i) => (row.id = newIds[i]));
                this.cpcDetailRows.push(...newTable);
              } catch (error) {
                console.error(
                  "Lỗi khi thêm các dòng chi tiết ban đầu:",
                  error
                );
              }
            }

            this.loadContractColumnSettings(newContractId);
            this.syncPaymentsToDetails(newContractId);
          }
        },
        deep: true,
      },

      "viewStates.cpcTracking.searchTerm"() {
        this.viewStates.cpcTracking.currentPage = 1;
      },
      "viewStates.cpcTracking.filter.projectId": {
        handler() {
          this.viewStates.cpcTracking.filter.vendorId = [];
          this.viewStates.cpcTracking.filter.contractId = [];
          this.viewStates.cpcTracking.currentPage = 1;
        },
        deep: true,
      },
      "viewStates.cpcTracking.filter.vendorId": {
        handler() {
          this.viewStates.cpcTracking.filter.contractId = [];
          this.viewStates.cpcTracking.currentPage = 1;
        },
        deep: true,
      },
      "viewStates.cpcTracking.filter.contractId": {
        handler() {
          this.viewStates.cpcTracking.currentPage = 1;
        },
        deep: true,
      },
      "viewStates.cpcTracking.filter.status": {
        handler() {
          this.viewStates.cpcTracking.currentPage = 1;
        },
        deep: true,
      },
      "viewStates.vendorBalance.filter.projectId": {
        handler() {
          this.viewStates.vendorBalance.currentPage = 1;
        },
        deep: true,
      },
      "viewStates.vendorBalance.filter.status": {
        handler() {
          this.viewStates.vendorBalance.currentPage = 1;
        },
        deep: true,
      },
      "viewStates.vendorBalance.filter.balanceStatus": {
        handler() {
          this.viewStates.vendorBalance.currentPage = 1;
        },
      },
      "viewStates.vendorBalance.filter.asOfDate": {
        handler() {
          this.viewStates.vendorBalance.currentPage = 1;
        },
      },

      "masterData.vendors.searchTerm"() {
        this.masterData.vendors.currentPage = 1;
      },
      "masterData.projects.searchTerm"() {
        this.masterData.projects.currentPage = 1;
      },

      language() {
        this.$nextTick(() => {
          this.tooltipInstance?.dispose();
          this.tooltipInstance = new bootstrap.Tooltip(document.body, {
            selector: "[data-bs-toggle='tooltip']",
          });
          lucide.createIcons();
        });
      },
      "viewStates.paymentDashboard.filter.projectId": {
        handler() {
          this.viewStates.paymentDashboard.filter.vendorId = [];
          this.viewStates.paymentDashboard.currentPage = 1;
        },
        deep: true,
      },
      "viewStates.paymentDashboard.filter.vendorId": {
        handler() {
          this.viewStates.paymentDashboard.filter.code = [];
          this.viewStates.paymentDashboard.currentPage = 1;
        },
        deep: true,
      },
      "viewStates.paymentDashboard.filter.code": {
        handler() {
          this.viewStates.paymentDashboard.filter.paymentSource = [];
          this.viewStates.paymentDashboard.currentPage = 1;
        },
        deep: true,
      },
      "viewStates.swapDashboard.filter.projectId": {
        handler() {
          this.viewStates.swapDashboard.filter.vendorId = [];
          this.viewStates.swapDashboard.currentPage = 1;
        },
        deep: true,
      },
      "viewStates.swapDashboard.filter.vendorId": {
        handler() {
          this.viewStates.swapDashboard.filter.vendorSWAP = [];
          this.viewStates.swapDashboard.currentPage = 1;
        },
        deep: true,
      },
      "viewStates.bondDashboard.filter.projectId": {
        handler() {
          this.viewStates.bondDashboard.filter.vendorId = [];
          this.viewStates.bondDashboard.currentPage = 1;
        },
        deep: true,
      },
      "viewStates.bondDashboard.filter.vendorId": {
        handler() {
          this.viewStates.bondDashboard.filter.contractId = [];
          this.viewStates.bondDashboard.currentPage = 1;
        },
        deep: true,
      },
      "viewStates.bondDashboard.filter.contractId": {
        handler() {
          this.viewStates.bondDashboard.filter.bondType = [];
          this.viewStates.bondDashboard.currentPage = 1;
        },
        deep: true,
      },
      "viewStates.contractDashboard.filter.projectId": {
        handler() {
          this.viewStates.contractDashboard.filter.vendorId = [];
          this.viewStates.contractDashboard.filter.contractId = [];
          this.viewStates.contractDashboard.filter.code = [];
          this.viewStates.contractDashboard.currentPage = 1;
        },
        deep: true,
      },
      "viewStates.contractDashboard.filter.vendorId": {
        handler() {
          this.viewStates.contractDashboard.filter.contractId = [];
          this.viewStates.contractDashboard.filter.code = [];
          this.viewStates.contractDashboard.currentPage = 1;
        },
        deep: true,
      },
      "viewStates.contractDashboard.filter.contractId": {
        handler() {
          this.viewStates.contractDashboard.filter.code = [];
          this.viewStates.contractDashboard.currentPage = 1;
        },
        deep: true,
      },

      columnVisibility: {
        handler() {
          this.saveColumnVisibilityToLocalStorage("cpc");
        },
        deep: true,
      },
      dashboardPaymentColumnVisibility: {
        handler() {
          this.saveColumnVisibilityToLocalStorage("dashboardPayment");
        },
        deep: true,
      },
      swapDashboardColumnVisibility: {
        handler() {
          this.saveColumnVisibilityToLocalStorage("swapDashboard");
        },
        deep: true,
      },
      dashboardBondColumnVisibility: {
        handler() {
          this.saveColumnVisibilityToLocalStorage("dashboardBond");
        },
        deep: true,
      },
      contractDashboardColumnVisibility: {
        handler() {
          this.saveColumnVisibilityToLocalStorage("contractDashboard");
        },
        deep: true,
      },

      commandSearchTerm(newValue) {
        this.activeCommandIndex = 0;
        this.debouncedSearch(newValue);
      },

      "currentEditItem.isUsd"(isUsd) {
        if (this.isModalInitializing) return;
        if (isUsd) {
          this.calculateVndFromUsd();
        }
      },
      "currentDetailItem.contractPercentVat": function (
        newValue,
        oldValue
      ) {
        if (
          this.isModalInitializing ||
          newValue === oldValue ||
          !this.currentDetailItem
        )
          return;
        this.updateFormulasInModal("contractVat", false);
      },
      "currentDetailItem.cpcPercentPoW": function (newValue, oldValue) {
        if (
          this.isModalInitializing ||
          newValue === oldValue ||
          !this.currentDetailItem
        )
          return;
        this.updateFormulasInModal("cpcPaymentOfWorkdone", false);
      },
      "currentDetailItem.cpcPercentAdv": function (newValue, oldValue) {
        if (
          this.isModalInitializing ||
          newValue === oldValue ||
          !this.currentDetailItem
        )
          return;
        this.updateFormulasInModal("cpcAdvance", false);
      },
      "currentDetailItem.useWorkdoneForRepayment": function (
        newValue,
        oldValue
      ) {
        if (
          this.isModalInitializing ||
          newValue === oldValue ||
          !this.currentDetailItem
        )
          return;
        this.updateFormulasInModal("cpcRepayment", false);
      },
      "currentDetailItem.cpcPercentVat": function (newValue, oldValue) {
        if (
          this.isModalInitializing ||
          newValue === oldValue ||
          !this.currentDetailItem
        )
          return;
        if (this.isVatOverrideVisible) {
          this.currentDetailItem.isVatRateManual = true;
        }
        this.updateFormulasInModal("cpcVat", false);
      },
      "currentDetailItem.isFinalSettlement": function (newValue, oldValue) {
        if (
          this.isModalInitializing ||
          newValue === oldValue ||
          !this.currentDetailItem
        )
          return;
        this.calculateFinalSettlement();
      },
    },
    computed: {
      totalContractDashboardMetrics() {
        const totals = {
          contractAmountTotal: 0,
          vonTotal: 0,
          contractVatTotal: 0,
          contractGrandTotal: 0,
          paidAmountExclVAT: 0,
          paidVatAmount: 0,
          paidAmountInclVAT: 0,
          invoiceAmountTotal: 0,
          invoiceVatTotal: 0,
          invoiceGrandTotal: 0
        };

        // Chỉ tính toán nếu có dữ liệu
        if (this.filteredContractDashboardData && this.filteredContractDashboardData.length > 0) {
          this.filteredContractDashboardData.forEach(item => {
            Object.keys(totals).forEach(key => {
              // Cộng dồn giá trị số, nếu không phải số thì coi như 0
              totals[key] += (Number(item[key]) || 0);
            });
          });
        }

        return totals;
      },
      vendorPartnerList() {
        if (!this.viewStates?.vendorPartner) return [];

        const search = this.viewStates.vendorPartner?.searchTerm?.trim().toLowerCase() || "";

        // Nếu không nhập hoặc nhập quá ngắn (< 2 ký tự), trả về mảng rỗng ngay lập tức
        if (search.length < 2) return [];

        // Chỉ thực hiện lọc khi có từ khóa tìm kiếm
        return this.vendors.filter(v => {
          return v.name.toLowerCase().includes(search) ||
            (v.vendorNo && v.vendorNo.toLowerCase().includes(search));
        }).map(v => {
          // Chỉ đếm số hợp đồng, không tính toán sâu để sidebar luôn mượt
          return {
            id: v.id,
            name: v.name,
            contractCount: this.contracts.filter(c => c.vendorId === v.id).length
          };
        });
      },

      selectedVendorData() {
        const vId = this.viewStates.vendorPartner?.selectedId;
        if (!vId) return null;

        const vendor = this.vendors.find(v => v.id === vId);
        if (!vendor) return null;

        const vendorContracts = this.contracts.filter(c => c.vendorId === vId);
        const contractIds = new Set(vendorContracts.map(c => c.id));
        const allRelatedRows = this.cpcDetailRows.filter(r => contractIds.has(r.contractId));

        let totalCpcOutstanding = 0;
        let totalAdvBalance = 0;
        let totalRetention = 0;
        let totalBudget = 0;
        let totalWorkdone = 0;

        const detailedContracts = vendorContracts.map(c => {
          const rows = allRelatedRows.filter(r => r.contractId === c.id);

          // Tính toán cho từng hợp đồng
          const cBudget = rows.reduce((s, r) => s + (Number(r.contractAmount) || 0) + (Number(r.contractVon) || 0), 0);
          const cWD = rows.reduce((s, r) => s + (Number(r.cpcWorkDone) || 0), 0);

          // 1. Công nợ CPC chưa trả = (Số đề nghị + VAT) - Thực chi
          const cCpcDue = rows.reduce((s, r) => s + (Number(r.cpcAmountDue) || 0) + (Number(r.cpcVat) || 0), 0);
          const cPaid = rows.reduce((s, r) => s + (Number(r.paymentGrandTotal) || 0), 0);
          const cOutstanding = cCpcDue - cPaid;

          // 2. Dư nợ tạm ứng = (Tạm ứng dương) - (Khấu trừ repayment) - (Tạm ứng âm)
          const cPosAdv = rows.reduce((s, r) => (Number(r.cpcAdvance) > 0 ? s + Number(r.cpcAdvance) : s), 0);
          const cRepay = rows.reduce((s, r) => s + Math.abs(Number(r.cpcRepayment) || 0), 0);
          const cNegAdv = rows.reduce((s, r) => (Number(r.cpcAdvance) < 0 ? s + Math.abs(Number(r.cpcAdvance)) : s), 0);
          const cAdvBal = cPosAdv - (cRepay + cNegAdv);

          // 3. Bảo hành giữ lại
          const cRetention = rows.reduce((s, r) => s + Math.abs(Number(r.cpcRetention) || 0), 0);

          // Cộng dồn vào tổng Vendor
          totalCpcOutstanding += cOutstanding;
          totalAdvBalance += cAdvBal;
          totalRetention += cRetention;
          totalBudget += cBudget;
          totalWorkdone += cWD;

          return {
            id: c.id,
            contractNo: c.contractNo,
            projectId: c.projectId, // Đảm bảo có dòng này
            vendorId: c.vendorId,   // Đảm bảo có dòng này
            description: c.description,
            status: c.status || 'Active',
            projectName: this.projectMap.get(c.projectId)?.name || 'N/A',
            budget: cBudget,
            workdone: cWD,
            outstanding: cOutstanding,
            advBalance: cAdvBal,
            progress: cBudget > 0 ? Math.round((cWD / cBudget) * 100) : 0
          };
        });

        return {
          vendor,
          contracts: detailedContracts,
          totalCpcOutstanding,
          totalAdvBalance,
          totalRetention,
          overallProgress: totalBudget > 0 ? Math.round((totalWorkdone / totalBudget) * 100) : 0,
          projectCount: [...new Set(vendorContracts.map(c => c.projectId))].length
        };
      },

      overviewBonds() {
        if (!this.selectedContractDetails) return [];
        // Lọc: Đúng hợp đồng + Chưa tất toán + Chưa bị gia hạn (chỉ lấy bản mới nhất)
        return this.bonds.filter(b =>
          b.contractId === this.selectedContractDetails.id &&
          !b.isSettled &&
          !b.isRenewed
        ).sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate));
      },
      historySummaryRows() {
        const allCpcs = this.groupedContractHistoryTable;
        const init = () => ({
          workDone: 0, paymentOfWorkdone: 0, advance: 0, repayment: 0,
          retention: 0, otherDeduction: 0, amountDue: 0, amountPaid: 0, count: 0
        });

        const summary = {
          paid: { label: 'TỔNG CÁC ĐỢT ĐÃ THANH TOÁN XONG', ...init() },
          processing: { label: 'TỔNG CÁC ĐỢT ĐANG XỬ LÝ / DỞ DANG', ...init() }
        };

        allCpcs.forEach(item => {
          const isPaid = item.amountPaid >= item.amountDue && item.amountDue > 0;
          const target = isPaid ? summary.paid : summary.processing;

          Object.keys(init()).forEach(key => {
            if (key !== 'count') target[key] += item[key];
          });
          target.count++;
        });

        return summary;
      },
      groupedContractHistoryTable() {
        const contractId = this.viewStates.cpcDetails.filter.selectedContractId;
        if (!contractId) return [];

        const rows = this.cpcDetailRows.filter(r => r.contractId === contractId && r.cpcNo);
        const groups = {};

        rows.forEach(row => {
          const cpc = row.cpcNo.trim();
          if (!groups[cpc]) {
            groups[cpc] = {
              id: cpc,
              cpcNo: cpc,
              description: row.description,
              workDone: 0,
              paymentOfWorkdone: 0,
              advance: 0,
              repayment: 0,
              retention: 0,
              otherDeduction: 0,
              amountDue: 0,
              amountPaid: 0
            };
          }

          groups[cpc].workDone += (Number(row.cpcWorkDone) || 0);
          groups[cpc].paymentOfWorkdone += (Number(row.cpcPaymentOfWorkdone) || 0);
          groups[cpc].advance += (Number(row.cpcAdvance) || 0);
          groups[cpc].repayment += (Number(row.cpcRepayment) || 0);
          groups[cpc].retention += (Number(row.cpcRetention) || 0);
          groups[cpc].otherDeduction += (Number(row.cpcOtherDeduction) || 0);

          groups[cpc].amountDue += (Number(row.cpcAmountDue) || 0) + (Number(row.cpcVat) || 0);

          groups[cpc].amountPaid += (Number(row.paymentGrandTotal) || 0);
        });

        return Object.values(groups).sort((a, b) => {
          const extractNum = (s) => {
            const match = String(s).match(/\d+/);
            return match ? parseInt(match[0], 10) : 0;
          };
          return extractNum(a.cpcNo) - extractNum(b.cpcNo);
        });
      },
      contractOverviewData() {
        const contractId = this.viewStates.cpcDetails.filter.selectedContractId;
        if (!contractId || !this.selectedContractDetails) return null;

        const rows = this.cpcDetailRows.filter(r => r.contractId === contractId);

        const budgetAmountExclVat = rows.reduce((sum, r) => {
          return sum + (Number(r.contractAmount) || 0) + (Number(r.contractVon) || 0);
        }, 0);

        const totalValueInclVat = rows.reduce((sum, r) => {
          return sum +
            (Number(r.contractAmount) || 0) +
            (Number(r.contractVon) || 0) +
            (Number(r.contractVat) || 0);
        }, 0);

        const totalWorkdone = rows.reduce((sum, r) => sum + (Number(r.cpcWorkDone) || 0), 0);
        const progressPercent = budgetAmountExclVat > 0 ? Math.round((totalWorkdone / budgetAmountExclVat) * 100) : 0;

        const positiveAdvanceRows = rows.filter(r => (Number(r.cpcAdvance) || 0) > 0);
        const groupedPositiveAdvances = {};
        positiveAdvanceRows.forEach(row => {
          const cpcKey = row.cpcNo || 'Unnumbered';
          if (!groupedPositiveAdvances[cpcKey]) {
            const firstDate = (row.paymentInstallments || []).map(i => i.date).filter(d => d).sort()[0] || '9999-12-31';
            groupedPositiveAdvances[cpcKey] = { amount: 0, date: firstDate };
          }
          groupedPositiveAdvances[cpcKey].amount += Number(row.cpcAdvance) || 0;
        });

        const advanceTimeline = Object.values(groupedPositiveAdvances).sort((a, b) => a.date.localeCompare(b.date));
        const initialAdvance = advanceTimeline.length > 0 ? advanceTimeline[0].amount : 0;
        const additionalAdvance = advanceTimeline.length > 1 ? advanceTimeline.slice(1).reduce((sum, item) => sum + item.amount, 0) : 0;
        const totalPositiveAdvance = initialAdvance + additionalAdvance;

        const recoveryFromRepayment = rows.reduce((sum, r) => sum + Math.abs(Number(r.cpcRepayment) || 0), 0);
        const recoveryFromNegativeAdvance = rows.reduce((sum, r) => {
          const val = Number(r.cpcAdvance) || 0;
          return val < 0 ? sum + Math.abs(val) : sum;
        }, 0);

        const totalRecovered = recoveryFromRepayment + recoveryFromNegativeAdvance;

        const currentAdvanceBalance = totalPositiveAdvance - totalRecovered;
        const totalPaid = rows.reduce((sum, r) => sum + (Number(r.paymentGrandTotal) || 0), 0);
        const totalPaymentOfWorkdone = rows.reduce((sum, r) => sum + (Number(r.cpcPaymentOfWorkdone) || 0), 0);
        const retentionValue = totalWorkdone - totalPaymentOfWorkdone;

        return {
          totalContractValue: totalValueInclVat,
          budgetAmount: budgetAmountExclVat,
          totalWorkdone,
          progressPercent,
          totalPaid,
          retentionValue,
          initialAdvance,
          additionalAdvance,
          totalRecovered,
          currentAdvanceBalance,
          remainingValue: budgetAmountExclVat - totalWorkdone
        };
      },

      contractHistoryTable() {
        const contractId = this.viewStates.cpcDetails.filter.selectedContractId;
        if (!contractId) return [];

        return this.cpcDetailRows
          .filter(r => r.contractId === contractId && r.cpcNo)
          .sort((a, b) => {
            const extractNum = (s) => {
              const match = String(s).match(/\d+/);
              return match ? parseInt(match[0], 10) : 0;
            };
            return extractNum(a.cpcNo) - extractNum(b.cpcNo);
          });
      },
      processedContractAgingData() {
        const reportDateStr =
          this.viewStates.invoiceAging.filter.reportDate;
        const reportDate = reportDateStr
          ? new Date(reportDateStr)
          : new Date();
        reportDate.setHours(0, 0, 0, 0);

        const allCpcs = this.processedCpcData;
        const grouped = {};

        allCpcs.forEach((cpc) => {
          const remaining = cpc.amount - (cpc.totalAmountPaid || 0);
          if (remaining <= 100 || !cpc.paymentDueDate) return;

          const dueDate = new Date(cpc.paymentDueDate);
          const diffTime = reportDate - dueDate;
          const age = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          if (age <= 0) return;

          const contractId = cpc.contractId;
          if (!grouped[contractId]) {
            const contract = this.contractMap.get(contractId) || {};
            const project = this.projectMap.get(cpc.projectId) || {};
            const vendor = this.vendorMap.get(cpc.vendorId) || {};

            grouped[contractId] = {
              id: contractId,
              contractId: contractId,
              projectId: contract.projectId,
              vendorId: contract.vendorId,
              projectName: project.name || "N/A",
              contractDate: contract.date || "",
              contractNo: contract.contractNo || "N/A",
              vendorNo: vendor.vendorNo || "",
              vendorName: vendor.name || "N/A",
              description: contract.description || "",
              age1_30: 0,
              age31_60: 0,
              age61_90: 0,
              ageOver90: 0,
              remainingTotal: 0,
            };
          }

          if (age <= 30) grouped[contractId].age1_30 += remaining;
          else if (age <= 60) grouped[contractId].age31_60 += remaining;
          else if (age <= 90) grouped[contractId].age61_90 += remaining;
          else grouped[contractId].ageOver90 += remaining;

          grouped[contractId].remainingTotal += remaining;
        });

        return Object.values(grouped);
      },

      filteredContractAgingData() {
        const state = this.viewStates.invoiceAging;
        let data = [...this.processedContractAgingData];
        if (state.filter.projectId.length > 0) {
          data = data.filter((item) =>
            state.filter.projectId.includes(item.projectId)
          );
        }
        if (state.filter.vendorId.length > 0) {
          data = data.filter((item) =>
            state.filter.vendorId.includes(item.vendorId)
          );
        }
        if (state.sortBy) {
          data.sort((a, b) => {
            let valA = a[state.sortBy],
              valB = b[state.sortBy];
            if (typeof valA === "number")
              return state.sortDirection === "asc"
                ? valA - valB
                : valB - valA;
            return state.sortDirection === "asc"
              ? String(valA).localeCompare(String(valB))
              : String(valB).localeCompare(String(valA));
          });
        }
        return data;
      },

      paginatedContractAgingData() {
        const state = this.viewStates.invoiceAging;
        return this.filteredContractAgingData.slice(
          (state.currentPage - 1) * state.perPage,
          state.currentPage * state.perPage
        );
      },

      totalContractAgingBuckets() {
        return this.filteredContractAgingData.reduce(
          (acc, item) => {
            acc.age1_30 += item.age1_30;
            acc.age31_60 += item.age31_60;
            acc.age61_90 += item.age61_90;
            acc.ageOver90 += item.ageOver90;
            acc.total += item.remainingTotal;
            return acc;
          },
          { age1_30: 0, age31_60: 0, age61_90: 0, ageOver90: 0, total: 0 }
        );
      },
      overdueCpcs() {
        if (!Array.isArray(this.processedCpcData)) return [];

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        return this.processedCpcData
          .filter((item) => {
            const statusKey = item.statusInfo?.statusKey;
            if (!item.paymentDueDate || statusKey === "complete")
              return false;

            const dueDate = new Date(item.paymentDueDate);
            const isPastDue = dueDate < today;
            const hasBalance =
              item.amount - (item.totalAmountPaid || 0) > 0;

            return isPastDue && hasBalance;
          })
          .sort(
            (a, b) =>
              new Date(b.paymentDueDate) - new Date(a.paymentDueDate)
          );
      },

      partialCpcs() {
        if (!Array.isArray(this.processedCpcData)) return [];

        return this.processedCpcData
          .filter((item) => {
            const totalAmount = item.isUsd ? item.amountUsd : item.amount;

            const paidAmount = item.isUsd
              ? (item.installments || []).reduce((sum, inst) => sum + (inst.amountUsd || 0), 0)
              : item.totalAmountPaid;

            const absTotal = Math.abs(totalAmount);
            const absPaid = Math.abs(paidAmount);

            return absPaid > 0 && absPaid < absTotal;
          })
          .sort(
            (a, b) =>
              new Date(a.paymentDueDate) - new Date(b.paymentDueDate)
          );
      },
      upcomingCpcs() {
        if (!Array.isArray(this.processedCpcData)) return [];

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const next10Days = new Date();
        next10Days.setDate(today.getDate() + 10);

        return this.processedCpcData
          .filter((item) => {
            const statusKey = item.statusInfo?.statusKey;
            if (!item.paymentDueDate || statusKey === "complete")
              return false;

            const dueDate = new Date(item.paymentDueDate);
            const isUpcoming = dueDate >= today && dueDate <= next10Days;
            const hasBalance =
              item.amount - (item.totalAmountPaid || 0) > 0;

            return isUpcoming && hasBalance;
          })
          .sort(
            (a, b) =>
              new Date(a.paymentDueDate) - new Date(b.paymentDueDate)
          );
      },
      swapDashboardStats() {
        const activeSwaps = this.filteredSwapsDashboard;
        let stats = {
          totalReceivable: 0,
          totalPayable: 0,
          totalSettled: 0,
          count: activeSwaps.length,
        };

        activeSwaps.forEach((s) => {
          if (s.transactionType === "receivable") {
            stats.totalReceivable += s.amount || 0;
          } else {
            stats.totalPayable += s.amount || 0;
          }
          stats.totalSettled += s.totalSwapPaidAmount || 0;
        });
        return stats;
      },

      swapDashboardYear() {
        const startDate = this.viewStates.swapDashboard.filter.startDate;
        if (!startDate) return new Date().getFullYear();
        return new Date(startDate).getFullYear();
      },
      dashboardStats() {
        const activeRows = this.filteredPaymentsDashboard;

        let stats = {
          totalVnd: 0,
          totalUsd: 0,
          totalSwap: 0,
          count: activeRows.length,
        };

        activeRows.forEach((p) => {
          if (p.isSwapRow) {
            stats.totalSwap += p.amount || 0;
          } else {
            if (p.isUsd) {
              stats.totalUsd += p.amountUsd || 0;
            } else {
              stats.totalVnd += p.amount || 0;
            }
          }
        });

        return stats;
      },

      paymentDashboardYear() {
        const startDate = this.viewStates.paymentDashboard.filter.startDate;
        if (!startDate) return new Date().getFullYear();
        return new Date(startDate).getFullYear();
      },
      invoiceAgingColumns() {
        return [
          { key: "projectName", label: this.t("project") },
          { key: "contractNo", label: this.t("contract") },
          { key: "contractDate", label: this.t("date") + " (HĐ)" },
          {
            key: "contractDescription",
            label: this.t("details") + " (HĐ)",
          },
          { key: "vendorNo", label: this.t("vendorNo") },
          { key: "vendorName", label: this.t("vendor") },
          { key: "invoiceNo", label: this.t("invoiceNoLabel") },
          { key: "invoiceDate", label: this.t("date") },
          { key: "invoicePostingDate", label: this.t("postingDate") },
          {
            key: "age",
            label: this.t("ageDays"),
            class: "text-center-custom",
          },
          {
            key: "remainingNet",
            label: this.t("remainingNet"),
            class: "text-end-custom",
          },
          {
            key: "remainingVat",
            label: this.t("remainingVat"),
            class: "text-end-custom",
          },
          {
            key: "remainingTotal",
            label: this.t("remainingTotal"),
            class: "text-end-custom",
          },
        ];
      },

      processedInvoiceAgingData() {
        const reportDateStr =
          this.viewStates.invoiceAging.filter.reportDate;
        const reportDate = reportDateStr
          ? new Date(reportDateStr)
          : new Date();
        reportDate.setHours(0, 0, 0, 0);

        return this.cpcDetailRows
          .filter((row) => {
            const contract = this.contractMap.get(row.contractId);
            const selectedProjectIds =
              this.viewStates.invoiceAging.filter.projectId;
            if (
              selectedProjectIds.length > 0 &&
              (!contract ||
                !selectedProjectIds.includes(contract.projectId))
            )
              return false;
            if (!row.invoiceNo) return false;
            const remaining =
              (row.invoiceTotal || 0) - (row.paymentGrandTotal || 0);
            return remaining > 100;
          })
          .map((row) => {
            const contract = this.contractMap.get(row.contractId) || {};
            const project = this.projectMap.get(contract.projectId) || {};
            const vendor = this.vendorMap.get(contract.vendorId) || {};

            let age = 0;
            if (row.invoicePostingDate) {
              const pDate = new Date(row.invoicePostingDate);
              const diffTime = reportDate - pDate;
              age = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            }

            return {
              id: row.id,
              contractId: row.contractId,
              projectId: contract.projectId,
              vendorId: contract.vendorId,
              projectName: project.name || "N/A",
              contractNo: contract.contractNo || "N/A",
              contractDate: contract.date || "",
              contractDescription: contract.description || "",
              vendorNo: vendor.vendorNo || "",
              vendorName: vendor.name || "N/A",
              invoiceNo: row.invoiceNo.trim(),
              invoiceDate: row.invoiceDate,
              invoicePostingDate: row.invoicePostingDate,
              age: age,
              remainingNet:
                (row.invoiceAmount || 0) - (row.paymentTotalAmount || 0),
              remainingVat:
                (row.invoiceVat || 0) - (row.paymentTotalVat || 0),
              remainingTotal:
                (row.invoiceTotal || 0) - (row.paymentGrandTotal || 0),
            };
          });

        const groupedMap = new Map();

        rawList.forEach((item) => {
          const key = `${item.contractNo}_${item.invoiceNo}_${item.invoiceDate}_${item.invoicePostingDate}`;

          if (!groupedMap.has(key)) {
            groupedMap.set(key, { ...item, id: key });
          } else {
            const existing = groupedMap.get(key);
            existing.remainingNet += item.remainingNet;
            existing.remainingVat += item.remainingVat;
            existing.remainingTotal += item.remainingTotal;

            if (
              existing.projectName !== item.projectName &&
              !existing.projectName.includes(item.projectName)
            ) {
              existing.projectName += `, ${item.projectName}`;
            }
          }
        });

        return Array.from(groupedMap.values()).map((item) => ({
          ...item,
          remainingNetFormatted: this.formatCurrency(item.remainingNet),
          remainingVatFormatted: this.formatCurrency(item.remainingVat),
          remainingTotalFormatted: this.formatCurrency(item.remainingTotal),
        }));
      },

      filteredInvoiceAgingData() {
        const state = this.viewStates.invoiceAging;
        let data = [...this.processedInvoiceAgingData];

        if (state.filter.projectId.length > 0) {
          data = data.filter((item) =>
            state.filter.projectId.includes(item.projectId)
          );
        }
        if (state.filter.vendorId.length > 0) {
          data = data.filter((item) =>
            state.filter.vendorId.includes(item.vendorId)
          );
        }
        if (state.filter.minAge > 0) {
          data = data.filter((item) => item.age >= state.filter.minAge);
        }

        if (state.sortBy) {
          data.sort((a, b) => {
            let valA = a[state.sortBy];
            let valB = b[state.sortBy];

            if (
              [
                "remainingNet",
                "remainingVat",
                "remainingTotal",
                "age",
              ].includes(state.sortBy)
            ) {
              return state.sortDirection === "asc"
                ? valA - valB
                : valB - valA;
            }
            valA = (valA || "").toString().toLowerCase();
            valB = (valB || "").toString().toLowerCase();
            if (valA < valB) return state.sortDirection === "asc" ? -1 : 1;
            if (valA > valB) return state.sortDirection === "asc" ? 1 : -1;
            return 0;
          });
        }

        return data;
      },

      paginatedInvoiceAgingData() {
        const state = this.viewStates.invoiceAging;
        const start = (state.currentPage - 1) * state.perPage;
        return this.filteredInvoiceAgingData.slice(
          start,
          start + state.perPage
        );
      },

      totalInvoiceAgingPages() {
        return Math.ceil(
          this.filteredInvoiceAgingData.length /
          this.viewStates.invoiceAging.perPage
        );
      },

      totalInvoiceAging() {
        return this.filteredInvoiceAgingData.reduce(
          (acc, item) => {
            acc.net += item.remainingNet;
            acc.vat += item.remainingVat;
            acc.total += item.remainingTotal;
            return acc;
          },
          { net: 0, vat: 0, total: 0 }
        );
      },

      availableInvoiceAgingProjects() {
        return appUtils.filter.getAvailableItems({
          sourceData: this.projects,
          linkingData: this.contracts,
          linkKey: "projectId",
          searchTerm: this.viewStates.invoiceAging.filter.projectSearch,
          vueInstance: this,
        });
      },

      availableInvoiceAgingVendors() {
        let relevantContracts = this.contracts;

        const selectedProjectIds =
          this.viewStates.invoiceAging.filter.projectId;
        if (selectedProjectIds && selectedProjectIds.length > 0) {
          relevantContracts = relevantContracts.filter((c) =>
            selectedProjectIds.includes(c.projectId)
          );
        }

        return appUtils.filter.getAvailableItems({
          sourceData: this.vendors,
          linkingData: relevantContracts,
          linkKey: "vendorId",
          searchTerm: this.viewStates.invoiceAging.filter.vendorSearch,
          vueInstance: this,
        });
      },
      groupedBondsDashboard() {
        const flatBonds = this.filteredBondsDashboard;
        if (flatBonds.length === 0) return [];

        const groups = {};

        const sortedFlat = [...flatBonds].sort((a, b) => {
          const dateA = new Date(a.expiryDate || "1970-01-01");
          const dateB = new Date(b.expiryDate || "1970-01-01");
          return dateB - dateA;
        });

        sortedFlat.forEach((bond) => {
          const groupKey = `${bond.contractId}_${bond.bondType}`;
          const isExpanded =
            this.viewStates.bondDashboard.expandedGroupKeys.includes(
              groupKey
            );

          if (!groups[groupKey]) {
            groups[groupKey] = {
              groupKey: groupKey,
              latestBond: bond,
              history: [],
              isExpanded: isExpanded,
            };
          } else {
            groups[groupKey].history.push(bond);
          }
        });

        let groupArray = Object.values(groups);

        groupArray.forEach((group) => {
          if (group.history.length > 0) {
            group.history.sort((a, b) => {
              const dateA = new Date(a.expiryDate || "1970-01-01");
              const dateB = new Date(b.expiryDate || "1970-01-01");

              return dateB - dateA;
            });
          }
        });

        const state = this.viewStates.bondDashboard;
        if (state.sortBy) {
          groupArray.sort((groupA, groupB) => {
            const a = groupA.latestBond;
            const b = groupB.latestBond;

            let valA = a[state.sortBy];
            let valB = b[state.sortBy];

            if (valA == null) return 1;
            if (valB == null) return -1;

            if (state.sortBy === "amount") {
              valA = parseFloat(valA);
              valB = parseFloat(valB);
            } else if (["issueDate", "expiryDate"].includes(state.sortBy)) {
              valA = new Date(valA);
              valB = new Date(valB);
              if (isNaN(valA)) return 1;
              if (isNaN(valB)) return -1;
            } else if (typeof valA === "string") {
              valA = valA.toLowerCase();
              valB = valB.toLowerCase();
            }

            if (valA < valB) return state.sortDirection === "asc" ? -1 : 1;
            if (valA > valB) return state.sortDirection === "asc" ? 1 : -1;
            return 0;
          });
        }

        return groupArray;
      },

      paginatedGroupedBonds() {
        const state = this.viewStates.bondDashboard;
        const start = (state.currentPage - 1) * state.perPage;
        return this.groupedBondsDashboard.slice(
          start,
          start + state.perPage
        );
      },

      groupedBondDashboardTotalPages() {
        return Math.ceil(
          this.groupedBondsDashboard.length /
          this.viewStates.bondDashboard.perPage
        );
      },

      filteredProjectsForContractModal() {
        if (!this.isContractProjectDropdownVisible) return [];

        let candidates = this.projects;

        const searchTerm = this.currentEditContract?.projectName || "";

        if (searchTerm) {
          const normalizedSearch =
            appUtils.text.normalizeVietnamese(searchTerm);
          candidates = candidates.filter((p) =>
            appUtils.text
              .normalizeVietnamese(p.name)
              .includes(normalizedSearch)
          );
        }

        return candidates
          .sort((a, b) => a.name.localeCompare(b.name))
          .slice(0, 10);
      },
      filteredProjectsForModal() {
        if (!this.isProjectDropdownVisible) return [];

        let candidates = this.projects;
        const searchTerm = this.currentEditItem?.projectName || "";

        if (searchTerm) {
          const normalizedSearch =
            appUtils.text.normalizeVietnamese(searchTerm);
          candidates = candidates.filter((p) =>
            appUtils.text
              .normalizeVietnamese(p.name)
              .includes(normalizedSearch)
          );
        }

        return candidates
          .sort((a, b) => a.name.localeCompare(b.name))
          .slice(0, 10);
      },

      filteredContractsForModal() {
        if (!this.isContractDropdownVisible) return [];

        let candidates = this.contracts;

        const currentProjectName =
          this.currentEditItem?.projectName?.trim();
        if (currentProjectName) {
          const project = this.projects.find(
            (p) => p.name.toLowerCase() === currentProjectName.toLowerCase()
          );
          if (project) {
            candidates = candidates.filter(
              (c) => c.projectId === project.id
            );
          }
        }

        if (this.contractSearchTerm) {
          const normalizedSearch = appUtils.text.normalizeVietnamese(
            this.contractSearchTerm
          );

          candidates = candidates.filter((c) => {
            const vendor = this.vendorMap.get(c.vendorId);
            const vendorName = vendor ? vendor.name : "";

            const fullSearchString = `${c.contractNo} ${vendorName}`;

            return appUtils.text
              .normalizeVietnamese(fullSearchString)
              .includes(normalizedSearch);
          });
        }

        return candidates
          .sort((a, b) => a.contractNo.localeCompare(b.contractNo))
          .slice(0, 10);
      },

      activeNote() {
        if (
          !this.activeNoteTabId ||
          this.currentContractNotes.length === 0
        ) {
          return null;
        }
        return this.currentContractNotes.find(
          (tab) => tab.id === this.activeNoteTabId
        );
      },

      displayCategories() {
        if (!this.reportCategoriesFromDB) return [];

        const sorted = [...this.reportCategoriesFromDB].sort((a, b) =>
          a.code.localeCompare(b.code, undefined, { numeric: true })
        );

        const result = [];
        const parents = sorted.filter((c) => c.level === 1);

        parents.forEach((parent) => {
          result.push(parent);
          const children = sorted.filter(
            (c) => c.parentCode === parent.code
          );
          result.push(...children);
        });

        return result;
      },

      levelOneCategories() {
        return this.reportCategoriesFromDB
          .filter((c) => c.level === 1)
          .sort((a, b) =>
            a.code.localeCompare(b.code, undefined, { numeric: true })
          );
      },

      categoryUsageCount() {
        const counts = {};
        this.reportCategoriesFromDB.forEach(
          (cat) => (counts[cat.code] = 0)
        );
        this.contracts.forEach((contract) => {
          if (contract.code && counts[contract.code] !== undefined) {
            counts[contract.code]++;
          }
        });
        return counts;
      },

      availableReportProjects() {
        const projectIdsInUse = new Set(
          this.contracts.map((c) => c.projectId)
        );

        let activeProjects = this.projects.filter((p) =>
          projectIdsInUse.has(p.id)
        );

        const searchTerm =
          this.viewStates.reportDashboard.filter.projectSearch;

        if (searchTerm) {
          const normalizedSearch = this.normalizeVietnamese(searchTerm);
          activeProjects = activeProjects.filter((p) =>
            this.normalizeVietnamese(p.name).includes(normalizedSearch)
          );
        }

        return activeProjects.sort((a, b) => a.name.localeCompare(b.name));
      },
      isVndViewForUsdContract() {
        return (
          this.isCurrentContractUSD &&
          this.viewStates.cpcDetails.currencyView === "VND"
        );
      },

      projectMap() {
        return new Map(this.projects.map((p) => [p.id, p]));
      },
      vendorMap() {
        return new Map(this.vendors.map((v) => [v.id, v]));
      },
      contractMap() {
        return new Map(this.contracts.map((c) => [c.id, c]));
      },

      installmentsByCpcId() {
        const map = new Map();
        for (const inst of this.installments) {
          if (inst.cpcId) {
            if (!map.has(inst.cpcId)) {
              map.set(inst.cpcId, []);
            }
            map.get(inst.cpcId).push(inst);
          }
        }
        return map;
      },
      bondsByContractId() {
        const map = new Map();
        for (const bond of this.bonds) {
          if (bond.contractId) {
            if (!map.has(bond.contractId)) {
              map.set(bond.contractId, []);
            }
            map.get(bond.contractId).push(bond);
          }
        }
        return map;
      },
      cpcItemsByContractId() {
        const map = new Map();
        for (const cpc of this.cpcItems) {
          if (cpc.contractId) {
            if (!map.has(cpc.contractId)) {
              map.set(cpc.contractId, []);
            }
            map.get(cpc.contractId).push(cpc);
          }
        }
        return map;
      },
      cpcDetailRowsByContractId() {
        const map = new Map();
        for (const row of this.cpcDetailRows) {
          if (row.contractId) {
            if (!map.has(row.contractId)) {
              map.set(row.contractId, []);
            }
            map.get(row.contractId).push(row);
          }
        }
        return map;
      },

      contractByNumberMap() {
        const map = new Map();
        for (const contract of this.contracts) {
          if (contract.contractNo) {
            map.set(contract.contractNo.toLowerCase(), contract);
          }
        }
        return map;
      },
      vendorByNoMap() {
        const map = new Map();
        for (const vendor of this.vendors) {
          if (vendor.vendorNo) {
            map.set(vendor.vendorNo, vendor);
          }
        }
        return map;
      },

      contractsByVendorIdMap() {
        const map = new Map();
        for (const contract of this.contracts) {
          if (contract.vendorId) {
            if (!map.has(contract.vendorId)) {
              map.set(contract.vendorId, []);
            }
            map.get(contract.vendorId).push(contract);
          }
        }
        return map;
      },

      filteredProjectsForQuickFilter() {
        const allProjectsOption = {
          id: "all",
          name: `--- ${this.t("allProjects", {
            default: "All Projects",
          })} ---`,
        };

        const projectIdsInUse = [
          ...new Set(this.processedCpcData.map((item) => item.projectId)),
        ];

        const baseProjects = this.projects
          .filter((p) => projectIdsInUse.includes(p.id))
          .sort((a, b) => a.name.localeCompare(b.name));

        let projectsToShow = [allProjectsOption, ...baseProjects];

        if (this.projectQuickFilterSearch) {
          const normalizedSearch = appUtils.text.normalizeVietnamese(
            this.projectQuickFilterSearch
          );
          projectsToShow = projectsToShow.filter(
            (p) =>
              p.id === "all" ||
              appUtils.text
                .normalizeVietnamese(p.name)
                .includes(normalizedSearch)
          );
        }

        return projectsToShow;
      },
      projectMap() {
        return new Map(this.projects.map((p) => [p.id, p]));
      },
      vendorMap() {
        return new Map(this.vendors.map((v) => [v.id, v]));
      },
      contractMap() {
        return new Map(this.contracts.map((c) => [c.id, c]));
      },
      bankMap() {
        return new Map(this.banks.map((b) => [b.id, b]));
      },
      processedCpcDataMap() {
        return new Map(this.processedCpcData.map((cpc) => [cpc.id, cpc]));
      },

      availableContractProjects() {
        const projectIdsInUse = new Set(
          this.contracts.map((c) => c.projectId)
        );
        return this.projects
          .filter((p) => projectIdsInUse.has(p.id))
          .sort((a, b) => a.name.localeCompare(b.name));
      },
      filteredAvailableContractProjects() {
        const searchTerm =
          this.viewStates.contractDashboard.filter.projectSearch;
        if (!searchTerm) return this.availableContractProjects;
        const normalizedSearch = this.normalizeVietnamese(searchTerm);
        return this.availableContractProjects.filter((p) =>
          this.normalizeVietnamese(p.name).includes(normalizedSearch)
        );
      },
      availableContractVendors() {
        const projectIds =
          this.viewStates.contractDashboard.filter.projectId;
        let relevantContracts = this.contracts;
        if (projectIds.length > 0) {
          relevantContracts = relevantContracts.filter((c) =>
            projectIds.includes(c.projectId)
          );
        }
        const vendorIdsInUse = new Set(
          relevantContracts.map((c) => c.vendorId)
        );
        return this.vendors
          .filter((v) => vendorIdsInUse.has(v.id))
          .sort((a, b) => a.name.localeCompare(b.name));
      },
      filteredAvailableContractVendors() {
        const searchTerm =
          this.viewStates.contractDashboard.filter.vendorSearch;
        if (!searchTerm) return this.availableContractVendors;
        const normalizedSearch = this.normalizeVietnamese(searchTerm);
        return this.availableContractVendors.filter((v) =>
          this.normalizeVietnamese(v.name).includes(normalizedSearch)
        );
      },
      availableContractContracts() {
        let relevantContracts = this.contracts;
        const projectIds =
          this.viewStates.contractDashboard.filter.projectId;
        const vendorIds = this.viewStates.contractDashboard.filter.vendorId;
        if (projectIds.length > 0) {
          relevantContracts = relevantContracts.filter((c) =>
            projectIds.includes(c.projectId)
          );
        }
        if (vendorIds.length > 0) {
          relevantContracts = relevantContracts.filter((c) =>
            vendorIds.includes(c.vendorId)
          );
        }
        return relevantContracts.sort((a, b) =>
          a.contractNo.localeCompare(b.contractNo)
        );
      },
      filteredAvailableContractContracts() {
        const searchTerm =
          this.viewStates.contractDashboard.filter.contractNoSearch;
        if (!searchTerm) return this.availableContractContracts;
        return this.availableContractContracts.filter((c) =>
          c.contractNo.toLowerCase().includes(searchTerm.toLowerCase())
        );
      },
      availableCodesForContract() {
        let relevantContracts = this.contracts;
        const { projectId, vendorId, contractId } =
          this.viewStates.contractDashboard.filter;
        if (projectId.length > 0) {
          relevantContracts = relevantContracts.filter((c) =>
            projectId.includes(c.projectId)
          );
        }
        if (vendorId.length > 0) {
          relevantContracts = relevantContracts.filter((c) =>
            vendorId.includes(c.vendorId)
          );
        }
        if (contractId.length > 0) {
          relevantContracts = relevantContracts.filter((c) =>
            contractId.includes(c.id)
          );
        }
        return [
          ...new Set(
            relevantContracts.map((item) => item.code).filter(Boolean)
          ),
        ].sort();
      },
      filteredAvailableContractCodes() {
        const searchTerm =
          this.viewStates.contractDashboard.filter.codeSearch;
        if (!searchTerm) return this.availableCodesForContract;
        return this.availableCodesForContract.filter((c) =>
          c.toLowerCase().includes(searchTerm.toLowerCase())
        );
      },

      filteredBondContractsForModal() {
        if (!this.bondContractSearchTerm || this.bondModalMode === "edit") {
          return [];
        }
        const normalizedSearch = appUtils.text.normalizeVietnamese(
          this.bondContractSearchTerm
        );
        return this.contracts
          .filter((contract) => {
            const vendor = this.vendorMap.get(contract.vendorId);
            const searchText = `${contract.contractNo} ${vendor ? vendor.name : ""
              }`;
            return appUtils.text
              .normalizeVietnamese(searchText)
              .includes(normalizedSearch);
          })
          .sort((a, b) => a.contractNo.localeCompare(b.contractNo))
          .slice(0, 10);
      },
      projectMap() {
        return new Map(this.projects.map((p) => [p.id, p]));
      },
      vendorMap() {
        return new Map(this.vendors.map((v) => [v.id, v]));
      },
      contractMap() {
        return new Map(this.contracts.map((c) => [c.id, c]));
      },
      bankMap() {
        return new Map(this.banks.map((b) => [b.id, b]));
      },
      processedCpcDataMap() {
        return new Map(this.processedCpcData.map((cpc) => [cpc.id, cpc]));
      },
      cogsContractsAsOfDate() {
        const asOfDate = this.viewStates.cogsDashboard.filter.asOfDate;
        const reportTime = asOfDate ? new Date(asOfDate).getTime() : Infinity;

        // Bước 1: Lọc nhanh các Hợp đồng thuộc các Dự án đang chọn (nếu có lọc)
        const selectedProjectIds = this.viewStates.cogsDashboard.filter.projectId;
        const targetContracts = selectedProjectIds.length > 0
          ? this.contracts.filter(c => selectedProjectIds.includes(c.projectId))
          : this.contracts;

        // Bước 2: Nhóm cpcDetailRows theo contractId TRƯỚC khi vào vòng lặp (Chỉ quét mảng Rows 1 lần)
        const rowsByContract = new Map();
        this.cpcDetailRows.forEach(row => {
          // Chỉ lấy các dòng có ngày hạch toán <= ngày báo cáo
          const postingTime = row.invoicePostingDate ? new Date(row.invoicePostingDate).getTime() : 0;
          if (postingTime <= reportTime) {
            if (!rowsByContract.has(row.contractId)) rowsByContract.set(row.contractId, []);
            rowsByContract.get(row.contractId).push(row);
          }
        });

        // Bước 3: Lấy Map CPC Items để tra cứu tỷ giá nhanh
        const cpcMap = new Map();
        this.cpcItems.forEach(c => {
          cpcMap.set(`${c.contractId}_${c.cpcIdentifier}`, c.exchangeRate || 0);
        });

        // Bước 4: Tính toán tổng hợp cho từng hợp đồng
        return targetContracts.map((contract) => {
          const project = this.projectMap.get(contract.projectId) || {};
          const vendor = this.vendorMap.get(contract.vendorId) || {};
          const relevantRows = rowsByContract.get(contract.id) || [];

          let invoiceAmountTotal = 0;
          const isUsd = contract.currency === "USD";

          relevantRows.forEach((row) => {
            if (isUsd) {
              // Ưu tiên tỷ giá trên hóa đơn, nếu ko có lấy tỷ giá CPC tương ứng
              let rate = parseFloat(row.invoiceExchangeRate) || cpcMap.get(`${contract.id}_${row.cpcNo}`) || 0;
              invoiceAmountTotal += Math.round((row.invoiceAmount || 0) * rate);
            } else {
              invoiceAmountTotal += (row.invoiceAmount || 0);
            }
          });

          return {
            ...contract,
            projectName: project.name || "N/A",
            vendorName: vendor.name || "N/A",
            vendorNo: vendor.vendorNo || "",
            invoiceAmountTotal,
          };
        });
      },
      hasOrphanData() {
        return Object.values(this.orphanData).some((arr) => arr.length > 0);
      },
      availableProjectsForBackup() {
        return [...this.projects].sort((a, b) =>
          a.name.localeCompare(b.name)
        );
      },
      availableCogsProjects() {
        const search = (
          this.viewStates.cogsDashboard.filter.projectSearch || ""
        ).toLowerCase();

        const projectIdsInUse = [
          ...new Set(this.contracts.map((c) => c.projectId)),
        ];

        const activeProjects = this.projects.filter((p) =>
          projectIdsInUse.includes(p.id)
        );

        if (!search) {
          return activeProjects.sort((a, b) =>
            a.name.localeCompare(b.name)
          );
        }
        return activeProjects
          .filter((p) => p.name.toLowerCase().includes(search))
          .sort((a, b) => a.name.localeCompare(b.name));
      },

      availableCogsStatuses() {
        return ["Match", "Mismatch", "Only in App", "Only in Accounting"];
      },

      cogsDashboardData() {
        if (this.currentTab !== "cogs-dashboard") return [];

        const state = this.viewStates.cogsDashboard;
        const baseData = this.cogsContractsAsOfDate; // Dữ liệu này đã được lọc theo Project ở bước trên

        let finalData;
        if (!this.cogsComparisonData) {
          // Chế độ không có file SAP
          finalData = baseData.map(item => ({
            ...item,
            invAmountSap: 0,
            difference: item.invoiceAmountTotal,
            status: "Only in App",
          }));
        } else {
          // Chế độ đối chiếu với file SAP (Sử dụng Map để merge dữ liệu O(1))
          const sapData = this.cogsComparisonData;
          const allKeys = new Set([...baseData.map(c => c.contractSystemNo || c.contractNo), ...Object.keys(sapData)]);

          const appDataMap = new Map(baseData.map(c => [c.contractSystemNo || c.contractNo, c]));

          finalData = Array.from(allKeys).map(key => {
            const app = appDataMap.get(key);
            const excel = sapData[key];

            const invAmountApp = app ? app.invoiceAmountTotal : 0;
            const invAmountSap = excel ? excel.invAmount : 0;
            const diff = invAmountApp - invAmountSap;

            let status = "Mismatch";
            if (!app && excel) status = "Only in Accounting";
            else if (app && !excel) status = "Only in App";
            else if (Math.abs(diff) < 1) status = "Match";

            return {
              id: app ? app.id : key,
              glAccount: app ? app.glAccount : (excel?.glAccount || "N/A"),
              vendorName: app ? app.vendorName : (excel?.vendorName || "N/A"),
              contractNo: app ? app.contractNo : key,
              contractSystemNo: app ? app.contractSystemNo : key,
              projectId: app ? app.projectId : null,
              invoiceAmountTotal: invAmountApp,
              invAmountSap: invAmountSap,
              difference: diff,
              status: status,
            };
          });
        }

        // Lọc theo Status (nếu có chọn)
        if (state.filter.status.length > 0) {
          finalData = finalData.filter(item => state.filter.status.includes(item.status));
        }

        // Sắp xếp (Sort)
        if (state.sortBy) {
          const dir = state.sortDirection === "asc" ? 1 : -1;
          const key = state.sortBy;
          finalData.sort((a, b) => {
            const valA = a[key];
            const valB = b[key];
            if (typeof valA === 'number') return dir * (valA - valB);
            return dir * String(valA).localeCompare(String(valB));
          });
        }

        return finalData;
      },
      cogsSummaryData() {
        if (
          this.currentTab !== "cogs-dashboard" ||
          this.viewStates.cogsDashboard.filter.projectId.length === 0
        ) {
          return [];
        }
        const state = this.viewStates.cogsDashboard;

        const appSummary = new Map();

        const filteredContractsInApp = this.cogsContractsAsOfDate.filter(
          (c) => {
            const projectFilter = state.filter.projectId;
            return (
              projectFilter.length === 0 ||
              projectFilter.includes(c.projectId)
            );
          }
        );

        filteredContractsInApp.forEach((contract) => {
          const gl = contract.glAccount || "N/A";
          const currentTotal = appSummary.get(gl) || 0;
          appSummary.set(
            gl,
            currentTotal + (contract.invoiceAmountTotal || 0)
          );
        });

        if (!this.cogsSummaryFromSap) {
          return Array.from(appSummary.entries())
            .map(([gl, total]) => ({
              glAccount: gl,
              totalInvoiceAmount: total,
              totalSap: 0,
              difference: total,
            }))
            .sort((a, b) => a.glAccount.localeCompare(b.glAccount));
        }

        const sapSummary = this.cogsSummaryFromSap;
        const combinedKeys = new Set([
          ...appSummary.keys(),
          ...Object.keys(sapSummary),
        ]);
        const combinedData = [];

        combinedKeys.forEach((glAccount) => {
          const appAmount = appSummary.get(glAccount) || 0;
          const sapAmount = sapSummary[glAccount] || 0;
          combinedData.push({
            glAccount: glAccount,
            totalInvoiceAmount: appAmount,
            totalSap: sapAmount,
            difference: appAmount - sapAmount,
          });
        });

        return combinedData.sort((a, b) =>
          a.glAccount.localeCompare(b.glAccount)
        );
      },

      totalCogsSummary() {
        return this.cogsSummaryData.reduce(
          (totals, item) => {
            totals.totalInvoiceAmount += item.totalInvoiceAmount || 0;
            totals.totalSap += item.totalSap || 0;
            totals.difference += item.difference || 0;
            return totals;
          },
          { totalInvoiceAmount: 0, totalSap: 0, difference: 0 }
        );
      },

      paginatedCogsDetailsData() {
        const state = this.viewStates.cogsDashboard;
        const start = (state.currentPage - 1) * state.perPage;
        return this.cogsDashboardData.slice(start, start + state.perPage);
      },

      cogsDashboardTotalPages() {
        return Math.ceil(
          this.cogsDashboardData.length /
          this.viewStates.cogsDashboard.perPage
        );
      },

      totalCogsDetails() {
        return this.cogsDashboardData.reduce(
          (totals, item) => {
            totals.totalInvoiceAmount += item.invoiceAmountTotal || 0;
            if (this.cogsComparisonData) {
              totals.totalInvAmountSap += item.invAmountSap || 0;
              totals.totalDifference += item.difference || 0;
            }
            return totals;
          },
          {
            totalInvoiceAmount: 0,
            totalInvAmountSap: 0,
            totalDifference: 0,
          }
        );
      },

      sidebarTabs() {
        return [
          { key: "cpc-tracking", label: this.t("tabCpcTracking") },
          { key: "cpc-details", label: this.t("tabCpcDetails") },
          { key: "contract-overview", label: this.t("contractOverview") },
          { key: "vendor-partner", label: this.t("vendorPartner") },
          { key: "vendor-balance", label: this.t("tabVendorBalance") },
          { key: "cpc-dashboard", label: this.t("tabPaymentDashboard") },
          { key: "cpc-swap-dashboard", label: this.t("tabSwapDashboard") },
          { key: "cpc-bond-dashboard", label: this.t("tabBondDashboard") },
          {
            key: "cpc-contract-dashboard",
            label: this.t("tabContractDashboard"),
          },
          {
            key: "cpc-report-dashboard",
            label: this.t("tabReportDashboard"),
          },
          { key: "cogs-dashboard", label: this.t("tabCogsDashboard") },
          { key: "invoice-aging", label: this.t("tabInvoiceAging") },

          { key: "master-data", label: "Master Data" },
        ];
      },
      quickMenuItems() {
        return [
          {
            action: "addCpc",
            label: this.t("btnAddCpc"),
            icon: "fas fa-plus",
          },
          {
            action: "addBond",
            label: this.t("btnAddBond"),
            icon: "fas fa-shield-alt",
          },
          {
            action: "addContract",
            label: this.t("btnAddContract"),
            icon: "fas fa-file-signature",
          },
          {
            action: "addVendor",
            label: this.t("modalTitleAddVendor", { vendor: "Vendor" }),
            icon: "fas fa-truck-fast",
          },
        ];
      },
      vendorBalanceData() {
        const _version = this.dataVersion;
        if (this.viewStates.vendorBalance.filter.projectId.length === 0) {
          return [];
        }

        const userSelectedDate =
          this.viewStates.vendorBalance.filter.asOfDate;
        const calculationDate = userSelectedDate
          ? userSelectedDate
          : appUtils.format.date(new Date());
        const reportDate = new Date(calculationDate);
        reportDate.setHours(23, 59, 59, 999);

        const projectFilter =
          this.viewStates.vendorBalance.filter.projectId;

        let relevantContracts = this.contracts.filter((c) =>
          projectFilter.includes(c.projectId)
        );

        const vendorMap = new Map();

        relevantContracts.forEach((contract) => {
          const vendor = this.vendorMap.get(contract.vendorId);
          if (!vendor) return;

          if (!vendorMap.has(vendor.id)) {
            vendorMap.set(vendor.id, {
              vendorId: vendor.id,
              vendorNo: vendor.vendorNo,
              vendorName: vendor.name,
              gl3311: 0,
              gl3312: 0,
            });
          }

          const vendorData = vendorMap.get(vendor.id);
          let finalPayableInVND = 0;
          let finalAdvanceInVND = 0;

          if (contract.currency === "USD") {
            const detailsTable =
              this.cpcDetailRowsByContractId.get(contract.id) || [];
            const cpcItemsForContract =
              this.cpcItemsByContractId.get(contract.id) || [];
            const allCpcIdsForContract = cpcItemsForContract.map(
              (cpc) => cpc.id
            );

            const getEffectiveRateForRow = (row) => {
              let rate = parseFloat(row.invoiceExchangeRate) || 0;
              if (rate > 0) return rate;

              const cpcItem = cpcItemsForContract.find(
                (cpc) => cpc.cpcIdentifier === row.cpcNo
              );
              return cpcItem ? cpcItem.exchangeRate || 0 : 0;
            };

            let totalAdvanceVND = 0;
            let totalRepaymentVND = 0;

            detailsTable.forEach((row) => {
              const rate = getEffectiveRateForRow(row);
              const cpcItem = cpcItemsForContract.find(
                (c) => c.cpcIdentifier === row.cpcNo
              );
              if (cpcItem) {
                const installmentsForCpc =
                  this.installmentsByCpcId.get(cpcItem.id) || [];
                const isAdvancePaid = installmentsForCpc.some(
                  (inst) => inst.date && new Date(inst.date) <= reportDate
                );
                if (isAdvancePaid) {
                  totalAdvanceVND += Math.round(
                    (row.cpcAdvance || 0) * rate
                  );
                }
              }
              if (
                row.invoicePostingDate &&
                new Date(row.invoicePostingDate) <= reportDate
              ) {
                totalRepaymentVND += Math.round(
                  (row.cpcRepayment || 0) * rate
                );
              }
            });

            finalAdvanceInVND = totalAdvanceVND + totalRepaymentVND;

            const totalInvoicedVND = detailsTable
              .filter(
                (row) =>
                  row.invoicePostingDate &&
                  new Date(row.invoicePostingDate) <= reportDate
              )
              .reduce(
                (sum, row) =>
                  sum +
                  Math.round(
                    (row.invoiceTotal || 0) * getEffectiveRateForRow(row)
                  ),
                0
              );

            const totalPaidVND = allCpcIdsForContract.reduce(
              (sum, cpcId) => {
                const installmentsForCpc =
                  this.installmentsByCpcId.get(cpcId) || [];
                const paidForCpc = installmentsForCpc
                  .filter(
                    (inst) => inst.date && new Date(inst.date) <= reportDate
                  )
                  .reduce(
                    (cpcSum, inst) =>
                      cpcSum + (inst.amountVND || inst.amount || 0),
                    0
                  );
                return sum + paidForCpc;
              },
              0
            );

            const payableFromInvoice = totalInvoicedVND - totalPaidVND;
            const finalPayableRaw = payableFromInvoice + finalAdvanceInVND;
            finalPayableInVND = Math.max(0, finalPayableRaw);
          } else {
            const balance = this.calculateContractBalanceAsOf(
              contract.id,
              calculationDate
            );
            finalPayableInVND = balance.finalPayable;
            finalAdvanceInVND = balance.advanceBalance;
          }

          vendorData.gl3311 += finalPayableInVND;
          vendorData.gl3312 += finalAdvanceInVND;
        });

        let data = Array.from(vendorMap.values());
        const state = this.viewStates.vendorBalance;
        if (state.sortBy) {
          data.sort((a, b) => {
            let valA = a[state.sortBy];
            let valB = b[state.sortBy];
            if (typeof valA === "string") {
              return state.sortDirection === "asc"
                ? valA.localeCompare(valB)
                : valB.localeCompare(valA);
            } else {
              return state.sortDirection === "asc"
                ? valA - valB
                : valB - valA;
            }
          });
        }
        return data;
      },
      paginatedVendorBalanceData() {
        const state = this.viewStates.vendorBalance;
        const start = (state.currentPage - 1) * state.perPage;
        const end = start + state.perPage;
        return this.vendorBalanceData.slice(start, end);
      },
      vendorBalanceTotalPages() {
        const totalItems = this.accountingComparisonData
          ? this.vendorBalanceComparison.length
          : this.vendorBalanceData.length;
        return Math.ceil(
          totalItems / this.viewStates.vendorBalance.perPage
        );
      },
      totalVendorBalance() {
        return this.vendorBalanceData.reduce(
          (totals, item) => {
            totals.gl3311 += item.gl3311;
            totals.gl3312 += item.gl3212;
            return totals;
          },
          { gl3311: 0, gl3312: 0 }
        );
      },
      availableProjectsForVendorBalance() {
        return appUtils.filter.getAvailableItems({
          sourceData: this.projects,
          linkingData: this.contracts,
          linkKey: "projectId",
          searchTerm: this.viewStates.vendorBalance.filter.projectSearch,
          vueInstance: this,
        });
      },

      vendorBalanceComparison() {
        let dataToFilterAndSort;

        if (!this.accountingComparisonData) {
          dataToFilterAndSort = this.vendorBalanceData.map((item) => ({
            ...item,
            gl3311_app: item.gl3311,
            gl3312_app: item.gl3312,
            status: "",
          }));
        } else {
          const comparison = [];
          const allVendorNos = new Set([
            ...this.vendorBalanceData.map((v) => v.vendorNo),
            ...Object.keys(this.accountingComparisonData),
          ]);
          allVendorNos.forEach((vendorNo) => {
            if (!vendorNo) return;
            const appData = this.vendorBalanceData.find(
              (v) => v.vendorNo === vendorNo
            );
            const excelData = this.accountingComparisonData[vendorNo];
            const gl3311_app = appData ? appData.gl3311 : 0;
            const gl3312_app = appData ? appData.gl3312 : 0;
            const gl3311_excel = excelData ? excelData.gl3311 : 0;
            const gl3312_excel = excelData ? excelData.gl3312 : 0;
            const gl3311_diff = gl3311_app - gl3311_excel;
            const gl3312_diff = gl3312_app - gl3312_excel;

            let status = "Mismatch";
            if (!appData && excelData) status = "Only in Accounting";
            else if (appData && !excelData) status = "Only in App";
            else if (
              Math.round(gl3311_diff) === 0 &&
              Math.round(gl3312_diff) === 0
            )
              status = "Match";

            comparison.push({
              vendorId: appData ? appData.vendorId : vendorNo,
              vendorNo: vendorNo,
              vendorName: appData
                ? appData.vendorName
                : excelData.vendorName || `(Chưa có trong App)`,
              gl3311_app,
              gl3312_app,
              gl3311_excel,
              gl3312_excel,
              gl3311_diff,
              gl3312_diff,
              status,
            });
          });
          dataToFilterAndSort = comparison;
        }

        const filters = this.viewStates.vendorBalance.filter;
        const searchTerm = this.viewStates.vendorBalance.searchTerm;

        if (filters.status.length > 0) {
          dataToFilterAndSort = dataToFilterAndSort.filter((item) =>
            filters.status.includes(item.status)
          );
        }

        if (filters.balanceStatus === "hasBalance") {
          dataToFilterAndSort = dataToFilterAndSort.filter((item) => {
            if (this.accountingComparisonData) {
              return (
                (item.gl3311_app || 0) !== 0 ||
                (item.gl3312_app || 0) !== 0 ||
                (item.gl3311_excel || 0) !== 0 ||
                (item.gl3312_excel || 0) !== 0
              );
            } else {
              return (
                (item.gl3311_app || 0) !== 0 || (item.gl3312_app || 0) !== 0
              );
            }
          });
        } else if (filters.balanceStatus === "fullySettled") {
          dataToFilterAndSort = dataToFilterAndSort.filter((item) => {
            if (this.accountingComparisonData) {
              return (
                (item.gl3311_app || 0) === 0 &&
                (item.gl3312_app || 0) === 0 &&
                (item.gl3311_excel || 0) === 0 &&
                (item.gl3312_excel || 0) === 0
              );
            } else {
              return (
                (item.gl3311_app || 0) === 0 && (item.gl3312_app || 0) === 0
              );
            }
          });
        }

        if (searchTerm && searchTerm.trim() !== "") {
          const normalizedSearch = appUtils.text.normalizeVietnamese(
            searchTerm.trim()
          );
          const rawSearch = searchTerm.trim().toLowerCase();

          dataToFilterAndSort = dataToFilterAndSort.filter((item) => {
            const normName = appUtils.text.normalizeVietnamese(
              item.vendorName || ""
            );
            const normNo = (item.vendorNo || "").toLowerCase();
            return (
              normName.includes(normalizedSearch) ||
              normNo.includes(rawSearch)
            );
          });
        }

        const state = this.viewStates.vendorBalance;
        if (state.sortBy) {
          dataToFilterAndSort.sort((a, b) => {
            let valA = a[state.sortBy];
            let valB = b[state.sortBy];
            const sortKey =
              state.sortBy.endsWith("_app") ||
                state.sortBy.endsWith("_excel") ||
                state.sortBy.endsWith("_diff")
                ? state.sortBy
                : `${state.sortBy}_app`;

            if (a[sortKey] !== undefined) valA = a[sortKey];
            else if (a[state.sortBy] !== undefined) valA = a[state.sortBy];

            if (b[sortKey] !== undefined) valB = b[sortKey];
            else if (b[state.sortBy] !== undefined) valB = b[state.sortBy];

            if (typeof valA === "string") {
              return state.sortDirection === "asc"
                ? valA.localeCompare(valB)
                : valB.localeCompare(valA);
            } else {
              return state.sortDirection === "asc"
                ? (valA || 0) - (valB || 0)
                : (valB || 0) - (valA || 0);
            }
          });
        }

        return dataToFilterAndSort;
      },

      paginatedVendorBalanceComparison() {
        const state = this.viewStates.vendorBalance;
        const start = (state.currentPage - 1) * state.perPage;
        const end = start + state.perPage;
        return this.vendorBalanceComparison.slice(start, end);
      },

      totalVendorBalanceComparison() {
        return this.vendorBalanceComparison.reduce(
          (totals, item) => {
            totals.gl3311_app += item.gl3311_app || 0;
            totals.gl3312_app += item.gl3312_app || 0;
            totals.gl3311_excel += item.gl3311_excel || 0;
            totals.gl3312_excel += item.gl3312_excel || 0;
            totals.gl3311_diff += item.gl3311_diff || 0;
            totals.gl3312_diff += item.gl3312_diff || 0;
            return totals;
          },
          {
            gl3311_app: 0,
            gl3312_app: 0,
            gl3311_excel: 0,
            gl3312_excel: 0,
            gl3311_diff: 0,
            gl3312_diff: 0,
          }
        );
      },

      invoiceCpcRows() {
        if (!this.currentDetailItem || !this.currentDetailItem.cpcNo)
          return [];
        const contractId =
          this.viewStates.cpcDetails.filter.selectedContractId;
        return this.cpcDetailRows.filter(
          (row) =>
            row.contractId === contractId &&
            row.cpcNo === this.currentDetailItem.cpcNo
        );
      },
      vendorUsageCount() {
        const counts = {};
        this.vendors.forEach((v) => (counts[v.id] = 0));
        this.contracts.forEach((c) => {
          if (counts[c.vendorId] !== undefined) {
            counts[c.vendorId]++;
          }
        });
        return counts;
      },

      projectUsageCount() {
        const counts = {};
        this.projects.forEach((p) => (counts[p.id] = 0));
        this.contracts.forEach((c) => {
          if (counts[c.projectId] !== undefined) {
            counts[c.projectId]++;
          }
        });
        return counts;
      },

      bankUsageCount() {
        const counts = {};
        this.banks.forEach((b) => (counts[b.id] = 0));
        this.bonds.forEach((bond) => {
          if (counts[bond.issuingBank] !== undefined) {
            counts[bond.issuingBank]++;
          }
        });
        return counts;
      },

      filteredVendorsForAdmin() {
        const state = this.masterData.vendors;
        if (!state.searchTerm) {
          return this.vendors;
        }
        const normalizedSearch = appUtils.text.normalizeVietnamese(
          state.searchTerm
        );
        return this.vendors.filter(
          (v) =>
            appUtils.text
              .normalizeVietnamese(v.name)
              .includes(normalizedSearch) ||
            (v.abbrName &&
              appUtils.text
                .normalizeVietnamese(v.abbrName)
                .includes(normalizedSearch)) ||
            (v.vendorNo && v.vendorNo.includes(state.searchTerm))
        );
      },
      paginatedVendors() {
        const state = this.masterData.vendors;
        const start = (state.currentPage - 1) * state.perPage;
        return this.filteredVendorsForAdmin.slice(
          start,
          start + state.perPage
        );
      },
      vendorTotalPages() {
        return Math.ceil(
          this.filteredVendorsForAdmin.length /
          this.masterData.vendors.perPage
        );
      },

      filteredProjectsForAdmin() {
        const state = this.masterData.projects;
        if (!state.searchTerm) return this.projects;
        const normalizedSearch = appUtils.text.normalizeVietnamese(
          state.searchTerm
        );
        return this.projects.filter((p) =>
          appUtils.text
            .normalizeVietnamese(p.name)
            .includes(normalizedSearch)
        );
      },
      paginatedProjects() {
        const state = this.masterData.projects;
        const start = (state.currentPage - 1) * state.perPage;
        return this.filteredProjectsForAdmin.slice(
          start,
          start + state.perPage
        );
      },
      projectTotalPages() {
        return Math.ceil(
          this.filteredProjectsForAdmin.length /
          this.masterData.projects.perPage
        );
      },

      formattedLastSaveTime() {
        if (!this.lastSaveTimestamp) {
          return null;
        }
        const date = new Date(this.lastSaveTimestamp);
        return date.toLocaleString(this.language, {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
        });
      },
      tooltipText() {
        if (this.isDataDirty) {
          return this.t("unsavedChangesTooltip");
        }
        if (this.formattedLastSaveTime) {
          return `${this.t("savedStatusTooltip")} - ${this.formattedLastSaveTime
            }`;
        }
        return this.t("savedStatusTooltip");
      },
      commandResults() {
        if (!this.commandSearchTerm) {
          return [];
        }
        return this.commandSearchResults;
      },

      availableRepaymentBasis() {
        if (!this.currentDetailItem) return [];
        const contractId =
          this.viewStates.cpcDetails.filter.selectedContractId;
        const tableData = this.cpcDetailRows
          .filter((r) => r.contractId === contractId)
          .sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));

        return tableData
          .map((row, index) => {
            const cVal = Number(row.contractAmount) || 0;
            const vVal = Number(row.contractVon) || 0;
            if (cVal === 0 && vVal === 0) return null;

            return {
              id: row.id,
              index: index + 1,
              info: row.contractInfo || "Hợp đồng chính",
              contractAmount: cVal,
              contractVon: vVal,
              total: cVal + vVal,
              isChecked:
                this.currentDetailItem.repaymentBasisItems?.includes(
                  row.id
                ) || false,
            };
          })
          .filter(Boolean);
      },

      isCurrentContractUSD() {
        return this.selectedContractDetails?.currency === "USD";
      },
      vndViewWeightedAvgRate() {
        if (
          !this.isCurrentContractUSD ||
          this.viewStates.cpcDetails.currencyView !== "VND"
        ) {
          return 0;
        }
        const contractId =
          this.viewStates.cpcDetails.filter.selectedContractId;
        if (!contractId) return 0;

        const cpcIdsForContract = this.cpcItems
          .filter((c) => c.contractId === contractId)
          .map((c) => c.id);
        const allPayments = this.installments.filter((i) =>
          cpcIdsForContract.includes(i.cpcId)
        );

        const totalPaidUSD = allPayments.reduce(
          (sum, p) => sum + (p.amountUsd || 0),
          0
        );
        const totalPaidVND = allPayments.reduce(
          (sum, p) => sum + (p.amountVND || p.amount || 0),
          0
        );

        return totalPaidUSD > 0 ? totalPaidVND / totalPaidUSD : 0;
      },
      displayedContractDetailTable() {
        const _version = this.dataVersion;
        const contractId =
          this.viewStates.cpcDetails.filter.selectedContractId;
        if (!contractId) return [];

        const activePhaseId = this.viewStates.cpcDetails.activePhaseId;
        const contractPhases = this.selectedContractDetails?.phases || [];

        let allRows = this.cpcDetailRows.filter(
          (row) => row.contractId === contractId
        );
        let rowsToDisplay = [];

        if (activePhaseId === "summary") {
          const rowsByPhase = {};
          contractPhases.forEach((p) => (rowsByPhase[p.id] = []));
          rowsByPhase["undefined"] = [];

          allRows.forEach((row) => {
            const pId =
              row.phaseId &&
                contractPhases.some((p) => p.id === row.phaseId)
                ? row.phaseId
                : "undefined";
            rowsByPhase[pId].push(row);
          });

          contractPhases.forEach((phase) => {
            const phaseRows = rowsByPhase[phase.id].sort(
              (a, b) => (a.sortOrder || 0) - (b.sortOrder || 0)
            );

            const displayRows = phaseRows.map((r, index) => {
              const rView = { ...r };
              if (index === 0) {
                const phasePrefix = `[${phase.name}]`;
                if (
                  !rView.contractInfo ||
                  !rView.contractInfo.startsWith("[")
                ) {
                  rView.contractInfo = `${phasePrefix}\n${rView.contractInfo || ""
                    }`;
                }
              }
              return rView;
            });

            rowsToDisplay.push(...displayRows);
          });

          const undefinedRows = rowsByPhase["undefined"].sort(
            (a, b) => (a.sortOrder || 0) - (b.sortOrder || 0)
          );
          if (contractPhases.length > 0) {
            const nonEmptyUndefinedRows = undefinedRows.filter(
              (r) =>
                (r.contractAmount || 0) !== 0 ||
                (r.contractVon || 0) !== 0 ||
                r.cpcNo
            );

            if (nonEmptyUndefinedRows.length > 0) {
              const firstUnset = { ...nonEmptyUndefinedRows[0] };
              firstUnset.contractInfo = `[Chung/Khác]\n${firstUnset.contractInfo || ""
                }`;
              nonEmptyUndefinedRows[0] = firstUnset;
              rowsToDisplay.push(...nonEmptyUndefinedRows);
            }
          } else {
            rowsToDisplay.push(...undefinedRows);
          }
        } else {
          rowsToDisplay = allRows
            .filter((row) => row.phaseId === activePhaseId)
            .sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));
        }

        if (
          this.isCurrentContractUSD &&
          this.viewStates.cpcDetails.currencyView === "VND"
        ) {
          return rowsToDisplay.map((item) => {
            const newItem = { ...item };
            let effectiveRate = parseFloat(item.invoiceExchangeRate) || 0;
            if (effectiveRate <= 0 && item.cpcNo) {
              const cpcItem = this.cpcItems.find(
                (c) =>
                  c.contractId === contractId &&
                  c.cpcIdentifier === item.cpcNo
              );
              if (cpcItem) effectiveRate = cpcItem.exchangeRate || 0;
            }
            const fieldsToConvert = [
              "contractAmount",
              "contractVon",
              "cpcWorkDone",
              "cpcPaymentOfWorkdone",
              "cpcAdvance",
              "cpcRepayment",
              "cpcRetention",
              "cpcOtherDeduction",
              "cpcAmountDue",
              "invoiceAmount",
              "paymentTotalAmount",
              "paymentGrandTotal",
              "remainingPayable",
              "contractRemainingInclVat",
              "contractRemainingExclVat",
            ];
            fieldsToConvert.forEach(
              (f) =>
                (newItem[f] = Math.round((item[f] || 0) * effectiveRate))
            );
            newItem.contractVat = 0;
            newItem.contractTotal =
              newItem.contractAmount + newItem.contractVon;
            newItem.invoiceVat = 0;
            newItem.invoiceTotal = newItem.invoiceAmount;
            newItem.paymentTotalVat = 0;
            newItem.contractRemainingVat = 0;
            newItem.paymentInstallments = (
              item.paymentInstallments || []
            ).map((p) => ({
              ...p,
              amount: Math.round(
                (p.amountUsd || 0) * (p.exchangeRate || effectiveRate)
              ),
              vat: 0,
              totalVND: Math.round(
                (p.amountUsd || 0) * (p.exchangeRate || effectiveRate)
              ),
            }));
            return newItem;
          });
        }

        return rowsToDisplay;
      },
      availableReportProjects() {
        const search = (
          this.viewStates.reportDashboard.filter.projectSearch || ""
        ).toLowerCase();
        const projectIdsInUse = [
          ...new Set(this.contracts.map((c) => c.projectId)),
        ];
        const activeProjects = this.projects.filter((p) =>
          projectIdsInUse.includes(p.id)
        );

        if (!search) {
          return activeProjects.sort((a, b) =>
            a.name.localeCompare(b.name)
          );
        }

        return activeProjects
          .filter((p) => p.name.toLowerCase().includes(search))
          .sort((a, b) => a.name.localeCompare(b.name));
      },
      formattedAsOfDate() {
        if (!this.viewStates.reportDashboard.asOfDate) return "";
        const [year, month, day] =
          this.viewStates.reportDashboard.asOfDate.split("-");
        return `${day}/${month}/${year}`;
      },
      formattedReportMonth() {
        if (!this.viewStates.reportDashboard.reportMonth) return "";
        const [year, month] =
          this.viewStates.reportDashboard.reportMonth.split("-");
        return `${month}/${year}`;
      },
      reportData() {
        if (this.currentTab !== "cpc-report-dashboard" || this.viewStates.reportDashboard.filter.projectId.length === 0) {
          return [];
        }

        const emptyMetrics = () => ({
          paidToDate: { net: 0, vat: 0, total: 0 },
          remaining: { net: 0, vat: 0, total: 0 },
          paidInMonth: { net: 0, vat: 0, total: 0 },
        });

        const flatReport = [];
        if (this.reportCategoriesFromDB.length > 0) {
          const parentItems = this.reportCategoriesFromDB
            .filter((c) => c.level === 1)
            .sort((a, b) => a.code.localeCompare(b.code, undefined, { numeric: true }));

          parentItems.forEach((parent) => {
            flatReport.push({
              ...parent,
              name: this.language === "vi" ? parent.name_vi : parent.name_en,
              metrics: emptyMetrics(),
            });
            const children = this.reportCategoriesFromDB
              .filter((c) => c.parentCode === parent.code)
              .sort((a, b) => a.code.localeCompare(b.code, undefined, { numeric: true }));

            children.forEach((child) => {
              flatReport.push({
                ...child,
                name: this.language === "vi" ? child.name_vi : child.name_en,
                metrics: emptyMetrics(),
              });
            });
          });
        }

        const reportMap = new Map(flatReport.map((item) => [item.code, item]));
        const [reportYear, reportMonth] = this.viewStates.reportDashboard.reportMonth.split("-").map(Number);
        const asOfDate = this.viewStates.reportDashboard.asOfDate;
        const reportDate = new Date(asOfDate);
        reportDate.setHours(23, 59, 59, 999);

        const filteredContracts = this.contracts.filter((c) => {
          const projectFilter = this.viewStates.reportDashboard.filter.projectId;
          return projectFilter.length === 0 || projectFilter.includes(c.projectId);
        });

        // --- PHẦN 1: GIỮ NGUYÊN LOGIC GỐC CHO PAID TO DATE & REMAINING ---
        filteredContracts.forEach((contract) => {
          if (!contract.code) return;
          const reportItem = reportMap.get(String(contract.code));
          if (!reportItem) return;

          const cpcItemsForContract = this.cpcItemsByContractId.get(contract.id) || [];
          const cpcIdsForContract = cpcItemsForContract.map((c) => c.id);
          const allInstallmentsForContract = cpcIdsForContract.flatMap(
            (cpcId) => this.installmentsByCpcId.get(cpcId) || []
          );

          const relevantInstallmentsAsOfDate = allInstallmentsForContract.filter(
            (inst) => !inst.isSwap && inst.date && new Date(inst.date) <= reportDate
          );

          const paidAmountInclVAT_asOfDate = relevantInstallmentsAsOfDate.reduce(
            (sum, inst) => sum + (inst.amountVND || inst.amount || 0), 0
          );

          let paidAmountExclVAT_asOfDate = 0;
          if (contract.currency === "USD") {
            paidAmountExclVAT_asOfDate = paidAmountInclVAT_asOfDate;
          } else {
            cpcItemsForContract.forEach((cpc) => {
              const cpcInsts = relevantInstallmentsAsOfDate.filter((i) => i.cpcId === cpc.id);
              const totalPaidForCpc = cpcInsts.reduce((sum, i) => sum + i.amount, 0);
              if (cpc.amount > 0) {
                const ratio = totalPaidForCpc / cpc.amount;
                paidAmountExclVAT_asOfDate += (cpc.amountExclVAT || 0) * ratio;
              } else {
                paidAmountExclVAT_asOfDate += totalPaidForCpc;
              }
            });
          }
          const paidVatAmount_asOfDate = paidAmountInclVAT_asOfDate - paidAmountExclVAT_asOfDate;

          reportItem.metrics.paidToDate.net += paidAmountExclVAT_asOfDate;
          reportItem.metrics.paidToDate.vat += paidVatAmount_asOfDate;
          reportItem.metrics.paidToDate.total += paidAmountInclVAT_asOfDate;

          const detailsTable = this.cpcDetailRowsByContractId.get(contract.id) || [];
          let remainingNet = 0;
          let remainingVat = 0;

          if (contract.currency === "USD") {
            const totalContractValueUSD = detailsTable.reduce((sum, row) => sum + (row.contractAmount || 0) + (row.contractVon || 0), 0);
            const totalPaidUSD_asOfDate = relevantInstallmentsAsOfDate.reduce((sum, p) => sum + (p.amountUsd || 0), 0);
            const remainingUSD = Math.max(0, totalContractValueUSD - totalPaidUSD_asOfDate);
            const weightedAvgRate = totalPaidUSD_asOfDate > 0 ? (paidAmountInclVAT_asOfDate / totalPaidUSD_asOfDate) : 25400;
            remainingNet = Math.round(remainingUSD * weightedAvgRate);
          } else {
            const contractAmountTotal = detailsTable.reduce((sum, row) => sum + (row.contractAmount || 0) + (row.contractVon || 0), 0);
            const contractVatTotal = detailsTable.reduce((sum, row) => sum + (row.contractVat || 0), 0);
            remainingNet = contractAmountTotal - paidAmountExclVAT_asOfDate;
            remainingVat = contractVatTotal - paidVatAmount_asOfDate;
          }

          reportItem.metrics.remaining.net += remainingNet;
          reportItem.metrics.remaining.vat += remainingVat;
          reportItem.metrics.remaining.total += (remainingNet + remainingVat);
        });

        // --- PHẦN 2: LOGIC ĐÃ SỬA CHO PAID IN MONTH (QUÉT TRỰC TIẾP TỪ INSTALLMENTS) ---
        const projectFilter = this.viewStates.reportDashboard.filter.projectId;
        this.installments.forEach((inst) => {
          if (inst.isSwap || !inst.date) return;
          const pDate = new Date(inst.date);
          if (pDate.getFullYear() === reportYear && (pDate.getMonth() + 1) === reportMonth) {
            if (projectFilter.length > 0 && !projectFilter.includes(inst.projectId)) return;

            const contract = this.contractMap.get(inst.contractId);
            if (!contract || !contract.code) return;

            const reportItem = reportMap.get(String(contract.code));
            if (!reportItem) return;

            const paymentAmountVND = inst.amountVND || inst.amount || 0;
            let pNet = 0;
            if (contract.currency === "USD") {
              pNet = paymentAmountVND;
            } else {
              const parentCpc = this.cpcItems.find(c => c.id === inst.cpcId);
              pNet = (parentCpc && parentCpc.amount !== 0)
                ? Math.round((parentCpc.amountExclVAT || 0) * (paymentAmountVND / parentCpc.amount))
                : Math.round(paymentAmountVND / 1.08);
            }
            reportItem.metrics.paidInMonth.net += pNet;
            reportItem.metrics.paidInMonth.vat += (paymentAmountVND - pNet);
            reportItem.metrics.paidInMonth.total += paymentAmountVND;
          }
        });

        // Tính tổng từ con lên cha
        for (let i = flatReport.length - 1; i >= 0; i--) {
          const item = flatReport[i];
          if (item.level > 1) {
            const parentCode = String(item.code).split(".")[0];
            const parent = reportMap.get(parentCode);
            if (parent) {
              Object.keys(item.metrics).forEach((mK) => {
                Object.keys(item.metrics[mK]).forEach((vK) => {
                  parent.metrics[mK][vK] += item.metrics[mK][vK];
                });
              });
            }
          }
        }
        return flatReport;
      },
      reportGrandTotal() {
        const totals = {
          paidToDate: { net: 0, vat: 0, total: 0 },
          remaining: { net: 0, vat: 0, total: 0 },
          paidInMonth: { net: 0, vat: 0, total: 0 },
        };
        this.reportData.forEach((item) => {
          if (item.level === 1) {
            Object.keys(totals).forEach((metricKey) => {
              totals[metricKey].net += item.metrics[metricKey].net;
              totals[metricKey].vat += item.metrics[metricKey].vat;
              totals[metricKey].total += item.metrics[metricKey].total;
            });
          }
        });
        return totals;
      },
      detailsAvailableColumnGroups() {
        return [
          { key: "contract", label: this.t("columnGroupContract") },
          { key: "cpc", label: this.t("columnGroupCpc") },
          { key: "payment", label: this.t("columnGroupPayment") },
          { key: "invoice", label: this.t("columnGroupInvoice") },
          {
            key: "remainingPayable",
            label: this.t("columnGroupRemainingPayable"),
          },
          {
            key: "contractRemaining",
            label: this.t("columnGroupContractRemaining"),
          },
        ];
      },
      detailsAllSubColumns() {
        return [
          {
            key: "contractInfo",
            label: this.t("contractinfo"),
            group: "contract",
          },
          {
            key: "description",
            label: this.t("details"),
            group: "contract",
          },
          {
            key: "contractAmount",
            label: `${this.t("contract")} - ${this.t("amount")}`,
            group: "contract",
          },
          {
            key: "contractVon",
            label: `${this.t("contract")} - Von`,
            group: "contract",
          },
          {
            key: "contractVat",
            label: `${this.t("contract")} - Vat`,
            group: "contract",
          },
          {
            key: "contractTotal",
            label: `${this.t("contract")} - Total`,
            group: "contract",
          },

          { key: "cpcNo", label: "CPC No", group: "cpc" },
          { key: "cpcDueDate", label: "Due Date", group: "cpc" },
          { key: "cpcWorkDone", label: "Work-done", group: "cpc" },
          {
            key: "cpcPaymentOfWorkdone",
            label: "Payment of workdone",
            group: "cpc",
          },
          { key: "cpcAdvance", label: "Advance", group: "cpc" },
          { key: "cpcRepayment", label: "Repayment", group: "cpc" },
          { key: "cpcRetention", label: "Retention", group: "cpc" },
          {
            key: "cpcOtherDeduction",
            label: "Other deduction",
            group: "cpc",
          },
          {
            key: "cpcAmountDue",
            label: `${this.t("amount")} Due - ${this.t("net")}`,
            group: "cpc",
          },
          {
            key: "cpcVatAmountDue",
            label: `${this.t("amount")} Due - Vat`,
            group: "cpc",
          },

          {
            key: "paymentDate",
            label: `${this.t("tabPaymentDashboard")} - ${this.t("date")}`,
            group: "payment",
          },
          {
            key: "paymentAmount",
            label: `${this.t("tabPaymentDashboard")} - ${this.t("net")}`,
            group: "payment",
          },
          {
            key: "paymentVat",
            label: `${this.t("tabPaymentDashboard")} - Vat`,
            group: "payment",
          },
          {
            key: "paymentTotal",
            label: `${this.t("tabPaymentDashboard")} - Total`,
            group: "payment",
          },

          { key: "invoiceNo", label: `Invoice - No.`, group: "invoice" },
          {
            key: "invoiceDate",
            label: `Invoice - ${this.t("date")}`,
            group: "invoice",
          },
          {
            key: "invoiceAmount",
            label: `Invoice - ${this.t("net")}`,
            group: "invoice",
          },
          { key: "invoiceVat", label: `Invoice - Vat`, group: "invoice" },
          {
            key: "invoiceTotal",
            label: `Invoice - Total`,
            group: "invoice",
          },

          {
            key: "contractRemainingInclVat",
            label: `${this.t("columnGroupContractRemaining")} - Incl. Vat`,
            group: "contractRemaining",
          },
          {
            key: "contractRemainingExclVat",
            label: `${this.t("columnGroupContractRemaining")} - Excl. Vat`,
            group: "contractRemaining",
          },
          {
            key: "contractRemainingVat",
            label: `${this.t("columnGroupContractRemaining")} - Vat`,
            group: "contractRemaining",
          },
        ];
      },
      paymentSubRowColspan() {
        let count = 0;
        if (this.viewStates.cpcDetails.columnVisibility.contract)
          count += this.getGroupColspan("contract");
        if (this.viewStates.cpcDetails.columnVisibility.cpc)
          count += this.getGroupColspan("cpc");
        return count;
      },
      paymentSubRowColspanAfter() {
        let count = 0;
        if (this.viewStates.cpcDetails.columnVisibility.invoice)
          count += this.getGroupColspan("invoice");
        if (this.viewStates.cpcDetails.columnVisibility.remainingPayable)
          count += 1;
        if (this.viewStates.cpcDetails.columnVisibility.contractRemaining)
          count += this.getGroupColspan("contractRemaining");
        return count;
      },
      availableDetailProjects() {
        const projectIdsInUse = new Set(
          this.contracts.map((c) => c.projectId)
        );
        const activeProjects = this.projects.filter((p) =>
          projectIdsInUse.has(p.id)
        );

        const search = (
          this.viewStates.cpcDetails.filter.projectSearch || ""
        ).toLowerCase();

        if (!search) {
          return activeProjects.sort((a, b) =>
            a.name.localeCompare(b.name)
          );
        }
        return activeProjects
          .filter((p) => p.name.toLowerCase().includes(search))
          .sort((a, b) => a.name.localeCompare(b.name));
      },
      availableDetailVendors() {
        const projectIds = this.viewStates.cpcDetails.filter.projectId;
        if (projectIds.length === 0) return [];

        const relevantContracts = appUtils.filter.filterBySelectedIds(
          this.contracts,
          projectIds,
          "projectId"
        );

        return appUtils.filter.getAvailableItems({
          sourceData: this.vendors,
          linkingData: relevantContracts,
          linkKey: "vendorId",
          searchTerm: this.viewStates.cpcDetails.filter.vendorSearch,
          vueInstance: this,
        });
      },
      availableDetailContracts() {
        const projectIds = this.viewStates.cpcDetails.filter.projectId;
        const vendorIds = this.viewStates.cpcDetails.filter.vendorId;
        if (projectIds.length !== 1 || vendorIds.length !== 1) return [];

        return this.contracts
          .filter(
            (c) =>
              c.projectId === projectIds[0] && c.vendorId === vendorIds[0]
          )
          .sort((a, b) => a.contractNo.localeCompare(b.contractNo));
      },
      selectedContractDetails() {
        const selectedId =
          this.viewStates.cpcDetails.filter.selectedContractId;
        if (!selectedId) {
          return null;
        }

        const contract = this.contractMap.get(selectedId);
        if (!contract) {
          console.warn(
            `Contract with ID ${selectedId} not found in contractMap.`
          );
          return null;
        }

        const project = this.projectMap.get(contract.projectId);
        if (!project) {
          console.warn(
            `Project with ID ${contract.projectId} for Contract ${contract.contractNo} not found.`
          );
          return null;
        }

        const vendor = this.vendorMap.get(contract.vendorId);
        if (!vendor) {
          console.warn(
            `Vendor with ID ${contract.vendorId} for Contract ${contract.contractNo} not found.`
          );
          return null;
        }

        return {
          ...contract,
          projectName: project.name,
          vendorName: vendor.name,
          vendorNameAbbr: vendor.abbrName || vendor.name,
          vendorNo: vendor.vendorNo || "",
          status: contract.status || "Active",
          statusNote: contract.statusNote || "",
        };
      },
      totalDetails() {
        const _version = this.dataVersion;
        const activeTable = this.displayedContractDetailTable || [];
        const numericFields = [
          "contractAmount",
          "contractVon",
          "contractVat",
          "contractTotal",
          "cpcWorkDone",
          "cpcPaymentOfWorkdone",
          "cpcAdvance",
          "cpcRepayment",
          "cpcRetention",
          "cpcOtherDeduction",
          "cpcAmountDue",
          "cpcVat",
          "paymentTotalAmount",
          "paymentTotalVat",
          "paymentGrandTotal",
          "invoiceAmount",
          "invoiceVat",
          "invoiceTotal",
          "remainingPayable",
          "contractRemainingInclVat",
          "contractRemainingExclVat",
          "contractRemainingVat",
        ];

        const totals = {};
        numericFields.forEach((field) => {
          totals[field] = activeTable.reduce(
            (sum, item) => sum + (Number(item[field]) || 0),
            0
          );
        });

        totals.paymentAmount = totals.paymentTotalAmount;
        totals.paymentVat = totals.paymentTotalVat;
        totals.paymentTotal = totals.paymentGrandTotal;

        return totals;
      },
      detailsCalculatedFooter() {
        const totals = this.totalDetails;
        if (!totals) {
          return {
            amountDueFormatted: " - ",
            advanceBalanceFormatted: " - ",
            workDoneBalanceFormatted: " - ",
            finalRemainingPayableFormatted: " - ",
          };
        }

        const contractId =
          this.viewStates.cpcDetails.filter.selectedContractId;
        if (!contractId) {
          return {
            amountDueFormatted: " - ",
            advanceBalanceFormatted: " - ",
            workDoneBalanceFormatted: " - ",
            finalRemainingPayableFormatted: " - ",
          };
        }

        const balance = this.calculateContractBalanceAsOf(
          contractId,
          new Date().toISOString().slice(0, 10)
        );

        const amountDueBalance =
          (totals.cpcAmountDue || 0) +
          (totals.cpcVat || 0) -
          (totals.paymentGrandTotal || 0);
        const workDoneBalance =
          (totals.contractAmount || 0) +
          (totals.contractVon || 0) -
          (totals.cpcWorkDone || 0);

        return {
          amountDueFormatted: this.formatDetailsCurrency(amountDueBalance),
          advanceBalanceFormatted: this.formatDetailsCurrency(
            balance.advanceBalance
          ),
          workDoneBalanceFormatted:
            this.formatDetailsCurrency(workDoneBalance),
          finalRemainingPayableFormatted: this.formatDetailsCurrency(
            balance.finalPayable
          ),
        };
      },
      hasOverdueBonds() {
        return this.expiringBonds.some((bond) => bond.status === "Overdue");
      },
      bondAlertsMap() {
        const alerts = new Map();
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        // Chỉ lọc các bảo lãnh chưa tất toán
        this.bonds.forEach(bond => {
          if (bond.isSettled || !bond.expiryDate) return;

          const expiryDate = new Date(bond.expiryDate);
          expiryDate.setHours(0, 0, 0, 0);
          const diffDays = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));

          let currentAlert = alerts.get(bond.contractId) || { overdue: 0, expiring: 0 };

          if (diffDays < 0) currentAlert.overdue++;
          else if (diffDays <= 30) currentAlert.expiring++;

          alerts.set(bond.contractId, currentAlert);
        });
        return alerts;
      },
      processedCpcData() {
        const t0 = performance.now(); // Debug hiệu năng nếu cần

        // Chuẩn bị các Map dữ liệu để truy xuất O(1)
        const contractMap = this.contractMap;
        const projectMap = this.projectMap;
        const vendorMap = this.vendorMap;
        const installmentsMap = this.installmentsByCpcId;
        const bondAlerts = this.bondAlertsMap;

        const result = this.cpcItems.map(item => {
          // Lấy nhanh các thông tin liên quan qua Map
          const itemInstallments = installmentsMap.get(item.id) || [];
          const contract = contractMap.get(item.contractId) || {};
          const project = projectMap.get(item.projectId) || {};
          const vendor = vendorMap.get(item.vendorId) || {};

          // Tính tổng tiền đã trả
          const totalAmountPaid = itemInstallments.reduce((sum, inst) => sum + (inst.amount || 0), 0);

          // Xác định ngày thanh toán gần nhất
          let latestDate = "N/A";
          if (itemInstallments.length > 0) {
            let maxTime = 0;
            itemInstallments.forEach(inst => {
              const d = inst.date ? new Date(inst.date).getTime() : 0;
              if (d > maxTime) maxTime = d;
              // Check thêm ngày trong swap nếu có
              if (inst.isSwap && inst.swapPayments) {
                inst.swapPayments.forEach(sp => {
                  const sd = sp.date ? new Date(sp.date).getTime() : 0;
                  if (sd > maxTime) maxTime = sd;
                });
              }
            });
            if (maxTime > 0) latestDate = appUtils.format.date(new Date(maxTime));
          }

          // Lấy cảnh báo bảo lãnh từ Map đã tính sẵn
          let bondAlert = null;
          const alertStatus = bondAlerts.get(item.contractId);
          if (alertStatus) {
            if (alertStatus.overdue > 0) {
              bondAlert = {
                level: "danger",
                class: "bond-alert-danger",
                message: `CẢNH BÁO: ${alertStatus.overdue} bảo lãnh QUÁ HẠN!`
              };
            } else if (alertStatus.expiring > 0) {
              bondAlert = {
                level: "warning",
                class: "bond-alert-warning",
                message: `${alertStatus.expiring} bảo lãnh sắp hết hạn (<=30 ngày)`
              };
            }
          }

          return {
            ...item,
            projectName: project.name || "N/A",
            vendorName: vendor.name || "N/A",
            vendorNameAbbr: vendor.abbrName || vendor.name || "N/A",
            contractNo: contract.contractNo || "N/A",
            isUsd: contract.currency === "USD",
            installments: itemInstallments,
            totalAmountPaid,
            latestPaymentDate: latestDate,
            statusInfo: this.getStatusInfo(item, itemInstallments, totalAmountPaid),
            bondAlert
          };
        });

        const t1 = performance.now();
        console.log(`[Performance] Processed ${result.length} CPCs in ${Math.round(t1 - t0)}ms`);
        return result;
      },
      availableCpcProjects() {
        return appUtils.filter.getAvailableItems({
          sourceData: this.projects,
          linkingData: this.processedCpcData,
          linkKey: "projectId",
          searchTerm: this.viewStates.cpcTracking.filter.projectSearch,
          vueInstance: this,
        });
      },
      availableCpcVendors() {
        const relevantData = appUtils.filter.filterBySelectedIds(
          this.processedCpcData,
          this.viewStates.cpcTracking.filter.projectId,
          "projectId"
        );

        return appUtils.filter.getAvailableItems({
          sourceData: this.vendors,
          linkingData: relevantData,
          linkKey: "vendorId",
          searchTerm: this.viewStates.cpcTracking.filter.vendorSearch,
          vueInstance: this,
        });
      },
      availableCpcContracts() {
        let relevantData = this.processedCpcData;
        relevantData = appUtils.filter.filterBySelectedIds(
          relevantData,
          this.viewStates.cpcTracking.filter.projectId,
          "projectId"
        );
        relevantData = appUtils.filter.filterBySelectedIds(
          relevantData,
          this.viewStates.cpcTracking.filter.vendorId,
          "vendorId"
        );

        const contractIdsInUse = new Set(
          relevantData.map((item) => item.contractId).filter(Boolean)
        );
        const allContractObjects = this.contracts.filter((c) =>
          contractIdsInUse.has(c.id)
        );

        const search = (
          this.viewStates.cpcTracking.filter.contractNoSearch || ""
        ).toLowerCase();

        if (!search) {
          return allContractObjects.sort((a, b) =>
            a.contractNo.localeCompare(b.contractNo)
          );
        }

        return allContractObjects
          .filter((c) => c.contractNo.toLowerCase().includes(search))
          .sort((a, b) => a.contractNo.localeCompare(b.contractNo));
      },
      filteredCpcData() {
        const state = this.viewStates.cpcTracking;
        let data = this.processedCpcData; // Không dùng spread [...] ở đây để tiết kiệm bộ nhớ

        // 1. Lọc theo ID (Nhanh nhất)
        if (state.filter.projectId.length > 0) {
          data = data.filter(item => state.filter.projectId.includes(item.projectId));
        }
        if (state.filter.vendorId.length > 0) {
          data = data.filter(item => state.filter.vendorId.includes(item.vendorId));
        }
        if (state.filter.contractId.length > 0) {
          data = data.filter(item => state.filter.contractId.includes(item.contractId));
        }

        // 2. Lọc theo Status
        if (state.filter.status.length > 0) {
          const targetStatuses = state.filter.status.map(s => s.toLowerCase().replace(/ /g, ""));
          data = data.filter(item => targetStatuses.includes(item.statusInfo.statusKey));
        }

        // 3. Lọc theo từ khóa (Search) - Tối ưu hóa chuỗi
        if (state.searchTerm) {
          const term = appUtils.text.normalizeVietnamese(state.searchTerm);
          data = data.filter(item => {
            // Chỉ tìm trên các trường định danh chính để tăng tốc
            return (item.cpcIdentifier && item.cpcIdentifier.toLowerCase().includes(term)) ||
              (item.contractNo && item.contractNo.toLowerCase().includes(term)) ||
              (item.vendorNameAbbr && item.vendorNameAbbr.toLowerCase().includes(term)) ||
              (item.contents && appUtils.text.normalizeVietnamese(item.contents).includes(term)) ||
              (item.lineTracking && appUtils.text.normalizeVietnamese(item.lineTracking).includes(term));
          });
        }

        // 4. Sắp xếp (Sorting)
        if (state.sortBy) {
          const dir = state.sortDirection === 'asc' ? 1 : -1;
          const key = state.sortBy;

          data.sort((a, b) => {
            let valA = a[key];
            let valB = b[key];

            if (valA === valB) return 0;
            if (valA == null) return 1;
            if (valB == null) return -1;

            if (typeof valA === 'string') {
              return dir * valA.localeCompare(valB);
            }
            return dir * (valA - valB);
          });
        }

        return data;
      },
      paginatedCpcData() {
        const state = this.viewStates.cpcTracking;
        const start = (state.currentPage - 1) * state.perPage;
        return this.filteredCpcData.slice(start, start + state.perPage);
      },
      formattedPaginatedCpcData() {
        return this.paginatedCpcData.map((item) => ({
          ...item,
          amountFormatted: appUtils.format.currency(item.amount),
          amountUsdFormatted: this.formatCurrencyUSD(item.amountUsd),
          totalAmountPaidFormatted: appUtils.format.currency(
            item.totalAmountPaid
          ),
          installmentsFormatted: (item.installments || []).map((inst) => ({
            ...inst,
            amountFormatted: appUtils.format.currency(inst.amount),
          })),
        }));
      },
      totalPages() {
        const state = this.viewStates.cpcTracking;
        return Math.ceil(this.filteredCpcData.length / state.perPage);
      },
      totalAmountCpcTracking() {
        const total = this.paginatedCpcData.reduce(
          (sum, item) => sum + (item.amount || 0),
          0
        );
        return appUtils.format.currency(total);
      },
      totalAmountPaidCpcTracking() {
        const total = this.paginatedCpcData.reduce(
          (sum, item) => sum + (item.totalAmountPaid || 0),
          0
        );
        return appUtils.format.currency(total);
      },
      allPaymentsDashboard() {
        return this.installments.flatMap((inst) => {
          const cpc = this.processedCpcDataMap.get(inst.cpcId) || {};
          const vendor = this.vendorMap.get(inst.vendorId) || {};

          const baseData = {
            ...cpc,
            vendorNameAbbr: vendor.abbrName || cpc.vendorName,
            originalAmount: cpc.amount,
            originalInstallmentId: inst.id,
            contractNo: cpc.contractNo,
          };

          if (!inst.isSwap) {
            return [
              {
                ...baseData,
                ...inst,
                isSwapRow: false,
              },
            ];
          }

          if (
            inst.isSwap &&
            inst.swapPayments &&
            inst.swapPayments.length > 0
          ) {
            return inst.swapPayments.map((subPay, idx) => ({
              ...baseData,
              id: `${inst.id}_swap_sub_${idx}`,

              amount: subPay.amount,
              amountFormatted: appUtils.format.currency(subPay.amount),
              date: subPay.date,
              paymentSource: subPay.source || "SWAP Offset",

              contents: `(SWAP - ${inst.vendorSWAP || "N/A"}) ${cpc.contents || ""
                }`,

              isSwapRow: true,

              _parentInstallment: inst,
              _subPaymentIndex: idx,
            }));
          }

          return [];
        });
      },
      paymentsFilteredByDate() {
        const filter = this.viewStates.paymentDashboard.filter;
        if (!filter.startDate || !filter.endDate)
          return this.allPaymentsDashboard;
        const start = new Date(filter.startDate);
        start.setHours(0, 0, 0, 0);
        const end = new Date(filter.endDate);
        end.setHours(23, 59, 59, 999);
        return this.allPaymentsDashboard.filter((p) => {
          if (!p.date) return false;
          const paymentDate = new Date(p.date);
          return (
            !isNaN(paymentDate.getTime()) &&
            paymentDate >= start &&
            paymentDate <= end
          );
        });
      },
      availableProjects() {
        return appUtils.filter.getAvailableItems({
          sourceData: this.projects,
          linkingData: this.paymentsFilteredByDate,
          linkKey: "projectId",
          searchTerm: this.viewStates.paymentDashboard.filter.projectSearch,
          vueInstance: this,
        });
      },
      paymentsFilteredByProject() {
        const filter = this.viewStates.paymentDashboard.filter;
        if (filter.projectId.length === 0)
          return this.paymentsFilteredByDate;
        return this.paymentsFilteredByDate.filter((p) =>
          filter.projectId.includes(p.projectId)
        );
      },
      availableVendors() {
        return appUtils.filter.getAvailableItems({
          sourceData: this.vendors,
          linkingData: this.paymentsFilteredByProject,
          linkKey: "vendorId",
          searchTerm: this.viewStates.paymentDashboard.filter.vendorSearch,
          vueInstance: this,
        });
      },
      paymentsFilteredByVendor() {
        const filter = this.viewStates.paymentDashboard.filter;
        if (filter.vendorId.length === 0)
          return this.paymentsFilteredByProject;
        return this.paymentsFilteredByProject.filter((p) =>
          filter.vendorId.includes(p.vendorId)
        );
      },
      availableCodes() {
        const filter = this.viewStates.paymentDashboard.filter;
        const data = this.paymentsFilteredByVendor;
        if (!filter.codeSearch)
          return [
            ...new Set(data.map((item) => item.code).filter(Boolean)),
          ].sort();
        return [
          ...new Set(
            data
              .map((c) => c.code)
              .filter(
                (c) =>
                  c &&
                  c.toLowerCase().includes(filter.codeSearch.toLowerCase())
              )
          ),
        ].sort();
      },
      paymentsFilteredByCode() {
        const filter = this.viewStates.paymentDashboard.filter;
        if (filter.code.length === 0) return this.paymentsFilteredByVendor;
        return this.paymentsFilteredByVendor.filter((p) =>
          filter.code.includes(p.code)
        );
      },
      availablePaymentSources() {
        const filter = this.viewStates.paymentDashboard.filter;
        const data = this.paymentsFilteredByCode;
        const sources = [
          ...new Set(
            data.map((item) => item.paymentSource).filter(Boolean)
          ),
        ].sort();
        if (!filter.paymentSourceSearch) return sources;
        return sources.filter((s) =>
          s.toLowerCase().includes(filter.paymentSourceSearch.toLowerCase())
        );
      },
      filteredPaymentsDashboard() {
        const state = this.viewStates.paymentDashboard;
        let payments = [...this.paymentsFilteredByCode];
        if (state.filter.paymentSource.length > 0)
          payments = payments.filter((p) =>
            state.filter.paymentSource.includes(p.paymentSource)
          );
        if (state.sortBy)
          payments.sort((a, b) => {
            let valA = a[state.sortBy],
              valB = b[state.sortBy];
            if (valA == null) return 1;
            if (valB == null) return -1;
            if (["amount", "originalAmount"].includes(state.sortBy)) {
              valA = parseFloat(valA);
              valB = parseFloat(valB);
            } else if (["date", "paymentDueDate"].includes(state.sortBy)) {
              valA = new Date(valA);
              valB = new Date(valB);
              if (isNaN(valA)) return 1;
              if (isNaN(valB)) return -1;
            } else if (typeof valA === "string") {
              valA = valA.toLowerCase();
              valB = valB.toLowerCase();
            }
            if (valA < valB) return state.sortDirection === "asc" ? -1 : 1;
            if (valA > valB) return state.sortDirection === "asc" ? 1 : -1;
            return 0;
          });
        return payments;
      },
      paginatedFilteredPaymentsDashboard() {
        const state = this.viewStates.paymentDashboard;
        const start = (state.currentPage - 1) * state.perPage;
        return this.filteredPaymentsDashboard.slice(
          start,
          start + state.perPage
        );
      },
      formattedPaginatedPaymentsDashboard() {
        return this.paginatedFilteredPaymentsDashboard.map((p) => ({
          ...p,
          amountFormatted: appUtils.format.currency(p.amount),
          originalAmountFormatted: appUtils.format.currency(
            p.originalAmount
          ),
        }));
      },
      dashboardTotalPages() {
        const state = this.viewStates.paymentDashboard;
        return Math.ceil(
          this.filteredPaymentsDashboard.length / state.perPage
        );
      },
      totalAmountPaidDashboard() {
        return this.filteredPaymentsDashboard.reduce(
          (sum, payment) => sum + (payment.amount || 0),
          0
        );
      },

      allSwapsDashboard() {
        const swaps = this.installments
          .filter((i) => i.isSwap)
          .map((inst) => {
            const cpc = this.processedCpcDataMap.get(inst.cpcId) || {};

            const totalSwapPaidAmount = (inst.swapPayments || []).reduce(
              (sum, p) => sum + p.amount,
              0
            );
            const swapDates = (inst.swapPayments || [])
              .map((p) => new Date(p.date))
              .filter((d) => !isNaN(d));
            const latestSwapPaymentDate =
              swapDates.length > 0
                ? appUtils.format.date(new Date(Math.max(...swapDates)))
                : "";

            const isReceivableSwap = cpc.amount < 0;

            return {
              ...cpc,
              ...inst,
              amount: Math.abs(inst.amount),
              totalSwapPaidAmount,
              latestSwapPaymentDate,
              isExpanded: inst.isExpanded || false,
              transactionType: isReceivableSwap ? "receivable" : "payable",
            };
          });
        return swaps;
      },

      availableSwapProjects() {
        return appUtils.filter.getAvailableItems({
          sourceData: this.projects,
          linkingData: this.allSwapsDashboard,
          linkKey: "projectId",
          searchTerm: this.viewStates.swapDashboard.filter.projectSearch,
          vueInstance: this,
        });
      },
      swapsFilteredByProject() {
        return appUtils.filter.filterBySelectedIds(
          this.allSwapsDashboard,
          this.viewStates.swapDashboard.filter.projectId,
          "projectId"
        );
      },
      availableSwapVendors() {
        return appUtils.filter.getAvailableItems({
          sourceData: this.vendors,
          linkingData: this.swapsFilteredByProject,
          linkKey: "vendorId",
          searchTerm: this.viewStates.swapDashboard.filter.vendorSearch,
          vueInstance: this,
        });
      },
      swapsFilteredByVendor() {
        return appUtils.filter.filterBySelectedIds(
          this.swapsFilteredByProject,
          this.viewStates.swapDashboard.filter.vendorId,
          "vendorId"
        );
      },
      availableSwapVendorSWAPs() {
        return [
          ...new Set(
            this.swapsFilteredByVendor
              .map((item) => item.vendorSWAP)
              .filter(Boolean)
          ),
        ].sort();
      },

      filteredSwapsDashboard() {
        const state = this.viewStates.swapDashboard;
        let data = [...this.allSwapsDashboard];

        if (state.filter.projectId.length > 0) {
          data = data.filter((s) =>
            state.filter.projectId.includes(s.projectId)
          );
        }

        if (state.filter.vendorSWAP.length > 0) {
          data = data.filter((s) =>
            state.filter.vendorSWAP.includes(s.vendorSWAP)
          );
        }

        if (state.filter.startDate || state.filter.endDate) {
          const start = state.filter.startDate
            ? new Date(state.filter.startDate)
            : null;
          const end = state.filter.endDate
            ? new Date(state.filter.endDate)
            : null;
          if (start) start.setHours(0, 0, 0, 0);
          if (end) end.setHours(23, 59, 59, 999);

          data = data.filter((item) => {
            const itemDate = item.date ? new Date(item.date) : null;
            if (!itemDate) return false;
            return (
              (!start || itemDate >= start) && (!end || itemDate <= end)
            );
          });
        }

        if (state.sortBy) {
          data.sort((a, b) => {
            let valA = a[state.sortBy],
              valB = b[state.sortBy];
            if (state.sortDirection === "asc") return valA > valB ? 1 : -1;
            return valA < valB ? 1 : -1;
          });
        }

        return data;
      },

      paginatedSwapsDashboard() {
        const state = this.viewStates.swapDashboard;
        const start = (state.currentPage - 1) * state.perPage;
        return this.filteredSwapsDashboard.slice(
          start,
          start + state.perPage
        );
      },
      formattedPaginatedSwapsDashboard() {
        return this.paginatedSwapsDashboard.map((s) => ({
          ...s,
          amountFormatted: this.formatCurrency(s.amount),
          totalSwapPaidAmountFormatted: this.formatCurrency(
            s.totalSwapPaidAmount
          ),
        }));
      },
      swapDashboardTotalPages() {
        const state = this.viewStates.swapDashboard;
        return Math.ceil(
          this.filteredSwapsDashboard.length / state.perPage
        );
      },
      swapDashboardAvailableColumns() {
        return [
          { key: "projectName", label: this.t("project") },
          { key: "vendorName", label: this.t("vendor") },
          { key: "cpcIdentifier", label: this.t("cpc") },
          { key: "contractNo", label: this.t("contract") },
          { key: "vendorSWAP", label: this.t("vendorSWAP") },
          { key: "swapAgreement", label: this.t("swapAgreement") },
          { key: "swapProduct", label: this.t("swapProduct") },
          { key: "date", label: this.t("agreementDate") },
          { key: "amount", label: this.t("amount") },
          { key: "totalSwapPaidAmount", label: this.t("swapAmountPaid") },
          {
            key: "latestSwapPaymentDate",
            label: this.t("swapPaymentDate"),
          },
          { key: "status", label: this.t("status") },
        ];
      },
      visibleSwapDashboardColumns() {
        return this.swapDashboardAvailableColumns.filter(
          (col) => this.swapDashboardColumnVisibility[col.key]
        );
      },

      allBondsDashboard() {
        return this.bonds.map((bond) => {
          const project = this.projectMap.get(bond.projectId) || {};
          const vendor = this.vendorMap.get(bond.vendorId) || {};
          const contract = this.contractMap.get(bond.contractId) || {};

          return {
            ...bond,
            projectName: project.name || "N/A",
            vendorName: vendor.name || "N/A",
            vendorNameAbbr: vendor.abbrName || vendor.name || "N/A",
            contractNo: contract.contractNo || "N/A",
            issuingBankName: bond.issuingBank,
            amountFormatted: appUtils.format.currency(bond.amount),
          };
        });
      },

      availableBondProjects() {
        return appUtils.filter.getAvailableItems({
          sourceData: this.projects,
          linkingData: this.allBondsDashboard,
          linkKey: "projectId",
          searchTerm: "",
          vueInstance: this,
        });
      },
      filteredAvailableBondProjects() {
        const searchTerm =
          this.viewStates.bondDashboard.filter.projectSearch;
        if (!searchTerm) return this.availableBondProjects;
        return this.availableBondProjects.filter((p) =>
          appUtils.text
            .normalizeVietnamese(p.name)
            .includes(appUtils.text.normalizeVietnamese(searchTerm))
        );
      },
      bondsFilteredByProject() {
        const filter = this.viewStates.bondDashboard.filter;
        if (filter.projectId.length === 0) return this.allBondsDashboard;
        return this.allBondsDashboard.filter((b) =>
          filter.projectId.includes(b.projectId)
        );
      },
      availableBondVendors() {
        return appUtils.filter.getAvailableItems({
          sourceData: this.vendors,
          linkingData: this.bondsFilteredByProject,
          linkKey: "vendorId",
          searchTerm: "",
          vueInstance: this,
        });
      },
      filteredAvailableBondVendors() {
        const searchTerm =
          this.viewStates.bondDashboard.filter.vendorSearch;
        if (!searchTerm) return this.availableBondVendors;
        return this.availableBondVendors.filter((v) =>
          appUtils.text
            .normalizeVietnamese(v.name)
            .includes(appUtils.text.normalizeVietnamese(searchTerm))
        );
      },

      bondsFilteredByVendor() {
        const filter = this.viewStates.bondDashboard.filter;
        if (filter.vendorId.length === 0)
          return this.bondsFilteredByProject;
        return this.bondsFilteredByProject.filter((b) =>
          filter.vendorId.includes(b.vendorId)
        );
      },
      availableBondContracts() {
        const contractIds = new Set(
          this.bondsFilteredByVendor.map((b) => b.contractId)
        );
        return this.contracts
          .filter((c) => contractIds.has(c.id))
          .sort((a, b) => a.contractNo.localeCompare(b.contractNo));
      },

      filteredAvailableBondContracts() {
        const searchTerm =
          this.viewStates.bondDashboard.filter.contractNoSearch;
        if (!searchTerm) return this.availableBondContracts;
        return this.availableBondContracts.filter((c) =>
          c.contractNo.toLowerCase().includes(searchTerm.toLowerCase())
        );
      },
      bondsFilteredByContract() {
        const filter = this.viewStates.bondDashboard.filter;
        if (filter.contractId.length === 0)
          return this.bondsFilteredByVendor;
        return this.bondsFilteredByVendor.filter((b) =>
          filter.contractId.includes(b.contractId)
        );
      },
      availableBondTypes() {
        return [
          ...new Set(
            this.bondsFilteredByContract
              .map((item) => item.bondType)
              .filter(Boolean)
          ),
        ].sort();
      },
      filteredAvailableBondTypes() {
        const filter = this.viewStates.bondDashboard.filter;
        if (!filter.typeSearch) return this.availableBondTypes;
        return this.availableBondTypes.filter((t) =>
          t.toLowerCase().includes(filter.typeSearch.toLowerCase())
        );
      },
      filteredBondsDashboard() {
        const state = this.viewStates.bondDashboard;
        let bonds = [...this.bondsFilteredByContract];

        if (state.filter.bondType.length > 0) {
          bonds = bonds.filter((b) =>
            state.filter.bondType.includes(b.bondType)
          );
        }

        if (state.filter.status.length > 0) {
          bonds = bonds.filter((bond) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const expiryDate = new Date(bond.expiryDate);
            expiryDate.setHours(0, 0, 0, 0);
            const diffDays = Math.ceil((expiryDate - today) / 864e5);

            let currentStatus = "Active";
            if (bond.isSettled) {
              currentStatus = "Settled";
            } else if (diffDays < 0) {
              currentStatus = "Overdue";
            } else if (diffDays <= 30) {
              currentStatus = "Expiring Soon";
            }

            return state.filter.status.includes(currentStatus);
          });
        }

        if (state.sortBy)
          bonds.sort((a, b) => {
            let valA = a[state.sortBy],
              valB = b[state.sortBy];
            if (valA == null) return 1;
            if (valB == null) return -1;
            if (state.sortBy === "amount") {
              valA = parseFloat(valA);
              valB = parseFloat(valB);
            } else if (["issueDate", "expiryDate"].includes(state.sortBy)) {
              valA = new Date(valA);
              valB = new Date(valB);
              if (isNaN(valA)) return 1;
              if (isNaN(valB)) return -1;
            } else if (typeof valA === "string") {
              valA = valA.toLowerCase();
              valB = valB.toLowerCase();
            }
            if (valA < valB) return state.sortDirection === "asc" ? -1 : 1;
            if (valA > valB) return state.sortDirection === "asc" ? 1 : -1;
            return 0;
          });
        return bonds;
      },
      paginatedFilteredBondsDashboard() {
        const state = this.viewStates.bondDashboard;
        const start = (state.currentPage - 1) * state.perPage;
        return this.filteredBondsDashboard.slice(
          start,
          start + state.perPage
        );
      },
      formattedPaginatedBondsDashboard() {
        return this.paginatedFilteredBondsDashboard.map((bond) => ({
          ...bond,
          amountFormatted: appUtils.format.currency(bond.amount),
        }));
      },
      bondDashboardTotalPages() {
        const state = this.viewStates.bondDashboard;
        return Math.ceil(
          this.filteredBondsDashboard.length / state.perPage
        );
      },

      expiringBonds() {
        const notifications = [];
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const latestExpiringBondPerType = new Map();

        this.bonds
          .filter((bond) => !bond.isSettled)
          .forEach((bond) => {
            const contract =
              this.contracts.find((c) => c.id === bond.contractId) || {};
            if (!contract.id) return;

            const compositeKey = `${contract.contractNo}_${bond.bondType}`;
            const currentLatest =
              latestExpiringBondPerType.get(compositeKey);
            const bondExpiry = new Date(bond.expiryDate);
            if (isNaN(bondExpiry.getTime())) return;

            if (
              !currentLatest ||
              bondExpiry > new Date(currentLatest.expiryDate)
            ) {
              const bank =
                this.banks.find((b) => b.id === bond.bankId) || {};
              const vendor =
                this.vendors.find((v) => v.id === contract.vendorId) || {};

              latestExpiringBondPerType.set(compositeKey, {
                ...bond,
                contractId: contract.id,
                projectId: contract.projectId,
                vendorId: contract.vendorId,
                contractNo: contract.contractNo,
                issuingBankName: bank.name,
              });
            }
          });

        latestExpiringBondPerType.forEach((bond) => {
          const expiryDate = new Date(bond.expiryDate);
          const diffTime = expiryDate.getTime() - today.getTime();
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          let message = "",
            status = "";

          if (diffDays < 0) {
            message = this.t("bond_status_overdue", { days: -diffDays });
            status = "Overdue";
          } else if (diffDays <= 30) {
            message = this.t("bond_status_expiring", { days: diffDays });
            status = "Expiring Soon";
          }

          if (message) {
            notifications.push({ ...bond, message, status });
          }
        });

        return notifications.sort(
          (a, b) => new Date(a.expiryDate) - new Date(b.expiryDate)
        );
      },
      visibleColumns() {
        return this.availableColumns.filter(
          (col) => this.columnVisibility[col.key]
        );
      },
      availableColumns() {
        return [
          { key: "projectName", label: this.t("project") },
          { key: "cpcIdentifier", label: this.t("cpc") },
          { key: "contractNo", label: this.t("contract") },
          { key: "contents", label: this.t("contents") },
          { key: "code", label: this.t("code") },
          { key: "vendorName", label: this.t("vendor") },
          { key: "amount", label: this.t("amountInclVAT") },
          { key: "receivedDate", label: this.t("receivedDate") },
          { key: "paymentDueDate", label: this.t("paymentDueDate") },
          { key: "totalAmountPaid", label: this.t("amountPaid") },
          { key: "latestPaymentDate", label: this.t("paymentDate") },
          { key: "moreInfo", label: "More Info", noSort: true },
          { key: "status", label: "Status" },
          { key: "lineTracking", label: this.t("lineTracking") },
          { key: "notes", label: this.t("notes") },
        ];
      },
      dashboardPaymentAvailableColumns() {
        return [
          { key: "projectName", label: this.t("project") },
          { key: "cpcIdentifier", label: this.t("cpc") },
          { key: "contractNo", label: this.t("contract") },
          { key: "contents", label: this.t("contents") },
          { key: "code", label: this.t("code") },
          { key: "vendorName", label: this.t("vendor") },
          { key: "originalAmount", label: this.t("amountInclVAT") },
          { key: "paymentDueDate", label: this.t("paymentDueDate") },
          { key: "amount", label: this.t("amountPaid") },
          { key: "date", label: this.t("paymentDate") },
          { key: "paymentSource", label: this.t("paymentSource") },
        ];
      },
      visiblePaymentDashboardColumns() {
        return this.dashboardPaymentAvailableColumns.filter(
          (col) => this.dashboardPaymentColumnVisibility[col.key]
        );
      },
      dashboardBondAvailableColumns() {
        return [
          { key: "projectName", label: this.t("project") },
          { key: "contractNo", label: this.t("contract") },
          { key: "vendorName", label: this.t("vendor") },
          { key: "bondNumber", label: this.t("bondNumber") },
          { key: "ref", label: this.t("ref") },
          { key: "bondType", label: this.t("bondType") },
          { key: "amount", label: this.t("amount") },
          { key: "issueDate", label: this.t("issueDate") },
          { key: "expiryDate", label: this.t("expiryDate") },
          { key: "issuingBankName", label: this.t("issuingBank") },
          { key: "quickSettle", label: "Quick Settle", noSort: true },
          { key: "status", label: "Status" },
        ];
      },
      contractDashboardAvailableColumns() {
        return [
          { key: "projectName", label: this.t("project") },
          { key: "glAccount", label: this.t("glaccount") },
          { key: "code", label: this.t("code") },
          { key: "department", label: this.t("department") },
          { key: "contractSystemNo", label: this.t("contractSystemNo") },
          { key: "vendorNo", label: this.t("vendorNo") },
          { key: "vendorName", label: this.t("vendor") },
          { key: "contractNo", label: this.t("contract") },
          { key: "currency", label: this.t("currency") },
          { key: "date", label: this.t("date") },
          { key: "description", label: this.t("details") },
          {
            key: "contractAmountTotal",
            label: this.t("contractAmountTotal"),
          },
          { key: "vonTotal", label: this.t("vonTotal") },
          { key: "contractVatTotal", label: this.t("contractVatTotal") },
          {
            key: "contractGrandTotal",
            label: this.t("contractGrandTotal"),
          },

          { key: "paidAmountExclVAT", label: this.t("paidAmountExclVAT") },
          { key: "paidVatAmount", label: this.t("paidVatAmount") },
          { key: "paidAmountInclVAT", label: this.t("paidAmountInclVAT") },
          {
            key: "invoiceAmountTotal",
            label: this.t("invoiceAmountTotal"),
          },
          { key: "invoiceVatTotal", label: this.t("invoiceVatTotal") },
          { key: "invoiceGrandTotal", label: this.t("invoiceGrandTotal") },
        ];
      },
      contractDashboardData() {
        const filters = this.viewStates.contractDashboard.filter;

        const hasActiveFilters =
          filters.projectId.length > 0 ||
          filters.vendorId.length > 0 ||
          filters.contractId.length > 0 ||
          filters.code.length > 0;

        if (!hasActiveFilters) {
          return [];
        }

        let filteredContracts = this.contracts;

        if (filters.projectId.length > 0) {
          filteredContracts = filteredContracts.filter((item) =>
            filters.projectId.includes(item.projectId)
          );
        }
        if (filters.vendorId.length > 0) {
          filteredContracts = filteredContracts.filter((item) =>
            filters.vendorId.includes(item.vendorId)
          );
        }
        if (filters.contractId.length > 0) {
          filteredContracts = filteredContracts.filter((item) =>
            filters.contractId.includes(item.id)
          );
        }
        if (filters.code.length > 0) {
          filteredContracts = filteredContracts.filter((item) =>
            filters.code.includes(item.code)
          );
        }

        return filteredContracts.map((contract) => {
          const project = this.projectMap.get(contract.projectId) || {};
          const vendor = this.vendorMap.get(contract.vendorId) || {};
          const cpcItemsForContract =
            this.cpcItemsByContractId.get(contract.id) || [];
          const cpcIdsForContract = cpcItemsForContract.map(
            (cpc) => cpc.id
          );

          const relevantInstallments = cpcIdsForContract.flatMap((cpcId) =>
            (this.installmentsByCpcId.get(cpcId) || []).filter(
              (inst) => !inst.isSwap
            )
          );

          const paidAmountInclVAT = relevantInstallments.reduce(
            (sum, inst) => sum + (inst.amountVND || inst.amount || 0),
            0
          );
          let paidAmountExclVAT = 0;
          if (contract.currency === "USD") {
            paidAmountExclVAT = paidAmountInclVAT;
          } else {
            cpcItemsForContract.forEach((cpc) => {
              const cpcInstallments = relevantInstallments.filter(
                (i) => i.cpcId === cpc.id
              );
              const totalPaidForCpc = cpcInstallments.reduce(
                (sum, i) => sum + i.amount,
                0
              );
              if (cpc.amount > 0) {
                const paymentRatio = totalPaidForCpc / cpc.amount;
                paidAmountExclVAT +=
                  (cpc.amountExclVAT || 0) * paymentRatio;
              } else {
                paidAmountExclVAT += totalPaidForCpc;
              }
            });
          }
          const paidVatAmount = paidAmountInclVAT - paidAmountExclVAT;

          const detailsTable =
            this.cpcDetailRowsByContractId.get(contract.id) || [];
          let contractTotals = {};

          if (contract.currency === "USD") {
            let totalContractAmountVND = 0;
            let totalVonVND = 0;
            let totalInvoiceVND = 0;

            detailsTable.forEach((row) => {
              const invoiceAmountUSD = row.invoiceAmount || 0;
              const contractAmountUSD = row.contractAmount || 0;
              const vonAmountUSD = row.contractVon || 0;

              let effectiveRate = parseFloat(row.invoiceExchangeRate) || 0;
              if (effectiveRate <= 0 && row.cpcNo) {
                const cpcItem = cpcItemsForContract.find(
                  (cpc) => cpc.cpcIdentifier === row.cpcNo
                );
                if (cpcItem && cpcItem.exchangeRate > 0) {
                  effectiveRate = cpcItem.exchangeRate;
                }
              }
              totalInvoiceVND += Math.round(
                invoiceAmountUSD * effectiveRate
              );
              totalContractAmountVND += Math.round(
                contractAmountUSD * effectiveRate
              );
              totalVonVND += Math.round(vonAmountUSD * effectiveRate);
            });

            contractTotals = {
              invoiceAmountTotal: totalInvoiceVND,
              invoiceVatTotal: 0,
              invoiceGrandTotal: totalInvoiceVND,
              contractAmountTotal: totalContractAmountVND,
              vonTotal: totalVonVND,
              contractVatTotal: 0,
              contractGrandTotal: totalContractAmountVND + totalVonVND,
            };
          } else {
            contractTotals = {
              invoiceAmountTotal: detailsTable.reduce(
                (sum, row) => sum + (row.invoiceAmount || 0),
                0
              ),
              invoiceVatTotal: detailsTable.reduce(
                (sum, row) => sum + (row.invoiceVat || 0),
                0
              ),
              invoiceGrandTotal: detailsTable.reduce(
                (sum, row) => sum + (row.invoiceTotal || 0),
                0
              ),
              contractAmountTotal: detailsTable.reduce(
                (sum, row) => sum + (row.contractAmount || 0),
                0
              ),
              vonTotal: detailsTable.reduce(
                (sum, row) => sum + (row.contractVon || 0),
                0
              ),
              contractVatTotal: detailsTable.reduce(
                (sum, row) => sum + (row.contractVat || 0),
                0
              ),
              contractGrandTotal: detailsTable.reduce(
                (sum, row) => sum + (row.contractTotal || 0),
                0
              ),
            };
          }

          return {
            id: contract.id,
            contractNo: contract.contractNo,
            currency: contract.currency,
            date: contract.date,
            description: contract.description,
            code: contract.code,
            department: contract.department,
            contractSystemNo: contract.contractSystemNo,
            glAccount: contract.glAccount,
            projectId: contract.projectId,
            vendorId: contract.vendorId,
            projectName: project.name,
            vendorName: vendor.name,
            vendorNo: vendor.vendorNo || "",
            paidAmountInclVAT,
            paidAmountExclVAT,
            paidVatAmount,
            ...contractTotals,
          };
        });
      },

      availableContractProjects() {
        return appUtils.filter.getAvailableItems({
          sourceData: this.projects,
          linkingData: this.contracts,
          linkKey: "projectId",
          searchTerm: "",
          vueInstance: this,
        });
      },

      contractsFilteredByProject() {
        const filter = this.viewStates.contractDashboard.filter;
        if (filter.projectId.length === 0)
          return this.contractDashboardData;
        return this.contractDashboardData.filter((item) =>
          filter.projectId.includes(item.projectId)
        );
      },
      availableContractVendors() {
        return appUtils.filter.getAvailableItems({
          sourceData: this.vendors,
          linkingData: this.contractsFilteredByProject,
          linkKey: "vendorId",
          searchTerm: "",
          vueInstance: this,
        });
      },
      filteredAvailableContractVendors() {
        const searchTerm =
          this.viewStates.contractDashboard.filter.vendorSearch;
        if (!searchTerm) return this.availableContractVendors;
        return this.availableContractVendors.filter((v) =>
          appUtils.text
            .normalizeVietnamese(v.name)
            .includes(appUtils.text.normalizeVietnamese(searchTerm))
        );
      },

      contractsFilteredByVendor() {
        const filter = this.viewStates.contractDashboard.filter;
        if (filter.vendorId.length === 0)
          return this.contractsFilteredByProject;
        return this.contractsFilteredByProject.filter((item) =>
          filter.vendorId.includes(item.vendorId)
        );
      },
      availableContractContracts() {
        const contractIds = new Set(
          this.contractsFilteredByVendor.map((c) => c.id)
        );
        return this.contracts
          .filter((c) => contractIds.has(c.id))
          .sort((a, b) => a.contractNo.localeCompare(b.contractNo));
      },
      filteredAvailableContractContracts() {
        const searchTerm =
          this.viewStates.contractDashboard.filter.contractNoSearch;
        if (!searchTerm) return this.availableContractContracts;
        return this.availableContractContracts.filter((c) =>
          c.contractNo.toLowerCase().includes(searchTerm.toLowerCase())
        );
      },
      filteredAvailableContractProjects() {
        const searchTerm =
          this.viewStates.contractDashboard.filter.projectSearch;
        if (!searchTerm) return this.availableContractProjects;
        return this.availableContractProjects.filter((p) =>
          appUtils.text
            .normalizeVietnamese(p.name)
            .includes(appUtils.text.normalizeVietnamese(searchTerm))
        );
      },

      contractsFilteredByContract() {
        const filter = this.viewStates.contractDashboard.filter;
        if (filter.contractId.length === 0)
          return this.contractsFilteredByVendor;
        return this.contractsFilteredByVendor.filter((item) =>
          filter.contractId.includes(item.id)
        );
      },
      availableContractCodes() {
        return [
          ...new Set(
            this.contractsFilteredByContract
              .map((item) => item.code)
              .filter(Boolean)
          ),
        ].sort();
      },
      filteredAvailableContractCodes() {
        const filter = this.viewStates.contractDashboard.filter;
        if (!filter.codeSearch) return this.availableContractCodes;
        return this.availableContractCodes.filter((c) =>
          c.toLowerCase().includes(filter.codeSearch.toLowerCase())
        );
      },
      filteredContractDashboardData() {
        const state = this.viewStates.contractDashboard;
        let data = [...this.contractsFilteredByContract];
        if (state.filter.code.length > 0)
          data = data.filter((item) =>
            state.filter.code.includes(item.code)
          );
        if (state.sortBy)
          data.sort((a, b) => {
            let valA = a[state.sortBy],
              valB = b[state.sortBy];
            if (valA == null) return 1;
            if (valB == null) return -1;
            if (
              [
                "paidAmountExclVAT",
                "paidVatAmount",
                "paidAmountInclVAT",
                "invoiceAmountTotal",
                "invoiceVatTotal",
                "invoiceGrandTotal",
                "contractAmountTotal",
                "vonTotal",
                "contractVatTotal",
                "contractGrandTotal",
              ].includes(state.sortBy)
            ) {
              valA = parseFloat(valA);
              valB = parseFloat(valB);
            } else if (state.sortBy === "date") {
              valA = new Date(valA);
              valB = new Date(valB);
              if (isNaN(valA)) return 1;
              if (isNaN(valB)) return -1;
            } else if (typeof valA === "string") {
              valA = valA.toLowerCase();
              valB = valB.toLowerCase();
            }
            if (valA < valB) return state.sortDirection === "asc" ? -1 : 1;
            if (valA > valB) return state.sortDirection === "asc" ? 1 : -1;
            return 0;
          });
        return data;
      },
      paginatedContractDashboardData() {
        const state = this.viewStates.contractDashboard;
        const start = (state.currentPage - 1) * state.perPage;
        return this.filteredContractDashboardData.slice(
          start,
          start + state.perPage
        );
      },
      formattedPaginatedContractDashboardData() {
        return this.paginatedContractDashboardData.map((item) => ({
          ...item,
          paidAmountExclVATFormatted: appUtils.format.number(
            item.paidAmountExclVAT
          ),
          paidVatAmountFormatted: appUtils.format.number(
            item.paidVatAmount
          ),
          paidAmountInclVATFormatted: appUtils.format.number(
            item.paidAmountInclVAT
          ),
          invoiceAmountTotalFormatted: appUtils.format.number(
            item.invoiceAmountTotal
          ),
          invoiceVatTotalFormatted: appUtils.format.number(
            item.invoiceVatTotal
          ),
          invoiceGrandTotalFormatted: appUtils.format.number(
            item.invoiceGrandTotal
          ),
          contractAmountTotalFormatted: appUtils.format.number(
            item.contractAmountTotal
          ),
          vonTotalFormatted: appUtils.format.number(item.vonTotal),
          contractVatTotalFormatted: appUtils.format.number(
            item.contractVatTotal
          ),
          contractGrandTotalFormatted: appUtils.format.number(
            item.contractGrandTotal
          ),
        }));
      },
      contractDashboardTotalPages() {
        const state = this.viewStates.contractDashboard;
        return Math.ceil(
          this.filteredContractDashboardData.length / state.perPage
        );
      },
      totalPaidAmountInclVATContractDashboard() {
        return this.filteredContractDashboardData.reduce(
          (sum, item) => sum + (item.paidAmountInclVAT || 0),
          0
        );
      },
      totalPaidAmountExclVATContractDashboard() {
        return this.filteredContractDashboardData.reduce(
          (sum, item) => sum + (item.paidAmountExclVAT || 0),
          0
        );
      },
      totalPaidVatAmountContractDashboard() {
        return this.filteredContractDashboardData.reduce(
          (sum, item) => sum + (item.paidVatAmount || 0),
          0
        );
      },
      totalInvoiceAmountContractDashboard() {
        return this.filteredContractDashboardData.reduce(
          (sum, item) => sum + (item.invoiceAmountTotal || 0),
          0
        );
      },
      totalInvoiceVatContractDashboard() {
        return this.filteredContractDashboardData.reduce(
          (sum, item) => sum + (item.invoiceVatTotal || 0),
          0
        );
      },
      totalInvoiceGrandTotalContractDashboard() {
        return this.filteredContractDashboardData.reduce(
          (sum, item) => sum + (item.invoiceGrandTotal || 0),
          0
        );
      },
      totalContractAmountContractDashboard() {
        return this.filteredContractDashboardData.reduce(
          (sum, item) => sum + (item.contractAmountTotal || 0),
          0
        );
      },
      totalVonContractDashboard() {
        return this.filteredContractDashboardData.reduce(
          (sum, item) => sum + (item.vonTotal || 0),
          0
        );
      },
      totalContractVatContractDashboard() {
        return this.filteredContractDashboardData.reduce(
          (sum, item) => sum + (item.contractVatTotal || 0),
          0
        );
      },
      totalContractGrandTotalContractDashboard() {
        return this.filteredContractDashboardData.reduce(
          (sum, item) => sum + (item.contractGrandTotal || 0),
          0
        );
      },
      visibleContractDashboardColumns() {
        return this.contractDashboardAvailableColumns.filter(
          (col) => this.contractDashboardColumnVisibility[col.key]
        );
      },
    },
    methods: {
      async bulkSyncCpcsAndInstallmentsFromUpload(contractId) {
        const contract = this.contracts.find(c => c.id === contractId);
        if (!contract) return;

        // Lấy tất cả các dòng thuộc hợp đồng này có chứa mã CPC tạm thời
        const allRelevantRows = this.cpcDetailRows.filter(r => r.contractId === contractId && r.tempCpcNoForSync);
        if (allRelevantRows.length === 0) return;

        // 1. Ép tính toán lại Net (Amount Due) cho từng dòng
        allRelevantRows.forEach(row => {
          row.cpcAmountDue = (Number(row.cpcPaymentOfWorkdone) || 0) +
            (Number(row.cpcAdvance) || 0) +
            (Number(row.cpcRepayment) || 0) +
            (Number(row.cpcRetention) || 0) +
            (Number(row.cpcOtherDeduction) || 0);
        });

        // 2. Gom nhóm theo tempCpcNoForSync
        const groupedByCpc = allRelevantRows.reduce((acc, row) => {
          const cpcKey = row.tempCpcNoForSync;
          if (!acc[cpcKey]) acc[cpcKey] = { rows: [], payments: [] };
          acc[cpcKey].rows.push(row);

          if (row.tempPaymentDate && row.tempPaymentAmount) {
            acc[cpcKey].payments.push({
              date: appUtils.format.date(new Date(row.tempPaymentDate)),
              amount: row.tempPaymentAmount,
              paymentSource: "Excel Import"
            });
          }
          return acc;
        }, {});

        try {
          const isUsd = contract.currency === "USD";

          for (const cpcNo in groupedByCpc) {
            const data = groupedByCpc[cpcNo];
            const aggregated = this._aggregateCpcDataFromDetailRows(data.rows, isUsd);

            let existingCpc = this.cpcItems.find(c => c.contractId === contractId && c.cpcIdentifier === cpcNo);
            let targetCpcId;

            const cpcFields = {
              contractId, cpcIdentifier: cpcNo,
              projectId: contract.projectId, vendorId: contract.vendorId,
              contents: aggregated.finalContents,
              amount: isUsd ? 0 : aggregated.finalAmount,
              amountExclVAT: isUsd ? 0 : aggregated.amountDue,
              vatAmount: isUsd ? 0 : aggregated.vatAmount,
              amountUsd: isUsd ? aggregated.amountDue : 0,
              paymentDueDate: aggregated.paymentDueDate,
              isUsd
            };

            if (existingCpc) {
              targetCpcId = existingCpc.id;
              await databaseService.db.cpcItems.update(targetCpcId, cpcFields);
              Object.assign(existingCpc, cpcFields);
            } else {
              targetCpcId = await databaseService.db.cpcItems.add(cpcFields);
              cpcFields.id = targetCpcId;
              this.cpcItems.push(cpcFields);
            }

            if (data.payments.length > 0) {
              await databaseService.db.installments.where("cpcId").equals(targetCpcId).delete();
              const rate = isUsd ? (existingCpc?.exchangeRate || 25000) : 0;
              const installmentsToSave = data.payments.map(p => ({
                ...p, cpcId: targetCpcId, contractId, projectId: contract.projectId, vendorId: contract.vendorId,
                isUsd, amountUsd: isUsd ? p.amount : 0, exchangeRate: rate,
                amountVND: isUsd ? Math.round(p.amount * rate) : p.amount,
                amount: isUsd ? Math.round(p.amount * rate) : p.amount
              }));
              await databaseService.db.installments.bulkAdd(installmentsToSave);
            }
          }

          this.installments = await databaseService.db.installments.toArray();
          this.syncPaymentsToDetails(contractId);

          // 3. Dọn dẹp các biến tạm trên allRelevantRows và CSDL
          allRelevantRows.forEach(r => {
            delete r.tempPaymentDate; delete r.tempPaymentAmount; delete r.tempCpcNoForSync;
          });
          await databaseService.db.cpcDetailRows.bulkPut(JSON.parse(JSON.stringify(allRelevantRows)));

          this.showToast("Đã đồng bộ Net Amount và Thanh toán (Gom nhóm theo CPC).", "success");
        } catch (err) { console.error(err); this.showToast("Lỗi đồng bộ.", "error"); }
      },
      goToVendorPartnerFromOverview(vendorId, vendorName) {
        if (!vendorId) return;

        // 1. Thiết lập state cho tab Vendor Partner để tự động tìm và chọn đúng NCC
        this.viewStates.vendorPartner.selectedId = vendorId;
        this.viewStates.vendorPartner.searchTerm = vendorName; // Để hiện ra ở sidebar trái

        // 2. Chuyển sang tab Vendor Partner
        this.currentTab = 'vendor-partner';

        // 3. Thông báo nhẹ
        this.showToast(this.t('filteringContractForVendor', { vendorName: vendorName }), 'info');
      },
      goToContractOverviewFromVendor(contract) {
        if (!contract || !contract.id) return;

        // 1. Thiết lập bộ lọc cho tab CPC Details/Overview để hệ thống nhận diện đúng ngữ cảnh
        this.viewStates.cpcDetails.filter.projectId = [contract.projectId];
        this.viewStates.cpcDetails.filter.vendorId = [contract.vendorId];

        // 2. Sử dụng $nextTick để đảm bảo các bộ lọc trên đã được áp dụng trước khi chọn ID hợp đồng
        this.$nextTick(() => {
          this.viewStates.cpcDetails.filter.selectedContractId = contract.id;

          // 3. Chuyển sang tab Tổng quan hợp đồng
          this.currentTab = 'contract-overview';

          // 4. Thông báo nhẹ cho người dùng
          this.showToast(this.t('filteringBondForContract', { contractNo: contract.contractNo }), 'info');
        });
      },
      async exportCpcDetailsToPdf() {
        const contractNo = this.selectedContractDetails?.contractNo || "Summary";
        const projectName = this.selectedContractDetails?.projectName || "Project";

        const originalPhase = this.viewStates.cpcDetails.activePhaseId;

        this.viewStates.cpcDetails.activePhaseId = 'summary';

        this.showToast("Đang khởi tạo bản in Grand Total...", "info");

        await this.$nextTick();

        const element = document.querySelector(".main-content > div > div");

        const opt = {
          margin: [10, 5, 10, 5], // top, left, bottom, right (mm)
          filename: `Summary_A3_${contractNo}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: {
            scale: 2, // Tăng độ nét
            useCORS: true,
            letterRendering: true
          },
          jsPDF: {
            unit: 'mm',
            format: 'a3',
            orientation: 'landscape' // Khổ ngang A3 cho bảng rộng
          },
          pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
        };

        html2pdf().set(opt).from(element).save().then(() => {
          this.viewStates.cpcDetails.activePhaseId = originalPhase;
          this.showToast("Xuất PDF thành công!", "success");
        }).catch(err => {
          console.error("PDF Export Error:", err);
          this.showToast("Lỗi khi xuất PDF", "error");
          this.viewStates.cpcDetails.activePhaseId = originalPhase;
        });
      },
      getOrdinal(n) {
        if (this.language !== 'en') return '';
        const s = ["th", "st", "nd", "rd"];
        const v = n % 100;
        return s[(v - 20) % 10] || s[v] || s[0];
      },
      toggleAllRepaymentBasis(isSelected) {
        if (!this.currentDetailItem) return;

        if (isSelected) {
          this.currentDetailItem.repaymentBasisItems =
            this.availableRepaymentBasis.map((b) => b.id);
        } else {
          this.currentDetailItem.repaymentBasisItems = [];
        }
        this.updateFormulasInModal("cpcRepayment", false);
      },

      exportInvoiceAgingToExcel() {
        const state = this.viewStates.invoiceAging;
        const isContractMode = state.viewMode === "contract";
        const data = isContractMode
          ? this.filteredContractAgingData
          : this.filteredInvoiceAgingData;

        if (!data || data.length === 0) {
          this.showToast(this.t("noMatchingData"), "warning");
          return;
        }

        let exportData = [];
        if (isContractMode) {
          exportData = data.map((item) => ({
            [this.t("project")]: item.projectName,
            [this.t("contractDateLabel")]: item.contractDate,
            [this.t("contract")]: item.contractNo,
            [this.t("vendorNo")]: item.vendorNo,
            [this.t("vendor")]: item.vendorName,
            [this.t("descriptionLabel")]: item.description,
            [this.t("age1_30")]: item.age1_30,
            [this.t("age31_60")]: item.age31_60,
            [this.t("age61_90")]: item.age61_90,
            [this.t("ageOver90")]: item.ageOver90,
            [this.t("totalOverdue")]: item.remainingTotal,
          }));
        } else {
          exportData = data.map((item) => ({
            [this.t("project")]: item.projectName,
            [this.t("contract")]: item.contractNo,
            [this.t("vendor")]: item.vendorName,
            [this.t("invoiceNoLabel")]: item.invoiceNo,
            [this.t("date")]: item.invoiceDate,
            [this.t("postingDate")]: item.invoicePostingDate,
            [this.t("ageDays")]: item.age,
            [this.t("invoiceNet")]: item.remainingNet,
            [this.t("invoiceVat")]: item.remainingVat,
            [this.t("invoiceTotal")]: item.remainingTotal,
          }));
        }

        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Aging");
        XLSX.writeFile(
          wb,
          `Aging_${state.viewMode}_${state.filter.reportDate}.xlsx`
        );
      },
      calculateDiffDays(dateStr) {
        if (!dateStr) return 0;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const targetDate = new Date(dateStr);
        targetDate.setHours(0, 0, 0, 0);
        const diffTime = targetDate - today;
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      },
      changePerPage(viewState, offset) {
        const options = [5, 10, 25, 50, 100];
        let currentIndex = options.indexOf(viewState.perPage);

        if (currentIndex === -1) currentIndex = 1;

        let nextIndex = currentIndex + offset;

        if (nextIndex >= 0 && nextIndex < options.length) {
          viewState.perPage = options[nextIndex];
          viewState.currentPage = 1;
        }
      },
      changeSwapDashboardYear(offset) {
        const currentYear = this.swapDashboardYear;
        const newYear = currentYear + offset;
        this.viewStates.swapDashboard.filter.startDate = `${newYear}-01-01`;
        this.viewStates.swapDashboard.filter.endDate = `${newYear}-12-31`;
        this.viewStates.swapDashboard.currentPage = 1;
        this.showToast(`SWAP: Switched to year ${newYear}`, "info");
      },

      toggleSwapExpand(swapItem) {
        const original = this.installments.find(
          (i) => i.id === swapItem.id
        );
        if (original) {
          original.isExpanded = !original.isExpanded;
        }
      },

      changeDashboardYear(offset) {
        const currentYear = this.paymentDashboardYear;
        const newYear = currentYear + offset;

        this.viewStates.paymentDashboard.filter.startDate = `${newYear}-01-01`;
        this.viewStates.paymentDashboard.filter.endDate = `${newYear}-12-31`;

        this.viewStates.paymentDashboard.currentPage = 1;
        this.showToast(`Switched to ${newYear}`, "info");
      },
      handleCpcUsdToggle() {
        if (this.currentEditItem.isUsd) {
          if (
            !this.currentEditItem.exchangeRate ||
            this.currentEditItem.exchangeRate === 0
          ) {
            this.currentEditItem.exchangeRate = 23500;
            this.currentEditItem.displayExchangeRate = "23.500";
          }
          if (!this.currentEditItem.amountUsd) {
            this.currentEditItem.amountUsd = 0;
            this.currentEditItem.displayAmountUsd = "0.00";
          }
          this.calculateVndFromUsd();
        } else {
          this.currentEditItem.displayAmountExclVAT = (
            this.currentEditItem.amountExclVAT || 0
          ).toLocaleString("vi-VN");
          this.currentEditItem.displayVatAmount = (
            this.currentEditItem.vatAmount || 0
          ).toLocaleString("vi-VN");
          this.currentEditItem.displayAmount = (
            this.currentEditItem.amount || 0
          ).toLocaleString("vi-VN");

          this.currentEditItem.amountUsd = 0;
          this.currentEditItem.displayAmountUsd = "0.00";
        }
      },
      handleUsdToggle(installment) {
        if (installment.isUsd) {
          if (!installment.exchangeRate || installment.exchangeRate === 0) {
            installment.exchangeRate = 23500;
            installment.displayExchangeRate = "23.500";
          }
          if (!installment.amountUsd) {
            installment.amountUsd = 0;
            installment.displayAmountUsd = "0.00";
          }
          this.calculateInstallmentVndFromUsd(installment);
        } else {
          installment.displayAmount = (
            installment.amount || 0
          ).toLocaleString("vi-VN");

          installment.amountUsd = 0;
          installment.displayAmountUsd = "0.00";
        }
      },
      getModalTotalPaid() {
        if (!this.currentEditItem || !this.currentEditItem.installments)
          return 0;

        const isUsd = this.currentEditItem.isUsd;

        return this.currentEditItem.installments.reduce((sum, inst) => {
          const val = isUsd ? inst.amountUsd || 0 : inst.amount || 0;
          return sum + val;
        }, 0);
      },

      getModalTotalPaidFormatted() {
        const total = this.getModalTotalPaid();
        if (this.currentEditItem && this.currentEditItem.isUsd) {
          return this.formatCurrencyUSD(total);
        }
        return this.formatCurrency(total);
      },

      getModalRemainingAmount() {
        if (!this.currentEditItem) return 0;

        const isUsd = this.currentEditItem.isUsd;
        const totalAmount = isUsd
          ? this.currentEditItem.amountUsd || 0
          : this.currentEditItem.amount || 0;
        const paid = this.getModalTotalPaid();

        if (totalAmount < 0) {
          return Math.abs(totalAmount) - paid;
        }

        return totalAmount - paid;
      },

      getModalRemainingFormatted() {
        const remaining = this.getModalRemainingAmount();
        if (this.currentEditItem && this.currentEditItem.isUsd) {
          return this.formatCurrencyUSD(remaining);
        }
        return this.formatCurrency(remaining);
      },

      getModalPaymentPercentage() {
        if (!this.currentEditItem) return 0;
        const isUsd = this.currentEditItem.isUsd;
        const totalAmount = Math.abs(
          isUsd
            ? this.currentEditItem.amountUsd || 0
            : this.currentEditItem.amount || 0
        );

        if (totalAmount === 0) return 100;

        const paid = this.getModalTotalPaid();
        return (paid / totalAmount) * 100;
      },
      manualRecalculateVendorBalance() {
        this.showToast(this.t("calculatingData"), "info");
        setTimeout(() => {
          this._recalculateAllDetailRowsAfterLoad();
          this.showToast(this.t("refreshSuccess"), "success");
        }, 100);
      },
      getBondTypeColorClass(bondType) {
        if (!bondType) return "";

        const type = bondType.toLowerCase().trim();

        const preEn = this.translations.en.prepaymentBond.toLowerCase();
        const preVi = this.translations.vi.prepaymentBond.toLowerCase();
        if (type === preEn || type === preVi) return "text-bond-prepayment";

        const perfEn = this.translations.en.performanceBond.toLowerCase();
        const perfVi = this.translations.vi.performanceBond.toLowerCase();
        if (type === perfEn || type === perfVi)
          return "text-bond-performance";

        const warEn = this.translations.en.warrantyBond.toLowerCase();
        const warVi = this.translations.vi.warrantyBond.toLowerCase();
        if (type === warEn || type === warVi) return "text-bond-warranty";

        return "";
      },

      toggleSidebarFixed() {
        this.isSidebarFixed = !this.isSidebarFixed;
        localStorage.setItem("isSidebarFixed", this.isSidebarFixed);

        this.$nextTick(() => {
          if (typeof lucide !== "undefined") {
            lucide.createIcons();
          }
        });
      },

      toggleBondGroupExpand(group) {
        const keys = this.viewStates.bondDashboard.expandedGroupKeys;
        const keyIndex = keys.indexOf(group.groupKey);

        if (keyIndex > -1) {
          keys.splice(keyIndex, 1);
        } else {
          keys.push(group.groupKey);
        }
      },

      getBondRowClass(bond) {
        const statusObj = this.getBondStatusClassForDashboard(bond);
        if (bond.isSettled) return "status-settled";
        if (statusObj.message.includes("Overdue")) return "status-danger";
        if (statusObj.message.includes("Expiring")) return "status-warning";
        return "status-active";
      },

      checkPhaseAndTriggerUpload() {
        const activePhaseId = this.viewStates.cpcDetails.activePhaseId;

        const hasPhases = this.selectedContractDetails?.phases?.length > 0;

        if (activePhaseId === "summary" && hasPhases) {
          this.showToast(this.t("errorUploadInSummaryMode"), "warning");
          return;
        }

        this.triggerDetailsFileUpload();
      },
      async addNewPhase() {
        const contractName = this.selectedContractDetails.contractNo;
        const phaseName = prompt(
          `Nhập tên Giai đoạn/Phần việc mới cho HĐ ${contractName}:`,
          `Phần ${(this.selectedContractDetails.phases?.length || 0) + 1}`
        );

        if (phaseName && phaseName.trim()) {
          const contract = this.contracts.find(
            (c) => c.id === this.selectedContractDetails.id
          );
          if (!contract) return;

          if (!contract.phases) contract.phases = [];

          const newPhase = {
            id: "phase_" + Date.now(),
            name: phaseName.trim(),
          };

          contract.phases.push(newPhase);

          await databaseService.db.contracts.put(
            JSON.parse(JSON.stringify(contract))
          );

          this.viewStates.cpcDetails.activePhaseId = newPhase.id;
          this.showToast(this.t("phaseAddedSuccess"), "success");
        }
      },

      async renamePhase(phase) {
        const newName = prompt("Nhập tên mới:", phase.name);
        if (newName && newName.trim()) {
          const contract = this.contracts.find(
            (c) => c.id === this.selectedContractDetails.id
          );
          const targetPhase = contract.phases.find(
            (p) => p.id === phase.id
          );
          if (targetPhase) {
            targetPhase.name = newName.trim();
            await databaseService.db.contracts.put(
              JSON.parse(JSON.stringify(contract))
            );
            this.showToast(this.t("phaseRenamedSuccess"), "success");
          }
        }
      },

      async deletePhase(phase) {
        const contractId = this.selectedContractDetails.id;
        const rowsToDelete = this.cpcDetailRows.filter(
          (r) => r.contractId === contractId && r.phaseId === phase.id
        );
        const count = rowsToDelete.length;

        let message = `Bạn có chắc chắn muốn xóa giai đoạn "${phase.name}"?`;
        if (count > 0) {
          message += `\n\n⚠️ CẢNH BÁO: Giai đoạn này đang chứa ${count} dòng dữ liệu sẽ bị mất.`;
        }

        if (confirm(message)) {
          try {
            // 1. Xóa các dòng thuộc Phase này trong DB
            if (count > 0) {
              const idsToDelete = rowsToDelete.map((r) => r.id);
              await databaseService.db.cpcDetailRows.bulkDelete(idsToDelete);
              this.cpcDetailRows = this.cpcDetailRows.filter((r) => !idsToDelete.includes(r.id));
            }

            // 2. Cập nhật danh sách Phase trong Contract
            const contract = this.contracts.find((c) => c.id === contractId);
            if (contract && contract.phases) {
              contract.phases = contract.phases.filter((p) => p.id !== phase.id);

              // --- LOGIC MỚI: Nếu không còn Phase nào, tạo 3 dòng trống mặc định ---
              if (contract.phases.length === 0) {
                // Kiểm tra xem hiện tại có dòng nào không thuộc phase không (dòng Summary cũ)
                const globalRows = this.cpcDetailRows.filter(r => r.contractId === contractId && !r.phaseId);

                if (globalRows.length === 0) {
                  const newEmptyRows = [];
                  for (let i = 0; i < 3; i++) {
                    const emptyRow = this.createEmptyDetailRow(contractId, i);
                    emptyRow.phaseId = null; // Đảm bảo thuộc về Grand Total
                    newEmptyRows.push(emptyRow);
                  }

                  const newIds = await databaseService.db.cpcDetailRows.bulkAdd(
                    JSON.parse(JSON.stringify(newEmptyRows)),
                    { allKeys: true }
                  );
                  newEmptyRows.forEach((row, idx) => row.id = newIds[idx]);
                  this.cpcDetailRows.push(...newEmptyRows);
                }
              }

              await databaseService.db.contracts.put(JSON.parse(JSON.stringify(contract)));
            }

            this.viewStates.cpcDetails.activePhaseId = "summary";
            this.showToast(this.t("phaseDeletedSuccess"), "success");
          } catch (error) {
            console.error("Lỗi khi xóa giai đoạn:", error);
            this.showToast(this.t("phaseDeleteError"), "error");
          }
        }
      },
      deleteDetailRow(itemId) {
        // Kiểm tra an toàn: Không cho phép xóa nếu chỉ còn 1 dòng hiển thị
        if (this.displayedContractDetailTable.length <= 1) {
          return;
        }

        appUtils.ui.showConfirmation(this, {
          title: this.t("confirmDeletion"),
          message: this.t("confirmDeleteRow"),
          onConfirm: async () => {
            const itemIndex = this.cpcDetailRows.findIndex((item) => item.id === itemId);
            if (itemIndex > -1) {
              try {
                await databaseService.db.cpcDetailRows.delete(itemId);
                this.cpcDetailRows.splice(itemIndex, 1);
                this.showToast(this.t("rowDeleted"), "success");
              } catch (error) {
                console.error("Error deleting detail row:", error);
              }
            }
          },
        });
      },

      exportSwapDashboardToExcel() {
        if (this.filteredSwapsDashboard.length === 0) {
          this.showToast(this.t("noSwapData"), "warning");
          return;
        }

        const dataToExport = this.filteredSwapsDashboard.map((item) => ({
          [this.t("project")]: item.projectName,
          [this.t("vendor")]: item.vendorName,
          [this.t("cpc")]: item.cpcIdentifier,
          [this.t("contract")]: item.contractNo,
          [this.t("vendorSWAP")]: item.vendorSWAP,
          [this.t("swapAgreement")]: item.swapAgreement,
          [this.t("swapProduct")]: item.swapProduct || "",
          [this.t("agreementDate")]: item.date,
          [this.t("amount")]: item.amount,
          [this.t("swapAmountPaid")]: item.totalSwapPaidAmount,
          [this.t("swapPaymentDate")]: item.latestSwapPaymentDate,
          [this.t("status")]: this.getSwapStatusInfo(item).statusText,
          [this.t("transactionType")]:
            item.transactionType === "receivable"
              ? this.t("transactionTypeReceivable")
              : this.t("transactionTypePayable"),
          [this.t("swapInformation")]: item.swapInformation,
        }));

        const ws = XLSX.utils.json_to_sheet(dataToExport);

        const colWidths = Object.keys(dataToExport[0]).map(() => ({
          wch: 20,
        }));
        ws["!cols"] = colWidths;

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "SWAP Dashboard");

        const fileName = `SWAP_Export_${appUtils.format.date(
          new Date()
        )}.xlsx`;
        XLSX.writeFile(wb, fileName);

        this.showToast(this.t("changesSavedSuccess"), "success");
      },
      selectProjectForContract(project) {
        if (this.currentEditContract) {
          this.currentEditContract.projectName = project.name;
          this.currentEditContract.projectId = project.id;
        }

        this.isContractProjectDropdownVisible = false;
        this.activeContractProjectIndex = -1;
      },

      handleContractProjectInputBlur() {
        setTimeout(() => {
          this.isContractProjectDropdownVisible = false;
        }, 200);
      },

      navigateProjectsForContract(event) {
        if (
          !this.isContractProjectDropdownVisible ||
          this.filteredProjectsForContractModal.length === 0
        )
          return;

        switch (event.key) {
          case "ArrowDown":
            event.preventDefault();
            if (
              this.activeContractProjectIndex <
              this.filteredProjectsForContractModal.length - 1
            ) {
              this.activeContractProjectIndex++;
              this.scrollToActiveItem(event.target);
            }
            break;
          case "ArrowUp":
            event.preventDefault();
            if (this.activeContractProjectIndex > 0) {
              this.activeContractProjectIndex--;
              this.scrollToActiveItem(event.target);
            }
            break;
          case "Enter":
            if (this.activeContractProjectIndex >= 0) {
              event.preventDefault();
              this.selectProjectForContract(
                this.filteredProjectsForContractModal[
                this.activeContractProjectIndex
                ]
              );
            } else {
              this.isContractProjectDropdownVisible = false;
            }
            break;
          case "Escape":
            this.isContractProjectDropdownVisible = false;
            break;
        }
      },
      goToBondDashboardFromTracking(item) {
        this.clearAllFilters();

        if (item.contractId) {
          this.viewStates.bondDashboard.filter.contractId = [
            item.contractId,
          ];
        }

        this.viewStates.bondDashboard.filter.status = [
          "Overdue",
          "Expiring Soon",
        ];

        this.$nextTick(() => {
          this.currentTab = "cpc-bond-dashboard";

          this.showToast(
            this.t("filteringBondForContract", {
              contractNo: item.contractNo,
            }),
            "warning"
          );
        });
      },
      goToContractDashboardFromVendor(vendorItem) {
        if (!vendorItem) return;

        let targetVendorId = vendorItem.vendorId;

        if (typeof targetVendorId !== "number") {
          const realVendor = this.vendors.find(
            (v) => v.vendorNo === vendorItem.vendorNo
          );
          if (realVendor) {
            targetVendorId = realVendor.id;
          } else {
            this.showToast(this.t("vendorNoContractWarning"), "warning");
            return;
          }
        }

        const filterState = this.viewStates.contractDashboard.filter;

        filterState.projectId = [];
        filterState.contractId = [];
        filterState.code = [];
        filterState.projectSearch = "";
        filterState.vendorSearch = "";
        filterState.contractNoSearch = "";
        filterState.codeSearch = "";

        this.$nextTick(() => {
          filterState.vendorId = [targetVendorId];

          this.viewStates.contractDashboard.currentPage = 1;

          this.$nextTick(() => {
            this.currentTab = "cpc-contract-dashboard";

            this.showToast(
              this.t("filteringContractForVendor", {
                vendorName: vendorItem.vendorName,
              }),
              "info"
            );
          });
        });
      },
      scrollToActiveItem(inputElement) {
        this.$nextTick(() => {
          const container = inputElement.closest(
            ".custom-dropdown-container"
          );
          if (!container) return;

          const menu = container.querySelector(".custom-dropdown-menu");
          if (!menu) return;

          const activeItem = menu.querySelector("li.active");

          if (activeItem) {
            activeItem.scrollIntoView({ block: "nearest" });
          }
        });
      },

      selectProject(project) {
        this.currentEditItem.projectName = project.name;

        this.isProjectDropdownVisible = false;
        this.activeProjectIndex = -1;
      },

      handleProjectInputBlur() {
        setTimeout(() => {
          this.isProjectDropdownVisible = false;
        }, 200);
      },

      navigateProjects(event) {
        if (
          !this.isProjectDropdownVisible ||
          this.filteredProjectsForModal.length === 0
        )
          return;

        switch (event.key) {
          case "ArrowDown":
            event.preventDefault();
            if (
              this.activeProjectIndex <
              this.filteredProjectsForModal.length - 1
            ) {
              this.activeProjectIndex++;
              this.scrollToActiveItem(event.target);
            }
            break;
          case "ArrowUp":
            event.preventDefault();
            if (this.activeProjectIndex > 0) {
              this.activeProjectIndex--;
              this.scrollToActiveItem(event.target);
            }
            break;
          case "Enter":
            if (this.activeProjectIndex >= 0) {
              event.preventDefault();
              this.selectProject(
                this.filteredProjectsForModal[this.activeProjectIndex]
              );
            } else {
              this.isProjectDropdownVisible = false;
            }
            break;
          case "Escape":
            this.isProjectDropdownVisible = false;
            break;
        }
      },

      selectContract(contract) {
        this.currentEditItem.contractNo = contract.contractNo;

        this.autoFillFromMasterContract();

        this.isContractDropdownVisible = false;
        this.activeContractIndex = -1;
      },

      handleContractInputBlur() {
        setTimeout(() => {
          this.isContractDropdownVisible = false;
        }, 200);
      },

      navigateContracts(event) {
        if (
          !this.isContractDropdownVisible ||
          this.filteredContractsForModal.length === 0
        )
          return;

        switch (event.key) {
          case "ArrowDown":
            event.preventDefault();
            if (
              this.activeContractIndex <
              this.filteredContractsForModal.length - 1
            ) {
              this.activeContractIndex++;
              this.scrollToActiveItem(event.target);
            }
            break;
          case "ArrowUp":
            event.preventDefault();
            if (this.activeContractIndex > 0) {
              this.activeContractIndex--;
              this.scrollToActiveItem(event.target);
            }
            break;
          case "Enter":
            if (this.activeContractIndex >= 0) {
              event.preventDefault();
              this.selectContract(
                this.filteredContractsForModal[this.activeContractIndex]
              );
            } else {
              this.isContractDropdownVisible = false;
            }
            break;
          case "Escape":
            this.isContractDropdownVisible = false;
            break;
        }
      },

      formatDoc(cmd, value = null) {
        document.execCommand(cmd, false, value);
        this.$nextTick(() => {
          if (this.$refs.notesEditor) {
            this.$refs.notesEditor.focus();
            this.updateNotesContent({ target: this.$refs.notesEditor });
          }
        });
      },

      formatTableAlign(alignType) {
        const selection = window.getSelection();
        if (!selection.rangeCount) return;

        let node = selection.anchorNode;
        if (node.nodeType === 3) node = node.parentNode;

        while (
          node &&
          node.nodeName !== "TD" &&
          node.nodeName !== "TH" &&
          !node.classList?.contains("notes-edit-area")
        ) {
          node = node.parentNode;
        }

        if (node && (node.nodeName === "TD" || node.nodeName === "TH")) {
          node.style.textAlign = alignType;

          this.updateNotesContent({ target: this.$refs.notesEditor });
        } else {
          const cmdMap = {
            left: "justifyLeft",
            center: "justifyCenter",
            right: "justifyRight",
          };
          this.formatDoc(cmdMap[alignType]);
        }
      },

      startResize(event) {
        this.isResizingNotes = true;
        window.addEventListener("mousemove", this.doResize);
        window.addEventListener("mouseup", this.stopResize);
      },
      doResize(event) {
        if (!this.isResizingNotes) return;

        const newWidth = window.innerWidth - event.clientX;

        const minWidth = 300;
        const maxWidth = 800;

        this.notesPanelWidth = Math.max(
          minWidth,
          Math.min(newWidth, maxWidth)
        );
      },
      stopResize() {
        this.isResizingNotes = false;
        window.removeEventListener("mousemove", this.doResize);
        window.removeEventListener("mouseup", this.stopResize);

        localStorage.setItem("notesPanelWidth", this.notesPanelWidth);
      },

      openNotesModal() {
        if (this.selectedContractDetails) {
          this.initializeNotesForContract(this.selectedContractDetails);
          this.isNotesEditing = false;
          this.isNotesModalVisible = true;
        }
      },

      closeNotesModal() {
        if (this.isNotesEditing) {
        }
        this.isNotesModalVisible = false;
        this.isNotesEditing = false;
        this.currentContractNotes = [];
        this.activeNoteTabId = null;
        this.editingTabId = null;
      },

      toggleNotesModal() {
        if (this.isNotesModalVisible) {
          this.closeNotesModal();
        } else {
          this.openNotesModal();
        }
      },

      toggleNotesEdit(isEditing) {
        this.isNotesEditing = isEditing;
        if (isEditing && this.activeNote) {
          this.$nextTick(() => {
            if (this.$refs.notesEditor) {
              this.$refs.notesEditor.innerHTML =
                this.activeNote.content || "";
              this.$refs.notesEditor.focus();
            }
          });
        }
      },

      async saveNotes() {
        if (!this.activeNote) return;

        if (this.$refs.notesEditor) {
          this.activeNote.content = this.$refs.notesEditor.innerHTML;
        }

        const contractId = this.selectedContractDetails?.id;
        if (!contractId) return;

        const contractIndex = this.contracts.findIndex(
          (c) => c.id === contractId
        );
        if (contractIndex === -1) return;

        const contractToUpdate = JSON.parse(
          JSON.stringify(this.contracts[contractIndex])
        );

        contractToUpdate.significantNotes = JSON.parse(
          JSON.stringify(this.currentContractNotes)
        );

        try {
          await databaseService.db.contracts.put(contractToUpdate);

          this.contracts[contractIndex] = contractToUpdate;

          this.showToast(this.t("changesSavedSuccess"), "success");
          this.toggleNotesEdit(false);
        } catch (error) {
          console.error("Error saving significant notes:", error);
          this.showToast(this.t("errorSavingChanges"), "error");
        }
      },

      updateNotesContent(event) {
        if (this.activeNote) {
          this.activeNote.content = event.target.innerHTML;
        }
      },

      initializeNotesForContract(contract) {
        if (!contract) {
          this.currentContractNotes = [];
          this.activeNoteTabId = null;
          return;
        }

        let notes = contract.significantNotes;

        if (typeof notes === "string") {
          if (notes.trim()) {
            this.currentContractNotes = [
              {
                id: "default",
                title: this.t("generalNotes", { default: "General Notes" }),
                content: notes,
              },
            ];
          } else {
            this.currentContractNotes = [];
          }
        } else if (Array.isArray(notes)) {
          this.currentContractNotes = JSON.parse(JSON.stringify(notes));
        } else {
          this.currentContractNotes = [];
        }

        if (this.currentContractNotes.length > 0) {
          this.activeNoteTabId = this.currentContractNotes[0].id;
        } else {
          this.activeNoteTabId = null;
        }
      },

      addNewNoteTab() {
        const tabTitle = prompt(
          this.t("promptNewTabTitle", {
            default: "Please enter a title for the new tab:",
          }),
          `Phụ lục ${this.currentContractNotes.length + 1}`
        );
        if (tabTitle && tabTitle.trim()) {
          const newTab = {
            id: "tab_" + Date.now(),
            title: tabTitle.trim(),
            content: "",
          };
          this.currentContractNotes.push(newTab);
          this.activeNoteTabId = newTab.id;
          this.saveContractWithNewNotesStructure();
        }
      },

      deleteNoteTab(tabToDelete) {
        appUtils.ui.showConfirmation(this, {
          title: this.t("confirmDeleteTabTitle", { default: "Delete Tab" }),
          message: this.t("confirmDeleteTabMessage", {
            title: tabToDelete.title,
            default: `Are you sure you want to delete the tab "<strong>${tabToDelete.title}</strong>"?`,
          }),
          onConfirm: () => {
            const index = this.currentContractNotes.findIndex(
              (tab) => tab.id === tabToDelete.id
            );
            if (index > -1) {
              this.currentContractNotes.splice(index, 1);

              if (this.activeNoteTabId === tabToDelete.id) {
                this.activeNoteTabId =
                  this.currentContractNotes.length > 0
                    ? this.currentContractNotes[Math.max(0, index - 1)].id
                    : null;
              }

              this.saveContractWithNewNotesStructure();
            }
          },
        });
      },

      startEditingTabTitle(tab) {
        this.editingTabId = tab.id;
        this.editingTabTitle = tab.title;
        this.$nextTick(() => {
          if (this.$refs.tabTitleInput && this.$refs.tabTitleInput[0]) {
            this.$refs.tabTitleInput[0].focus();
            this.$refs.tabTitleInput[0].select();
          }
        });
      },

      saveTabTitle() {
        if (this.editingTabId && this.editingTabTitle.trim()) {
          const tab = this.currentContractNotes.find(
            (t) => t.id === this.editingTabId
          );
          if (tab) {
            tab.title = this.editingTabTitle.trim();
            this.saveContractWithNewNotesStructure();
          }
        }
        this.cancelEditingTabTitle();
      },

      cancelEditingTabTitle() {
        this.editingTabId = null;
        this.editingTabTitle = "";
      },

      async saveContractWithNewNotesStructure() {
        const contractId = this.selectedContractDetails?.id;
        if (!contractId) return;

        const contractIndex = this.contracts.findIndex(
          (c) => c.id === contractId
        );
        if (contractIndex === -1) return;

        const contractToUpdate = JSON.parse(
          JSON.stringify(this.contracts[contractIndex])
        );

        contractToUpdate.significantNotes = JSON.parse(
          JSON.stringify(this.currentContractNotes)
        );

        try {
          await databaseService.db.contracts.put(contractToUpdate);

          this.contracts[contractIndex] = contractToUpdate;
        } catch (error) {
          console.error("Error saving new notes structure:", error);
          this.showToast(this.t("errorSavingChanges"), "error");
        }
      },
      handleNotesKeystroke(event) {
        if (
          (event.ctrlKey || event.metaKey) &&
          event.key.toLowerCase() === "b"
        ) {
          event.preventDefault();
          this.formatDoc("bold");
          return;
        }

        if (
          (event.ctrlKey || event.metaKey) &&
          event.key.toLowerCase() === "s"
        ) {
          event.preventDefault();
          if (this.isNotesEditing) {
            this.saveNotes();
          }
          return;
        }

        if (
          event.key === "Tab" ||
          (event.key === "Enter" && (event.ctrlKey || event.metaKey))
        ) {
          const selection = window.getSelection();
          if (!selection.rangeCount) return;

          let node = selection.anchorNode;
          if (node.nodeType === 3) node = node.parentNode;

          const cell = node.closest("td, th");

          if (cell) {
            const row = cell.closest("tr");
            const table = row.closest("table");

            if (row && table) {
              const cells = Array.from(row.querySelectorAll("td, th"));
              const isLastCell = cells.indexOf(cell) === cells.length - 1;

              const rows = Array.from(table.querySelectorAll("tr"));
              const isLastRow = rows.indexOf(row) === rows.length - 1;

              if (event.key === "Tab" && !event.shiftKey) {
                if (isLastCell && isLastRow) {
                  event.preventDefault();
                  this.addTableRow(table, row);
                }
              } else if (
                event.key === "Enter" &&
                (event.ctrlKey || event.metaKey)
              ) {
                event.preventDefault();
                this.addTableRow(table, row);
              }
            }
          }
        }
      },

      addTableRow(table, currentRow) {
        const newRow = currentRow.cloneNode(true);

        const newCells = newRow.querySelectorAll("td, th");
        newCells.forEach((cell) => {
          cell.innerHTML = "<br>";
        });

        const parent = currentRow.parentNode;
        if (currentRow.nextSibling) {
          parent.insertBefore(newRow, currentRow.nextSibling);
        } else {
          parent.appendChild(newRow);
        }

        this.$nextTick(() => {
          const firstCell = newRow.querySelector("td, th");
          if (firstCell) {
            const range = document.createRange();
            const sel = window.getSelection();

            range.setStart(firstCell, 0);
            range.collapse(true);

            sel.removeAllRanges();
            sel.addRange(range);

            firstCell.scrollIntoView({
              block: "nearest",
              behavior: "smooth",
            });
          }

          this.updateNotesContent({ target: this.$refs.notesEditor });
        });
      },
      downloadCategoryTemplate() {
        const headers = [
          "code",
          "name_vi",
          "name_en",
          "level",
          "parentCode",
        ];
        const ws = XLSX.utils.json_to_sheet([], { header: headers });
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Categories");
        XLSX.writeFile(wb, "report_categories_template.xlsx");
      },

      triggerCategoryUpload() {
        this.$refs.uploadCategoryInput.click();
      },

      handleCategoryUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const workbook = XLSX.read(new Uint8Array(e.target.result), {
              type: "array",
            });
            const sheet =
              workbook.Sheets["Categories"] ||
              workbook.Sheets[workbook.SheetNames[0]];
            if (!sheet) {
              this.showToast(
                this.t("errorSheetNotFound", { sheetName: "Categories" }),
                "error"
              );
              return;
            }
            const rows = XLSX.utils.sheet_to_json(sheet, { defval: null });

            let toAdd = [];
            let toUpdate = [];
            let skippedCount = 0;

            const existingCodes = new Map(
              this.reportCategoriesFromDB.map((c) => [c.code, c])
            );

            for (const row of rows) {
              const code = row.code?.trim();
              const name_vi = row.name_vi?.trim();

              if (!code || !name_vi) {
                skippedCount++;
                continue;
              }

              const categoryData = {
                code: code,
                name_vi: name_vi,
                name_en: row.name_en?.trim() || "",
                level: parseInt(row.level) === 2 ? 2 : 1,
                parentCode:
                  parseInt(row.level) === 2 ? row.parentCode?.trim() : null,
              };

              const existing = existingCodes.get(code);
              if (existing) {
                toUpdate.push({ ...existing, ...categoryData });
              } else {
                toAdd.push(categoryData);
              }
            }

            if (toAdd.length > 0 || toUpdate.length > 0) {
              await databaseService.db.transaction(
                "rw",
                databaseService.db.categories,
                async () => {
                  if (toAdd.length > 0)
                    await databaseService.db.categories.bulkAdd(
                      JSON.parse(JSON.stringify(toAdd))
                    );
                  if (toUpdate.length > 0)
                    await databaseService.db.categories.bulkPut(
                      JSON.parse(JSON.stringify(toUpdate))
                    );
                }
              );

              this.reportCategoriesFromDB =
                await databaseService.db.categories.toArray();

              let message = this.t("categoryUploadSuccess", {
                added: toAdd.length,
                updated: toUpdate.length,
              });
              if (skippedCount > 0) {
                message +=
                  " " +
                  this.t("categoryUploadSkipped", {
                    skipped: skippedCount,
                  });
              }
              this.showToast(message, "success");
            } else if (skippedCount > 0) {
              this.showToast(
                this.t("categoryUploadSkipped", { skipped: skippedCount }),
                "warning"
              );
            } else {
              this.showToast(this.t("noValidDataFound"), "info");
            }
          } catch (error) {
            console.error("Lỗi khi tải lên file hạng mục:", error);
            this.showToast(this.t("errorProcessingExcel"), "error");
          } finally {
            event.target.value = "";
          }
        };
        reader.readAsArrayBuffer(file);
      },

      exportCategories() {
        if (this.reportCategoriesFromDB.length === 0) {
          this.showToast(this.t("errorNoCategoryDataToExport"), "warning");
          return;
        }

        const dataToExport = this.displayCategories.map((cat) => ({
          code: cat.code,
          name_vi: cat.name_vi,
          name_en: cat.name_en,
          level: cat.level,
          parentCode: cat.parentCode,
        }));

        const ws = XLSX.utils.json_to_sheet(dataToExport);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Categories");
        XLSX.writeFile(
          wb,
          `Report_Categories_Export_${appUtils.format.date(
            new Date()
          )}.xlsx`
        );
        this.showToast(this.t("categoryExportSuccess"), "success");
      },

      openCategoryModal(mode = "add", category = null) {
        this.categoryModalMode = mode;
        if (mode === "add") {
          this.currentEditCategory = {
            code: "",
            name_vi: "",
            name_en: "",
            level: 1,
            parentCode: null,
          };
        } else {
          this.currentEditCategory = JSON.parse(JSON.stringify(category));
        }
        appUtils.ui.toggleModal("categoryManagementModal", "show");
      },

      closeCategoryModal() {
        appUtils.ui.toggleModal("categoryManagementModal", "hide");
        this.currentEditCategory = null;
      },

      async saveCategory() {
        if (!this.currentEditCategory) return;
        const category = this.currentEditCategory;

        if (!category.code || !category.name_vi) {
          this.showToast(this.t("errorCategoryRequired"), "error");
          return;
        }

        const isDuplicate = this.reportCategoriesFromDB.some(
          (c) =>
            c.code.toLowerCase() === category.code.toLowerCase() &&
            c.id !== category.id
        );
        if (isDuplicate) {
          this.showToast(
            this.t("errorCategoryCodeExists", { code: category.code }),
            "error"
          );
          return;
        }

        category.level = category.parentCode ? 2 : 1;

        try {
          const categoryToSave = JSON.parse(JSON.stringify(category));
          if (this.categoryModalMode === "add") {
            delete categoryToSave.id;
            await databaseService.db.categories.add(categoryToSave);
            this.showToast(this.t("categoryAddSuccess"), "success");
          } else {
            await databaseService.db.categories.put(categoryToSave);
            this.showToast(this.t("categoryUpdateSuccess"), "success");
          }

          this.reportCategoriesFromDB =
            await databaseService.db.categories.toArray();
          this.closeCategoryModal();
        } catch (error) {
          console.error("Lỗi khi lưu hạng mục:", error);
          this.showToast(this.t("categorySaveFailed"), "error");
        }
      },

      deleteCategory(category) {
        if (this.categoryUsageCount[category.code] > 0) {
          this.showToast(this.t("errorCategoryInUse"), "error");
          return;
        }

        let itemsToDelete = [category];
        let message = this.t("confirmDeleteCategory", {
          code: category.code,
          name: category.name_vi,
        });

        if (category.level === 1) {
          const children = this.reportCategoriesFromDB.filter(
            (c) => c.parentCode === category.code
          );
          if (children.length > 0) {
            const childrenInUse = children.some(
              (c) => this.categoryUsageCount[c.code] > 0
            );
            if (childrenInUse) {
              this.showToast(this.t("errorDeleteParentInUse"), "error");
              return;
            }
            itemsToDelete.push(...children);
            message +=
              "<br><br>" +
              this.t("warningDeleteParentCategory", {
                count: children.length,
              });
          }
        }

        appUtils.ui.showConfirmation(this, {
          title: this.t("confirmDeletion"),
          message: message,
          onConfirm: async () => {
            try {
              const idsToDelete = itemsToDelete.map((item) => item.id);
              await databaseService.db.categories.bulkDelete(idsToDelete);

              this.reportCategoriesFromDB =
                this.reportCategoriesFromDB.filter(
                  (c) => !idsToDelete.includes(c.id)
                );

              this.showToast(this.t("categoryDeleteSuccess"), "success");
            } catch (error) {
              console.error("Lỗi khi xóa hạng mục:", error);
              this.showToast(this.t("categoryDeleteFailed"), "error");
            }
          },
        });
      },

      async seedInitialCategories() {
        try {
          const categoryCount = await databaseService.db.categories.count();
          if (categoryCount === 0) {
            console.log(
              "Seeding initial report categories into the database..."
            );

            const defaultReportStructure = [
              {
                code: "11",
                name_vi: "CHI PHÍ MUA BÁN VÀ SÁP NHẬP (M&A)",
                name_en: "M&A COST",
                level: 1,
                children: [
                  {
                    code: "11.1",
                    name_vi: "Chi phí mua vốn",
                    name_en: "Capital Purchase Cost",
                    level: 2,
                  },
                  {
                    code: "11.2",
                    name_vi: "Chi phí mua đất, đền bù",
                    name_en: "Land Purchase & Compensation Cost",
                    level: 2,
                  },
                  {
                    code: "11.3",
                    name_vi: "Chi phí chuyển nhượng dự án",
                    name_en: "Project Transfer Cost",
                    level: 2,
                  },
                  {
                    code: "11.99",
                    name_vi: "Chi phí khác mua bán và sáp nhập khác",
                    name_en: "Other M&A Cost",
                    level: 2,
                  },
                ],
              },
              {
                code: "12",
                name_vi: "CHI PHÍ SỬ DỤNG ĐẤT",
                name_en: "LAND USE COST",
                level: 1,
                children: [
                  {
                    code: "12.1",
                    name_vi: "Trị giá quyền sử dụng đất",
                    name_en: "Land Use Right Value",
                    level: 2,
                  },
                  {
                    code: "12.99",
                    name_vi: "Chi phí sử dụng đất khác",
                    name_en: "Other Land Use Cost",
                    level: 2,
                  },
                ],
              },
              {
                code: "13",
                name_vi: "HẠNG MỤC TRƯỚC XÂY DỰNG",
                name_en: "PRE-CONSTRUCTION",
                level: 1,
                children: [
                  {
                    code: "13.1",
                    name_vi: "Rà phá bom mìn",
                    name_en: "Bomb & Mine Clearance",
                    level: 2,
                  },
                  {
                    code: "13.2",
                    name_vi: "Hàng rào & chốt bảo vệ tạm dự án",
                    name_en: "Temporary Fencing & Security",
                    level: 2,
                  },
                  {
                    code: "13.3",
                    name_vi: "Dọn dẹp, phát quang & tháo dỡ",
                    name_en: "Site Clearance & Demolition",
                    level: 2,
                  },
                  {
                    code: "13.4",
                    name_vi: "Dịch vụ bảo vệ",
                    name_en: "Security Service",
                    level: 2,
                  },
                  {
                    code: "13.5",
                    name_vi: "Bảo hiểm rủi ro trong xây dựng",
                    name_en: "Construction All Risk Insurance",
                    level: 2,
                  },
                  {
                    code: "13.6",
                    name_vi: "Văn phòng tạm",
                    name_en: "Temporary Office",
                    level: 2,
                  },
                  {
                    code: "13.7",
                    name_vi:
                      "Điện nước tạm phục vụ thi công, chống sét tạm",
                    name_en: "Temporary Utilities",
                    level: 2,
                  },
                  {
                    code: "13.8",
                    name_vi: "Di dời, ngầm hóa hệ thống điện, viễn thông",
                    name_en: "Utility Relocation",
                    level: 2,
                  },
                  {
                    code: "13.9",
                    name_vi:
                      "Xin phép phục vụ thi công (đấu nối giao thông, qua",
                    name_en: "Construction Permits",
                    level: 2,
                  },
                  {
                    code: "13.10",
                    name_vi: "Kiểm định",
                    name_en: "Inspection",
                    level: 2,
                  },
                  {
                    code: "13.11",
                    name_vi: "Đo vẽ, Khảo sát",
                    name_en: "Surveying",
                    level: 2,
                  },
                  {
                    code: "13.99",
                    name_vi: "Hạng mục trước xây dựng khác",
                    name_en: "Other Pre-construction",
                    level: 2,
                  },
                ],
              },
              {
                code: "14",
                name_vi: "HẠ TẦNG KỸ THUẬT",
                name_en: "INFRASTRUCTURE",
                level: 1,
                children: [
                  {
                    code: "14.1",
                    name_vi: "San lấp, nạo vét bùn",
                    name_en: "Land Filling, Dredging",
                    level: 2,
                  },
                  {
                    code: "14.2",
                    name_vi: "Tường chắn",
                    name_en: "Retaining Wall",
                    level: 2,
                  },
                  {
                    code: "14.3",
                    name_vi: "Thi công đê, kè",
                    name_en: "Dike, Embankment Construction",
                    level: 2,
                  },
                  {
                    code: "14.4",
                    name_vi: "Thi công cầu",
                    name_en: "Bridge Construction",
                    level: 2,
                  },
                  {
                    code: "14.5",
                    name_vi: "Hàng rào, cổng chào, bảng hiệu & nhà bảo vệ",
                    name_en: "Fence, Gate, Signage",
                    level: 2,
                  },
                  {
                    code: "14.6",
                    name_vi: "Hạ tầng kỹ thuật giao thông",
                    name_en: "Transportation Infrastructure",
                    level: 2,
                  },
                  {
                    code: "14.7",
                    name_vi:
                      "Hạ tầng đường giao thông, vỉa hè, thoát nước mưa,",
                    name_en: "Roads, Pavements, Drainage",
                    level: 2,
                  },
                  {
                    code: "14.8",
                    name_vi: "Hạ tầng kỹ thuật cơ điện",
                    name_en: "M&E Infrastructure",
                    level: 2,
                  },
                  {
                    code: "14.9",
                    name_vi: "Hạ tầng viễn thông",
                    name_en: "Telecommunication Infrastructure",
                    level: 2,
                  },
                  {
                    code: "14.10",
                    name_vi: "Công nghệ xử lý nước thải",
                    name_en: "Wastewater Treatment",
                    level: 2,
                  },
                  {
                    code: "14.11",
                    name_vi: "Hệ thống camera quan sát & barrier",
                    name_en: "CCTV & Barrier System",
                    level: 2,
                  },
                  {
                    code: "14.99",
                    name_vi: "Hạ tầng kỹ thuật khác",
                    name_en: "Other Infrastructure",
                    level: 2,
                  },
                ],
              },
              {
                code: "15",
                name_vi: "CỌC, TƯỜNG VÂY",
                name_en: "PILING, DIAPHRAGM WALL",
                level: 1,
                children: [
                  {
                    code: "15.1",
                    name_vi: "Cọc, tường vây",
                    name_en: "Piling, Diaphragm Wall",
                    level: 2,
                  },
                  {
                    code: "15.2",
                    name_vi: "Thép cọc, tường vây",
                    name_en: "Steel for Piling",
                    level: 2,
                  },
                  {
                    code: "15.3",
                    name_vi: "Thép Kingpost",
                    name_en: "Kingpost Steel",
                    level: 2,
                  },
                  {
                    code: "15.4",
                    name_vi: "Bê tông cọc, tường vây",
                    name_en: "Concrete for Piling",
                    level: 2,
                  },
                  {
                    code: "15.99",
                    name_vi: "Cọc, tường vây khác",
                    name_en: "Other Piling Works",
                    level: 2,
                  },
                ],
              },
              {
                code: "16",
                name_vi: "KẾT CẤU, HOÀN THIỆN",
                name_en: "STRUCTURE, FINISHING",
                level: 1,
                children: [
                  {
                    code: "16.1",
                    name_vi: "Thi công kết cấu, hoàn thiện",
                    name_en: "Structure & Finishing Works",
                    level: 2,
                  },
                  {
                    code: "16.2",
                    name_vi: "Thép",
                    name_en: "Steel",
                    level: 2,
                  },
                  {
                    code: "16.3",
                    name_vi: "Bê tông",
                    name_en: "Concrete",
                    level: 2,
                  },
                  {
                    code: "16.4",
                    name_vi: "Bảng hiệu",
                    name_en: "Signage",
                    level: 2,
                  },
                  {
                    code: "16.5",
                    name_vi: "Nội thất sảnh chính, tiện ích",
                    name_en: "Lobby & Amenity Furniture",
                    level: 2,
                  },
                  {
                    code: "16.6",
                    name_vi: "Cửa gỗ, cửa sắt, phụ kiện, tủ tường",
                    name_en: "Doors, Accessories, Cabinets",
                    level: 2,
                  },
                  {
                    code: "16.7",
                    name_vi: "Gạch, đá, sàn gỗ",
                    name_en: "Tiles, Stone, Wood Flooring",
                    level: 2,
                  },
                  {
                    code: "16.8",
                    name_vi: "Sàn gỗ",
                    name_en: "Wood Flooring",
                    level: 2,
                  },
                  {
                    code: "16.9",
                    name_vi: "Tủ bếp, thiết bị bếp",
                    name_en: "Kitchen Cabinets & Equipment",
                    level: 2,
                  },
                  {
                    code: "16.10",
                    name_vi: "Thiết bị vệ sinh, máy nước nóng",
                    name_en: "Sanitary Ware, Water Heater",
                    level: 2,
                  },
                  {
                    code: "16.99",
                    name_vi: "Kết cấu, hoàn thiện khác",
                    name_en: "Other Structure & Finishing",
                    level: 2,
                  },
                ],
              },
              {
                code: "17",
                name_vi: "CẢNH QUAN",
                name_en: "LANDSCAPE",
                level: 1,
                children: [
                  {
                    code: "17.1",
                    name_vi: "Cảnh quan mềm, hệ thống tưới",
                    name_en: "Softscape, Irrigation System",
                    level: 2,
                  },
                  {
                    code: "17.2",
                    name_vi: "Hệ thống tưới",
                    name_en: "Irrigation System",
                    level: 2,
                  },
                  {
                    code: "17.3",
                    name_vi: "Cảnh quan cứng",
                    name_en: "Hardscape",
                    level: 2,
                  },
                  {
                    code: "17.4",
                    name_vi: "Thiết bị ngoài trời",
                    name_en: "Outdoor Equipment",
                    level: 2,
                  },
                  {
                    code: "17.99",
                    name_vi: "Cảnh quan khác",
                    name_en: "Other Landscape",
                    level: 2,
                  },
                ],
              },
              {
                code: "18",
                name_vi: "NHÔM KÍNH",
                name_en: "ALUMINIUM & GLASS",
                level: 1,
                children: [
                  {
                    code: "18.1",
                    name_vi: "Nhôm kính, vách kính nhà tắm",
                    name_en: "Aluminum, Glass, Partitions",
                    level: 2,
                  },
                  {
                    code: "18.2",
                    name_vi: "Kim loại",
                    name_en: "Metal Works",
                    level: 2,
                  },
                  {
                    code: "18.99",
                    name_vi: "Nhôm kính khác",
                    name_en: "Other Aluminum & Glass",
                    level: 2,
                  },
                ],
              },
              {
                code: "19",
                name_vi: "CƠ ĐIỆN",
                name_en: "M&E",
                level: 1,
                children: [
                  {
                    code: "19.2",
                    name_vi: "Thi công hệ thống PCCC",
                    name_en: "Fire Fighting System",
                    level: 2,
                  },
                  {
                    code: "19.3",
                    name_vi: "Điều hòa không khí",
                    name_en: "Air Conditioning",
                    level: 2,
                  },
                  {
                    code: "19.4",
                    name_vi: "Đèn, công tắc, ổ cắm",
                    name_en: "Lighting, Switches, Sockets",
                    level: 2,
                  },
                  {
                    code: "19.5",
                    name_vi: "Máy phát điện",
                    name_en: "Generator",
                    level: 2,
                  },
                  {
                    code: "19.6",
                    name_vi: "Hệ thống intercom",
                    name_en: "Intercom System",
                    level: 2,
                  },
                  {
                    code: "19.7",
                    name_vi: "Đèn cảnh quan và mặt dựng",
                    name_en: "Landscape & Facade Lighting",
                    level: 2,
                  },
                  {
                    code: "19.8",
                    name_vi: "Hệ thống car parking",
                    name_en: "Car Parking System",
                    level: 2,
                  },
                  {
                    code: "19.9",
                    name_vi: "Thang máy, thang cuốn",
                    name_en: "Elevator, Escalator",
                    level: 2,
                  },
                  {
                    code: "19.99",
                    name_vi: "Cơ điện khác",
                    name_en: "Other M&E",
                    level: 2,
                  },
                ],
              },
              {
                code: "20",
                name_vi: "HẠNG MỤC ĐẶC BIỆT",
                name_en: "SPECIAL CATEGORIES",
                level: 1,
                children: [
                  {
                    code: "20.1",
                    name_vi: "BMS",
                    name_en: "BMS",
                    level: 2,
                  },
                  {
                    code: "20.2",
                    name_vi: "Smart home",
                    name_en: "Smart Home",
                    level: 2,
                  },
                  {
                    code: "20.3",
                    name_vi: "FF&E",
                    name_en: "FF&E",
                    level: 2,
                  },
                  {
                    code: "20.4",
                    name_vi: "OSE, EQT",
                    name_en: "OSE, EQT",
                    level: 2,
                  },
                  {
                    code: "20.5",
                    name_vi: "Car stucker",
                    name_en: "Car Stacker",
                    level: 2,
                  },
                  {
                    code: "20.6",
                    name_vi: "Công nghệ hồ bơi",
                    name_en: "Swimming Pool Technology",
                    level: 2,
                  },
                  {
                    code: "20.7",
                    name_vi: "Smart City",
                    name_en: "Smart City",
                    level: 2,
                  },
                  {
                    code: "20.8",
                    name_vi: "Phương tiện di chuyển, vận chuyển",
                    name_en: "Transportation",
                    level: 2,
                  },
                  {
                    code: "20.99",
                    name_vi: "Trang thiết bị khác",
                    name_en: "Other Equipment",
                    level: 2,
                  },
                ],
              },
              {
                code: "21",
                name_vi: "TƯ VẤN THIẾT KẾ",
                name_en: "DESIGN CONSULTANCY",
                level: 1,
                children: [
                  {
                    code: "21.1",
                    name_vi: "Tư vấn quy hoạch",
                    name_en: "Planning Consultancy",
                    level: 2,
                  },
                  {
                    code: "21.2",
                    name_vi: "Tư vấn thiết kế kiến trúc",
                    name_en: "Architectural Design",
                    level: 2,
                  },
                  {
                    code: "21.3",
                    name_vi: "Tư vấn thiết kế kết cấu",
                    name_en: "Structural Design",
                    level: 2,
                  },
                  {
                    code: "21.4",
                    name_vi: "Tư vấn thiết kế cơ điện",
                    name_en: "M&E Design",
                    level: 2,
                  },
                  {
                    code: "21.5",
                    name_vi: "Tư vấn thiết kế hạ tầng",
                    name_en: "Infrastructure Design",
                    level: 2,
                  },
                  {
                    code: "21.6",
                    name_vi: "Tư vấn thiết kế cảnh quan",
                    name_en: "Landscape Design",
                    level: 2,
                  },
                  {
                    code: "21.7",
                    name_vi: "Tư vấn thiết kế nội thất",
                    name_en: "Interior Design",
                    level: 2,
                  },
                  {
                    code: "21.8",
                    name_vi: "Tư vấn thẩm tra, thẩm duyệt thiết kế",
                    name_en: "Design Verification",
                    level: 2,
                  },
                  {
                    code: "21.9",
                    name_vi: "Tư vấn thẩm tra, thẩm duyệt PCCC",
                    name_en: "Fire Safety Verification",
                    level: 2,
                  },
                  {
                    code: "21.10",
                    name_vi:
                      "Tư vấn lập báo cáo đánh giá tác động môi trường",
                    name_en: "EIA Consultancy",
                    level: 2,
                  },
                  {
                    code: "21.11",
                    name_vi: "Tư vấn thiết kế chiếu sáng (Lighting design)",
                    name_en: "Lighting Design",
                    level: 2,
                  },
                  {
                    code: "21.12",
                    name_vi: "Tư vấn hệ thống IT/AV",
                    name_en: "IT/AV Consultancy",
                    level: 2,
                  },
                  {
                    code: "21.13",
                    name_vi: "Tư vấn hệ thống bếp & Giặt ủi",
                    name_en: "Kitchen & Laundry Consultancy",
                    level: 2,
                  },
                  {
                    code: "21.14",
                    name_vi: "Tư vấn thiết kế 3 bộ môn",
                    name_en: "3-Discipline Design",
                    level: 2,
                  },
                  {
                    code: "21.15",
                    name_vi: "Tư vấn vận hành khách sạn",
                    name_en: "Hotel Operation Consultancy",
                    level: 2,
                  },
                  {
                    code: "21.99",
                    name_vi: "Tư vấn thiết kế khác",
                    name_en: "Other Design Consultancy",
                    level: 2,
                  },
                ],
              },
              {
                code: "22",
                name_vi: "TƯ VẤN GIÁM SÁT VÀ QUẢN LÝ DỰ ÁN",
                name_en: "SUPERVISION & PM",
                level: 1,
                children: [
                  {
                    code: "22.1",
                    name_vi: "Tư vấn quản lý dự án",
                    name_en: "Project Management",
                    level: 2,
                  },
                  {
                    code: "22.2",
                    name_vi: "Tư vấn giám sát dự án",
                    name_en: "Project Supervision",
                    level: 2,
                  },
                  {
                    code: "22.3",
                    name_vi: "Chi phí hoạt động dự án (ADM)",
                    name_en: "Project Admin Cost (ADM)",
                    level: 2,
                  },
                  {
                    code: "22.4",
                    name_vi: "Chi phí bảo hành (PDC)",
                    name_en: "Warranty Cost (PDC)",
                    level: 2,
                  },
                  {
                    code: "22.5",
                    name_vi: "Khảo sát & Chứng nhận chất lượng",
                    name_en: "Survey & Quality Certification",
                    level: 2,
                  },
                  {
                    code: "22.6",
                    name_vi: "Tư vấn khối lượng (QS)",
                    name_en: "Quantity Surveying (QS)",
                    level: 2,
                  },
                  {
                    code: "22.7",
                    name_vi: "Đo vẽ cấp sổ cho dự án",
                    name_en: "Survey for Land Title",
                    level: 2,
                  },
                  {
                    code: "22.99",
                    name_vi: "Tư vấn giám sát dự án và quản lý dự án khác",
                    name_en: "Other Supervision & PM",
                    level: 2,
                  },
                ],
              },
              {
                code: "23",
                name_vi: "MARKETING",
                name_en: "MARKETING",
                level: 1,
                children: [
                  {
                    code: "23.1",
                    name_vi:
                      "Nhà mẫu dự án (Show Flat, Sale Gallary, Show Unit…",
                    name_en: "Show Flat, Sales Gallery...",
                    level: 2,
                  },
                  {
                    code: "23.2",
                    name_vi: "Tài liệu bán hàng",
                    name_en: "Sales Materials",
                    level: 2,
                  },
                  {
                    code: "23.3",
                    name_vi: "Branding",
                    name_en: "Branding",
                    level: 2,
                  },
                  {
                    code: "23.4",
                    name_vi: "Tài liệu Marketting",
                    name_en: "Marketing Materials",
                    level: 2,
                  },
                  {
                    code: "23.5",
                    name_vi: "Truyền thông",
                    name_en: "Communication",
                    level: 2,
                  },
                  {
                    code: "23.6",
                    name_vi: "Sự kiện",
                    name_en: "Events",
                    level: 2,
                  },
                  {
                    code: "23.99",
                    name_vi: "Marketing khác",
                    name_en: "Other Marketing",
                    level: 2,
                  },
                ],
              },
              {
                code: "24",
                name_vi: "CHI PHÍ TÀI CHÍNH & VỐN HÓA",
                name_en: "FINANCIAL & CAPITALIZED COST",
                level: 1,
                children: [
                  {
                    code: "24.1",
                    name_vi: "Lãi vay vốn hóa",
                    name_en: "Capitalized Interest",
                    level: 2,
                  },
                  {
                    code: "24.2",
                    name_vi: "Lãi tiết kiệm/cho vay thu được",
                    name_en: "Interest Income",
                    level: 2,
                  },
                ],
              },
              {
                code: "25",
                name_vi: "CÔNG TRÌNH TIỆN ÍCH",
                name_en: "AMENITIES",
                level: 1,
                children: [
                  {
                    code: "25.1",
                    name_vi: "Hồ điều tiết, hồ cảnh quan",
                    name_en: "Regulating Lake, Landscape Lake",
                    level: 2,
                  },
                  {
                    code: "25.2",
                    name_vi: "Hồ bơi",
                    name_en: "Swimming Pool",
                    level: 2,
                  },
                  {
                    code: "25.3",
                    name_vi: "Khu vui chơi giải trí",
                    name_en: "Amusement Park",
                    level: 2,
                  },
                  {
                    code: "25.4",
                    name_vi: "Khu thể thao ngoài trời",
                    name_en: "Outdoor Sports Area",
                    level: 2,
                  },
                  {
                    code: "25.5",
                    name_vi: "Sân Golf",
                    name_en: "Golf Course",
                    level: 2,
                  },
                  {
                    code: "25.6",
                    name_vi: "Bến (tàu, thuyền…)",
                    name_en: "Marina",
                    level: 2,
                  },
                  {
                    code: "25.7",
                    name_vi: "Safari",
                    name_en: "Safari",
                    level: 2,
                  },
                  {
                    code: "25.8",
                    name_vi: "Sân vận động",
                    name_en: "Stadium",
                    level: 2,
                  },
                  {
                    code: "25.9",
                    name_vi: "Clubhouse",
                    name_en: "Clubhouse",
                    level: 2,
                  },
                  {
                    code: "25.10",
                    name_vi: "Welcome center",
                    name_en: "Welcome Center",
                    level: 2,
                  },
                  {
                    code: "25.11",
                    name_vi: "Nhà hội nghị",
                    name_en: "Convention Center",
                    level: 2,
                  },
                  {
                    code: "25.12",
                    name_vi: "BOH",
                    name_en: "BOH",
                    level: 2,
                  },
                  {
                    code: "25.13",
                    name_vi: "Hồ cấp nước dự án",
                    name_en: "Project Reservoir",
                    level: 2,
                  },
                  {
                    code: "25.14",
                    name_vi:
                      "Nhà máy khai thác nước ngầm/ nước mặt và đường ống",
                    name_en: "Water Plant & Pipelines",
                    level: 2,
                  },
                  {
                    code: "25.15",
                    name_vi: "Công trình tiện ích phụ trợ",
                    name_en: "Auxiliary Amenities",
                    level: 2,
                  },
                  {
                    code: "25.16",
                    name_vi: "Sport Center",
                    name_en: "Sport Center",
                    level: 2,
                  },
                ],
              },
              {
                code: "26",
                name_vi: "CHI PHÍ TIỀN KHAI TRƯƠNG",
                name_en: "PRE-OPENING COST",
                level: 1,
                children: [
                  {
                    code: "26.1",
                    name_vi: "Nhân sự và admin",
                    name_en: "HR & Admin",
                    level: 2,
                  },
                  {
                    code: "26.2",
                    name_vi: "CP hàng cung ứng vận hành",
                    name_en: "Operational Supplies",
                    level: 2,
                  },
                  {
                    code: "26.3",
                    name_vi: "CP năng lượng tiền khai trương",
                    name_en: "Pre-opening Energy Cost",
                    level: 2,
                  },
                  {
                    code: "26.4",
                    name_vi: "Công nghệ thông tin",
                    name_en: "Information Technology",
                    level: 2,
                  },
                  {
                    code: "26.5",
                    name_vi: "Trang thiết bị vận hành",
                    name_en: "Operational Equipment",
                    level: 2,
                  },
                  {
                    code: "26.6",
                    name_vi: "Trang thiết bị F&B",
                    name_en: "F&B Equipment",
                    level: 2,
                  },
                  {
                    code: "26.7",
                    name_vi: "Marketing tiền khai trương",
                    name_en: "Pre-opening Marketing",
                    level: 2,
                  },
                  {
                    code: "26.99",
                    name_vi: "Tiền khai trương khác",
                    name_en: "Other Pre-opening",
                    level: 2,
                  },
                ],
              },
              {
                code: "93",
                name_vi: "CHI PHÍ TÀI TRỢ DỰ ÁN",
                name_en: "PROJECT SPONSORSHIP COST",
                level: 1,
                children: [],
              },
              {
                code: "94",
                name_vi: "CHI PHÍ PHÁP LÝ DỰ ÁN",
                name_en: "PROJECT LEGAL COST",
                level: 1,
                children: [
                  {
                    code: "94.1",
                    name_vi:
                      "Chi phí liên quan đến đất (thủ tục pháp lý, thẩm định giá đất, )",
                    name_en: "Land-related Legal Fees",
                    level: 2,
                  },
                  {
                    code: "94.2",
                    name_vi:
                      "Chi phí liên quan thủ tục xin phép (phê duyệt 1/500; 1/2000; 1/5000…)",
                    name_en: "Permit Application Fees",
                    level: 2,
                  },
                  {
                    code: "94.3",
                    name_vi: "Hợp đồng tư vấn pháp lý",
                    name_en: "Legal Consultancy Contracts",
                    level: 2,
                  },
                ],
              },
              {
                code: "95",
                name_vi: "CHI PHÍ HOẠT ĐỘNG CHUNG DỰ ÁN",
                name_en: "GENERAL PROJECT OPERATING COST",
                level: 1,
                children: [
                  {
                    code: "95.1",
                    name_vi: "Phí điện, nước, điện thoại, internet",
                    name_en: "Utilities Fee",
                    level: 2,
                  },
                  {
                    code: "95.2",
                    name_vi:
                      "Phí & lệ phí (thuế đất, thuế đất PNN, phí, lệ phí trước bạ, thuế nhập khẩu…)",
                    name_en: "Taxes & Fees",
                    level: 2,
                  },
                  {
                    code: "95.3",
                    name_vi: "Chi phí ủng hộ, mua quà, … đưa vào dự án",
                    name_en: "Donations, Gifts...",
                    level: 2,
                  },
                  {
                    code: "95.4",
                    name_vi: "Chi phí liên quan đến bàn giao nhà",
                    name_en: "Handover Costs",
                    level: 2,
                  },
                  {
                    code: "95.5",
                    name_vi: "Chi phí linh tinh khác thuộc dự án",
                    name_en: "Other Miscellaneous Costs",
                    level: 2,
                  },
                ],
              },
              {
                code: "96",
                name_vi: "CHI PHÍ BẢO HÀNH, BẢO TRÌ",
                name_en: "WARRANTY & MAINTENANCE COST",
                level: 1,
                children: [],
              },
              {
                code: "97",
                name_vi: "CHI PHÍ VẬN HÀNH BÙ LỖ THỜI GIAN ĐẦU",
                name_en: "INITIAL OPERATING LOSS",
                level: 1,
                children: [],
              },
              {
                code: "98",
                name_vi: "PHÍ TƯ VẤN & THIẾT KẾ KHÁC",
                name_en: "OTHER CONSULTANCY & DESIGN FEES",
                level: 1,
                children: [
                  {
                    code: "98.1",
                    name_vi: "Tư vấn phiên biện dự án",
                    name_en: "Project Defense Consultancy",
                    level: 2,
                  },
                  {
                    code: "98.2",
                    name_vi: "Tư vấn nội bộ",
                    name_en: "Internal Consultancy",
                    level: 2,
                  },
                  {
                    code: "98.3",
                    name_vi: "Phí tư vấn khác",
                    name_en: "Other Consultancy Fees",
                    level: 2,
                  },
                ],
              },
              {
                code: "99",
                name_vi: "CHI PHÍ CHƯA XÁC ĐỊNH",
                name_en: "UNIDENTIFIED COST",
                level: 1,
                children: [
                  {
                    code: "99.99",
                    name_vi: "Chi phí dự phòng",
                    name_en: "Contingency Cost",
                    level: 2,
                  },
                ],
              },
            ];

            const categoriesToSeed = [];
            defaultReportStructure.forEach((parent) => {
              categoriesToSeed.push({
                code: parent.code,
                name_vi: parent.name_vi,
                name_en: parent.name_en,
                level: parent.level,
                parentCode: null,
              });
              if (parent.children && parent.children.length > 0) {
                parent.children.forEach((child) => {
                  categoriesToSeed.push({
                    code: child.code,
                    name_vi: child.name_vi,
                    name_en: child.name_en,
                    level: child.level,
                    parentCode: parent.code,
                  });
                });
              }
            });

            await databaseService.db.categories.bulkAdd(categoriesToSeed);
            console.log(
              `Seeded ${categoriesToSeed.length} categories successfully.`
            );
          } else {
            console.log(
              "Categories table already populated. Skipping seed."
            );
          }
        } catch (error) {
          console.error("Failed to seed initial categories:", error);
        }
      },
      _recalculateAllDetailRowsAfterLoad() {
        const allContractIds = Array.from(new Set(this.contracts.map((c) => c.id)));
        if (allContractIds.length === 0) return;

        const allRecalculatedRows = [];
        const contractMap = this.contractMap;

        // Sử dụng kỹ thuật xử lý không chặn luồng (Non-blocking loop)
        let index = 0;
        const processNextContract = () => {
          if (index < allContractIds.length) {
            const contractId = allContractIds[index];
            const contract = contractMap.get(contractId);
            let tableData = this.cpcDetailRows
              .filter((row) => row.contractId === contractId)
              .sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));

            if (tableData.length > 0 && contract) {
              // Sync thanh toán và tính toán lại
              this.syncPaymentsToDetails(contractId, null, tableData);
              const recalculated = this.runCalculationEngine(tableData, contract);
              allRecalculatedRows.push(...recalculated);
            }

            index++;
            // Cứ sau mỗi hợp đồng, trả lại quyền điều khiển cho trình duyệt 1ms để tránh treo UI
            setTimeout(processNextContract, 1);
          } else {
            // Khi đã tính xong tất cả
            const orphanRows = this.cpcDetailRows.filter(
              (row) => !new Set(allContractIds).has(row.contractId)
            );
            this.cpcDetailRows = [...allRecalculatedRows, ...orphanRows];
            console.log(
              `Global recalculation finished. Processed rows for ${allContractIds.size} contracts.`
            );
          }
        };

        processNextContract();
      },

      async navigateDetailModal(direction) {
        const saveSuccess = await this.saveContractDetails(false);
        if (!saveSuccess) {
          this.showToast("Lỗi khi lưu, không thể di chuyển.", "error");
          return;
        }

        const contractId =
          this.viewStates.cpcDetails.filter.selectedContractId;
        const currentTable = this.cpcDetailRows
          .filter((r) => r.contractId === contractId)
          .sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));

        let nextIndex;
        if (direction === "next") {
          nextIndex = this.currentDetailIndex + 1;
        } else {
          nextIndex = this.currentDetailIndex - 1;
        }

        if (nextIndex >= 0 && nextIndex < currentTable.length) {
          const nextItem = currentTable[nextIndex];
          this.openContractDetailsModal(nextItem, nextIndex);
        } else {
          this.showToast(
            direction === "next"
              ? "Đã ở dòng cuối cùng."
              : "Đã ở dòng đầu tiên.",
            "info",
            2000
          );
        }
      },

      handleCpcSendClick(event, item) {
        if (event.ctrlKey || event.metaKey) {
          this.sendAllCpcsForContract();
        } else {
          this.sendCpcToTracking(item);
        }
      },

      async sendAllCpcsForContract() {
        const contractId =
          this.viewStates.cpcDetails.filter.selectedContractId;
        const contractInfo = this.selectedContractDetails;

        if (!contractId || !contractInfo) {
          this.showToast(this.t("errorSelectContractAction"), "warning");
          return;
        }

        const allRowsForContract = this.cpcDetailRows.filter(
          (row) => row.contractId === contractId && row.cpcNo
        );

        if (allRowsForContract.length === 0) {
          this.showToast(this.t("infoNoCpcToSend"), "info");
          return;
        }

        const groupedByCpc = allRowsForContract.reduce((acc, row) => {
          if (!acc[row.cpcNo]) {
            acc[row.cpcNo] = [];
          }
          acc[row.cpcNo].push(row);
          return acc;
        }, {});

        const cpcKeys = Object.keys(groupedByCpc);

        appUtils.ui.showConfirmation(this, {
          title: this.t("confirmBulkSendTitle"),
          message: this.t("confirmBulkSendMessage", {
            count: cpcKeys.length,
            contractNo: contractInfo.contractNo,
          }),
          confirmButtonText: this.t("btnConfirmSendAll"),
          confirmButtonClass: "btn-primary",
          onConfirm: async () => {
            try {
              let cpcsToAdd = [];
              let cpcsToUpdate = [];
              let allUpdatedDetailRows = [];
              let firstCpcId = null;

              for (const cpcNo of cpcKeys) {
                const rows = groupedByCpc[cpcNo];
                const aggregatedData = this._aggregateCpcDataFromDetailRows(
                  rows,
                  contractInfo.currency === "USD"
                );

                const existingCpc = this.cpcItems.find(
                  (c) =>
                    c.contractId === contractId && c.cpcIdentifier === cpcNo
                );

                if (existingCpc) {
                  const cpcToUpdate = { ...existingCpc };
                  if (contractInfo.currency === "USD") {
                    cpcToUpdate.amountUsd = aggregatedData.amountDue;
                  } else {
                    cpcToUpdate.amountExclVAT = aggregatedData.amountDue;
                    cpcToUpdate.vatAmount = aggregatedData.vatAmount;
                    cpcToUpdate.amount = aggregatedData.finalAmount;
                  }
                  if (aggregatedData.finalContents)
                    cpcToUpdate.contents = aggregatedData.finalContents;
                  if (aggregatedData.paymentDueDate)
                    cpcToUpdate.paymentDueDate =
                      aggregatedData.paymentDueDate;

                  cpcsToUpdate.push(cpcToUpdate);
                  if (!firstCpcId) firstCpcId = cpcToUpdate.id;
                  rows.forEach((row) => (row.linkedCpcId = cpcToUpdate.id));
                } else {
                  const cpcToAdd = {
                    contractId: contractInfo.id,
                    cpcIdentifier: cpcNo,
                    contents: aggregatedData.finalContents,
                    amount:
                      contractInfo.currency === "USD"
                        ? 0
                        : aggregatedData.finalAmount,
                    amountExclVAT:
                      contractInfo.currency === "USD"
                        ? 0
                        : aggregatedData.amountDue,
                    vatAmount: aggregatedData.vatAmount,
                    amountUsd:
                      contractInfo.currency === "USD"
                        ? aggregatedData.amountDue
                        : 0,
                    exchangeRate: 0,
                    receivedDate: "",
                    paymentDueDate: aggregatedData.paymentDueDate,

                    projectId: contractInfo.projectId,
                    vendorId: contractInfo.vendorId,
                    code: contractInfo.code,
                    department: contractInfo.department,
                    contractSystemNo: contractInfo.contractSystemNo,

                    lineTracking: "",
                    notes: "",
                    isExpanded: false,
                  };
                  cpcsToAdd.push(cpcToAdd);
                }
                allUpdatedDetailRows.push(...rows);
              }

              await databaseService.db.transaction(
                "rw",
                databaseService.db.cpcItems,
                databaseService.db.cpcDetailRows,
                async () => {
                  if (cpcsToUpdate.length > 0) {
                    await databaseService.db.cpcItems.bulkPut(
                      JSON.parse(JSON.stringify(cpcsToUpdate))
                    );
                  }
                  if (cpcsToAdd.length > 0) {
                    const newIds =
                      await databaseService.db.cpcItems.bulkAdd(
                        JSON.parse(JSON.stringify(cpcsToAdd)),
                        { allKeys: true }
                      );
                    cpcsToAdd.forEach((cpc, index) => {
                      cpc.id = newIds[index];
                      if (!firstCpcId) firstCpcId = cpc.id;
                      allUpdatedDetailRows
                        .filter((row) => row.cpcNo === cpc.cpcIdentifier)
                        .forEach((row) => (row.linkedCpcId = cpc.id));
                    });
                  }
                  if (allUpdatedDetailRows.length > 0) {
                    await databaseService.db.cpcDetailRows.bulkPut(
                      JSON.parse(JSON.stringify(allUpdatedDetailRows))
                    );
                  }
                }
              );

              cpcsToUpdate.forEach((updatedCpc) => {
                const index = this.cpcItems.findIndex(
                  (c) => c.id === updatedCpc.id
                );
                if (index > -1) this.cpcItems[index] = updatedCpc;
              });
              this.cpcItems.unshift(...cpcsToAdd);

              allUpdatedDetailRows.forEach((updatedRow) => {
                const index = this.cpcDetailRows.findIndex(
                  (r) => r.id === updatedRow.id
                );
                if (index > -1) this.cpcDetailRows[index] = updatedRow;
              });

              this.showToast(
                this.t("successBulkCpcSent", { count: cpcKeys.length }),
                "success"
              );
            } catch (error) {
              console.error("Lỗi khi gửi hàng loạt CPC:", error);
              this.showToast(this.t("errorBulkCpcFailed"), "error");
            }
          },
        });
      },

      _aggregateCpcDataFromDetailRows(rows, isUsdContract) {
        const aggregated = rows.reduce(
          (acc, row) => {
            acc.amountDue += row.cpcAmountDue || 0;
            acc.vatAmount += isUsdContract ? 0 : row.cpcVat || 0;
            if (row.description) {
              acc.descriptions.add(row.description);
            }
            if (
              row.cpcDueDate &&
              (!acc.paymentDueDate || row.cpcDueDate < acc.paymentDueDate)
            ) {
              acc.paymentDueDate = row.cpcDueDate;
            }
            return acc;
          },
          {
            amountDue: 0,
            vatAmount: 0,
            descriptions: new Set(),
            paymentDueDate: null,
          }
        );
        aggregated.finalContents = Array.from(aggregated.descriptions).join(
          "; "
        );
        aggregated.finalAmount =
          aggregated.amountDue + aggregated.vatAmount;
        return aggregated;
      },

      openProjectModal(mode = "add", project = null) {
        this.projectModalMode = mode;
        if (mode === "add") {
          this.currentEditProject = { name: "" };
        } else {
          this.currentEditProject = JSON.parse(JSON.stringify(project));
        }
        appUtils.ui.toggleModal("projectManagementModal", "show");
      },

      closeProjectModal() {
        appUtils.ui.toggleModal("projectManagementModal", "hide");
        this.currentEditProject = null;
      },

      async saveProject() {
        if (
          !this.currentEditProject ||
          !this.currentEditProject.name.trim()
        ) {
          this.showToast(this.t("errorProjectNameRequired"), "error");
          return;
        }

        const name = this.currentEditProject.name.trim();

        const isDuplicate = this.projects.some(
          (p) =>
            p.name.toLowerCase() === name.toLowerCase() &&
            p.id !== this.currentEditProject.id
        );

        if (isDuplicate) {
          this.showToast(
            this.t("errorProjectNameExists", { name: name }),
            "error"
          );
          return;
        }

        const projectToSave = JSON.parse(
          JSON.stringify(this.currentEditProject)
        );

        try {
          if (this.projectModalMode === "add") {
            delete projectToSave.id;
            const newId = await databaseService.db.projects.add(
              projectToSave
            );
            projectToSave.id = newId;
            this.projects.push(projectToSave);
            this.showToast(this.t("projectAddSuccess"), "success");
          } else {
            await databaseService.updateProject(projectToSave);

            const index = this.projects.findIndex(
              (p) => p.id === projectToSave.id
            );
            if (index !== -1) {
              this.projects[index] = projectToSave;
            }
            this.showToast(this.t("projectUpdateSuccess"), "success");
          }

          this.closeProjectModal();
        } catch (error) {
          console.error("Lỗi khi lưu dự án:", error);
          this.showToast(this.t("projectSaveError"), "error");
        }
      },

      triggerReactivity() {
        this.dataVersion++;
        console.log(
          `Data version incremented to: ${this.dataVersion}. Forcing UI update.`
        );
      },

      handlePaginationShortcut(event) {
        if (
          event.altKey &&
          (event.key === "ArrowRight" || event.key === "ArrowLeft")
        ) {
          event.preventDefault();

          let state = null;
          let totalPages = 1;

          switch (this.currentTab) {
            case "cpc-tracking":
              state = this.viewStates.cpcTracking;
              totalPages = this.totalPages;
              break;
            case "cpc-dashboard":
              state = this.viewStates.paymentDashboard;
              totalPages = this.dashboardTotalPages;
              break;
            case "cpc-swap-dashboard":
              state = this.viewStates.swapDashboard;
              totalPages = this.swapDashboardTotalPages;
              break;
            case "cpc-bond-dashboard":
              state = this.viewStates.bondDashboard;
              totalPages = this.bondDashboardTotalPages;
              break;
            case "cpc-contract-dashboard":
              state = this.viewStates.contractDashboard;
              totalPages = this.contractDashboardTotalPages;
              break;
            case "vendor-balance":
              state = this.viewStates.vendorBalance;
              totalPages = this.vendorBalanceTotalPages;
              break;
            case "cogs-dashboard":
              state = this.viewStates.cogsDashboard;
              totalPages = this.cogsDashboardTotalPages;
              break;
            case "master-data":
              if (this.masterData.activeSubTab === "vendors") {
                state = this.masterData.vendors;
                totalPages = this.vendorTotalPages;
              } else if (this.masterData.activeSubTab === "projects") {
                state = this.masterData.projects;
                totalPages = this.projectTotalPages;
              }
              break;
          }

          if (state) {
            if (
              event.key === "ArrowRight" &&
              state.currentPage < totalPages
            ) {
              state.currentPage++;
            } else if (event.key === "ArrowLeft" && state.currentPage > 1) {
              state.currentPage--;
            }
          }
        }
      },

      handleFilterToggleShortcut: function (event) {
        if (event.altKey && event.key.toLowerCase() === "f") {
          event.preventDefault();

          let targetState = null;
          switch (this.currentTab) {
            case "cpc-tracking":
              targetState = this.viewStates.cpcTracking;
              break;
            case "cpc-details":
              targetState = this.viewStates.cpcDetails;
              break;
            case "vendor-balance":
              targetState = this.viewStates.vendorBalance;
              break;
            case "cpc-dashboard":
              targetState = this.viewStates.paymentDashboard;
              break;
            case "cpc-swap-dashboard":
              targetState = this.viewStates.swapDashboard;
              break;
            case "cpc-bond-dashboard":
              targetState = this.viewStates.bondDashboard;
              break;
            case "cpc-contract-dashboard":
              targetState = this.viewStates.contractDashboard;
              break;
            case "cogs-dashboard":
              targetState = this.viewStates.cogsDashboard;
              break;
          }

          if (targetState) {
            this.toggleFilterPanel(targetState);
          }
        }
      },

      toggleNotificationDropdown() {
        const bellButton = this.$refs.notificationBellButton;
        if (bellButton) {
          const dropdownInstance =
            bootstrap.Dropdown.getOrCreateInstance(bellButton);
          dropdownInstance.toggle();
        }
      },
      toggleProjectQuickFilter(forceState = null) {
        this.isProjectQuickFilterVisible =
          forceState !== null
            ? forceState
            : !this.isProjectQuickFilterVisible;

        if (this.isProjectQuickFilterVisible) {
          this.projectQuickFilterSearch = "";
          this.activeProjectQuickFilterIndex = 0;
          this.$nextTick(() => {
            this.$refs.projectQuickFilterInput?.focus();
          });
        }
      },

      navigateProjectQuickFilter(direction) {
        const itemCount = this.filteredProjectsForQuickFilter.length;
        if (itemCount === 0) return;

        if (direction === "down") {
          this.activeProjectQuickFilterIndex =
            (this.activeProjectQuickFilterIndex + 1) % itemCount;
        } else if (direction === "up") {
          this.activeProjectQuickFilterIndex =
            (this.activeProjectQuickFilterIndex - 1 + itemCount) %
            itemCount;
        }

        this.$nextTick(() => {
          const list = this.$refs.projectQuickFilterInput
            ?.closest(".command-palette-dialog")
            ?.querySelector(".command-results-list");
          const activeItem = list?.querySelector(
            ".command-result-item.active"
          );

          if (activeItem) {
            activeItem.scrollIntoView({
              block: "nearest",
            });
          }
        });
      },

      toggleProjectSelection(project) {
        if (!project) return;

        const filter = this.viewStates.cpcTracking.filter;

        if (project.id === "all") {
          filter.projectId = [];
          return;
        }

        const index = filter.projectId.indexOf(project.id);

        if (index > -1) {
          filter.projectId.splice(index, 1);
        } else {
          filter.projectId.push(project.id);
        }
      },
      validateDates(item, dateFields) {
        if (!item) return true;

        for (const field of dateFields) {
          const dateStr = item[field];
          if (dateStr && !appUtils.validation.isValidDateString(dateStr)) {
            const fieldLabel = this.t(field.toLowerCase()) || field;
            this.showToast(
              this.t("errorDateInvalidField", {
                dateStr: dateStr,
                field: this.t(field.toLowerCase()) || field,
              }),
              "error",
              6000
            );
            return false;
          }
        }

        if (item.installments && item.installments.length > 0) {
          for (const inst of item.installments) {
            if (
              (inst.date &&
                !appUtils.validation.isValidDateString(inst.date)) ||
              (inst.swapDueDatePayment &&
                !appUtils.validation.isValidDateString(
                  inst.swapDueDatePayment
                ))
            ) {
              this.showToast(
                this.t("errorDateInvalidInstallment"),
                "error",
                6000
              );
              return false;
            }
          }
        }

        return true;
      },

      updateNotesContent(event) {
        this.currentNotesContent = event.target.innerHTML;
      },

      async runFullResync() {
        appUtils.ui.showConfirmation(this, {
          title: this.t("confirmResyncTitle"),
          message: this.t("confirmResyncMessage"),
          confirmButtonClass: "btn-info",
          confirmButtonText: this.t("btnStart"),
          onConfirm: async () => {
            this.showToast(this.t("resyncStarted"), "info", 10000);
            try {
              const updatedCount =
                await databaseService.resyncAllDenormalizedData();
              const freshData = await databaseService.getAllData();
              this._loadState(freshData);
              this.showToast(
                this.t("resyncComplete", { count: updatedCount }),
                "success"
              );
            } catch (error) {
              console.error("Lỗi khi đồng bộ hóa:", error);
              this.showToast(this.t("resyncError"), "error");
            }
          },
        });
      },

      downloadBondTemplate() {
        const bondHeaders = [
          "contractNo",
          "bondNumber",
          "ref",
          "bondType",
          "amount",
          "issueDate",
          "expiryDate",
          "issuingBank",
          "renewedFromBondNumber",
        ];

        const ws = XLSX.utils.json_to_sheet([], { header: bondHeaders });
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Bonds");
        XLSX.writeFile(wb, "bonds_template.xlsx");
      },

      triggerBondFileUpload() {
        this.$refs.uploadBondExcelInput.click();
      },

      async handleBondFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const workbook = XLSX.read(new Uint8Array(e.target.result), {
              type: "array",
              cellDates: true,
            });
            const sheet =
              workbook.Sheets["Bonds"] ||
              workbook.Sheets[workbook.SheetNames[0]];

            if (!sheet) {
              this.showToast(
                this.t("errorSheetNotFound", { sheetName: "Bonds" }),
                "error"
              );
              return;
            }
            const rows = XLSX.utils.sheet_to_json(sheet, {
              raw: false,
              defval: null,
            });

            const newBondsFromFile = [];
            const skippedInfo = [];
            let skippedCount = 0;
            const existingBondNumbers = new Set(
              this.bonds.map((b) => b.bondNumber)
            );
            const newBondNumbersInFile = new Set();

            for (const row of rows) {
              const contractNo = row.contractNo?.trim();
              const bondNumber = row.bondNumber?.trim();

              if (!contractNo || !bondNumber) {
                skippedCount++;
                skippedInfo.push({
                  ...row,
                  reason: this.t("bondUploadReasonMissingData"),
                });
                continue;
              }

              if (
                existingBondNumbers.has(bondNumber) ||
                newBondNumbersInFile.has(bondNumber)
              ) {
                skippedCount++;
                skippedInfo.push({
                  ...row,
                  reason: this.t("bondUploadReasonExists"),
                });
                continue;
              }

              const contract = this.contracts.find(
                (c) =>
                  c.contractNo.trim().toLowerCase() ===
                  contractNo.toLowerCase()
              );
              if (!contract) {
                skippedCount++;
                skippedInfo.push({
                  ...row,
                  reason: this.t("bondUploadReasonNoContract", {
                    contractNo,
                  }),
                });
                continue;
              }

              newBondsFromFile.push({
                contractId: contract.id,
                bondNumber: bondNumber,
                ref: row.ref || "",
                bondType: row.bondType || "",
                amount: parseFloat(row.amount) || 0,
                issueDate: row.issueDate
                  ? appUtils.format.date(new Date(row.issueDate))
                  : "",
                expiryDate: row.expiryDate
                  ? appUtils.format.date(new Date(row.expiryDate))
                  : "",
                issuingBank: row.issuingBank || "",
                isSettled: false,
                isRenewed: false,
                settlementReasonDisplay: "",
                renewedFromBondNumber:
                  row.renewedFromBondNumber?.trim() || null,
              });
              newBondNumbersInFile.add(bondNumber);
            }

            const dbBondsToUpdate = new Map();
            const newBondsMap = new Map(
              newBondsFromFile.map((b) => [b.bondNumber, b])
            );

            for (const newBond of newBondsFromFile) {
              if (newBond.renewedFromBondNumber) {
                const originalBondNumber = newBond.renewedFromBondNumber;

                if (newBondsMap.has(originalBondNumber)) {
                  const originalBondInFile =
                    newBondsMap.get(originalBondNumber);
                  originalBondInFile.isRenewed = true;
                  originalBondInFile.isSettled = true;
                  originalBondInFile.settlementReasonDisplay =
                    this.t("renewedStatus");
                } else {
                  const originalBondInDb = this.bonds.find(
                    (b) => b.bondNumber === originalBondNumber
                  );
                  if (originalBondInDb) {
                    const updatedOriginal = JSON.parse(
                      JSON.stringify(originalBondInDb)
                    );
                    updatedOriginal.isRenewed = true;
                    updatedOriginal.isSettled = true;
                    updatedOriginal.settlementReasonDisplay =
                      this.t("renewedStatus");
                    dbBondsToUpdate.set(
                      updatedOriginal.id,
                      updatedOriginal
                    );
                  }
                }
              }
            }

            const bondsToAdd = Array.from(newBondsMap.values());
            const bondsToUpdate = Array.from(dbBondsToUpdate.values());

            if (bondsToAdd.length > 0 || bondsToUpdate.length > 0) {
              await databaseService.db.transaction(
                "rw",
                databaseService.db.bonds,
                async () => {
                  if (bondsToAdd.length > 0) {
                    await databaseService.db.bonds.bulkAdd(
                      JSON.parse(JSON.stringify(bondsToAdd))
                    );
                  }
                  if (bondsToUpdate.length > 0) {
                    await databaseService.db.bonds.bulkPut(
                      JSON.parse(JSON.stringify(bondsToUpdate))
                    );
                  }
                }
              );

              const freshData = await databaseService.getAllData();
              this._loadState(freshData);
            }

            let message =
              bondsToAdd.length > 0
                ? this.t("bondUploadSuccess", { count: bondsToAdd.length })
                : this.t("bondUploadNone");
            if (skippedCount > 0) {
              message += this.t("bondUploadSkipped", {
                count: skippedCount,
              });
              console.warn(this.t("bondUploadSkippedConsole"), skippedInfo);
            }

            this.showToast(
              message,
              bondsToAdd.length > 0 ? "success" : "info"
            );
          } catch (error) {
            console.error("Lỗi xử lý file bảo lãnh:", error);
            this.showToast(this.t("errorProcessingExcel"), "error");
          } finally {
            event.target.value = "";
          }
        };
        reader.readAsArrayBuffer(file);
      },

      exportBondsToExcel() {
        if (this.filteredBondsDashboard.length === 0) {
          this.showToast(this.t("errorNoBondDataToExport"), "warning");
          return;
        }

        const dataToExport = this.filteredBondsDashboard.map((bond) => ({
          [this.t("excelHeaderContract")]: bond.contractNo,
          [this.t("excelHeaderBondNumber")]: bond.bondNumber,
          [this.t("excelHeaderReference")]: bond.ref,
          [this.t("excelHeaderBondType")]: bond.bondType,
          [this.t("excelHeaderAmount")]: bond.amount,
          [this.t("excelHeaderIssueDate")]: bond.issueDate,
          [this.t("excelHeaderExpiryDate")]: bond.expiryDate,
          [this.t("excelHeaderBank")]: bond.issuingBankName,
          [this.t("excelHeaderStatus")]:
            this.getBondStatusClassForDashboard(bond).message,
        }));

        const ws = XLSX.utils.json_to_sheet(dataToExport);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Bonds Export");
        XLSX.writeFile(
          wb,
          `Bonds_Export_${appUtils.format.date(new Date())}.xlsx`
        );
        this.showToast(this.t("bondExportSuccess"), "success");
      },

      goToFilteredBondDashboard() {
        this.clearAllFilters();

        this.viewStates.bondDashboard.filter.status = [
          "Overdue",
          "Expiring Soon",
        ];

        this.currentTab = "cpc-bond-dashboard";

        const bellButton = document.querySelector(
          ".notification-bell-button"
        );
        if (bellButton) {
          const dropdown = bootstrap.Dropdown.getInstance(bellButton);
          if (dropdown) {
            dropdown.hide();
          }
        }
      },
      promptQuickSettle(bond, event) {
        const toggleSwitch = event.target;
        const willBeSettled = toggleSwitch.checked;

        if (bond.isRenewed) {
          toggleSwitch.checked = true;
          return;
        }

        const confirmationConfig = {
          title: willBeSettled
            ? this.t("confirmSettleTitle")
            : this.t("confirmCancelSettleTitle"),
          message: willBeSettled
            ? this.t("confirmSettleMessage", {
              bondNumber: bond.bondNumber,
            })
            : this.t("confirmCancelSettleMessage", {
              bondNumber: bond.bondNumber,
            }),
          confirmButtonText: willBeSettled
            ? this.t("btnConfirmSettle")
            : this.t("btnConfirmCancelSettle"),
          confirmButtonClass: willBeSettled ? "btn-success" : "btn-warning",
          onConfirm: () => {
            confirmationHandled = true;
            this.quickSettleBond(bond, willBeSettled);
          },
          onCancel: () => {
            confirmationHandled = true;
            toggleSwitch.checked = !willBeSettled;
          },
        };

        const modalEl = document.getElementById("confirmationModal");
        let confirmationHandled = false;

        appUtils.ui.showConfirmation(this, confirmationConfig);

        const hideListener = () => {
          if (!confirmationHandled) {
            toggleSwitch.checked = !willBeSettled;
          }
          modalEl.removeEventListener("hide.bs.modal", hideListener);
        };
        modalEl.addEventListener("hide.bs.modal", hideListener, {
          once: true,
        });
      },

      async quickSettleBond(bond, newState) {
        const bondIndex = this.bonds.findIndex((b) => b.id === bond.id);
        if (bondIndex === -1) {
          this.showToast(this.t("errorFindBondToUpdate"), "error");
          return;
        }

        const bondToUpdate = JSON.parse(
          JSON.stringify(this.bonds[bondIndex])
        );

        bondToUpdate.isSettled = newState;
        bondToUpdate.settlementReasonDisplay = newState
          ? "Quick Settle"
          : "";

        try {
          await databaseService.db.bonds.put(bondToUpdate);
          this.bonds[bondIndex] = bondToUpdate;

          const message = newState
            ? this.t("bondSettledSuccess", { bondNumber: bond.bondNumber })
            : this.t("bondUnsettledSuccess", {
              bondNumber: bond.bondNumber,
            });
          this.showToast(message, newState ? "success" : "info");
        } catch (error) {
          console.error("Lỗi khi cập nhật trạng thái bảo lãnh:", error);
          this.showToast(this.t("errorUpdateBondStatus"), "error");
        }
      },
      selectBondContract(contract) {
        this.currentEditBond.contractId = contract.id;
        this.bondContractSearchTerm = contract.contractNo;
        this.isBondContractDropdownVisible = false;
      },

      handleBondContractInputBlur() {
        setTimeout(() => {
          this.isBondContractDropdownVisible = false;
        }, 200);
      },

      navigateBondContracts(event) {
        if (
          !this.isBondContractDropdownVisible ||
          this.filteredBondContractsForModal.length === 0
        )
          return;

        switch (event.key) {
          case "ArrowDown":
            event.preventDefault();
            if (
              this.activeBondContractIndex <
              this.filteredBondContractsForModal.length - 1
            ) {
              this.activeBondContractIndex++;
              this.scrollToActiveItem(event.target);
            }
            break;
          case "ArrowUp":
            event.preventDefault();
            if (this.activeBondContractIndex > 0) {
              this.activeBondContractIndex--;
              this.scrollToActiveItem(event.target);
            }
            break;
          case "Enter":
            if (this.activeBondContractIndex >= 0) {
              event.preventDefault();
              this.selectBondContract(
                this.filteredBondContractsForModal[
                this.activeBondContractIndex
                ]
              );
            } else {
              this.isBondContractDropdownVisible = false;
            }
            break;
          case "Escape":
            this.isBondContractDropdownVisible = false;
            break;
        }
      },

      openBondModal(mode, bond = null) {
        this.bondModalMode = mode;
        this.bondContractSearchTerm = "";
        this.isBondContractDropdownVisible = false;
        this.activeBondContractIndex = -1;

        if (mode === "add") {
          this.currentEditBond = {
            contractId: null,
            bondNumber: "",
            ref: "",
            bondType: "",
            amount: 0,
            displayAmount: "0",
            issueDate: "",
            expiryDate: "",
            issuingBank: "",
            isSettled: false,
          };
        } else {
          this.currentEditBond = JSON.parse(JSON.stringify(bond));
          this.currentEditBond.displayAmount = (
            this.currentEditBond.amount || 0
          ).toLocaleString("vi-VN");
          const contract = this.contracts.find(
            (c) => c.id === bond.contractId
          );
          if (contract) {
            this.bondContractSearchTerm = contract.contractNo;
          }
        }
        appUtils.ui.toggleModal("bondManagementModal", "show");
      },

      closeBondModal() {
        appUtils.ui.toggleModal("bondManagementModal", "hide");
        this.currentEditBond = null;
      },

      formatCurrentBondAmount() {
        if (!this.currentEditBond) return;
        const numericValue = appUtils.text.parseVndAmount(
          this.currentEditBond.displayAmount
        );
        this.currentEditBond.amount = numericValue;
        this.currentEditBond.displayAmount =
          numericValue.toLocaleString("vi-VN");
      },

      async saveBond() {
        if (!this.currentEditBond || !this.currentEditBond.contractId) {
          this.showToast("Vui lòng chọn một hợp đồng.", "error");
          return;
        }

        if (
          !this.validateDates(this.currentEditBond, [
            "issueDate",
            "expiryDate",
          ])
        ) {
          return;
        }

        const bondToSave = JSON.parse(JSON.stringify(this.currentEditBond));
        delete bondToSave.displayAmount;

        const contract = this.contracts.find(
          (c) => c.id === bondToSave.contractId
        );
        if (contract) {
          bondToSave.projectId = contract.projectId;
          bondToSave.vendorId = contract.vendorId;
        } else {
          console.error(
            "Không tìm thấy hợp đồng tương ứng khi lưu bảo lãnh. Dữ liệu có thể hiển thị N/A."
          );
          this.showToast(this.t("errorContractNotFound"), "error");
          return;
        }

        try {
          if (this.bondModalMode === "add") {
            delete bondToSave.id;
            const newId = await databaseService.db.bonds.add(bondToSave);
            bondToSave.id = newId;
            this.bonds.push(bondToSave);
          } else {
            await databaseService.db.bonds.put(bondToSave);
            const index = this.bonds.findIndex(
              (b) => b.id === bondToSave.id
            );
            if (index > -1) {
              this.bonds[index] = bondToSave;
            }
          }
          this.showToast(
            "Đã lưu thông tin bảo lãnh thành công.",
            "success"
          );
          this.closeBondModal();
        } catch (error) {
          console.error("Lỗi khi lưu bảo lãnh:", error);
          this.showToast("Lưu bảo lãnh thất bại.", "error");
        }
      },
      async goToBondDashboard(bond) {
        if (!bond.projectId || !bond.vendorId || !bond.contractId) {
          this.showToast(
            "Thông tin hợp đồng không đầy đủ để điều hướng.",
            "warning"
          );
          return;
        }

        this.clearAllFilters();
        const bondFilters = this.viewStates.bondDashboard.filter;

        bondFilters.projectId = [bond.projectId];
        await this.$nextTick();

        bondFilters.vendorId = [bond.vendorId];
        await this.$nextTick();

        bondFilters.contractId = [bond.contractId];

        this.currentTab = "cpc-bond-dashboard";

        const bellButton = document.querySelector(
          ".notification-bell-button"
        );
        if (bellButton) {
          const dropdown = bootstrap.Dropdown.getInstance(bellButton);
          if (dropdown) {
            dropdown.hide();
          }
        }
      },

      cancelAction() {
        if (typeof this.confirmation.onCancel === "function") {
          this.confirmation.onCancel();
        }
        appUtils.ui.toggleModal("confirmationModal", "hide");
      },
      promptForVendorMerge(sourceVendor, destinationVendor) {
        appUtils.ui.toggleModal("vendorManagementModal", "hide");

        appUtils.ui.showConfirmation(this, {
          title: "Phát hiện Trùng Mã Nhà Cung Cấp",
          message: `Mã nhà cung cấp <strong>${destinationVendor.vendorNo}</strong> đã tồn tại cho NCC "<strong>${destinationVendor.name}</strong>".<br><br>Bạn có muốn hợp nhất NCC bạn đang sửa ("<strong>${sourceVendor.name}</strong>") vào NCC đã có không? <br><br><strong class="text-danger">Lưu ý:</strong> Toàn bộ hợp đồng của NCC "${sourceVendor.name}" sẽ được chuyển sang cho "${destinationVendor.name}" và NCC "${sourceVendor.name}" sẽ bị xóa. Hành động này không thể hoàn tác.`,
          confirmButtonText: `Đồng ý Hợp nhất`,
          confirmButtonClass: "btn-warning",
          onConfirm: () => {
            this.performVendorMerge(sourceVendor.id, destinationVendor.id);
          },
          onCancel: () => {
            appUtils.ui.toggleModal("vendorManagementModal", "show");
          },
        });
      },
      async performVendorMerge(sourceVendorId, destinationVendorId) {
        if (
          !sourceVendorId ||
          !destinationVendorId ||
          sourceVendorId === destinationVendorId
        ) {
          this.showToast(
            "Lỗi: ID nhà cung cấp không hợp lệ để hợp nhất.",
            "error"
          );
          return;
        }

        const sourceVendor = this.vendors.find(
          (v) => v.id === sourceVendorId
        );
        const destinationVendor = this.vendors.find(
          (v) => v.id === destinationVendorId
        );

        if (!sourceVendor || !destinationVendor) {
          this.showToast(
            "Lỗi: Không tìm thấy nhà cung cấp trong hệ thống.",
            "error"
          );
          return;
        }

        try {
          await databaseService.db.transaction(
            "rw",
            databaseService.db.contracts,
            databaseService.db.vendors,
            async () => {
              const contractsToUpdate = await databaseService.db.contracts
                .where("vendorId")
                .equals(sourceVendorId)
                .toArray();

              if (contractsToUpdate.length > 0) {
                const updatedContracts = contractsToUpdate.map(
                  (contract) => {
                    contract.vendorId = destinationVendorId;
                    return contract;
                  }
                );

                await databaseService.db.contracts.bulkPut(
                  updatedContracts
                );
              }

              await databaseService.db.vendors.delete(sourceVendorId);
            }
          );

          this.contracts.forEach((contract) => {
            if (contract.vendorId === sourceVendorId) {
              contract.vendorId = destinationVendorId;
            }
          });

          const vendorIndex = this.vendors.findIndex(
            (v) => v.id === sourceVendorId
          );
          if (vendorIndex > -1) {
            this.vendors.splice(vendorIndex, 1);
          }

          this.$nextTick(() => { });

          this.showToast(
            `Đã hợp nhất thành công NCC "${sourceVendor.name}" vào "${destinationVendor.name}"!`,
            "success"
          );
          this.closeVendorModal();
        } catch (error) {
          console.error("Lỗi khi hợp nhất nhà cung cấp:", error);
          this.showToast(
            "Đã xảy ra lỗi trong quá trình hợp nhất. Dữ liệu đã được hoàn tác.",
            "error"
          );
        }
      },
      exportMasterVendors() {
        if (!this.vendors || this.vendors.length === 0) {
          this.showToast(this.t("errorNoVendorDataToExport"), "warning");
          return;
        }

        const dataToExport = this.vendors.map((vendor) => ({
          name: vendor.name,
          abbrName: vendor.abbrName,
          vendorNo: vendor.vendorNo,
          contactPerson: vendor.contactPerson || "",
          phoneNumber: vendor.phoneNumber || ""
        }));

        const ws = XLSX.utils.json_to_sheet(dataToExport);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Vendors");

        const fileName = `MasterData_Vendors_${appUtils.format.date(
          new Date()
        )}.xlsx`;
        XLSX.writeFile(wb, fileName);

        this.showToast(this.t("vendorExportSuccess"), "success");
      },
      async cleanupOrphanData() {
        console.log("Scanning for orphan data with complete logic...");

        const validProjectIds = new Set(this.projects.map((p) => p.id));
        const validVendorIds = new Set(this.vendors.map((v) => v.id));
        const validContractIds = new Set(this.contracts.map((c) => c.id));
        const validCpcIds = new Set(this.cpcItems.map((cpc) => cpc.id));

        const allProjectIdsInUse = new Set(
          this.contracts.map((c) => c.projectId)
        );
        this.cpcItems.forEach((cpc) => {
          if (cpc.projectId) {
            allProjectIdsInUse.add(cpc.projectId);
          }
        });

        const projectsWithNoLinks = this.projects.filter(
          (p) => !allProjectIdsInUse.has(p.id)
        );

        const contractsWithOrphanProject = this.contracts.filter(
          (c) => c.projectId && !validProjectIds.has(c.projectId)
        );

        const contractsWithOrphanVendor = this.contracts.filter(
          (c) => c.vendorId && !validVendorIds.has(c.vendorId)
        );

        const installmentsWithOrphanCpc = this.installments.filter(
          (inst) => inst.cpcId && !validCpcIds.has(inst.cpcId)
        );

        const bondsWithOrphanCpc = this.bonds.filter(
          (bond) => bond.cpcId && !validCpcIds.has(bond.cpcId)
        );

        this.orphanData = {
          projectsWithNoContracts: projectsWithNoLinks,
          contractsWithOrphanProject,
          contractsWithOrphanVendor,
          installmentsWithOrphanCpc,
          bondsWithOrphanCpc,
          cpcWithOrphanContract: [],
        };

        appUtils.ui.toggleModal("orphanDataModal", "show");
      },

      async deleteOrphanItem(tableName, itemId) {
        appUtils.ui.toggleModal("orphanDataModal", "hide");

        appUtils.ui.showConfirmation(this, {
          title: "Xác nhận Xóa",
          message: `Bạn có chắc chắn muốn xóa vĩnh viễn mục này (ID: ${itemId}) không?`,
          confirmButtonText: "Xóa",
          onCancel: () => {
            appUtils.ui.toggleModal("orphanDataModal", "show");
          },
          onConfirm: async () => {
            try {
              await databaseService.db[tableName].delete(itemId);

              const freshData = await databaseService.getAllData();
              this._loadState(freshData);

              this.showToast(
                `Đã xóa mục (ID: ${itemId}) thành công.`,
                "success"
              );

              this.cleanupOrphanData();
            } catch (error) {
              console.error(
                `Lỗi khi xóa mục ${itemId} từ bảng ${tableName}:`,
                error
              );
              this.showToast(
                "Xóa thất bại. Vui lòng kiểm tra console.",
                "error"
              );
              appUtils.ui.toggleModal("orphanDataModal", "show");
            }
          },
        });
      },

      deleteAllOrphans() {
        appUtils.ui.showConfirmation(this, {
          title: "Xác nhận Xóa Tất cả",
          message:
            "Hành động này sẽ xóa vĩnh viễn **TẤT CẢ** các mục được liệt kê. Bạn có chắc chắn muốn tiếp tục không?",
          confirmButtonClass: "btn-danger",
          confirmButtonText: "Vâng, Xóa Tất cả",
          onCancel: () => {
            appUtils.ui.toggleModal("orphanDataModal", "show");
          },
          onConfirm: async () => {
            try {
              const idsToDelete = {};
              const tableNameMapping = {
                contractsWithOrphanProject: "contracts",
                contractsWithOrphanVendor: "contracts",
                projectsWithNoContracts: "projects",
                installmentsWithOrphanCpc: "installments",
                bondsWithOrphanCpc: "bonds",
              };

              for (const key in this.orphanData) {
                const actualTableName = tableNameMapping[key];
                if (!actualTableName) continue;

                const items = this.orphanData[key];
                if (items.length > 0) {
                  if (!idsToDelete[actualTableName]) {
                    idsToDelete[actualTableName] = [];
                  }
                  idsToDelete[actualTableName].push(
                    ...items.map((item) => item.id)
                  );
                }
              }

              await databaseService.db.transaction(
                "rw",
                databaseService.db.tables,
                async () => {
                  for (const tableName in idsToDelete) {
                    const uniqueIds = [...new Set(idsToDelete[tableName])];
                    if (uniqueIds.length > 0) {
                      await databaseService.db[tableName].bulkDelete(
                        uniqueIds
                      );
                    }
                  }
                }
              );

              const freshData = await databaseService.getAllData();
              this._loadState(freshData);

              for (const key in this.orphanData) {
                this.orphanData[key] = [];
              }

              this.showToast(
                "Đã dọn dẹp tất cả dữ liệu mồ côi thành công.",
                "success"
              );
            } catch (error) {
              console.error("Lỗi khi xóa tất cả dữ liệu mồ côi:", error);
              this.showToast(
                "Xóa hàng loạt thất bại. Vui lòng kiểm tra console.",
                "error"
              );
            } finally {
              appUtils.ui.toggleModal("confirmationModal", "hide");
              appUtils.ui.toggleModal("orphanDataModal", "hide");
            }
          },
        });
      },
      openProjectBackupModal() {
        this.selectedProjectIdForBackup = null;
        appUtils.ui.toggleModal("projectBackupModal", "show");
        this.$nextTick(() => {
          lucide.createIcons();
        });
      },

      triggerProjectImport() {
        this.$refs.importProjectInput.click();
      },

      exportSelectedProject() {
        const projectId = this.selectedProjectIdForBackup;
        if (!projectId) {
          this.showToast("Vui lòng chọn một dự án.", "warning");
          return;
        }

        const projectToBackup = this.projects.find(
          (p) => p.id === projectId
        );
        if (!projectToBackup) {
          this.showToast("Không tìm thấy dự án.", "error");
          return;
        }

        const contractsInProject = this.contracts.filter(
          (c) => c.projectId === projectId
        );
        const contractIds = new Set(contractsInProject.map((c) => c.id));
        const vendorIds = new Set(
          contractsInProject.map((c) => c.vendorId)
        );

        const cpcItemsInProject = this.cpcItems.filter((cpc) =>
          contractIds.has(cpc.contractId)
        );
        const cpcIds = new Set(cpcItemsInProject.map((cpc) => cpc.id));

        const projectData = {
          type: "ProjectBackup",
          version: "1.0",
          exportedAt: new Date().toISOString(),
          projectData: {
            projects: [projectToBackup],
            vendors: this.vendors.filter((v) => vendorIds.has(v.id)),
            contracts: contractsInProject,
            cpcItems: cpcItemsInProject,
            cpcDetailRows: this.cpcDetailRows.filter((row) =>
              contractIds.has(row.contractId)
            ),
            installments: this.installments.filter((inst) =>
              cpcIds.has(inst.cpcId)
            ),
            bonds: this.bonds.filter((bond) => contractIds.has(bond.contractId)),
          },
        };

        const blob = new Blob([JSON.stringify(projectData, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `Backup_${projectToBackup.name.replace(
          / /g,
          "_"
        )}_${appUtils.format.date(new Date())}.json`;
        a.click();
        URL.revokeObjectURL(url);

        this.showToast(
          `Đã xuất dữ liệu cho dự án "${projectToBackup.name}" thành công.`,
          "success"
        );
        appUtils.ui.toggleModal("projectBackupModal", "hide");
      },

      handleProjectFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const parsedData = JSON.parse(e.target.result);
            if (
              parsedData.type !== "ProjectBackup" ||
              !parsedData.projectData
            ) {
              this.showToast(
                "File không hợp lệ hoặc không phải là file backup dự án.",
                "error"
              );
              return;
            }

            const projectFromFile = parsedData.projectData.projects[0];
            const existingProject = this.projects.find(
              (p) =>
                p.name.toLowerCase() === projectFromFile.name.toLowerCase()
            );

            if (existingProject) {
              appUtils.ui.showConfirmation(this, {
                title: "Dự án đã tồn tại",
                message: `Dự án "<strong>${existingProject.name}</strong>" đã có trong dữ liệu hiện tại. Bạn có muốn <strong>xóa toàn bộ dữ liệu cũ</strong> của dự án này và thay thế bằng dữ liệu từ file không?`,
                confirmButtonText: "Ghi đè",
                confirmButtonClass: "btn-danger",
                onConfirm: async () => {
                  await this.importProjectData(
                    parsedData.projectData,
                    existingProject.id
                  );
                },
              });
            } else {
              appUtils.ui.showConfirmation(this, {
                title: "Xác nhận Import Dự án Mới",
                message: `Bạn có chắc chắn muốn thêm dự án "<strong>${projectFromFile.name}</strong>" và tất cả dữ liệu liên quan vào ứng dụng không?`,
                confirmButtonText: "Import",
                confirmButtonClass: "btn-primary",
                onConfirm: async () => {
                  await this.importProjectData(
                    parsedData.projectData,
                    null
                  );
                },
              });
            }
          } catch (error) {
            console.error("Lỗi khi import dự án:", error);
            this.showToast("Có lỗi xảy ra khi xử lý file.", "error");
          }
        };
        reader.readAsText(file);
        event.target.value = "";
      },

      async importProjectData(data, existingProjectIdToDelete) {
        try {
          if (existingProjectIdToDelete) {
            const contractsToDelete = this.contracts.filter(
              (c) => c.projectId === existingProjectIdToDelete
            );
            const contractIdsToDelete = new Set(
              contractsToDelete.map((c) => c.id)
            );
            const cpcItemsToDelete = this.cpcItems.filter((cpc) =>
              contractIdsToDelete.has(cpc.contractId)
            );
            const cpcIdsToDelete = new Set(
              cpcItemsToDelete.map((cpc) => cpc.id)
            );

            await databaseService.db.transaction(
              "rw",
              databaseService.db.tables,
              async () => {
                if (cpcIdsToDelete.size > 0) {
                  await databaseService.db.installments
                    .where("cpcId")
                    .anyOf(...cpcIdsToDelete)
                    .delete();
                  await databaseService.db.bonds
                    .where("cpcId")
                    .anyOf(...cpcIdsToDelete)
                    .delete();
                }
                if (contractIdsToDelete.size > 0) {
                  await databaseService.db.bonds.where("contractId").anyOf(idsArray).delete();
                  await databaseService.db.cpcItems
                    .where("contractId")
                    .anyOf(...contractIdsToDelete)
                    .delete();
                  await databaseService.db.cpcDetailRows
                    .where("contractId")
                    .anyOf(...contractIdsToDelete)
                    .delete();
                }
                await databaseService.db.contracts
                  .where("projectId")
                  .equals(existingProjectIdToDelete)
                  .delete();
                await databaseService.db.projects.delete(
                  existingProjectIdToDelete
                );
              }
            );
          }

          await databaseService.db.transaction(
            "rw",
            databaseService.db.tables,
            async () => {
              await databaseService.db.projects.bulkPut(data.projects);
              await databaseService.db.vendors.bulkPut(data.vendors);
              await databaseService.db.contracts.bulkPut(data.contracts);
              await databaseService.db.cpcItems.bulkPut(data.cpcItems);
              await databaseService.db.cpcDetailRows.bulkPut(
                data.cpcDetailRows
              );
              await databaseService.db.installments.bulkPut(
                data.installments
              );
              await databaseService.db.bonds.bulkPut(data.bonds);
            }
          );

          const allData = await databaseService.getAllData();
          this._loadState(allData);

          this.showToast(
            "Dữ liệu dự án đã được import thành công!",
            "success"
          );
        } catch (error) {
          console.error(
            "Lỗi nghiêm trọng khi import dữ liệu dự án:",
            error
          );
          this.showToast(
            "Quá trình import thất bại. Vui lòng kiểm tra console.",
            "error"
          );
        }
      },
      triggerCogsFileUpload() {
        this.$refs.cogsUploadInput.click();
      },

      handleCogsFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const workbook = XLSX.read(new Uint8Array(e.target.result), {
              type: "array",
            });
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];

            if (!sheet) {
              this.showToast(
                this.t("errorSheetNotFound", {
                  sheetName: sheetName || "data",
                }),
                "error"
              );
              return;
            }

            const jsonData = XLSX.utils.sheet_to_json(sheet, {
              header: 1,
              defval: null,
            });

            const excelData = {};
            const summarySap = {};
            let processedRows = 0;

            for (let i = 1; i < jsonData.length; i++) {
              const row = jsonData[i];
              if (!row || row.length === 0) continue;

              const contractKey = row[2] ? String(row[2]).trim() : null;
              const glAccount = row[1] ? String(row[1]).trim() : null;
              const amountValue =
                row[7] != null
                  ? parseFloat(String(row[7]).replace(/,/g, ""))
                  : NaN;

              if (isNaN(amountValue)) continue;

              if (contractKey) {
                if (!excelData[contractKey]) {
                  excelData[contractKey] = { invAmount: 0 };
                }
                excelData[contractKey].invAmount += amountValue;
              }

              if (glAccount) {
                if (!summarySap[glAccount]) {
                  summarySap[glAccount] = 0;
                }
                summarySap[glAccount] += amountValue;
              }

              if (contractKey || glAccount) {
                processedRows++;
              }
            }

            if (processedRows > 0) {
              this.cogsComparisonData = excelData;
              this.cogsSummaryFromSap = summarySap;
              this.showToast(
                this.t("cogsUploadSuccess", { count: processedRows }),
                "success"
              );
            } else {
              this.showToast(this.t("errorNoValidDataInExcel"), "warning");
            }
          } catch (error) {
            console.error("Lỗi xử lý file COGS:", error);
            this.showToast(this.t("errorProcessingExcel"), "error");
          } finally {
            event.target.value = "";
          }
        };
        reader.readAsArrayBuffer(file);
      },

      clearCogsComparison() {
        this.cogsComparisonData = null;
        this.cogsSummaryFromSap = null;
        this.showToast(this.t("cogsReconciliationCleared"), "info");
      },

      runDataMigrationToNumericIDs() { },
      promptAndDebugVendor() {
        const vendorNo = window.prompt(
          "Vui lòng nhập Mã Nhà cung cấp (Vendor No.) cần debug:",
          ""
        );

        if (vendorNo && vendorNo.trim()) {
          this.debugVendorBalance(vendorNo.trim());
        } else {
          console.log("Hủy thao tác debug.");
        }
      },
      debugVendorBalance(vendorNo) {
        console.clear();
        console.log(
          `%c--- DEBUG CÔNG NỢ NCC: ${vendorNo} (Đã đồng bộ logic 3311/3312) ---`,
          "color: white; background: #0d6efd; font-size: 16px; font-weight: bold; padding: 8px; border-radius: 4px;"
        );

        const vendor = this.vendors.find((v) => v.vendorNo === vendorNo);
        if (!vendor) {
          console.error(`Lỗi: Không tìm thấy nhà cung cấp với mã ${vendorNo}`);
          return;
        }
        console.log(`Nhà cung cấp: %c${vendor.name}`, "font-weight: bold; color: blue; font-size: 14px;");

        const vendorContracts = this.contracts.filter((c) => c.vendorId === vendor.id);
        const asOfDate = this.viewStates.vendorBalance.filter.asOfDate;
        const reportDate = new Date(asOfDate || new Date());
        reportDate.setHours(23, 59, 59, 999);

        console.log(`Ngày chốt số liệu: %c${reportDate.toLocaleDateString("vi-VN")}`, "font-weight: bold; color: #c55");

        let grandTotal3311 = 0;
        let grandTotal3312 = 0;

        const contractsByProject = new Map();
        vendorContracts.forEach(c => {
          if (!contractsByProject.has(c.projectId)) contractsByProject.set(c.projectId, []);
          contractsByProject.get(c.projectId).push(c);
        });

        contractsByProject.forEach((contracts, projectId) => {
          const project = this.projectMap.get(projectId);
          console.groupCollapsed(`%c📂 DỰ ÁN: ${project ? project.name.toUpperCase() : 'UNKNOWN'}`, "color: purple; font-weight: bold;");

          contracts.forEach(contract => {
            const balance = this.calculateContractBalanceAsOf(contract.id, asOfDate || new Date().toISOString().slice(0, 10));

            const tableData = this.cpcDetailRows.filter(r => r.contractId === contract.id);
            const cpcItemsForContract = this.cpcItems.filter(c => c.contractId === contract.id);

            console.group(`🔍 Hợp đồng: ${contract.contractNo} (${contract.currency})`);

            const advanceCpcNos = [...new Set(tableData.filter(r => (r.cpcAdvance || 0) !== 0).map(r => r.cpcNo).filter(Boolean))];
            const advanceCpcs = cpcItemsForContract.filter(c => advanceCpcNos.includes(c.cpcIdentifier));

            console.log("%c[3312 - Tạm ứng]", "font-weight: bold; color: #1976d2;");
            let realizedAdvVND = 0;
            advanceCpcs.forEach(c => {
              const insts = (this.installmentsByCpcId.get(c.id) || []).filter(i => i.date && new Date(i.date) <= reportDate);
              const sumInst = insts.reduce((s, i) => s + (contract.currency === 'USD' ? (i.amountUsd || 0) : (i.amount || 0)), 0);
              const sumInstVND = insts.reduce((s, i) => s + (i.amountVND || i.amount || 0), 0);
              realizedAdvVND += sumInstVND;
              if (sumInst !== 0) console.log(`  + Chi tạm ứng CPC ${c.cpcIdentifier}: ${this.formatCurrency(sumInstVND)}`);
            });

            const repayments = tableData.filter(r => r.invoicePostingDate && new Date(r.invoicePostingDate) <= reportDate && (r.cpcRepayment || 0) !== 0);
            const totalRepayVND = repayments.reduce((s, r) => {
              let rate = 1;
              if (contract.currency === 'USD') {
                rate = parseFloat(r.invoiceExchangeRate) || 0;
                if (rate <= 0) {
                  const cpc = cpcItemsForContract.find(i => i.cpcIdentifier === r.cpcNo);
                  rate = cpc ? cpc.exchangeRate : 0;
                }
              }
              return s + (r.cpcRepayment * rate);
            }, 0);

            if (totalRepayVND !== 0) console.log(`  - Đã hoàn ứng (theo Hóa đơn): ${this.formatCurrency(Math.abs(totalRepayVND))}`);
            console.log(`  => Dư tạm ứng (3312): ${this.formatCurrency(balance.advanceBalance)}`);

            console.log("%c[3311 - Phải trả]", "font-weight: bold; color: #d32f2f;");
            const invoices = tableData.filter(r => r.invoicePostingDate && new Date(r.invoicePostingDate) <= reportDate);
            const totalInvVND = invoices.reduce((s, r) => {
              let rate = 1;
              if (contract.currency === 'USD') {
                rate = parseFloat(r.invoiceExchangeRate) || 0;
                if (rate <= 0) {
                  const cpc = cpcItemsForContract.find(i => i.cpcIdentifier === r.cpcNo);
                  rate = cpc ? cpc.exchangeRate : 0;
                }
              }
              return s + (r.invoiceTotal * rate);
            }, 0);

            const allPayments = cpcItemsForContract.flatMap(c => (this.installmentsByCpcId.get(c.id) || []))
              .filter(i => i.date && new Date(i.date) <= reportDate);
            const totalPaidVND = allPayments.reduce((s, i) => s + (i.amountVND || i.amount || 0), 0);

            console.log(`  + Tổng Hóa đơn (VND): ${this.formatCurrency(totalInvVND)}`);
            console.log(`  - Tổng Đã trả (VND): ${this.formatCurrency(totalPaidVND)}`);
            console.log(`  + Dư tạm ứng: ${this.formatCurrency(balance.advanceBalance)}`);
            console.log(`  => Phải trả NCC (3311): ${this.formatCurrency(balance.finalPayable)}`);

            console.groupEnd();

            grandTotal3311 += balance.finalPayable;
            grandTotal3312 += balance.advanceBalance;
          });
          console.groupEnd();
        });

        console.log(
          `%c--- TỔNG CỘNG CUỐI CÙNG ---`,
          "color: white; background: green; font-size: 14px; font-weight: bold; padding: 5px; margin-top: 20px; display: block;"
        );
        console.log(`%cGL 3311 (Phải trả): ${this.formatCurrency(grandTotal3311)}`, "font-size: 18px; font-weight: bold; color: #d32f2f;");
        console.log(`%cGL 3312 (Tạm ứng): ${this.formatCurrency(grandTotal3312)}`, "font-size: 18px; font-weight: bold; color: #1976d2;");
      },
      calculateContractBalanceAsOf(contractId, asOfDate) {
        const tableData =
          this.cpcDetailRowsByContractId.get(contractId) || [];
        const contract = this.contractMap.get(contractId);

        if (!contract || !asOfDate) {
          return { finalPayable: 0, advanceBalance: 0 };
        }

        const reportDate = new Date(asOfDate);
        reportDate.setHours(23, 59, 59, 999);

        const cpcItemsForContract =
          this.cpcItemsByContractId.get(contractId) || [];

        const advanceCpcNos = [
          ...new Set(
            tableData
              .filter((row) => (row.cpcAdvance || 0) !== 0)
              .map((row) => row.cpcNo)
              .filter(Boolean)
          ),
        ];

        const advanceCpcIds = cpcItemsForContract
          .filter((cpc) => advanceCpcNos.includes(cpc.cpcIdentifier))
          .map((cpc) => cpc.id);

        const totalRealizedAdvanceAsOf = advanceCpcIds.reduce(
          (sum, cpcId) => {
            const installmentsForCpc =
              this.installmentsByCpcId.get(cpcId) || [];

            const cpcItem = cpcItemsForContract.find((c) => c.id === cpcId);

            const paidForCpc = installmentsForCpc
              .filter(
                (inst) => inst.date && new Date(inst.date) <= reportDate
              )
              .reduce((cpcSum, inst) => {
                let paymentValue =
                  contract.currency === "USD"
                    ? inst.amountUsd || 0
                    : inst.amountVND || inst.amount || 0;

                if (cpcItem && cpcItem.amount < 0) {
                  paymentValue = -Math.abs(paymentValue);
                }

                return cpcSum + paymentValue;
              }, 0);
            return sum + paidForCpc;
          },
          0
        );

        const totalRepaymentAsOf = tableData
          .filter(
            (row) =>
              row.invoicePostingDate &&
              new Date(row.invoicePostingDate) <= reportDate
          )
          .reduce((sum, row) => sum + (row.cpcRepayment || 0), 0);

        const advanceBalanceAsOf =
          totalRealizedAdvanceAsOf + totalRepaymentAsOf;

        const totalInvoicedAsOf = tableData
          .filter(
            (row) =>
              row.invoicePostingDate &&
              new Date(row.invoicePostingDate) <= reportDate
          )
          .reduce((sum, row) => sum + (row.invoiceTotal || 0), 0);

        const allCpcIdsForContract = cpcItemsForContract.map(
          (cpc) => cpc.id
        );

        const totalPaidAsOf = allCpcIdsForContract.reduce((sum, cpcId) => {
          const installmentsForCpc =
            this.installmentsByCpcId.get(cpcId) || [];
          const paidForCpc = installmentsForCpc
            .filter(
              (inst) => inst.date && new Date(inst.date) <= reportDate
            )
            .reduce((cpcSum, inst) => {
              const cpcItem = cpcItemsForContract.find(
                (cpc) => cpc.id === inst.cpcId
              );
              let paymentValue =
                contract.currency === "USD"
                  ? inst.amountUsd || 0
                  : inst.amountVND || inst.amount || 0;

              if (cpcItem && cpcItem.amount < 0) {
                paymentValue = -Math.abs(paymentValue);
              }
              return cpcSum + paymentValue;
            }, 0);
          return sum + paidForCpc;
        }, 0);

        const remainingPayableFromInvoice =
          totalInvoicedAsOf - totalPaidAsOf;

        const finalPayableAsOf =
          remainingPayableFromInvoice + advanceBalanceAsOf;

        return {
          finalPayable: Math.max(0, finalPayableAsOf),
          advanceBalance: advanceBalanceAsOf,
        };
      },
      toggleZeroFilter(filterObject, key, value) {
        if (filterObject[key] === value) {
          filterObject[key] = null;
        } else {
          filterObject[key] = value;
        }
      },
      getIconForKey(key) {
        const iconMap = {
          "cpc-tracking": "clipboard-list",
          "cpc-details": "table-2",
          "cogs-dashboard": "clipboard-check",
          "vendor-balance": "scale",
          "cpc-dashboard": "landmark",
          "cpc-swap-dashboard": "repeat",
          "cpc-bond-dashboard": "shield",
          "cpc-contract-dashboard": "file-signature",
          "cpc-report-dashboard": "bar-chart-3",
          "invoice-aging": "history",
          "master-data": "database",
        };
        return iconMap[key] || "file";
      },
      handleSidebarShortcut(event) {
        if (event.altKey && event.key.toLowerCase() === "s") {
          event.preventDefault();
          this.toggleSidebarNavigation();
          return;
        }

        if (!this.isSidebarNavigating) return;

        switch (event.key) {
          case "ArrowUp":
            event.preventDefault();
            this.navigateSidebar("prev");
            break;
          case "ArrowDown":
            event.preventDefault();
            this.navigateSidebar("next");
            break;
          case "Enter":
            event.preventDefault();
            this.selectSidebarTab();
            break;
          case "Escape":
            event.preventDefault();
            this.toggleSidebarNavigation(false);
            break;
        }
      },

      toggleSidebarNavigation(forceState = null) {
        this.isSidebarNavigating =
          forceState !== null ? forceState : !this.isSidebarNavigating;

        if (this.isSidebarNavigating) {
          this.sidebarNavIndex = this.sidebarTabs.findIndex(
            (tab) => tab.key === this.currentTab
          );
          if (this.sidebarNavIndex === -1) {
            this.sidebarNavIndex = 0;
          }
        } else {
          this.sidebarNavIndex = -1;
        }
      },

      navigateSidebar(direction) {
        const tabCount = this.sidebarTabs.length;
        if (tabCount === 0) return;

        let newIndex = this.sidebarNavIndex;
        if (direction === "next") {
          newIndex = (this.sidebarNavIndex + 1) % tabCount;
        } else if (direction === "prev") {
          newIndex = (this.sidebarNavIndex - 1 + tabCount) % tabCount;
        }
        this.sidebarNavIndex = newIndex;
      },

      selectSidebarTab() {
        if (
          this.sidebarNavIndex > -1 &&
          this.sidebarNavIndex < this.sidebarTabs.length
        ) {
          const selectedTabKey = this.sidebarTabs[this.sidebarNavIndex].key;
          this.currentTab = selectedTabKey;
          this.toggleSidebarNavigation(false);
        }
      },
      toggleQuickMenu(forceState = null) {
        this.isQuickMenuOpen =
          forceState !== null ? forceState : !this.isQuickMenuOpen;

        if (this.isQuickMenuOpen) {
          this.activeQuickMenuIndex = 0;
        } else {
          this.activeQuickMenuIndex = -1;
        }
      },

      handleQuickMenuShortcut(event) {
        if (event.altKey && event.key.toLowerCase() === "a") {
          event.preventDefault();
          this.toggleQuickMenu();
        }

        if (!this.isQuickMenuOpen) return;

        switch (event.key) {
          case "ArrowRight":
          case "ArrowDown":
            event.preventDefault();
            this.navigateQuickMenu("next");
            break;
          case "ArrowLeft":
          case "ArrowUp":
            event.preventDefault();
            this.navigateQuickMenu("prev");
            break;
          case "Enter":
            event.preventDefault();
            this.executeQuickMenuAction();
            break;
          case "Escape":
            event.preventDefault();
            this.toggleQuickMenu(false);
            break;
        }
      },

      navigateQuickMenu(direction) {
        const itemCount = this.quickMenuItems.length;
        if (itemCount === 0) return;

        let newIndex = this.activeQuickMenuIndex;
        if (direction === "next") {
          newIndex = (this.activeQuickMenuIndex + 1) % itemCount;
        } else if (direction === "prev") {
          newIndex =
            (this.activeQuickMenuIndex - 1 + itemCount) % itemCount;
        }
        this.activeQuickMenuIndex = newIndex;
      },

      executeQuickMenuAction(action = null) {
        if (!action) {
          if (this.activeQuickMenuIndex < 0) return;
          action = this.quickMenuItems[this.activeQuickMenuIndex].action;
        }

        switch (action) {
          case "addCpc":
            this.addNewCpcItem();
            break;
          case "addContract":
            this.addNewContractItem();
            break;
          case "addVendor":
            this.openVendorModal("add");
            break;
          case "addBond":
            this.openBondModal("add");
            break;
        }

        this.toggleQuickMenu(false);
      },

      async openVendorModal(mode = "add", vendor = null) {
        this.vendorModalMode = mode;
        if (mode === "add") {
          this.currentEditVendor = {
            name: "", abbrName: "", vendorNo: "",
            contactPerson: "", phoneNumber: "" // Khởi tạo trống
          };
        } else {
          // Đảm bảo các trường mới tồn tại để tránh lỗi undefined
          this.currentEditVendor = {
            contactPerson: "",
            phoneNumber: "",
            ...vendor
          };
        }
        appUtils.ui.toggleModal("vendorManagementModal", "show");
      },

      closeVendorModal() {
        appUtils.ui.toggleModal("vendorManagementModal", "hide");
        this.currentEditVendor = null;
      },

      async saveVendor() {
        if (
          !this.currentEditVendor ||
          !this.currentEditVendor.name.trim()
        ) {
          this.showToast(this.t("errorVendorNameRequired"), "error");
          return;
        }
        if (
          !this.currentEditVendor.vendorNo ||
          !this.currentEditVendor.vendorNo.trim()
        ) {
          this.showToast(this.t("errorVendorNoRequired"), "error");
          return;
        }

        const vendorName = this.currentEditVendor.name.trim();
        const vendorNo = this.currentEditVendor.vendorNo.trim();

        const isNameDuplicate = this.vendors.some(
          (v) =>
            v.name.toLowerCase() === vendorName.toLowerCase() &&
            v.id !== this.currentEditVendor.id
        );
        if (isNameDuplicate) {
          this.showToast(
            this.t("errorVendorNameExists", { vendorName: vendorName }),
            "error"
          );
          return;
        }

        const duplicateVendorByNo = this.vendors.find(
          (v) =>
            v.vendorNo &&
            v.vendorNo.toLowerCase() === vendorNo.toLowerCase() &&
            v.id !== this.currentEditVendor.id
        );
        if (duplicateVendorByNo) {
          this.promptForVendorMerge(
            this.currentEditVendor,
            duplicateVendorByNo
          );
          return;
        }

        try {
          const vendorToSave = JSON.parse(
            JSON.stringify(this.currentEditVendor)
          );

          if (this.vendorModalMode === "add") {
            delete vendorToSave.id;

            const newId = await databaseService.db.vendors.add(
              vendorToSave
            );
            vendorToSave.id = newId;

            this.vendors.push(vendorToSave);
          } else {
            await databaseService.updateVendor(vendorToSave);

            const index = this.vendors.findIndex(
              (v) => v.id === vendorToSave.id
            );
            if (index !== -1) {
              this.cpcItems.forEach((cpc) => {
                if (cpc.vendorId === vendorToSave.id) {
                  cpc.vendorName = vendorToSave.name;
                  cpc.vendorNameAbbr = vendorToSave.abbrName;
                  cpc.vendorNo = vendorToSave.vendorNo;
                }
              });
              this.vendors[index] = vendorToSave;
            }
          }
          this.initializeFuse();
          this.showToast(this.t("vendorSavedSuccess"), "success");
          this.closeVendorModal();
        } catch (error) {
          console.error("Error saving vendor:", error);
          if (error.name === "ConstraintError") {
            this.showToast(
              `Lỗi: Tên hoặc Mã NCC đã tồn tại trong cơ sở dữ liệu.`,
              "error"
            );
          } else {
            this.showToast(this.t("vendorSaveFailed"), "error");
          }
        }
      },

      selectVendor(vendor) {
        const activeItem = this.currentEditItem || this.currentEditContract;

        if (activeItem) {
          activeItem.vendorName = vendor.name;
          activeItem.vendorNo = vendor.vendorNo;

          if (this.currentEditContract) {
            this.currentEditContract.vendorAbbrName = vendor.abbrName;
          }
        }

        this.vendorSearchTerm = vendor.name;
        this.isVendorDropdownVisible = false;
        this.filteredVendors = [];

        this.$nextTick(() => {
          if (this.currentEditItem) {
            this.autoFillFromMasterContract();
          }
        });
      },
      handleVendorInputBlur() {
        setTimeout(() => {
          this.isVendorDropdownVisible = false;
        }, 200);
      },
      navigateVendors(event) {
        if (!this.isVendorDropdownVisible) return;
        switch (event.key) {
          case "ArrowDown":
            event.preventDefault();
            if (this.activeVendorIndex < this.filteredVendors.length - 1)
              this.activeVendorIndex++;
            break;
          case "ArrowUp":
            event.preventDefault();
            if (this.activeVendorIndex > 0) this.activeVendorIndex--;
            break;
          case "Enter":
            event.preventDefault();
            if (this.activeVendorIndex >= 0)
              this.selectVendor(
                this.filteredVendors[this.activeVendorIndex]
              );
            break;
          case "Escape":
            this.isVendorDropdownVisible = false;
            break;
        }
      },
      syncVendorSearch(name) {
        this.vendorSearchTerm = name || "";
      },

      deleteVendor(vendor) {
        if (this.vendorUsageCount[vendor.id] > 0) {
          this.showToast(this.t("errorVendorInUse"), "error");
          return;
        }

        appUtils.ui.showConfirmation(this, {
          title: this.t("confirmDeletion"),
          message: this.t("confirmDeleteVendorMessage", {
            vendorName: vendor.name,
          }),
          onConfirm: async () => {
            try {
              await databaseService.db.vendors.delete(vendor.id);
              const index = this.vendors.findIndex(
                (v) => v.id === vendor.id
              );
              if (index > -1) {
                this.vendors.splice(index, 1);
                this.showToast(this.t("vendorDeletedSuccess"), "success");
              }
            } catch (error) {
              console.error("Error deleting vendor:", error);
              this.showToast(this.t("vendorDeleteFailed"), "error");
            }
          },
        });
      },
      deleteProject(project) {
        if (this.projectUsageCount[project.id] > 0) {
          this.showToast(this.t("errorProjectInUse"), "error");
          return;
        }

        appUtils.ui.showConfirmation(this, {
          title: this.t("confirmDeletion"),
          message: this.t("confirmDeleteProjectMessage", {
            projectName: project.name,
          }),
          onConfirm: async () => {
            try {
              await databaseService.db.projects.delete(project.id);
              const index = this.projects.findIndex(
                (p) => p.id === project.id
              );
              if (index > -1) {
                this.projects.splice(index, 1);
                this.showToast(this.t("projectDeletedSuccess"), "success");
              }
            } catch (error) {
              console.error("Error deleting project:", error);
              this.showToast(this.t("projectDeleteFailed"), "error");
            }
          },
        });
      },

      _getAppState() {
        return {
          projects: this.projects,
          vendors: this.vendors,
          banks: this.banks,
          contracts: this.contracts,
          cpcItems: this.cpcItems,
          installments: this.installments,
          bonds: this.bonds,
          cpcDetailRows: this.cpcDetailRows,
          categories: this.reportCategoriesFromDB,
        };
      },
      _loadState(data) {
        if (data) {
          this.projects = data.projects || [];
          this.vendors = data.vendors || [];
          this.banks = data.banks || [];
          this.contracts = data.contracts || [];
          this.cpcItems = data.cpcItems || [];
          this.installments = data.installments || [];
          this.bonds = data.bonds || [];
          this.cpcDetailRows =
            data.cpcDetailRows ||
            (Array.isArray(data.cpcDetailsData)
              ? []
              : this.migrateOldLocalStorageFormat(data.cpcDetailsData));
        }
      },
      migrateOldLocalStorageFormat(oldData) {
        if (!oldData || typeof oldData !== "object") return [];
        console.warn(
          "Migrating old backup file format to new cpcDetailRows structure."
        );
        const newRows = [];
        for (const contractId in oldData) {
          if (Array.isArray(oldData[contractId])) {
            oldData[contractId].forEach((row) => {
              newRows.push({ ...row, contractId });
            });
          }
        }
        return newRows;
      },
      async loadDataFromIndexedDB() {
        try {
          const data = await databaseService.getAllData();
          if (
            data &&
            (data.cpcItems?.length > 0 || data.contracts?.length > 0)
          ) {
            console.log("Successfully loaded data from IndexedDB.");
            this._loadState(data);

            // this._recalculateAllDetailRowsAfterLoad();

            return true;
          }
          console.log(
            "IndexedDB is empty. Will attempt to load from LocalStorage."
          );
          return false;
        } catch (error) {
          console.error("Failed to load data from IndexedDB:", error);
          this.showToast(
            "Unable to load data from browser database.",
            "error"
          );
          return false;
        }
      },

      backupDataToFile() {
        const rawData = this._getAppState();

        const cleanItem = (item, type) => {
          const cleaned = { ...item };

          const uiKeys = [
            "displayAmount",
            "displayAmountUsd",
            "displayAmountExclVAT",
            "displayVatAmount",
            "displayExchangeRate",
            "isExpanded",
            "_isBeingEdited",
            "_tempKey",
            "_parentTempKey",
            "amountFormatted",
            "totalAmountPaidFormatted",
            "originalAmount",
          ];
          uiKeys.forEach((key) => delete cleaned[key]);

          if (type !== "projects") delete cleaned.projectName;
          if (type !== "vendors") {
            delete cleaned.vendorName;
            delete cleaned.vendorNameAbbr;
            delete cleaned.vendorNo;
          }
          if (type !== "contracts") {
            delete cleaned.contractNo;
            delete cleaned.contractSystemNo;
            delete cleaned.code;
            delete cleaned.department;
          }

          if (cleaned.installments && Array.isArray(cleaned.installments)) {
            cleaned.installments = cleaned.installments.map((inst) =>
              cleanItem(inst, "installment")
            );
          }

          return cleaned;
        };

        const optimizedData = {
          type: "ProjectBackup",
          version: "2.0",
          exportedAt: new Date().toISOString(),

          projects: rawData.projects,
          vendors: rawData.vendors,
          banks: rawData.banks,

          contracts: rawData.contracts.map((c) =>
            cleanItem(c, "contracts")
          ),
          cpcItems: rawData.cpcItems.map((c) => cleanItem(c, "cpcItems")),
          installments: rawData.installments.map((i) =>
            cleanItem(i, "installments")
          ),
          bonds: rawData.bonds.map((b) => cleanItem(b, "bonds")),
          cpcDetailRows: rawData.cpcDetailRows.map((r) =>
            cleanItem(r, "cpcDetailRows")
          ),
          categories: rawData.categories,
        };

        const blob = new Blob([JSON.stringify(optimizedData)], {
          type: "application/json",
        });

        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `cpc_data_backup_opt_${appUtils.format.date(
          new Date()
        )}.json`;
        a.click();
        URL.revokeObjectURL(url);
        this.showToast(this.t("fileSaveSuccess"), "success");
      },
      debounce(func, delay) {
        let timeout;
        return function (...args) {
          const context = this;
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(context, args), delay);
        };
      },
      initializeFuse() {
        const contractList = this.contracts.map((item) => {
          const project = this.projectMap.get(item.projectId) || {};
          const vendor = this.vendorMap.get(item.vendorId) || {};
          const searchableString = [
            item.contractNo,
            vendor.name,
            project.name,
            item.description,
          ].join(" ");
          const dashboardItem =
            this.contractDashboardData.find((d) => d.id === item.id) || {};
          return {
            ...item,
            ...dashboardItem,
            type: "CONTRACT",
            projectName: project.name || "",
            vendorName: vendor.name || "",
            searchLabel: item.contractNo,
            searchSublabel: `${project.name || "N/A"} | ${vendor.name || "N/A"
              }`,
            normalizedSearchableString:
              appUtils.text.normalizeVietnamese(searchableString),
          };
        });

        const cpcList = this.processedCpcData.map((item) => {
          const searchableString = [
            item.cpcIdentifier,
            item.contractNo,
            item.vendorName,
            item.projectName,
            item.contents,
          ].join(" ");
          const cpcNumberMatch = item.cpcIdentifier
            ? item.cpcIdentifier.match(/\d+$/)
            : null;
          const cpcNumber = cpcNumberMatch
            ? parseInt(cpcNumberMatch[0], 10)
            : 0;

          return {
            ...item,
            type: "CPC",
            searchLabel: `${item.projectName} | ${item.cpcIdentifier} - ${item.contents}`,
            searchSublabel: `${item.contractNo} | ${item.vendorNameAbbr}`,
            normalizedSearchableString:
              appUtils.text.normalizeVietnamese(searchableString),
            cpcNumber: cpcNumber,
          };
        });

        const vendorList = this.vendors.map((vendor) => {
          const searchableString = [
            vendor.name,
            vendor.vendorNo,
            vendor.abbrName,
          ].join(" ");
          return {
            ...vendor,
            type: "VENDOR",
            searchLabel: vendor.name,
            searchSublabel: `Mã NCC: ${vendor.vendorNo}`,
            normalizedSearchableString:
              appUtils.text.normalizeVietnamese(searchableString),
          };
        });

        const actionList = this.commandActions.map((action) => ({
          ...action,
          type: "ACTION",
          normalizedSearchableString: appUtils.text.normalizeVietnamese(
            `${action.searchLabel} ${action.searchSublabel}`
          ),
        }));

        const listToSearch = [
          ...cpcList,
          ...contractList,
          ...vendorList,
          ...actionList,
        ];

        const options = {
          includeScore: true,
          minMatchCharLength: 2,
          threshold: 0.4,
          ignoreLocation: true,
          keys: [{ name: "normalizedSearchableString", weight: 1.0 }],
        };

        this.fuseInstance = new Fuse(listToSearch, options);
      },
      performSearch(term) {
        if (!this.fuseInstance || !term || term.length < 1) {
          this.commandSearchResults = [];
          return;
        }

        this.isSearching = true;
        const normalizedSearchTerm =
          appUtils.text.normalizeVietnamese(term);

        setTimeout(() => {
          const fuseResults =
            this.fuseInstance.search(normalizedSearchTerm);

          let finalResults = [];
          const limits = { CPC: 4, CONTRACT: 4, VENDOR: 2 };
          const MAX_TOTAL_RESULTS = 10;
          const addedIds = new Set();

          const cpcGroupedByContract = new Map();
          fuseResults.forEach((result) => {
            const item = result.item;
            if (item.type === "CPC") {
              if (!cpcGroupedByContract.has(item.contractId)) {
                cpcGroupedByContract.set(item.contractId, []);
              }
              cpcGroupedByContract.get(item.contractId).push(item);
            }
          });

          cpcGroupedByContract.forEach((cpcList) => {
            cpcList.sort((a, b) => b.cpcNumber - a.cpcNumber);
          });

          const otherResults = fuseResults
            .filter((result) => result.item.type !== "CPC")
            .map((r) => r.item);

          let cpcPool = Array.from(cpcGroupedByContract.values())
            .map((group) => group.shift())
            .filter(Boolean);
          let contractPool = otherResults.filter(
            (r) => r.type === "CONTRACT"
          );
          let vendorPool = otherResults.filter((r) => r.type === "VENDOR");
          let actionPool = otherResults.filter((r) => r.type === "ACTION");

          let cpcAdded = 0,
            contractAdded = 0,
            vendorAdded = 0;

          actionPool.forEach((item) => {
            if (
              finalResults.length < MAX_TOTAL_RESULTS &&
              !addedIds.has(item.id)
            ) {
              finalResults.push(this.createCommandResult(item));
              addedIds.add(item.id);
            }
          });

          while (finalResults.length < MAX_TOTAL_RESULTS) {
            let itemAddedInLoop = false;

            if (
              contractAdded < limits.CONTRACT &&
              contractPool.length > 0
            ) {
              const item = contractPool.shift();
              if (item && !addedIds.has(item.id)) {
                finalResults.push(this.createCommandResult(item));
                addedIds.add(item.id);
                contractAdded++;
                itemAddedInLoop = true;
              }
            }

            if (
              finalResults.length < MAX_TOTAL_RESULTS &&
              cpcAdded < limits.CPC &&
              cpcPool.length > 0
            ) {
              const item = cpcPool.shift();
              if (item && !addedIds.has(item.id)) {
                finalResults.push(this.createCommandResult(item));
                addedIds.add(item.id);
                cpcAdded++;
                itemAddedInLoop = true;
              }
            }

            if (
              finalResults.length < MAX_TOTAL_RESULTS &&
              vendorAdded < limits.VENDOR &&
              vendorPool.length > 0
            ) {
              const item = vendorPool.shift();
              if (item && !addedIds.has(item.id)) {
                finalResults.push(this.createCommandResult(item));
                addedIds.add(item.id);
                vendorAdded++;
                itemAddedInLoop = true;
              }
            }

            if (!itemAddedInLoop) break;
          }

          const typeOrder = { ACTION: 1, CONTRACT: 2, CPC: 3, VENDOR: 4 };

          finalResults.sort((a, b) => {
            const orderA = typeOrder[a.type.toUpperCase()] || 99;
            const orderB = typeOrder[b.type.toUpperCase()] || 99;
            if (orderA !== orderB) {
              return orderA - orderB;
            }
            return a.label.localeCompare(b.label, undefined, {
              numeric: true,
            });
          });

          this.commandSearchResults = finalResults;
          this.isSearching = false;
        }, 0);
      },

      createCommandResult(item) {
        const itemType = item.type.toUpperCase();
        let action = () => { };

        switch (itemType) {
          case "CPC":
            action = () => this.goToCpc(item);
            break;
          case "CONTRACT":
            action = () => this.goToContract(item);
            break;
          case "VENDOR":
            action = () => this.goToVendor(item);
            break;
          case "ACTION":
            action = item.action;
            break;
        }

        return {
          id: item.id || item.searchLabel,
          type: item.type,
          label: item.searchLabel,
          sublabel: item.searchSublabel,
          financialInfo: "",
          action: action,
          payload: item,
        };
      },
      async saveModal() {
        if (!this.currentEditItem) return;

        const dateFieldsToValidate = ["receivedDate", "paymentDueDate"];
        if (
          !this.validateDates(this.currentEditItem, dateFieldsToValidate)
        ) {
          return;
        }

        if (
          this.currentEditItem.installments.some(
            (inst) => inst.amount > 0 && !inst.date && !inst.isSwap
          )
        ) {
          this.currentEditItem.installments.forEach((inst) => {
            inst.isDateInvalid =
              inst.amount > 0 && !inst.date && !inst.isSwap;
          });
          this.showToast(this.t("errorPaymentDate"), "error");
          return;
        }

        const totalPaid = (this.currentEditItem.installments || [])
          .filter((i) => !i.isSwap)
          .reduce((acc, curr) => acc + (curr.amount || 0), 0);
        const cpcAmount = this.currentEditItem.amount;
        let validationError = false;
        if (cpcAmount >= 0) {
          if (totalPaid > cpcAmount) {
            validationError = true;
          }
        } else {
          if (totalPaid < 0 || totalPaid > Math.abs(cpcAmount)) {
            validationError = true;
          }
        }
        if (!this.currentEditItem.isUsd && validationError) {
          let errorMessage;
          if (cpcAmount >= 0) {
            errorMessage = this.t("errorPaymentExceedsDetails", {
              totalPaid: appUtils.format.currency(totalPaid),
              cpcAmount: appUtils.format.currency(cpcAmount),
              overExcessAmount: appUtils.format.currency(
                totalPaid - cpcAmount
              ),
            });
          } else {
            errorMessage = this.t("errorPaymentExceedsDetailsNegative", {
              totalPaid: appUtils.format.currency(totalPaid),
              cpcAmount: appUtils.format.currency(cpcAmount),
              absAmount: appUtils.format.currency(Math.abs(cpcAmount)),
            });
          }
          this.showToast(errorMessage, "error");
          return;
        }

        if (
          !this.currentEditItem.projectName ||
          !this.currentEditItem.vendorName
        ) {
          this.showToast(this.t("errorProjectVendorRequired"), "error");
          return;
        }

        const cpcDataToProcess = JSON.parse(
          JSON.stringify(this.currentEditItem)
        );
        const originalModalMode = this.modalMode;
        this.closeModal();

        try {
          await databaseService.db.transaction(
            "rw",
            databaseService.db.tables,
            async () => {
              const projectEntity =
                await databaseService.findOrCreateEntity(
                  "projects",
                  "name",
                  (cpcDataToProcess.projectName || "").trim()
                );
              const vendorEntity = await databaseService.findOrCreateEntity(
                "vendors",
                "vendorNo",
                (cpcDataToProcess.vendorNo || "").trim()
              );

              const contractNoTrimmed = (
                cpcDataToProcess.contractNo || ""
              ).trim();
              let masterContract = null;
              if (contractNoTrimmed) {
                masterContract = await databaseService.db.contracts
                  .where("contractNo")
                  .equalsIgnoreCase(contractNoTrimmed)
                  .first();
              }

              if (!masterContract && contractNoTrimmed) {
                const newContract = {
                  contractNo: contractNoTrimmed,
                  projectId: projectEntity.id,
                  vendorId: vendorEntity.id,
                  date:
                    cpcDataToProcess.receivedDate ||
                    new Date().toISOString().slice(0, 10),
                  description: cpcDataToProcess.contents,
                  code: cpcDataToProcess.code,
                  currency: cpcDataToProcess.isUsd ? "USD" : "VND",
                  settings: {
                    repaymentThreshold: 80,
                    retentionRate: 5,
                    defaultVatRate: 8,
                  },
                };
                const newId = await databaseService.db.contracts.add(
                  newContract
                );
                masterContract = { ...newContract, id: newId };
                this.showToast(
                  this.t("contractCreatedAutomatically"),
                  "info"
                );
              }

              cpcDataToProcess.projectId = projectEntity.id;
              cpcDataToProcess.vendorId = vendorEntity.id;
              cpcDataToProcess.contractId = masterContract
                ? masterContract.id
                : null;

              const installmentsData = cpcDataToProcess.installments || [];
              const bondsData = cpcDataToProcess.bonds || [];
              delete cpcDataToProcess.installments;
              delete cpcDataToProcess.bonds;

              if (
                originalModalMode === "add" ||
                originalModalMode === "copy"
              ) {
                delete cpcDataToProcess.id;
                const newId = await databaseService.db.cpcItems.add(
                  cpcDataToProcess
                );
                cpcDataToProcess.id = newId;
              } else {
                await databaseService.db.cpcItems.put(cpcDataToProcess);
              }

              const cpcId = cpcDataToProcess.id;

              await databaseService.db.installments
                .where("cpcId")
                .equals(cpcId)
                .delete();

              if (installmentsData.length > 0) {
                const installmentsToSave = installmentsData.map((inst) => ({
                  ...inst,
                  cpcId: cpcId,
                  contractId: masterContract?.id,
                  projectId: projectEntity.id,
                  vendorId: vendorEntity.id,
                }));
                await databaseService.db.installments.bulkPut(
                  installmentsToSave
                );
              }

              if (bondsData.length > 0) {
                const bondsToSave = bondsData.map((bond) => ({
                  ...bond,
                  cpcId: cpcId,
                  contractId: masterContract?.id,
                  projectId: projectEntity.id,
                  vendorId: vendorEntity.id,
                }));
                await databaseService.db.bonds.bulkPut(bondsToSave);
              }
            }
          );

          const freshData = await databaseService.getAllData();
          this._loadState(freshData);

          this.triggerReactivity();

          this.showToast(this.t("changesSavedSuccess"), "success");

          this.$nextTick(() => {
            this.syncPaymentsToDetails(
              cpcDataToProcess.contractId,
              cpcDataToProcess.id
            );
            this.syncTrackingToDetails(cpcDataToProcess);
            this.highlightAndScrollToItem(cpcDataToProcess.id);
            this.initializeFuse();
          });
        } catch (error) {
          console.error("Lỗi nghiêm trọng khi lưu CPC:", error);
          this.showToast(this.t("errorSavingCpc"), "error");

          const freshData = await databaseService.getAllData();
          this._loadState(freshData);
        }
      },

      async _findOrCreateEntity(
        entityArray,
        propertyName,
        value,
        tableName
      ) {
        const trimmedValue = value.trim();
        let entity = entityArray.find(
          (e) =>
            e[propertyName].trim().toLowerCase() ===
            trimmedValue.toLowerCase()
        );
        if (!entity) {
          const newEntity = { [propertyName]: trimmedValue };
          const newId = await databaseService.db[tableName].add(newEntity);
          entity = { id: newId, ...newEntity };
          entityArray.push(entity);
        }
        return entity;
      },
      autoFillFromMasterContract() {
        if (!this.currentEditItem || !this.currentEditItem.contractNo) {
          return;
        }

        const normalizedInputContractNo = this.currentEditItem.contractNo
          .trim()
          .toLowerCase();

        if (
          !normalizedInputContractNo ||
          normalizedInputContractNo === "n/a"
        ) {
          return;
        }

        const masterContract = this.contractByNumberMap.get(
          normalizedInputContractNo
        );

        if (masterContract) {
          const project =
            this.projectMap.get(masterContract.projectId) || {};
          const vendor = this.vendorMap.get(masterContract.vendorId) || {};

          this.currentEditItem.projectName = project.name || "";
          this.currentEditItem.vendorName = vendor.name || "";
          this.currentEditItem.code = masterContract.code || "";
          this.currentEditItem.department = masterContract.department || "";
          this.currentEditItem.contractSystemNo =
            masterContract.contractSystemNo || "";
          this.currentEditItem.vendorNo = vendor.vendorNo || "";
          this.currentEditItem.glAccount = masterContract.glAccount || "";
          this.currentEditItem.isUsd = masterContract.currency === "USD";
          this.showToast(this.t("contractDataAutoFilled"), "info");
        } else {
          if (typeof this.currentEditItem.vendorNo === "undefined") {
            this.currentEditItem.vendorNo = "";
          }
        }
      },

      initializeCalculationEngine() {
        const formulas = {
          contractVat: {
            manualFlag: "isContractVatManual",
            calculate: (row, context) => {
              if (context.isUsdContract) return 0;

              return Math.round(
                ((row.contractAmount || 0) + (row.contractVon || 0)) *
                ((row.contractPercentVat || 0) / 100)
              );
            },
          },

          contractTotal: {
            calculate: (row) =>
              Number(row.contractAmount || 0) +
              Number(row.contractVon || 0) +
              Number(row.contractVat || 0),
          },

          invoiceTotal: {
            calculate: (row) =>
              Number(row.invoiceAmount || 0) +
              Number(row.invoiceVat || 0),
          },

          invoiceAmountVND: {
            calculate: (row, context) =>
              context.isUsdContract
                ? Math.round(
                  (row.invoiceAmount || 0) *
                  (row.invoiceExchangeRate || 0)
                )
                : 0,
          },

          cpcPaymentOfWorkdone: {
            manualFlag: "isPoWManual",
            calculate: (row) =>
              Math.round(
                (row.cpcWorkDone || 0) * ((row.cpcPercentPoW || 0) / 100)
              ),
          },

          cpcAdvance: {
            manualFlag: "isAdvanceManual",
            calculate: (row, context) => {
              let baseAmount = 0;
              if (context.tableData && context.tableData.length > 0) {
                const relevantRows = row.phaseId
                  ? context.tableData.filter(
                    (r) => r.phaseId === row.phaseId
                  )
                  : context.tableData;

                const firstRow = relevantRows[0];
                baseAmount =
                  (firstRow?.contractAmount || 0) +
                  (firstRow?.contractVon || 0);
              }

              return Math.round(
                baseAmount * ((row.cpcPercentAdv || 0) / 100)
              );
            },
          },

          cpcVat: {
            manualFlag: "isVatManual",
            calculate: (row, context) => {
              if (row.isVatManual) {
                return row.cpcVat;
              }
              const vatRateToUse =
                row.cpcPercentVat ??
                (context.contractSettings?.defaultVatRate || 8);

              return Math.round(
                (row.cpcWorkDone || 0) * (vatRateToUse / 100)
              );
            },
          },

          cpcRepayment: {
            manualFlag: "isRepaymentManual",
            calculate: (row, context) => {
              if (
                row.cpcNo &&
                row.cpcNo.trim() !== "" &&
                !row._isBeingEdited
              )
                return row.cpcRepayment;
              if (row.isRepaymentManual) return row.cpcRepayment;
              if (
                !row.cpcNo &&
                !row.cpcWorkDone &&
                !row.cpcPaymentOfWorkdone
              )
                return 0;

              const { tableData, rowIndex, contractSettings } = context;
              if (!tableData) return 0;

              let relevantData = tableData;
              let adjustedRowIndex = rowIndex;

              if (row.phaseId) {
                relevantData = tableData.filter(
                  (r) => r.phaseId === row.phaseId
                );

                adjustedRowIndex = relevantData.findIndex(
                  (r) => r.id === row.id
                );

                if (adjustedRowIndex === -1)
                  adjustedRowIndex = relevantData.length;
              }

              const repaymentThreshold =
                (contractSettings.repaymentThreshold || 80) / 100;

              if ((row.cpcAdvance || 0) > 0) return 0;

              const totalAdvanceInPhase = relevantData.reduce(
                (sum, r) => sum + (Number(r.cpcAdvance) || 0),
                0
              );

              const totalRepaymentBefore = relevantData
                .slice(0, adjustedRowIndex)
                .reduce(
                  (sum, r) => sum + Math.abs(Number(r.cpcRepayment) || 0),
                  0
                );

              const remainingAdvanceToCollect =
                totalAdvanceInPhase - totalRepaymentBefore;

              if (remainingAdvanceToCollect <= 0) return 0;

              let finalValue = 0;

              if (row.isFinalSettlement) {
                finalValue = -1 * Math.round(remainingAdvanceToCollect);
              } else {
                const cumulativeWorkDone = relevantData
                  .slice(0, adjustedRowIndex + 1)
                  .reduce(
                    (sum, r) => sum + (Number(r.cpcWorkDone) || 0),
                    0
                  );

                const cumulativePoW = relevantData
                  .slice(0, adjustedRowIndex + 1)
                  .reduce(
                    (sum, r) => sum + (Number(r.cpcPaymentOfWorkdone) || 0),
                    0
                  );

                const valueToUse = row.useWorkdoneForRepayment
                  ? cumulativeWorkDone
                  : cumulativePoW;

                let basisItemIds = row.repaymentBasisItems;

                if (
                  !basisItemIds ||
                  !Array.isArray(basisItemIds) ||
                  basisItemIds.length === 0
                ) {
                  basisItemIds = relevantData
                    .slice(0, adjustedRowIndex + 1)
                    .filter(
                      (r) =>
                        (Number(r.contractAmount) || 0) +
                        (Number(r.contractVon) || 0) >
                        0
                    )
                    .map((r) => r.id);
                }

                const totalContractValue = relevantData
                  .filter((r) => basisItemIds.includes(r.id))
                  .reduce(
                    (sum, r) =>
                      sum +
                      (Number(r.contractAmount) || 0) +
                      (Number(r.contractVon) || 0),
                    0
                  );

                let totalRepaymentTarget = 0;
                if (totalContractValue > 0) {
                  const thresholdValue =
                    repaymentThreshold * totalContractValue;
                  if (thresholdValue > 0) {
                    totalRepaymentTarget =
                      (totalAdvanceInPhase * valueToUse) / thresholdValue;
                  }
                }

                const repaymentThisPeriod =
                  totalRepaymentTarget - totalRepaymentBefore;

                const actualRepayment = Math.min(
                  repaymentThisPeriod,
                  remainingAdvanceToCollect
                );

                finalValue = -1 * Math.round(Math.max(0, actualRepayment));
              }

              return finalValue;
            },
          },

          cpcAmountDue: {
            calculate: (row) =>
              Number(row.cpcPaymentOfWorkdone || 0) +
              Number(row.cpcAdvance || 0) +
              Number(row.cpcRepayment || 0) +
              Number(row.cpcRetention || 0) +
              Number(row.cpcOtherDeduction || 0),
          },

          remainingPayable: {
            isSummary: true,
            calculate: (row, context) => {
              const totalDue = context.isUsdContract
                ? row.invoiceTotal || 0
                : row.invoiceTotal || 0;
              const totalPaid = context.isUsdContract
                ? row.paymentTotalAmountUsd || 0
                : row.paymentGrandTotal || 0;
              return Math.round(totalDue - totalPaid);
            },
          },
          contractRemainingInclVat: {
            isSummary: true,
            calculate: (row, context) => {
              const totalDue = context.isUsdContract
                ? row.contractTotal || 0
                : row.contractTotal || 0;
              const totalPaid = context.isUsdContract
                ? row.paymentTotalAmountUsd || 0
                : row.paymentGrandTotal || 0;
              return Math.round(totalDue - totalPaid);
            },
          },
          contractRemainingExclVat: {
            isSummary: true,
            calculate: (row, context) => {
              const totalDue =
                (row.contractAmount || 0) + (row.contractVon || 0);
              const totalPaid = row.paymentTotalAmount || 0;
              return Math.round(totalDue - totalPaid);
            },
          },
          contractRemainingVat: {
            isSummary: true,
            calculate: (row, context) => {
              const totalDue = row.contractVat || 0;
              const totalPaid = row.paymentTotalVat || 0;
              return Math.round(totalDue - totalPaid);
            },
          },
        };

        this.calculationEngine = {
          formulas,
          calculationOrder: [
            "contractVat",
            "contractTotal",
            "invoiceTotal",
            "invoiceAmountVND",
            "cpcPaymentOfWorkdone",
            "cpcAdvance",
            "cpcRepayment",
            "cpcAmountDue",
            "cpcVat",
          ],
          summaryOrder: [
            "remainingPayable",
            "contractRemainingInclVat",
            "contractRemainingExclVat",
            "contractRemainingVat",
          ],
        };
      },
      runCalculationEngine(tableData, contract, startIndex = 0) {
        if (!this.calculationEngine) return tableData;

        if (!contract) {
          console.error(
            "Lỗi nghiêm trọng: runCalculationEngine được gọi mà không có thông tin hợp đồng."
          );
          return tableData;
        }
        const context = {
          isUsdContract: contract?.currency === "USD",
          contractSettings:
            contract?.settings || this.defaultNewContractItem.settings,
        };

        for (let i = startIndex; i < tableData.length; i++) {
          const row = tableData[i];
          context.rowIndex = i;
          context.tableData = tableData;

          this.calculationEngine.calculationOrder.forEach((field) => {
            const formula = this.calculationEngine.formulas[field];
            const isManual = formula.manualFlag && row[formula.manualFlag];

            if (!isManual) {
              row[field] = formula.calculate(row, context);
            }
          });
        }

        tableData.forEach((row, i) => {
          context.rowIndex = i;
          context.tableData = tableData;
          this.calculationEngine.summaryOrder.forEach((field) => {
            const formula = this.calculationEngine.formulas[field];
            row[field] = formula.calculate(row, context);
          });
        });

        return tableData;
      },
      recalculateDetailsTable(tableData, contractId) {
        if (!tableData || !Array.isArray(tableData)) return tableData;
        return this.runCalculationEngine(tableData);
      },
      updateFormulasInModal(changedField, isManual = false) {
        if (!this.currentDetailItem || this.isModalInitializing) return;

        const formula = this.calculationEngine.formulas[changedField];
        if (formula?.manualFlag) {
          this.currentDetailItem[formula.manualFlag] = isManual;
        }

        const contractId =
          this.viewStates.cpcDetails.filter.selectedContractId;
        const rowIndex = this.cpcDetailRows
          .filter((r) => r.contractId === contractId)
          .sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0))
          .findIndex((r) => r.id === this.currentDetailItem.id);

        if (rowIndex === -1) {
          console.error(
            "Không thể tìm thấy chỉ số của dòng đang sửa. Hủy tính toán."
          );
          return;
        }

        const tempTableData = this.cpcDetailRows
          .filter((r) => r.contractId === contractId)
          .map((r) => JSON.parse(JSON.stringify(r)))
          .sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));

        if (tempTableData[rowIndex]) {
          Object.assign(tempTableData[rowIndex], this.currentDetailItem);
        }

        const updatedTable = this.runCalculationEngine(
          tempTableData,
          this.selectedContractDetails,
          0
        );

        if (updatedTable[rowIndex]) {
          const fieldsToUpdate = [
            ...this.calculationEngine.calculationOrder,
            ...this.calculationEngine.summaryOrder,
          ];
          for (const field of fieldsToUpdate) {
            this.currentDetailItem[field] = updatedTable[rowIndex][field];
          }
        }
      },
      _setupDetailItemForEdit(item, index) {
        if (this.viewStates.cpcDetails.activePhaseId === "summary") {
          const hasPhases =
            (this.selectedContractDetails?.phases?.length || 0) > 0;
          if (hasPhases) {
            this.showToast(
              "Hợp đồng này có chia Giai đoạn. Vui lòng chọn Tab Giai đoạn cụ thể để chỉnh sửa.",
              "warning"
            );
            return;
          }
        }

        this.isModalInitializing = true;
        this.currentDetailItem = JSON.parse(JSON.stringify(item));
        this.currentDetailItem._isBeingEdited = true;
        this.currentDetailIndex = index;

        if (this.calculationEngine && this.selectedContractDetails) {
          const tempTable = [this.currentDetailItem];

          const contextTable = this.cpcDetailRows.filter(
            (r) => r.contractId === this.selectedContractDetails.id
          );

          const context = {
            isUsdContract: this.selectedContractDetails?.currency === "USD",
            contractSettings:
              this.selectedContractDetails?.settings ||
              this.defaultNewContractItem.settings,
            rowIndex: index,
            tableData: contextTable,
          };

          this.calculationEngine.calculationOrder.forEach((field) => {
            const formula = this.calculationEngine.formulas[field];
            const isManual =
              formula.manualFlag &&
              this.currentDetailItem[formula.manualFlag];
            if (!isManual) {
              this.currentDetailItem[field] = formula.calculate(
                this.currentDetailItem,
                context
              );
            }
          });
        }

        this.$nextTick(() => {
          this.isModalInitializing = false;
        });
      },
      toggleRepaymentBasis(basisId) {
        if (!this.currentDetailItem) return;
        if (
          this.currentDetailItem.repaymentBasisItems === null ||
          this.currentDetailItem.repaymentBasisItems === undefined
        ) {
          this.currentDetailItem.repaymentBasisItems = [];
        }

        const index =
          this.currentDetailItem.repaymentBasisItems.indexOf(basisId);
        if (index > -1) {
          this.currentDetailItem.repaymentBasisItems.splice(index, 1);
        } else {
          this.currentDetailItem.repaymentBasisItems.push(basisId);
        }

        this.updateFormulasInModal("cpcRepayment", false);
      },
      toggleFilterPanel(viewState) {
        viewState.isFilterCollapsed = !viewState.isFilterCollapsed;
      },
      activeFiltersSummary(viewState) {
        const summaries = [];
        const filter = viewState.filter;

        const addSummaryById = (labelKey, ids, sourceArray) => {
          if (ids && ids.length > 0) {
            const names = ids
              .map(
                (id) =>
                  sourceArray.find((item) => item.id === id)?.name || id
              )
              .join(", ");
            summaries.push(`${this.t(labelKey)}: ${names}`);
          }
        };
        const addSummaryByContractId = (labelKey, ids) => {
          if (ids && ids.length > 0) {
            const names = ids
              .map(
                (id) =>
                  this.contracts.find((item) => item.id === id)
                    ?.contractNo || id
              )
              .join(", ");
            summaries.push(`${this.t(labelKey)}: ${names}`);
          }
        };
        const addSummaryByValue = (labelKey, values) => {
          if (values && values.length > 0) {
            summaries.push(`${this.t(labelKey)}: ${values.join(", ")}`);
          }
        };

        addSummaryById("project", filter.projectId, this.projects);
        addSummaryById("vendor", filter.vendorId, this.vendors);
        addSummaryByContractId("contract", filter.contractId);
        addSummaryByValue(
          "status",
          filter.status?.map((s) =>
            this.t(s.toLowerCase().replace(/ /g, ""))
          )
        );
        addSummaryByValue("code", filter.code);
        addSummaryByValue("paymentSource", filter.paymentSource);
        addSummaryByValue("vendorSWAP", filter.vendorSWAP);
        addSummaryByValue("bondType", filter.bondType);
        addSummaryByValue("status", filter.status);

        if (filter.startDate && filter.endDate) {
          summaries.push(
            `${this.t("dateRange")}: ${filter.startDate} → ${filter.endDate
            }`
          );
        }

        return summaries.length > 0
          ? summaries.join("; ")
          : this.t("noActiveFilters");
      },
      handleGlobalKeyDown(event) {
        this.handlePaginationShortcut(event);
        if ((event.ctrlKey || event.metaKey) && event.key === "i") {
          event.preventDefault();
          this.toggleCommandPalette();
        }

        if (event.altKey && event.key.toLowerCase() === "p") {
          if (this.currentTab === "cpc-tracking") {
            event.preventDefault();
            this.toggleProjectQuickFilter();
          }
        }

        if (event.altKey && event.key.toLowerCase() === "c") {
          event.preventDefault();
          this.clearAllFilters();
        }

        if (event.key === "/") {
          const target = event.target;
          if (
            target.tagName === "INPUT" ||
            target.tagName === "TEXTAREA" ||
            target.tagName === "SELECT"
          ) {
            return;
          }

          if (this.currentTab === "cpc-tracking") {
            event.preventDefault();
            this.$nextTick(() => {
              const searchInput = this.$refs.cpcSearchInput;
              if (searchInput) {
                searchInput.focus();
                searchInput.select();
              }
            });
          } else if (this.currentTab === "master-data") {
            event.preventDefault();
            this.$nextTick(() => {
              let searchInput = null;

              if (this.masterData.activeSubTab === "vendors") {
                searchInput = this.$refs.vendorSearchInput;
              } else if (this.masterData.activeSubTab === "projects") {
                searchInput = this.$refs.projectSearchInput;
              }

              if (searchInput) {
                searchInput.focus();
                searchInput.select();
              }
            });
          } else if (this.currentTab === "vendor-balance") {
            event.preventDefault();
            this.$nextTick(() => {
              const searchInput = this.$refs.vendorBalanceSearchInput;
              if (searchInput) {
                searchInput.focus();
                searchInput.select();
              }
            });
          }
          else if (this.currentTab === "vendor-partner") {
            event.preventDefault();
            this.$nextTick(() => {
              const searchInput = this.$refs.vendorPartnerSearchInput;
              if (searchInput) {
                searchInput.focus();
                searchInput.select();
              }
            });
          }
        }

        if (event.altKey && event.key.toLowerCase() === "n") {
          event.preventDefault();
          this.toggleNotificationDropdown();
        }
        if (event.key === "Escape" && this.isNotesModalVisible) {
          this.closeNotesModal();
        }
      },
      toggleCommandPalette(forceState = null) {
        this.isCommandPaletteVisible =
          forceState !== null ? forceState : !this.isCommandPaletteVisible;
        if (this.isCommandPaletteVisible) {
          this.commandSearchTerm = "";
          this.activeCommandIndex = 0;
          this.$nextTick(() => {
            this.$refs.commandInput?.focus();
          });
        }
      },
      navigateCommands(direction) {
        if (this.commandResults.length === 0) return;
        if (direction === "down") {
          this.activeCommandIndex =
            (this.activeCommandIndex + 1) % this.commandResults.length;
        } else if (direction === "up") {
          this.activeCommandIndex =
            (this.activeCommandIndex - 1 + this.commandResults.length) %
            this.commandResults.length;
        }

        this.$nextTick(() => {
          const list = this.$refs.commandInput
            ?.closest(".command-palette-dialog")
            ?.querySelector(".command-results-list");
          const activeItem = list?.querySelector(
            ".command-result-item.active"
          );

          if (activeItem) {
            activeItem.scrollIntoView({
              block: "nearest",
            });
          }
        });
      },
      executeActiveCommand() {
        if (this.commandResults[this.activeCommandIndex]) {
          this.executeCommand(this.commandResults[this.activeCommandIndex]);
        }
      },
      executeCommand(command) {
        if (typeof command.action === "function") {
          command.action();
        }
        this.toggleCommandPalette(false);
      },
      goToCpc(payload) {
        this.currentTab = "cpc-tracking";
        const filters = this.viewStates.cpcTracking.filter;
        filters.projectId = payload.projectId ? [payload.projectId] : [];
        this.$nextTick(() => {
          filters.vendorId = payload.vendorId ? [payload.vendorId] : [];
          this.$nextTick(() => {
            filters.contractId = payload.contractId
              ? [payload.contractId]
              : [];
            filters.status = [];
            this.$nextTick(() => {
              this.highlightAndScrollToItem(payload.id);
            });
          });
        });
      },
      goToContract(payload) {
        this.currentTab = "cpc-details";
        const filters = this.viewStates.cpcDetails.filter;
        filters.projectId = payload.projectId ? [payload.projectId] : [];
        this.$nextTick(() => {
          filters.vendorId = payload.vendorId ? [payload.vendorId] : [];
          this.$nextTick(() => {
            filters.selectedContractId = payload.id;
          });
        });
      },
      goToVendor(payload) {
        this.currentTab = "master-data";
        this.masterData.activeSubTab = "vendors";
        this.masterData.vendors.searchTerm = payload.name;
        this.toggleCommandPalette(false);
      },
      goToContractDetails(item) {
        if (!item.projectId || !item.vendorId || !item.contractId) {
          this.showToast(
            "Project, Vendor, or Contract information is missing.",
            "warning"
          );
          return;
        }

        this.viewStates.cpcDetails.filter.projectId = [item.projectId];
        this.viewStates.cpcDetails.filter.vendorId = [item.vendorId];

        this.$nextTick(() => {
          this.viewStates.cpcDetails.filter.selectedContractId =
            item.contractId;
          this.currentTab = "cpc-details";
        });
      },
      goToContractDetailsFromDashboard(item) {
        const contractId = item.contractId || item.id;
        const contract = this.contracts.find((c) => c.id === contractId);
        if (!contract || !contract.projectId || !contract.vendorId) {
          this.showToast(
            "Project, Vendor, or Contract information is missing.",
            "warning"
          );
          return;
        }
        this.viewStates.cpcDetails.filter.projectId = [contract.projectId];
        this.viewStates.cpcDetails.filter.vendorId = [contract.vendorId];

        this.$nextTick(() => {
          this.viewStates.cpcDetails.filter.selectedContractId =
            contract.id;
          this.currentTab = "cpc-details";
        });
      },
      _prepareEditItem(item) {
        this.currentEditItem = JSON.parse(JSON.stringify(item));

        if (
          (!this.currentEditItem.vendorNo ||
            this.currentEditItem.vendorNo === "N/A") &&
          this.currentEditItem.vendorId
        ) {
          const vendor = this.vendorMap.get(this.currentEditItem.vendorId);
          if (vendor) {
            this.currentEditItem.vendorNo = vendor.vendorNo;
            this.currentEditItem.vendorName = vendor.name;
            if (!this.currentEditItem.vendorNameAbbr) {
              this.currentEditItem.vendorNameAbbr = vendor.abbrName;
            }
          }
        }

        this.currentEditItem.cpcIdentifier =
          this.currentEditItem.cpcIdentifier || this.currentEditItem.cpc;

        this.currentEditItem.displayAmountExclVAT = (
          this.currentEditItem.amountExclVAT || 0
        ).toLocaleString("vi-VN");
        this.currentEditItem.displayVatAmount = (
          this.currentEditItem.vatAmount || 0
        ).toLocaleString("vi-VN");
        this.currentEditItem.displayAmount = (
          this.currentEditItem.amount || 0
        ).toLocaleString("vi-VN");
        this.currentEditItem.displayAmountUsd = (
          this.currentEditItem.amountUsd || 0
        ).toLocaleString("en-US", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
        this.currentEditItem.displayExchangeRate = (
          this.currentEditItem.exchangeRate || 0
        ).toLocaleString("vi-VN");

        (this.currentEditItem.installments || []).forEach((inst) => {
          inst.displayAmount = (inst.amount || 0).toLocaleString("vi-VN");
          if (inst.isUsd) {
            inst.displayAmountUsd = (inst.amountUsd || 0).toLocaleString(
              "en-US",
              { minimumFractionDigits: 2, maximumFractionDigits: 2 }
            );
            inst.displayExchangeRate = (
              inst.exchangeRate || 0
            ).toLocaleString("vi-VN");
          }
          if (inst.swapPayments) {
            inst.swapPayments.forEach(
              (p) =>
                (p.displayAmount = (p.amount || 0).toLocaleString("vi-VN"))
            );
          }
        });

        this.autoFillFromMasterContract();
      },
      openFinancialsModal(item) {
        this._prepareEditItem(item);
        this.modalMode = "financials";

        this.shouldFocusPaymentDate = true;

        if (!this.currentEditItem.installments || this.currentEditItem.installments.length === 0) {
          this.addInstallment();
        }

        appUtils.ui.toggleModal("cpcDetailModal", "show");
      },
      toggleCurrencyDisplay(item) {
        const originalItem = this.cpcItems.find((d) => d.id === item.id);
        if (originalItem) {
          if (originalItem.displayAmountInUsd === undefined) {
            originalItem.displayAmountInUsd = false;
          }
          originalItem.displayAmountInUsd =
            !originalItem.displayAmountInUsd;
        }
      },
      exportReportToExcel() {
        if (this.reportData.length === 0) {
          this.showToast("Không có dữ liệu báo cáo để xuất.", "warning");
          return;
        }
        const wb = XLSX.utils.book_new();
        const ws_name = "Report Dashboard";
        const ws_data = [];
        const header1 = [
          this.t("category"),
          this.t("reportPaidToDateHeader", {
            date: this.formattedAsOfDate,
          }),
          null,
          null,
          this.t("reportRemainingFromDateHeader", {
            date: this.formattedAsOfDate,
          }),
          null,
          null,
          this.t("reportPaidInMonthHeader", {
            month: this.formattedReportMonth,
          }),
          null,
          null,
        ];
        const header2 = [
          null,
          "Net",
          "VAT",
          "Total",
          "Net",
          "VAT",
          "Total",
          "Net",
          "VAT",
          "Total",
        ];
        ws_data.push(header1, header2);

        const level1RowIndices = [];

        this.reportData.forEach((item, index) => {
          const excelRowIndex = ws_data.length + 1;
          const indent = " ".repeat((item.level - 1) * 4);

          const row = [
            `${indent}${item.code} ${item.name}`,
            item.metrics.paidToDate.net,
            item.metrics.paidToDate.vat,
            item.metrics.paidToDate.total,
            item.metrics.remaining.net,
            item.metrics.remaining.vat,
            item.metrics.remaining.total,
            item.metrics.paidInMonth.net,
            item.metrics.paidInMonth.vat,
            item.metrics.paidInMonth.total,
          ];

          if (item.level === 1) {
            level1RowIndices.push(excelRowIndex);

            let childCount = 0;
            for (let i = index + 1; i < this.reportData.length; i++) {
              if (this.reportData[i].level > 1) {
                childCount++;
              } else {
                break;
              }
            }

            if (childCount > 0) {
              const startChildRow = excelRowIndex + 1;
              const endChildRow = excelRowIndex + childCount;
              row[3] = {
                t: "n",
                f: `SUBTOTAL(9,B${startChildRow}:B${endChildRow})+SUBTOTAL(9,C${startChildRow}:C${endChildRow})`,
              };
              row[6] = {
                t: "n",
                f: `SUBTOTAL(9,E${startChildRow}:E${endChildRow})+SUBTOTAL(9,F${startChildRow}:F${endChildRow})`,
              };
              row[9] = {
                t: "n",
                f: `SUBTOTAL(9,H${startChildRow}:H${endChildRow})+SUBTOTAL(9,I${startChildRow}:I${endChildRow})`,
              };
              row[1] = {
                t: "n",
                f: `SUBTOTAL(9,B${startChildRow}:B${endChildRow})`,
              };
              row[2] = {
                t: "n",
                f: `SUBTOTAL(9,C${startChildRow}:C${endChildRow})`,
              };
              row[4] = {
                t: "n",
                f: `SUBTOTAL(9,E${startChildRow}:E${endChildRow})`,
              };
              row[5] = {
                t: "n",
                f: `SUBTOTAL(9,F${startChildRow}:F${endChildRow})`,
              };
              row[7] = {
                t: "n",
                f: `SUBTOTAL(9,H${startChildRow}:H${endChildRow})`,
              };
              row[8] = {
                t: "n",
                f: `SUBTOTAL(9,I${startChildRow}:I${endChildRow})`,
              };
            }
          }

          ws_data.push(row);
        });

        const footerRow = [this.t("grandTotal")];
        for (let i = 1; i <= 9; i++) {
          const colLetter = XLSX.utils.encode_col(i);
          const formula = `SUM(${level1RowIndices
            .map((r) => `${colLetter}${r}`)
            .join(",")})`;
          footerRow.push({ t: "n", f: formula });
        }
        ws_data.push(footerRow);
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        const colWidths = [];
        ws_data.forEach((row) => {
          row.forEach((cell, i) => {
            const cellValue = cell
              ? cell.f
                ? "0".repeat(15)
                : cell.toString()
              : "";
            const currentLength = cellValue.length;
            if (!colWidths[i] || currentLength > colWidths[i]) {
              colWidths[i] = currentLength;
            }
          });
        });
        ws["!cols"] = colWidths.map((width) => ({ wch: width + 2 }));
        ws["!merges"] = [
          { s: { r: 0, c: 0 }, e: { r: 1, c: 0 } },
          { s: { r: 0, c: 1 }, e: { r: 0, c: 3 } },
          { s: { r: 0, c: 4 }, e: { r: 0, c: 6 } },
          { s: { r: 0, c: 7 }, e: { r: 0, c: 9 } },
        ];
        XLSX.utils.book_append_sheet(wb, ws, ws_name);
        const fileName = `Report_Dashboard_${this.viewStates.reportDashboard.reportMonth}.xlsx`;
        XLSX.writeFile(wb, fileName);

        this.showToast(`${this.t("btnExport")} thành công!`, "success");
      },
      printReport() {
        window.print();
      },
      getGroupColspan(groupKey, exceptKeys = []) {
        if (groupKey === "remainingPayable") {
          return this.viewStates.cpcDetails.columnVisibility
            .remainingPayable
            ? 1
            : 0;
        }

        if (!this.viewStates.cpcDetails.columnVisibility[groupKey])
          return 0;

        const subColumnsForGroup = this.detailsAllSubColumns.filter(
          (c) => c.group === groupKey
        );
        let visibleCount = 0;

        subColumnsForGroup.forEach((sc) => {
          if (
            this.viewStates.cpcDetails.subColumnVisibility[sc.key] &&
            !exceptKeys.includes(sc.key)
          ) {
            visibleCount++;
          }
        });

        return visibleCount > 0 ? visibleCount : 0;
      },
      getOrdinal(n) {
        if (this.language !== "en") return "";
        const s = ["th", "st", "nd", "rd"];
        const v = n % 100;
        return s[(v - 20) % 10] || s[v] || s[0];
      },
      handleSort(state, key) {
        if (state.sortBy === key) {
          state.sortDirection =
            state.sortDirection === "asc" ? "desc" : "asc";
        } else {
          state.sortBy = key;
          const descendingByDefault = [
            "receivedDate",
            "date",
            "paymentDueDate",
          ];
          state.sortDirection = descendingByDefault.includes(key)
            ? "desc"
            : "asc";
        }
      },
      toggleModal(modalId, action = "show") {
        const modalEl = document.getElementById(modalId);
        if (modalEl) {
          const modalInstance =
            bootstrap.Modal.getInstance(modalEl) ||
            new bootstrap.Modal(modalEl);
          if (action === "show") {
            modalInstance.show();
          } else if (action === "hide") {
            modalInstance.hide();
          }
        }
      },
      clearModalData(modalId) {
        switch (modalId) {
          case "cpcDetailModal":
            this.currentEditItem = null;
            this.modalMode = "edit";
            break;
          case "swapEditModal":
            this.currentEditSwap = null;
            break;
          case "contractDetailModal":
            this.currentEditContract = null;
            this.contractModalMode = "add";
            break;
          case "bondDetailViewModal":
            this.currentViewBondItem = null;
            break;
          case "bondEditModal":
            this.currentEditBond = null;
            break;
          case "installmentEditModal":
            this.currentEditInstallment = null;
            break;
          case "renewBondModal":
            this.currentRenewBond = null;
            this.newBondDetails = {
              bondNumber: "",
              ref: "",
              bondType: "",
              amount: 0,
              displayAmount: "",
              issueDate: "",
              expiryDate: "",
              issuingBank: "",
              isSettled: false,
              settlementReasonDisplay: "",
              renewedFromBondId: null,
              renewalNotes: "",
              renewalDate: "",
            };
            break;
          case "statusUpdateModal":
            this.currentStatusUpdate = null;
            break;
          case "contractDetailsModal":
          case "cpcDetailsModal":
          case "paymentDetailsModal":
          case "invoiceDetailsModal":
            this.currentDetailItem = null;
            this.currentDetailIndex = -1;
            this.showRepaymentBasisConfig = false;
            this.isVatOverrideVisible = false;
            this.isContractVatOverrideVisible = false;
            this.invoiceSelectedRowIds = [];
            break;
        }
      },

      toggleDetailsCurrencyView() {
        const currentView = this.viewStates.cpcDetails.currencyView;
        this.viewStates.cpcDetails.currencyView =
          currentView === "USD" ? "VND" : "USD";
      },
      toggleDetailRowExpand(item) {
        const originalItem = this.cpcDetailRows.find(
          (d) => d.id === item.id
        );
        if (originalItem) {
          originalItem.isExpanded = !originalItem.isExpanded;
        }
      },
      formatDetailsCurrency(value) {
        if (value === 0 || !value) return " - ";

        const isUsdContract = this.isCurrentContractUSD;
        const view = this.viewStates.cpcDetails.currencyView;

        if (isUsdContract && view === "USD") {
          return this.formatCurrencyUSD(value);
        }
        return appUtils.format.currency(value);
      },
      getStatusBadgeClass(status) {
        if (status === "Closed") {
          return "badge bg-secondary";
        }
        return "badge bg-primary";
      },
      async openStatusUpdateModal(contract) {
        if (!contract) return;
        this.currentStatusUpdate = {
          id: contract.id,
          status: contract.status || "Active",
          statusNote: contract.statusNote || "",
        };
        appUtils.ui.toggleModal("statusUpdateModal", "show");
      },
      closeStatusUpdateModal() {
        appUtils.ui.toggleModal("statusUpdateModal", "hide");
      },
      async saveStatusUpdate() {
        if (!this.currentStatusUpdate) return;
        const contractIndex = this.contracts.findIndex(
          (c) => c.id === this.currentStatusUpdate.id
        );
        if (contractIndex !== -1) {
          const contractToUpdate = JSON.parse(
            JSON.stringify(this.contracts[contractIndex])
          );
          contractToUpdate.status = this.currentStatusUpdate.status;
          contractToUpdate.statusNote = this.currentStatusUpdate.statusNote;

          try {
            await databaseService.db.contracts.put(contractToUpdate);
            this.contracts[contractIndex] = contractToUpdate;
            this.showToast(this.t("contractStatusUpdated"), "success");
          } catch (error) {
            console.error("Error updating contract status:", error);
            this.showToast("Failed to update contract status.", "error");
          }
        }
        this.closeStatusUpdateModal();
      },
      downloadDetailsTemplate() {
        // Lấy hợp đồng đang chọn (nếu có)
        const selectedContractId = this.viewStates.cpcDetails.filter.selectedContractId;
        const selectedContract = this.contracts.find(c => c.id === selectedContractId);

        const headers = [
          "contractNo", "phaseName", "contractInfo", "description",
          "contractAmount", "contractVon", "contractPercentVat", "contractVat",
          "cpcNo", "cpcDueDate", "cpcWorkDone", "cpcPercentPoW",
          "cpcPaymentOfWorkdone", "cpcPercentAdv", "cpcAdvance",
          "cpcRepayment", "cpcRetention", "cpcOtherDeduction",
          "cpcPercentVat", "cpcVat", "invoiceNo", "invoiceDate",
          "invoicePostingDate", "invoiceAmount", "invoiceVat",
          "paymentDate", "paymentAmount"
        ];

        // Tạo dữ liệu mẫu nếu có hợp đồng đang chọn
        const data = selectedContract ? [{ "contractNo": selectedContract.contractNo }] : [];

        const ws = XLSX.utils.json_to_sheet(data, { header: headers });
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Details");
        XLSX.writeFile(wb, `CPC_Details_Template.xlsx`);
      },

      triggerDetailsFileUpload() {
        this.$refs.uploadDetailsExcelInput.click();
      },
      async handleDetailsFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const workbook = XLSX.read(new Uint8Array(e.target.result), { type: "array" });
            const sheetName = workbook.SheetNames[0];
            const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { raw: false, defval: null });

            if (jsonData.length === 0) return;

            // Gom nhóm theo contractNo
            const groupedData = jsonData.reduce((acc, row) => {
              const cNo = row.contractNo ? String(row.contractNo).trim() : "UNKNOWN";
              if (!acc[cNo]) acc[cNo] = [];
              acc[cNo].push(row);
              return acc;
            }, {});

            // Xác thực và chuẩn bị mapping
            const contractMapping = {};
            const invalidContracts = [];
            for (const cNo in groupedData) {
              if (cNo === "UNKNOWN") continue;
              const contract = this.contracts.find(c => c.contractNo.toLowerCase() === cNo.toLowerCase());
              if (contract) contractMapping[cNo] = contract;
              else invalidContracts.push(cNo);
            }

            if (invalidContracts.length > 0) {
              this.showToast(`Hợp đồng không tồn tại: ${invalidContracts.join(", ")}`, "error");
              return;
            }

            appUtils.ui.showConfirmation(this, {
              title: "Tải dữ liệu đa hợp đồng",
              message: `Xử lý <strong>${Object.keys(contractMapping).length}</strong> hợp đồng. Chọn phương thức:`,
              confirmButtonText: "Ghi đè tất cả",
              confirmButtonClass: "btn-danger",
              neutralButtonText: "Nối tiếp tất cả",
              onConfirm: () => this.processMultiContractUpload(groupedData, contractMapping, true),
              onNeutral: () => this.processMultiContractUpload(groupedData, contractMapping, false),
            });
          } catch (error) {
            console.error(error);
            this.showToast("Lỗi xử lý file.", "error");
          } finally { event.target.value = ""; }
        };
        reader.readAsArrayBuffer(file);
      },

      async processMultiContractUpload(groupedByContract, contractMapping, isOverwrite) {
        this.showToast("Đang đồng bộ dữ liệu Hợp đồng & Thanh toán...", "info");

        try {
          for (const cNo in groupedByContract) {
            const contract = contractMapping[cNo];
            const excelRows = groupedByContract[cNo];

            // --- 1. TỰ ĐỘNG TẠO PHASE ---
            if (!contract.phases) contract.phases = [];
            let contractChanged = false;
            excelRows.forEach(row => {
              const pName = row.phaseName ? String(row.phaseName).trim() : null;
              if (pName && !contract.phases.find(p => p.name === pName)) {
                contract.phases.push({ id: "phase_" + Date.now() + Math.random(), name: pName });
                contractChanged = true;
              }
            });
            if (contractChanged) await databaseService.db.contracts.put(JSON.parse(JSON.stringify(contract)));

            // --- 2. GOM NHÓM THEO PHASE ĐỂ CHÈN DÒNG TRỐNG ---
            const rowsByPhase = {};
            excelRows.forEach(row => {
              const pName = row.phaseName ? String(row.phaseName).trim() : "Default";
              if (!rowsByPhase[pName]) rowsByPhase[pName] = [];
              rowsByPhase[pName].push(row);
            });

            const finalRowsToSave = [];
            const syncOnlyRows = [];

            // Duyệt từng Phase của Hợp đồng này
            for (const pName in rowsByPhase) {
              const phase = contract.phases.find(p => p.name === pName);
              const phaseId = phase ? phase.id : null;
              const pRows = rowsByPhase[pName];

              pRows.forEach(row => {
                const hasStructuralData = !!(
                  row.contractInfo ||
                  row.description ||
                  row.contractAmount ||
                  row.contractVon ||
                  row.contractVat ||
                  row.cpcWorkDone ||
                  row.cpcAdvance ||
                  row.cpcRepayment ||
                  row.cpcRetention ||      // Thêm kiểm tra này
                  row.cpcOtherDeduction ||  // Thêm kiểm tra này
                  row.invoiceNo
                );

                const newRow = this.createEmptyDetailRow(contract.id, 0);
                newRow.phaseId = phaseId;

                // --- DANH SÁCH TRƯỜNG SỐ CẦN UPDATE (Đã bổ sung các trường bạn yêu cầu) ---
                const numericKeys = [
                  "contractAmount", "contractVon", "contractPercentVat", "contractVat",
                  "cpcWorkDone", "cpcPercentPoW", "cpcPaymentOfWorkdone",
                  "cpcPercentAdv", "cpcAdvance", "cpcRepayment",
                  "cpcRetention", "cpcOtherDeduction", "cpcPercentVat", "cpcVat",
                  "invoiceAmount", "invoiceVat", "paymentAmount"
                ];

                for (const key in row) {
                  if (newRow.hasOwnProperty(key) || key === "paymentAmount") {
                    if (numericKeys.includes(key)) {
                      const val = Number(String(row[key] || 0).replace(/,/g, ""));
                      if (key !== "paymentAmount") newRow[key] = val;
                      else newRow.tempPaymentAmount = val;
                    } else if (!["contractNo", "phaseName"].includes(key)) {
                      newRow[key] = row[key];
                    }
                  }
                }

                // Lưu biến tạm cho thanh toán
                newRow.tempCpcNoForSync = row.cpcNo ? String(row.cpcNo).trim() : "";
                if (row.paymentDate) {
                  newRow.tempPaymentDate = appUtils.format.date(new Date(row.paymentDate));
                }

                // --- THIẾT LẬP CỜ THỦ CÔNG (Để engine không tính đè dữ liệu Excel) ---
                newRow.isContractVatManual = !!row.contractVat; // Nếu Excel có tiền VAT thì ưu tiên tiền VAT
                newRow.isVatManual = !!row.cpcVat;
                newRow.isPoWManual = true;
                newRow.isAdvanceManual = true;
                newRow.isRepaymentManual = true;

                if (hasStructuralData) finalRowsToSave.push(newRow);
                else if (newRow.tempCpcNoForSync) syncOnlyRows.push(newRow);
              });

              // CHÈN 3 DÒNG TRỐNG VÀO CUỐI MỖI PHASE
              for (let i = 0; i < 3; i++) {
                const empty = this.createEmptyDetailRow(contract.id, 0);
                empty.phaseId = phaseId;
                finalRowsToSave.push(empty);
              }
            }

            // --- 3. LƯU VÀO DATABASE ---
            if (isOverwrite) {
              await databaseService.db.cpcDetailRows.where("contractId").equals(contract.id).delete();
            }

            const maxSort = isOverwrite ? -1 : (this.cpcDetailRows
              .filter(r => r.contractId === contract.id)
              .reduce((max, r) => Math.max(max, r.sortOrder || 0), -1));

            finalRowsToSave.forEach((r, i) => r.sortOrder = maxSort + 1 + i);

            // Chạy engine tính toán lũy kế và tổng cộng
            const calculatedRows = this.runCalculationEngine(finalRowsToSave, contract);
            await databaseService.db.cpcDetailRows.bulkAdd(JSON.parse(JSON.stringify(calculatedRows)));

            // --- 4. ĐỒNG BỘ 2 CHIỀU ---
            const allRowsForSync = [...calculatedRows, ...syncOnlyRows];
            await this._internalBulkSyncFromData(contract, allRowsForSync);
            await this.syncPaymentsToDetails(contract.id);
          }

          const freshData = await databaseService.getAllData();
          this._loadState(freshData);
          this.showToast("Đã cập nhật toàn bộ dữ liệu Hợp đồng, VAT và dòng trống!", "success");

        } catch (err) {
          console.error(err);
          this.showToast("Lỗi đồng bộ dữ liệu.", "error");
        }
      },

      async _internalBulkSyncFromData(contract, allRows) {
        const isUsd = contract.currency === "USD";
        const groupedByCpc = allRows.reduce((acc, row) => {
          if (!row.tempCpcNoForSync) return acc;
          const cpcKey = row.tempCpcNoForSync;
          if (!acc[cpcKey]) acc[cpcKey] = { rows: [], payments: [] };
          acc[cpcKey].rows.push(row);

          // Nếu có dữ liệu thanh toán
          if (row.tempPaymentDate && row.tempPaymentAmount) {
            acc[cpcKey].payments.push({
              date: row.tempPaymentDate,
              amount: row.tempPaymentAmount,
              paymentSource: "Excel Upload"
            });
          }
          return acc;
        }, {});

        for (const cpcNo in groupedByCpc) {
          const data = groupedByCpc[cpcNo];
          const aggregated = this._aggregateCpcDataFromDetailRows(data.rows, isUsd);

          let existingCpc = this.cpcItems.find(c => c.contractId === contract.id && c.cpcIdentifier === cpcNo);
          let targetCpcId;

          const cpcFields = {
            contractId: contract.id, cpcIdentifier: cpcNo,
            projectId: contract.projectId, vendorId: contract.vendorId,
            contents: aggregated.finalContents || ("Thanh toán " + cpcNo),
            amount: isUsd ? 0 : aggregated.finalAmount,
            amountUsd: isUsd ? aggregated.amountDue : 0,
            paymentDueDate: aggregated.paymentDueDate,
            isUsd
          };

          if (existingCpc) {
            targetCpcId = existingCpc.id;
            await databaseService.db.cpcItems.update(targetCpcId, cpcFields);
          } else {
            targetCpcId = await databaseService.db.cpcItems.add(cpcFields);
            cpcFields.id = targetCpcId;
            this.cpcItems.push(cpcFields); // Cập nhật mảng local để tránh duplicate trong cùng 1 lần loop
          }

          // Xử lý Installments (Các đợt thanh toán)
          if (data.payments.length > 0) {
            // Xóa đợt cũ nếu overwrite (hoặc tùy bạn có muốn giữ ko)
            await databaseService.db.installments.where("cpcId").equals(targetCpcId).delete();

            const rate = isUsd ? 25000 : 0;
            const installmentsToSave = data.payments.map(p => ({
              ...p,
              cpcId: targetCpcId,
              contractId: contract.id,
              projectId: contract.projectId,
              vendorId: contract.vendorId,
              isUsd,
              amountUsd: isUsd ? p.amount : 0,
              exchangeRate: rate,
              amountVND: isUsd ? Math.round(p.amount * rate) : p.amount,
              amount: isUsd ? Math.round(p.amount * rate) : p.amount
            }));
            await databaseService.db.installments.bulkAdd(installmentsToSave);
          }
        }
      },

      createEmptyDetailRow(contractId = "", sortOrder = 0) {
        let currentPhaseId = null;
        if (this.viewStates.cpcDetails.activePhaseId !== "summary") {
          currentPhaseId = this.viewStates.cpcDetails.activePhaseId;
        }

        return {
          contractId: contractId,
          phaseId: currentPhaseId,
          sortOrder: sortOrder,
          contractInfo: "",
          description: "",
          contractAmount: 0,
          contractVon: 0,
          contractPercentVat: 0,
          contractVat: 0,
          contractTotal: 0,
          cpcNo: "",
          cpcDueDate: "",
          cpcWorkDone: 0,
          cpcPercentPoW: 0,
          cpcPaymentOfWorkdone: 0,
          cpcPercentAdv: 0,
          cpcAdvance: 0,
          cpcRepayment: 0,
          cpcRetention: 0,
          cpcOtherDeduction: 0,
          cpcAmountDue: 0,
          cpcPercentVat: null,
          cpcVat: 0,

          latestPaymentDate: "",
          paymentTotalAmount: 0,
          paymentTotalVat: 0,
          paymentGrandTotal: 0,
          paymentTotalAmountUsd: 0,
          paymentInstallments: [],

          invoiceNo: "",
          invoiceDate: "",
          invoicePostingDate: "",
          invoiceAmount: 0,
          invoiceVat: 0,
          invoiceTotal: 0,
          invoiceExchangeRate: 0,
          invoiceAmountVND: 0,
          remainingPayable: 0,
          contractRemainingInclVat: 0,
          contractRemainingExclVat: 0,
          contractRemainingVat: 0,
          isExpanded: false,
          linkedCpcId: null,

          isPoWManual: false,
          isAdvanceManual: false,
          isRepaymentManual: false,
          isContractVatManual: false,
          isVatRateManual: false,
          useWorkdoneForRepayment: false,
          repaymentBasisItems: null,
          isFinalSettlement: false,
          isVatManual: false,
        };
      },

      async syncPaymentsToDetails(
        contractId,
        cpcId = null,
        targetTable = null
      ) {
        if (!contractId) return;

        let detailsTable = targetTable
          ? targetTable
          : this.cpcDetailRows.filter((r) => r.contractId === contractId);
        const contract = this.contractMap.get(contractId);

        if (!contract || !detailsTable || detailsTable.length === 0) {
          return;
        }

        detailsTable = JSON.parse(JSON.stringify(detailsTable));

        const isUsdContract = contract.currency === "USD";

        let cpcItemsFromTracking;
        if (cpcId) {
          const cpcItemsForContract =
            this.cpcItemsByContractId.get(contractId) || [];
          cpcItemsFromTracking = cpcItemsForContract.filter(
            (c) => c.id === cpcId
          );
          if (cpcItemsFromTracking.length === 0) return;

          const targetCpcIdentifier = cpcItemsFromTracking[0].cpcIdentifier;
          detailsTable.forEach((row) => {
            if (row.cpcNo === targetCpcIdentifier) {
              row.paymentInstallments = [];
              row.latestPaymentDate = "";
              row.paymentTotalAmount = 0;
              row.paymentTotalVat = 0;
              row.paymentGrandTotal = 0;
              row.paymentTotalAmountUsd = 0;
            }
          });
        } else {
          cpcItemsFromTracking =
            this.cpcItemsByContractId.get(contractId) || [];
          detailsTable.forEach((row) => {
            row.paymentInstallments = [];
            row.latestPaymentDate = "";
            row.paymentTotalAmount = 0;
            row.paymentTotalVat = 0;
            row.paymentGrandTotal = 0;
            row.paymentTotalAmountUsd = 0;
          });
        }

        const detailsByCpcNo = new Map();
        detailsTable.forEach((row) => {
          if (row.cpcNo) {
            if (!detailsByCpcNo.has(row.cpcNo))
              detailsByCpcNo.set(row.cpcNo, []);
            detailsByCpcNo.get(row.cpcNo).push(row);
          }
        });

        for (const cpcItem of cpcItemsFromTracking) {
          const itemInstallments = this.installmentsByCpcId.get(cpcItem.id);
          if (!itemInstallments || itemInstallments.length === 0) continue;

          const detailRowsForCpc = detailsByCpcNo.get(
            cpcItem.cpcIdentifier
          );
          if (!detailRowsForCpc || detailRowsForCpc.length === 0) continue;

          const totalDueForCpc = detailRowsForCpc.reduce((sum, row) => {
            const rowDue = isUsdContract
              ? row.cpcAmountDue || 0
              : (row.cpcAmountDue || 0) + (row.cpcVat || 0);
            return sum + rowDue;
          }, 0);

          if (totalDueForCpc === 0) continue;

          for (const payment of itemInstallments) {
            let paymentAmount = isUsdContract
              ? payment.amountUsd || 0
              : payment.amount || 0;
            let paymentAmountVND = payment.amountVND || payment.amount || 0;
            if (cpcItem.amount < 0) {
              paymentAmount = -Math.abs(paymentAmount);
              paymentAmountVND = -Math.abs(paymentAmountVND);
            }
            for (const detailRow of detailRowsForCpc) {
              const rowDue = isUsdContract
                ? detailRow.cpcAmountDue || 0
                : (detailRow.cpcAmountDue || 0) + (detailRow.cpcVat || 0);
              const allocationRatio = rowDue / totalDueForCpc;
              const allocatedAmount = paymentAmount * allocationRatio;
              const allocatedVND = paymentAmountVND * allocationRatio;
              let allocatedNet = 0,
                allocatedVat = 0,
                allocatedUsd = 0;

              if (isUsdContract) {
                allocatedNet = allocatedAmount;
                allocatedUsd = allocatedAmount;
              } else {
                const cpcRowTotalDue =
                  (detailRow.cpcAmountDue || 0) + (detailRow.cpcVat || 0);
                if (cpcRowTotalDue !== 0) {
                  allocatedNet =
                    allocatedVND *
                    ((detailRow.cpcAmountDue || 0) / cpcRowTotalDue);
                  allocatedVat = allocatedVND - allocatedNet;
                } else {
                  allocatedNet = allocatedVND;
                }
              }
              detailRow.paymentInstallments.push({
                date: payment.date,
                amount: allocatedNet,
                vat: allocatedVat,
                totalVND: allocatedVND,
                amountUsd: allocatedUsd,
                isSwap: payment.isSwap,
              });
            }
          }
        }

        detailsTable.forEach((row) => {
          if (row.paymentInstallments.length > 0) {
            if (isUsdContract) {
              const totalUsd = row.paymentInstallments.reduce(
                (sum, p) => sum + p.amountUsd,
                0
              );
              row.paymentTotalAmount = totalUsd;
              row.paymentTotalAmountUsd = totalUsd;
              row.paymentGrandTotal = totalUsd;
            } else {
              row.paymentTotalAmount = row.paymentInstallments.reduce(
                (sum, p) => sum + p.amount,
                0
              );
              row.paymentTotalVat = row.paymentInstallments.reduce(
                (sum, p) => sum + p.vat,
                0
              );
              row.paymentGrandTotal =
                row.paymentTotalAmount + row.paymentTotalVat;
            }
            row.latestPaymentDate = row.paymentInstallments.reduce(
              (latest, p) => (p.date > latest ? p.date : latest),
              row.paymentInstallments[0].date
            );
          }
        });

        if (!targetTable) {
          const recalculatedTable = this.runCalculationEngine(
            detailsTable,
            contract
          );

          recalculatedTable.forEach((recalculatedRow) => {
            const originalRow = this.cpcDetailRows.find(
              (r) => r.id === recalculatedRow.id
            );
            if (originalRow) {
              Object.assign(originalRow, recalculatedRow);
            }
          });
        }
      },
      async addNewDetailRow(index) {
        this.addNewDetailRowAtIndex(index);
      },
      async addNewDetailRowAtIndex(index) {
        const contractId =
          this.viewStates.cpcDetails.filter.selectedContractId;
        if (!contractId) return;

        try {
          const currentDisplayedTable = this.displayedContractDetailTable;

          const currentRow = currentDisplayedTable[index];

          const newRow = this.createEmptyDetailRow(contractId, 0);

          let allRowsOfContract = this.cpcDetailRows
            .filter((r) => r.contractId === contractId)
            .sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));

          const insertionIndexInGlobal = allRowsOfContract.findIndex(
            (r) => r.id === currentRow.id
          );

          if (insertionIndexInGlobal !== -1) {
            allRowsOfContract.splice(insertionIndexInGlobal + 1, 0, newRow);
          } else {
            allRowsOfContract.push(newRow);
          }

          allRowsOfContract.forEach((row, idx) => {
            row.sortOrder = idx;
          });

          const newId = await databaseService.db.cpcDetailRows.add(
            JSON.parse(JSON.stringify(newRow))
          );
          newRow.id = newId;

          await databaseService.db.cpcDetailRows.bulkPut(
            JSON.parse(JSON.stringify(allRowsOfContract))
          );

          this.cpcDetailRows = this.cpcDetailRows
            .filter((r) => r.contractId !== contractId)
            .concat(allRowsOfContract);

          this.showToast(this.t("rowAddedSuccess"), "success");
        } catch (error) {
          console.error("Lỗi khi thêm dòng mới:", error);
          this.showToast(this.t("rowAddError"), "error");
        }
      },
      deleteDetailRow(itemId) {
        appUtils.ui.showConfirmation(this, {
          title: this.t("confirmDeletion"),
          message: this.t("confirmDeleteRow"),
          onConfirm: async () => {
            const itemIndex = this.cpcDetailRows.findIndex(
              (item) => item.id === itemId
            );
            if (itemIndex > -1) {
              try {
                await databaseService.db.cpcDetailRows.delete(itemId);
                this.cpcDetailRows.splice(itemIndex, 1);
                this.showToast(this.t("rowDeleted"), "success");
              } catch (error) {
                console.error("Error deleting detail row:", error);
                this.showToast("Failed to delete row.", "error");
              }
            }
          },
        });
      },
      clearContractDetails() {
        if (!this.currentDetailItem) return;
        const fields = [
          "contractInfo",
          "description",
          "contractAmount",
          "contractVon",
          "contractPercentVat",
        ];
        fields.forEach((field) => {
          this.currentDetailItem[field] =
            typeof this.currentDetailItem[field] === "number" ? 0 : "";
        });
        this.updateFormulasInModal("contractVat", false);
      },
      clearCpcDetails() {
        if (!this.currentDetailItem) return;

        const fields = [
          "cpcNo",
          "cpcDueDate",
          "cpcWorkDone",
          "cpcPaymentOfWorkdone",
          "cpcPercentAdv",
          "cpcAdvance",
          "cpcRepayment",
          "cpcRetention",
          "cpcOtherDeduction",
          "cpcAmountDue",
          "cpcPercentVat",
          "cpcVat",
        ];
        fields.forEach((field) => {
          this.currentDetailItem[field] =
            typeof this.currentDetailItem[field] === "number" ? 0 : "";
        });

        this.currentDetailItem.isRepaymentManual = false;
        this.currentDetailItem.isPoWManual = false;
        this.currentDetailItem.isAdvanceManual = false;
        this.currentDetailItem.isVatManual = false;
        this.currentDetailItem.isFinalSettlement = false;

        const tableData = this.cpcDetailRows.filter(
          (r) =>
            r.contractId ===
            this.viewStates.cpcDetails.filter.selectedContractId
        );
        this.runCalculationEngine(
          tableData,
          this.selectedContractDetails,
          this.currentDetailIndex
        );
      },
      clearInvoiceDetails() {
        if (!this.currentDetailItem) return;
        const fields = [
          "invoiceNo",
          "invoiceDate",
          "invoicePostingDate",
          "invoiceAmount",
          "invoiceVat",
          "invoiceTotal",
          "invoiceExchangeRate",
          "invoiceAmountVND",
        ];
        fields.forEach((field) => {
          this.currentDetailItem[field] =
            typeof this.currentDetailItem[field] === "number" ? 0 : "";
        });
        this.updateFormulasInModal("invoiceTotal");
      },
      openContractDetailsModal(item, index) {
        this.isContractVatOverrideVisible = false;
        this._setupDetailItemForEdit(item, index);
        if (!this.currentDetailItem.contractPercentVat) {
          const contractSettings = this.selectedContractDetails?.settings;
          if (contractSettings && contractSettings.defaultVatRate) {
            this.currentDetailItem.contractPercentVat =
              contractSettings.defaultVatRate;
            this.updateFormulasInModal("contractPercentVat");
          }
        }
        appUtils.ui.toggleModal("contractDetailsModal", "show");
      },
      async saveContractDetails(shouldCloseModal = true) {
        if (!this.currentDetailItem) return;

        try {
          await databaseService.db.cpcDetailRows.put(
            JSON.parse(JSON.stringify(this.currentDetailItem))
          );
          const index = this.cpcDetailRows.findIndex(
            (r) => r.id === this.currentDetailItem.id
          );
          if (index > -1) {
            this.cpcDetailRows[index] = this.currentDetailItem;
          }
          const contractId =
            this.viewStates.cpcDetails.filter.selectedContractId;
          const tableData = this.cpcDetailRows.filter(
            (r) => r.contractId === contractId
          );
          const recalculatedTable = this.runCalculationEngine(
            tableData,
            this.selectedContractDetails
          );
          this.cpcDetailRows = this.cpcDetailRows
            .filter((r) => r.contractId !== contractId)
            .concat(recalculatedTable);

          if (shouldCloseModal) {
            this.showToast("Changes saved successfully.", "success");
            appUtils.ui.toggleModal("contractDetailsModal", "hide");
          }
          return true;
        } catch (error) {
          console.error("Error saving contract details:", error);
          this.showToast("Failed to save changes.", "error");
          if (shouldCloseModal) {
            appUtils.ui.toggleModal("contractDetailsModal", "hide");
          }
          return false;
        }
      },
      openCpcDetailsModal(item, index) {
        this.isVatOverrideVisible = false;

        const contractId =
          this.viewStates.cpcDetails.filter.selectedContractId;
        const currentTableState = this.cpcDetailRows
          .filter((r) => r.contractId === contractId)
          .map((r) => JSON.parse(JSON.stringify(r)))
          .sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));

        this._setupDetailItemForEdit(item, index);

        if (
          !this.currentDetailItem.repaymentBasisItems ||
          this.currentDetailItem.repaymentBasisItems.length === 0
        ) {
          this.currentDetailItem.repaymentBasisItems = currentTableState
            .slice(0, index + 1)
            .filter(
              (r) =>
                (r.contractAmount || 0) !== 0 || (r.contractVon || 0) !== 0
            )
            .map((r) => r.id);
        }

        if (!this.currentDetailItem.isVatRateManual) {
          const contract = this.selectedContractDetails;
          const settings = contract?.settings || {};
          this.currentDetailItem.cpcPercentVat =
            settings.defaultVatRate ?? 8;
        }

        this.updateFormulasInModal("cpcVat");

        appUtils.ui.toggleModal("cpcDetailsModal", "show");
      },
      async saveCpcDetails() {
        if (!this.currentDetailItem) return;
        try {
          delete this.currentDetailItem._isBeingEdited;
          const contractId =
            this.viewStates.cpcDetails.filter.selectedContractId;

          const tempTableData = this.cpcDetailRows
            .filter((r) => r.contractId === contractId)
            .map((r) => JSON.parse(JSON.stringify(r)))
            .sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));

          const rowIndex = tempTableData.findIndex(
            (r) => r.id === this.currentDetailItem.id
          );
          if (rowIndex > -1) {
            Object.assign(tempTableData[rowIndex], this.currentDetailItem);
          }

          const recalculatedTable = this.runCalculationEngine(
            tempTableData,
            this.selectedContractDetails,
            0
          );

          recalculatedTable.forEach((row) => {
            if (row.cpcRepayment !== 0 && !row.isRepaymentManual) {
              row.isRepaymentManual = true;
            }
            if (row.cpcPaymentOfWorkdone !== 0 && !row.isPoWManual)
              row.isPoWManual = true;
            if (row.cpcAdvance !== 0 && !row.isAdvanceManual)
              row.isAdvanceManual = true;
            if (row.cpcVat !== 0 && !row.isVatManual)
              row.isVatManual = true;
            if (row.contractVat !== 0 && !row.isContractVatManual)
              row.isContractVatManual = true;
          });

          await databaseService.db.cpcDetailRows.bulkPut(
            JSON.parse(JSON.stringify(recalculatedTable))
          );

          const otherContractsRows = this.cpcDetailRows.filter(
            (r) => r.contractId !== contractId
          );
          this.cpcDetailRows = otherContractsRows.concat(recalculatedTable);

          this.syncPaymentsToDetails(contractId);

          this.showToast(this.t("changesSavedSuccess"), "success");
        } catch (error) {
          console.error("Error saving CPC details:", error);
          this.showToast("Failed to save changes.", "error");
        }
        appUtils.ui.toggleModal("cpcDetailsModal", "hide");
      },
      openPaymentDetailsModal(item, index) {
        this._setupDetailItemForEdit(item, index);
        appUtils.ui.toggleModal("paymentDetailsModal", "show");
      },
      async savePaymentDetails() {
        if (!this.currentDetailItem) return;
        try {
          await databaseService.db.cpcDetailRows.put(
            JSON.parse(JSON.stringify(this.currentDetailItem))
          );
          const index = this.cpcDetailRows.findIndex(
            (r) => r.id === this.currentDetailItem.id
          );
          if (index > -1)
            this.cpcDetailRows[index] = this.currentDetailItem;
          this.showToast("Changes saved successfully.", "success");
        } catch (error) {
          console.error("Error saving payment details:", error);
          this.showToast("Failed to save changes.", "error");
        }
        appUtils.ui.toggleModal("paymentDetailsModal", "hide");
      },
      openInvoiceDetailsModal(item, index) {
        this._setupDetailItemForEdit(item, index);
        this.invoiceSelectedRowIds = this.invoiceCpcRows.map((r) => r.id);
        appUtils.ui.toggleModal("invoiceDetailsModal", "show");
      },
      async saveInvoiceDetails() {
        if (!this.currentDetailItem) return;

        if (
          !this.validateDates(this.currentDetailItem, [
            "invoiceDate",
            "invoicePostingDate",
          ])
        ) {
          return;
        }

        const hasInvoiceData =
          this.currentDetailItem.invoiceNo ||
          (this.currentDetailItem.invoiceAmount || 0) !== 0 ||
          (this.currentDetailItem.invoiceVat || 0) !== 0;

        if (hasInvoiceData && !this.currentDetailItem.invoicePostingDate) {
          this.showToast(this.t("errorPostingDateRequired"), "error");
          return;
        }

        try {
          const contractId =
            this.viewStates.cpcDetails.filter.selectedContractId;
          const currentCpcNo = this.currentDetailItem.cpcNo;

          const rowsToUpdate = this.cpcDetailRows.filter(
            (row) =>
              row.contractId === contractId &&
              this.invoiceSelectedRowIds.includes(row.id)
          );

          if (rowsToUpdate.length === 0) {
            this.showToast(this.t("errorNoRowsToUpdateInvoice"), "warning");
            appUtils.ui.toggleModal("invoiceDetailsModal", "hide");
            return;
          }

          rowsToUpdate.forEach((row) => {
            row.invoicePostingDate =
              this.currentDetailItem.invoicePostingDate;
            if (this.isCurrentContractUSD) {
              row.invoiceExchangeRate =
                this.currentDetailItem.invoiceExchangeRate;
            }
            if (row.id === this.currentDetailItem.id) {
              row.invoiceNo = this.currentDetailItem.invoiceNo;
              row.invoiceDate = this.currentDetailItem.invoiceDate;
              row.invoiceAmount = this.currentDetailItem.invoiceAmount;
              row.invoiceVat = this.currentDetailItem.invoiceVat;
            }
          });

          await databaseService.db.cpcDetailRows.bulkPut(
            JSON.parse(JSON.stringify(rowsToUpdate))
          );

          const tableDataForContract = this.cpcDetailRows
            .filter((r) => r.contractId === contractId)
            .map((r) => JSON.parse(JSON.stringify(r)));

          const recalculatedTable = this.runCalculationEngine(
            tableDataForContract,
            this.selectedContractDetails
          );

          recalculatedTable.forEach((recalculatedRow) => {
            const originalRow = this.cpcDetailRows.find(
              (r) => r.id === recalculatedRow.id
            );
            if (originalRow) {
              Object.assign(originalRow, recalculatedRow);
            }
          });

          this.showToast(this.t("changesSavedSuccess"), "success");
        } catch (error) {
          console.error("Error saving invoice details:", error);
          this.showToast("Failed to save changes.", "error");
        }

        appUtils.ui.toggleModal("invoiceDetailsModal", "hide");
      },
      formatManualCpcDetailInput(event, field) {
        this.formatNumericInput(event, field, true);
      },
      formatNumericInput(event, field, isManual = false) {
        let value = event.target.value.replace(/\./g, "").replace(/,/g, "");
        if (!isNaN(value) && value.trim() !== "") {
          const numericValue = parseFloat(value);
          this.currentDetailItem[field] = numericValue;
          event.target.value = new Intl.NumberFormat("vi-VN").format(
            numericValue
          );
        } else {
          this.currentDetailItem[field] = 0;
          event.target.value = "0";
        }
        this.updateFormulasInModal(field, isManual);
      },

      calculateFinalSettlement() {
        if (this.isModalInitializing) return;

        const contractId =
          this.viewStates.cpcDetails.filter.selectedContractId;
        const tableData = this.cpcDetailRows.filter(
          (r) => r.contractId === contractId
        );
        const currentIndex = this.currentDetailIndex;
        if (!tableData || currentIndex < 0) return;

        const settings = this.selectedContractDetails?.settings || {};
        const retentionRate = (settings.retentionRate || 5) / 100;

        if (!this.currentDetailItem.isFinalSettlement) {
          this.currentDetailItem.cpcWorkDone = 0;
          this.currentDetailItem.cpcPaymentOfWorkdone = 0;
          this.currentDetailItem.cpcRetention = 0;
          this.currentDetailItem.isPoWManual = false;
        } else {
          const totalContractValue = tableData.reduce(
            (sum, row) =>
              sum + (row.contractAmount || 0) + (row.contractVon || 0),
            0
          );
          const cumulativeWorkDone = tableData
            .slice(0, currentIndex)
            .reduce((sum, row) => sum + (row.cpcWorkDone || 0), 0);
          const cumulativePoW = tableData
            .slice(0, currentIndex)
            .reduce((sum, row) => sum + (row.cpcPaymentOfWorkdone || 0), 0);

          this.currentDetailItem.cpcWorkDone =
            totalContractValue - cumulativeWorkDone;
          this.currentDetailItem.cpcPaymentOfWorkdone =
            totalContractValue - cumulativePoW;
          this.currentDetailItem.cpcRetention = -Math.round(
            retentionRate * totalContractValue
          );
          this.currentDetailItem.isPoWManual = true;
        }

        this.updateFormulasInModal("isFinalSettlement");
      },
      triggerInvoiceXmlUpload() {
        this.$refs.invoiceXmlInput.click();
      },
      async handleInvoiceXmlUpload(event) {
        const file = event.target.files[0];
        if (!file || !this.currentDetailItem) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const xmlString = e.target.result;
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlString, "text/xml");

            const getValue = (tagName) =>
              xmlDoc.getElementsByTagName(tagName)[0]?.textContent || "";

            const khmshdon = getValue("KHMSHDon");
            const khhdon = getValue("KHHDon");
            const shdon = getValue("SHDon");

            const invoiceNo = `${khmshdon}${khhdon}#${shdon}`;
            const invoiceDate = getValue("NLap");

            const invoiceAmountTotal = Math.round(
              parseFloat(getValue("TgTCThue"))
            );
            const invoiceVatTotal = Math.round(
              parseFloat(getValue("TgTThue"))
            );

            const contractId =
              this.viewStates.cpcDetails.filter.selectedContractId;
            const currentCpcNo = this.currentDetailItem.cpcNo;

            if (!currentCpcNo) {
              this.showToast(
                "Enter CPC number in the current row before uploading invoice.",
                "warning"
              );
              return;
            }

            const relevantRows = this.cpcDetailRows.filter((row) =>
              this.invoiceSelectedRowIds.includes(row.id)
            );

            if (relevantRows.length === 0) {
              this.showToast(
                `Vui lòng chọn ít nhất một dòng để phân bổ hóa đơn.`,
                "error"
              );
              return;
            }

            const totalWorkDoneForCpc = relevantRows.reduce(
              (sum, row) => sum + (row.cpcWorkDone || 0),
              0
            );
            const totalVatForCpc = relevantRows.reduce(
              (sum, row) => sum + (row.cpcVat || 0),
              0
            );

            let distributedAmount = 0;
            let distributedVat = 0;

            relevantRows.forEach((row, index) => {
              let rowInvoiceAmount = 0;
              let rowInvoiceVat = 0;

              if (index === relevantRows.length - 1) {
                rowInvoiceAmount = invoiceAmountTotal - distributedAmount;
                rowInvoiceVat = invoiceVatTotal - distributedVat;
              } else {
                const workDoneRatio =
                  totalWorkDoneForCpc > 0
                    ? (row.cpcWorkDone || 0) / totalWorkDoneForCpc
                    : 1 / relevantRows.length;
                const vatRatio =
                  totalVatForCpc > 0
                    ? (row.cpcVat || 0) / totalVatForCpc
                    : workDoneRatio;

                rowInvoiceAmount = Math.round(
                  invoiceAmountTotal * workDoneRatio
                );
                rowInvoiceVat = Math.round(invoiceVatTotal * vatRatio);
              }

              row.invoiceNo = invoiceNo;
              row.invoiceDate = invoiceDate;
              row.invoiceAmount = rowInvoiceAmount;
              row.invoiceVat = rowInvoiceVat;

              distributedAmount += rowInvoiceAmount;
              distributedVat += rowInvoiceVat;
            });

            const editedRowInRelevantRows = relevantRows.find(
              (r) => r.id === this.currentDetailItem.id
            );
            if (editedRowInRelevantRows) {
              this.currentDetailItem.invoiceNo =
                editedRowInRelevantRows.invoiceNo;
              this.currentDetailItem.invoiceDate =
                editedRowInRelevantRows.invoiceDate;
              this.currentDetailItem.invoiceAmount =
                editedRowInRelevantRows.invoiceAmount;
              this.currentDetailItem.invoiceVat =
                editedRowInRelevantRows.invoiceVat;
            }

            this.updateFormulasInModal("invoiceAmount");
            this.showToast(this.t("xmlLoadSuccess"), "success");

            this.$nextTick(() => {
              if (this.$refs.invoicePostingDateInput) {
                this.$refs.invoicePostingDateInput.focus();
              }
            });
          } catch (error) {
            console.error("XML Parsing Error:", error);
            this.showToast(this.t("xmlLoadError"), "error");
          }
        };
        reader.readAsText(file);
        event.target.value = "";
      },
      async sendCpcToTracking(detailItem) {
        if (!detailItem.cpcNo) {
          this.showToast(this.t("errorNoDataToSend"), "warning");
          return;
        }
        const contractInfo = this.selectedContractDetails;
        if (!contractInfo) return;

        const allRowsForThisCpc = this.cpcDetailRows.filter(
          (row) =>
            row.contractId === contractInfo.id &&
            row.cpcNo === detailItem.cpcNo
        );

        if (allRowsForThisCpc.length === 0) {
          this.showToast(
            "Không tìm thấy dòng chi tiết nào để gửi.",
            "error"
          );
          return;
        }

        const isUsdContract = contractInfo.currency === "USD";
        const aggregatedData = this._aggregateCpcDataFromDetailRows(
          allRowsForThisCpc,
          isUsdContract
        );

        const existingCpc = this.cpcItems.find(
          (c) =>
            c.contractId === contractInfo.id &&
            c.cpcIdentifier === detailItem.cpcNo
        );

        let confirmationMessage = "";
        let confirmButtonText = "";
        let formattedAmount;

        if (isUsdContract) {
          formattedAmount = this.formatCurrencyUSD(
            aggregatedData.finalAmount
          );
        } else {
          formattedAmount = this.formatCurrency(aggregatedData.finalAmount);
        }

        if (existingCpc) {
          confirmationMessage = this.t("confirmUpdateCpcMessage", {
            cpcNo: detailItem.cpcNo,
            amount: formattedAmount,
          });
          confirmButtonText = this.t("btnUpdate");
        } else {
          confirmationMessage = this.t("confirmSendCpcMessage", {
            cpcNo: detailItem.cpcNo,
            amount: formattedAmount,
          });
          confirmButtonText = this.t("btnSend");
        }

        appUtils.ui.showConfirmation(this, {
          title: `Xác nhận gửi CPC`,
          message: confirmationMessage,
          confirmButtonText: confirmButtonText,
          confirmButtonClass: "btn-primary",
          onConfirm: async () => {
            let targetCpcId;
            let cpcToSave;

            if (existingCpc) {
              cpcToSave = { ...existingCpc };
              if (isUsdContract) {
                cpcToSave.amountUsd = aggregatedData.amountDue;
              } else {
                cpcToSave.amountExclVAT = aggregatedData.amountDue;
                cpcToSave.vatAmount = aggregatedData.vatAmount;
                cpcToSave.amount = aggregatedData.finalAmount;
              }
              if (aggregatedData.finalContents)
                cpcToSave.contents = aggregatedData.finalContents;
              if (aggregatedData.paymentDueDate)
                cpcToSave.paymentDueDate = aggregatedData.paymentDueDate;

              targetCpcId = existingCpc.id;
            } else {
              cpcToSave = {
                contractId: contractInfo.id,
                cpcIdentifier: detailItem.cpcNo,
                contents: aggregatedData.finalContents,
                amount: isUsdContract ? 0 : aggregatedData.finalAmount,
                amountExclVAT: isUsdContract ? 0 : aggregatedData.amountDue,
                vatAmount: aggregatedData.vatAmount,
                amountUsd: isUsdContract ? aggregatedData.amountDue : 0,
                exchangeRate: 0,

                receivedDate: appUtils.format.date(new Date()),

                paymentDueDate: aggregatedData.paymentDueDate,
                lineTracking: "",
                notes: "",
                isExpanded: false,

                projectId: contractInfo.projectId,
                vendorId: contractInfo.vendorId,
                code: contractInfo.code,
                department: contractInfo.department,
                contractSystemNo: contractInfo.contractSystemNo,
              };
              targetCpcId = cpcToSave.id;
            }

            try {
              const cleanCpcToSave = JSON.parse(JSON.stringify(cpcToSave));

              if (existingCpc) {
                await databaseService.db.cpcItems.put(cleanCpcToSave);
              } else {
                delete cleanCpcToSave.id;
                const newId = await databaseService.db.cpcItems.add(
                  cleanCpcToSave
                );
                cpcToSave.id = newId;
                targetCpcId = newId;
              }

              if (existingCpc) {
                const index = this.cpcItems.findIndex(
                  (c) => c.id === targetCpcId
                );
                if (index > -1) this.cpcItems[index] = cpcToSave;
                this.showToast(this.t("cpcUpdatedInTracking"), "success");
              } else {
                this.cpcItems.unshift(cpcToSave);
                this.showToast(this.t("cpcSentToTracking"), "success");
              }

              allRowsForThisCpc.forEach((row) => {
                row.linkedCpcId = targetCpcId;
              });
              await databaseService.db.cpcDetailRows.bulkPut(
                JSON.parse(JSON.stringify(allRowsForThisCpc))
              );

              allRowsForThisCpc.forEach((updatedRow) => {
                const index = this.cpcDetailRows.findIndex(
                  (r) => r.id === updatedRow.id
                );
                if (index > -1) this.cpcDetailRows[index] = updatedRow;
              });

              this.currentTab = "cpc-tracking";
              this.highlightAndScrollToItem(targetCpcId);
            } catch (error) {
              console.error("Error sending CPC to tracking:", error);
              this.showToast("Failed to send CPC.", "error");
            }
          },
        });
      },
      updateDetailsGridWithPayments(savedCpcItem) {
        if (!savedCpcItem || !savedCpcItem.contractId) {
          return;
        }
        if (
          this.currentTab === "cpc-details" &&
          this.viewStates.cpcDetails.filter.selectedContractId ===
          savedCpcItem.contractId
        ) {
          this.syncPaymentsToDetails(savedCpcItem.contractId);
          this.showToast(this.t("cpcPaymentUpdatedInDetails"), "info");
        }
      },
      printCpcDetails() {
        window.print();
      },
      exportDetailsToExcel() {
        const contractId =
          this.viewStates.cpcDetails.filter.selectedContractId;
        if (!contractId) {
          this.showToast(this.t("errorSelectContractToExport"), "warning");
          return;
        }
        const contractNo =
          this.contracts.find((c) => c.id === contractId)?.contractNo ||
          "export";
        const tableData = this.displayedContractDetailTable;

        if (tableData.length === 0) {
          this.showToast(this.t("errorNoDetailDataToExport"), "warning");
          return;
        }

        const headers = [
          "contractInfo",
          "description",
          "contractAmount",
          "contractVon",
          "contractPercentVat",
          "contractVat",
          "cpcNo",
          "cpcDueDate",
          "cpcWorkDone",
          "cpcPercentPoW",
          "cpcPaymentOfWorkdone",
          "cpcPercentAdv",
          "cpcAdvance",
          "cpcRepayment",
          "cpcRetention",
          "cpcOtherDeduction",
          "cpcPercentVat",
          "cpcVat",
          "invoiceNo",
          "invoiceDate",
          "invoicePostingDate",
          "invoiceAmount",
          "invoiceVat",
        ];

        const dataToExport = tableData.map((item) => {
          const row = {};
          headers.forEach((header) => {
            row[header] = item[header] !== undefined ? item[header] : null;
          });
          return row;
        });

        const ws = XLSX.utils.json_to_sheet(dataToExport, {
          header: headers,
        });
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Details");

        XLSX.writeFile(
          wb,
          `Details_Export_${contractNo}_${appUtils.format.date(
            new Date()
          )}.xlsx`
        );
        this.showToast(this.t("exportDetailsSuccess"), "success");
      },
      t(key, replacements = {}) {
        let translation = this.translations[this.language][key] || key;
        Object.keys(replacements).forEach((rKey) => {
          translation = translation.replace(
            `{${rKey}}`,
            replacements[rKey]
          );
        });
        return translation;
      },
      toggleLanguage() {
        this.language = this.language === "vi" ? "en" : "vi";
        localStorage.setItem("cpcTrackingLanguage", this.language);
      },
      loadLanguage() {
        const savedLanguage = localStorage.getItem("cpcTrackingLanguage");
        if (savedLanguage && ["en", "vi"].includes(savedLanguage))
          this.language = savedLanguage;
      },
      toggleSidebar() {
        this.isSidebarCollapsed = !this.isSidebarCollapsed;
      },
      toggleNotificationExpansion(bondId) {
        const index = this.expandedNotificationIds.indexOf(bondId);
        if (index > -1) this.expandedNotificationIds.splice(index, 1);
        else this.expandedNotificationIds.push(bondId);
      },
      isNotificationExpanded(bondId) {
        return this.expandedNotificationIds.includes(bondId);
      },
      formatDateToYYYYMMDD(date) {
        if (!date) return "";
        const d = new Date(date);
        if (isNaN(d.getTime())) return "";
        return `${d.getFullYear()}-${(d.getMonth() + 1)
          .toString()
          .padStart(2, "0")}-${d.getDate().toString().padStart(2, "0")}`;
      },
      setDefaultDashboardDates() {
        const today = new Date();
        this.viewStates.paymentDashboard.filter.startDate =
          appUtils.format.date(
            new Date(today.getFullYear(), today.getMonth(), 1)
          );
        this.viewStates.paymentDashboard.filter.endDate =
          appUtils.format.date(
            new Date(today.getFullYear(), today.getMonth() + 1, 0)
          );
      },
      toggleExpand(item) {
        const itemIndex = this.cpcItems.findIndex((i) => i.id === item.id);
        if (itemIndex !== -1)
          this.cpcItems[itemIndex].isExpanded =
            !this.cpcItems[itemIndex].isExpanded;
      },
      getTotalAmountPaid(item) {
        return this.installments
          .filter((i) => i.cpcId === item.id)
          .reduce((sum, installment) => sum + (installment.amount || 0), 0);
      },
      formatCurrency(value) {
        if (!value && value !== 0) return "";
        return new Intl.NumberFormat("vi-VN", {
          style: "currency",
          currency: "VND",
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        }).format(value || 0);
      },
      formatCurrencyUSD(value) {
        if (!value && value !== 0) return "$0.00";
        return new Intl.NumberFormat("en-US", {
          style: "currency",
          currency: "USD",
        }).format(value || 0);
      },
      formatNumber(value) {
        if (value === 0) return "0";
        if (!value) return "";
        return new Intl.NumberFormat("vi-VN").format(value);
      },
      formatReportNumber(value) {
        if (value === 0) return "-";
        if (!value) return "";
        return new Intl.NumberFormat("vi-VN").format(value);
      },
      getStatusInfo(item, installments, totalPaid) {
        const amount = item.isUsd ? item.amountUsd : item.amount;
        const paid = item.isUsd
          ? installments.reduce(
            (sum, inst) => sum + (inst.amountUsd || 0),
            0
          )
          : totalPaid;

        const isComplete =
          (amount >= 0 && paid >= amount) ||
          (amount < 0 && paid >= Math.abs(amount));

        if (amount === 0) {
          const hasSettlementInstallment = installments.some(
            (inst) => inst.date
          );
          if (hasSettlementInstallment) {
            return {
              badgeClass: "badge bg-success",
              iconClass: "fas fa-check-circle",
              statusText: this.t("completeWithOffset"),
              statusKey: "complete",
            };
          }
        }
        const hasInstallments = installments.length > 0;
        const swappedInstallments = installments.filter(
          (inst) => inst.isSwap
        );
        const normalInstallments = installments.filter(
          (inst) => !inst.isSwap
        );
        const allAreSwaps =
          hasInstallments && normalInstallments.length === 0;
        const allSwapsPaid = swappedInstallments.every((inst) =>
          this.isSwapFullyPaid(inst)
        );
        const anySwapPaid = swappedInstallments.some(
          (inst) =>
            (inst.swapPayments || []).reduce(
              (sum, p) => sum + p.amount,
              0
            ) > 0
        );

        let badgeClass = "badge",
          iconClass = "",
          statusText = "",
          statusKey = "";

        if (isComplete && amount != 0) {
          if (swappedInstallments.length > 0) {
            if (allSwapsPaid) {
              statusKey = "completeswappayment";
              statusText = this.t(statusKey);
              badgeClass += " bg-success";
              iconClass = "fas fa-check-double";
            } else {
              statusKey = allAreSwaps ? "completeswap" : "partialswap";
              statusText = this.t(statusKey);
              badgeClass += " bg-info";
              iconClass = "fas fa-exchange-alt";
            }
          } else {
            statusKey = "complete";
            statusText = this.t(statusKey);
            badgeClass += " bg-success";
            iconClass = "fas fa-check-circle";
          }
        } else if (paid > 0) {
          if (swappedInstallments.length > 0) {
            if (anySwapPaid && !allSwapsPaid) {
              statusKey = "partialswappayment";
              statusText = this.t(statusKey);
              badgeClass += " bg-info";
              iconClass = "fas fa-exchange-alt";
            } else {
              statusKey = "partialswap";
              statusText = this.t(statusKey);
              badgeClass += " bg-info";
              iconClass = "fas fa-exchange-alt";
            }
          } else {
            statusKey = "partialpayment";
            statusText = this.t(statusKey);
            badgeClass += " bg-warning";
            iconClass = "fas fa-adjust";
          }
        } else if (item.paymentDueDate) {
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const dueDate = new Date(item.paymentDueDate);
          dueDate.setHours(0, 0, 0, 0);
          const diffDays = Math.ceil((dueDate - today) / 864e5);
          statusKey = "pending";
          if (diffDays < 0) {
            badgeClass += " bg-danger";
            iconClass = "fas fa-exclamation-triangle";
            statusText = this.t("status_overdue_days", {
              days: -diffDays,
            });
          } else if (diffDays === 0) {
            badgeClass += " bg-due-today";
            iconClass = "fas fa-clock";
            statusText = this.t("status_due_today");
          } else {
            badgeClass += " bg-primary";
            iconClass = "fas fa-calendar-alt";
            statusText = this.t("status_days_left", {
              days: diffDays,
            });
          }
        } else {
          statusKey = "pending";
          statusText = this.t(statusKey);
          badgeClass += " bg-secondary";
          iconClass = "fas fa-hourglass-half";
        }

        return {
          badgeClass,
          iconClass,
          statusText,
          statusKey,
        };
      },
      addNewCpcItem() {
        this.currentEditItem = {
          cpcIdentifier: "",
          contractId: null,
          contractNo: "",
          projectName: "",
          vendorName: "",
          contents: "",
          amount: 0,
          amountExclVAT: 0,
          vatAmount: 0,
          isUsd: false,
          amountUsd: 0,
          exchangeRate: 0,
          receivedDate: "",
          paymentDueDate: "",
          lineTracking: "",
          notes: "",
          installments: [],
          bonds: [],
        };
        this.modalMode = "add";
        appUtils.ui.toggleModal("cpcDetailModal", "show");
      },
      copyItem(item) {
        this._prepareEditItem(item);

        this.currentEditItem.installments = [];
        this.currentEditItem.totalAmountPaid = 0;
        this.currentEditItem.latestPaymentDate = "N/A";

        delete this.currentEditItem.id;

        this.modalMode = "copy";
        appUtils.ui.toggleModal("cpcDetailModal", "show");
      },
      editItem(item) {
        this._prepareEditItem(item);
        this.modalMode = "edit";
        appUtils.ui.toggleModal("cpcDetailModal", "show");
      },

      formatAmountInput(obj, prop) {
        let rawValue = String(obj[prop] || "").replace(/\./g, "");
        let numericValue = parseInt(rawValue, 10) || 0;
        obj.amount = numericValue;
        obj[prop] = numericValue.toLocaleString("vi-VN");
      },
      calculateCpcTotalAmount() {
        const amountExclVAT = this.currentEditItem.amountExclVAT || 0;
        const vatAmount = this.currentEditItem.vatAmount || 0;
        this.currentEditItem.amount = amountExclVAT + vatAmount;
        this.currentEditItem.displayAmount =
          this.currentEditItem.amount.toLocaleString("vi-VN");
      },
      calculateVndFromUsd() {
        if (!this.currentEditItem || !this.currentEditItem.isUsd) return;
        const amountUsd = this.currentEditItem.amountUsd || 0;
        const exchangeRate = this.currentEditItem.exchangeRate || 0;
        const amountExclVAT = Math.round(amountUsd * exchangeRate);
        this.currentEditItem.amountExclVAT = amountExclVAT;
        this.currentEditItem.displayAmountExclVAT =
          amountExclVAT.toLocaleString("vi-VN");
        this.calculateCpcTotalAmount();
      },
      formatCpcAmountUsd() {
        const numericValue = appUtils.text.parseUsdAmount(
          this.currentEditItem.displayAmountUsd
        );

        this.currentEditItem.amountUsd = numericValue;

        this.calculateVndFromUsd();
      },
      formatExchangeRate() {
        const numericValue = appUtils.text.parseVndAmount(
          this.currentEditItem.displayExchangeRate
        );
        this.currentEditItem.exchangeRate = numericValue;
        this.currentEditItem.displayExchangeRate =
          numericValue.toLocaleString("vi-VN");
        this.calculateVndFromUsd();
      },
      formatCpcAmountExclVAT() {
        if (this.currentEditItem.isUsd) return;
        this.currentEditItem.amountExclVAT = appUtils.text.parseVndAmount(
          this.currentEditItem.displayAmountExclVAT
        );
        this.currentEditItem.displayAmountExclVAT =
          this.currentEditItem.amountExclVAT.toLocaleString("vi-VN");
        this.calculateCpcTotalAmount();
      },
      formatCpcVatAmount() {
        this.currentEditItem.vatAmount = appUtils.text.parseVndAmount(
          this.currentEditItem.displayVatAmount
        );
        this.currentEditItem.displayVatAmount =
          this.currentEditItem.vatAmount.toLocaleString("vi-VN");
        this.calculateCpcTotalAmount();
      },

      formatInstallmentAmount(inst) {
        if (inst.isUsd) return;
        inst.amount = appUtils.text.parseVndAmount(inst.displayAmount);
        inst.displayAmount = inst.amount.toLocaleString("vi-VN");
      },
      calculateInstallmentVndFromUsd(inst) {
        const amountUsd = inst.amountUsd || 0;
        const exchangeRate = inst.exchangeRate || 0;
        const amountVND = Math.round(amountUsd * exchangeRate);
        inst.amount = amountVND;
        inst.amountVND = amountVND;
        inst.displayAmount = inst.amount.toLocaleString("vi-VN");
      },
      formatInstallmentAmountUsd(inst) {
        const numericValue = appUtils.text.parseUsdAmount(
          inst.displayAmountUsd
        );

        inst.amountUsd = numericValue;

        this.calculateInstallmentVndFromUsd(inst);
      },
      formatInstallmentExchangeRate(inst) {
        const numericValue = appUtils.text.parseVndAmount(
          inst.displayExchangeRate
        );
        inst.exchangeRate = numericValue;
        inst.displayExchangeRate = numericValue.toLocaleString("vi-VN");
        this.calculateInstallmentVndFromUsd(inst);
      },

      addInstallment() {
        this.currentEditItem.installments.push({
          amount: 0,
          displayAmount: "0",
          date: "",
          paymentSource: "",
          isDateInvalid: false,
          isSwap: false,
          vendorSWAP: "",
          swapAgreement: "",
          swapInformation: "",
          swapDueDatePayment: "",
          swapPayments: [],
          isSwapPaid: false,
          isUsd: false,
          amountUsd: 0,
          exchangeRate: 0,
          displayAmountUsd: "0",
          displayExchangeRate: "0",
          amountVND: 0,
        });
      },
      removeInstallment(index) {
        this.currentEditItem.installments.splice(index, 1);
      },

      closeModal() {
        appUtils.ui.toggleModal("cpcDetailModal", "hide");
      },
      viewBondDetails(item) {
        const contractBonds = this.bonds.filter(
          (b) => b.contractId === item.contractId
        );
        this.currentViewBondItem = {
          ...JSON.parse(JSON.stringify(item)),
          bonds: contractBonds,
        };
        appUtils.ui.toggleModal("bondDetailViewModal", "show");
      },
      closeBondViewModal() {
        appUtils.ui.toggleModal("bondDetailViewModal", "hide");
      },
      startEditing(item, field) {
        this.editingCell.itemId = item.id;
        this.editingCell.field = field;
        this.inlineEditValue = item[field] || "";
        this.$nextTick(() => {
          if (this.$refs.inlineInput && this.$refs.inlineInput[0]) {
            this.$refs.inlineInput[0].focus();
          } else if (this.$refs.inlineInput) {
            this.$refs.inlineInput.focus();
          }
        });
      },
      async saveInlineEdit() {
        if (!this.editingCell.itemId) return;
        const itemIndex = this.cpcItems.findIndex(
          (d) => d.id === this.editingCell.itemId
        );
        if (itemIndex !== -1) {
          const field = this.editingCell.field;
          const originalValue = this.cpcItems[itemIndex][field] || "";
          if (originalValue !== this.inlineEditValue) {
            const itemToUpdate = JSON.parse(
              JSON.stringify(this.cpcItems[itemIndex])
            );
            itemToUpdate[field] = this.inlineEditValue;
            try {
              await databaseService.db.cpcItems.put(itemToUpdate);
              this.cpcItems[itemIndex] = itemToUpdate;
              this.justEditedCell = {
                itemId: this.editingCell.itemId,
                field: this.editingCell.field,
              };
              setTimeout(() => {
                this.justEditedCell = { itemId: null, field: null };
              }, 2000);
            } catch (error) {
              console.error("Error saving inline edit:", error);
              this.showToast("Failed to save changes.", "error");
            }
          }
        }
        this.cancelInlineEdit();
      },
      cancelInlineEdit() {
        this.editingCell.itemId = null;
        this.editingCell.field = null;
        this.inlineEditValue = "";
      },
      initializeColumnVisibility() {
        const savedCpc = JSON.parse(
          localStorage.getItem("cpcColumnVisibility") || "{}"
        );
        this.availableColumns.forEach((col) => {
          this.columnVisibility[col.key] =
            savedCpc[col.key] !== undefined ? savedCpc[col.key] : true;
        });
        const savedPayment = JSON.parse(
          localStorage.getItem("dashboardPaymentColumnVisibility") || "{}"
        );
        this.dashboardPaymentAvailableColumns.forEach((col) => {
          this.dashboardPaymentColumnVisibility[col.key] =
            savedPayment[col.key] !== undefined
              ? savedPayment[col.key]
              : true;
        });
        const savedSwap = JSON.parse(
          localStorage.getItem("swapDashboardColumnVisibility") || "{}"
        );
        this.swapDashboardAvailableColumns.forEach((col) => {
          this.swapDashboardColumnVisibility[col.key] =
            savedSwap[col.key] !== undefined ? savedSwap[col.key] : true;
        });
        const savedBond = JSON.parse(
          localStorage.getItem("dashboardBondColumnVisibility") || "{}"
        );
        this.dashboardBondAvailableColumns.forEach((col) => {
          this.dashboardBondColumnVisibility[col.key] =
            savedBond[col.key] !== undefined ? savedBond[col.key] : true;
        });
        const savedContract = JSON.parse(
          localStorage.getItem("contractDashboardColumnVisibility") || "{}"
        );
        this.contractDashboardAvailableColumns.forEach((col) => {
          this.contractDashboardColumnVisibility[col.key] =
            savedContract[col.key] !== undefined
              ? savedContract[col.key]
              : true;
        });
        this.dashboardBondColumnVisibility["quickSettle"] =
          savedBond["quickSettle"] !== undefined
            ? savedBond["quickSettle"]
            : true;
      },
      saveColumnVisibilityToLocalStorage(type) {
        const visibilityMap = {
          cpc: this.columnVisibility,
          dashboardPayment: this.dashboardPaymentColumnVisibility,
          swapDashboard: this.swapDashboardColumnVisibility,
          dashboardBond: this.dashboardBondColumnVisibility,
          contractDashboard: this.contractDashboardColumnVisibility,
        };
        localStorage.setItem(
          `${type}ColumnVisibility`,
          JSON.stringify(visibilityMap[type])
        );
      },
      highlightAndScrollToItem(itemId) {
        if (!itemId) return;
        this.$nextTick(() => {
          const itemIndex = this.filteredCpcData.findIndex(
            (p) => p.id === itemId
          );
          this.viewStates.cpcTracking.currentPage =
            itemIndex === -1
              ? 1
              : Math.floor(
                itemIndex / this.viewStates.cpcTracking.perPage
              ) + 1;
          this.$nextTick(() => {
            const rowElement = document.getElementById(`cpc-row-${itemId}`);
            if (rowElement) {
              this.highlightedRowId = itemId;
              rowElement.scrollIntoView({
                behavior: "smooth",
                block: "center",
              });
              setTimeout(() => {
                if (this.highlightedRowId === itemId)
                  this.highlightedRowId = null;
              }, 7000);
            }
          });
        });
      },
      downloadExcelTemplate() {
        const wb = XLSX.utils.book_new();

        const headerStyle = { font: { bold: true } };
        const requiredHeaderStyle = {
          font: { bold: true, color: { rgb: "FF0000" } },
        };
        const numberFormat = "#,##0";
        const dateFormat = "yyyy-mm-dd";

        const createSheet = (headers, requiredHeaders, columnFormats) => {
          const ws = XLSX.utils.json_to_sheet([{}], { header: headers });

          headers.forEach((header, index) => {
            const cellAddress = XLSX.utils.encode_cell({ c: index, r: 0 });
            if (ws[cellAddress]) {
              ws[cellAddress].s = requiredHeaders.includes(header)
                ? requiredHeaderStyle
                : headerStyle;
            }
          });

          const colSettings = headers.map((header) => {
            const format = columnFormats[header];
            if (format) {
              const cellAddress = XLSX.utils.encode_cell({
                c: headers.indexOf(header),
                r: 0,
              });
              if (ws[cellAddress]) {
                ws[cellAddress].z = format;
              }
            }
            return { wch: header.length + 5 };
          });
          ws["!cols"] = colSettings;

          ws["!ref"] = XLSX.utils.encode_range({
            s: { c: 0, r: 0 },
            e: { c: headers.length - 1, r: 0 },
          });

          return ws;
        };

        const cpcHeaders = [
          "contractNo",
          "cpc",
          "contents",
          "amountExclVAT",
          "vatAmount",
          "isUsd",
          "amountUsd",
          "exchangeRate",
          "receivedDate",
          "paymentDueDate",
          "lineTracking",
          "notes",
        ];
        const cpcRequired = ["contractNo", "cpc"];
        const cpcFormats = {
          amountExclVAT: numberFormat,
          vatAmount: numberFormat,
          amountUsd: "#,##0.00",
          exchangeRate: numberFormat,
          receivedDate: dateFormat,
          paymentDueDate: dateFormat,
        };
        const cpcWs = createSheet(cpcHeaders, cpcRequired, cpcFormats);
        XLSX.utils.book_append_sheet(wb, cpcWs, "CPC_Main");

        const instHeaders = [
          "contractNo",
          "cpc",
          "amount",
          "date",
          "paymentSource",
          "isUsd",
          "amountUsd",
          "exchangeRate",
          "isSwap",
          "vendorSWAP",
          "swapAgreement",
          "swapInformation",
          "swapDueDatePayment",
        ];
        const instRequired = ["contractNo", "cpc"];
        const instFormats = {
          amount: numberFormat,
          date: dateFormat,
          amountUsd: "#,##0.00",
          exchangeRate: numberFormat,
          swapDueDatePayment: dateFormat,
        };
        const instWs = createSheet(instHeaders, instRequired, instFormats);
        XLSX.utils.book_append_sheet(wb, instWs, "Installments");

        XLSX.writeFile(wb, "cpc_upload_template_formatted.xlsx");
      },
      exportToExcel() {
        try {
          if (!this.filteredCpcData || this.filteredCpcData.length === 0) {
            this.showToast("Không có dữ liệu để xuất.", "warning");
            return;
          }

          const wb = XLSX.utils.book_new();

          const cpcExportData = this.filteredCpcData.map((item) => ({
            projectName: item.projectName,
            cpcIdentifier: item.cpcIdentifier,
            contractNo: item.contractNo,
            contents: item.contents,
            vendorName: item.vendorName,
            code: item.code,
            department: item.department,
            contractSystemNo: item.contractSystemNo,
            vendorNo: item.vendorNo,
            amountExclVAT: item.amountExclVAT,
            vatAmount: item.vatAmount,
            amount: item.amount,
            isUsd: item.isUsd,
            amountUsd: item.amountUsd,
            exchangeRate: item.exchangeRate,
            receivedDate: item.receivedDate,
            paymentDueDate: item.paymentDueDate,
            lineTracking: item.lineTracking,
            notes: item.notes,
          }));

          const installmentsExportData = [];
          const swapPaymentsExportData = [];

          this.filteredCpcData.forEach((item) => {
            (item.installments || []).forEach((inst) => {
              const { swapPayments, ...instDetails } = inst;
              installmentsExportData.push({
                cpcIdentifier: item.cpcIdentifier,
                contractNo: item.contractNo,
                ...instDetails,
              });

              if (inst.isSwap && inst.swapPayments) {
                inst.swapPayments.forEach((p) => {
                  swapPaymentsExportData.push({
                    cpcIdentifier: item.cpcIdentifier,
                    contractNo: item.contractNo,
                    vendorSWAP: inst.vendorSWAP,
                    swapAgreement: inst.swapAgreement,
                    ...p,
                  });
                });
              }
            });
          });

          XLSX.utils.book_append_sheet(
            wb,
            XLSX.utils.json_to_sheet(cpcExportData),
            "CPC_Main"
          );
          XLSX.utils.book_append_sheet(
            wb,
            XLSX.utils.json_to_sheet(installmentsExportData),
            "Installments"
          );
          XLSX.utils.book_append_sheet(
            wb,
            XLSX.utils.json_to_sheet(swapPaymentsExportData),
            "SWAP_Payments"
          );

          XLSX.writeFile(
            wb,
            `cpc_data_export_${appUtils.format.date(new Date())}.xlsx`
          );

          this.showToast("Xuất dữ liệu ra Excel thành công!", "success");
        } catch (error) {
          console.error("Lỗi khi xuất Excel:", error);
          this.showToast("Đã xảy ra lỗi khi xuất file Excel.", "error");
        }
      },
      clearAllFilters() {
        const currentTab = this.currentTab;

        if (currentTab === "master-data") {
          let cleared = false;
          if (this.masterData.activeSubTab === "vendors") {
            this.masterData.vendors.searchTerm = "";
            this.masterData.vendors.currentPage = 1;
            cleared = true;
          } else if (this.masterData.activeSubTab === "projects") {
            this.masterData.projects.searchTerm = "";
            this.masterData.projects.currentPage = 1;
            cleared = true;
          }

          if (cleared) {
            this.showToast(this.t("allFiltersCleared"), "info");
          }
          return;
        }

        let targetState = null;

        switch (currentTab) {
          case "cpc-tracking":
            targetState = this.viewStates.cpcTracking;
            break;
          case "cpc-details":
            targetState = this.viewStates.cpcDetails;
            break;
          case "vendor-balance":
            targetState = this.viewStates.vendorBalance;
            break;
          case "cpc-dashboard":
            targetState = this.viewStates.paymentDashboard;
            break;
          case "cpc-swap-dashboard":
            targetState = this.viewStates.swapDashboard;
            break;
          case "cpc-bond-dashboard":
            targetState = this.viewStates.bondDashboard;
            break;
          case "cpc-contract-dashboard":
            targetState = this.viewStates.contractDashboard;
            break;
          case "cogs-dashboard":
            targetState = this.viewStates.cogsDashboard;
            break;
        }

        if (targetState && targetState.filter) {
          const filter = targetState.filter;

          for (const filterKey in filter) {
            const filterValue = filter[filterKey];
            if (Array.isArray(filterValue)) {
              filter[filterKey] = [];
            } else if (typeof filterValue === "string") {
              filter[filterKey] = "";
            } else if (
              filterKey === "expansion" &&
              typeof filterValue === "object" &&
              filterValue !== null
            ) {
              Object.keys(filterValue).forEach((expansionKey) => {
                filterValue[expansionKey] = false;
              });
            } else if (
              typeof filterValue !== "object" ||
              filterValue === null
            ) {
              filter[filterKey] = null;
            }
          }

          if (targetState.hasOwnProperty("searchTerm")) {
            targetState.searchTerm = "";
          }

          if (currentTab === "cpc-dashboard") {
            this.setDefaultDashboardDates();
          }

          this.showToast(this.t("allFiltersCleared"), "info");
        } else {
          console.log(`Tab '${currentTab}' không có bộ lọc để xóa.`);
        }
      },
      toggleFilter(filterArray, itemValue) {
        const index = filterArray.indexOf(itemValue);
        if (index > -1) filterArray.splice(index, 1);
        else filterArray.push(itemValue);
      },
      getBondStatusClassForDashboard(bond) {
        if (bond.isSettled)
          return {
            badgeClass: "badge bg-success",
            message: bond.isRenewed
              ? this.t("renewedStatus")
              : this.t("bondSettled"),
          };
        if (!bond.expiryDate)
          return { badgeClass: "badge bg-secondary", message: "N/A" };
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const expiryDate = new Date(bond.expiryDate);
        expiryDate.setHours(0, 0, 0, 0);
        const diffDays = Math.ceil((expiryDate - today) / 864e5);
        if (diffDays < 0)
          return {
            badgeClass: "badge bg-danger",
            message: this.t("bond_status_overdue", { days: -diffDays }),
          };
        if (diffDays <= 30)
          return {
            badgeClass: "badge bg-warning text-dark",
            message: this.t("bond_status_expiring", { days: diffDays }),
          };
        return {
          badgeClass: "badge bg-primary",
          message: this.t("bond_status_active"),
        };
      },
      editBond(bond) {
        this.openBondModal("edit", bond);
      },
      deleteBond(bondToDelete) {
        appUtils.ui.showConfirmation(this, {
          title: this.t("confirmDeletion"),
          message:
            this.t("confirmDeleteBond", {
              bondNumber: bondToDelete.bondNumber,
            }) + `<br><small>${this.t("actionCannotBeUndone")}</small>`,
          onConfirm: async () => {
            try {
              const originalBondId = bondToDelete.renewedFromBondId;
              let originalBondToUpdate = null;

              if (originalBondId) {
                const originalBond = this.bonds.find(
                  (b) => b.id === originalBondId
                );
                if (originalBond) {
                  originalBondToUpdate = JSON.parse(
                    JSON.stringify(originalBond)
                  );
                  originalBondToUpdate.isSettled = false;
                  originalBondToUpdate.isRenewed = false;
                  originalBondToUpdate.settlementReasonDisplay = "";
                }
              }

              await databaseService.db.transaction(
                "rw",
                databaseService.db.bonds,
                async () => {
                  await databaseService.db.bonds.delete(bondToDelete.id);

                  if (originalBondToUpdate) {
                    await databaseService.db.bonds.put(
                      originalBondToUpdate
                    );
                  }
                }
              );

              const bondIndexToDelete = this.bonds.findIndex(
                (b) => b.id === bondToDelete.id
              );
              if (bondIndexToDelete !== -1) {
                this.bonds.splice(bondIndexToDelete, 1);
              }

              if (originalBondToUpdate) {
                const originalBondIndex = this.bonds.findIndex(
                  (b) => b.id === originalBondId
                );
                if (originalBondIndex !== -1) {
                  this.bonds[originalBondIndex] = originalBondToUpdate;
                }
              }

              this.showToast(this.t("bondDeletedSuccess"), "success");
            } catch (error) {
              console.error("Error deleting bond:", error);
              this.showToast(this.t("errorFindBondToDelete"), "error");
            }
          },
        });
      },
      clearFilteredBonds() {
        const visibleBondIds = this.filteredBondsDashboard.map((b) => b.id);
        if (visibleBondIds.length === 0) return;
        appUtils.ui.showConfirmation(this, {
          title: this.t("confirmDeletion"),
          message: this.t("confirmClearVisibleBonds", {
            count: visibleBondIds.length,
          }),
          onConfirm: async () => {
            try {
              await databaseService.db.bonds.bulkDelete(visibleBondIds);
              this.bonds = this.bonds.filter(
                (bond) => !visibleBondIds.includes(bond.id)
              );
              this.showToast(
                this.t("visibleBondsCleared", {
                  count: visibleBondIds.length,
                }),
                "success"
              );
            } catch (error) {
              console.error("Error clearing filtered bonds:", error);
              this.showToast("Failed to clear bonds.", "error");
            }
          },
        });
      },
      clearFilteredContracts() {
        const visibleContracts = this.filteredContractDashboardData;
        if (visibleContracts.length === 0) return;
        const visibleContractIds = visibleContracts.map((c) => c.id);

        appUtils.ui.showConfirmation(this, {
          title: this.t("confirmDeletion"),
          message: this.t("confirmClearVisibleContracts", {
            count: visibleContractIds.length,
          }),
          onConfirm: async () => {
            try {
              const cpcItemsToDelete = await databaseService.db.cpcItems
                .where("contractId")
                .anyOf(visibleContractIds)
                .toArray();
              const cpcItemIdsToDelete = cpcItemsToDelete.map(
                (cpc) => cpc.id
              );

              await databaseService.db.transaction(
                "rw",
                databaseService.db.tables,
                async () => {
                  if (cpcItemIdsToDelete.length > 0) {
                    await databaseService.db.installments
                      .where("cpcId")
                      .anyOf(cpcItemIdsToDelete)
                      .delete();
                    await databaseService.db.bonds
                      .where("cpcId")
                      .anyOf(cpcItemIdsToDelete)
                      .delete();
                  }
                  await databaseService.db.cpcItems
                    .where("contractId")
                    .anyOf(visibleContractIds)
                    .delete();
                  await databaseService.db.cpcDetailRows
                    .where("contractId")
                    .anyOf(visibleContractIds)
                    .delete();
                  await databaseService.db.contracts.bulkDelete(
                    visibleContractIds
                  );
                }
              );

              this.contracts = this.contracts.filter(
                (c) => !visibleContractIds.includes(c.id)
              );
              if (cpcItemIdsToDelete.length > 0) {
                this.cpcItems = this.cpcItems.filter(
                  (cpc) => !visibleContractIds.includes(cpc.contractId)
                );
                this.installments = this.installments.filter(
                  (inst) => !cpcItemIdsToDelete.includes(inst.cpcId)
                );
                this.bonds = this.bonds.filter(
                  (bond) => !cpcItemIdsToDelete.includes(bond.cpcId)
                );
                this.cpcDetailRows = this.cpcDetailRows.filter(
                  (r) => !visibleContractIds.includes(r.contractId)
                );
              }

              this.showToast(
                this.t("visibleContractsCleared", {
                  count: visibleContractIds.length,
                }),
                "success"
              );
            } catch (error) {
              console.error(
                "Error clearing filtered contracts and their related data:",
                error
              );
              this.showToast("Failed to clear contracts.", "error");
            }
          },
        });
      },
      openRenewBondModal(bond) {
        this.currentRenewBond = JSON.parse(JSON.stringify(bond));
        this.newBondDetails = {
              /*id: crypto.randomUUID(),*/ bondNumber: bond.bondNumber,
          ref: bond.ref,
          bondType: bond.bondType,
          amount: bond.amount,
          displayAmount: bond.amount.toLocaleString("vi-VN"),
          issueDate: "",
          expiryDate: "",
          issuingBank: bond.issuingBank,
          isSettled: false,
          settlementReasonDisplay: "",
          renewedFromBondNumber: bond.bondNumber,
          renewalNotes: "",
          renewalDate: appUtils.format.date(new Date()),
        };
        appUtils.ui.toggleModal("renewBondModal", "show");
      },
      formatNewBondAmount() {
        this.newBondDetails.amount = appUtils.text.parseVndAmount(
          this.newBondDetails.displayAmount
        );
        this.newBondDetails.displayAmount =
          this.newBondDetails.amount.toLocaleString("vi-VN");
      },
      async saveRenewedBond() {
        if (
          !this.validateDates(this.newBondDetails, [
            "issueDate",
            "expiryDate",
          ])
        ) {
          return;
        }
        if (
          !this.newBondDetails.expiryDate ||
          !this.newBondDetails.issueDate
        ) {
          this.showToast(this.t("errorNewBondDates"), "error");
          return;
        }

        const originalBondIndex = this.bonds.findIndex(
          (b) => b.id === this.currentRenewBond.id
        );
        if (originalBondIndex === -1) {
          this.showToast(this.t("errorFindOriginalCpcItem"), "error");
          return;
        }

        const originalBondToUpdate = JSON.parse(
          JSON.stringify(this.bonds[originalBondIndex])
        );
        originalBondToUpdate.isRenewed = true;
        originalBondToUpdate.isSettled = true;
        originalBondToUpdate.settlementReasonDisplay =
          this.t("renewedStatus");

        const newBond = {
          ...this.newBondDetails,
          renewedFromBondId: this.currentRenewBond.id,
          contractId: this.currentRenewBond.contractId,

          projectId: this.currentRenewBond.projectId,
          vendorId: this.currentRenewBond.vendorId,
        };
        delete newBond.cpcId;

        try {
          const cleanNewBond = JSON.parse(JSON.stringify(newBond));
          delete cleanNewBond.id;
          const cleanOriginalBond = JSON.parse(
            JSON.stringify(originalBondToUpdate)
          );

          await databaseService.db.transaction(
            "rw",
            databaseService.db.bonds,
            async () => {
              await databaseService.db.bonds.put(cleanOriginalBond);

              const newId = await databaseService.db.bonds.add(
                cleanNewBond
              );
              newBond.id = newId;
            }
          );

          this.bonds[originalBondIndex] = originalBondToUpdate;
          this.bonds.push(newBond);

          this.showToast(this.t("bondRenewedSuccess"), "success");
          this.closeRenewBondModal();
        } catch (error) {
          console.error("Error renewing bond:", error);
          this.showToast("Failed to renew bond.", "error");
        }
      },

      closeRenewBondModal() {
        appUtils.ui.toggleModal("renewBondModal", "hide");
      },
      async saveBondModal() {
        if (!this.currentEditBond) return;

        const isSettled =
          this.currentEditBond.isAdvanceSettled ||
          this.currentEditBond.isContractSettled ||
          this.currentEditBond.isOtherReasonSettled;
        let reasons = [];
        if (this.currentEditBond.isAdvanceSettled)
          reasons.push(this.t("advancePaymentsCleared"));
        if (this.currentEditBond.isContractSettled)
          reasons.push(this.t("contractSettled"));
        if (
          this.currentEditBond.isOtherReasonSettled &&
          this.currentEditBond.otherReasonText
        )
          reasons.push(
            `${this.t("otherReason")}: ${this.currentEditBond.otherReasonText
            }`
          );
        const settlementReasonDisplay = reasons.join(", ");

        const bondIndex = this.bonds.findIndex(
          (b) => b.id === this.currentEditBond.id
        );
        if (bondIndex > -1) {
          const bondToUpdate = this.bonds[bondIndex];
          bondToUpdate.isSettled = isSettled;
          bondToUpdate.settlementReasonDisplay = settlementReasonDisplay;
          try {
            await databaseService.db.bonds.put(
              JSON.parse(JSON.stringify(bondToUpdate))
            );
            this.showToast(this.t("bondInfoSaved"), "success");
          } catch (error) {
            console.error("Error saving bond status:", error);
            this.showToast("Failed to save bond status.", "error");
            this.bonds[bondIndex] = JSON.parse(
              JSON.stringify(this.bonds[bondIndex])
            );
          }
        }
        this.closeBondEditModal();
      },
      closeBondEditModal() {
        appUtils.ui.toggleModal("bondEditModal", "hide");
      },
      showToast(message, type = "info", duration = 4000) {
        const id = Date.now() + Math.random();
        this.toasts.push({ id, message, type });
        this.$nextTick(() => {
          const toastElement = document.querySelector(
            `.toast-notification[data-toast-id="${id}"]`
          );
          if (toastElement) {
            void toastElement.offsetWidth;
            toastElement.classList.add("show");
          }
        });
        setTimeout(() => {
          const toastElement = document.querySelector(
            `.toast-notification[data-toast-id="${id}"]`
          );
          if (toastElement) {
            toastElement.classList.remove("show");
            setTimeout(() => {
              this.toasts = this.toasts.filter((t) => t.id !== id);
            }, 500);
          }
        }, duration);
      },

      confirmAction() {
        if (typeof this.confirmation.onConfirm === "function") {
          this.confirmation.onConfirm();
        }
        appUtils.ui.toggleModal("confirmationModal", "hide");
      },
      neutralAction() {
        if (typeof this.confirmation.onNeutral === "function") {
          this.confirmation.onNeutral();
        }
      },
      closeConfirmationModal() {
        appUtils.ui.toggleModal("confirmationModal", "hide");
      },
      deleteItem(itemToDelete) {
        appUtils.ui.showConfirmation(this, {
          title: this.t("confirmDeletion"),
          message: this.t("confirmDeleteCpcItem", {
            cpc: itemToDelete.cpcIdentifier,
          }),
          onConfirm: async () => {
            try {
              const installmentsForCpc =
                this.installmentsByCpcId.get(itemToDelete.id) || [];
              const installmentIdsToDelete = installmentsForCpc.map(
                (i) => i.id
              );
              const bondsToDelete = this.bonds.filter(
                (b) => b.cpcId === itemToDelete.id
              );
              const bondIdsToDelete = bondsToDelete.map((b) => b.id);

              await databaseService.db.transaction(
                "rw",
                databaseService.db.cpcItems,
                databaseService.db.installments,
                databaseService.db.bonds,
                async () => {
                  if (installmentIdsToDelete.length > 0) {
                    await databaseService.db.installments.bulkDelete(
                      installmentIdsToDelete
                    );
                  }
                  if (bondIdsToDelete.length > 0) {
                    await databaseService.db.bonds.bulkDelete(
                      bondIdsToDelete
                    );
                  }
                  await databaseService.db.cpcItems.delete(itemToDelete.id);
                }
              );

              const cpcIndex = this.cpcItems.findIndex(
                (item) => item.id === itemToDelete.id
              );
              if (cpcIndex > -1) this.cpcItems.splice(cpcIndex, 1);

              if (installmentIdsToDelete.length > 0) {
                const idsSet = new Set(installmentIdsToDelete);
                this.installments = this.installments.filter(
                  (i) => !idsSet.has(i.id)
                );
              }
              if (bondIdsToDelete.length > 0) {
                const idsSet = new Set(bondIdsToDelete);
                this.bonds = this.bonds.filter((b) => !idsSet.has(b.id));
              }

              this.triggerReactivity();
              this.showToast(this.t("itemDeleted"), "success");

              const totalPages = this.totalPages;
              if (
                this.viewStates.cpcTracking.currentPage > totalPages &&
                this.viewStates.cpcTracking.currentPage > 1
              ) {
                this.viewStates.cpcTracking.currentPage = totalPages;
              }
            } catch (error) {
              console.error("Error deleting item:", error);
              this.showToast("Failed to delete item.", "error");
            }
          },
        });
      },
      clearAllData() {
        appUtils.ui.showConfirmation(this, {
          title: this.t("btnClearAll"),
          message: `<strong>${this.t("warning")}!</strong> ${this.t(
            "confirmClearAllData"
          )}`,
          confirmButtonClass: "btn-danger",
          confirmButtonText: this.t("yesClearAll"),
          onConfirm: async () => {
            try {
              await Promise.all(
                databaseService.db.tables.map((table) => table.clear())
              );
              this.projects = [];
              this.vendors = [];
              this.banks = [];
              this.contracts = [];
              this.cpcItems = [];
              this.installments = [];
              this.bonds = [];
              this.cpcDetailRows = [];
              this.reportCategoriesFromDB = [];
              this.viewStates.cpcTracking.currentPage = 1;
              this.showToast(this.t("allDataCleared"), "warning");
            } catch (error) {
              console.error("Error clearing all data:", error);
              this.showToast("Failed to clear all data.", "error");
            }
          },
        });
      },
      triggerFileOpen() {
        this.$refs.restoreJsonInput.click();
      },
      async handleFileLoad(event) {
        const file = event.target.files[0];
        if (!file) return;

        appUtils.ui.showConfirmation(this, {
          title: this.t("confirmDataLoad"),
          message: `<strong>${this.t("warning")}!</strong> ${this.t(
            "confirmOverwriteData"
          )}`,
          confirmButtonClass: "btn-primary",
          onConfirm: () => {
            const reader = new FileReader();
            reader.onload = async (e) => {
              try {
                const jsonData = JSON.parse(e.target.result);

                const dataToRestore = jsonData.contracts
                  ? jsonData
                  : jsonData;

                if (dataToRestore.contracts && dataToRestore.cpcItems) {
                  this.isDataLoading = true;

                  await databaseService.saveAllData(dataToRestore);

                  this._loadState(dataToRestore);

                  this.triggerReactivity();
                  this.$nextTick(() => {
                    this.initializeFuse();
                    this._recalculateAllDetailRowsAfterLoad();
                    this.isDataLoading = false;
                  });

                  this.showToast(this.t("loadSuccess"), "success");
                } else {
                  this.showToast(this.t("invalidJsonFormat"), "error");
                }
              } catch (error) {
                console.error("Restore Error:", error);
                this.showToast(this.t("errorParsingJson"), "error");
              }
            };
            reader.readAsText(file);
          },
        });
        event.target.value = "";
      },


      openGuideModal() {
        appUtils.ui.toggleModal("guideModal", "show");
      },
      openContractModal() {
        appUtils.ui.toggleModal("contractDetailModal", "show");
      },
      closeContractModal() {
        appUtils.ui.toggleModal("contractDetailModal", "hide");
      },
      addNewContractItem() {
        this.contractModalMode = "add";
        this.currentEditContract = {
          projectName: this.currentEditItem?.projectName || "",
          vendorName: this.currentEditItem?.vendorName || "",
          vendorNo: this.currentEditItem?.vendorNo || "",

          contractNo: "",
          date: new Date().toISOString().slice(0, 10),
          description: this.currentEditItem?.contents || "",
          glAccount: "",
          code: this.currentEditItem?.code || "",
          department: this.currentEditItem?.department || "",
          contractSystemNo: "",
          currency: "VND",
          significantNotes: "",
          status: "Active",
          statusNote: "",
          settings: {
            repaymentThreshold: 80,
            retentionRate: 5,
            defaultVatRate: 8,
          },
        };
        this.openContractModal();
      },
      editContractItem(contract) {
        this.contractModalMode = "edit";
        this.currentEditContract = JSON.parse(JSON.stringify(contract));
        const vendor = this.vendors.find(
          (v) => v.id === this.currentEditContract.vendorId
        );
        if (vendor) {
          this.currentEditContract.vendorAbbrName = vendor.abbrName || "";
        } else {
          this.currentEditContract.vendorAbbrName = "";
        }
        if (!this.currentEditContract.settings) {
          this.currentEditContract.settings = {
            repaymentThreshold: 80,
            retentionRate: 5,
            defaultVatRate: 8,
          };
        }
        this.openContractModal();
      },
      async saveContractModal() {
        if (
          !this.currentEditContract ||
          !this.currentEditContract.contractNo
        ) {
          this.showToast(this.t("errorContractNumberRequired"), "error");
          return;
        }

        if (!this.validateDates(this.currentEditContract, ["date"])) {
          return;
        }
        try {
          let project = await databaseService.findOrCreateEntity(
            "projects",
            "name",
            this.currentEditContract.projectName.trim()
          );
          let vendor = await databaseService.findOrCreateEntity(
            "vendors",
            "vendorNo",
            this.currentEditContract.vendorNo.trim()
          );

          if (vendor) {
            let vendorNeedsUpdate = false;
            if (
              vendor.name !== this.currentEditContract.vendorName.trim()
            ) {
              vendor.name = this.currentEditContract.vendorName.trim();
              vendorNeedsUpdate = true;
            }
            if (
              vendor.abbrName !==
              (this.currentEditContract.vendorAbbrName || "").trim()
            ) {
              vendor.abbrName = (
                this.currentEditContract.vendorAbbrName || ""
              ).trim();
              vendorNeedsUpdate = true;
            }
            if (vendorNeedsUpdate) {
              await databaseService.updateVendor(vendor);
            }
          }

          const contractData = JSON.parse(
            JSON.stringify(this.currentEditContract)
          );
          contractData.projectId = project.id;
          contractData.vendorId = vendor.id;
          delete contractData.projectName;
          delete contractData.vendorName;
          delete contractData.vendorAbbrName;
          delete contractData.vendorNo;

          if (this.contractModalMode === "add") {
            delete contractData.id;
            const newId = await databaseService.db.contracts.add(
              contractData
            );
            contractData.id = newId;
          } else {
            await databaseService.updateContract(contractData);
          }

          const freshData = await databaseService.getAllData();
          this._loadState(freshData);
          this.initializeFuse();

          this.showToast(this.t("contractSavedSuccess"), "success");
          this.closeContractModal();
        } catch (error) {
          console.error("Error saving contract:", error);
          if (error.name === "ConstraintError") {
            this.showToast(
              `Lỗi: Số hợp đồng '${this.currentEditContract.contractNo}' đã tồn tại.`,
              "error"
            );
          } else {
            this.showToast("Failed to save contract.", "error");
          }
        }
      },
      deleteContractItem(contractToDelete) {
        appUtils.ui.showConfirmation(this, {
          title: this.t("confirmDeletion"),
          message: this.t("confirmDeleteContract", {
            contractNo: contractToDelete.contractNo,
          }),
          onConfirm: async () => {
            const contractIdToDelete = contractToDelete.id;
            try {
              const cpcItemsToDelete =
                this.cpcItemsByContractId.get(contractIdToDelete) || [];
              const cpcItemIdsToDelete = cpcItemsToDelete.map(
                (cpc) => cpc.id
              );

              await databaseService.db.transaction(
                "rw",
                databaseService.db.tables,
                async () => {
                  if (cpcItemIdsToDelete.length > 0) {
                    await databaseService.db.installments
                      .where("cpcId")
                      .anyOf(cpcItemIdsToDelete)
                      .delete();
                    await databaseService.db.bonds
                      .where("cpcId")
                      .anyOf(cpcItemIdsToDelete)
                      .delete();
                  }
                  await databaseService.db.cpcItems
                    .where("contractId")
                    .equals(contractIdToDelete)
                    .delete();
                  await databaseService.db.cpcDetailRows
                    .where("contractId")
                    .equals(contractIdToDelete)
                    .delete();
                  await databaseService.db.contracts.delete(
                    contractIdToDelete
                  );
                }
              );

              const contractIndex = this.contracts.findIndex(
                (c) => c.id === contractIdToDelete
              );
              if (contractIndex > -1)
                this.contracts.splice(contractIndex, 1);

              if (cpcItemIdsToDelete.length > 0) {
                const cpcIdsSet = new Set(cpcItemIdsToDelete);
                this.cpcItems = this.cpcItems.filter(
                  (cpc) => c.contractId !== contractIdToDelete
                );
                this.installments = this.installments.filter(
                  (inst) => !cpcIdsSet.has(inst.cpcId)
                );
                this.bonds = this.bonds.filter(
                  (bond) => !cpcIdsSet.has(bond.cpcId)
                );
              }
              this.cpcDetailRows = this.cpcDetailRows.filter(
                (r) => r.contractId !== contractIdToDelete
              );

              this.showToast(this.t("contractDeletedSuccess"), "success");
            } catch (error) {
              console.error(
                "Error during cascading delete for contract:",
                error
              );
              this.showToast(
                "Failed to delete contract and its related data.",
                "error"
              );
            }
          },
        });
      },
      downloadContractTemplate() {
        const wb = XLSX.utils.book_new();
        const contractHeaders = [
          "project",
          "glAccount",
          "contractNo",
          "date",
          "vendorNo",
          "description",
          "code",
          "department",
          "contractSystemNo",
          "currency",
          "status",
          "statusNote",
        ];
        XLSX.utils.book_append_sheet(
          wb,
          XLSX.utils.json_to_sheet([], { header: contractHeaders }),
          "Contracts"
        );
        XLSX.writeFile(wb, "contracts_template.xlsx");
      },
      exportContractDashboardToExcel() {
        const dataToExport =
          this.formattedPaginatedContractDashboardData.map((item) => {
            const row = {};
            this.visibleContractDashboardColumns.forEach((col) => {
              row[col.label] =
                item[col.key + "Formatted"] || item[col.key] || "";
            });
            return row;
          });
        const ws = XLSX.utils.json_to_sheet(dataToExport);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ContractDashboard");
        XLSX.writeFile(
          wb,
          `contract_dashboard_export_${appUtils.format.date(
            new Date()
          )}.xlsx`
        );
        this.showToast(this.t("changesSavedSuccess"), "success");
      },
      triggerContractFileUpload() {
        this.$refs.uploadContractExcelInput.click();
      },
      async handleContractFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const workbook = XLSX.read(new Uint8Array(e.target.result), {
              type: "array",
            });
            const contractSheet = workbook.Sheets["Contracts"];
            if (!contractSheet) {
              this.showToast(
                this.t("errorSheetNotFound", { sheet: "Contracts" }),
                "error"
              );
              return;
            }
            const newContractsRaw = XLSX.utils.sheet_to_json(
              contractSheet,
              { raw: false, defval: null }
            );

            let addedCount = 0,
              updatedCount = 0,
              skippedCount = 0;
            let skippedContractsInfo = [];

            for (const row of newContractsRaw) {
              const contractNoTrimmed = row.contractNo?.trim();
              const vendorNoTrimmed = row.vendorNo?.trim();

              if (!contractNoTrimmed || !vendorNoTrimmed) {
                skippedCount++;
                skippedContractsInfo.push({
                  contractNo: contractNoTrimmed || "Thiếu",
                  vendorNo: vendorNoTrimmed || "Thiếu",
                  reason: "Thiếu mã Hợp đồng hoặc mã NCC.",
                });
                continue;
              }

              const vendor = this.vendors.find(
                (v) =>
                  v.vendorNo &&
                  v.vendorNo.trim().toLowerCase() ===
                  vendorNoTrimmed.toLowerCase()
              );

              if (!vendor) {
                skippedCount++;
                skippedContractsInfo.push({
                  contractNo: contractNoTrimmed,
                  vendorNo: vendorNoTrimmed,
                  reason: `Mã NCC '${vendorNoTrimmed}' không tồn tại trong Master Data.`,
                });
                continue;
              }

              let project = null;
              if (row.project && row.project.trim()) {
                const projectName = row.project.trim();
                project = this.projects.find(
                  (p) =>
                    p.name.trim().toLowerCase() ===
                    projectName.toLowerCase()
                );
                if (!project) {
                  project = { name: projectName };
                  const newId = await databaseService.db.projects.add(
                    project
                  );
                  project.id = newId;
                  this.projects.push(project);
                }
              }

              const existingContractIndex = this.contracts.findIndex(
                (c) =>
                  c.contractNo.trim().toLowerCase() ===
                  contractNoTrimmed.toLowerCase()
              );

              if (existingContractIndex !== -1) {
                const existingContract =
                  this.contracts[existingContractIndex];
                if (project) existingContract.projectId = project.id;
                existingContract.vendorId = vendor.id;
                if (row.date != null) existingContract.date = row.date;
                if (row.description != null)
                  existingContract.description = row.description;
                if (row.glAccount != null)
                  existingContract.glAccount = row.glAccount;
                if (row.code != null) existingContract.code = row.code;
                if (row.department != null)
                  existingContract.department = row.department;
                if (row.contractSystemNo != null)
                  existingContract.contractSystemNo = row.contractSystemNo;
                if (row.currency != null)
                  existingContract.currency = row.currency;
                if (row.status != null)
                  existingContract.status = row.status;
                if (row.statusNote != null)
                  existingContract.statusNote = row.statusNote;

                updatedCount++;
              } else {
                const newContract = {
                  projectId: project ? project.id : null,
                  vendorId: vendor.id,
                  contractNo: contractNoTrimmed,
                  date: row.date || "",
                  description: row.description || "",
                  glAccount: row.glAccount || "",
                  code: row.code || "",
                  department: row.department || "",
                  contractSystemNo: row.contractSystemNo || "",
                  currency: row.currency || "VND",
                  status: row.status || "Active",
                  statusNote: row.statusNote || "",
                  settings: {
                    repaymentThreshold: 80,
                    retentionRate: 5,
                    defaultVatRate: 8,
                  },
                };
                this.contracts.push(newContract);
                addedCount++;
              }
            }

            await databaseService.saveAllData(this._getAppState());

            let messageParts = [];
            if (addedCount > 0)
              messageParts.push(`Đã thêm ${addedCount} hợp đồng mới`);
            if (updatedCount > 0)
              messageParts.push(`Đã cập nhật ${updatedCount} hợp đồng`);
            if (skippedCount > 0)
              messageParts.push(
                `Đã bỏ qua ${skippedCount} hợp đồng do lỗi`
              );

            const finalMessage =
              messageParts.length > 0
                ? messageParts.join(". ") + "."
                : "Không có hợp đồng nào được xử lý.";

            if (skippedContractsInfo.length > 0) {
              console.warn(
                "Các hợp đồng bị bỏ qua khi upload:",
                skippedContractsInfo
              );
            }
            this.initializeFuse();
            this.showToast(
              finalMessage,
              addedCount > 0 || updatedCount > 0 ? "success" : "info"
            );
          } catch (error) {
            console.error("Contract Upload Error:", error);
            this.showToast(this.t("errorProcessingExcel"), "error");
          } finally {
            event.target.value = "";
          }
        };
        reader.readAsArrayBuffer(file);
      },
      async editInstallment(payment) {
        this.currentEditInstallment = JSON.parse(JSON.stringify(payment));
        this.currentEditInstallment.displayAmount = (
          this.currentEditInstallment.amount || 0
        ).toLocaleString("vi-VN");
        appUtils.ui.toggleModal("installmentEditModal", "show");
      },
      closeInstallmentModal() {
        appUtils.ui.toggleModal("installmentEditModal", "hide");
      },
      formatInstallmentEditAmount() {
        const amount = appUtils.text.parseVndAmount(
          this.currentEditInstallment.displayAmount
        );
        this.currentEditInstallment.amount = amount;
        this.currentEditInstallment.displayAmount =
          amount.toLocaleString("vi-VN");
      },
      async saveInstallmentModal() {
        if (!this.currentEditInstallment) return;
        if (!this.validateDates(this.currentEditInstallment, ["date"])) {
          return;
        }
        const instIndex = this.installments.findIndex(
          (i) => i.id === this.currentEditInstallment.id
        );
        if (instIndex > -1) {
          const installmentToUpdate = JSON.parse(
            JSON.stringify(this.installments[instIndex])
          );
          installmentToUpdate.paymentSource =
            this.currentEditInstallment.paymentSource;
          installmentToUpdate.amount = this.currentEditInstallment.amount;
          installmentToUpdate.date = this.currentEditInstallment.date;
          try {
            await databaseService.db.installments.put(installmentToUpdate);
            this.installments[instIndex] = installmentToUpdate;
            this.showToast(this.t("paymentUpdatedSuccess"), "success");
            this.closeInstallmentModal();
          } catch (error) {
            console.error("Error updating installment:", error);
            this.showToast(this.t("errorUpdatingPayment"), "error");
          }
        } else {
          this.showToast(this.t("errorUpdatingPayment"), "error");
        }
      },
      handleScroll() {
        const mainContent = this.$refs.mainContentWrapper;
        if (mainContent) {
          this.showScrollToTopButton = mainContent.scrollTop > 300;
        }
      },
      scrollToTop() {
        this.$refs.mainContentWrapper?.scrollTo({
          top: 0,
          behavior: "smooth",
        });
      },
      isSwapFullyPaid(installment) {
        if (!installment.isSwap) return false;
        const totalPaid = (installment.swapPayments || []).reduce(
          (sum, p) => sum + p.amount,
          0
        );
        return totalPaid >= installment.amount;
      },
      getSwapStatusInfo(swap) {
        const totalPaid = swap.totalSwapPaidAmount || 0;
        const amount = swap.amount || 0;
        const isReceivable = swap.transactionType === "receivable";

        if (totalPaid >= amount && amount > 0) {
          return {
            badgeClass: "badge bg-success",
            iconClass: "fas fa-check-circle",
            statusText: isReceivable
              ? this.t("collected")
              : this.t("paidStatus"),
          };
        }
        if (totalPaid > 0 && totalPaid < amount) {
          return {
            badgeClass: "badge bg-info",
            iconClass: "fas fa-adjust",
            statusText: isReceivable
              ? this.t("partiallyCollected")
              : this.t("partialpayment"),
          };
        }
        return {
          badgeClass: "badge bg-warning",
          iconClass: "fas fa-hourglass-half",
          statusText: isReceivable
            ? this.t("uncollected")
            : this.t("unpaidStatus"),
        };
      },
      addSwapPayment(installment) {
        if (!installment.swapPayments) {
          installment.swapPayments = [];
        }
        installment.swapPayments.push({
          amount: 0,
          displayAmount: "",
          date: "",
          source: "",
        });
      },
      removeSwapPayment(installment, index) {
        installment.swapPayments.splice(index, 1);
      },
      formatSwapPaymentAmount(payment) {
        this.formatAmountInput(payment, "displayAmount");
      },
      totalSwapPayments(installment) {
        const total = (installment.swapPayments || []).reduce(
          (sum, p) => sum + p.amount,
          0
        );
        return appUtils.format.currency(total);
      },
      editSwap(swap) {
        this.currentEditSwap = JSON.parse(JSON.stringify(swap));
        if (this.currentEditSwap.swapPayments) {
          this.currentEditSwap.swapPayments.forEach((p) => {
            p.displayAmount = (p.amount || 0).toLocaleString("vi-VN");
          });
        }
        appUtils.ui.toggleModal("swapEditModal", "show");
      },
      closeSwapModal() {
        appUtils.ui.toggleModal("swapEditModal", "hide");
      },
      async saveSwapModal() {
        if (!this.currentEditSwap) return;
        const dateFields = ["date", "swapDueDatePayment"];
        if (!this.validateDates(this.currentEditSwap, dateFields)) {
          return;
        }
        const installmentIndex = this.installments.findIndex(
          (i) => i.id === this.currentEditSwap.id
        );

        if (installmentIndex > -1) {
          const updatedSwapData = JSON.parse(
            JSON.stringify(this.currentEditSwap)
          );

          const installmentToUpdate = JSON.parse(
            JSON.stringify(this.installments[installmentIndex])
          );

          Object.assign(installmentToUpdate, {
            vendorSWAP: updatedSwapData.vendorSWAP,
            swapAgreement: updatedSwapData.swapAgreement,
            swapProduct: updatedSwapData.swapProduct,
            swapInformation: updatedSwapData.swapInformation,
            swapDueDatePayment: updatedSwapData.swapDueDatePayment,
            date: updatedSwapData.date,
            swapPayments: (updatedSwapData.swapPayments || []).map((p) => {
              delete p.displayAmount;
              return p;
            }),
          });

          installmentToUpdate.isSwapPaid =
            this.isSwapFullyPaid(installmentToUpdate);

          try {
            await databaseService.db.installments.put(installmentToUpdate);

            this.installments[installmentIndex] = installmentToUpdate;

            this.triggerReactivity();

            this.showToast(this.t("changesSavedSuccess"), "success");
            this.closeSwapModal();
          } catch (error) {
            console.error("Error saving swap details:", error);
            this.showToast("Failed to save SWAP details.", "error");
          }
        }
      },
      async syncTrackingToDetails(cpcItem) {
        if (!cpcItem || !cpcItem.contractId || !cpcItem.cpcIdentifier) {
          return;
        }

        const detailsTable = this.cpcDetailRows.filter(
          (r) => r.contractId === cpcItem.contractId
        );
        if (detailsTable.length === 0) {
          return;
        }

        let wasUpdated = false;
        const matchingDetailRows = detailsTable.filter(
          (row) => row.cpcNo === cpcItem.cpcIdentifier
        );

        if (matchingDetailRows.length > 0) {
          matchingDetailRows.forEach((row) => {
            if (row.linkedCpcId !== cpcItem.id) {
              row.linkedCpcId = cpcItem.id;
              wasUpdated = true;
            }
          });
        }
        if (wasUpdated) {
          await databaseService.db.cpcDetailRows.bulkPut(
            JSON.parse(JSON.stringify(matchingDetailRows))
          );
        }
      },
      toggleSwapExpand(swapItem) {
        const originalInstallment = this.installments.find(
          (i) => i.id === swapItem.id
        );
        if (originalInstallment) {
          originalInstallment.isExpanded = !originalInstallment.isExpanded;
        }
      },
      getDefaultCpcDetailsColumnVisibility() {
        const defaults = { columnVisibility: {}, subColumnVisibility: {} };
        this.detailsAvailableColumnGroups.forEach((col) => {
          defaults.columnVisibility[col.key] = true;
        });
        this.detailsAllSubColumns.forEach((col) => {
          defaults.subColumnVisibility[col.key] = true;
        });
        return defaults;
      },
      loadContractColumnSettings(contractId) {
        const contract = this.contracts.find((c) => c.id === contractId);
        if (contract && contract.columnSettings) {
          this.viewStates.cpcDetails.columnVisibility = {
            ...contract.columnSettings.columnVisibility,
          };
          this.viewStates.cpcDetails.subColumnVisibility = {
            ...contract.columnSettings.subColumnVisibility,
          };
        } else {
          const defaults = this.getDefaultCpcDetailsColumnVisibility();
          this.viewStates.cpcDetails.columnVisibility =
            defaults.columnVisibility;
          this.viewStates.cpcDetails.subColumnVisibility =
            defaults.subColumnVisibility;
        }
      },
      async toggleDetailColumnVisibility(type, key) {
        const contractId =
          this.viewStates.cpcDetails.filter.selectedContractId;
        if (!contractId) return;

        const contract = this.contracts.find((c) => c.id === contractId);
        if (!contract) return;

        if (!contract.columnSettings) {
          contract.columnSettings =
            this.getDefaultCpcDetailsColumnVisibility();
        }

        if (type === "column") {
          this.viewStates.cpcDetails.columnVisibility[key] =
            !this.viewStates.cpcDetails.columnVisibility[key];
          contract.columnSettings.columnVisibility[key] =
            this.viewStates.cpcDetails.columnVisibility[key];
        } else if (type === "subColumn") {
          this.viewStates.cpcDetails.subColumnVisibility[key] =
            !this.viewStates.cpcDetails.subColumnVisibility[key];
          contract.columnSettings.subColumnVisibility[key] =
            this.viewStates.cpcDetails.subColumnVisibility[key];
        }

        try {
          await databaseService.db.contracts.put(
            JSON.parse(JSON.stringify(contract))
          );
        } catch (error) {
          console.error("Error saving column visibility:", error);
        }
      },
      getRowIndex(rowId) {
        const contractId =
          this.viewStates.cpcDetails.filter.selectedContractId;
        if (!contractId) return -1;
        const tableForContract = this.cpcDetailRows.filter(
          (r) => r.contractId === contractId
        );
        return tableForContract.findIndex((row) => row.id === rowId);
      },
      downloadMasterDataTemplate() {
        const wb = XLSX.utils.book_new();
        // Thêm contactPerson và phoneNumber vào header mẫu
        const vendorHeaders = ["name", "abbrName", "vendorNo", "contactPerson", "phoneNumber"];
        const ws = XLSX.utils.json_to_sheet([], { header: vendorHeaders });
        XLSX.utils.book_append_sheet(wb, ws, "Vendors");
        XLSX.writeFile(wb, "master_data_template.xlsx");
      },
      triggerMasterDataUpload() {
        this.$refs.uploadMasterDataInput.click();
      },
      async handleMasterDataUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const workbook = XLSX.read(new Uint8Array(e.target.result), {
              type: "array",
            });
            const sheet = workbook.Sheets["Vendors"] || workbook.Sheets[workbook.SheetNames[0]];

            if (!sheet) {
              this.showToast("Không tìm thấy sheet 'Vendors' hoặc dữ liệu không hợp lệ.", "error");
              return;
            }

            const rows = XLSX.utils.sheet_to_json(sheet, { raw: false, defval: null });

            let vendorsToAdd = [];
            let addedCount = 0;
            let skippedCount = 0;

            const existingVendorNos = new Set(this.vendors.map(v => String(v.vendorNo).toLowerCase()));
            const processedInFile = new Set();

            rows.forEach((row) => {
              const name = row.name?.toString().trim();
              const vendorNo = row.vendorNo?.toString().trim();

              if (!name || !vendorNo) return; // Bỏ qua dòng trống

              const lowerVendorNo = vendorNo.toLowerCase();

              if (existingVendorNos.has(lowerVendorNo) || processedInFile.has(lowerVendorNo)) {
                skippedCount++;
              } else {
                const abbrName = row.abbrName?.toString().trim() || "";
                vendorsToAdd.push({
                  name,
                  abbrName,
                  vendorNo,
                  contactPerson: row.contactPerson?.toString().trim() || "", // Thêm dòng này
                  phoneNumber: row.phoneNumber?.toString().trim() || ""      // Thêm dòng này
                });
                processedInFile.add(lowerVendorNo);
                addedCount++;
              }
            });

            if (vendorsToAdd.length > 0) {
              await databaseService.db.transaction("rw", databaseService.db.vendors, async () => {
                await databaseService.db.vendors.bulkAdd(JSON.parse(JSON.stringify(vendorsToAdd)));
              });

              this.vendors = await databaseService.db.vendors.toArray();

              this.initializeFuse();
            }

            // Thông báo kết quả
            let message = `Đã thêm thành công ${addedCount} nhà cung cấp mới.`;
            if (skippedCount > 0) {
              message += ` Bỏ qua ${skippedCount} dòng do trùng mã hoặc thiếu dữ liệu.`;
            }
            this.showToast(message, addedCount > 0 ? "success" : "info");

          } catch (error) {
            console.error("Master Data Upload Error:", error);
            if (error.name === 'ConstraintError') {
              this.showToast("Lỗi: Phát hiện mã NCC bị trùng lặp nghiêm trọng trong file.", "error");
            } else {
              this.showToast(this.t("errorProcessingExcel"), "error");
            }
          } finally {
            event.target.value = "";
          }
        };
        reader.readAsArrayBuffer(file);
      },
      triggerAccountingFileUpload() {
        this.$refs.accountingUploadInput.click();
      },
      clearAccountingComparison() {
        this.accountingComparisonData = null;
        this.$refs.accountingUploadInput.value = "";
        this.showToast(this.t("accountingReconciliationCleared"), "info");
      },
      async handleAccountingFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const workbook = XLSX.read(new Uint8Array(e.target.result), {
              type: "array",
            });

            const sheet3311 = workbook.Sheets["33110001"];
            if (!sheet3311) {
              this.showToast(
                this.t("errorSheetNotFound", { sheetName: "33110001" }),
                "error"
              );
              return;
            }
            const data3311 = XLSX.utils.sheet_to_json(sheet3311, {
              header: 1,
              defval: null,
            });

            const sheet3312 = workbook.Sheets["33120001"];
            if (!sheet3312) {
              this.showToast(
                this.t("errorSheetNotFound", { sheetName: "33120001" }),
                "error"
              );
              return;
            }
            const data3312 = XLSX.utils.sheet_to_json(sheet3312, {
              header: 1,
              defval: null,
            });

            const excelData = {};

            data3311.forEach((row) => {
              const vendorNo = row[2] ? String(row[2]).trim() : null;
              if (vendorNo) {
                const vendorName = row[3] ? String(row[3]).trim() : null;
                const amount = parseFloat(row[17]);

                if (!isNaN(amount)) {
                  if (!excelData[vendorNo]) {
                    excelData[vendorNo] = {
                      vendorName: vendorName,
                      gl3311: 0,
                      gl3312: 0,
                    };
                  }
                  excelData[vendorNo].gl3311 = amount;
                  if (vendorName && !excelData[vendorNo].vendorName) {
                    excelData[vendorNo].vendorName = vendorName;
                  }
                }
              }
            });

            data3312.forEach((row) => {
              const vendorNo = row[2] ? String(row[2]).trim() : null;
              if (vendorNo) {
                const vendorName = row[3] ? String(row[3]).trim() : null;
                const amount = parseFloat(row[16]);
                if (!isNaN(amount)) {
                  if (!excelData[vendorNo]) {
                    excelData[vendorNo] = {
                      vendorName: vendorName,
                      gl3311: 0,
                      gl3312: 0,
                    };
                  }
                  excelData[vendorNo].gl3312 = amount;
                  if (vendorName && !excelData[vendorNo].vendorName) {
                    excelData[vendorNo].vendorName = vendorName;
                  }
                }
              }
            });

            this.accountingComparisonData = excelData;

            await this._recalculateAllDetailRowsAfterLoad();

            this.showToast(
              this.t("accountingUploadSuccess", {
                count: Object.keys(excelData).length,
              }),
              "success"
            );
          } catch (error) {
            console.error("Lỗi xử lý file kế toán:", error);
            this.showToast(this.t("errorProcessingExcel"), "error");
          }
        };
        reader.readAsArrayBuffer(file);
      },
      getComparisonStatusBadge(status) {
        switch (status) {
          case "Match":
            return "bg-success";
          case "Mismatch":
            return "bg-danger";
          case "Only in App":
            return "bg-info";
          case "Only in Accounting":
            return "bg-secondary";
          default:
            return "bg-light";
        }
      },
    },
  });
  app.directive("focus", {
    mounted(el) {
      el.focus();
      if (el.tagName === "INPUT") el.select();
    },
  });
  app.mount("#app");
  window.vueApp = app;
</script>
</head>

</html>